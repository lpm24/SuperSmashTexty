var xl=Object.defineProperty;var yl=(e,t,o)=>t in e?xl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var L=(e,t,o)=>yl(e,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();var wl=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return o=>{for(var s=o.length,i=new Uint8Array((s-(o[s-1]=="=")-(o[s-2]=="="))*3/4|0),a=0,l=0;a<s;){var c=e[o.charCodeAt(a++)],r=e[o.charCodeAt(a++)],n=e[o.charCodeAt(a++)],d=e[o.charCodeAt(a++)];i[l++]=c<<2|r>>4,i[l++]=r<<4|n>>2,i[l++]=n<<6|d}return i}})(),bl={version:"3001.0.19"};function Gt(e,t,o){return t>o?Gt(e,o,t):Math.min(Math.max(e,t),o)}var Ce,Me=(Ce=class{constructor(t,o,s){L(this,"r",255);L(this,"g",255);L(this,"b",255);this.r=Gt(t,0,255),this.g=Gt(o,0,255),this.b=Gt(s,0,255)}static fromArray(t){return new Ce(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new Ce(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!o)throw new Error("Invalid hex color format");return new Ce(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,o,s){if(o==0)return new Ce(255*s,255*s,255*s);let i=(d,u,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<1/6?d+(u-d)*6*h:h<1/2?u:h<2/3?d+(u-d)*(2/3-h)*6:d),a=s<.5?s*(1+o):s+o-s*o,l=2*s-a,c=i(l,a,t+1/3),r=i(l,a,t),n=i(l,a,t-1/3);return new Ce(Math.round(c*255),Math.round(r*255),Math.round(n*255))}clone(){return new Ce(this.r,this.g,this.b)}lighten(t){return new Ce(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new Ce(255-this.r,255-this.g,255-this.b)}mult(t){return new Ce(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,o){return new Ce(vt(this.r,t.r,o),vt(this.g,t.g,o),vt(this.b,t.b,o))}toHSL(){let t=this.r/255,o=this.g/255,s=this.b/255,i=Math.max(t,o,s),a=Math.min(t,o,s),l=(i+a)/2,c=l,r=l;if(i==a)l=c=0;else{let n=i-a;switch(c=r>.5?n/(2-i-a):n/(i+a),i){case t:l=(o-s)/n+(o<s?6:0);break;case o:l=(s-t)/n+2;break;case s:l=(t-o)/n+4;break}l/=6}return[l,c,r]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}},L(Ce,"RED",new Ce(255,0,0)),L(Ce,"GREEN",new Ce(0,255,0)),L(Ce,"BLUE",new Ce(0,0,255)),L(Ce,"YELLOW",new Ce(255,255,0)),L(Ce,"MAGENTA",new Ce(255,0,255)),L(Ce,"CYAN",new Ce(0,255,255)),L(Ce,"WHITE",new Ce(255,255,255)),L(Ce,"BLACK",new Ce(0,0,0)),Ce);function Pe(...e){if(e.length===0)return new Me(255,255,255);if(e.length===1){if(e[0]instanceof Me)return e[0].clone();if(typeof e[0]=="string")return Me.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Me.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof Me)return e[0].clone()}else if(e.length===3||e.length===4)return new Me(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var Al=(e,t,o)=>Me.fromHSL(e,t,o);function ke(e){return e*Math.PI/180}function Io(e){return e*180/Math.PI}function vt(e,t,o){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*o;if(e instanceof X&&t instanceof X||e instanceof Me&&t instanceof Me)return e.lerp(t,o);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function Xt(e,t,o,s,i){return s+(e-t)/(o-t)*(i-s)}function vl(e,t,o,s,i){return Gt(Xt(e,t,o,s,i),s,i)}var Oe,X=(Oe=class{constructor(t=0,o=t){L(this,"x",0);L(this,"y",0);this.x=t,this.y=o}static fromAngle(t){let o=ke(t);return new Oe(Math.cos(o),Math.sin(o))}static fromArray(t){return new Oe(t[0],t[1])}clone(){return new Oe(this.x,this.y)}add(...t){let o=N(...t);return new Oe(this.x+o.x,this.y+o.y)}sub(...t){let o=N(...t);return new Oe(this.x-o.x,this.y-o.y)}scale(...t){let o=N(...t);return new Oe(this.x*o.x,this.y*o.y)}dist(...t){let o=N(...t);return this.sub(o).len()}sdist(...t){let o=N(...t);return this.sub(o).slen()}static sdist(t,o){let s=t.x-o.x,i=t.y-o.y;return s*s+i*i}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new Oe(0):this.scale(1/t)}normal(){return new Oe(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,o){return t.x*o.x+t.y*o.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,o){return t.x*o.y-t.y*o.x}angle(...t){let o=N(...t);return Io(Math.atan2(this.y-o.y,this.x-o.x))}angleBetween(...t){let o=N(...t);return Io(Math.atan2(this.cross(o),this.dot(o)))}lerp(t,o){return new Oe(vt(this.x,t.x,o),vt(this.y,t.y,o))}slerp(t,o){let s=this.dot(t),i=this.cross(t),a=Math.atan2(i,s);return this.scale(Math.sin((1-o)*a)).add(t.scale(Math.sin(o*a))).scale(1/i)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new Oe(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Ue(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}},L(Oe,"ZERO",new Oe(0,0)),L(Oe,"ONE",new Oe(1,1)),L(Oe,"LEFT",new Oe(-1,0)),L(Oe,"RIGHT",new Oe(1,0)),L(Oe,"UP",new Oe(0,-1)),L(Oe,"DOWN",new Oe(0,1)),Oe);function N(...e){if(e.length===1){if(e[0]instanceof X)return new X(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new X(...e[0])}return new X(...e)}var Ye=class Ti{constructor(t,o,s,i){L(this,"x",0);L(this,"y",0);L(this,"w",1);L(this,"h",1);this.x=t,this.y=o,this.w=s,this.h=i}scale(t){return new Ti(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new X(this.x,this.y)}clone(){return new Ti(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function Ze(e,t,o,s){return new Ye(e,t,o,s)}var Gs=class Xo{constructor(t,o,s,i){L(this,"a");L(this,"b");L(this,"c");L(this,"d");this.a=t,this.b=o,this.c=s,this.d=i}mul(t){return new Xo(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return N(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new Xo(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new Xo(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,o=this.det,s=t+Math.sqrt(t*t-o),i=t-Math.sqrt(t*t-o);return[s,i]}eigenvectors(t,o){return this.c!=0?[[t-this.d,this.c],[o-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,o-this.a]]:Math.abs(this.transform(N(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let o=Math.cos(t),s=Math.sin(t);return new Xo(o,s,-s,o)}static scale(t,o){return new Xo(t,0,0,o)}},ss=class is{constructor(t,o,s,i,a,l,c,r,n){L(this,"m11");L(this,"m12");L(this,"m13");L(this,"m21");L(this,"m22");L(this,"m23");L(this,"m31");L(this,"m32");L(this,"m33");this.m11=t,this.m12=o,this.m13=s,this.m21=i,this.m22=a,this.m23=l,this.m31=c,this.m32=r,this.m33=n}static fromMat2(t){return new is(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new Gs(this.m11,this.m12,this.m21,this.m22)}mul(t){return new is(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let o=Math.cos(t),s=Math.sin(t),i=this.m11,a=this.m12;return this.m11=o*this.m11+s*this.m21,this.m12=o*this.m12+s*this.m22,this.m21=o*this.m21-s*i,this.m22=o*this.m22-s*a,this}scale(t,o){return this.m11*=t,this.m12*=t,this.m21*=o,this.m22*=o,this}get inverse(){let t=this.det;return new is((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new is(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},Kt=class Qt{constructor(t){L(this,"m",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);t&&(this.m=t)}static translate(t){return new Qt([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new Qt([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=ke(-t);let o=Math.cos(t),s=Math.sin(t);return new Qt([1,0,0,0,0,o,-s,0,0,s,o,0,0,0,0,1])}static rotateY(t){t=ke(-t);let o=Math.cos(t),s=Math.sin(t);return new Qt([o,0,s,0,0,1,0,0,-s,0,o,0,0,0,0,1])}static rotateZ(t){t=ke(-t);let o=Math.cos(t),s=Math.sin(t);return new Qt([o,-s,0,0,s,o,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=ke(-t);let o=Math.cos(t),s=Math.sin(t),i=this.m[0],a=this.m[1],l=this.m[4],c=this.m[5];return this.m[0]=i*o+a*s,this.m[1]=-i*s+a*o,this.m[4]=l*o+c*s,this.m[5]=-l*s+c*o,this}mult(t){let o=[];for(let s=0;s<4;s++)for(let i=0;i<4;i++)o[s*4+i]=this.m[0*4+i]*t.m[s*4+0]+this.m[1*4+i]*t.m[s*4+1]+this.m[2*4+i]*t.m[s*4+2]+this.m[3*4+i]*t.m[s*4+3];return new Qt(o)}multVec2(t){return new X(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new X(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new X(o,t/o)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new X(t/o,o)}else return new X(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return Io(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return Io(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new X(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new X(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new X(0,0)}invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],s=this.m[9]*this.m[15]-this.m[13]*this.m[11],i=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],l=this.m[8]*this.m[14]-this.m[12]*this.m[10],c=this.m[8]*this.m[13]-this.m[12]*this.m[9],r=this.m[6]*this.m[15]-this.m[14]*this.m[7],n=this.m[5]*this.m[15]-this.m[13]*this.m[7],d=this.m[5]*this.m[14]-this.m[13]*this.m[6],u=this.m[4]*this.m[15]-this.m[12]*this.m[7],h=this.m[4]*this.m[14]-this.m[12]*this.m[6],y=this.m[5]*this.m[15]-this.m[13]*this.m[7],f=this.m[4]*this.m[13]-this.m[12]*this.m[5],A=this.m[6]*this.m[11]-this.m[10]*this.m[7],g=this.m[5]*this.m[11]-this.m[9]*this.m[7],w=this.m[5]*this.m[10]-this.m[9]*this.m[6],E=this.m[4]*this.m[11]-this.m[8]*this.m[7],T=this.m[4]*this.m[10]-this.m[8]*this.m[6],z=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*s+this.m[7]*i,t[4]=-(this.m[4]*o-this.m[6]*a+this.m[7]*l),t[8]=this.m[4]*s-this.m[5]*a+this.m[7]*c,t[12]=-(this.m[4]*i-this.m[5]*l+this.m[6]*c),t[1]=-(this.m[1]*o-this.m[2]*s+this.m[3]*i),t[5]=this.m[0]*o-this.m[2]*a+this.m[3]*l,t[9]=-(this.m[0]*s-this.m[1]*a+this.m[3]*c),t[13]=this.m[0]*i-this.m[1]*l+this.m[2]*c,t[2]=this.m[1]*r-this.m[2]*n+this.m[3]*d,t[6]=-(this.m[0]*r-this.m[2]*u+this.m[3]*h),t[10]=this.m[0]*y-this.m[1]*u+this.m[3]*f,t[14]=-(this.m[0]*d-this.m[1]*h+this.m[2]*f),t[3]=-(this.m[1]*A-this.m[2]*g+this.m[3]*w),t[7]=this.m[0]*A-this.m[2]*E+this.m[3]*T,t[11]=-(this.m[0]*g-this.m[1]*E+this.m[3]*z),t[15]=this.m[0]*w-this.m[1]*T+this.m[2]*z;let q=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let p=0;p<4;p++)for(let m=0;m<4;m++)t[p*4+m]*=1/q;return new Qt(t)}clone(){return new Qt([...this.m])}toString(){return this.m.toString()}};function Ma(e,t,o,s=i=>-Math.cos(i)){return e+(s(o)+1)/2*(t-e)}var El=1103515245,Ml=12345,On=2147483648,Sa=class{constructor(e){L(this,"seed");this.seed=e}gen(){return this.seed=(El*this.seed+Ml)%On,this.seed/On}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new X(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new Me(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof X)return this.genVec2(N(0,0),e[0]);if(e[0]instanceof Me)return this.genColor(Pe(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof X&&e[1]instanceof X)return this.genVec2(e[0],e[1]);if(e[0]instanceof Me&&e[1]instanceof Me)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},Ci=new Sa(Date.now());function Sl(e){return e!=null&&(Ci.seed=e),Ci.seed}function lt(...e){return Ci.genAny(...e)}function Ra(...e){return Math.floor(lt(...e.length>0?e:[2]))}function Rl(e){return lt()<=e}function Da(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Dl(e,t){return e.length<=t?e.slice():Da(e.slice()).slice(0,t)}function Tl(e){return e[Ra(e.length)]}function Ta(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function Cl(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let o=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(o===0)return null;let s=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/o,i=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/o;return s<0||s>1||i<0||i>1?null:s}function on(e,t){let o=Cl(e,t);return o?N(e.p1.x+o*(e.p2.x-e.p1.x),e.p1.y+o*(e.p2.y-e.p1.y)):null}function sn(e,t){let o=t.p2.sub(t.p1),s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;if(o.x!=0){let a=(e.pos.x-t.p1.x)/o.x,l=(e.pos.x+e.width-t.p1.x)/o.x;s=Math.max(s,Math.min(a,l)),i=Math.min(i,Math.max(a,l))}if(o.y!=0){let a=(e.pos.y-t.p1.y)/o.y,l=(e.pos.y+e.height-t.p1.y)/o.y;s=Math.max(s,Math.min(a,l)),i=Math.min(i,Math.max(a,l))}return i>=s&&i>=0&&s<=1}function ni(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Ca(e,t){let o=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),s=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return N(o,s).sdist(t.center)<=t.radius*t.radius}function Ia(e,t){return Pa(t,new wt(e.points()))}function nn(e,t){let o=t.sub(e.p1),s=e.p2.sub(e.p1);if(Math.abs(o.cross(s))>Number.EPSILON)return!1;let i=o.dot(s)/s.dot(s);return i>=0&&i<=1}function bs(e,t){let o=e.p2.sub(e.p1),s=o.dot(o),i=e.p1.sub(t.center),a=2*o.dot(i),l=i.dot(i)-t.radius*t.radius,c=a*a-4*s*l;if(s<=Number.EPSILON||c<0)return!1;if(c==0){let r=-a/(2*s);if(r>=0&&r<=1)return!0}else{let r=(-a+Math.sqrt(c))/(2*s),n=(-a-Math.sqrt(c))/(2*s);if(r>=0&&r<=1||n>=0&&n<=1)return!0}return ai(t,e.p1)}function an(e,t){if(wo(t,e.p1)||wo(t,e.p2))return!0;for(let o=0;o<t.pts.length;o++){let s=t.pts[o],i=t.pts[(o+1)%t.pts.length];if(on(e,new Mt(s,i)))return!0}return!1}function ai(e,t){return e.center.sdist(t)<e.radius*e.radius}function Il(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function ri(e,t){let o=t.pts[t.pts.length-1];for(let s of t.pts){if(bs(new Mt(o,s),e))return!0;o=s}return ai(e,t.pts[0])?!0:wo(t,e.center)}function Pa(e,t){for(let o=0;o<e.pts.length;o++)if(an(new Mt(e.pts[o],e.pts[(o+1)%e.pts.length]),t))return!0;return!!(e.pts.some(o=>wo(t,o))||t.pts.some(o=>wo(e,o)))}function wo(e,t){let o=!1,s=e.pts;for(let i=0,a=s.length-1;i<s.length;a=i++)s[i].y>t.y!=s[a].y>t.y&&t.x<(s[a].x-s[i].x)*(t.y-s[i].y)/(s[a].y-s[i].y)+s[i].x&&(o=!o);return o}function rn(e,t){t=t.sub(e.center);let o=ke(e.angle),s=Math.cos(o),i=Math.sin(o),a=t.x*s+t.y*i,l=-t.x*i+t.y*s;return a*a/(e.radiusX*e.radiusX)+l*l/(e.radiusY*e.radiusY)<1}function Ks(e,t){let o=t.center.sub(e.center),s=ke(e.angle),i=Math.cos(s),a=Math.sin(s),l=o.x*i+o.y*a,c=-o.x*a+o.y*i;return rn(new so(N(),e.radiusX+t.radius,e.radiusY+t.radius,0),N(l,c))}function Ba(e,t){let o=e.toMat2().inverse;return t=new Mt(o.transform(t.p1.sub(e.center)),o.transform(t.p2.sub(e.center))),bs(t,new Et(N(),1))}function Pl(e,t){if(e.radiusX===e.radiusY)return Ks(t,new Et(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Ks(e,new Et(t.center,t.radiusX));let o=new ss(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),s=new ss(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),i=e.center.x,a=e.center.y,l=t.center.x,c=t.center.y,r=ke(e.angle),n=ke(t.angle),d=new ss(Math.cos(r),-Math.sin(r),i,Math.sin(r),Math.cos(r),a,0,0,1),u=new ss(Math.cos(n),-Math.sin(n),l,Math.sin(n),Math.cos(n),c,0,0,1),h=d.inverse,y=u.inverse,f=h.transpose.mul(o).mul(h),A=y.transpose.mul(s).mul(y),g=f.m11,w=f.m12,E=f.m13,T=f.m21,z=f.m22,q=f.m23,p=f.m31,m=f.m32,b=f.m33,S=A.m11,R=A.m12,P=A.m13,D=A.m21,I=A.m22,C=A.m23,U=A.m31,Y=A.m32,G=A.m33,K=g*z*b-g*q*m-w*T*b+w*q*p+E*T*m-E*z*p,$=(g*z*G-g*q*Y-g*m*C+g*b*I-w*T*G+w*q*U+w*p*C-w*b*D+E*T*Y-E*z*U-E*p*I+E*m*D+T*m*P-T*b*R-z*p*P+z*b*S+q*p*R-q*m*S)/K,V=(g*I*G-g*C*Y-w*D*G+w*C*U+E*D*Y-E*I*U-T*R*G+T*P*Y+z*S*G-z*P*U-q*S*Y+q*R*U+p*R*C-p*P*I-m*S*C+m*P*D+b*S*I-b*R*D)/K,ue=(S*I*G-S*C*Y-R*D*G+R*C*U+P*D*Y-P*I*U)/K;if($>=0){let Q=-3*V+$**2,we=3*$*ue+V*$**2-4*V**2,oe=-27*ue**2+18*ue*$*V+$**2*V**2-4*$**3*ue-4*V**3;return!(Q>0&&we<0&&oe>0)}else{let Q=-3*V+$**2,we=-27*ue**2+18*ue*$*V+$**2*V**2-4*$**3*ue-4*V**3;return!(Q>0&&we>0)}}function Oa(e,t){return ln(e,new wt(t.points()))}function ln(e,t){let o=e.toMat2().inverse;return t=new wt(t.pts.map(s=>o.transform(s.sub(e.center)))),ri(new Et(N(),1),t)}function Bl(e,t){return e.x===t.x&&e.y===t.y}function Ol(e,t){return t instanceof X?Bl(t,e.pt):t instanceof Et?ai(t,e.pt):t instanceof Mt?nn(t,e.pt):t instanceof Ue?ni(t,e.pt):t instanceof wt?wo(t,e.pt):t instanceof so?rn(t,e.pt):!1}function Ll(e,t){return t instanceof X?nn(e,t):t instanceof Et?bs(e,t):t instanceof Mt?on(e,t)!=null:t instanceof Ue?sn(t,e):t instanceof wt?an(e,t):t instanceof so?Ba(t,e):!1}function zl(e,t){return t instanceof X?ai(e,t):t instanceof Et?Il(e,t):t instanceof Mt?bs(t,e):t instanceof Ue?Ca(t,e):t instanceof wt?ri(e,t):t instanceof so?Ks(t,e):!1}function Hl(e,t){return t instanceof X?ni(e,t):t instanceof Et?Ca(e,t):t instanceof Mt?sn(e,t):t instanceof Ue?Ta(e,t):t instanceof wt?Ia(e,t):t instanceof so?Oa(t,e):!1}function Nl(e,t){return t instanceof X?wo(e,t):t instanceof Et?ri(t,e):t instanceof Mt?an(t,e):t instanceof Ue?Ia(t,e):t instanceof wt?Pa(t,e):t instanceof so?ln(t,e):!1}function Ul(e,t){return t instanceof X?rn(e,t):t instanceof Et?Ks(e,t):t instanceof Mt?Ba(e,t):t instanceof Ue?Oa(e,t):t instanceof wt?ln(e,t):t instanceof so?Pl(t,e):!1}function La(e,t,o){let s=e,i=o.p1,a=o.p2,l=t,c=a.sub(i),r=l.cross(c);if(Math.abs(r)<Number.EPSILON)return null;let n=i.sub(s),d=n.cross(c)/r;if(d<=0||d>=1)return null;let u=n.cross(l)/r;if(u<=0||u>=1)return null;let h=c.normal().unit();return t.dot(h)>0&&(h.x*=-1,h.y*=-1),{point:s.add(l.scale(d)),normal:h,fraction:d}}function ql(e,t,o){let s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY,a;if(e.x!=0){let l=(o.pos.x-e.x)/t.x,c=(o.pos.x+o.width-e.x)/t.x;a=N(-Math.sign(t.x),0),s=Math.max(s,Math.min(l,c)),i=Math.min(i,Math.max(l,c))}if(e.y!=0){let l=(o.pos.y-e.y)/t.y,c=(o.pos.y+o.height-e.y)/t.y;Math.min(l,c)>s&&(a=N(0,-Math.sign(t.y))),s=Math.max(s,Math.min(l,c)),i=Math.min(i,Math.max(l,c))}return i>=s&&s>=0&&s<=1?{point:e.add(t.scale(s)),normal:a,fraction:s}:null}function za(e,t,o){let s=e,i=o.center,a=t,l=a.dot(a),c=s.sub(i),r=2*a.dot(c),n=c.dot(c)-o.radius*o.radius,d=r*r-4*l*n;if(l<=Number.EPSILON||d<0)return null;if(d==0){let u=-r/(2*l);if(u>=0&&u<=1){let h=s.add(a.scale(u));return{point:h,normal:h.sub(i),fraction:u}}}else{let u=(-r+Math.sqrt(d))/(2*l),h=(-r-Math.sqrt(d))/(2*l),y=null;if(u>=0&&u<=1&&(y=u),h>=0&&h<=1&&(y=Math.min(h,y??h)),y!=null){let f=s.add(a.scale(y));return{point:f,normal:f.sub(i).unit(),fraction:y}}}return null}function Fl(e,t,o){let s=o.pts,i=null,a=s[s.length-1];for(let l=0;l<s.length;l++){let c=s[l],r=La(e,t,new Mt(a,c));r&&(!i||i.fraction>r.fraction)&&(i=r),a=c}return i}function _l(e,t,o){let s=o.toMat2(),i=s.inverse,a=i.transform(e.sub(o.center)),l=i.transform(t),c=za(a,l,new Et(N(),1));if(c){let r=Gs.rotation(ke(-o.angle)),n=Gs.scale(o.radiusX,o.radiusY).transform(c.point),d=s.transform(c.point).add(o.center),u=d.dist(e)/t.len();return{point:d,normal:r.transform(N(o.radiusY**2*n.x,o.radiusX**2*n.y)).unit(),fraction:u}}return c}function Xl(e,t,o,s=64){let i=e,a=t.len(),l=t.scale(1/a),c=0,r=N(Math.floor(e.x),Math.floor(e.y)),n=N(l.x>0?1:-1,l.y>0?1:-1),d=N(Math.abs(1/l.x),Math.abs(1/l.y)),u=N(n.x>0?r.x+1-e.x:e.x-r.x,n.y>0?r.y+1-e.y:e.y-r.y),h=N(d.x<1/0?d.x*u.x:1/0,d.y<1/0?d.y*u.y:1/0),y=-1;for(;c<=s;){let f=o(r);if(f===!0)return{point:i.add(l.scale(c)),normal:N(y===0?-n.x:0,y===1?-n.y:0),fraction:c/a,gridPos:r};if(f)return f;h.x<h.y?(r.x+=n.x,c=h.x,h.x+=d.x,y=0):(r.y+=n.y,c=h.y,h.y+=d.y,y=1)}return null}var Yl=class Ii{constructor(t){L(this,"pt");this.pt=t.clone()}transform(t){return new Ii(t.multVec2(this.pt))}bbox(){return new Ue(this.pt,0,0)}area(){return 0}clone(){return new Ii(this.pt)}collides(t){return Ol(this,t)}contains(t){return this.pt.eq(t)}raycast(t,o){return null}random(){return this.pt.clone()}},Mt=class Pi{constructor(t,o){L(this,"p1");L(this,"p2");this.p1=t.clone(),this.p2=o.clone()}transform(t){return new Pi(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Ue.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Pi(this.p1,this.p2)}collides(t){return Ll(this,t)}contains(t){return this.collides(t)}raycast(t,o){return La(t,o,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(lt(1)))}},Ue=class Bi{constructor(t,o,s){L(this,"pos");L(this,"width");L(this,"height");this.pos=t.clone(),this.width=o,this.height=s}static fromPoints(t,o){return new Bi(t.clone(),o.x-t.x,o.y-t.y)}center(){return new X(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new wt(this.points().map(o=>t.multVec2(o)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Bi(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let o=this.pos,s=this.pos.add(this.width,this.height),i=Math.max(o.x-t.x,0,t.x-s.x),a=Math.max(o.y-t.y,0,t.y-s.y);return i*i+a*a}collides(t){return Hl(this,t)}contains(t){return this.collides(t)}raycast(t,o){return ql(t,o,this)}random(){return this.pos.add(lt(this.width),lt(this.height))}},Et=class Ha{constructor(t,o){L(this,"center");L(this,"radius");this.center=t.clone(),this.radius=o}transform(t){return new so(this.center,this.radius,this.radius).transform(t)}bbox(){return Ue.fromPoints(this.center.sub(N(this.radius)),this.center.add(N(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new Ha(this.center,this.radius)}collides(t){return zl(this,t)}contains(t){return this.collides(t)}raycast(t,o){return za(t,o,this)}random(){return this.center.add(X.fromAngle(lt(360)).scale(lt(this.radius)))}},so=class Yo{constructor(t,o,s,i=0){L(this,"center");L(this,"radiusX");L(this,"radiusY");L(this,"angle");this.center=t.clone(),this.radiusX=o,this.radiusY=s,this.angle=i}static fromMat2(t){let o=t.inverse,s=o.transpose.mul(o),[i,a]=s.eigenvalues,[l,c]=s.eigenvectors(i,a),[r,n]=[1/Math.sqrt(i),1/Math.sqrt(a)];return r>n?new Yo(N(),r,n,Io(Math.atan2(-l[1],l[0]))):new Yo(N(),n,r,Io(Math.atan2(-c[1],c[0])))}toMat2(){let t=ke(this.angle),o=Math.cos(t),s=Math.sin(t);return new Gs(o*this.radiusX,-s*this.radiusY,s*this.radiusX,o*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new Yo(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let o=this.toMat2(),s=t.getRotation(),i=t.getScale();o=ss.fromMat2(o).scale(i.x,i.y).rotate(s).toMat2();let a=Yo.fromMat2(o);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return Ue.fromPoints(this.center.sub(N(this.radiusX,this.radiusY)),this.center.add(N(this.radiusX,this.radiusY)));{let t=ke(this.angle),o=Math.cos(t),s=Math.sin(t),i=this.radiusX*o,a=this.radiusX*s,l=this.radiusY*s,c=this.radiusY*o,r=Math.sqrt(i*i+l*l),n=Math.sqrt(a*a+c*c);return Ue.fromPoints(this.center.sub(N(r,n)),this.center.add(N(r,n)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new Yo(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return Ul(this,t)}contains(t){t=t.sub(this.center);let o=ke(this.angle),s=Math.cos(o),i=Math.sin(o),a=t.x*s+t.y*i,l=-t.x*i+t.y*s;return a*a/(this.radiusX*this.radiusX)+l*l/(this.radiusY*this.radiusY)<1}raycast(t,o){return _l(t,o,this)}random(){return this.center}};function Gl(e,t,o,s){let i=t.sub(e),a=s.sub(o),l=i.cross(a);return l<1e-5&&l>-1e-5||(l=o.sub(e).cross(a)/l,l<0||l>1)?null:e.add(i.scale(l))}var wt=class ns{constructor(t){L(this,"pts");if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new ns(this.pts.map(o=>t.multVec2(o)))}bbox(){let t=N(Number.MAX_VALUE),o=N(-Number.MAX_VALUE);for(let s of this.pts)t.x=Math.min(t.x,s.x),o.x=Math.max(o.x,s.x),t.y=Math.min(t.y,s.y),o.y=Math.max(o.y,s.y);return Ue.fromPoints(t,o)}area(){let t=0,o=this.pts.length;for(let s=0;s<o;s++){let i=this.pts[s],a=this.pts[(s+1)%o];t+=i.x*a.y*.5,t-=a.x*i.y*.5}return Math.abs(t)}clone(){return new ns(this.pts.map(t=>t.clone()))}collides(t){return Nl(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Fl(t,o,this)}random(){return N()}cut(t,o){new Mt(t,o);let s=[],i=[],a=o.sub(t),l=this.pts[this.pts.length-1],c=l.sub(t),r=a.cross(c)>0;return this.pts.forEach(n=>{c=n.sub(t);let d=a.cross(c)>0;if(r!=d){let u=Gl(l,n,t,o);s.push(u),i.push(u),r=d}(d?s:i).push(n),l=n}),[s.length?new ns(s):null,i.length?new ns(i):null]}};function Kl(e,t,o,s){let i=s*s,a=1-s,l=a*a;return e.scale(l).add(t.scale(2*a*s)).add(o.scale(i))}function Vl(e,t,o,s){let i=1-s;return t.sub(e).scale(2*i).add(o.sub(t).scale(2*s))}function jl(e,t,o,s){return o.sub(t.scale(2)).add(e).scale(2)}function cn(e,t,o,s,i){let a=i*i,l=a*i,c=1-i,r=c*c,n=r*c;return e.scale(n).add(t.scale(3*r*i)).add(o.scale(3*c*a)).add(s.scale(l))}function Wl(e,t,o,s,i){let a=i*i,l=1-i,c=l*l;return t.sub(e).scale(3*c).add(o.sub(t).scale(6*l*i)).add(s.sub(o).scale(3*a))}function $l(e,t,o,s,i){let a=1-i;return o.sub(t.scale(2)).add(e).scale(6*a).add(s.sub(o.scale(2)).add(t).scale(6*i))}function Jl(e,t,o,s,i){let a=.5*(((-i+2)*i-1)*i),l=.5*((3*i-5)*i*i+2),c=.5*(((-3*i+4)*i+1)*i),r=.5*((i-1)*i*i);return e.scale(a).add(t.scale(l)).add(o.scale(c)).add(s.scale(r))}function Ql(e,t,o,s,i){let a=.5*((-3*i+4)*i-1),l=.5*((9*i-10)*i),c=.5*((-9*i+8)*i+1),r=.5*((3*i-2)*i);return e.scale(a).add(t.scale(l)).add(o.scale(c)).add(s.scale(r))}function Zl(e){let t=Na(e),o=t(1);return s=>{let i=s*o,a=t(i,!0);return e(a)}}function Na(e,t=10,o=10){let s=[0],i=[0],a=1/(t-1)/o,l=0,c=e(0),r=0;for(let n=1;n<t;n++){for(let d=0;d<o;d++){r+=a;let u=e(r),h=u.dist(c);l+=h,c=u}s[n]=l,i[n]=r}return i[t-1]=1,(n,d=!1)=>{if(d){let u=n;if(u<=0)return 0;if(u>=l)return 1;let h=0;for(;s[h+1]<u;)h++;let y=i[h],f=i[h+1],A=s[h],g=s[h+1],w=(u-A)/(g-A);return y+(f-y)*w}else{if(n<=0)return 0;if(n>=1)return s[t-1];let u=0;for(;i[u+1]<n;)u++;let h=i[u],y=i[u+1],f=s[u],A=s[u+1],g=(n-h)/(y-h);return f+(A-f)*g}}}function As(e,t,o,s){let i=2*e+t-2*s+o,a=-3*e+3*s-2*t-o,l=t,c=e;return r=>{let n=r*r,d=n*r;return i*d+a*n+l*r+c}}function Ua(e,t,o,s,i,a=As){let l=a(t.x,(1-i)*(o.x-e.x),(1-i)*(s.x-t.x),o.x),c=a(t.y,(1-i)*(o.y-e.y),(1-i)*(s.y-t.y),o.y);return r=>new X(l(r),c(r))}function Vs(e,t,o,s,i=As){return Ua(e,t,o,s,.5,i)}function kl(e,t,o,s,i=As){return Vs(s.add(e.sub(t).scale(6)),e,s,e.add(s.sub(o).scale(6)),i)}function ec(e,t,o,s,i,a,l,c=As){let r=c(t.x,.5*(1-i)*(1+l)*(1+a)*(t.x-e.x)+.5*(1-i)*(1-l)*(1-a)*(o.x-t.x),.5*(1-i)*(1+l)*(1-a)*(o.x-t.x)+.5*(1-i)*(1-l)*(1+a)*(s.x-o.x),o.x),n=c(t.y,.5*(1-i)*(1+l)*(1+a)*(t.y-e.y)+.5*(1-i)*(1-l)*(1-a)*(o.y-t.y),.5*(1-i)*(1+l)*(1-a)*(o.y-t.y)+.5*(1-i)*(1-l)*(1+a)*(s.y-o.y),o.y);return d=>new X(r(d),n(d))}function tc(e,t,o,s){let i=2*e+t-2*s+o,a=-3*e+3*s-2*t+o,l=t;return c=>{let r=c*c;return 3*i*r+2*a*c+l}}function Zo(e){return 0<=e&&e<=1}function wi(e,t){return Math.abs(e-t)<=Number.EPSILON}function ko(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function oc(e,t,o,s){let i=3*e-6*t+3*o,a=-3*e+3*t,l=e,c=-e+3*t-3*o+s;if(wi(c,0)){if(wi(i,0))return wi(a,0)?[]:[-l/a].filter(Zo);let g=Math.sqrt(a*a-4*i*l),w=2*i;return[(g-a)/w,(-a-g)/w].filter(Zo)}i/=c,a/=c,l/=c;let r=(3*a-i*i)/3,n=r/3,d=(2*i*i*i-9*i*a+27*l)/27,u=d/2,h=u*u+n*n*n;if(h<0){let g=-r/3,w=g*g*g,E=Math.sqrt(w),T=-d/(2*E),z=T<-1?-1:T>1?1:T,q=Math.acos(z),p=2*ko(E),m=p*Math.cos(q/3)-i/3,b=p*Math.cos((q+2*Math.PI)/3)-i/3,S=p*Math.cos((q+4*Math.PI)/3)-i/3;return[m,b,S].filter(Zo)}if(h===0){let g=u<0?ko(-u):-ko(u),w=2*g-i/3,E=-g-i/3;return[w,E].filter(Zo)}let y=Math.sqrt(h),f=ko(y-u),A=ko(y+u);return[f-A-i/3].filter(Zo)}function sc(e,t,o,s,i){let a=oc(e.x-i,t.x-i,o.x-i,s.x-i);return a.length>0?cn(e,t,o,s,a[0]).y:NaN}function ic(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return o=>{if(o<=0||e.length==1||o<=e[0].x)return e[0].y;for(let s=0;s<t;s++)if(e[s].x>=o)return Xt(o,e[s-1].x,e[s].x,e[s-1].y,e[s].y);return e[e.length-1].y}}function nc(e,t){return o=>sc(N(0,0),e,t,N(1,1),o)}function ac(e,t="jump-end"){let o=1/e,s=t=="jump-start"||t=="jump-both",i=t=="jump-end"||t=="jump-both",a=1/(e+(i?1:0)),l=s?a:0;return c=>{let r=Math.floor(c/o);return l+r*a}}function rc(e,t){let o=Number.MAX_VALUE,s={normal:N(0),distance:0};for(let i of[e,t])for(let a=0;a<i.pts.length;a++){let l=i.pts[a],c=i.pts[(a+1)%i.pts.length].sub(l).normal().unit(),r=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let y=0;y<e.pts.length;y++){let f=e.pts[y].dot(c);r=Math.min(r,f),n=Math.max(n,f)}let d=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(let y=0;y<t.pts.length;y++){let f=t.pts[y].dot(c);d=Math.min(d,f),u=Math.max(u,f)}let h=Math.min(n,u)-Math.max(r,d);if(h<0)return null;if(h<Math.abs(o)){let y=u-r,f=d-n;o=Math.abs(y)<Math.abs(f)?y:f,s.normal=c,s.distance=o}}return s}function qa(e,t,o){return(t.x-e.x)*(o.y-e.y)-(t.y-e.y)*(o.x-e.x)>=0}function lc(e){let t=0,o=e[e.length-1];for(let s=0;s<e.length;s++)t+=(e[s].x-o.x)*(e[s].y+o.y),o=e[s];return t<0}function bi(e,t,o,s){let i=s.x-o.x,a=s.y-o.y,l=i*(e.y-o.y)-a*(e.x-o.x),c=i*(t.y-o.y)-a*(t.x-o.x);return l*c>=0}function cc(e,t,o,s){return bi(e,t,o,s)&&bi(e,o,t,s)&&bi(e,s,t,o)}function hc(e,t,o,s){for(let i of e)if(i!==t&&i!==o&&i!==s&&cc(i,t,o,s))return!0;return!1}function dc(e,t,o,s){return qa(e,t,o)&&!hc(s,e,t,o)}function Fa(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],o=[],s=0;for(let u=0;u<e.length;u++){let h=e[s],y=e[u];(y.x<h.x||y.x==h.x&&y.y<h.y)&&(s=s),t[u]=u+1,o[u]=u-1}t[t.length-1]=0,o[0]=o.length-1,lc(e)||([t,o]=[o,t]);let i=[];for(let u=0;u<e.length;++u)qa(e[o[u]],e[u],e[t[u]])||i.push(e[u]);let a=[],l=e.length,c=1,r=0,n,d;for(;l>3;){n=t[c],d=o[c];let u=e[d],h=e[c],y=e[n];if(dc(u,h,y,i))a.push([u,h,y]),t[d]=n,o[n]=d,i.splice(i.indexOf(h),1),--l,r=0;else if(++r>l)return[];c=n}return n=t[c],d=o[c],a.push([e[d],e[c],e[n]]),a}function uc(e){if(e.length<3)return!1;let t=e.length-2,o=e.length-1,s=0,i=e[o].sub(e[t]),a=e[s].sub(e[o]),l=i.cross(a);for(;s+1<e.length;)if(t=o,o=s,s++,i=e[o].sub(e[t]),a=e[s].sub(e[o]),i.cross(a)*l<0)return!1;return!0}var _a=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",li="topleft",pc="monospace",js="monospace",Oi="linear",hn=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],fc=hn.reduce((e,t)=>e+t.size,0),Xa=2048,gc=Xa*4*fc,mc=Xa*6,xc=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,yc=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Li=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,zi=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,wc=new Set(["id","require"]),bc=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),Ln=200,Ac=640,vc=65536,Ya=Symbol.for("kaplay.cancel"),Ga=class extends Map{constructor(){super(...arguments);L(this,"lastID",0)}push(t){let o=this.lastID;return this.set(o,t),this.lastID++,o}pushd(t){let o=this.push(t);return()=>this.delete(o)}},zo=class Ka{constructor(t){L(this,"paused",!1);L(this,"cancel");this.cancel=t}static join(t){let o=new Ka(()=>t.forEach(s=>s.cancel()));return Object.defineProperty(o,"paused",{get:()=>t[0].paused,set:s=>t.forEach(i=>i.paused=s)}),o.paused=!1,o}static replace(t,o){return t.cancel=()=>o.cancel(),o.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>o.paused,set:s=>o.paused=s}),t}},yt=class{constructor(){L(this,"cancellers",new WeakMap);L(this,"handlers",new Ga)}add(e){function t(...i){if(!s.paused)return e(...i)}let o=this.handlers.pushd(t),s=new zo(o);return this.cancellers.set(t,o),s}addOnce(e){let t=this.add((...o)=>{t.cancel(),e(...o)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let o=t(...e),s;o===Ya&&(s=this.cancellers.get(t))&&s()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},fs=class{constructor(){L(this,"handlers",{});L(this,"registers",{})}on(e,t){return this.handlers[e]||(this.handlers[e]=new yt),this.handlers[e].add(t)}onOnce(e,t){let o=this.on(e,(...s)=>{o.cancel(),t(...s)});return o}next(e){return new Promise(t=>{this.onOnce(e,(...o)=>t(o[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){var t;return((t=this.handlers[e])==null?void 0:t.numListeners())??0}},Ec=e=>e[0]instanceof Me,Mc=e=>e[0]instanceof X,Sc=e=>typeof e[0]=="number",Va=class{constructor(e=(t,o)=>t<o){L(this,"_items");L(this,"_compareFn");this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Rc(e){let t=window.atob(e),o=t.length,s=new Uint8Array(o);for(let i=0;i<o;i++)s[i]=t.charCodeAt(i);return s.buffer}function Dc(e){return Rc(e.split(",")[1])}function dn(e,t){let o=document.createElement("a");o.href=t,o.download=e,o.click()}function ja(e,t){dn(e,"data:text/plain;charset=utf-8,"+t)}function Tc(e,t){ja(e,JSON.stringify(t))}function zn(e,t){let o=URL.createObjectURL(t);dn(e,o),URL.revokeObjectURL(o)}var Wa=e=>e.match(/^data:\w+\/\w+;base64,.+/),Cc=e=>e.split(".").slice(0,-1).join(".");function un(e,t){if(e===t)return!0;let o=typeof e,s=typeof t;if(o!==s)return!1;if(o==="object"&&s==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let i=Object.keys(e),a=Object.keys(t);if(i.length!==a.length)return!1;for(let l of i){let c=e[l],r=t[l];if(!un(c,r))return!1}return!0}return!1}var Hn=new Set,Ic=e=>e instanceof Error?e.message:String(e);function Pc(e){Hn.has(e)||(Hn.add(e),console.warn(e))}function jo(e,t){Pc(`${e} is deprecated. Use ${t} instead.`)}function Hi(e,t){return Number(e.toFixed(t))}function _e(e,t){return(...o)=>{let s=o.length;if(s===e.length)return e(...o);if(s===t.length)return t(...o)}}var Bc=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function Oc(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],o=0,s=0;for(;o<e.length;){if(s+=Lc(o+s,e),_c(e[o+s])&&s++,Uc(e[o+s])&&s++,qc(e[o+s])&&s++,Xc(e[o+s])){s++;continue}t.push(e.substring(o,o+s)),o+=s,s=0}return t}function Lc(e,t){let o=t[e];if(!zc(o)||e===t.length-1)return 1;let s=o+t[e+1],i=t.substring(e+2,e+5);return Nn(s)&&Nn(i)?4:Hc(s)&&Fc(i)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:Nc(i)?4:2}function zc(e){return e&&Ho(e[0].charCodeAt(0),55296,56319)}function Nn(e){return Ho(pn(e),127462,127487)}function Hc(e){return Ho(pn(e),127988,127988)}function Nc(e){return Ho(pn(e),127995,127999)}function Uc(e){return typeof e=="string"&&Ho(e.charCodeAt(0),65024,65039)}function qc(e){return typeof e=="string"&&Ho(e.charCodeAt(0),8400,8447)}function Fc(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&Ho(t,917504,917631)}function _c(e){return typeof e=="string"&&Bc.includes(e.charCodeAt(0))}function Xc(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function pn(e){let t=e.charCodeAt(0)-55296,o=e.charCodeAt(1)-56320;return(t<<10)+o+65536}function Ho(e,t,o){return e>=t&&e<=o}var Ct=(e,t)=>Array.isArray(e)?e==null?void 0:e.includes(t):e===t,_t=(e,t)=>Array.isArray(t)?t.some(o=>e.has(o)):e.has(t),Is=(e,t,o)=>{var s;e.has(t)?(s=e.get(t))==null||s.push(o):e.set(t,[o])},Yc=(()=>{let e=0;return()=>e++})(),Gc={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function $a(){let e=x.globalOpt.pixelDensity??1,t=x.globalOpt.width,o=x.globalOpt.height,s=x.gfx.ggl.gl.drawingBufferWidth,i=x.gfx.ggl.gl.drawingBufferHeight,a=s/e,l=i/e,c=0,r=0,n=a,d=l;if(x.globalOpt.letterbox){if(!t||!o)throw new Error("Letterboxing requires width and height defined.");let u=a/l,h=t/o;if(u>h){let y=l*h;c=(a-y)/2,n=y}else{let y=a/h;d=y,r=(l-y)/2}}if(x.globalOpt.stretch&&(!x.globalOpt.width||!x.globalOpt.height))throw new Error("Stretching requires width and height defined.");x.gfx.viewport={x:c,y:r,width:n,height:d,scale:(x.gfx.viewport.width+x.gfx.viewport.height)/(x.gfx.width+x.gfx.height)}}function Kc(e){return new X(e.x*x.gfx.viewport.width/x.gfx.width,e.y*x.gfx.viewport.height/x.gfx.height)}function $t(e){return new X((e.x-x.gfx.viewport.x)*x.gfx.width/x.gfx.viewport.width,(e.y-x.gfx.viewport.y)*x.gfx.height/x.gfx.viewport.height)}var Vc=()=>So.lastInputDevice,jc=()=>{let e=So.buttons;for(let t in e){let o=e[t].keyboard&&[e[t].keyboard].flat(),s=e[t].keyboardCode&&[e[t].keyboardCode].flat(),i=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();o&&o.forEach(l=>{Is(So.buttonsByKey,l,t)}),s&&s.forEach(l=>{Is(So.buttonsByKeyCode,l,t)}),i&&i.forEach(l=>{Is(So.buttonsByGamepad,l,t)}),a&&a.forEach(l=>{Is(So.buttonsByMouse,l,t)})}},cs=class{constructor(){L(this,"pressed",new Set([]));L(this,"pressedRepeat",new Set([]));L(this,"released",new Set([]));L(this,"down",new Set([]))}update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},Wc=class{constructor(){L(this,"buttonState",new cs);L(this,"stickState",new Map)}},$c=class{constructor(){L(this,"dts",[]);L(this,"timer",0);L(this,"fps",0)}tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,o)=>t+o)/this.dts.length)),this.dts=[])}},So,Un=Gc,Jc=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new $c,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new X(0),mouseDeltaPos:new X(0),keyState:new cs,mouseState:new cs,mergedGamepadState:new Wc,gamepadStates:new Map,lastInputDevice:null,buttonState:new cs,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new fs}},Qc=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=Jc(e);So=t,jc();function o(){return t.dt*t.timeScale}function s(){return t.fixedDt*t.timeScale}function i(){return t.restDt*t.timeScale}function a(){return t.isHidden}function l(){return t.time}function c(){return t.fpsCounter.fps}function r(){return t.numFrames}function n(){return t.canvas.toDataURL()}function d(v){t.canvas.style.cursor=v}function u(){return t.canvas.style.cursor}function h(v){if(v)try{let H=t.canvas.requestPointerLock();H!=null&&H.catch&&H.catch(_=>console.error(_))}catch(H){console.error(H)}else document.exitPointerLock()}function y(){return!!document.pointerLockElement}function f(v){v.requestFullscreen?v.requestFullscreen():v.webkitRequestFullscreen&&v.webkitRequestFullscreen()}function A(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function g(v=!0){v?f(t.canvas):A()}function w(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function E(){t.stopped=!0;let v=Object.entries(Ke),H=Object.entries(ze),_=Object.entries(ut);for(let[Z,ge]of v)t.canvas.removeEventListener(Z,ge);for(let[Z,ge]of H)document.removeEventListener(Z,ge);for(let[Z,ge]of _)window.removeEventListener(Z,ge);at.disconnect()}function T(v,H){t.loopID!==null&&cancelAnimationFrame(t.loopID);let _=0,Z=0,ge=Le=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(ge);return}let Je=Le/1e3,Ne=Math.min(Je-t.realTime,.25),ft=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Je,Z+=Ne,Z>ft){if(!t.skipTime){for(_+=Z,t.dt=t.fixedDt,t.restDt=0;_>t.fixedDt;)_-=t.fixedDt,_<t.fixedDt&&(t.restDt=_),v();t.restDt=_,t.dt=Z,t.time+=o(),t.fpsCounter.tick(t.dt)}Z=0,t.skipTime=!1,t.numFrames++,H(qo,Ss)}t.loopID=requestAnimationFrame(ge)};ge(0)}function z(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function q(){return t.mousePos.clone()}function p(){return t.mouseDeltaPos.clone()}function m(v="left"){return t.mouseState.pressed.has(v)}function b(v="left"){return t.mouseState.down.has(v)}function S(v="left"){return t.mouseState.released.has(v)}function R(){return t.isMouseMoved}function P(v){return v===void 0?t.keyState.pressed.size>0:_t(t.keyState.pressed,v)}function D(v){return v===void 0?t.keyState.pressedRepeat.size>0:_t(t.keyState.pressedRepeat,v)}function I(v){return v===void 0?t.keyState.down.size>0:_t(t.keyState.down,v)}function C(v){return v===void 0?t.keyState.released.size>0:_t(t.keyState.released,v)}function U(v){return v===void 0?t.mergedGamepadState.buttonState.pressed.size>0:_t(t.mergedGamepadState.buttonState.pressed,v)}function Y(v){return v===void 0?t.mergedGamepadState.buttonState.down.size>0:_t(t.mergedGamepadState.buttonState.down,v)}function G(v){return v===void 0?t.mergedGamepadState.buttonState.released.size>0:_t(t.mergedGamepadState.buttonState.released,v)}function K(v){return v===void 0?t.buttonState.pressed.size>0:_t(t.buttonState.pressed,v)}function $(v){return v===void 0?t.buttonState.down.size>0:_t(t.buttonState.down,v)}function V(v){return v===void 0?t.buttonState.released.size>0:_t(t.buttonState.released,v)}function ue(v){var H;return(H=t.buttons)==null?void 0:H[v]}function Q(v,H){t.buttons[v]={...t.buttons[v],...H}}function we(v){t.buttonState.press(v),t.events.trigger("buttonPress",v)}function oe(v){t.buttonState.release(v),t.events.trigger("buttonRelease",v)}function me(v){return t.events.on("resize",v)}let Se=_e(v=>t.events.on("keyDown",v),(v,H)=>t.events.on("keyDown",_=>Ct(v,_)&&H(_))),Te=_e(v=>t.events.on("keyPress",H=>v(H)),(v,H)=>t.events.on("keyPress",_=>Ct(v,_)&&H(_))),Ve=_e(v=>t.events.on("keyPressRepeat",v),(v,H)=>t.events.on("keyPressRepeat",_=>Ct(v,_)&&H(_))),it=_e(v=>t.events.on("keyRelease",v),(v,H)=>t.events.on("keyRelease",_=>Ct(v,_)&&H(_))),je=_e(v=>t.events.on("mouseDown",H=>v(H)),(v,H)=>t.events.on("mouseDown",_=>Ct(v,_)&&H(_))),k=_e(v=>t.events.on("mousePress",H=>v(H)),(v,H)=>t.events.on("mousePress",_=>Ct(v,_)&&H(_))),se=_e(v=>t.events.on("mouseRelease",H=>v(H)),(v,H)=>t.events.on("mouseRelease",_=>_===v&&H(_)));function F(v){return t.events.on("mouseMove",()=>v(q(),p()))}function j(v){return t.events.on("charInput",v)}function ie(v){return t.events.on("touchStart",v)}function be(v){return t.events.on("touchMove",v)}function Re(v){return t.events.on("touchEnd",v)}function he(v){return t.events.on("scroll",v)}function Ie(v){return t.events.on("hide",v)}function Rt(v){return t.events.on("show",v)}let io=_e(v=>t.events.on("gamepadButtonPress",(H,_)=>v(H,_)),(v,H)=>t.events.on("gamepadButtonPress",(_,Z)=>Ct(v,_)&&H(_,Z))),jt=_e(v=>t.events.on("gamepadButtonDown",(H,_)=>v(H,_)),(v,H)=>t.events.on("gamepadButtonDown",(_,Z)=>Ct(v,_)&&H(_,Z))),Wt=_e(v=>t.events.on("gamepadButtonRelease",(H,_)=>v(H,_)),(v,H)=>t.events.on("gamepadButtonRelease",(_,Z)=>Ct(v,_)&&H(_,Z)));function Jo(v,H){return t.events.on("gamepadStick",(_,Z,ge)=>_===v&&H(Z,ge))}function no(v){t.events.on("gamepadConnect",v)}function nt(v){t.events.on("gamepadDisconnect",v)}function Ft(v){return t.mergedGamepadState.stickState.get(v)||new X(0)}function ao(){return[...t.charInputted]}function dt(){return[...t.gamepads]}let We=_e(v=>t.events.on("buttonPress",H=>v(H)),(v,H)=>t.events.on("buttonPress",_=>Ct(v,_)&&H(_))),qe=_e(v=>t.events.on("buttonDown",H=>v(H)),(v,H)=>t.events.on("buttonDown",_=>Ct(v,_)&&H(_))),Uo=_e(v=>t.events.on("buttonRelease",H=>v(H)),(v,H)=>t.events.on("buttonRelease",_=>Ct(v,_)&&H(_)));function qo(){t.events.trigger("input"),t.keyState.down.forEach(v=>t.events.trigger("keyDown",v)),t.mouseState.down.forEach(v=>t.events.trigger("mouseDown",v)),t.buttonState.down.forEach(v=>{t.events.trigger("buttonDown",v)}),Ht()}function Ss(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((v,H)=>{t.mergedGamepadState.stickState.set(H,new X(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new X(0),t.gamepadStates.forEach(v=>{v.buttonState.update(),v.stickState.forEach((H,_)=>{v.stickState.set(_,new X(0))})})}function Rs(v){let H={index:v.index,isPressed:_=>{var Z;return((Z=t.gamepadStates.get(v.index))==null?void 0:Z.buttonState.pressed.has(_))||!1},isDown:_=>{var Z;return((Z=t.gamepadStates.get(v.index))==null?void 0:Z.buttonState.down.has(_))||!1},isReleased:_=>{var Z;return((Z=t.gamepadStates.get(v.index))==null?void 0:Z.buttonState.released.has(_))||!1},getStick:_=>{var Z;return((Z=t.gamepadStates.get(v.index))==null?void 0:Z.stickState.get(_))||N()}};return t.gamepads.push(H),t.gamepadStates.set(v.index,{buttonState:new cs,stickState:new Map([["left",new X(0)],["right",new X(0)]])}),H}function pi(v){t.gamepads=t.gamepads.filter(H=>H.index!==v.index),t.gamepadStates.delete(v.index)}function Ht(){var v,H;for(let _ of navigator.getGamepads())_&&!t.gamepadStates.has(_.index)&&Rs(_);for(let _ of t.gamepads){let Z=navigator.getGamepads()[_.index];if(!Z)continue;let ge=(e.gamepads??{})[Z.id]||Un[Z.id]||Un.default,Le=t.gamepadStates.get(_.index);if(Le){for(let Je=0;Je<Z.buttons.length;Je++){let Ne=ge.buttons[Je],ft=Z.buttons[Je],Tt=t.buttonsByGamepad.has(Ne);if(ft.pressed){if(Le.buttonState.down.has(Ne)){t.events.trigger("gamepadButtonDown",Ne,_);continue}t.lastInputDevice="gamepad",Tt&&((v=t.buttonsByGamepad.get(Ne))==null||v.forEach(bt=>{t.buttonState.press(bt),t.events.trigger("buttonPress",bt)})),t.mergedGamepadState.buttonState.press(Ne),Le.buttonState.press(Ne),t.events.trigger("gamepadButtonPress",Ne,_)}else Le.buttonState.down.has(Ne)&&(Tt&&((H=t.buttonsByGamepad.get(Ne))==null||H.forEach(bt=>{t.buttonState.release(bt),t.events.trigger("buttonRelease",bt)})),t.mergedGamepadState.buttonState.release(Ne),Le.buttonState.release(Ne),t.events.trigger("gamepadButtonRelease",Ne,_))}for(let Je in ge.sticks){let Ne=ge.sticks[Je];if(!Ne)continue;let ft=new X(Z.axes[Ne.x],Z.axes[Ne.y]);Le.stickState.set(Je,ft),t.mergedGamepadState.stickState.set(Je,ft),t.events.trigger("gamepadStick",Je,ft,_)}}}}let Ke={},ze={},ut={},$e=e.pixelDensity||1;Ke.mousemove=v=>{let H=$t(new X(v.offsetX,v.offsetY)),_=new X(v.movementX,v.movementY);if(w()){let Z=t.canvas.width/$e,ge=t.canvas.height/$e,Le=window.innerWidth,Je=window.innerHeight,Ne=Le/Je,ft=Z/ge;if(Ne>ft){let Tt=Je/ge,bt=(Le-Z*Tt)/2;H.x=Xt(v.offsetX-bt,0,Z*Tt,0,Z),H.y=Xt(v.offsetY,0,ge*Tt,0,ge)}else{let Tt=Le/Z,bt=(Je-ge*Tt)/2;H.x=Xt(v.offsetX,0,Z*Tt,0,Z),H.y=Xt(v.offsetY-bt,0,ge*Tt,0,ge)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=H,t.mouseDeltaPos=_,t.events.trigger("mouseMove")})};let Dt=["left","middle","right","back","forward"];Ke.mousedown=v=>{t.events.onOnce("input",()=>{var _;let H=Dt[v.button];H&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(H)&&((_=t.buttonsByMouse.get(H))==null||_.forEach(Z=>{t.buttonState.press(Z),t.events.trigger("buttonPress",Z)})),t.mouseState.press(H),t.events.trigger("mousePress",H))})},Ke.mouseup=v=>{t.events.onOnce("input",()=>{var _;let H=Dt[v.button];H&&(t.buttonsByMouse.has(H)&&((_=t.buttonsByMouse.get(H))==null||_.forEach(Z=>{t.buttonState.release(Z),t.events.trigger("buttonRelease",Z)})),t.mouseState.release(H),t.events.trigger("mouseRelease",H))})};let pt=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),Nt={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};Ke.keydown=v=>{pt.has(v.key)&&v.preventDefault(),t.events.onOnce("input",()=>{var Z,ge;let H=Nt[v.key]||v.key.toLowerCase(),_=v.code;if(H===void 0)throw new Error(`Unknown key: ${v.key}`);H.length===1?(t.events.trigger("charInput",H),t.charInputted.push(H)):H==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),v.repeat?(t.keyState.pressRepeat(H),t.events.trigger("keyPressRepeat",H)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(H)&&((Z=t.buttonsByKey.get(H))==null||Z.forEach(Le=>{t.buttonState.press(Le),t.events.trigger("buttonPress",Le)})),t.buttonsByKeyCode.has(_)&&((ge=t.buttonsByKeyCode.get(_))==null||ge.forEach(Le=>{t.buttonState.press(Le),t.events.trigger("buttonPress",Le)})),t.keyState.press(H),t.events.trigger("keyPressRepeat",H),t.events.trigger("keyPress",H))})},Ke.keyup=v=>{t.events.onOnce("input",()=>{var Z,ge;let H=Nt[v.key]||v.key.toLowerCase(),_=v.code;t.buttonsByKey.has(H)&&((Z=t.buttonsByKey.get(H))==null||Z.forEach(Le=>{t.buttonState.release(Le),t.events.trigger("buttonRelease",Le)})),t.buttonsByKeyCode.has(_)&&((ge=t.buttonsByKeyCode.get(_))==null||ge.forEach(Le=>{t.buttonState.release(Le),t.events.trigger("buttonRelease",Le)})),t.keyState.release(H),t.events.trigger("keyRelease",H)})},Ke.touchstart=v=>{v.preventDefault(),t.events.onOnce("input",()=>{var Z;let H=[...v.changedTouches],_=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=$t(new X(H[0].clientX-_.x,H[0].clientY-_.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&((Z=t.buttonsByMouse.get("left"))==null||Z.forEach(ge=>{t.buttonState.press(ge),t.events.trigger("buttonPress",ge)})),t.mouseState.press("left"),t.events.trigger("mousePress","left")),H.forEach(ge=>{t.events.trigger("touchStart",$t(new X(ge.clientX-_.x,ge.clientY-_.y)),ge)})})},Ke.touchmove=v=>{v.preventDefault(),t.events.onOnce("input",()=>{let H=[...v.changedTouches],_=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let Z=t.mousePos;t.mousePos=$t(new X(H[0].clientX-_.x,H[0].clientY-_.y)),t.mouseDeltaPos=t.mousePos.sub(Z),t.events.trigger("mouseMove")}H.forEach(Z=>{t.events.trigger("touchMove",$t(new X(Z.clientX-_.x,Z.clientY-_.y)),Z)})})},Ke.touchend=v=>{t.events.onOnce("input",()=>{var Z;let H=[...v.changedTouches],_=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=$t(new X(H[0].clientX-_.x,H[0].clientY-_.y)),t.mouseDeltaPos=new X(0,0),t.buttonsByMouse.has("left")&&((Z=t.buttonsByMouse.get("left"))==null||Z.forEach(ge=>{t.buttonState.release(ge),t.events.trigger("buttonRelease",ge)})),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),H.forEach(ge=>{t.events.trigger("touchEnd",$t(new X(ge.clientX-_.x,ge.clientY-_.y)),ge)})})},Ke.touchcancel=v=>{t.events.onOnce("input",()=>{let H=[...v.changedTouches],_=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=$t(new X(H[0].clientX-_.x,H[0].clientY-_.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),H.forEach(Z=>{t.events.trigger("touchEnd",$t(new X(Z.clientX-_.x,Z.clientY-_.y)),Z)})})},Ke.wheel=v=>{v.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new X(v.deltaX,v.deltaY))})},Ke.contextmenu=v=>v.preventDefault(),ze.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},ut.gamepadconnected=v=>{let H=Rs(v.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",H)})},ut.gamepaddisconnected=v=>{let H=dt().filter(_=>_.index===v.gamepad.index)[0];pi(v.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",H)})};for(let[v,H]of Object.entries(Ke))t.canvas.addEventListener(v,H);for(let[v,H]of Object.entries(ze))document.addEventListener(v,H);for(let[v,H]of Object.entries(ut))window.addEventListener(v,H);let at=new ResizeObserver(v=>{for(let H of v)if(H.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return at.observe(t.canvas),{state:t,dt:o,fixedDt:s,restDt:i,time:l,run:T,canvas:t.canvas,fps:c,numFrames:r,quit:E,isHidden:a,setFullscreen:g,isFullscreen:w,setCursor:d,screenshot:n,getGamepads:dt,getCursor:u,setCursorLocked:h,isCursorLocked:y,isTouchscreen:z,mousePos:q,mouseDeltaPos:p,isKeyDown:I,isKeyPressed:P,isKeyPressedRepeat:D,isKeyReleased:C,isMouseDown:b,isMousePressed:m,isMouseReleased:S,isMouseMoved:R,isGamepadButtonPressed:U,isGamepadButtonDown:Y,isGamepadButtonReleased:G,getGamepadStick:Ft,isButtonPressed:K,isButtonDown:$,isButtonReleased:V,setButton:Q,getButton:ue,pressButton:we,releaseButton:oe,charInputted:ao,onResize:me,onKeyDown:Se,onKeyPress:Te,onKeyPressRepeat:Ve,onKeyRelease:it,onMouseDown:je,onMousePress:k,onMouseRelease:se,onMouseMove:F,onCharInput:j,onTouchStart:ie,onTouchMove:be,onTouchEnd:Re,onScroll:he,onHide:Ie,onShow:Rt,onGamepadButtonDown:jt,onGamepadButtonPress:io,onGamepadButtonRelease:Wt,onGamepadStick:Jo,onGamepadConnect:no,onGamepadDisconnect:nt,onButtonPress:We,onButtonDown:qe,onButtonRelease:Uo,getLastInputDeviceType:Vc,events:t.events}};function ct(){return x.app.dt()}function Ni(){return x.app.fixedDt()}function Ui(){return x.app.restDt()}var Zc=new X(-1,-1),kc=new X(0,-1),eh=new X(1,-1),th=new X(-1,0),oh=new X(0,0),sh=new X(1,0),ih=new X(-1,1),nh=new X(0,1),ah=new X(1,1);function Wo(e){switch(e){case"topleft":return Zc;case"top":return kc;case"topright":return eh;case"left":return th;case"center":return oh;case"right":return sh;case"botleft":return ih;case"bot":return nh;case"botright":return ah;default:return e}}function rh(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function lh(e){return e.createBuffer(1,1,44100)}var Ps=2.5949095,qn=1.70158+1,Fn=2*Math.PI/3,_n=2*Math.PI/4.5,qs={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>qn*e*e*e-1.70158*e*e,easeOutBack:e=>1+qn*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((Ps+1)*2*e-Ps)/2:(Math.pow(2*e-2,2)*((Ps+1)*(e*2-2)+Ps)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*Fn),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*Fn)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*_n))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*_n)/2+1,easeInBounce:e=>1-qs.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-qs.easeOutBounce(1-2*e))/2:(1+qs.easeOutBounce(2*e-1))/2},gs=qs;function ch(e,t,o){let s=[],i=t;for(s.push(i);i!==e;){if(i=o.get(i),i==null)return null;s.push(i)}return s.reverse()}function hh(e,t,o){var l;let s=new Va((c,r)=>c.cost<r.cost);s.insert({cost:0,node:t});let i=new Map;i.set(t,t);let a=new Map;for(a.set(t,0);s.length!==0;){let c=(l=s.remove())==null?void 0:l.node;if(c===o)break;let r=e.getNeighbours(c);for(let n of r){let d=(a.get(c)||0)+e.getCost(c,n)+e.getHeuristic(n,o);(!a.has(n)||d<a.get(n))&&(a.set(n,d),s.insert({cost:d,node:n}),i.set(n,c))}}return ch(t,o,i)}var dh=class{constructor(e,t,o){L(this,"a");L(this,"b");L(this,"polygon");this.a=e,this.b=t,this.polygon=new WeakRef(o)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},uh=class{constructor(e){L(this,"_edges");L(this,"_centroid");L(this,"_id");this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,o=0,s=0;for(let i of this._edges){i.polygon=new WeakRef(this);let a=i.a.x*i.b.y-i.a.y*i.b.x;t+=(i.a.x+i.b.x)*a,o+=(i.a.y+i.b.y)*a,s+=a}s/=2,this._centroid=N(t/(6*s),o/(6*s))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let o of this.edges)o.b.y>e.y!=o.a.y>e.y&&e.x<(o.a.x-o.b.x)*(e.y-o.b.y)/(o.a.y-o.b.y)+o.b.x&&(t=!t);return t}},ph=class{constructor(){L(this,"_polygons");L(this,"_pointCache");L(this,"_edgeCache");this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let o=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[o]}_findCommonEdge(e,t){for(let o of e.edges){let s=this._findEdge(o.b,o.a);if(s&&s.polygon.deref().id===t.id)return s}return null}addPolygon(e){let t=new uh(this._polygons.length),o=e.map((s,i)=>new dh(s,e[(i+1)%e.length],t));t.edges=o,this._polygons.push(t);for(let s of t.edges)this._addEdge(s);return t}addRect(e,t){let o=this._addPoint(e),s=this._addPoint(e.add(t.x,0)),i=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([o,s,i,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let o of this._polygons[e].edges){let s=this._findEdge(o.b,o.a);if(s){let i=s.polygon.deref();i&&t.push(i.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let o=this._polygons[e],s=this._polygons[t],i=o.centroid.x-s.centroid.x,a=o.centroid.y-s.centroid.y;return Math.sqrt(i*i+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:hh(this,e,t)}getWaypointPath(e,t,o){let s=(o==null?void 0:o.type)||"centroids",i=this._getLocation(e),a=this._getLocation(t);if(i===void 0||a===void 0)return[];let l=this.getPath(i.id,a.id);if(!l)return[];if(s==="edges"){let c=[];for(let r=1;r<l.length;r++){let n=this._polygons[l[r-1]],d=this._polygons[l[r]],u=this._findCommonEdge(n,d);c.push(u.middle.add(d.centroid.sub(u.middle).unit().scale(4)))}return[e,...c,t]}else return[e,...l.slice(1,-1).map(c=>this._polygons[c].centroid),t]}};function hs(e){let t=new Kt;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function fh(e){return new X(e.x/ht()*2-1,-e.y/mt()*2+1)}function as(e,t,o,s,i,a=1){s=ke(s%360),i=ke(i%360),i<=s&&(i+=Math.PI*2);let l=[],c=Math.ceil((i-s)/ke(8)*a),r=(i-s)/c,n=N(Math.cos(s),Math.sin(s)),d=N(Math.cos(r),Math.sin(r));for(let u=0;u<=c;u++)l.push(e.add(t*n.x,o*n.y)),n=N(n.x*d.x-n.y*d.y,n.x*d.y+n.y*d.x);return l}function gh(...e){let t=Pe(...e),o=e[3]??1;x.gfx.bgColor=t,x.gfx.bgAlpha=o,x.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,o)}function mh(){var e,t;return((t=(e=x.gfx.bgColor)==null?void 0:e.clone)==null?void 0:t.call(e))??null}function Ge(...e){if(e[0]===void 0)return;let t=N(...e);t.x===0&&t.y===0||x.gfx.transform.translate(t)}function Pt(){x.gfx.transformStack.push(x.gfx.transform.clone())}function xh(e){x.gfx.transform=e.clone()}function ms(...e){if(e[0]===void 0)return;let t=N(...e);t.x===1&&t.y===1||x.gfx.transform.scale(t)}function Go(e){e&&x.gfx.transform.rotate(e)}function At(){x.gfx.transformStack.length>0&&(x.gfx.transform=x.gfx.transformStack.pop())}function Bt(){x.gfx.renderer.flush()}function ht(){return x.gfx.width}function mt(){return x.gfx.height}function Ja(){return(x.gfx.viewport.width+x.gfx.viewport.height)/(x.gfx.width+x.gfx.height)}function Ws(){return N(ht()/2,mt()/2)}var yh=class{constructor(e,t,o,s){L(this,"lastTextureId",0);L(this,"textures",[]);L(this,"bigTextures",[]);L(this,"texturesPosition",new Map);L(this,"canvas");L(this,"c2d");L(this,"x",0);L(this,"y",0);L(this,"curHeight",0);L(this,"gfx");L(this,"padding");this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.textures=[go.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=s;let i=this.canvas.getContext("2d");if(!i)throw new Error("Failed to get 2d context");this.c2d=i}addSingle(e){let t=go.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new Ye(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,o=e.height+this.padding*2;if(t>this.canvas.width||o>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+o>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(go.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let s=this.textures[this.textures.length-1],i=new X(this.x+this.padding,this.y+this.padding);return this.x+=t,o>this.curHeight&&(this.curHeight=o),e instanceof ImageData?this.c2d.putImageData(e,i.x,i.y):this.c2d.drawImage(e,i.x,i.y),s.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:i,size:new X(e.width,e.height),texture:s}),this.lastTextureId++,[s,new Ye(i.x/this.canvas.width,i.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Lt(e){return typeof e!="string"||Wa(e)?e:x.assets.urlPrefix+e}var zt=class Qa{constructor(t){L(this,"loaded",!1);L(this,"data",null);L(this,"error",null);L(this,"onLoadEvents",new yt);L(this,"onErrorEvents",new yt);L(this,"onFinishEvents",new yt);t.then(o=>{this.loaded=!0,this.data=o,this.onLoadEvents.trigger(o)}).catch(o=>{if(this.error=o,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(o);else throw o}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let o=new Qa(Promise.resolve(t));return o.data=t,o.loaded=!0,o}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},Fo=class{constructor(){L(this,"assets",new Map);L(this,"lastUID",0)}add(e,t){let o=e??this.lastUID+++"",s=new zt(t);return this.assets.set(o,s),s}addLoaded(e,t){let o=e??this.lastUID+++"",s=zt.loaded(t);return this.assets.set(o,s),s}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function fn(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function ci(e){return fn(e).then(t=>t.json())}function wh(e){return fn(e).then(t=>t.text())}function bh(e){return fn(e).then(t=>t.arrayBuffer())}function Ah(e){return e!==void 0&&(x.assets.urlPrefix=e),x.assets.urlPrefix}function vh(e,t){return x.assets.custom.add(e,ci(Lt(t)))}function hi(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((o,s)=>{t.onload=()=>o(t),t.onerror=()=>s(new Error(`Failed to load image from "${e}"`))})}function Po(){let e=[x.assets.sprites,x.assets.sounds,x.assets.shaders,x.assets.fonts,x.assets.bitmapFonts,x.assets.custom];return e.reduce((t,o)=>t+o.progress(),0)/e.length}function Za(){return[x.assets.sprites,x.assets.sounds,x.assets.shaders,x.assets.fonts,x.assets.bitmapFonts,x.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function Eh(e){return x.assets.custom.get(e)??null}function qi(e){return x.assets.custom.add(null,e)}var Mh=(e,t)=>({urlPrefix:"",sprites:new Fo,fonts:new Fo,bitmapFonts:new Fo,sounds:new Fo,shaders:new Fo,custom:new Fo,music:{},packer:new yh(e,2048,2048,t),loaded:!1}),Sh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",bo=class rs{constructor(t,o,s={},i=null){L(this,"tex");L(this,"frames",[new Ye(0,0,1,1)]);L(this,"anims",{});L(this,"slice9",null);this.tex=t,o&&(this.frames=o),this.anims=s,this.slice9=i}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,o={}){return typeof t=="string"?rs.fromURL(t,o):Promise.resolve(rs.fromImage(t,o))}static fromImage(t,o={}){let[s,i]=o.singular?x.assets.packer.addSingle(t):x.assets.packer.add(t),a=o.frames?o.frames.map(l=>new Ye(i.x+l.x*i.w,i.y+l.y*i.h,l.w*i.w,l.h*i.h)):er(o.sliceX||1,o.sliceY||1,i.x,i.y,i.w,i.h);return new rs(s,a,o.anims,o.slice9)}static fromURL(t,o={}){return hi(t).then(s=>rs.fromImage(s,o))}};function Fs(e){if(typeof e=="string"){let t=ka(e);if(t)return t;if(Po()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof bo)return zt.loaded(e);if(e instanceof zt)return e;throw new Error(`Invalid sprite: ${e}`)}}function ka(e){return x.assets.sprites.get(e)??null}function ds(e,t,o={sliceX:1,sliceY:1,anims:{}}){return t=Lt(t),Array.isArray(t)?t.some(s=>typeof s=="string")?x.assets.sprites.add(e,Promise.all(t.map(s=>typeof s=="string"?hi(s):Promise.resolve(s))).then(s=>Xn(s,o))):x.assets.sprites.addLoaded(e,Xn(t,o)):typeof t=="string"?x.assets.sprites.add(e,bo.from(t,o)):x.assets.sprites.addLoaded(e,bo.fromImage(t,o))}function er(e=1,t=1,o=0,s=0,i=1,a=1){let l=[],c=i/e,r=a/t;for(let n=0;n<t;n++)for(let d=0;d<e;d++)l.push(new Ye(o+d*c,s+n*r,c,r));return l}function Xn(e,t={}){let o=document.createElement("canvas"),s=e[0].width,i=e[0].height;o.width=s*e.length,o.height=i;let a=o.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((c,r)=>{c instanceof ImageData?a.putImageData(c,r*s,0):a.drawImage(c,r*s,0)});let l=a.getImageData(0,0,e.length*s,i);return bo.fromImage(l,{...t,sliceX:e.length,sliceY:1})}function Rh(e="bean"){return ds(e,Sh)}function Dh(e,t,o){t=Lt(t),o=Lt(o),typeof t=="string"&&!o&&(o=Cc(t)+".json");let s=typeof o=="string"?ci(o):Promise.resolve(o);return x.assets.sprites.add(e,s.then(i=>{let a=i.meta.size,l=i.frames.map(r=>new Ye(r.frame.x/a.w,r.frame.y/a.h,r.frame.w/a.w,r.frame.h/a.h)),c={};for(let r of i.meta.frameTags)r.from===r.to?c[r.name]=r.from:c[r.name]={from:r.from,to:r.to,speed:10,loop:!0,pingpong:r.direction==="pingpong"};return bo.from(t,{frames:l,anims:c})}))}var _s=class{constructor(e,t={}){L(this,"fontface");L(this,"filter",Oi);L(this,"outline",null);L(this,"size",64);if(this.fontface=e,this.filter=t.filter??Oi,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Pe(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function tr(e){if(!e)return tr(x.globalOpt.font??pc);if(typeof e=="string"){let t=sr(e),o=or(e);if(t)return t.data??t;if(o)return o.data??o;if(document.fonts.check(`64px ${e}`))return e;if(Po()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof zt)return e.data?e.data:e;return e}function or(e){return x.assets.fonts.get(e)??null}function Th(e,t,o={}){let s=Lt(t),i=new FontFace(e,typeof t=="string"?`url(${s})`:s);return document.fonts.add(i),x.assets.fonts.add(e,i.load().catch(a=>{throw new Error(`Failed to load font from "${s}": ${a}`)}).then(a=>new _s(a,o)))}function Ch(e,t,o,s){let i=e.width/t,a={},l=s.split("").entries();for(let[c,r]of l)a[r]=new Ye(c%i*t,Math.floor(c/i)*o,t,o);return{tex:e,map:a,size:o}}function sr(e){return x.assets.bitmapFonts.get(e)??null}function Ih(e,t,o,s,i={}){let a=Lt(t);return x.assets.bitmapFonts.add(e,hi(a).then(l=>Ch(go.fromImage(x.gfx.ggl,l,i),o,s,i.chars??_a)))}function Ph(e,t){return t=Lt(t),x.assets.sprites.add(e,new Promise(async o=>{let s=typeof t=="string"?await ci(t):t,i=await Promise.all(s.frames.map(hi)),a=document.createElement("canvas");a.width=s.width,a.height=s.height*s.frames.length;let l=a.getContext("2d");if(!l)throw new Error("Failed to create canvas context");i.forEach((r,n)=>{l.drawImage(r,0,n*s.height)});let c=await ds(null,a,{sliceY:s.frames.length,anims:s.anims});o(c)}))}var Bh=class{constructor(e,t,o,s){L(this,"ctx");L(this,"glProgram");this.ctx=e,e.onDestroy(()=>this.free());let i=e.gl,a=i.createShader(i.VERTEX_SHADER),l=i.createShader(i.FRAGMENT_SHADER);if(!a||!l)throw new Error("Failed to create shader");i.shaderSource(a,t),i.shaderSource(l,o),i.compileShader(a),i.compileShader(l);let c=i.createProgram();if(this.glProgram=c,i.attachShader(c,a),i.attachShader(c,l),s.forEach((r,n)=>i.bindAttribLocation(c,n,r)),i.linkProgram(c),!i.getProgramParameter(c,i.LINK_STATUS)){let r=i.getShaderInfoLog(a);if(r)throw new Error("VERTEX SHADER "+r);let n=i.getShaderInfoLog(l);if(n)throw new Error("FRAGMENT SHADER "+n)}i.deleteShader(a),i.deleteShader(l)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let o in e){let s=e[o],i=t.getUniformLocation(this.glProgram,o);if(typeof s=="number")t.uniform1f(i,s);else if(s instanceof Kt)t.uniformMatrix4fv(i,!1,new Float32Array(s.m));else if(s instanceof Me)t.uniform3f(i,s.r,s.g,s.b);else if(s instanceof X)t.uniform2f(i,s.x,s.y);else if(Array.isArray(s))s[0],Sc(s)?t.uniform1fv(i,s):Mc(s)?t.uniform2fv(i,s.map(a=>[a.x,a.y]).flat()):Ec(s)&&t.uniform3fv(i,s.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function gn(e,t=Li,o=zi){let s=xc.replace("{{user}}",t??Li),i=yc.replace("{{user}}",o??zi);try{return new Bh(e,s,i,hn.map(a=>a.name))}catch(a){let l=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,c=Ic(a).match(l);if(!(c!=null&&c.groups))throw a;let r=Number(c.groups.line)-14,n=c.groups.msg.trim(),d=c.groups.type.toLowerCase();throw new Error(`${d} shader line ${r}: ${n}`)}}function Oh(e){if(!e)return x.gfx.defShader;if(typeof e=="string"){let t=ir(e);if(t)return t.data??t;if(Po()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof zt)return e.data?e.data:e;return e}function ir(e){return x.assets.shaders.get(e)??null}function Lh(e,t,o){return x.assets.shaders.addLoaded(e,gn(x.gfx.ggl,t,o))}function zh(e,t,o){t=Lt(t),o=Lt(o);let s=a=>a?wh(a):Promise.resolve(null),i=Promise.all([s(t),s(o)]).then(([a,l])=>gn(x.gfx.ggl,a,l));return x.assets.shaders.add(e,i)}var xs=class Xs{constructor(t){L(this,"buf");this.buf=t}static fromArrayBuffer(t){return new Promise((o,s)=>x.audio.ctx.decodeAudioData(t,o,s)).then(o=>new Xs(o))}static fromURL(t){return Wa(t)?Xs.fromArrayBuffer(Dc(t)):bh(t).then(o=>Xs.fromArrayBuffer(o))}};function Hh(e){if(typeof e=="string"){let t=nr(e);if(t)return t;if(Po()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof xs)return zt.loaded(e);if(e instanceof zt)return e;throw new Error(`Invalid sound: ${e}`)}}function nr(e){return x.assets.sounds.get(e)??null}function Nh(e,t){return t=Lt(t),x.assets.sounds.add(e,typeof t=="string"?xs.fromURL(t):xs.fromArrayBuffer(t))}function Uh(e,t){let o=Lt(t),s=new Audio(o);return s.preload="auto",x.assets.music[e]=o}function ar(e,t){return e=Lt(e),qi(typeof t=="string"?new Promise((o,s)=>{ci(t).then(i=>{ar(e,i).then(o).catch(s)})}):bo.from(e).then(o=>{let s={};for(let i in t){let a=t[i],l=o.frames[0],c=2048*l.w,r=2048*l.h,n=a.frames?a.frames.map(u=>new Ye(l.x+(a.x+u.x)/c*l.w,l.y+(a.y+u.y)/r*l.h,u.w/c*l.w,u.h/r*l.h)):er(a.sliceX||1,a.sliceY||1,l.x+a.x/c*l.w,l.y+a.y/r*l.h,a.width/c*l.w,a.height/r*l.h),d=new bo(o.tex,n,a.anims);x.assets.sprites.addLoaded(i,d),s[i]=d}return s}))}function Ao(e,t,o=!1,s,i,a={}){let l=s??x.gfx.defTex,c=i??x.gfx.defShader,r=Oh(c);if(!r||r instanceof zt)return;let n=x.gfx.fixed||o?x.gfx.transform:x.game.cam.transform.mult(x.gfx.transform),d=[];for(let u of e){let h=fh(n.multVec2(u.pos));d.push(h.x,h.y,u.uv.x,u.uv.y,u.color.r/255,u.color.g/255,u.color.b/255,u.opacity)}x.gfx.renderer.push(x.gfx.ggl.gl.TRIANGLES,d,t,r,l,a)}function fo(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Pt(),Ge(e.pos),ms(e.scale),Go(e.angle),Ge(e.offset),e.fill!==!1){let o=e.color??Me.WHITE,s=e.pts.map((a,l)=>({pos:new X(a.x,a.y),uv:e.uv?e.uv[l]:new X(0,0),color:e.colors&&e.colors[l]?e.colors[l].mult(o):o,opacity:e.opacity??1})),i;e.triangulate?i=Fa(e.pts).map(a=>a.map(l=>e.pts.indexOf(l))).flat():i=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),Ao(s,e.indices??i,e.fixed,e.uv?e.tex:x.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&mn({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),At()}}function rr(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,o=e.end??360,s=Wo(e.anchor??"center").scale(new X(-e.radiusX,-e.radiusY)),i=as(s,e.radiusX,e.radiusY,t,o,e.resolution);i.unshift(s);let a=Object.assign({},e,{pts:i,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(i.length-1).fill(e.gradient[1])]}:{}});if(o-t>=360&&e.outline){e.fill!==!1&&fo(Object.assign({},a,{outline:null})),fo(Object.assign({},a,{pts:i.slice(1),fill:!1}));return}fo(a)}function $o(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&rr(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function ls(e){let{p1:t,p2:o}=e;if(!t||!o)throw new Error('drawLine() requires properties "p1" and "p2".');let s=e.width||1,i=o.sub(t).unit().normal().scale(s*.5),a=[t.sub(i),t.add(i),o.add(i),o.sub(i)].map(l=>({pos:new X(l.x,l.y),uv:new X(0),color:e.color??Me.WHITE,opacity:e.opacity??1}));Ao(a,[0,1,3,1,2,3],e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function qh(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||N(0,0),l;i?l=t[0].sub(t[t.length-2]):l=t[1].sub(t[0]);let c=l.len(),r=l.normal().scale(-s/c),n,d=t[0];if(!i)switch(e.cap){case"square":{let f=l.scale(-s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(-1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)o.push(d),o.push(d.sub(g)),g=N(g.x*w-g.y*E,g.x*E+g.y*w)}}for(let f=1;f<t.length;f++){if(d===t[f]||d.eq(t[f]))continue;n=d,d=t[f];let A=d.sub(n),g=A.len(),w=A.normal().scale(-s/g),E=l.cross(A);if(Math.abs(E)/(c*g)<.05){o.push(n.add(r)),o.push(n.sub(r)),l.dot(A)<0&&(o.push(n.sub(r)),o.push(n.add(r))),l=A,c=g,r=w;continue}let T=w.sub(r).cross(A)/E,z=r.add(l.scale(T));E>0?(o.push(n.add(z)),o.push(n.sub(r)),o.push(n.add(z)),o.push(n.sub(w))):(o.push(n.add(r)),o.push(n.sub(z)),o.push(n.add(w)),o.push(n.sub(z))),l=A,c=g,r=w}if(!i)switch(o.push(d.add(r)),o.push(d.sub(r)),e.cap){case"square":{let f=l.scale(s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)g=N(g.x*w-g.y*E,g.x*E+g.y*w),o.push(d),o.push(d.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:N(),color:e.color||Me.WHITE,opacity:e.opacity??1})),h=[],y=0;for(let f=0;f<o.length-2;f+=2)h[y++]=f+1,h[y++]=f,h[y++]=f+2,h[y++]=f+2,h[y++]=f+3,h[y++]=f+1;i&&(h[y++]=o.length-1,h[y++]=o.length-2,h[y++]=0,h[y++]=0,h[y++]=1,h[y++]=o.length-1),Ao(u,h,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Fh(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||N(0,0),l;i?l=t[0].sub(t[t.length-2]):l=t[1].sub(t[0]);let c=l.len(),r=l.normal().scale(-s/c),n,d=t[0];if(!i)switch(e.cap){case"square":{let f=l.scale(-s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(-1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)o.push(d),o.push(d.sub(g)),g=N(g.x*w-g.y*E,g.x*E+g.y*w)}}for(let f=1;f<t.length;f++){if(d===t[f]||d.eq(t[f]))continue;n=d,d=t[f];let A=d.sub(n),g=A.len(),w=A.normal().scale(-s/g),E=l.cross(A);if(Math.abs(E)/(c*g)<.05){o.push(n.add(r)),o.push(n.sub(r)),l.dot(A)<0&&(o.push(n.sub(r)),o.push(n.add(r))),l=A,c=g,r=w;continue}let T=w.sub(r).cross(A)/E,z=r.add(l.scale(T));if(E>0){let q=n.add(z),p=Math.max(s,10),m=ke(r.angleBetween(w)/p),b=r,S=Math.cos(m),R=Math.sin(m);for(let P=0;P<p;P++)o.push(q),o.push(n.sub(b)),b=N(b.x*S-b.y*R,b.x*R+b.y*S)}else{let q=n.sub(z),p=Math.max(s,10),m=ke(r.angleBetween(w)/p),b=r,S=Math.cos(m),R=Math.sin(m);for(let P=0;P<p;P++)o.push(n.add(b)),o.push(q),b=N(b.x*S-b.y*R,b.x*R+b.y*S)}l=A,c=g,r=w}if(!i)switch(o.push(d.add(r)),o.push(d.sub(r)),e.cap){case"square":{let f=l.scale(s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)g=N(g.x*w-g.y*E,g.x*E+g.y*w),o.push(d),o.push(d.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:N(),color:e.color||Me.WHITE,opacity:e.opacity??1})),h=[],y=0;for(let f=0;f<o.length-2;f+=2)h[y++]=f+1,h[y++]=f,h[y++]=f+2,h[y++]=f+2,h[y++]=f+3,h[y++]=f+1;i&&(h[y++]=o.length-1,h[y++]=o.length-2,h[y++]=0,h[y++]=0,h[y++]=1,h[y++]=o.length-1),Ao(u,h,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function _h(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||N(0,0),l;i?l=t[0].sub(t[t.length-2]):l=t[1].sub(t[0]);let c=l.len(),r=l.normal().scale(-s/c),n,d=t[0];if(!i)switch(e.cap){case"square":{let f=l.scale(-s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(-1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)o.push(d),o.push(d.sub(g)),g=N(g.x*w-g.y*E,g.x*E+g.y*w)}}for(let f=1;f<t.length;f++){if(d===t[f]||d.eq(t[f]))continue;n=d,d=t[f];let A=d.sub(n),g=A.len(),w=A.normal().scale(-s/g),E=l.cross(A);if(Math.abs(E)/(c*g)<.05){o.push(n.add(r)),o.push(n.sub(r)),l.dot(A)<0&&(o.push(n.sub(r)),o.push(n.add(r))),l=A,c=g,r=w;continue}let T=w.sub(r).cross(A)/E,z=r.add(l.scale(T));o.push(n.add(z)),o.push(n.sub(z)),l=A,c=g,r=w}if(!i)switch(o.push(d.add(r)),o.push(d.sub(r)),e.cap){case"square":{let f=l.scale(s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)g=N(g.x*w-g.y*E,g.x*E+g.y*w),o.push(d),o.push(d.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:N(),color:e.color||Me.WHITE,opacity:e.opacity??1})),h=[],y=0;for(let f=0;f<o.length-2;f+=2)h[y++]=f+1,h[y++]=f,h[y++]=f+2,h[y++]=f+2,h[y++]=f+3,h[y++]=f+1;i&&(h[y++]=o.length-1,h[y++]=o.length-2,h[y++]=0,h[y++]=0,h[y++]=1,h[y++]=o.length-1),Ao(u,h,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function mn(e){let t=e.pts,o=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return qh(e);case"round":return Fh(e);case"miter":return _h(e)}if(e.radius&&t.length>=3){ls(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let s=1;s<t.length-2;s++){let i=t[s],a=t[s+1];ls(Object.assign({},e,{p1:i,p2:a}))}ls(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let s=0;s<t.length-1;s++)ls(Object.assign({},e,{p1:t[s],p2:t[s+1]})),e.join!=="none"&&$o(Object.assign({},e,{pos:t[s],radius:o/2}))}}function lr(e,t){let o=t.segments??16,s=[];for(let i=0;i<=o;i++)s.push(e(i/o));mn({pts:s,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Xh(e){lr(t=>cn(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var go=class cr{constructor(t,o,s,i={}){L(this,"ctx");L(this,"src",null);L(this,"glTex");L(this,"width");L(this,"height");this.ctx=t;let a=t.gl,l=t.gl.createTexture();if(!l)throw new Error("Failed to create texture");this.glTex=l,t.onDestroy(()=>this.free()),this.width=o,this.height=s;let c={linear:a.LINEAR,nearest:a.NEAREST}[i.filter??t.opts.texFilter??"nearest"],r={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[i.wrap??"clampToEdge"];this.bind(),o&&s&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,o,s,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,r),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,o,s={}){let i=new cr(t,o.width,o.height,s);return i.update(o),i.src=o,i}update(t,o=0,s=0){let i=this.ctx.gl;this.bind(),i.texSubImage2D(i.TEXTURE_2D,0,o,s,i.RGBA,i.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},$s=class{constructor(e,t,o,s={}){L(this,"ctx");L(this,"tex");L(this,"glFramebuffer");L(this,"glRenderbuffer");this.ctx=e;let i=e.gl;e.onDestroy(()=>this.free()),this.tex=new go(e,t,o,s);let a=i.createFramebuffer(),l=i.createRenderbuffer();if(!a||!l)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=l,this.bind(),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t,o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.tex.glTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let o=this.width*4,s=new Uint8Array(o);for(let i=0;i<(this.height/2|0);i++){let a=i*o,l=(this.height-i-1)*o;s.set(t.subarray(a,a+o)),t.copyWithin(a,l,l+o),t.set(s,l)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},Yh=class{constructor(e,t,o,s){L(this,"ctx");L(this,"glVBuf");L(this,"glIBuf");L(this,"vqueue",[]);L(this,"iqueue",[]);L(this,"stride");L(this,"maxVertices");L(this,"maxIndices");L(this,"vertexFormat");L(this,"numDraws",0);L(this,"curPrimitive",null);L(this,"curTex",null);L(this,"curShader",null);L(this,"curUniform",{});let i=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((l,c)=>l+c.size,0),this.maxVertices=o,this.maxIndices=s;let a=i.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),i.bufferData(i.ARRAY_BUFFER,o*4,i.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=i.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),i.bufferData(i.ELEMENT_ARRAY_BUFFER,s*4,i.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,o,s,i=null,a={}){(e!==this.curPrimitive||i!==this.curTex||s!==this.curShader||!un(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+o.length>this.maxIndices)&&this.flush();let l=this.vqueue.length/this.stride;for(let c of t)this.vqueue.push(c);for(let c of o)this.iqueue.push(c+l);this.curPrimitive=e,this.curShader=s,this.curTex=i,this.curUniform=a}flush(){var t,o;if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),(t=this.curTex)==null||t.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),(o=this.curTex)==null||o.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Eo(e){let t=[],o=a=>{t.push(a),e(a)},s=()=>{t.pop(),e(i()??null)},i=()=>t[t.length-1];return[o,s,i]}function Gh(e,t={}){let o=[];function s(q){o.push(q)}function i(){o.forEach(p=>p());let q=e.getExtension("WEBGL_lose_context");q&&q.loseContext()}let a=null;function l(q){if(un(q,a))return;a=q;let p=q.reduce((m,b)=>m+b.size,0);q.reduce((m,b,S)=>(e.vertexAttribPointer(S,b.size,e.FLOAT,!1,p*4,m),e.enableVertexAttribArray(S),m+b.size*4),0)}let[c,r]=Eo(q=>e.bindTexture(e.TEXTURE_2D,q)),[n,d]=Eo(q=>e.bindBuffer(e.ARRAY_BUFFER,q)),[u,h]=Eo(q=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,q)),[y,f]=Eo(q=>e.bindFramebuffer(e.FRAMEBUFFER,q)),[A,g]=Eo(q=>e.bindRenderbuffer(e.RENDERBUFFER,q)),[w,E]=Eo(q=>{if(!q)return;let{x:p,y:m,w:b,h:S}=q;e.viewport(p,m,b,S)}),[T,z]=Eo(q=>e.useProgram(q));return w({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:s,destroy:i,pushTexture2D:c,popTexture2D:r,pushArrayBuffer:n,popArrayBuffer:d,pushElementArrayBuffer:u,popElementArrayBuffer:h,pushFramebuffer:y,popFramebuffer:f,pushRenderbuffer:A,popRenderbuffer:g,pushViewport:w,popViewport:E,pushProgram:T,popProgram:z,setVertexFormat:l}}var Ai={};function Yn(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(N(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function Fi(e){let t={},o="",s=[],i=String(e),a=l=>{s.length>0&&(t[o.length]=s.slice()),o+=l};for(;i!=="";){if(i[0]==="\\"){if(i.length===1)throw new Error("Styled text error: \\ at end of string");a(i[1]),i=i.slice(2);continue}if(i[0]==="["){let l=/^\[(\/)?(\w+?)\]/.exec(i);if(!l){a(i[0]),i=i.slice(1);continue}let[c,r,n]=l;if(r!==void 0){let d=s.pop();if(d!==n)throw d!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${d}], got [/${n}]`):new Error(`Styled text error: stray end tag [/${n}]`)}else s.push(n);i=i.slice(c.length);continue}a(i[0]),i=i.slice(1)}if(s.length>0)throw new Error(`Styled text error: unclosed tags ${s}`);return{charStyleMap:t,text:o}}function Bo(e){var T,z,q;if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=tr(e.font);if(!e.text||e.text===""||t instanceof zt||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:o,text:s}=Fi(e.text+""),i=Oc(s);if(t instanceof _s||typeof t=="string"){let p=t instanceof _s?t.fontface.family:t,m=t instanceof _s?{outline:t.outline,filter:t.filter}:{outline:null,filter:Oi},b=Ai[p]??{font:{tex:new go(x.gfx.ggl,2048,2048,{filter:m.filter}),map:{},size:64},cursor:new X(0),maxHeight:0,outline:m.outline};Ai[p]||(Ai[p]=b),t=b.font;for(let S of i)if(!b.font.map[S]){let R=x.fontCacheC2d;if(!R)throw new Error("fontCacheC2d is not defined.");if(!x.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");R.clearRect(0,0,x.fontCacheCanvas.width,x.fontCacheCanvas.height),R.font=`${t.size}px ${p}`,R.textBaseline="top",R.textAlign="left",R.fillStyle="#ffffff";let P=R.measureText(S),D=Math.ceil(P.width);if(!D)continue;let I=Math.ceil(Math.abs(P.actualBoundingBoxAscent))+Math.ceil(Math.abs(P.actualBoundingBoxDescent));b.outline&&b.outline.width&&b.outline.color&&(R.lineJoin="round",R.lineWidth=b.outline.width*2,R.strokeStyle=b.outline.color.toHex(),R.strokeText(S,b.outline.width,b.outline.width),D+=b.outline.width*2,I+=b.outline.width*3),R.fillText(S,((T=b.outline)==null?void 0:T.width)??0,((z=b.outline)==null?void 0:z.width)??0);let C=R.getImageData(0,0,D,I);if(b.cursor.x+D>2048&&(b.cursor.x=0,b.cursor.y+=b.maxHeight,b.maxHeight=0,b.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(C,b.cursor.x,b.cursor.y),t.map[S]=new Ye(b.cursor.x,b.cursor.y,D,I),b.cursor.x+=D+1,b.maxHeight=Math.max(b.maxHeight,I)}}let a=e.size||t.size,l=N(e.scale??1).scale(a/t.size),c=e.lineSpacing??0,r=e.letterSpacing??0,n=0,d=0,u=0,h=[],y=[],f=0,A=null,g=0,w;for(;f<i.length;){let p=i[f];if(p===`
`)u+=a+c,h.push({width:n-r,chars:y}),A=null,g=0,n=0,y=[],w=void 0;else{let m=t.map[p];if(m){let b=m.w*l.x;e.width&&n+b>e.width&&(u+=a+c,A!=null&&(f-=y.length-A,p=i[f],m=t.map[p],b=m.w*l.x,y=y.slice(0,A-1),n=g),A=null,g=0,h.push({width:n-r,chars:y}),n=w??0,y=[]),y.push({tex:t.tex,width:m.w,height:m.h,quad:new Ye(m.x/t.tex.width,m.y/t.tex.height,m.w/t.tex.width,m.h/t.tex.height),ch:p,pos:new X(n,u),opacity:e.opacity??1,color:e.color??Me.WHITE,scale:N(l),angle:0}),p===" "&&(A=y.length,g=n),e.indentAll&&w===void 0&&/\S/.test(p)&&(w=n),n+=b,d=Math.max(d,n),n+=r}}f++}h.push({width:n-r,chars:y}),u+=a,e.width&&(d=e.width);let E=[];for(let p=0;p<h.length;p++){let m=(d-h[p].width)*rh(e.align??"left");for(let b of h[p].chars){let S=t.map[b.ch],R=E.length+p;if(b.pos=b.pos.add(m,0).add(S.w*l.x*.5,S.h*l.y*.5),e.transform){let P=typeof e.transform=="function"?e.transform(R,b.ch):e.transform;P&&Yn(b,P)}if(o[R]){let P=o[R];for(let D of P){let I=(q=e.styles)==null?void 0:q[D],C=typeof I=="function"?I(R,b.ch):I;C&&Yn(b,C)}}E.push(b)}}return{width:d,height:u,chars:E,opt:e,renderedText:s}}function ys(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,s=Wo(e.anchor||li).scale(new X(t,o).scale(-.5)),i=e.quad||new Ye(0,0,1,1),a=e.color||Pe(255,255,255),l=e.opacity??1,c=e.tex?.1/e.tex.width:0,r=e.tex?.1/e.tex.height:0,n=i.x+c,d=i.y+r,u=i.w-c*2,h=i.h-r*2;Pt(),Ge(e.pos),Go(e.angle),ms(e.scale),Ge(s),Ao([{pos:new X(-t/2,o/2),uv:new X(e.flipX?n+u:n,e.flipY?d:d+h),color:a,opacity:l},{pos:new X(-t/2,-o/2),uv:new X(e.flipX?n+u:n,e.flipY?d+h:d),color:a,opacity:l},{pos:new X(t/2,-o/2),uv:new X(e.flipX?n:n+u,e.flipY?d+h:d),color:a,opacity:l},{pos:new X(t/2,o/2),uv:new X(e.flipX?n:n+u,e.flipY?d:d+h),color:a,opacity:l}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),At()}function Oo(e){Pt(),Ge(e.opt.pos),Go(e.opt.angle),Ge(Wo(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{ys({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),At()}function Ot(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,s=Wo(e.anchor||li).add(1,1).scale(new X(t,o).scale(-.5)),i=[new X(0,0),new X(t,0),new X(t,o),new X(0,o)];if(e.radius){let a=Math.min(t,o)/2,l=Array.isArray(e.radius)?e.radius.map(c=>Math.min(a,c)):new Array(4).fill(Math.min(a,e.radius));i=[new X(l[0],0),...l[1]?as(new X(t-l[1],l[1]),l[1],l[1],270,360):[N(t,0)],...l[2]?as(new X(t-l[2],o-l[2]),l[2],l[2],0,90):[N(t,o)],...l[3]?as(new X(l[3],o-l[3]),l[3],l[3],90,180):[N(0,o)],...l[0]?as(new X(l[0],l[0]),l[0],l[0],180,270):[]]}fo(Object.assign({},e,{offset:s,pts:i,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function uo(e){Bt();let t=x.gfx.width,o=x.gfx.height;x.gfx.width=x.gfx.viewport.width,x.gfx.height=x.gfx.viewport.height,e(),Bt(),x.gfx.width=t,x.gfx.height=o}function Gn(e,t){uo(()=>{let o=N(8);Pt(),Ge(e);let s=Bo({text:t,font:js,size:16,pos:o,color:Pe(255,255,255),fixed:!0}),i=s.width+o.x*2,a=s.height+o.x*2;e.x+i>=ht()&&Ge(N(-i,0)),e.y+a>=mt()&&Ge(N(0,-a)),Ot({width:i,height:a,color:Pe(0,0,0),radius:4,opacity:.8,fixed:!0}),Oo(s),At()})}function hr(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return fo(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Kh(){if(x.debug.inspect){let e=null;for(let t of x.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(x.game.root.drawInspect(),e){let t=[],o=e.inspect();for(let s in o)o[s]?t.push(`${o[s]}`):t.push(`${s}`);Gn(Kc(x.k.mousePos()),t.join(`
`))}Gn(N(8),`FPS: ${x.debug.fps()}`)}x.debug.paused&&uo(()=>{Pt(),Ge(ht(),0),Ge(-8,8);let e=32;Ot({width:e,height:e,anchor:"topright",color:Pe(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)Ot({width:4,height:e*.6,anchor:"center",pos:N(-e/3*t,e*.5),color:Pe(255,255,255),radius:2,fixed:!0});At()}),x.debug.timeScale!==1&&uo(()=>{Pt(),Ge(ht(),mt()),Ge(-8,-8);let e=8,t=Bo({text:x.debug.timeScale.toFixed(1),font:js,size:16,color:Pe(255,255,255),pos:N(-e),anchor:"botright",fixed:!0});Ot({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Pe(0,0,0),opacity:.8,radius:4,fixed:!0});for(let o=0;o<2;o++){let s=x.debug.timeScale<1;hr({p1:N(-t.width-e*(s?2:3.5),-e),p2:N(-t.width-e*(s?2:3.5),-e-t.height),p3:N(-t.width-e*(s?3.5:2),-e-t.height/2),pos:N(-o*e*1+(s?-e*.5:0),0),color:Pe(255,255,255),fixed:!0})}Oo(t),At()}),x.debug.curRecording&&uo(()=>{Pt(),Ge(0,mt()),Ge(24,-24),$o({radius:12,color:Pe(255,0,0),opacity:Ma(0,1,x.app.time()*4),fixed:!0}),At()}),x.debug.showLog&&x.game.logs.length>0&&uo(()=>{Pt(),Ge(0,mt()),Ge(8,-8);let e=8,t=[];for(let s of x.game.logs){let i="",a=s.msg instanceof Error?"error":"info";i+=`[time]${s.time.toFixed(2)}[/time]`,i+=" ",i+=`[${a}]${_i(s.msg)}[/${a}]`,t.push(i)}x.game.logs=x.game.logs.filter(s=>x.app.time()-s.time<(x.globalOpt.logTime||4));let o=Bo({text:t.join(`
`),font:js,pos:N(e,-e),anchor:"botleft",size:16,width:ht()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Pe(127,127,127)},info:{color:Pe(255,255,255)},error:{color:Pe(255,0,127)}}});Ot({width:o.width+e*2,height:o.height+e*2,anchor:"botleft",color:Pe(0,0,0),radius:4,opacity:.8,fixed:!0}),Oo(o),At()})}function _i(e,t=!1,o=new Set){if(o.has(e))return"<recursive>";var s="",i;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(s=["[",e.map(a=>_i(a,!0,o.union(new Set([e])))).join(", "),"]"].join(""),e=s),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(s+=e.constructor.name+" "),s+=["{",(i=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${_i(e[a],!0,o.union(new Set([e])))}`).join(", "))?` ${i} `:"","}"].join(""),e=s),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function Vh(){let e=x.game.cam,t=X.fromAngle(lt(0,360)).scale(e.shake);e.shake=vt(e.shake,0,5*ct()),e.transform=new Kt().translate(Ws()).scale(e.scale).rotate(e.angle).translate((e.pos??Ws()).scale(-1).add(t)),x.game.root.draw(),Bt()}function jh(){let e=Po();x.game.events.numListeners("loading")>0?x.game.events.trigger("loading",e):uo(()=>{let t=ht()/2,o=24,s=N(ht()/2,mt()/2).sub(N(t/2,o/2));Ot({pos:N(0),width:ht(),height:mt(),color:Pe(0,0,0)}),Ot({pos:s,width:t,height:o,fill:!1,outline:{width:4}}),Ot({pos:s,width:t*e,height:o})})}function dr(e,t,o){let s=x.gfx.ggl.gl;Bt(),s.clear(s.STENCIL_BUFFER_BIT),s.enable(s.STENCIL_TEST),s.stencilFunc(s.NEVER,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),t(),Bt(),s.stencilFunc(o,1,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),e(),Bt(),s.disable(s.STENCIL_TEST)}function Wh(e,t){let o=x.gfx.ggl.gl;dr(e,t,o.EQUAL)}function Js(e){var a,l;if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new Ye(0,0,1,1),o=e.tex.width*t.w,s=e.tex.height*t.h,i=new X(1);if(e.tiled){let c=Wo(e.anchor||li);(((a=e.pos)==null?void 0:a.x)||0)-(c.x+1)*.5*(e.width||o),(((l=e.pos)==null?void 0:l.y)||0)-(c.y+1)*.5*(e.height||s);let r=(e.width||o)/o,n=(e.height||s)/s,d=Math.floor(r),u=Math.floor(n),h=r-d,y=n-u,f=(d+h?1:0)*(u+y?1:0),A=new Array(f*6),g=new Array(f*4),w=0,E=(T,z,q,p,m)=>{A[w*6+0]=w*4+0,A[w*6+1]=w*4+1,A[w*6+2]=w*4+3,A[w*6+3]=w*4+1,A[w*6+4]=w*4+2,A[w*6+5]=w*4+3,g[w*4+0]={pos:new X(T-c.x,z-c.y),uv:new X(m.x,m.y),color:e.color||Me.WHITE,opacity:e.opacity||1},g[w*4+1]={pos:new X(T+q-c.x,z-c.y),uv:new X(m.x+m.w,m.y),color:e.color||Me.WHITE,opacity:e.opacity||1},g[w*4+2]={pos:new X(T+q-c.x,z+p-c.y),uv:new X(m.x+m.w,m.y+m.h),color:e.color||Me.WHITE,opacity:e.opacity||1},g[w*4+3]={pos:new X(T-c.x,z+p-c.y),uv:new X(m.x,m.y+m.h),color:e.color||Me.WHITE,opacity:e.opacity||1},w++};for(let T=0;T<u;T++){for(let z=0;z<d;z++)E(z*o,T*s,o,s,t);h&&E(d*o,T*s,o*h,s,new Ye(t.x,t.y,t.w*h,t.h))}if(y){for(let T=0;T<d;T++)E(T*o,u*s,o,s*y,new Ye(t.x,t.y,t.w,t.h*y));h&&E(d*o,u*s,o*h,s*y,new Ye(t.x,t.y,t.w*h,t.h*y))}Ao(g,A,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(i.x=e.width/o,i.y=e.height/s):e.width?(i.x=e.width/o,i.y=i.x):e.height&&(i.y=e.height/s,i.x=i.y),ys(Object.assign({},e,{scale:i.scale(e.scale||new X(1)),tex:e.tex,quad:t,width:o,height:s}))}function $h(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Fs(e.sprite);if(!t||!t.data)return;let o=t.data.frames[e.frame??0];if(!o)throw new Error(`Frame not found: ${e.frame??0}`);Js(Object.assign({},e,{tex:t.data.tex,quad:o.scale(e.quad??new Ye(0,0,1,1))}))}function Jh(e,t){let o=x.gfx.ggl.gl;dr(e,t,o.NOTEQUAL)}function Kn(e){Oo(Bo(e))}var Qh=(e,t)=>{let o=gn(t,Li,zi),s=e.pixelDensity??1,i=e.scale??1,{gl:a}=t,l=go.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),c=e.width&&e.height?new $s(t,e.width*s*i,e.height*s*i):new $s(t,a.drawingBufferWidth,a.drawingBufferHeight),r=null,n=1;e.background&&(typeof e.background=="string"?r=Pe(e.background):(r=Pe(...e.background),n=e.background[3]??1),a.clearColor(r.r/255,r.g/255,r.b/255,n??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let d=new Yh(t,hn,gc,mc),u=go.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:o,defTex:l,frameBuffer:c,postShader:null,postShaderUniform:null,renderer:d,transform:new Kt,transformStack:[],bgTex:u,bgColor:r,bgAlpha:n,width:e.width??a.drawingBufferWidth/s/i,height:e.height??a.drawingBufferHeight/s/i,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function To(e){return e.fixed?!0:e.parent?To(e.parent):!1}function Lo(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Zh(e,t={}){return{id:"circle",radius:e,draw(){$o(Object.assign(Lo(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Ue(new X(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function ur(...e){return{id:"color",color:Pe(...e),inspect(){return`color: ${this.color.toString()}`}}}function kh(e){return{add(){this.canvas=e}}}function ed(e=1){let t,o=0,s=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){s||(o+=ct(),this.opacity=Xt(o,0,e,0,t),o>=e&&(this.opacity=t,s=!0))}}}function td(e="intersect"){return{id:"mask",mask:e}}function pr(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,o=x.k.easings.linear){return x.game.root.tween(0,this.opacity,t,s=>this.opacity=s,o)},fadeOut(t=1,o=x.k.easings.linear){return x.game.root.tween(this.opacity,0,t,s=>this.opacity=s,o)},inspect(){return`opacity: ${Hi(this.opacity,1)}`}}}function od(e=1,t=Pe(0,0,0),o=1,s="miter",i=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:o,join:s,miterLimit:i,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var sd=class{constructor(){L(this,"pos",N(0));L(this,"vel",N(0));L(this,"acc",N(0));L(this,"angle",0);L(this,"angularVelocity",0);L(this,"damping",0);L(this,"t");L(this,"lt",null);L(this,"gc");this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function id(e,t){let o=t.lifetime,s=[],i=e.colors||[Me.WHITE],a=e.opacities||[1],l=e.quads||[new Ye(0,0,1,1)],c=e.scales||[1],r=e.lifeTime,n=t.direction,d=t.spread,u=e.speed||[0,0],h=e.angle||[0,0],y=e.angularVelocity||[0,0],f=e.acceleration||[N(0),N(0)],A=e.damping||[0,0],g=[],w=new Array(e.max),E=0,T=0;for(let p=0;p<e.max;p++){g[p*6+0]=p*4+0,g[p*6+1]=p*4+1,g[p*6+2]=p*4+3,g[p*6+3]=p*4+1,g[p*6+4]=p*4+2,g[p*6+5]=p*4+3;for(let m=0;m<4;m++)w[p*4+m]={pos:new X(0,0),uv:new X(0,0),color:Pe(255,255,255),opacity:1};s[p]=new sd}let z=new yt;function q(p=0){for(;p<e.max;){if(s[p].gc)return p;p++}return null}return{id:"particles",emit(p){let m=0;for(let b=0;b<p;b++){if(m=q(m),m==null)return;let S=lt(n-d,n+d),R=X.fromAngle(S).scale(lt(u[0],u[1])),P=lt(h[0],h[1]),D=lt(y[0],y[1]),I=N(lt(f[0].x,f[1].x),lt(f[0].y,f[1].y)),C=lt(A[0],A[1]),U=r?lt(r[0],r[1]):null,Y=t.shape?t.shape.random():N(),G=s[m];G.lt=U,G.pos=Y,G.vel=R,G.acc=I,G.angle=P,G.angularVelocity=D,G.damping=C,G.angularVelocity=D,G.gc=!1}E+=p},update(){if(o!==void 0&&o<=0)return;let p=ct();for(let m of s)if(!m.gc){if(m.t+=p,m.lt&&m.t>=m.lt){m.gc=!0,E--;continue}m.vel=m.vel.add(m.acc.scale(p)).scale(1-m.damping*p),m.pos=m.pos.add(m.vel.scale(p)),m.angle+=m.angularVelocity*p}for(o!==void 0&&(o-=p,o<=0&&z.trigger()),T+=p;E<e.max&&t.rate&&T>t.rate;)this.emit(1),E++,T-=t.rate},draw(){if(!(o!==void 0&&o<=0)){for(let p=0;p<s.length;p++){let m=s[p];if(m.gc)continue;let b=m.progress,S=Math.floor(m.progress*i.length),R=S<i.length-1?vt(i[S],i[S+1],Xt(b,S/i.length,(S+1)/i.length,0,1)):i[S],P=Math.floor(m.progress*a.length),D=P<a.length-1?vt(a[P],a[P+1],Xt(b,P/a.length,(P+1)/a.length,0,1)):a[P],I=Math.floor(m.progress*l.length),C=l[I],U=Math.floor(m.progress*c.length),Y=c[U],G=Math.cos(m.angle*Math.PI/180),K=Math.sin(m.angle*Math.PI/180),$=(e.texture?e.texture.width:10)*C.w/2,V=(e.texture?e.texture.height:10)*C.h/2,ue=p*4,Q=w[ue];Q.pos.x=m.pos.x+-$*Y*G- -V*Y*K,Q.pos.y=m.pos.y+-$*Y*K+-V*Y*G,Q.uv.x=C.x,Q.uv.y=C.y,Q.color.r=R.r,Q.color.g=R.g,Q.color.b=R.b,Q.opacity=D,Q=w[ue+1],Q.pos.x=m.pos.x+$*Y*G- -V*Y*K,Q.pos.y=m.pos.y+$*Y*K+-V*Y*G,Q.uv.x=C.x+C.w,Q.uv.y=C.y,Q.color.r=R.r,Q.color.g=R.g,Q.color.b=R.b,Q.opacity=D,Q=w[ue+2],Q.pos.x=m.pos.x+$*Y*G-V*Y*K,Q.pos.y=m.pos.y+$*Y*K+V*Y*G,Q.uv.x=C.x+C.w,Q.uv.y=C.y+C.h,Q.color.r=R.r,Q.color.g=R.g,Q.color.b=R.b,Q.opacity=D,Q=w[ue+3],Q.pos.x=m.pos.x+-$*Y*G-V*Y*K,Q.pos.y=m.pos.y+-$*Y*K+V*Y*G,Q.uv.x=C.x,Q.uv.y=C.y+C.h,Q.color.r=R.r,Q.color.g=R.g,Q.color.b=R.b,Q.opacity=D}Ao(w,g,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(p){return z.add(p)},inspect(){return`count: ${E}/${e.max}`}}}function nd(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){fo(Object.assign(Lo(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new wt(this.pts)},inspect(){return`polygon: ${this.pts.map(o=>`[${o.x},${o.y}]`).join(",")}`}}}function fr(e,t,o){let s;return x.game.root.get("area").forEach(i=>{if(o&&o.some(l=>i.is(l)))return;let a=i.worldArea().raycast(e,t);a&&(s?a.fraction<s.fraction&&(s=a,s.object=i):(s=a,s.object=i))}),s}function gr(e,t,o={}){return{id:"rect",width:e,height:t,radius:o.radius||0,draw(){Ot(Object.assign(Lo(this),{width:this.width,height:this.height,radius:this.radius,fill:o.fill}))},renderArea(){return new Ue(N(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function ad(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function rd(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let o=x.game.root.add([Qs(t.pos??N(0))]),s=e.length,i=0,a=null,l=null,c=null,r=null,n=p=>p.x+p.y*i,d=p=>N(Math.floor(p%i),Math.floor(p/i)),u=()=>{a=[];for(let p of o.children)h(p)},h=p=>{let m=n(p.tilePos);a[m]?a[m].push(p):a[m]=[p]},y=p=>{let m=n(p.tilePos);if(a[m]){let b=a[m].indexOf(p);b>=0&&a[m].splice(b,1)}},f=()=>{let p=!1;for(let m of o.children){let b=o.pos2Tile(m.pos);(m.tilePos.x!=b.x||m.tilePos.y!=b.y)&&(p=!0,y(m),m.tilePos.x=b.x,m.tilePos.y=b.y,h(m))}p&&o.trigger("spatialMapChanged")},A=()=>{let p=o.getSpatialMap(),m=o.numRows()*o.numColumns();l?l.length=m:l=new Array(m),l.fill(1,0,m);for(let b=0;b<p.length;b++){let S=p[b];if(S){let R=0;for(let P of S)if(P.isObstacle){R=1/0;break}else R+=P.cost;l[b]=R||1}}},g=()=>{let p=o.getSpatialMap(),m=o.numRows()*o.numColumns();c?c.length=m:c=new Array(m),c.fill(15,0,m);for(let b=0;b<p.length;b++){let S=p[b];if(S){let R=S.length,P=15;for(let D=0;D<R;D++)P|=S[D].edgeMask;c[b]=P}}},w=()=>{let p=o.numRows()*o.numColumns(),m=(S,R)=>{let P=[];for(P.push(S);P.length>0;){let D=P.pop();z(D).forEach(I=>{r[I]<0&&(r[I]=R,P.push(I))})}};r?r.length=p:r=new Array(p),r.fill(-1,0,p);let b=0;for(let S=0;S<l.length;S++){if(r[S]>=0){b++;continue}m(S,b),b++}},E=(p,m)=>l[m],T=(p,m)=>{let b=d(p),S=d(m);return b.dist(S)},z=(p,m)=>{let b=[],S=Math.floor(p%i),R=S>0&&c[p]&1&&l[p-1]!==1/0,P=p>=i&&c[p]&2&&l[p-i]!==1/0,D=S<i-1&&c[p]&4&&l[p+1]!==1/0,I=p<i*s-i-1&&c[p]&8&&l[p+i]!==1/0;return m?(R&&(P&&b.push(p-i-1),b.push(p-1),I&&b.push(p+i-1)),P&&b.push(p-i),D&&(P&&b.push(p-i+1),b.push(p+1),I&&b.push(p+i+1)),I&&b.push(p+i)):(R&&b.push(p-1),P&&b.push(p-i),D&&b.push(p+1),I&&b.push(p+i)),b},q={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(p,...m){let b=N(...m),S=(()=>{if(typeof p=="string"){if(t.tiles[p]){if(typeof t.tiles[p]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[p](b)}else if(t.wildcardTile)return t.wildcardTile(p,b)}else{if(Array.isArray(p))return p;throw new Error("Expected a symbol or a component list")}})();if(!S)return null;let R=!1,P=!1;for(let I of S)I.id==="tile"&&(P=!0),I.id==="pos"&&(R=!0);R||S.push(Qs(this.tile2Pos(b))),P||S.push(Or());let D=o.add(S);return R&&(D.tilePosOffset=D.pos.clone()),D.tilePos=b,D.transform=hs(D),a&&(h(D),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),D},numColumns(){return i},numRows(){return s},levelWidth(){return i*this.tileWidth()},levelHeight(){return s*this.tileHeight()},tile2Pos(...p){return N(...p).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...p){let m=N(...p);return N(Math.floor(m.x/this.tileWidth()),Math.floor(m.y/this.tileHeight()))},getSpatialMap(){return a||u(),a},removeFromSpatialMap:y,insertIntoSpatialMap:h,onSpatialMapChanged(p){return this.on("spatialMapChanged",p)},onNavigationMapInvalid(p){return this.on("navigationMapInvalid",p)},getAt(p){a||u();let m=n(p);return a[m]||[]},raycast(p,m){let b=this.toWorld(p),S=this.toWorld(p.add(m)).sub(b),R=1/this.tileWidth(),P=p.scale(R),D=Xl(P,m,I=>{let C=this.getAt(I);if(C.some(Y=>Y.isObstacle))return!0;let U=null;for(let Y of C)if(Y.has("area")){let G=Y.worldArea().raycast(b,S);G&&(U?G.fraction<U.fraction&&(U=G,U.object=Y):(U=G,U.object=Y))}return U&&(U.point=this.fromWorld(U.point).scale(R)),U||!1},64);return D&&(D.point=D.point.scale(this.tileWidth())),D},update(){a&&f()},invalidateNavigationMap(){l=null,c=null,r=null},onNavigationMapChanged(p){return this.on("navigationMapChanged",p)},getTilePath(p,m,b={}){var G;if(l||A(),c||g(),r||w(),p.x<0||p.x>=i||p.y<0||p.y>=s||m.x<0||m.x>=i||m.y<0||m.y>=s)return null;let S=n(p),R=n(m);if(l[R]===1/0)return null;if(S===R)return[];if(r[S]!=-1&&r[S]!==r[R])return null;let P=new Va((K,$)=>K.cost<$.cost);P.insert({cost:0,node:S});let D=new Map;D.set(S,S);let I=new Map;for(I.set(S,0);P.length!==0;){let K=(G=P.remove())==null?void 0:G.node;if(K===R)break;let $=z(K,b.allowDiagonals);for(let V of $){let ue=(I.get(K)||0)+E(K,V)+T(V,R);(!I.has(V)||ue<I.get(V))&&(I.set(V,ue),P.insert({cost:ue,node:V}),D.set(V,K))}}let C=[],U=R,Y=d(U);for(C.push(Y);U!==S;){let K=D.get(U);if(K===void 0)throw new Error("Bug in pathfinding algorithm");U=K;let $=d(U);C.push($)}return C.reverse()},getPath(p,m,b={}){let S=this.tileWidth(),R=this.tileHeight(),P=this.getTilePath(this.pos2Tile(p),this.pos2Tile(m),b);return P?[p,...P.slice(1,-1).map(D=>D.scale(S,R).add(S/2,R/2)),m]:null}};return o.use(q),o.onNavigationMapInvalid(()=>{o.invalidateNavigationMap(),o.trigger("navigationMapChanged")}),e.forEach((p,m)=>{let b=p.split("");i=Math.max(b.length,i),b.forEach((S,R)=>{o.spawn(S,N(R,m))})}),o}function St(e,t,o){return x.game.objEvents.registers[e]||(x.game.objEvents.registers[e]=new Ga),x.game.objEvents.on(e,(s,...i)=>{s.is(t)&&o(s,...i)})}var ld=(e,t,...o)=>{for(let s of x.game.root.children)s.is(t)&&s.trigger(e,o)},cd=_e(e=>{let t=x.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>St("fixedUpdate",e,t)),mr=_e(e=>{let t=x.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>St("update",e,t)),hd=_e(e=>{let t=x.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(o){t.hidden=o},cancel:()=>t.destroy()}},(e,t)=>St("draw",e,t)),xr=_e(e=>x.game.events.on("add",e),(e,t)=>St("add",e,t)),dd=_e(e=>x.game.events.on("destroy",e),(e,t)=>St("destroy",e,t)),ud=_e(e=>x.game.events.on("use",e),(e,t)=>St("use",e,t)),pd=_e(e=>x.game.events.on("unuse",e),(e,t)=>St("unuse",e,t)),yr=_e(e=>x.game.events.on("tag",e),(e,t)=>St("tag",e,t)),fd=_e(e=>x.game.events.on("untag",e),(e,t)=>St("untag",e,t));function gd(e,t,o){return St("collide",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function md(e,t,o){return St("collideUpdate",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function xd(e,t,o){return St("collideEnd",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function di(e,t){x.game.root.get(e,{recursive:!0}).forEach(t),xr(e,t),yr((o,s)=>{s===e&&t(o)})}var yd=_e(e=>x.app.onMousePress(e),(e,t)=>{let o=[];return di(e,s=>{if(!s.area)throw new Error("onClick() requires the object to have area() component");o.push(s.onClick(()=>t(s)))}),zo.join(o)});function wd(e,t){let o=[];return di(e,s=>{if(!s.area)throw new Error("onHover() requires the object to have area() component");o.push(s.onHover(()=>t(s)))}),zo.join(o)}function bd(e,t){let o=[];return di(e,s=>{if(!s.area)throw new Error("onHoverUpdate() requires the object to have area() component");o.push(s.onHoverUpdate(()=>t(s)))}),zo.join(o)}function Ad(e,t){let o=[];return di(e,s=>{if(!s.area)throw new Error("onHoverEnd() requires the object to have area() component");o.push(s.onHoverEnd(()=>t(s)))}),zo.join(o)}function vd(e){x.game.events.on("loading",e)}function Ed(e){x.app.onResize(e)}function Md(e){x.game.events.on("error",e)}function xn(e){x.assets.loaded?e():x.game.events.on("load",e)}function Sd(e){if(x.assets.loaded)Za().forEach(t=>e(...t));else return x.game.events.on("loadError",e)}function wr(...e){x.game.cam.pos=N(...e)}function br(){return x.game.cam.pos?x.game.cam.pos.clone():Ws()}function Ar(...e){x.game.cam.scale=N(...e)}function vr(){return x.game.cam.scale.clone()}function Er(e){x.game.cam.angle=e}function Mr(){return x.game.cam.angle}function Rd(){return x.game.cam.transform.clone()}function Sr(e=Pe(255,255,255),t=1){let o=x.game.root.add([gr(ht(),mt()),ur(e),pr(1),Hr()]),s=o.fadeOut(t);return s.onEnd(()=>Br(o)),s}function Dd(){return x.game.cam.transform.clone()}function Td(e=12){x.game.cam.shake+=e}function Xi(e){return x.game.cam.transform.multVec2(e)}function Rr(e){return x.game.cam.transform.invert().multVec2(e)}function Cd(...e){return jo("camPos","setCamPos / getCamPos"),e.length>0&&wr(...e),br()}function Id(...e){return jo("camScale","setCamScale / getCamScale"),e.length>0&&Ar(...e),vr()}function Pd(e){return jo("camRot","setCamRot / getCamRot"),e!==void 0&&Er(e),Mr()}function Bd(e=Pe(255,255,255),t=1){return jo("camFlash","flash"),Sr(e,t)}function yn(e=[]){let t=new Map,o=[],s={},i=new fs,a=[],l=new Set("*"),c=x.globalOpt.tagsAsComponents,r=null,n=!1,d={id:Yc(),hidden:!1,transform:new Kt,children:[],parent:null,set paused(h){if(h!==n){n=h;for(let y of a)y.paused=h}},get paused(){return n},get tags(){return Array.from(l)},add(h){let y=Array.isArray(h)?yn(h):h;if(y.parent)throw new Error("Cannot add a game obj that already has a parent.");return y.parent=this,y.transform=hs(y),this.children.push(y),y.trigger("add",y),x.game.events.trigger("add",y),y},readd(h){let y=this.children.indexOf(h);return y!==-1&&(this.children.splice(y,1),this.children.push(h)),h},remove(h){let y=this.children.indexOf(h);if(y!==-1){h.parent=null,this.children.splice(y,1);let f=A=>{A.trigger("destroy"),x.game.events.trigger("destroy",A),A.children.forEach(g=>f(g))};f(h)}},removeAll(h){if(h)this.get(h).forEach(y=>this.remove(y));else for(let y of[...this.children])this.remove(y)},fixedUpdate(){this.paused||(this.children.forEach(h=>h.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(h=>h.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Bt(),this.canvas.bind());let h=x.gfx.fixed;this.fixed&&(x.gfx.fixed=!0),Pt(),Ge(this.pos),ms(this.scale),Go(this.angle);let y=this.children.sort((f,A)=>{let g=f.layerIndex??x.game.defaultLayerIndex,w=A.layerIndex??x.game.defaultLayerIndex;return g-w||(f.z??0)-(A.z??0)});if(this.mask){let f={intersect:x.k.drawMasked,subtract:x.k.drawSubtracted}[this.mask];if(!f)throw new Error(`Invalid mask func: "${this.mask}"`);f(()=>{y.forEach(A=>A.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),y.forEach(f=>f.draw());At(),x.gfx.fixed=h,this.canvas&&(Bt(),this.canvas.unbind())},drawInspect(){this.hidden||(Pt(),Ge(this.pos),ms(this.scale),Go(this.angle),this.children.forEach(h=>h.drawInspect()),this.trigger("drawInspect"),At())},use(h){var A;if(typeof h=="string")return l.add(h);if(!h||typeof h!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof h}"`);let y=[];h.id?(this.unuse(h.id),s[h.id]=[],y=s[h.id],t.set(h.id,h),c&&l.add(h.id)):o.push(h);for(let g in h){if(wc.has(g))continue;let w=Object.getOwnPropertyDescriptor(h,g);if(w)if(typeof w.value=="function"&&(h[g]=h[g].bind(this)),w.set&&Object.defineProperty(h,g,{set:w.set.bind(this)}),w.get&&Object.defineProperty(h,g,{get:w.get.bind(this)}),bc.has(g)){let E=g==="add"?()=>{var T;r=z=>y.push(z),(T=h[g])==null||T.call(h),r=null}:h[g];y.push(this.on(g,E).cancel)}else if(this[g]===void 0)Object.defineProperty(this,g,{get:()=>h[g],set:E=>h[g]=E,configurable:!0,enumerable:!0}),y.push(()=>delete this[g]);else{let E=(A=t.values().find(T=>T[g]!==void 0))==null?void 0:A.id;throw new Error(`Duplicate component property: "${g}" while adding component "${h.id}"`+(E?` (originally added by "${E}")`:""))}}let f=()=>{if(h.require){for(let g of h.require)if(!this.c(g))throw new Error(`Component "${h.id}" requires component "${g}"`)}};h.destroy&&y.push(h.destroy.bind(this)),this.exists()?(f(),h.add&&(r=g=>y.push(g),h.add.call(this),r=null),h.id&&(this.trigger("use",h.id),x.game.events.trigger("use",this,h.id))):h.require&&y.push(this.on("add",f).cancel)},unuse(h){if(t.has(h)){for(let y of t.values())if(y.require&&y.require.includes(h))throw new Error(`Can't unuse. Component "${y.id}" requires component "${h}"`);t.delete(h),this.trigger("unuse",h),x.game.events.trigger("unuse",this,h)}else c&&l.has(h)&&l.delete(h);s[h]&&(s[h].forEach(y=>y()),delete s[h])},c(h){return t.get(h)??null},get(h,y={}){let f=(g,w)=>y.only==="comps"?g.has(w):y.only==="tags"?g.is(w):g.is(w)||g.has(w),A=y.recursive?this.children.flatMap(function g(w){return[w,...w.children.flatMap(g)]}):this.children;if(A=A.filter(g=>h?f(g,h):!0),y.liveUpdate){let g=E=>y.recursive?this.isAncestorOf(E):E.parent===this,w=[];w.push(x.k.onAdd(E=>{g(E)&&f(E,h)&&A.push(E)})),w.push(x.k.onDestroy(E=>{if(g(E)&&f(E,h)){let T=A.findIndex(z=>z.id===E.id);T!==-1&&A.splice(T,1)}})),this.onDestroy(()=>{for(let E of w)E.cancel()})}return A},query(h){let y=h.hierarchy||"children",f=h.include,A=h.exclude,g=[];switch(y){case"children":g=this.children;break;case"siblings":g=this.parent?this.parent.children.filter(E=>E!==this):[];break;case"ancestors":let w=this.parent;for(;w;)g.push(w),w=w.parent;break;case"descendants":g=this.children.flatMap(function E(T){return[T,...T.children.flatMap(E)]});break}if(f&&((h.includeOp||"and")==="and"||!Array.isArray(h.include)?g=g.filter(w=>w.is(f)):g=g.filter(w=>h.include.some(E=>w.is(E)))),A&&((h.includeOp||"and")==="and"||!Array.isArray(h.include)?g=g.filter(w=>!w.is(A)):g=g.filter(w=>!h.exclude.some(E=>w.is(E)))),h.visible===!0&&(g=g.filter(w=>w.visible)),h.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let w=h.distanceOp||"near",E=h.distance*h.distance;w==="near"?g=g.filter(T=>T.pos&&this.pos.sdist(T.pos)<=E):g=g.filter(T=>T.pos&&this.pos.sdist(T.pos)>E)}return h.name&&(g=g.filter(w=>w.name===h.name)),g},isAncestorOf(h){return h.parent?h.parent===this||this.isAncestorOf(h.parent):!1},exists(){return x.game.root.isAncestorOf(this)},is(h,y="and"){return Array.isArray(h)?y==="and"?h.every(f=>l.has(f)):h.some(f=>l.has(f)):l.has(h)},tag(h){if(Array.isArray(h))for(let y of h)l.add(y),this.trigger("tag",y),x.game.events.trigger("tag",this,y);else l.add(h),this.trigger("tag",h),x.game.events.trigger("tag",this,h)},untag(h){if(Array.isArray(h))for(let y of h)l.delete(y),this.trigger("untag",y),x.game.events.trigger("untag",this,y);else l.delete(h),this.trigger("untag",h),x.game.events.trigger("untag",this,h)},has(h,y="and"){return Array.isArray(h)?y==="and"?h.every(f=>t.has(f)):h.some(f=>t.has(f)):t.has(h)},on(h,y){let f=i.on(h,y.bind(this));return r&&r(()=>f.cancel()),f},trigger(h,...y){i.trigger(h,...y),x.game.objEvents.trigger(h,this,...y)},destroy(){this.parent&&this.parent.remove(this)},inspect(){var y;let h={};for(let[f,A]of t)h[f]=((y=A.inspect)==null?void 0:y.call(A))??null;for(let[f,A]of o.entries()){if(A.inspect){h[f]=A.inspect();continue}for(let[g,w]of Object.entries(A))typeof w!="function"&&(h[g]=`${g}: ${w}`)}return h},onAdd(h){return this.on("add",h)},onFixedUpdate(h){return this.on("fixedUpdate",h)},onUpdate(h){return this.on("update",h)},onDraw(h){return this.on("draw",h)},onDestroy(h){return this.on("destroy",h)},onUse(h){return this.on("use",h)},onUnuse(h){return this.on("unuse",h)},clearEvents(){i.clear()}},u=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let h of u)d[h]=(...y)=>{var A,g;let f=(g=(A=x.app)[h])==null?void 0:g.call(A,...y);return a.push(f),d.onDestroy(()=>f.cancel()),d.on("sceneEnter",()=>{var E,T;a.splice(a.indexOf(f),1);let w=(T=(E=x.app)[h])==null?void 0:T.call(E,...y);zo.replace(f,w),a.push(f)}),f};for(let h of e)d.use(h);return d}var Od=()=>({events:new fs,objEvents:new fs,root:yn([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new X(1),angle:0,shake:0,transform:new Kt}});function Ld(e){x.game.gravity=e?(x.game.gravity||N(0,1)).unit().scale(e):null}function zd(){return x.game.gravity?x.game.gravity.len():0}function Hd(e){x.game.gravity=e.unit().scale(x.game.gravity?x.game.gravity.len():1)}function us(){return x.game.gravity?x.game.gravity.unit():N(0,1)}var Nd=wl("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Ud=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let o=new xs(lh(e));return e.decodeAudioData(Nd.buffer.slice(0)).then(s=>{o.buf=s}).catch(s=>{console.error("Failed to load burp: ",s)}),{ctx:e,masterNode:t,burpSnd:o}})();function qd(e,t={}){let o=new yt,s=new Audio(e);s.crossOrigin="anonymous",s.loop=!!t.loop,x.audio.ctx.createMediaElementSource(s).connect(x.audio.masterNode);function i(){x.debug.paused||x.app.isHidden()&&!x.globalOpt.backgroundAudio||x.audio.ctx.resume()}function a(){i(),s.play()}return t.paused||a(),s.onended=()=>o.trigger(),{play(){a()},seek(l){s.currentTime=l},stop(){s.pause(),this.seek(0)},set loop(l){s.loop=l},get loop(){return s.loop},set paused(l){l?s.pause():a()},get paused(){return s.paused},time(){return s.currentTime},duration(){return s.duration},set volume(l){s.volume=Gt(l,0,1)},get volume(){return s.volume},set speed(l){s.playbackRate=Math.max(l,0)},get speed(){return s.playbackRate},set detune(l){},get detune(){return 0},onEnd(l){return o.add(l)},then(l){return this.onEnd(l)}}}function Fd(e,t={}){if(typeof e=="string"&&x.assets.music[e])return qd(x.assets.music[e],t);let o=x.audio.ctx,s=t.paused??!1,i=o.createBufferSource(),a=new yt,l=o.createGain(),c=o.createStereoPanner(),r=t.seek??0,n=0,d=0,u=!1;i.loop=!!t.loop,i.detune.value=t.detune??0,i.playbackRate.value=t.speed??1,i.connect(c),i.onended=()=>{var g;f()>=(((g=i.buffer)==null?void 0:g.duration)??Number.POSITIVE_INFINITY)&&a.trigger()},c.pan.value=t.pan??0,c.connect(l),l.connect(x.audio.masterNode),l.gain.value=t.volume??1;let h=g=>{i.buffer=g.buf,s||(n=o.currentTime,i.start(0,r),u=!0)},y=Hh(e);y instanceof zt&&y.onLoad(h);let f=()=>{if(!i.buffer)return 0;let g=s?d-n:o.currentTime-n,w=i.buffer.duration;return i.loop?g%w:Math.min(g,w)},A=g=>{let w=o.createBufferSource();return w.buffer=g.buffer,w.loop=g.loop,w.playbackRate.value=g.playbackRate.value,w.detune.value=g.detune.value,w.onended=g.onended,w.connect(c),w};return{stop(){this.paused=!0,this.seek(0)},set paused(g){if(s!==g)if(s=g,g)u&&(i.stop(),u=!1),d=o.currentTime;else{i=A(i);let w=d-n;i.start(0,w),u=!0,n=o.currentTime-w,d=0}},get paused(){return s},play(g=0){this.seek(g),this.paused=!1},seek(g){var w;(w=i.buffer)!=null&&w.duration&&(g>i.buffer.duration||(s?(i=A(i),n=d-g):(i.stop(),i=A(i),n=o.currentTime-g,i.start(0,g),u=!0,d=0)))},set speed(g){i.playbackRate.value=g},get speed(){return i.playbackRate.value},set detune(g){i.detune.value=g},get detune(){return i.detune.value},set volume(g){l.gain.value=Math.max(g,0)},get volume(){return l.gain.value},set pan(g){c.pan.value=g},get pan(){return c.pan.value},set loop(g){i.loop=g},get loop(){return i.loop},duration(){var g;return((g=i.buffer)==null?void 0:g.duration)??0},time(){return f()%this.duration()},onEnd(g){return a.add(g)},then(g){return this.onEnd(g)}}}function Dr(e){return x.k.play(x.audio.burpSnd,e)}function Tr(e){x.audio.masterNode.gain.value=e}function Cr(){return x.audio.masterNode.gain.value}function _d(e){return jo("volume","setVolume / getVolume"),e!==void 0&&Tr(e),Cr()}function Ir(){x.app.onHide(()=>{x.globalOpt.backgroundAudio||x.audio.ctx.suspend()}),x.app.onShow(()=>{!x.globalOpt.backgroundAudio&&!x.debug.paused&&x.audio.ctx.resume()}),x.app.onResize(()=>{if(x.app.isFullscreen())return;let e=x.globalOpt.width&&x.globalOpt.height;e&&!x.globalOpt.stretch&&!x.globalOpt.letterbox||(x.canvas.width=x.canvas.offsetWidth*x.pixelDensity,x.canvas.height=x.canvas.offsetHeight*x.pixelDensity,$a(),e||(x.gfx.frameBuffer.free(),x.gfx.frameBuffer=new $s(x.gfx.ggl,x.gfx.ggl.gl.drawingBufferWidth,x.gfx.ggl.gl.drawingBufferHeight),x.gfx.width=x.gfx.ggl.gl.drawingBufferWidth/x.pixelDensity/x.gscale,x.gfx.height=x.gfx.ggl.gl.drawingBufferHeight/x.pixelDensity/x.gscale))}),x.globalOpt.debug!==!1&&(x.app.onKeyPress(x.globalOpt.debugKey??"f1",()=>x.debug.inspect=!x.debug.inspect),x.app.onKeyPress("f2",()=>x.debug.clearLog()),x.app.onKeyPress("f8",()=>x.debug.paused=!x.debug.paused),x.app.onKeyPress("f7",()=>{x.debug.timeScale=Hi(Gt(x.debug.timeScale-.2,0,2),1)}),x.app.onKeyPress("f9",()=>{x.debug.timeScale=Hi(Gt(x.debug.timeScale+.2,0,2),1)}),x.app.onKeyPress("f10",()=>x.debug.stepFrame())),x.globalOpt.burp&&x.app.onKeyPress("b",()=>Dr())}function Xd(e,t={}){let o=x.game.root.add([Qs(e),zr()]),s=(t.speed||1)*5,i=t.scale||1;o.add([Yi(x.boomSprite),Zs(0),Vi("center"),jn(s,i),...t.comps??[]]);let a=o.add([Yi(x.kaSprite),Zs(0),Vi("center"),Gi(),...t.comps??[]]);return a.wait(.4/s,()=>a.use(jn(s,i))),a.onDestroy(()=>o.destroy()),o}function Pr(e,t){if(x.game.layers)throw Error("Layers can only be assigned once.");let o=e.indexOf(t);if(o==-1)throw Error("The default layer name should be present in the layers list.");x.game.layers=e,x.game.defaultLayerIndex=o}function Yd(){return x.game.layers}function Gd(){var e;return((e=x.game.layers)==null?void 0:e[x.game.defaultLayerIndex])??null}function Kd(e,t){jo("layers","setLayers"),Pr(e,t)}function Br(e){e.destroy()}function Vd(){return x.game.root}function jd(e,t){x.game.scenes[e]=t}function Wd(e,...t){if(!x.game.scenes[e])throw new Error(`Scene not found: ${e}`);x.game.events.onOnce("frameEnd",()=>{x.game.events.trigger("sceneLeave",e),x.app.events.clear(),x.game.events.clear(),x.game.objEvents.clear(),[...x.game.root.children].forEach(o=>{!o.stay||o.scenesToStay&&!o.scenesToStay.includes(e)?x.game.root.remove(o):o.trigger("sceneEnter",e)}),x.game.root.clearEvents(),Ir(),x.game.cam={pos:null,scale:N(1),angle:0,shake:0,transform:new Kt},x.game.scenes[e](...t)}),x.game.currentScene=e}function $d(e){return x.game.events.on("sceneLeave",e)}function Jd(){return x.game.currentScene}function Yi(e,t={}){let o=null,s=null,i=null,a=new yt;if(!e)throw new Error("Please pass the resource name or data to sprite()");let l=(n,d,u,h)=>{let y=N(1,1);return u&&h?(y.x=u/(n.width*d.w),y.y=h/(n.height*d.h)):u?(y.x=u/(n.width*d.w),y.y=y.x):h&&(y.y=h/(n.height*d.h),y.x=y.y),y},c=(n,d)=>{if(!d)return;let u=d.frames[0].clone();t.quad&&(u=u.scale(t.quad));let h=l(d.tex,u,t.width,t.height);if(n.width=d.tex.width*u.w*h.x,n.height=d.tex.height*u.h*h.y,d.anims)for(let y in d.anims){let f=d.anims[y];typeof f!="number"&&(f.frames=r(f))}o=d,a.trigger(o),t.anim&&n.play(t.anim)},r=n=>{if(n.frames)return n.frames;let d=[];if(n.from===void 0||n.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let u=Math.abs(n.to-n.from)+1;for(let h=0;h<u;h++)d.push(n.from+h*Math.sign(n.to-n.from));if(n.pingpong)for(let h=u-2;h>0;h--)d.push(d[h]);return d};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new Ye(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(n){let d=Fs(n);d&&d.onLoad(u=>c(this,u))},get animFrame(){if(!o||!s||i===null)return this.frame;let n=o.anims[s.name];return typeof n=="number"?n:n.from===void 0||n.to===void 0?s.frameIndex:this.frame-Math.min(n.from,n.to)},draw(){if(!o)return;let n=o.frames[this.frame??0];if(!n)throw new Error(`Frame not found: ${this.frame??0}`);if(o.slice9){let{left:d,right:u,top:h,bottom:y}=o.slice9,f=o.tex.width*n.w,A=o.tex.height*n.h,g=this.width-d-u,w=this.height-h-y,E=d/f,T=u/f,z=1-E-T,q=h/A,p=y/A,m=1-q-p,b=[Ze(0,0,E,q),Ze(E,0,z,q),Ze(E+z,0,T,q),Ze(0,q,E,m),Ze(E,q,z,m),Ze(E+z,q,T,m),Ze(0,q+m,E,p),Ze(E,q+m,z,p),Ze(E+z,q+m,T,p),Ze(0,0,d,h),Ze(d,0,g,h),Ze(d+g,0,u,h),Ze(0,h,d,w),Ze(d,h,g,w),Ze(d+g,h,u,w),Ze(0,h+w,d,y),Ze(d,h+w,g,y),Ze(d+g,h+w,u,y)];for(let S=0;S<9;S++){let R=b[S],P=b[S+9];Js(Object.assign(Lo(this),{pos:P.pos(),tex:o.tex,quad:n.scale(R),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:P.w,height:P.h}))}}else Js(Object.assign(Lo(this),{tex:o.tex,quad:n.scale(this.quad??new Ye(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let n=Fs(e);n?n.onLoad(d=>c(this,d)):xn(()=>c(this,Fs(e).data))},update(){if(!o||!s||i===null)return;let n=o.anims[s.name];if(typeof n=="number"){this.frame=n;return}if(n.speed===0)throw new Error("Sprite anim speed cannot be 0");if(s.timer+=ct()*this.animSpeed,s.timer>=1/s.speed){s.timer=0,s.frameIndex+=i;let d=n.frames;if(s.frameIndex>=d.length)if(s.pingpong&&!n.pingpong)i=-1,s.frameIndex=d.length-2;else if(s.loop)s.frameIndex=0;else{this.frame=d.at(-1),s.onEnd(),this.stop();return}else if(s.frameIndex<0)if(s.pingpong&&s.loop)i=1,s.frameIndex=1;else if(s.loop)s.frameIndex=d.length-1;else{this.frame=d[0],s.onEnd(),this.stop();return}this.frame=d[s.frameIndex]}},play(n,d={}){if(!o){a.add(()=>this.play(n,d));return}let u=o.anims[n];if(u===void 0)throw new Error(`Anim not found: ${n}`);s&&this.stop(),s=typeof u=="number"?{name:n,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:n,timer:0,loop:d.loop??u.loop??!1,pingpong:d.pingpong??u.pingpong??!1,speed:d.speed??u.speed??10,frameIndex:0,onEnd:d.onEnd??(()=>{})},i=typeof u=="number"?null:1,this.frame=typeof u=="number"?u:u.frames[0],this.trigger("animStart",n)},stop(){if(!s)return;let n=s.name;s=null,this.trigger("animEnd",n)},numFrames(){return(o==null?void 0:o.frames.length)??0},getCurAnim(){return s},curAnim(){return s==null?void 0:s.name},getAnim(n){return(o==null?void 0:o.anims[n])??null},hasAnim(n){return!!this.getAnim(n)},onAnimEnd(n){return this.on("animEnd",n)},onAnimStart(n){return this.on("animStart",n)},renderArea(){return new Ue(N(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function Qd(e,t={}){function o(i){var l,c;let a=Bo(Object.assign(Lo(i),{text:i.text+"",size:i.textSize,font:i.font,width:t.width&&i.width,align:i.align,letterSpacing:i.letterSpacing,lineSpacing:i.lineSpacing,transform:i.textTransform,styles:i.textStyles,indentAll:t.indentAll}));return t.width||(i.width=a.width/(((l=i.scale)==null?void 0:l.x)||1)),i.height=a.height/(((c=i.scale)==null?void 0:c.y)||1),a}let s={id:"text",set text(i){e=i,o(this),this.renderedText=Fi(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?Fi(e).text:"",add(){xn(()=>o(this))},draw(){Oo(o(this))},renderArea(){return new Ue(N(0),this.width,this.height)}};return o(s),s}function Zd(e,t){return{id:"rect",width:e,height:t,draw(){ys(Object.assign(Lo(this),{width:this.width,height:this.height}))},renderArea(){return new Ue(N(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function kd(e={}){let t=null,o=null,s=null,i=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return o&&s?o[s]:null},getPath(){return o?o.slice():null},getTarget(){return t},isNavigationFinished(){return o?s===null:!0},isTargetReachable(){return o!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s=o?0:null,o&&s!==null?(i||(i=this.getLevel().onNavigationMapChanged(()=>{t&&o&&s!==null&&(o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o?(s=0,this.trigger("navigationNext",this,o[s])):(s=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>i==null?void 0:i.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,o[s])):this.trigger("navigationEnded",this)},update(){if(t&&o&&s!==null){if(this.pos.sdist(o[s])<2)if(s===o.length-1){this.pos=t.clone(),s=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else s++,this.trigger("navigationNext",this,o[s]);this.moveTo(o[s],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(o)})}}}function eu(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(o){var s;return(s=this.graph)==null?void 0:s.getWaypointPath(this.pos,o,e.navigationOpt)},get graph(){if(t)return t;let o=this.parent;for(;o;){if(o.has("pathfinderMap"))return o.graph;o=o.parent}},set graph(o){t=o}}}function tu(e={}){let t=e.waypoints,o=e.speed||100,s=e.endBehavior||"stop",i=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return o},set patrolSpeed(l){o=l},get waypoints(){return t},set waypoints(l){t=l,i=0,a=!1},get nextLocation(){return t?t[i]:void 0},update(){let l=this.nextLocation;if(!(!t||!l||a)&&(this.moveTo(l,o),this.pos.sdist(l)<9))switch(s){case"loop":i=(i+1)%t.length;break;case"ping-pong":i=i+1,i==t.length&&(t.reverse(),i=0);break;case"stop":i<t.length-1?i+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(l){return this.on("patrolFinished",l)}}}function ou(e,t={}){let o=typeof e=="function"?e:()=>x.game.root.query(e),s=t.checkFrequency||1,i=typeof t.direction=="number"?X.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?X.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(l){this.direction=l!==void 0?X.fromAngle(l):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(l,c,r){let n=(typeof c=="number"?X.fromAngle(c):c)||i,d=r||t.fieldOfView;if(!n||!d||d>=360)return!0;let u=d/2;return l.pos&&n.angleBetween(l.pos.sub(this.pos))<=u},hasLineOfSight(l){let c=fr(this.pos,l.pos.sub(this.pos),t.raycastExclude);return c!=null&&c.object===l},update(){if(a+=ct(),a>s){a-=s;let l=o();if(l.length&&i&&this.fieldOfView&&this.fieldOfView<360){let c=this.fieldOfView/2;l=l.filter(r=>r.pos&&i.angleBetween(r.pos.sub(this.pos))<=c)}l.length&&t.lineOfSight&&(l=l.filter(c=>c.pos&&this.hasLineOfSight(c))),l.length>0&&(this.spotted=l,this.trigger("objectSpotted",l))}},onObjectsSpotted(l){return this.on("objectSpotted",l)}}}function Or(e={}){let t=N(0),o=e.isObstacle??!1,s=e.cost??0,i=e.edges??[],a=()=>{let c={left:1,top:2,right:4,bottom:8};return i.map(r=>c[r]||0).reduce((r,n)=>r|n,0)},l=a();return{id:"tile",tilePosOffset:e.offset??N(0),set tilePos(c){let r=this.getLevel();t=c.clone(),this.pos=N(this.tilePos.x*r.tileWidth(),this.tilePos.y*r.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(c){o!==c&&(o=c,this.getLevel().invalidateNavigationMap())},get isObstacle(){return o},set cost(c){s!==c&&(s=c,this.getLevel().invalidateNavigationMap())},get cost(){return s},set edges(c){i=c,l=a(),this.getLevel().invalidateNavigationMap()},get edges(){return i},get edgeMask(){return l},getLevel(){return this.parent},tileMove(c){let r=this.getLevel();r.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(c),r.insertIntoSpatialMap(this),r.trigger("spatialMapChanged")},moveLeft(){this.tileMove(N(-1,0))},moveRight(){this.tileMove(N(1,0))},moveUp(){this.tileMove(N(0,-1))},moveDown(){this.tileMove(N(0,1))}}}var wn=class{constructor(e,t,o){L(this,"name");L(this,"duration");L(this,"loops");L(this,"direction");L(this,"easing");L(this,"interpolation");L(this,"isFinished");L(this,"timing");L(this,"easings");L(this,"relative");this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||gs.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=o}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,o){let s=t-1,i=e/this.duration;if(this.loops!==0&&i>=this.loops)return[s,0,!0];let a=Math.trunc(i);if(i-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(i=1-i),o){let l=0;for(;o[l+1]!==void 0&&o[l+1]<i;)l++;return l>=s?[s,0,!0]:[l,(i-o[l])/(o[l+1]-o[l]),!1]}else{let l=Math.floor((t-1)*i);return[l,(i-l/s)*s,!1]}}setValue(e,t,o){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(o);break;case"angle":e.angle=e.base.angle+o;break;case"scale":e.scale=e.base.scale.scale(o);break;case"opacity":e.opacity=e.base.opacity*o;break;default:e[t]=o}else e[t]=o}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=gs.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Vn(e,t){return t.add(t.sub(e))}var su=class extends wn{constructor(t,o,s,i){super(t,s,i);L(this,"keys");this.keys=o}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(t,this.name,this.keys[s]);else{let l=this.easings?this.easings[s]:this.easing;this.setValue(t,this.name,vt(this.keys[s],this.keys[s+1],l(i)))}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},iu=class extends wn{constructor(t,o,s,i,a){var l;super(t,s,i);L(this,"keys");L(this,"curves");L(this,"dcurves");if(this.keys=o,this.interpolation==="spline"){this.curves=[],a&&(this.dcurves=[]);for(let c=0;c<this.keys.length-1;c++){let r=this.keys[c],n=c+1,d=this.keys[n],u=c>0?this.keys[c-1]:Vn(d,r),h=n<this.keys.length-1?this.keys[n+1]:Vn(r,d);this.curves.push(Vs(u,r,d,h)),a&&((l=this.dcurves)==null||l.push(Vs(u,r,d,h,tc)))}}}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(t,this.name,this.keys[s]);else{let l=this.easings?this.easings[s]:this.easing;switch(this.interpolation){case"linear":this.setValue(t,this.name,this.keys[s].lerp(this.keys[s+1],l(i)));break;case"slerp":this.setValue(t,this.name,this.keys[s].slerp(this.keys[s+1],l(i)));break;case"spline":if(this.curves){this.setValue(t,this.name,this.curves[s](l(i))),this.dcurves&&this.setValue(t,"angle",this.dcurves[s](l(i)).angle());break}}}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(t=>[t.x,t.y])})}},nu=class extends wn{constructor(t,o,s,i){super(t,s,i);L(this,"keys");this.keys=o}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation=="none")this.setValue(t,this.name,this.keys[s]);else{let l=this.easings?this.easings[s]:this.easing;this.setValue(t,this.name,this.keys[s].lerp(this.keys[s+1],l(i)))}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function au(e={}){let t=[],o=0,s=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:N(0,0),angle:0,scale:N(1,1),opacity:1},animation:{paused:!1,seek(i){o=Gt(i,0,this.duration),t.forEach(a=>{a.isFinished=!1}),s=!1},get duration(){return t.reduce((i,a)=>Math.max(a.duration,i),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let i=!0,a;o+=ct();for(let l of t)a=l.update(this,o),a&&!l.isFinished&&(l.isFinished=!0,this.trigger("animateChannelFinished",l.name)),i&&(i=a);i&&!s&&(s=!0,this.trigger("animateFinished"))},animate(i,a,l){s=!1,this.unanimate(i),typeof a[0]=="number"?t.push(new su(i,a,l,e.relative||!1)):a[0]instanceof X?t.push(new iu(i,a,l,e.relative||!1,i==="pos"&&(e.followMotion||!1))):a[0]instanceof Me&&t.push(new nu(i,a,l,e.relative||!1))},unanimate(i){let a=t.findIndex(l=>l.name===i);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(i){return this.on("animateFinished",i)},onAnimateChannelFinished(i){return this.on("animateChannelFinished",i)},serializeAnimationChannels(){return t.reduce((i,a)=>(i[a.name]=a.serialize(),i),{})},serializeAnimationOptions(){let i={};return e.followMotion&&(i.followMotion=!0),e.relative&&(i.relative=!0),i}}}function Lr(e,t){let o={name:e.name};return e.has("animate")&&(o.channels=e.serializeAnimationChannels(),Object.assign(o,e.serializeAnimationOptions())),e.children.length>0&&(o.children=e.children.filter(s=>s.has("named")).map(s=>Lr(s,s.name))),o}function jn(e=2,t=1){let o=0;return{require:["scale"],update(){let s=Math.sin(o*e)*t;s<0&&this.destroy(),this.scale=N(s),o+=ct()}}}function ru(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(o=1){this.setHP(e-o),this.trigger("hurt",o)},heal(o=1){let s=e;this.setHP(e+o),this.trigger("heal",e-s)},hp(){return e},maxHP(){return t??null},setMaxHP(o){t=o},setHP(o){e=t?Math.min(t,o):o,e<=0&&this.trigger("death")},onHurt(o){return this.on("hurt",o)},onHeal(o){return this.on("heal",o)},onDeath(o){return this.on("death",o)},inspect(){return`health: ${e}`}}}function lu(e,t={}){if(e==null)throw new Error("lifespan() requires time");let o=t.fade??0;return{id:"lifespan",require:["opacity"],add(){x.game.root.wait(e,()=>{this.opacity=this.opacity??1,o>0?x.game.root.tween(this.opacity,0,o,s=>this.opacity=s,gs.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function cu(e){return{id:"named",name:e}}function hu(e,t,o){if(!e)throw new Error("state() requires an initial state");let s={};function i(r){s[r]||(s[r]={enter:new yt,end:new yt,update:new yt,draw:new yt})}function a(r,n,d){return i(n),s[n][r].add(d)}function l(r,n,...d){i(n),s[n][r].trigger(...d)}let c=!1;return{id:"state",state:e,enterState(r,...n){if(c=!0,t&&!t.includes(r))throw new Error(`State not found: ${r}`);let d=this.state;if(o){if(!(o!=null&&o[d]))return;let u=typeof o[d]=="string"?[o[d]]:o[d];if(!u.includes(r))throw new Error(`Cannot transition state from "${d}" to "${r}". Available transitions: ${u.map(h=>`"${h}"`).join(", ")}`)}l("end",d,...n),this.state=r,l("enter",r,...n),l("enter",`${d} -> ${r}`,...n)},onStateTransition(r,n,d){return a("enter",`${r} -> ${n}`,d)},onStateEnter(r,n){return a("enter",r,n)},onStateUpdate(r,n){return a("update",r,n)},onStateDraw(r,n){return a("draw",r,n)},onStateEnd(r,n){return a("end",r,n)},update(){c||(l("enter",e),c=!0),l("update",this.state)},draw(){l("draw",this.state)},inspect(){return`state: ${this.state}`}}}function zr(e){return{id:"stay",stay:!0,scenesToStay:e}}function du(e=!0,t){let o,s;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let i=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};o=x.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(x.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,i())}),s=x.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),i())})},destroy(){o.cancel(),s.cancel()}}}function Gi(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,o,s=1/0,i=!1){let a=i?0:t,l=new yt,c=this.onUpdate(()=>{a+=x.app.state.dt;for(let r=0;a>=t&&r<this.maxLoopsPerFrame;r++)if(s--,o(),a-=t,s<=0){c.cancel(),l.trigger();return}});return{get paused(){return c.paused},set paused(r){c.paused=r},cancel:c.cancel,onEnd(r){l.add(r)},then(r){return l.add(r),this}}},wait(t,o){return this.loop(t,o??(()=>{}),1,!0)},tween(t,o,s,i,a=gs.linear){let l=0,c=[],r=this.onUpdate(()=>{l+=x.app.state.dt;let n=Math.min(l/s,1);i(vt(t,o,a(n))),n===1&&(r.cancel(),i(o),c.forEach(d=>d()))});return{get paused(){return r.paused},set paused(n){r.paused=n},onEnd(n){c.push(n)},then(n){return this.onEnd(n),this},cancel(){r.cancel()},finish(){r.cancel(),i(o),c.forEach(n=>n())}}}}}var Ki=0;function uu(){return Ki>0}function pu(e={}){let t={},o=new Set,s=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){Ki++,this.area.cursor&&s.push(this.onHover(()=>x.app.setCursor(this.area.cursor))),s.push(this.onCollideUpdate((i,a)=>{if(!i.id)throw new Error("area() requires the object to have an id");t[i.id]||this.trigger("collide",i,a),a&&(t[i.id]=a,o.add(i.id))}))},destroy(){Ki--;for(let i of s)i.cancel()},fixedUpdate(){for(let i in t)o.has(Number(i))||(this.trigger("collideEnd",t[i].target),delete t[i]);o.clear()},drawInspect(){let i=this.localArea();Pt(),Ge(this.area.offset);let a={outline:{width:4/Ja(),color:Pe(0,0,255)},anchor:this.anchor,fill:!1,fixed:To(this)};i instanceof Ue?Ot({...a,pos:i.pos,width:i.width*this.area.scale.x,height:i.height*this.area.scale.y}):i instanceof wt?fo({...a,pts:i.pts,scale:this.area.scale}):i instanceof Et&&$o({...a,pos:i.center,radius:i.radius}),At()},area:{shape:e.shape??null,scale:e.scale?N(e.scale):N(1),offset:e.offset??N(0),cursor:e.cursor??null},isClicked(){return x.app.isMousePressed()&&this.isHovering()},isHovering(){let i=To(this)?x.k.mousePos():x.k.toWorld(x.k.mousePos());return this.hasPoint(i)},checkCollision(i){if(!i.id)throw new Error("checkCollision() requires the object to have an id");return t[i.id]??null},getCollisions(){return Object.values(t)},isColliding(i){if(!i.id)throw new Error("isColliding() requires the object to have an id");return!!t[i.id]},isOverlapping(i){if(!i.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[i.id];return a&&a.hasOverlap()},onClick(i,a="left"){let l=this.onMousePress(a,()=>{this.isHovering()&&i()});return s.push(l),l},onHover(i){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,i())})},onHoverUpdate(i){return this.onUpdate(()=>{this.isHovering()&&i()})},onHoverEnd(i){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,i()):a=this.isHovering()})},onCollide(i,a){if(typeof i=="function"&&a===void 0)return this.on("collide",i);if(typeof i=="string")return this.onCollide((l,c)=>{l.is(i)&&(a==null||a(l,c))});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(i,a){if(typeof i=="function"&&a===void 0)return this.on("collideUpdate",i);if(typeof i=="string")return this.on("collideUpdate",(l,c)=>l.is(i)&&(a==null?void 0:a(l,c)));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(i,a){if(typeof i=="function"&&a===void 0)return this.on("collideEnd",i);if(typeof i=="string")return this.on("collideEnd",l=>l.is(i)&&(a==null?void 0:a(l)));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(i){return wo(this.worldArea(),i)},resolveCollision(i){let a=this.checkCollision(i);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let i=this.localArea();if(!(i instanceof wt||i instanceof Ue))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale(N(this.area.scale??1));if(i instanceof Ue){let l=Wo(this.anchor||li).add(1,1).scale(-.5).scale(i.width,i.height);a.translate(l)}return i.transform(a)},screenArea(){let i=this.worldArea();return To(this)?i:i.transform(x.game.cam.transform)},inspect(){var i,a,l,c,r,n,d;return((i=this.area.scale)==null?void 0:i.x)==((a=this.area.scale)==null?void 0:a.y)?`area: ${(c=(l=this.area.scale)==null?void 0:l.x)==null?void 0:c.toFixed(1)}x`:`area: (${(n=(r=this.area.scale)==null?void 0:r.x)==null?void 0:n.toFixed(1)}x, ${(d=this.area.scale.y)==null?void 0:d.toFixed(1)}y)`}}}function fu(e={}){let t=null,o=null,s=!1,i=N(0),a=null,l=null,c;return{id:"body",require:["pos"],vel:N(0),drag:e.drag??0,jumpForce:e.jumpForce??Ac,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),l=this.pos.clone(),c=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((r,n)=>{if(!n||!r.has("body")||n.resolved)return;this.trigger("beforePhysicsResolve",n);let d=n.reverse();if(r.trigger("beforePhysicsResolve",d),!(n.resolved||d.resolved)&&!(this.isStatic&&r.isStatic)){if(!this.isStatic&&!r.isStatic){let u=this.mass+r.mass;this.pos=this.pos.add(n.displacement.scale(r.mass/u)),r.pos=r.pos.add(n.displacement.scale(-this.mass/u)),this.transform=hs(this),r.transform=hs(r)}else{let u=!this.isStatic&&r.isStatic?n:n.reverse();u.source.pos=u.source.pos.add(u.displacement),u.source.transform=hs(u.source)}n.resolved=!0,this.trigger("physicsResolve",n),r.trigger("physicsResolve",n.reverse())}}),this.onPhysicsResolve(r=>{if(x.game.gravity)if(r.isBottom()&&this.isFalling()){this.vel=this.vel.reject(x.game.gravity.unit());let n=t;t=r.target,n!=t&&(o=r.target.pos),s?s=!1:n||(this.trigger("ground",t),r.target.trigger("land",this))}else r.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(x.game.gravity.unit()),this.trigger("headbutt",r.target),r.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(o&&!t.pos.eq(o)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(o)),o=t.pos);let r=Ui();r&&(this.pos.x==c.x&&(this.pos.x=vt(a.x,l.x,r/Ni()),c.x=this.pos.x),this.pos.y==c.y&&(this.pos.y=vt(a.y,l.y,r/Ni()),c.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==c.x&&(this.pos.x=a.x),this.pos.y==c.y&&(this.pos.y=a.y),a=null),x.game.gravity&&!this.isStatic){s&&(t=null,o=null,this.trigger("fallOff"),s=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(s=!0);let r=this.vel.clone();this.vel=this.vel.add(x.game.gravity.scale(this.gravityScale*ct()));let n=e.maxVelocity??vc;this.vel.slen()>n*n&&(this.vel=this.vel.unit().scale(n)),r.dot(x.game.gravity)<0&&this.vel.dot(x.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=i.x*ct(),this.vel.y+=i.y*ct(),this.vel.x*=1-this.drag*ct(),this.vel.y*=1-this.drag*ct(),this.move(this.vel),Ui()){a=this.pos.clone();let r=this.vel.add(i.scale(ct()));l=this.pos.add(r.scale(ct())),c=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(r){return this.on("physicsResolve",r)},onBeforePhysicsResolve(r){return this.on("beforePhysicsResolve",r)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(us())>0},isJumping(){return this.vel.dot(us())<0},applyImpulse(r){this.isStatic||(this.vel=this.vel.add(r))},addForce(r){this.isStatic||(i.x+=r.x/this.mass,i.y+=r.y/this.mass)},jump(r){this.isStatic||(t=null,o=null,this.vel=us().scale(-r||-this.jumpForce))},onGround(r){return this.on("ground",r)},onFall(r){return this.on("fall",r)},onFallOff(r){return this.on("fallOff",r)},onHeadbutt(r){return this.on("headbutt",r)},onLand(r){return this.on("land",r)},onHeadbutted(r){return this.on("headbutted",r)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function gu(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(o){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(o))},onDoubleJump(o){return this.on("doubleJump",o)},inspect(){return`jumpsLeft: ${t}`}}}function mu(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,o)=>{var l;let s=o==null?void 0:o.normal.normal(),i=t.vel.project(s),a=(l=s==null?void 0:s.scale(this.speed))==null?void 0:l.sub(i);t.addForce(a==null?void 0:a.scale(t.mass*this.forceScale))})}}}function xu(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{if(!t.has("body"))return;let s=X.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(s),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function yu(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{let s=this.pos.sub(t.pos),i=s.len(),a=i*this.distanceScale/10,l=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,c=s.scale(this.forceMagnitude*l/i);t.addForce(c),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function wu(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function bu(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let o=t.target.vel,s=us().scale(-1).angleBetween(o);Math.abs(s)>this.surfaceArc/2&&t.preventResolution()})}}}function Au(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,o)=>{let s=t,i=s.worldArea(),[a,l]=i.cut(N(-100,this.surfaceLevel),N(100,this.surfaceLevel));a&&(this.applyBuoyancy(s,a),this.applyDrag(s,a)),this.flowMagnitude&&s.addForce(X.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,o){let s=this.density*o.area(),i=N(0,1).scale(-s);t.addForce(i)},applyDrag(t,o){let s=t.vel,i=this.density*this.linearDrag,a=s.scale(-i);t.addForce(a)}}}function Vi(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function Hr(){return{id:"fixed",fixed:!0}}function vu(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??N(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Eu(e){var o;let t=(o=x.game.layers)==null?void 0:o.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){var s;return t?((s=x.game.layers)==null?void 0:s[t])??null:null},set layer(s){var i;if(t=(i=x.game.layers)==null?void 0:i.indexOf(s),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function Mu(e,t){let o=typeof e=="number"?X.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(o.scale(t))}}}function Su(e={}){let t=!1,o=new Ue(N(0),ht(),mt()),s=new Ue(N(0),0,0),i=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??Ln,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(o.width=ht(),o.height=mt(),!this.offscreenDistance&&this.width&&this.height)return s.width=this.width,s.height=this.height,s.pos=this.pos,s.collides(o);let l=this.offscreenDistance?this.offscreenDistance:Ln;return!ni(o,a)&&o.sdistToPoint(a)>l*l},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?mr(()=>i(this)):this.onUpdate(()=>i(this))}}}function Qs(...e){return{id:"pos",pos:N(...e),moveBy(...t){this.pos=this.pos.add(N(...t))},move(...t){this.moveBy(N(...t).scale(ct()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(N(t[0],t[1]),t[2]);let o=t[0],s=t[1];if(s===void 0){this.pos=N(o);return}let i=o.sub(this.pos);if(i.len()<=s*ct()){this.pos=N(o);return}this.move(i.unit().scale(s))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let o=this.worldPos();return o?To(this)?o:Xi(o):null}},toScreen(t){let o=this.toWorld(t);return To(this)?o:Xi(o)},fromScreen(t){return To(this)?this.fromWorld(t):this.fromWorld(Rr(t))},toOther(t,o){return t.fromWorld(this.toWorld(o))},fromOther(t,o){return t.toOther(this,o)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){$o({color:Pe(255,0,0),radius:4/Ja()})}}}function Ru(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function Zs(...e){if(e.length===0)return Zs(1);let t=N(...e);return{id:"scale",set scale(o){if(!(o instanceof X))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=N(o)},get scale(){return t},scaleTo(...o){t=N(...o)},scaleBy(...o){t=t.scale(N(...o))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function Du(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Tu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",Cu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",Iu=bl.version,x={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},Pu=(e={tagsAsComponents:!0})=>{x.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),x.k.quit()),x.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let o=e.canvas??t.appendChild(document.createElement("canvas"));x.canvas=o;let s=e.scale??1;x.gscale=s;let i=e.width&&e.height&&!e.stretch&&!e.letterbox;i?(o.width=e.width*s,o.height=e.height*s):(o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(i){let F=o.width,j=o.height;a.push(`width: ${F}px`),a.push(`height: ${j}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),o.style.cssText=a.join(";");let l=e.pixelDensity||1;x.pixelDensity=l,o.width*=l,o.height*=l,o.tabIndex=0;let c=document.createElement("canvas");c.width=256,c.height=256,x.fontCacheCanvas=c;let r=c.getContext("2d",{willReadFrequently:!0});x.fontCacheC2d=r;let n=Qc({canvas:o,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});x.app=n;let d=[],u=n.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!u)throw new Error("WebGL not supported");let h=u,y=Gh(h,{texFilter:e.texFilter}),f=Qh(e,y);x.gfx=f;let A=Ud();x.audio=A;let g=Mh(y,e.spriteAtlasPadding??0);x.assets=g;let w=Od();x.game=w,w.root.use(Gi());function E(F,j){let ie=new $s(y,F,j);return{clear:()=>ie.clear(),free:()=>ie.free(),toDataURL:()=>ie.toDataURL(),toImageData:()=>ie.toImageData(),width:ie.width,height:ie.height,draw:be=>{Bt(),ie.bind(),be(),Bt(),ie.unbind()},get fb(){return ie}}}function T(){h.clear(h.COLOR_BUFFER_BIT),f.frameBuffer.bind(),h.clear(h.COLOR_BUFFER_BIT),f.bgColor||uo(()=>{ys({width:ht(),height:mt(),quad:new Ye(0,0,ht()/64,mt()/64),tex:f.bgTex,fixed:!0})}),f.renderer.numDraws=0,f.fixed=!1,f.transformStack.length=0,f.transform=new Kt}function z(F,j){f.postShader=F,f.postShaderUniform=j??null}function q(){Bt(),f.lastDrawCalls=f.renderer.numDraws,f.frameBuffer.unbind(),h.viewport(0,0,h.drawingBufferWidth,h.drawingBufferHeight);let F=f.width,j=f.height;f.width=h.drawingBufferWidth/l,f.height=h.drawingBufferHeight/l,Js({flipY:!0,tex:f.frameBuffer.tex,pos:new X(f.viewport.x,f.viewport.y),width:f.viewport.width,height:f.viewport.height,shader:f.postShader,uniform:typeof f.postShaderUniform=="function"?f.postShaderUniform():f.postShaderUniform,fixed:!0}),Bt(),f.width=F,f.height=j}let p=!1,m={inspect:!1,set timeScale(F){x.app.state.timeScale=F},get timeScale(){return x.app.state.timeScale},showLog:!0,fps:()=>n.fps(),numFrames:()=>n.numFrames(),stepFrame:oe,drawCalls:()=>f.lastDrawCalls,clearLog:()=>w.logs=[],log:(...F)=>{let j=e.logMax??8,ie=F.length>1?F.concat(" ").join(" "):F[0];w.logs.unshift({msg:ie,time:n.time()}),w.logs.length>j&&(w.logs=w.logs.slice(0,j))},error:F=>m.log(new Error(F.toString?F.toString():F)),curRecording:null,numObjects:()=>Y("*",{recursive:!0}).length,get paused(){return p},set paused(F){p=F,F?A.ctx.suspend():A.ctx.resume()}};x.debug=m;function b(F,j){try{return JSON.parse(window.localStorage[F])}catch{return j?(S(F,j),j):null}}function S(F,j){window.localStorage[F]=JSON.stringify(j)}function R(F,...j){let ie=F(k),be;typeof ie=="function"?be=ie(...j)(k):be=ie;for(let Re in be)k[Re]=be[Re],e.global!==!1&&(window[Re]=be[Re]);return k}function P(F){let j=n.canvas.captureStream(F),ie=A.ctx.createMediaStreamDestination();A.masterNode.connect(ie);let be=new MediaRecorder(j),Re=[];return be.ondataavailable=he=>{he.data.size>0&&Re.push(he.data)},be.onerror=()=>{A.masterNode.disconnect(ie),j.getTracks().forEach(he=>he.stop())},be.start(),{resume(){be.resume()},pause(){be.pause()},stop(){return be.stop(),A.masterNode.disconnect(ie),j.getTracks().forEach(he=>he.stop()),new Promise(he=>{be.onstop=()=>{he(new Blob(Re,{type:"video/mp4"}))}})},download(he="kaboom.mp4"){this.stop().then(Ie=>zn(he,Ie))}}}function D(){return document.activeElement===n.canvas}let I=w.root.add.bind(w.root),C=w.root.readd.bind(w.root),U=w.root.removeAll.bind(w.root),Y=w.root.get.bind(w.root),G=w.root.wait.bind(w.root),K=w.root.loop.bind(w.root),$=w.root.query.bind(w.root),V=w.root.tween.bind(w.root),ue=ds(null,Cu),Q=ds(null,Tu);x.kaSprite=ue,x.boomSprite=Q;function we(){w.root.fixedUpdate()}function oe(){w.root.update()}class me{constructor(j,ie,be,Re,he=!1){L(this,"source");L(this,"target");L(this,"normal");L(this,"distance");L(this,"resolved",!1);this.source=j,this.target=ie,this.normal=be,this.distance=Re,this.resolved=he}get displacement(){return this.normal.scale(this.distance)}reverse(){return new me(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(w.gravity||N(0,1))>0}isRight(){return this.displacement.cross(w.gravity||N(0,1))<0}isTop(){return this.displacement.dot(w.gravity||N(0,1))>0}isBottom(){return this.displacement.dot(w.gravity||N(0,1))<0}preventResolution(){this.resolved=!0}}function Se(){if(!uu())return;let F={},j=e.hashGridSize||64,ie=new Kt,be=[];function Re(he){if(be.push(ie.clone()),he.pos&&ie.translate(he.pos),he.scale&&ie.scale(he.scale),he.angle&&ie.rotate(he.angle),he.transform=ie.clone(),he.c("area")&&!he.paused){let Ie=he,Rt=Ie.worldArea().bbox(),io=Math.floor(Rt.pos.x/j),jt=Math.floor(Rt.pos.y/j),Wt=Math.ceil((Rt.pos.x+Rt.width)/j),Jo=Math.ceil((Rt.pos.y+Rt.height)/j),no=new Set;for(let nt=io;nt<=Wt;nt++)for(let Ft=jt;Ft<=Jo;Ft++)if(!F[nt])F[nt]={},F[nt][Ft]=[Ie];else if(!F[nt][Ft])F[nt][Ft]=[Ie];else{let ao=F[nt][Ft];e:for(let dt of ao){if(dt.paused||!dt.exists()||no.has(dt.id))continue;for(let qe of Ie.collisionIgnore)if(dt.is(qe))continue e;for(let qe of dt.collisionIgnore)if(Ie.is(qe))continue e;let We=rc(Ie.worldArea(),dt.worldArea());if(We){let qe=new me(Ie,dt,We.normal,We.distance);Ie.trigger("collideUpdate",dt,qe);let Uo=qe.reverse();Uo.resolved=qe.resolved,dt.trigger("collideUpdate",Ie,Uo)}no.add(dt.id)}ao.push(Ie)}}he.children.forEach(Re),ie=be.pop()}Re(w.root)}function Te(F){console.error(F),A.ctx.suspend();let j=F.message??String(F)??"Unknown error, check console for more info";n.run(()=>{},()=>{T(),uo(()=>{let ie=ht(),be=mt(),Re={size:36,width:ie-32*2,letterSpacing:4,lineSpacing:4,font:js,fixed:!0};Ot({width:ie,height:be,color:Pe(0,0,255),fixed:!0});let he=Bo({...Re,text:"Error",pos:N(32),color:Pe(255,128,0),fixed:!0});Oo(he),Kn({...Re,text:j,pos:N(32,32+he.height+16),fixed:!0}),At(),w.events.trigger("error",F)}),q()})}function Ve(F){d.push(F)}function it(){w.events.onOnce("frameEnd",()=>{n.quit(),h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT|h.STENCIL_BUFFER_BIT);let F=h.getParameter(h.MAX_TEXTURE_IMAGE_UNITS);for(let j=0;j<F;j++)h.activeTexture(h.TEXTURE0+j),h.bindTexture(h.TEXTURE_2D,null),h.bindTexture(h.TEXTURE_CUBE_MAP,null);h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),y.destroy(),d.forEach(j=>j())})}let je=!0;n.run(()=>{try{g.loaded&&(m.paused||we(),Se())}catch(F){Te(F)}},(F,j)=>{try{F(),g.loaded||Po()===1&&!je&&(g.loaded=!0,Za().forEach(ie=>w.events.trigger("loadError",...ie)),w.events.trigger("load")),!g.loaded&&e.loadingScreen!==!1||je?(T(),jh(),q()):(m.paused||oe(),Se(),T(),Vh(),e.debug!==!1&&Kh(),q()),je&&(je=!1),w.events.trigger("frameEnd"),j()}catch(ie){Te(ie)}}),$a(),Ir();let k={_k:x,VERSION:Iu,loadRoot:Ah,loadProgress:Po,loadSprite:ds,loadSpriteAtlas:ar,loadSound:Nh,loadMusic:Uh,loadBitmapFont:Ih,loadFont:Th,loadShader:Lh,loadShaderURL:zh,loadAseprite:Dh,loadPedit:Ph,loadBean:Rh,loadJSON:vh,load:qi,getSound:nr,getFont:or,getBitmapFont:sr,getSprite:ka,getShader:ir,getAsset:Eh,Asset:zt,SpriteData:bo,SoundData:xs,width:ht,height:mt,center:Ws,dt:ct,fixedDt:Ni,restDt:Ui,time:n.time,screenshot:n.screenshot,record:P,isFocused:D,setCursor:n.setCursor,getCursor:n.getCursor,setCursorLocked:n.setCursorLocked,isCursorLocked:n.isCursorLocked,setFullscreen:n.setFullscreen,isFullscreen:n.isFullscreen,isTouchscreen:n.isTouchscreen,onLoad:xn,onLoadError:Sd,onLoading:vd,onResize:Ed,onGamepadConnect:n.onGamepadConnect,onGamepadDisconnect:n.onGamepadDisconnect,onError:Md,onCleanup:Ve,flash:Sr,setCamPos:wr,getCamPos:br,setCamRot:Er,getCamRot:Mr,setCamScale:Ar,getCamScale:vr,getCamTransform:Rd,camPos:Cd,camScale:Id,camFlash:Bd,camRot:Pd,camTransform:Dd,shake:Td,toScreen:Xi,toWorld:Rr,setGravity:Ld,getGravity:zd,setGravityDirection:Hd,getGravityDirection:us,setBackground:gh,getBackground:mh,getGamepads:n.getGamepads,getTreeRoot:Vd,add:I,make:yn,destroy:Br,destroyAll:U,get:Y,query:$,readd:C,pos:Qs,scale:Zs,rotate:Ru,color:ur,opacity:pr,anchor:Vi,area:pu,sprite:Yi,text:Qd,polygon:nd,rect:gr,circle:Zh,uvquad:Zd,outline:od,particles:id,body:fu,platformEffector:bu,surfaceEffector:mu,areaEffector:xu,pointEffector:yu,buoyancyEffector:Au,constantForce:wu,doubleJump:gu,shader:ad,textInput:du,timer:Gi,fixed:Hr,stay:zr,health:ru,lifespan:lu,named:cu,state:hu,z:Du,layer:Eu,move:Mu,offscreen:Su,follow:vu,fadeIn:ed,mask:td,drawon:kh,raycast:fr,tile:Or,animate:au,serializeAnimation:Lr,agent:kd,sentry:ou,patrol:tu,pathfinder:eu,trigger:ld,on:St,onFixedUpdate:cd,onUpdate:mr,onDraw:hd,onAdd:xr,onDestroy:dd,onTag:yr,onUntag:fd,onUse:ud,onUnuse:pd,onClick:yd,onCollide:gd,onCollideUpdate:md,onCollideEnd:xd,onHover:wd,onHoverUpdate:bd,onHoverEnd:Ad,onKeyDown:n.onKeyDown,onKeyPress:n.onKeyPress,onKeyPressRepeat:n.onKeyPressRepeat,onKeyRelease:n.onKeyRelease,onMouseDown:n.onMouseDown,onMousePress:n.onMousePress,onMouseRelease:n.onMouseRelease,onMouseMove:n.onMouseMove,onCharInput:n.onCharInput,onTouchStart:n.onTouchStart,onTouchMove:n.onTouchMove,onTouchEnd:n.onTouchEnd,onScroll:n.onScroll,onHide:n.onHide,onShow:n.onShow,onGamepadButtonDown:n.onGamepadButtonDown,onGamepadButtonPress:n.onGamepadButtonPress,onGamepadButtonRelease:n.onGamepadButtonRelease,onGamepadStick:n.onGamepadStick,onButtonPress:n.onButtonPress,onButtonDown:n.onButtonDown,onButtonRelease:n.onButtonRelease,mousePos:n.mousePos,mouseDeltaPos:n.mouseDeltaPos,isKeyDown:n.isKeyDown,isKeyPressed:n.isKeyPressed,isKeyPressedRepeat:n.isKeyPressedRepeat,isKeyReleased:n.isKeyReleased,isMouseDown:n.isMouseDown,isMousePressed:n.isMousePressed,isMouseReleased:n.isMouseReleased,isMouseMoved:n.isMouseMoved,isGamepadButtonPressed:n.isGamepadButtonPressed,isGamepadButtonDown:n.isGamepadButtonDown,isGamepadButtonReleased:n.isGamepadButtonReleased,getGamepadStick:n.getGamepadStick,isButtonPressed:n.isButtonPressed,isButtonDown:n.isButtonDown,isButtonReleased:n.isButtonReleased,setButton:n.setButton,getButton:n.getButton,pressButton:n.pressButton,releaseButton:n.releaseButton,getLastInputDeviceType:n.getLastInputDeviceType,charInputted:n.charInputted,loop:K,wait:G,play:Fd,setVolume:Tr,getVolume:Cr,volume:_d,burp:Dr,audioCtx:A.ctx,Line:Mt,Rect:Ue,Circle:Et,Ellipse:so,Point:Yl,Polygon:wt,Vec2:X,Color:Me,Mat4:Kt,Quad:Ye,RNG:Sa,rand:lt,randi:Ra,randSeed:Sl,vec2:N,rgb:Pe,hsl2rgb:Al,quad:Ze,choose:Tl,chooseMultiple:Dl,shuffle:Da,chance:Rl,lerp:vt,tween:V,easings:gs,map:Xt,mapc:vl,wave:Ma,deg2rad:ke,rad2deg:Io,clamp:Gt,evaluateQuadratic:Kl,evaluateQuadraticFirstDerivative:Vl,evaluateQuadraticSecondDerivative:jl,evaluateBezier:cn,evaluateBezierFirstDerivative:Wl,evaluateBezierSecondDerivative:$l,evaluateCatmullRom:Jl,evaluateCatmullRomFirstDerivative:Ql,curveLengthApproximation:Na,normalizedCurve:Zl,hermite:As,cardinal:Ua,catmullRom:Vs,bezier:kl,kochanekBartels:ec,easingSteps:ac,easingLinear:ic,easingCubicBezier:nc,testLineLine:on,testRectRect:Ta,testRectLine:sn,testRectPoint:ni,testCirclePolygon:ri,testLinePoint:nn,testLineCircle:bs,isConvex:uc,triangulate:Fa,NavMesh:ph,drawSprite:$h,drawText:Kn,formatText:Bo,drawRect:Ot,drawLine:ls,drawLines:mn,drawTriangle:hr,drawCircle:$o,drawEllipse:rr,drawUVQuad:ys,drawPolygon:fo,drawCurve:lr,drawBezier:Xh,drawFormattedText:Oo,drawMasked:Wh,drawSubtracted:Jh,pushTransform:Pt,popTransform:At,pushTranslate:Ge,pushScale:ms,pushRotate:Go,pushMatrix:xh,usePostEffect:z,makeCanvas:E,debug:m,scene:jd,getSceneName:Jd,go:Wd,onSceneLeave:$d,layers:Kd,getLayers:Yd,setLayers:Pr,getDefaultLayer:Gd,addLevel:rd,getData:b,setData:S,download:dn,downloadJSON:Tc,downloadText:ja,downloadBlob:zn,plug:R,ASCII_CHARS:_a,canvas:n.canvas,addKaboom:Xd,LEFT:X.LEFT,RIGHT:X.RIGHT,UP:X.UP,DOWN:X.DOWN,RED:Me.RED,GREEN:Me.GREEN,BLUE:Me.BLUE,YELLOW:Me.YELLOW,MAGENTA:Me.MAGENTA,CYAN:Me.CYAN,WHITE:Me.WHITE,BLACK:Me.BLACK,quit:it,KEvent:yt,KEventHandler:fs,KEventController:zo,cancel:()=>Ya};x.k=k;let se=e.plugins;if(se&&se.forEach(R),e.global!==!1)for(let F in k)window[F]=k[F];return e.focus!==!1&&n.canvas.focus(),k},Bu=Pu;const Ou="modulepreload",Lu=function(e){return"/SuperSmashTexty/"+e},Wn={},zu=function(t,o,s){let i=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(o.map(r=>{if(r=Lu(r),r in Wn)return;Wn[r]=!0;const n=r.endsWith(".css"),d=n?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${d}`))return;const u=document.createElement("link");if(u.rel=n?"stylesheet":Ou,n||(u.as="script"),u.crossOrigin="",u.href=r,c&&u.setAttribute("nonce",c),document.head.appendChild(u),n)return new Promise((h,y)=>{u.addEventListener("load",h),u.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${r}`)))})}))}function a(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return i.then(l=>{for(const c of l||[])c.status==="rejected"&&a(c.reason);return t().catch(a)})},$n=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Legendary","Royal","Noble","Rogue","Savage"],Jn=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter"];function ji(){const e=$n[Math.floor(Math.random()*$n.length)],t=Jn[Math.floor(Math.random()*Jn.length)];return`${e}${t}`}function Qn(){return Math.floor(1e5+Math.random()*9e5).toString()}function Hu(e){return/^\d{6}$/.test(e)}const Nr="superSmashTexty_save",Nu="$",Wi={version:1,currency:0,playerName:null,inviteCode:null,unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[]},permanentUpgradeLevels:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0},achievements:[]};function et(){try{const t=localStorage.getItem(Nr);if(t){const o=JSON.parse(t),s={...Wi,...o};return s.playerName||(s.playerName=ji(),qt(s)),s.inviteCode||(s.inviteCode=Qn(),qt(s)),s}}catch(t){console.error("Error loading save:",t)}const e={...Wi};return e.playerName=ji(),e.inviteCode=Qn(),qt(e),e}function qt(e){try{return localStorage.setItem(Nr,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function Uu(){return et()}function $i(e){const t=et();return t.currency+=e,qt(t),t.currency}function mo(){return et().currency}function po(e,t){const o=et();return o.unlocks[e]&&o.unlocks[e].includes(t)}function qu(e,t){const o=et();return o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)?!1:(o.unlocks[e].push(t),qt(o),!0)}async function Zn(e){const{CHARACTER_UNLOCKS:t}=await zu(async()=>{const{CHARACTER_UNLOCKS:s}=await Promise.resolve().then(()=>Vu);return{CHARACTER_UNLOCKS:s}},void 0);et();let o=!1;for(const[s,i]of Object.entries(t))i.unlockRequirement&&i.unlockRequirement.type==="floor"&&e>=i.unlockRequirement.value&&(po("characters",s)||(qu("characters",s),o=!0));return o}function bn(){return et().selectedCharacter||"survivor"}function Fu(e){const t=et();t.selectedCharacter=e,qt(t)}function kt(e){const t=et();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function _u(e,t,o){const s=et();return s.currency>=o?(s.currency-=o,s.unlocks[e]||(s.unlocks[e]=[]),s.unlocks[e].includes(t)||s.unlocks[e].push(t),qt(s),!0):!1}function Xu(e,t,o){const s=et(),i=kt(e);return o&&i>=o?{success:!1,reason:"maxLevel"}:s.currency<t?{success:!1,reason:"insufficientCurrency"}:(s.currency-=t,s.permanentUpgradeLevels||(s.permanentUpgradeLevels={}),s.permanentUpgradeLevels[e]=(i||0)+1,s.unlocks.permanentUpgrades||(s.unlocks.permanentUpgrades=[]),s.unlocks.permanentUpgrades.includes(e)||s.unlocks.permanentUpgrades.push(e),qt(s),{success:!0,newLevel:s.permanentUpgradeLevels[e]})}function Yu(e){const t=et();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),qt(t)}function ot(e){const t=et();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function st(e){const t=et();return t.achievements||(t.achievements=[]),t.achievements.includes(e)?!1:(t.achievements.push(e),qt(t),!0)}function Gu(){return et().achievements||[]}function Ur(){return et().stats||Wi.stats}function Ku(e){let t=0;return t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30),Math.floor(t)}function vs(){return Nu}function An(){return et().playerName||"Player"}function kn(e){const t=et();return t.playerName=e,qt(t),t.playerName}function ws(){return et().inviteCode||"000000"}const xo={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"}},qr={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0}},Fr={startingHealth:{name:"Starting Health +10",description:"Begin runs with +10 max health",cost:50,maxLevel:5},startingDamage:{name:"Starting Damage +1",description:"Begin runs with +1 damage",cost:75,maxLevel:5},startingSpeed:{name:"Starting Speed +10",description:"Begin runs with +10 speed",cost:60,maxLevel:5}};function _r(e){switch(e){case"characters":return xo;case"weapons":return qr;case"permanentUpgrades":return Fr;default:return{}}}const Vu=Object.freeze(Object.defineProperty({__proto__:null,CHARACTER_UNLOCKS:xo,PERMANENT_UPGRADE_UNLOCKS:Fr,WEAPON_UNLOCKS:qr,getUnlocksForCategory:_r},Symbol.toStringTag,{value:"Module"})),Ji={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]}};function Xr(e){return Ji[e]||Ji.pistol}function ju(e,t){return Xr(e).upgradeCategories.includes(t)}const es={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},Jt={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},to={BASE_XP_TO_NEXT_LEVEL:10,XP_SCALING_FACTOR:1.5,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},ro={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},gt={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},Ko={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},Xe={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,255,100],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:200,MAGNETIZE_ACCELERATION:50,COLLECTION_RADIUS:20};function vi(e,t=0,o=0){const s=e*(1-o);return Math.max(gt.MIN_DAMAGE,s-t)}function Wu(e){return Math.random()<e}function $u(e,t=2){return Math.floor(e*t)}function Ei(e,t,o){const s=bn(),i=xo[s]||xo.survivor,a=e.add([e.text(i.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...i.color),e.area(),e.health(i.stats.health),"player"]);a.characterKey=s,a.characterData=i,a.speed=i.stats.speed,a.originalSpeed=i.stats.speed,a.slowed=!1,a.maxHealth=i.stats.health,a.level=to.STARTING_LEVEL,a.xp=to.STARTING_XP,a.xpToNext=to.BASE_XP_TO_NEXT_LEVEL,a.pickupRadius=Jt.BASE_PICKUP_RADIUS,a.invulnerable=!1,a.invulnerableTime=0,a.invulnerableDuration=Jt.INVULNERABILITY_DURATION,a.setHP(a.maxHealth);const l=i.weapon||"pistol",c=Xr(l);a.weaponKey=l,a.weaponDef=c,a.baseFireRate=c.fireRate,a.baseProjectileSpeed=c.projectileSpeed,a.baseProjectileDamage=c.baseDamage;const r=i.stats.damage||10,n=c.baseDamage,d=r/10;a.fireRate=c.fireRate,a.projectileSpeed=c.projectileSpeed,a.projectileDamage=Math.floor(n*d),a.lastFireTime=0,a.projectileCount=c.projectileCount,a.piercing=c.piercing,a.obstaclePiercing=c.obstaclePiercing,a.critChance=c.critChance,a.critDamage=c.critDamage,a.spreadAngle=c.spreadAngle,a.defense=0,a.weaponRange=c.range,a.weaponCategory=c.category,c.orbitRadius&&(a.orbitRadius=c.orbitRadius,a.rotationSpeed=c.rotationSpeed,a.orbitalOrbs=[],a.orbitalAngles=[]),c.explosionRadius&&(a.explosionRadius=c.explosionRadius,a.explosionDamage=c.explosionDamage),c.chainRange&&(a.chainRange=c.chainRange,a.maxJumps=c.maxJumps,a.chainDamageReduction=c.chainDamageReduction),a.xpMultiplier=1,a.dodgeChance=0,a.damageReduction=0,a.weapons=[l],a.passiveUpgrades=[],a.upgradeStacks={},i.ability==="xpBoost"?a.xpMultiplier=ro.SURVIVOR_XP_BOOST:i.ability==="speedBoost"?(a.speed=a.speed*ro.SCOUT_SPEED_BOOST,a.originalSpeed=a.speed,a.dodgeChance=ro.SCOUT_DODGE_CHANCE):i.ability==="tankStats"?(a.maxHealth=Math.floor(a.maxHealth*ro.TANK_HEALTH_BOOST),a.setHP(a.maxHealth),a.damageReduction=ro.TANK_DAMAGE_REDUCTION):i.ability==="critBoost"?(a.critChance=(a.critChance||0)*ro.SNIPER_CRIT_CHANCE_MULTIPLIER,a.critDamage=(a.critDamage||2)*ro.SNIPER_CRIT_DAMAGE_MULTIPLIER):i.ability==="fireDot"&&(a.fireDotMultiplier=ro.PYRO_FIRE_DOT_MULTIPLIER);let u=e.vec2(0,0);return e.onKeyDown(["w","up"],()=>{a.isRemote||(u.y=-1)}),e.onKeyDown(["s","down"],()=>{a.isRemote||(u.y=1)}),e.onKeyDown(["a","left"],()=>{a.isRemote||(u.x=-1)}),e.onKeyDown(["d","right"],()=>{a.isRemote||(u.x=1)}),e.onKeyRelease(["w","up"],()=>{a.isRemote||!e.isKeyDown("s")&&!e.isKeyDown("down")&&(u.y=0)}),e.onKeyRelease(["s","down"],()=>{a.isRemote||!e.isKeyDown("w")&&!e.isKeyDown("up")&&(u.y=0)}),e.onKeyRelease(["a","left"],()=>{a.isRemote||!e.isKeyDown("d")&&!e.isKeyDown("right")&&(u.x=0)}),e.onKeyRelease(["d","right"],()=>{a.isRemote||!e.isKeyDown("a")&&!e.isKeyDown("left")&&(u.x=0)}),a.onUpdate(()=>{if(e.paused)return;if(a.invulnerable)if(a.invulnerableTime-=e.dt(),a.invulnerableTime<=0)a.invulnerable=!1,a.color=e.rgb(...Jt.NORMAL_COLOR);else{const A=Jt.IMMUNITY_FLASH_RATE;Math.floor(a.invulnerableTime*A)%2===0?a.color=e.rgb(...Jt.NORMAL_COLOR):a.color=e.rgb(...Jt.NORMAL_COLOR,Jt.IMMUNITY_ALPHA)}if(u.len()>0){const A=u.len(),w=u.scale(1/A).scale(a.speed*e.dt()),E=a.pos.x+w.x,T=a.pos.y+w.y;let z=!0,q=!0;const p=e.get("obstacle"),m=Jt.COLLISION_SIZE;for(const b of p){if(!b.exists())continue;const S=b.pos.x-b.width/2,R=b.pos.x+b.width/2,P=b.pos.y-b.height/2,D=b.pos.y+b.height/2,I=E-m,C=E+m,U=a.pos.y-m,Y=a.pos.y+m;C>S&&I<R&&Y>P&&U<D&&(z=!1);const G=a.pos.x-m,K=a.pos.x+m,$=T-m,V=T+m;K>S&&G<R&&V>P&&$<D&&(q=!1)}z&&(a.pos.x=E),q&&(a.pos.y=T)}const h=e.width(),y=e.height(),f=Jt.ROOM_MARGIN;a.pos.x=e.clamp(a.pos.x,f,h-f),a.pos.y=e.clamp(a.pos.y,f,y-f)}),a}const Ee={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function Yr(e,t=!0){return new Promise((o,s)=>{if(Ee.isInitialized){console.warn("Network already initialized"),o();return}if(typeof Peer>"u"){console.error("PeerJS library not loaded"),s(new Error("PeerJS library not available"));return}Ee.isHost=t;const i=t?`smash-${e}`:void 0;try{Ee.peer=new Peer(i,{debug:0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}}),Ee.peer.on("open",a=>{console.log("Peer initialized with ID:",a),Ee.peerId=a,Ee.isInitialized=!0,o(a)}),Ee.peer.on("error",a=>{console.error("Peer error:",a),a.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):a.type==="peer-unavailable"?console.warn("Host not found - check invite code"):a.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),Ee.isInitialized||s(new Error(`Multiplayer unavailable: ${a.type||"connection failed"}`))}),t&&Ee.peer.on("connection",a=>{console.log("Incoming connection from:",a.peer),Ju(a)})}catch(a){console.error("Failed to create peer:",a),s(a)}})}function Ju(e){Ee.isHost&&(e.on("open",()=>{console.log("Connection opened with:",e.peer),Ee.connections.set(e.peer,e),Ee.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{Gr(t,e.peer)}),e.on("close",()=>{console.log("Connection closed with:",e.peer),Ee.connections.delete(e.peer),Ee.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function Qu(e){return new Promise((t,o)=>{if(Ee.isHost){o(new Error("Host cannot connect to another host"));return}if(!Ee.isInitialized){o(new Error("Network not initialized"));return}const s=`smash-${e}`;console.log("Connecting to host:",s);const i=Ee.peer.connect(s,{reliable:!0});i.on("open",()=>{console.log("Connected to host!"),Ee.hostConnection=i,Ee.hostId=s,vn("join_request",{peerId:Ee.peerId}),t()}),i.on("data",a=>{Gr(a,s)}),i.on("close",()=>{console.log("Disconnected from host"),Ee.hostConnection=null,Ee.hostId=null,Ee.connectionCallbacks.forEach(a=>a("host_disconnect"))}),i.on("error",a=>{console.error("Failed to connect to host:",a),o(a)})})}function Gr(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const o=Ee.messageHandlers.get(e.type);o?o(e.payload,t):console.warn("No handler for message type:",e.type)}function yo(e,t){Ee.messageHandlers.set(e,t)}function Kr(e){Ee.connectionCallbacks.includes(e)||Ee.connectionCallbacks.push(e)}function vn(e,t){if(Ee.isHost){console.warn("Host cannot send to itself");return}if(!Ee.hostConnection){console.warn("Not connected to host");return}Ee.hostConnection.send({type:e,payload:t})}function Qi(e,t,o){if(!Ee.isHost){console.warn("Only host can send to specific peers");return}const s=Ee.connections.get(e);s?s.send({type:t,payload:o}):console.warn("No connection to peer:",e)}function Vr(e,t,o=[]){if(!Ee.isHost){console.warn("Only host can broadcast");return}Ee.connections.forEach((s,i)=>{o.includes(i)||s.send({type:e,payload:t})})}function Zu(){return{isInitialized:Ee.isInitialized,isHost:Ee.isHost,peerId:Ee.peerId,hostId:Ee.hostId,connectedPeers:Array.from(Ee.connections.keys()),peerCount:Ee.connections.size}}const De={slots:[{playerId:"local",playerName:null,inviteCode:null,isLocal:!0,peerId:null},{playerId:null,playerName:null,inviteCode:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,isLocal:!1,peerId:null}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1};async function ku(){if(De.slots[0].playerName=An(),De.slots[0].inviteCode=ws(),!De.networkInitialized)try{const e=ws();await Yr(e,!0),De.networkInitialized=!0,console.log("Party network initialized as host"),ep()}catch(e){console.error("Failed to initialize party network:",e),console.warn("Multiplayer disabled - running in single-player mode")}}function ep(){yo("join_request",(e,t)=>{console.log("Join request from:",t,e);const o=op(e.playerName||"Player",e.inviteCode||"000000",t);o!==null?(Qi(t,"party_sync",{slots:De.slots.map(s=>({playerId:s.playerId,playerName:s.playerName,inviteCode:s.inviteCode,isLocal:!1})),yourSlotIndex:o}),setTimeout(()=>{fp(t)},100),Zi()):Qi(t,"join_rejected",{reason:"Party full"})}),yo("player_info",(e,t)=>{const o=De.peerIdToSlot.get(t);o!==void 0&&(e.playerName&&(De.slots[o].playerName=e.playerName),Zi())}),Kr((e,t)=>{e==="leave"&&np(t)})}function jr(){return De}function tp(){return De.slots.filter(e=>e.playerId!==null).length}function op(e,t,o){for(let s=1;s<De.slots.length;s++)if(De.slots[s].playerId===null)return De.slots[s].playerId=`player_${Date.now()}_${s}`,De.slots[s].playerName=e,De.slots[s].inviteCode=t,De.slots[s].peerId=o,De.peerIdToSlot.set(o,s),s;return null}async function sp(e){try{return De.networkInitialized||(await Yr("client",!1),De.networkInitialized=!0,De.isHost=!1),ip(),await Qu(e),vn("join_request",{playerName:An(),inviteCode:ws()}),!0}catch(t){return console.error("Failed to join party:",t),!1}}function ip(){yo("party_sync",e=>{console.log("Received party sync:",e),De.slots=e.slots,e.yourSlotIndex!==void 0&&(De.slots[e.yourSlotIndex].isLocal=!0),De.slots[0].isLocal=!1}),yo("party_update",e=>{console.log("Received party update:",e),De.slots=e.slots}),yo("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),Kr(e=>{e==="host_disconnect"&&(alert("Host disconnected"),ap())})}function Zi(){De.isHost&&Vr("party_update",{slots:De.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,isLocal:!1}))})}function np(e){const t=De.peerIdToSlot.get(e);t!==void 0&&(console.log("Player disconnected from slot",t),Wr(t),De.peerIdToSlot.delete(e),Zi())}function Wr(e){if(e>0&&e<De.slots.length){const t=De.slots[e].peerId;return t&&De.peerIdToSlot.delete(t),De.slots[e]={playerId:null,playerName:null,inviteCode:null,isLocal:!1,peerId:null},!0}return!1}function ap(){for(let e=1;e<De.slots.length;e++)Wr(e)}function rp(){return De.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode}))}function lp(){return De.networkInitialized}const ne={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/20,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null};function cp(e,t=0,o=null){ne.isActive=!0,ne.isHost=e,ne.localPlayerSlot=t,ne.players.clear(),ne.inputBuffer=[],ne.lastSyncTime=0,ne.k=o,ne.enemies.clear(),ne.projectiles.clear(),ne.pickups.clear(),ne.nextEntityId=1,console.log(`Multiplayer initialized - isHost: ${e}, localSlot: ${t}`),e?hp():dp()}function hp(){yo("player_input",(e,t)=>{const s=jr().slots.findIndex(i=>i.peerId===t);if(s!==-1&&ne.players.has(s)){const i=ne.players.get(s);e.move&&(i.move=e.move),e.shoot&&(i.isShooting=e.shoot),e.aimAngle!==void 0&&(i.aimAngle=e.aimAngle)}})}function dp(){yo("game_state",e=>{if(ne.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==ne.localPlayerSlot){const o=ne.players.get(t.slotIndex);o&&o.exists()&&(o.pos.x=t.x,o.pos.y=t.y,o.angle=t.angle||0,t.hp!==void 0&&o.setHP&&o.setHP(t.hp))}}),e.enemies){const t=new Set;e.enemies.forEach(o=>{t.add(o.id);const s=ne.enemies.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y,s.setHP&&o.hp!==void 0&&s.setHP(o.hp))}),ne.enemies.forEach((o,s)=>{!t.has(s)&&o.exists()&&(o.destroy(),ne.enemies.delete(s))})}if(e.projectiles){const t=new Set;e.projectiles.forEach(o=>{t.add(o.id);const s=ne.projectiles.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y,s.angle=o.angle||0)}),ne.projectiles.forEach((o,s)=>{!t.has(s)&&o.exists()&&(o.destroy(),ne.projectiles.delete(s))})}if(e.pickups){const t=new Set;e.pickups.forEach(o=>{t.add(o.id);const s=ne.pickups.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y)}),ne.pickups.forEach((o,s)=>{!t.has(s)&&o.exists()&&(o.destroy(),ne.pickups.delete(s))})}}}),yo("spawn_entity",e=>{e.type})}function ea(e,t){ne.players.set(e,t),t.mpSlotIndex=e,console.log(`Registered player for slot ${e}`)}function up(e){ne.isActive&&(ne.lastSyncTime+=e,ne.isHost?ne.lastSyncTime>=ne.syncInterval&&(pp(),ne.lastSyncTime=0):ne.lastSyncTime>=ne.syncInterval&&(gp(),ne.lastSyncTime=0))}function $r(){const e=[],t=[],o=[],s=[];return ne.players.forEach((i,a)=>{i.exists()&&e.push({slotIndex:a,x:i.pos.x,y:i.pos.y,angle:i.angle||0,hp:i.hp||i.maxHealth,level:i.level||1,xp:i.xp||0})}),ne.enemies.forEach((i,a)=>{i.exists()?t.push({id:a,x:i.pos.x,y:i.pos.y,hp:i.hp||0,type:i.enemyType||"basic"}):ne.enemies.delete(a)}),ne.projectiles.forEach((i,a)=>{i.exists()?o.push({id:a,x:i.pos.x,y:i.pos.y,angle:i.angle||0}):ne.projectiles.delete(a)}),ne.pickups.forEach((i,a)=>{i.exists()?s.push({id:a,x:i.pos.x,y:i.pos.y,type:i.pickupType||"xp"}):ne.pickups.delete(a)}),{players:e,enemies:t,projectiles:o,pickups:s}}function pp(){ne.isHost&&Vr("game_state",$r())}function fp(e){!ne.isHost||!ne.isActive||(console.log("Sending initial game state to new joiner:",e),Qi(e,"game_state",$r()))}function gp(){if(ne.isHost)return;const e=ne.players.get(ne.localPlayerSlot);!e||!e.exists()||vn("player_input",{slotIndex:ne.localPlayerSlot,move:e.move||{x:0,y:0},shoot:e.isShooting||!1,aimAngle:e.aimAngle||0})}function eo(){return ne.isActive}function mp(){return ne.players.size}function ta(){ne.isActive=!1,ne.players.clear(),ne.inputBuffer=[],ne.enemies.clear(),ne.projectiles.clear(),ne.pickups.clear(),ne.nextEntityId=1,console.log("Multiplayer session cleaned up")}function xp(e){if(!ne.isHost)return null;const t=ne.nextEntityId++;return e.mpEntityId=t,ne.enemies.set(t,e),t}function yp(e){if(!ne.isHost)return null;const t=ne.nextEntityId++;return e.mpEntityId=t,ne.projectiles.set(t,e),t}function En(e){if(!ne.isHost)return null;const t=ne.nextEntityId++;return e.mpEntityId=t,ne.pickups.set(t,e),t}function Es(){return ne.isHost}function Vt(e,t,o,s,i,a,l=0,c=0,r=!1,n=null){const d=Math.atan2(s.y,s.x)*(180/Math.PI)+90,u=e.add([e.text("*",{size:16}),e.pos(t,o),e.anchor("center"),e.color(255,r?200:255,r?0:100),e.rotate(d),e.area(),"projectile"]);return u.damage=a,u.piercing=l,u.obstaclePiercing=c,u.piercedEnemies=new Set,u.piercedObstacles=new Set,u.isCrit=r,u.maxRange=n||Ko.DEFAULT_WEAPON_RANGE,u.distanceTraveled=0,u.direction=s,u.speed=i,u.useWeaponVisual=function(h){h&&h.char&&(u.text=h.char),h&&h.color&&(u.isCrit||(u.color=e.rgb(...h.color))),h&&h.range&&(u.maxRange=h.range)},u.onUpdate(()=>{if(e.paused)return;const h=u.direction.scale(u.speed*e.dt()),y=h.len();if(u.distanceTraveled+=y,u.pos.x+=h.x,u.pos.y+=h.y,u.distanceTraveled>=u.maxRange){e.destroy(u);return}(u.pos.x<0||u.pos.x>e.width()||u.pos.y<0||u.pos.y>e.height())&&e.destroy(u)}),eo()&&Es()&&yp(u),u}const oa={rusher:{char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.8,projectileSpeed:200,projectileDamage:7},zombie:{char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},mage:{char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},healer:{char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},basic:{char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function wp(e){return oa[e]||oa.basic}const Yt=32,bp=100;class Ap{constructor(){this.elements=[]}enqueue(t,o){this.elements.push({element:t,priority:o}),this.elements.sort((s,i)=>s.priority-i.priority)}dequeue(){var t;return(t=this.elements.shift())==null?void 0:t.element}isEmpty(){return this.elements.length===0}}function sa(e,t){return{gx:Math.floor(e/Yt),gy:Math.floor(t/Yt)}}function Jr(e,t){return{x:e*Yt+Yt/2,y:t*Yt+Yt/2}}function Mi(e,t,o,s,i){if(t<0||o<0||t>=s||o>=i)return!1;const a=Jr(t,o),l=e.get("obstacle");for(const c of l){if(!c.exists())continue;const r=Yt/2,n=a.x-r,d=a.x+r,u=a.y-r,h=a.y+r,y=c.pos.x-c.width/2,f=c.pos.x+c.width/2,A=c.pos.y-c.height/2,g=c.pos.y+c.height/2;if(d>y&&n<f&&h>A&&u<g)return!1}return!0}function vp(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function Ep(e,t,o,s,i){const a=e.width(),l=e.height(),c=Math.ceil(a/Yt),r=Math.ceil(l/Yt),n=sa(t,o),d=sa(s,i);if(!Mi(e,n.gx,n.gy,c,r)||!Mi(e,d.gx,d.gy,c,r))return[];const u=new Ap;u.enqueue(n,0);const h=new Map,y=new Map,f=T=>`${T.gx},${T.gy}`;h.set(f(n),null),y.set(f(n),0);let A=0;const g=c*r;for(;!u.isEmpty()&&A<g;){A++;const T=u.dequeue();if(T.gx===d.gx&&T.gy===d.gy)break;const z=[{gx:T.gx+1,gy:T.gy},{gx:T.gx-1,gy:T.gy},{gx:T.gx,gy:T.gy+1},{gx:T.gx,gy:T.gy-1},{gx:T.gx+1,gy:T.gy+1},{gx:T.gx+1,gy:T.gy-1},{gx:T.gx-1,gy:T.gy+1},{gx:T.gx-1,gy:T.gy-1}];for(const q of z){if(!Mi(e,q.gx,q.gy,c,r))continue;const m=q.gx!==T.gx&&q.gy!==T.gy?1.4:1,b=y.get(f(T))+m,S=f(q);if(!y.has(S)||b<y.get(S)){y.set(S,b);const R=b+vp(q,d);u.enqueue(q,R),h.set(S,T)}}}const w=[];let E=d;for(;E&&h.has(f(E));){const T=Jr(E.gx,E.gy);if(w.unshift(T),E=h.get(f(E)),w.length>bp)break}return w}function Mp(e,t,o,s){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=Ep(e,t.pos.x,t.pos.y,o,s),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const l=t.pathfindingPath[t.pathfindingWaypointIndex];if(l){const c=e.vec2(l.x-t.pos.x,l.y-t.pos.y),r=c.len();if(r<Yt/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),r>0)return c.unit()}}const i=e.vec2(o-t.pos.x,s-t.pos.y);return i.len()>0?i.unit():e.vec2(0,0)}function Sp(e,t){const o=e.width(),s=e.height(),i=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:i});const a=t.perimeterMode;t.speed*e.dt();const l=20,c=e.vec2(a.targetX-t.pos.x,a.targetY-t.pos.y),r=c.len();if(r<l)switch(a.side){case"top":a.side="right",a.targetX=o-i,a.targetY=i;break;case"right":a.side="bottom",a.targetX=o-i,a.targetY=s-i;break;case"bottom":a.side="left",a.targetX=i,a.targetY=s-i;break;case"left":a.side="top",a.targetX=i,a.targetY=i;break}return r>0?c.unit():e.vec2(0,0)}function Co(e,t,o,s="basic",i=1){const a=wp(s),l=1+(i-1)*.3,c={char:a.char,color:a.color,health:Math.floor(a.baseHealth*l),speed:Math.floor(a.baseSpeed*(1+(i-1)*.1)),size:a.size,xpValue:Math.floor(a.baseXPValue*l),behavior:a.behavior};function r(){return c.char}const n=e.add([e.text(r(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"enemy"]);n.originalColor=c.color,n.maxHealth=c.health,n.speed=c.speed,n.xpValue=c.xpValue,n.type=s,n.behavior=c.behavior,n.floor=i,n.pathfindingMode=a.pathfindingMode||"none",a.damage&&(n.damage=a.damage),a.fireRate&&(n.fireRate=a.fireRate),a.projectileSpeed&&(n.projectileSpeed=a.projectileSpeed),a.projectileDamage&&(n.projectileDamage=a.projectileDamage),a.chargeCooldown&&(n.chargeCooldown=a.chargeCooldown),a.splits&&(n.splits=!0),a.explodes&&(n.explodes=!0,n.explosionDamage=a.explosionDamage,n.explosionRadius=a.explosionRadius,a.shrapnel&&(n.shrapnel=!0,n.shrapnelCount=a.shrapnelCount||8));let d=0,u=0,h=0;i>=2&&i>=2&&(s==="zombie"||s==="turret"||s==="heavyTank"||Math.random()<.3)&&(d=Math.floor(15+(i-2)*5)),i>=3&&(s==="shooter"||s==="turret"||s==="wraith"||Math.random()<.2)&&(u=Math.floor(10+(i-3)*5),h=1+(i-3)*.5),i>=4&&(s==="heavyTank"||s==="spawner"||Math.random()<.1)&&(d===0&&(d=Math.floor(20+(i-4)*5)),u===0&&(u=Math.floor(15+(i-4)*5),h=1.5+(i-4)*.5));const y=(a.baseArmorHealth||0)+d;n.armorHealth=Math.floor(y*l),n.maxArmorHealth=Math.floor(y*l),n.damageReduction=a.damageReduction||(y>0?.2:0),n.armorChar=a.armorChar||"[]",n.armorColor=a.armorColor||[200,200,200];const f=(a.baseShieldHealth||0)+u;n.shieldHealth=Math.floor(f*l),n.maxShieldHealth=Math.floor(f*l),n.shieldRegenRate=((a.shieldRegenRate||0)+h)*l,n.shieldChar=a.shieldChar||"{}",n.shieldColor=a.shieldColor||[100,200,255],n.shieldRegenTimer=0,n.shieldRegenCooldown=0,n.lastDamageTime=0,n.originalColor=c.color,n.coreChar=c.char,n.updateVisual=function(){let p="",m="",b="",S="";if(n.shieldHealth>0){const P=n.shieldHealth/n.maxShieldHealth;P>.66?(p="",m=""):P>.33?(p="",m=""):(p="",m="")}if(n.armorHealth>0){const P=n.armorHealth/n.maxArmorHealth;P>.66?(b="",S=""):P>.33?(b="",S=""):(b="",S="")}const R=`${p}${b}${n.coreChar}${S}${m}`;n.text=R,n.shieldHealth>0?n.color=e.rgb(...n.shieldColor):n.color=e.rgb(...n.originalColor)},n.takeDamage=function(p){let m=!1,b=!1;const S=n.shieldHealth,R=n.armorHealth;n.lastDamageTime=e.time();const P=3;if(n.shieldRegenCooldown=P,n.shieldHealth>0){const D=Math.min(p,n.shieldHealth);n.shieldHealth=Math.max(0,n.shieldHealth-D),m=n.shieldHealth!==S;const I=p-D;I>0&&n.takeDamageInternal(I)}else n.takeDamageInternal(p);b=n.armorHealth!==R,(m||b)&&n.updateVisual()},n.takeDamageInternal=function(p){if(n.armorHealth>0){const m=Math.floor(p*(1-n.damageReduction)),b=Math.min(m,n.armorHealth);n.armorHealth=Math.max(0,n.armorHealth-b);const S=p-m;if(S>0){const R=n.armorHealth>0?1-n.damageReduction:1,P=Math.floor(S*R);n.hurt(P)}}else n.hurt(p)},a.blocksProjectiles&&(n.blocksProjectiles=!0),a.teleportCooldown&&(n.teleportCooldown=a.teleportCooldown),a.teleportRange&&(n.teleportRange=a.teleportRange),a.spawnInterval&&(n.spawnInterval=a.spawnInterval),a.spawnType&&(n.spawnType=a.spawnType),a.buffRadius&&(n.buffRadius=a.buffRadius),a.buffAmount&&(n.buffAmount=a.buffAmount),a.healRadius&&(n.healRadius=a.healRadius),a.healAmount&&(n.healAmount=a.healAmount),a.healInterval&&(n.healInterval=a.healInterval),a.slowRadius&&(n.slowRadius=a.slowRadius),a.slowAmount&&(n.slowAmount=a.slowAmount),a.lifesteal&&(n.lifesteal=a.lifesteal),n.updateVisual(),n.attackTimer=0,n.chargeTimer=0,n.isCharging=!1,n.chargeDirection=null,n.chargeDuration=0,n.chargePauseTimer=0,n.teleportTimer=0,n.spawnTimer=0,n.healTimer=0,n.buffedEnemies=new Set,n.stuckTimer=0,n.stuckThreshold=1,n.lastPosition={x:t,y:o},n.lastPositionUpdateTime=0,n.avoidanceDirection=null,n.avoidanceTimer=0;const A=30,g=3,w=-20,E=e.add([e.rect(A,g),e.pos(t,o+w),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),T=e.add([e.rect(A,g),e.pos(t,o+w),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);n.healthBarBg=E,n.healthBar=T,n.showHealthThreshold=.5,E.hidden=!0,T.hidden=!0,n.onUpdate(()=>{if(n.exists()&&n.healthBar&&n.healthBarBg){const p=n.hp()/n.maxHealth;if(p<n.showHealthThreshold&&p>0){n.healthBarBg.hidden=!1,n.healthBar.hidden=!1,n.healthBarBg.pos.x=n.pos.x,n.healthBarBg.pos.y=n.pos.y+w,n.healthBar.pos.x=n.pos.x,n.healthBar.pos.y=n.pos.y+w;const b=A*p;n.healthBar.width=Math.max(1,b),n.healthBar.pos.x=n.pos.x-(A-b)/2}else n.healthBarBg.hidden=!0,n.healthBar.hidden=!0}}),n.cleanupHealthBars=function(){n.healthBarBg&&n.healthBarBg.exists()&&e.destroy(n.healthBarBg),n.healthBar&&n.healthBar.exists()&&e.destroy(n.healthBar)};const z=(p,m)=>{const b=e.get("obstacle"),S=n.size||12;for(const R of b){if(!R.exists())continue;const P=R.pos.x-R.width/2,D=R.pos.x+R.width/2,I=R.pos.y-R.height/2,C=R.pos.y+R.height/2,U=p-S,Y=p+S,G=m-S,K=m+S;if(Y>P&&U<D&&K>I&&G<C)return!1}return!0},q=p=>{const m=p.len(),b=m>0?p.unit():e.vec2(0,0);n.lastPositionUpdateTime+=e.dt(),n.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(n.pos.x-n.lastPosition.x,2)+Math.pow(n.pos.y-n.lastPosition.y,2))<5?n.stuckTimer+=n.lastPositionUpdateTime:n.stuckTimer=0,n.lastPosition={x:n.pos.x,y:n.pos.y},n.lastPositionUpdateTime=0);const S=n.pos.x+p.x,R=n.pos.y+p.y;if(z(S,R))return n.avoidanceDirection=null,n.avoidanceTimer=0,p;if(n.avoidanceTimer-=e.dt(),n.stuckTimer>=n.stuckThreshold||n.avoidanceTimer<=0){const P=e.vec2(-b.y,b.x),D=e.vec2(b.y,-b.x),I=[P.scale(m),D.scale(m),e.vec2(P.x*.7+b.x*.3,P.y*.7+b.y*.3).unit().scale(m),e.vec2(D.x*.7+b.x*.3,D.y*.7+b.y*.3).unit().scale(m),e.vec2(P.x*.5+b.x*.5,P.y*.5+b.y*.5).unit().scale(m),e.vec2(D.x*.5+b.x*.5,D.y*.5+b.y*.5).unit().scale(m)];for(const C of I){const U=n.pos.x+C.x,Y=n.pos.y+C.y;if(z(U,Y))return n.avoidanceDirection=e.vec2(C.x,C.y).unit(),n.avoidanceTimer=.8,C}if(n.avoidanceDirection){const C=n.avoidanceDirection.scale(m),U=n.pos.x+C.x,Y=n.pos.y+C.y;if(z(U,Y))return C}return z(S,n.pos.y)?e.vec2(p.x,0):z(n.pos.x,R)?e.vec2(0,p.y):e.vec2(0,0)}else if(n.avoidanceDirection){const P=n.avoidanceDirection.scale(m),D=n.pos.x+P.x,I=n.pos.y+P.y;if(z(D,I))return P;n.avoidanceDirection=null,n.avoidanceTimer=0}return z(S,n.pos.y)?e.vec2(p.x,0):z(n.pos.x,R)?e.vec2(0,p.y):e.vec2(0,0)};return n.onUpdate(()=>{if(e.paused)return;if(n.shieldRegenRate>0&&n.shieldHealth<n.maxShieldHealth&&n.hp()>0&&!n.isDead&&(n.shieldRegenCooldown>0&&(n.shieldRegenCooldown-=e.dt()),n.shieldRegenCooldown<=0)){n.shieldRegenTimer+=e.dt();const I=1;if(n.shieldRegenTimer>=I){const C=n.shieldRegenRate*I;n.shieldHealth=Math.min(n.maxShieldHealth,n.shieldHealth+C),n.shieldRegenTimer=0,n.shieldHealth>0&&n.updateVisual()}}n.burnDuration>0&&n.hp()>0&&!n.isDead&&(n.burnTimer=(n.burnTimer||0)+e.dt(),n.burnTimer>=.5&&(n.takeDamage?n.takeDamage(n.burnDamage):n.hurt(n.burnDamage),n.color=e.rgb(255,150,50),e.wait(.1,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor))}),n.burnTimer=0),n.burnDuration-=e.dt(),n.burnDuration<=0&&(n.burnDamage=0,n.burnTimer=0));const p=e.get("player")[0];if(!p||!p.exists())return;const m=e.vec2(p.pos.x-n.pos.x,p.pos.y-n.pos.y),b=m.len();if(n.behavior==="turret"){if(n.attackTimer+=e.dt(),b>0&&n.attackTimer>=1/n.fireRate){const I=m.unit(),C=Vt(e,n.pos.x,n.pos.y,I,n.projectileSpeed,n.projectileDamage,0,0,!1);C.isEnemyProjectile=!0,C.color=e.rgb(...n.originalColor),n.attackTimer=0}return}if(n.behavior==="shoot"){n.attackTimer+=e.dt();const I=150;let C=e.vec2(0,0);if(b>I*1.2?C=m.unit().scale(n.speed*e.dt()):b<I*.8&&(C=m.unit().scale(-n.speed*e.dt())),b>0&&n.attackTimer>=1/n.fireRate){const U=m.unit(),Y=Vt(e,n.pos.x,n.pos.y,U,n.projectileSpeed,n.projectileDamage,0,0,!1);Y.isEnemyProjectile=!0,Y.color=e.rgb(...n.originalColor),n.attackTimer=0}if(C.len()>0){const U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="charge"){if(n.chargeTimer+=e.dt(),n.isCharging)if(n.chargeDuration+=e.dt(),n.chargeDuration>=.8)n.isCharging=!1,n.chargeDuration=0,n.chargePauseTimer=0;else{const C=n.chargeDirection.scale(n.speed*e.dt()),U=q(C);U.len()<C.len()*.3?(n.isCharging=!1,n.chargePauseTimer=.1):(n.pos.x+=U.x,n.pos.y+=U.y)}else if(n.chargePauseTimer>0)n.chargePauseTimer+=e.dt(),n.chargePauseTimer>=1&&(n.chargePauseTimer=0,n.chargeTimer=0);else if(n.chargeTimer>=n.chargeCooldown)n.color=e.rgb(255,255,0),e.wait(.2,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor),b>0&&(n.isCharging=!0,n.chargeDirection=m.unit(),n.chargeDuration=0))}),n.chargeTimer=0;else{const C=m.unit().scale(n.speed*.5*e.dt()),U=q(C);U.len()<C.len()*.5&&n.isCharging&&(n.isCharging=!1,n.chargePauseTimer=.1),n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="erratic"){if(b>0){const I=m.unit(),C=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),Y=e.vec2(I.x+C.x,I.y+C.y).unit().scale(n.speed*e.dt()),G=q(Y);n.pos.x+=G.x,n.pos.y+=G.y}return}if(n.behavior==="shield"){if(b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="teleport"){if(n.teleportTimer+=e.dt(),n.teleportTimer>=n.teleportCooldown&&b>0){const I=m.unit(),C=e.vec2(n.pos.x+I.x*n.teleportRange,n.pos.y+I.y*n.teleportRange);z(C.x,C.y)&&(n.pos.x=C.x,n.pos.y=C.y,n.teleportTimer=0,n.color=e.rgb(255,255,255),e.wait(.1,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor))}))}else if(b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="spawner"){if(n.spawnTimer+=e.dt(),n.spawnTimer>=n.spawnInterval){const I=Math.random()*Math.PI*2,C=30,U=n.pos.x+Math.cos(I)*C,Y=n.pos.y+Math.sin(I)*C;if(z(U,Y)){const G=Co(e,U,Y,n.spawnType||"rusher",n.floor);G.isBossMinion=!0,n.spawnTimer=0}}if(b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="buffer"){if(n.attackTimer+=e.dt(),n.attackTimer>=1){const I=e.get("enemy");for(const C of I){if(!C.exists()||C===n)continue;e.vec2(C.pos.x-n.pos.x,C.pos.y-n.pos.y).len()<=n.buffRadius?(C.buffed||(C.buffed=!0,C.originalSpeed=C.speed,C.originalDamage=C.damage||10),C.speed=C.originalSpeed*(1+n.buffAmount),C.damage=C.originalDamage*(1+n.buffAmount),n.buffedEnemies.add(C)):n.buffedEnemies.has(C)&&(C.buffed&&(C.speed=C.originalSpeed,C.damage=C.originalDamage,C.buffed=!1),n.buffedEnemies.delete(C))}n.attackTimer=0}if(b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="healer"){if(n.healTimer+=e.dt(),n.healTimer>=n.healInterval){const I=e.get("enemy");for(const C of I){if(!C.exists()||C===n)continue;if(e.vec2(C.pos.x-n.pos.x,C.pos.y-n.pos.y).len()<=n.healRadius){const G=C.hp(),K=C.maxHealth;if(G<K){const $=Math.min(K,G+n.healAmount);C.setHP($);const V=e.add([e.text("+",{size:16}),e.pos(C.pos.x,C.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{V.exists()&&e.destroy(V)})}}}n.healTimer=0}if(b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="teleportPlayer"){if(n.teleportTimer+=e.dt(),n.teleportTimer>=n.teleportCooldown&&b<=80){const I=Math.random()*Math.PI*2,C=p.pos.x+Math.cos(I)*n.teleportRange,U=p.pos.y+Math.sin(I)*n.teleportRange,Y=Math.max(50,Math.min(e.width()-50,C)),G=Math.max(50,Math.min(e.height()-50,U));p.pos.x=Y,p.pos.y=G,n.teleportTimer=0;const K=e.add([e.text("!",{size:24}),e.pos(p.pos.x,p.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{K.exists()&&e.destroy(K)})}if(b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="freeze"){if(b<=n.slowRadius?(p.slowed||(p.slowed=!0,p.originalSpeed=p.speed),p.speed=p.originalSpeed*(1-n.slowAmount)):p.slowed&&(p.speed=p.originalSpeed,p.slowed=!1),b>0){const C=m.unit().scale(n.speed*e.dt()),U=q(C);n.pos.x+=U.x,n.pos.y+=U.y}return}if(n.behavior==="rush"&&b>0){let I;if(n.pathfindingMode==="smart")I=Mp(e,n,p.pos.x,p.pos.y);else{const U=m.unit().scale(n.speed*e.dt());I=q(U).unit()}n.pos.x+=I.x*n.speed*e.dt(),n.pos.y+=I.y*n.speed*e.dt()}if(n.behavior==="perimeter"){const I=Sp(e,n);n.pos.x+=I.x*n.speed*e.dt(),n.pos.y+=I.y*n.speed*e.dt()}const S=e.width(),R=e.height(),P=20,D=n.size||12;n.pos.x=e.clamp(n.pos.x,P+D,S-P-D),n.pos.y=e.clamp(n.pos.y,P+D,R-P-D)}),n.isDead=!1,n.onDeath(()=>{if(n.behavior==="buffer"&&n.buffedEnemies)for(const p of n.buffedEnemies)p.exists()&&p.buffed&&(p.speed=p.originalSpeed,p.damage=p.originalDamage,p.buffed=!1)}),n.onDeath(()=>{if(n.splits&&n.hp()<=0)for(let m=0;m<2;m++){const b=Math.PI*2/2*m,S=20,R=n.pos.x+Math.cos(b)*S,P=n.pos.y+Math.sin(b)*S,D=Co(e,R,P,"slime",n.floor);D.maxHealth=Math.floor(D.maxHealth/2),D.setHP(D.maxHealth),D.size=Math.floor(D.size*.8),D.splits=!1}if(n.explodes&&n.hp()<=0){const p=e.get("player")[0];if(p&&p.exists()&&e.vec2(p.pos.x-n.pos.x,p.pos.y-n.pos.y).len()<=n.explosionRadius&&!p.invulnerable){const R=Math.max(1,n.explosionDamage-(p.defense||0));p.hurt(R),p.invulnerable=!0,p.invulnerableTime=p.invulnerableDuration,p.color=e.rgb(255,100,100)}const m=e.add([e.text("*",{size:24}),e.pos(n.pos.x,n.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{m.exists()&&e.destroy(m)})}}),eo()&&Es()&&(xp(n),n.enemyType=s),n}const ia={gatekeeper:{coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function Rp(e){return ia[e]||ia.gatekeeper}function ki(e,t,o,s="gatekeeper",i=1){const a=Rp(s),l=1+(i-1)*.2,c={coreChar:a.coreChar,armorChar:a.armorChar||"()",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*l),armorHealth:Math.floor((a.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*l),shieldHealth:Math.floor((a.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*l),speed:Math.floor(a.baseSpeed*(1+(i-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*l),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*l};function r(){const d=c.armorHealth>c.maxArmorHealth*.5?"(":"",u=c.armorHealth>0?")":"";return`${d}${c.coreChar}${u}`}const n=e.add([e.text(r(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"boss"]);return n.maxHealth=c.health,n.speed=c.speed,n.xpValue=c.xpValue,n.type=s,n.floor=i,n.textSize=c.size,a.meleeDamage&&(n.meleeDamage=a.meleeDamage),a.projectileDamage&&(n.projectileDamage=a.projectileDamage),a.projectileSpeed&&(n.projectileSpeed=a.projectileSpeed),a.fireRate&&(n.fireRate=a.fireRate),(s==="twinGuardianMelee"||s==="twinGuardianRanged")&&(n.enraged=!1),n.armorHealth=c.armorHealth,n.maxArmorHealth=c.maxArmorHealth,n.damageReduction=c.damageReduction,n.coreChar=c.coreChar,n.armorChar=c.armorChar,n.armorColor=c.armorColor,n.shieldHealth=c.shieldHealth,n.maxShieldHealth=c.maxShieldHealth,n.shieldRegenRate=c.shieldRegenRate,n.shieldChar=c.shieldChar,n.shieldColor=c.shieldColor,n.shieldRegenTimer=0,n.shieldRegenCooldown=0,n.lastDamageTime=0,n.updateVisual=function(){let d="",u="",h="",y="";if(n.shieldHealth>0){const A=n.shieldHealth/n.maxShieldHealth;A>.66?(d="",u=""):A>.33?(d="",u=""):(d="",u="")}if(n.armorHealth>0){const A=n.armorHealth/n.maxArmorHealth;A>.66?(h="",y=""):A>.33?(h="",y=""):(h="",y="")}const f=`${d}${h}${n.coreChar}${y}${u}`;n.text=f,n.shieldHealth>0?n.color=e.rgb(...c.shieldColor):n.color=e.rgb(...c.color)},n.takeDamage=function(d){let u=!1,h=!1;const y=n.shieldHealth,f=n.armorHealth;n.lastDamageTime=e.time();const A=3;if(n.shieldRegenCooldown=A,n.shieldHealth>0){const g=Math.min(d,n.shieldHealth);n.shieldHealth=Math.max(0,n.shieldHealth-g),u=n.shieldHealth!==y;const w=d-g;w>0&&n.takeDamageInternal(w)}else n.takeDamageInternal(d);h=n.armorHealth!==f,(u||h)&&n.updateVisual()},n.takeDamageInternal=function(d){if(n.armorHealth>0){const u=Math.floor(d*(1-n.damageReduction)),h=Math.min(u,n.armorHealth);n.armorHealth=Math.max(0,n.armorHealth-h);const y=d-u;if(y>0){const f=n.armorHealth>0?1-n.damageReduction:1,A=Math.floor(y*f);n.hurt(A)}}else n.hurt(d)},n.attackTimer=0,n.minionSpawnTimer=0,n.chargeCooldownTimer=0,n.chargeDurationTimer=0,n.radialBurstTimer=0,n.isCharging=!1,n.chargeDirection=null,n.chargeSpeed=0,n.spawnedMinions=[],n.enraged=!1,n.twinPartner=null,n.getPhase=function(){const d=n.hp()/n.maxHealth;return d>.75?1:d>.5?2:3},n.spawnMinions=function(){if(!n.exists())return;const d=n.getPhase(),u=d===1?2:3;for(let h=0;h<u;h++){const y=Math.PI*2/u*h+Math.random()*.5,f=40+Math.random()*20,A=n.pos.x+Math.cos(y)*f,g=n.pos.y+Math.sin(y)*f,w=Math.random()<.5?"rusher":"basic",E=Co(e,A,g,w,i);E.isBossMinion=!0,n.spawnedMinions.push(E)}},n.radialBurst=function(){if(!n.exists())return;const d=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];n.getPhase();const u=200,h=12;d.forEach(y=>{const f=Vt(e,n.pos.x,n.pos.y,y,u,h,0,0,!1);f.isBossProjectile=!0,f.color=e.rgb(255,100,100)})},n.startCharge=function(d){if(!n.exists())return;n.isCharging=!0;const u=e.vec2(d.x-n.pos.x,d.y-n.pos.y);if(u.len()>0&&(n.chargeDirection=u.unit(),!n.chargeSpeed||n.chargeSpeed===0)){const h=n.getPhase?n.getPhase():1;n.chargeSpeed=n.speed*(h===1?2.5:h===2?3:3.5)}},n.onUpdate(()=>{if(e.paused)return;if(n.shieldRegenRate>0&&n.shieldHealth<n.maxShieldHealth&&n.hp()>0&&!n.isDead&&(n.shieldRegenCooldown>0&&(n.shieldRegenCooldown-=e.dt()),n.shieldRegenCooldown<=0)){n.shieldRegenTimer+=e.dt();const g=1;if(n.shieldRegenTimer>=g){const w=n.shieldRegenRate*g;n.shieldHealth=Math.min(n.maxShieldHealth,n.shieldHealth+w),n.shieldRegenTimer=0,n.shieldHealth>0&&n.updateVisual()}}n.burnDuration>0&&n.hp()>0&&!n.isDead&&(n.burnTimer=(n.burnTimer||0)+e.dt(),n.burnTimer>=.5&&(n.takeDamage?n.takeDamage(n.burnDamage):n.hurt(n.burnDamage),n.color,n.color=e.rgb(255,150,50),e.wait(.1,()=>{n.exists()&&n.updateVisual()}),n.burnTimer=0),n.burnDuration-=e.dt(),n.burnDuration<=0&&(n.burnDamage=0,n.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const u=n.getPhase();if(n.type==="gatekeeper"){n.attackTimer+=e.dt(),n.minionSpawnTimer+=e.dt(),n.radialBurstTimer+=e.dt();const g=u===1?8:u===2?6:5,w=10,E=u===1?8:u===2?6:5;if(n.isCharging){const T=n.chargeDirection.scale(n.chargeSpeed*e.dt());n.pos.x+=T.x,n.pos.y+=T.y,n.chargeDurationTimer+=e.dt(),n.chargeDurationTimer>=1&&(n.isCharging=!1,n.chargeDurationTimer=0,n.chargeCooldownTimer=0)}else{n.chargeCooldownTimer+=e.dt();const T=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y);if(T.len()>0){const q=T.unit(),p=n.speed*(u===1?1:u===2?1.2:1.5),m=q.scale(p*e.dt()),b=n.pos.x+m.x,S=n.pos.y+m.y;let R=!0,P=!0;const D=e.get("obstacle"),I=n.size||14;for(const C of D){if(!C.exists())continue;const U=C.pos.x-C.width/2,Y=C.pos.x+C.width/2,G=C.pos.y-C.height/2,K=C.pos.y+C.height/2,$=b-I,V=b+I,ue=n.pos.y-I,Q=n.pos.y+I;V>U&&$<Y&&Q>G&&ue<K&&(R=!1,n.isCharging&&(n.isCharging=!1,n.chargeTimer=0));const we=n.pos.x-I,oe=n.pos.x+I,me=S-I,Se=S+I;oe>U&&we<Y&&Se>G&&me<K&&(P=!1,n.isCharging&&(n.isCharging=!1,n.chargeTimer=0))}R&&(n.pos.x=b),P&&(n.pos.y=S)}n.minionSpawnTimer>=g&&(n.spawnMinions(),n.minionSpawnTimer=0),n.chargeCooldownTimer>=w&&(n.color=e.rgb(255,255,0),e.wait(.3,()=>{n.exists()&&(n.color=e.rgb(...c.color),n.startCharge(d.pos))}),n.chargeCooldownTimer=0),n.radialBurstTimer>=E&&(n.radialBurst(),n.radialBurstTimer=0)}}else if(n.type==="twinGuardianMelee"){n.attackTimer+=e.dt(),n.chargeCooldownTimer+=e.dt();const g=8,w=150,E=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y),T=E.len();if(n.isCharging){const z=n.chargeDirection.scale(n.chargeSpeed*e.dt());n.pos.x+=z.x,n.pos.y+=z.y,n.chargeDurationTimer+=e.dt(),n.chargeDurationTimer>=1.2&&(n.isCharging=!1,n.chargeDurationTimer=0,n.chargeCooldownTimer=0)}else{if(T>0){const z=E.unit(),q=n.speed*(n.enraged?1.5:1),p=z.scale(q*e.dt()),m=n.pos.x+p.x,b=n.pos.y+p.y;let S=!0,R=!0;const P=e.get("obstacle"),D=n.size||14;for(const I of P){if(!I.exists())continue;const C=I.pos.x-I.width/2,U=I.pos.x+I.width/2,Y=I.pos.y-I.height/2,G=I.pos.y+I.height/2,K=m-D,$=m+D,V=n.pos.y-D,ue=n.pos.y+D;$>C&&K<U&&ue>Y&&V<G&&(S=!1);const Q=n.pos.x-D,we=n.pos.x+D,oe=b-D,me=b+D;we>C&&Q<U&&me>Y&&oe<G&&(R=!1)}S&&(n.pos.x=m),R&&(n.pos.y=b)}n.chargeCooldownTimer>=g&&T<w&&(n.color=e.rgb(255,255,0),e.wait(.3,()=>{if(n.exists()){n.color=e.rgb(...c.color);const z=n.enraged?3.5:2.5;n.chargeSpeed=n.speed*z,n.startCharge(d.pos)}}),n.chargeCooldownTimer=0)}}else if(n.type==="twinGuardianRanged"){n.attackTimer+=e.dt();const g=200,w=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y),E=w.len();if(E>0){const z=w.unit();let q=n.speed*(n.enraged?1.5:1);if(E<g){const p=z.scale(-q*e.dt()),m=n.pos.x+p.x,b=n.pos.y+p.y;let S=!0,R=!0;const P=e.get("obstacle"),D=n.size||14;for(const I of P){if(!I.exists())continue;const C=I.pos.x-I.width/2,U=I.pos.x+I.width/2,Y=I.pos.y-I.height/2,G=I.pos.y+I.height/2,K=m-D,$=m+D,V=n.pos.y-D,ue=n.pos.y+D;$>C&&K<U&&ue>Y&&V<G&&(S=!1);const Q=n.pos.x-D,we=n.pos.x+D,oe=b-D,me=b+D;we>C&&Q<U&&me>Y&&oe<G&&(R=!1)}S&&(n.pos.x=m),R&&(n.pos.y=b)}else if(E>g*1.5){const p=z.scale(q*e.dt()),m=n.pos.x+p.x,b=n.pos.y+p.y;let S=!0,R=!0;const P=e.get("obstacle"),D=n.size||14;for(const I of P){if(!I.exists())continue;const C=I.pos.x-I.width/2,U=I.pos.x+I.width/2,Y=I.pos.y-I.height/2,G=I.pos.y+I.height/2,K=m-D,$=m+D,V=n.pos.y-D,ue=n.pos.y+D;$>C&&K<U&&ue>Y&&V<G&&(S=!1);const Q=n.pos.x-D,we=n.pos.x+D,oe=b-D,me=b+D;we>C&&Q<U&&me>Y&&oe<G&&(R=!1)}S&&(n.pos.x=m),R&&(n.pos.y=b)}}const T=1/(n.fireRate*(n.enraged?1.5:1));if(n.attackTimer>=T){if(E>0){const z=w.unit(),q=Vt(e,n.pos.x,n.pos.y,z,n.projectileSpeed,n.projectileDamage*(n.enraged?1.25:1),0,0,!1);q.isBossProjectile=!0,q.color=e.rgb(100,150,255)}n.attackTimer=0}}else if(n.type==="swarmQueen"){n.minionSpawnTimer+=e.dt();const g=n.hp()/n.maxHealth;let w;g>.66?w=5:g>.33?w=3:w=2;const E=n.spawnedMinions.filter(P=>P.exists()&&P.hp()>0);if(n.minionSpawnTimer>=w&&E.length<8){const P=Math.random()<.5?"fast":"basic",D=Math.random()*Math.PI*2,I=50+Math.random()*30,C=n.pos.x+Math.cos(D)*I,U=n.pos.y+Math.sin(D)*I,Y=Co(e,C,U,P,i);Y.isBossMinion=!0,n.spawnedMinions.push(Y),n.spawnedMinions=n.spawnedMinions.filter(G=>G.exists()),n.minionSpawnTimer=0}const z=e.width()/2,q=e.height()/2,p=150,m=e.vec2(z-n.pos.x,q-n.pos.y),b=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y),S=b.len();let R=e.vec2(0,0);if(m.len()>30&&(R=R.add(m.unit().scale(.5))),S<p&&(R=R.add(b.unit().scale(-1))),R.len()>0){const D=R.unit().scale(n.speed*e.dt()),I=n.pos.x+D.x,C=n.pos.y+D.y;let U=!0,Y=!0;const G=e.get("obstacle"),K=n.size||14;for(const $ of G){if(!$.exists())continue;const V=$.pos.x-$.width/2,ue=$.pos.x+$.width/2,Q=$.pos.y-$.height/2,we=$.pos.y+$.height/2,oe=I-K,me=I+K,Se=n.pos.y-K,Te=n.pos.y+K;me>V&&oe<ue&&Te>Q&&Se<we&&(U=!1);const Ve=n.pos.x-K,it=n.pos.x+K,je=C-K,k=C+K;it>V&&Ve<ue&&k>Q&&je<we&&(Y=!1)}U&&(n.pos.x=I),Y&&(n.pos.y=C)}}else{const g=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y);if(g.len()>0){const T=g.unit().scale(n.speed*e.dt()),z=n.pos.x+T.x,q=n.pos.y+T.y;let p=!0,m=!0;const b=e.get("obstacle"),S=n.size||14;for(const R of b){if(!R.exists())continue;const P=R.pos.x-R.width/2,D=R.pos.x+R.width/2,I=R.pos.y-R.height/2,C=R.pos.y+R.height/2,U=z-S,Y=z+S,G=n.pos.y-S,K=n.pos.y+S;Y>P&&U<D&&K>I&&G<C&&(p=!1);const $=n.pos.x-S,V=n.pos.x+S,ue=q-S,Q=q+S;V>P&&$<D&&Q>I&&ue<C&&(m=!1)}p&&(n.pos.x=z),m&&(n.pos.y=q)}}const h=e.width(),y=e.height(),f=20,A=n.size||14;n.pos.x=e.clamp(n.pos.x,f+A,h-f-A),n.pos.y=e.clamp(n.pos.y,f+A,y-f-A)}),n.isDead=!1,s==="swarmQueen"&&n.onDeath(()=>{const d=8+Math.floor(Math.random()*5);for(let u=0;u<d;u++){const h=Math.PI*2/d*u+Math.random()*.3,y=40+Math.random()*20,f=n.pos.x+Math.cos(h)*y,A=n.pos.y+Math.sin(h)*y,g=Math.random()<.5?"fast":"basic",w=Co(e,f,A,g,i);w.isBossMinion=!0}}),n.updateVisual(),n}function Dp(e,t,o,s=1){const i=ki(e,t.pos.x,t.pos.y,"twinGuardianMelee",s),a=ki(e,o.pos.x,o.pos.y,"twinGuardianRanged",s);return i.twinPartner=a,a.twinPartner=i,i.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enraged=!0,a.speed=Math.floor(a.speed*1.5),a.fireRate=a.fireRate*1.5,a.projectileDamage=Math.floor(a.projectileDamage*1.25),a.color=e.rgb(255,200,0))}),a.onDeath(()=>{i&&i.exists()&&!i.enraged&&(i.enraged=!0,i.speed=Math.floor(i.speed*1.5),i.chargeCooldownTimer=0,i.meleeDamage=Math.floor(i.meleeDamage*1.25),i.color=e.rgb(255,200,0))}),[i,a]}const na={brute:{coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function Tp(e){return na[e]||na.brute}function Cp(e,t,o,s="brute",i=1){const a=Tp(s),l=1+(i-1)*.2,c={coreChar:a.coreChar,armorChar:a.armorChar||"[]",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*l),armorHealth:Math.floor((a.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*l),shieldHealth:Math.floor((a.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*l),speed:Math.floor(a.baseSpeed*(1+(i-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*l),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*l},r=e.add([e.text(c.coreChar,{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"miniboss"]);return r.maxHealth=c.health,r.speed=c.speed,r.xpValue=c.xpValue,r.type=s,r.floor=i,a.meleeDamage&&(r.meleeDamage=a.meleeDamage),a.projectileDamage&&(r.projectileDamage=a.projectileDamage),a.projectileSpeed&&(r.projectileSpeed=a.projectileSpeed),a.fireRate&&(r.fireRate=a.fireRate),r.armorHealth=c.armorHealth,r.maxArmorHealth=c.maxArmorHealth,r.damageReduction=c.damageReduction,r.coreChar=c.coreChar,r.armorChar=c.armorChar,r.armorColor=c.armorColor,r.shieldHealth=c.shieldHealth,r.maxShieldHealth=c.maxShieldHealth,r.shieldRegenRate=c.shieldRegenRate,r.shieldChar=c.shieldChar,r.shieldColor=c.shieldColor,r.shieldRegenTimer=0,r.shieldRegenCooldown=0,r.lastDamageTime=0,r.attackTimer=0,r.chargeCooldownTimer=0,r.chargeDurationTimer=0,r.isCharging=!1,r.chargeDirection=null,r.chargeSpeed=0,r.updateVisual=function(){let n="",d="",u="",h="";if(r.shieldHealth>0){const f=r.shieldHealth/r.maxShieldHealth;f>.66?(n="",d=""):f>.33?(n="",d=""):(n="",d="")}if(r.armorHealth>0){const f=r.armorHealth/r.maxArmorHealth;f>.66?(u="",h=""):f>.33?(u="",h=""):(u="",h="")}const y=`${n}${u}${r.coreChar}${h}${d}`;r.text=y,r.shieldHealth>0?r.color=e.rgb(...c.shieldColor):r.color=e.rgb(...c.color)},r.takeDamage=function(n){let d=!1,u=!1;const h=r.shieldHealth,y=r.armorHealth;r.lastDamageTime=e.time();const f=3;if(r.shieldRegenCooldown=f,r.shieldHealth>0){const A=Math.min(n,r.shieldHealth);r.shieldHealth=Math.max(0,r.shieldHealth-A),d=r.shieldHealth!==h;const g=n-A;g>0&&r.takeDamageInternal(g)}else r.takeDamageInternal(n);u=r.armorHealth!==y,(d||u)&&r.updateVisual()},r.takeDamageInternal=function(n){if(r.armorHealth>0){const d=Math.floor(n*(1-r.damageReduction)),u=Math.min(d,r.armorHealth);r.armorHealth=Math.max(0,r.armorHealth-u);const h=n-d;if(h>0){const y=r.armorHealth>0?1-r.damageReduction:1,f=Math.floor(h*y);r.hurt(f)}}else r.hurt(n)},r.startCharge=function(n){if(!r.exists())return;r.isCharging=!0;const d=e.vec2(n.x-r.pos.x,n.y-r.pos.y);d.len()>0&&(r.chargeDirection=d.unit(),r.chargeSpeed=r.speed*2.5)},r.onUpdate(()=>{if(e.paused)return;if(r.shieldRegenRate>0&&r.shieldHealth<r.maxShieldHealth&&r.hp()>0&&!r.isDead&&(r.shieldRegenCooldown>0&&(r.shieldRegenCooldown-=e.dt()),r.shieldRegenCooldown<=0)){r.shieldRegenTimer+=e.dt();const g=1;if(r.shieldRegenTimer>=g){const w=r.shieldRegenRate*g;r.shieldHealth=Math.min(r.maxShieldHealth,r.shieldHealth+w),r.shieldRegenTimer=0,r.shieldHealth>0&&r.updateVisual()}}r.burnDuration>0&&r.hp()>0&&!r.isDead&&(r.burnTimer=(r.burnTimer||0)+e.dt(),r.burnTimer>=.5&&(r.takeDamage?r.takeDamage(r.burnDamage):r.hurt(r.burnDamage),r.color,r.color=e.rgb(255,150,50),e.wait(.1,()=>{r.exists()&&r.updateVisual()}),r.burnTimer=0),r.burnDuration-=e.dt(),r.burnDuration<=0&&(r.burnDamage=0,r.burnTimer=0));const n=e.get("player")[0];if(!n||!n.exists())return;const d=e.vec2(n.pos.x-r.pos.x,n.pos.y-r.pos.y),u=d.len();if(a.behavior==="charge"){r.attackTimer+=e.dt(),r.chargeCooldownTimer+=e.dt();const g=6,w=200;if(r.isCharging){const E=r.chargeDirection.scale(r.chargeSpeed*e.dt());r.pos.x+=E.x,r.pos.y+=E.y,r.chargeDurationTimer+=e.dt(),r.chargeDurationTimer>=1&&(r.isCharging=!1,r.chargeDurationTimer=0,r.chargeCooldownTimer=0)}else{if(u>0){const T=d.unit().scale(r.speed*e.dt());r.pos.x+=T.x,r.pos.y+=T.y}r.chargeCooldownTimer>=g&&u<w&&(r.color=e.rgb(255,255,0),e.wait(.3,()=>{r.exists()&&(r.color=e.rgb(...c.color),r.startCharge(n.pos))}),r.chargeCooldownTimer=0)}}else if(a.behavior==="shoot"){r.attackTimer+=e.dt();const g=180;if(u>0){const E=d.unit();let T=r.speed;if(u<g){const z=E.scale(-T*e.dt());r.pos.x+=z.x,r.pos.y+=z.y}else if(u>g*1.5){const z=E.scale(T*e.dt());r.pos.x+=z.x,r.pos.y+=z.y}}const w=1/r.fireRate;if(r.attackTimer>=w){if(u>0){const E=d.unit(),T=Vt(e,r.pos.x,r.pos.y,E,r.projectileSpeed,r.projectileDamage,0,0,!1);T.isBossProjectile=!0,T.color=e.rgb(...c.color)}r.attackTimer=0}}else if(a.behavior==="rush"&&u>0){const w=d.unit().scale(r.speed*e.dt());r.pos.x+=w.x,r.pos.y+=w.y}const h=e.width(),y=e.height(),f=20,A=r.size||24;r.pos.x=e.clamp(r.pos.x,f+A,h-f-A),r.pos.y=e.clamp(r.pos.y,f+A,y-f-A)}),r.isDead=!1,r.updateVisual(),r}const No={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function Ip(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const s=1+(t-1)*.1;for(const[i,a]of Object.entries(No)){const l=a.dropChance*s;if(Math.random()<l)return i}return null}function Pp(e,t){const o=No[t];if(!o)return;const s=Ji[o.weaponKey];s&&(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=o.weaponKey,e.weaponDef=s,e.fireRate=s.fireRate,e.projectileSpeed=s.projectileSpeed,e.projectileDamage=s.baseDamage,e.projectileCount=s.projectileCount,e.piercing=s.piercing,e.obstaclePiercing=s.obstaclePiercing,e.critChance=s.critChance,e.critDamage=s.critDamage,e.spreadAngle=s.spreadAngle,e.weaponRange=s.range,e.weaponCategory=s.category,s.orbitRadius&&(e.orbitRadius=s.orbitRadius,e.rotationSpeed=s.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),s.explosionRadius&&(e.explosionRadius=s.explosionRadius,e.explosionDamage=s.explosionDamage),s.chainRange&&(e.chainRange=s.chainRange,e.maxJumps=s.maxJumps,e.chainDamageReduction=s.chainDamageReduction),o.isAmmoBased?(e.powerupAmmo=o.ammo,e.powerupDuration=null):o.isTimeBased&&(e.powerupDuration=o.duration,e.powerupAmmo=null))}function aa(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function Bp(e,t=0){if(!e.powerupWeapon)return!1;const o=No[e.powerupWeapon];return o&&(o.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||o.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(aa(e),!0):!1}function Op(e){if(!e.powerupWeapon)return;const t=No[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function Lp(e){if(!e.powerupWeapon)return null;const t=No[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function Bs(e,t,o,s){const i=e.add([e.text("+",{size:16}),e.pos(t,o),e.anchor("center"),e.color(...Xe.XP_COLOR),e.area(),"xpPickup"]);return i.value=s,i.lifetime=Xe.XP_LIFETIME,i.age=0,i.collected=!1,i.magnetizing=!1,i.magnetizeSpeed=0,i.targetPlayer=null,i.onUpdate(()=>{if(e.paused){const l=Math.sin(i.age*Xe.XP_PULSE_SPEED)*Xe.XP_PULSE_AMOUNT;i.scale=e.vec2(1+l);return}i.age+=e.dt();const a=Math.sin(i.age*Xe.XP_PULSE_SPEED)*Xe.XP_PULSE_AMOUNT;if(i.scale=e.vec2(1+a),i.magnetizing&&i.targetPlayer&&i.targetPlayer.exists()){const l=e.vec2(i.targetPlayer.pos.x-i.pos.x,i.targetPlayer.pos.y-i.pos.y),c=l.len();if(c>0){const r=l.scale(1/c);i.magnetizeSpeed=Math.min(i.magnetizeSpeed+Xe.MAGNETIZE_ACCELERATION*e.dt(),Xe.MAGNETIZE_SPEED),i.pos=i.pos.add(r.scale(i.magnetizeSpeed*e.dt()))}}i.age>=i.lifetime&&e.destroy(i)}),i.pickupType="xp",eo()&&Es()&&En(i),i}const ra=["$","","","","","","",""];function Qr(){return ra[Math.floor(Math.random()*ra.length)]}function Os(e,t,o,s,i=null){const a=i||Qr(),l=e.add([e.text(a,{size:9}),e.pos(t,o),e.anchor("center"),e.color(...Xe.CURRENCY_COLOR),e.area(),"currencyPickup"]);return l.value=s,l.lifetime=Xe.CURRENCY_LIFETIME,l.age=0,l.collected=!1,l.magnetizing=!1,l.magnetizeSpeed=0,l.targetPlayer=null,l.onUpdate(()=>{if(e.paused){const r=Math.sin(l.age*Xe.CURRENCY_PULSE_SPEED)*Xe.CURRENCY_PULSE_AMOUNT;l.scale=e.vec2(1+r);return}l.age+=e.dt();const c=Math.sin(l.age*Xe.CURRENCY_PULSE_SPEED)*Xe.CURRENCY_PULSE_AMOUNT;if(l.scale=e.vec2(1+c),l.magnetizing&&l.targetPlayer&&l.targetPlayer.exists()){const r=e.vec2(l.targetPlayer.pos.x-l.pos.x,l.targetPlayer.pos.y-l.pos.y),n=r.len();if(n>0){const d=r.scale(1/n);l.magnetizeSpeed=Math.min(l.magnetizeSpeed+Xe.MAGNETIZE_ACCELERATION*e.dt(),Xe.MAGNETIZE_SPEED),l.pos=l.pos.add(d.scale(l.magnetizeSpeed*e.dt()))}}l.age>=l.lifetime&&e.destroy(l)}),l.pickupType="currency",eo()&&Es()&&En(l),l}function la(e,t,o,s){const i=No[s];if(!i)return null;const a=e.add([e.text(i.icon,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...i.color),e.area(),"powerupWeaponPickup"]);return a.powerupKey=s,a.lifetime=Xe.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.onUpdate(()=>{if(e.paused){const c=Math.sin(a.age*4)*.15;a.scale=e.vec2(1+c),a.angle=Math.sin(a.age*2)*10;return}a.age+=e.dt();const l=Math.sin(a.age*4)*.15;if(a.scale=e.vec2(1+l),a.angle=Math.sin(a.age*2)*10,a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){const c=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),r=c.len();if(r>0){const n=c.scale(1/r);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+Xe.MAGNETIZE_ACCELERATION*e.dt(),Xe.MAGNETIZE_SPEED),a.pos=a.pos.add(n.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="powerup",eo()&&Es()&&En(a),a}function zp(e,t,o,s){const i=e.add([e.rect(40,40),e.pos(t,o),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return i.direction=s,i.open=!1,i.isSpawnDoor=!1,i.blocked=!1,i.gridDirection=null,i.parts=[],i.updateVisual=()=>{i.parts.forEach(l=>{l.exists()&&e.destroy(l)}),i.parts=[];let a;if(i.blocked?a=e.rgb(80,80,80):i.open?a=e.rgb(100,255,100):i.isSpawnDoor?a=e.rgb(200,50,50):a=e.rgb(200,200,100),s==="north"||s==="south"){const l=i.blocked?"":i.open?"":"",c=e.add([e.text(l,{size:24}),e.pos(t,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(c);const r=e.add([e.text(i.open?"":"",{size:20}),e.pos(t-35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(r);const n=e.add([e.text(i.open?"":"",{size:20}),e.pos(t+35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(n)}else{const l=i.blocked?["","",""]:i.open?["","",""]:["","",""],c=16;for(let d=0;d<l.length;d++){const u=(d-1)*c,h=e.add([e.text(l[d],{size:24}),e.pos(t,o+u),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(h)}const r=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,o-c*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(r);const n=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,o+c*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(n)}if(i.blocked){const l=e.add([e.text("X",{size:28}),e.pos(t,o),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);i.parts.push(l)}},Object.defineProperty(i,"color",{get:()=>i._color,set:a=>{i._color=a,i.parts.forEach(l=>{l.exists()&&(l.color=a)})}}),Object.defineProperty(i,"text",{get:()=>i._text||"=",set:a=>{i._text=a}}),i.onDestroy(()=>{i.parts.forEach(a=>{a.exists()&&e.destroy(a)}),i.parts=[]}),i.updateVisual(),i}function Hp(e,t,o,s,i,a="wall",l="#",c=null){const r=a==="wall",n=r?e.rgb(100,100,100):e.rgb(140,140,140),d=r?e.rgb(80,80,80):e.rgb(120,120,120),u=e.add([e.rect(s,i),e.pos(t,o),e.anchor("center"),e.color(c||n),e.outline(2,c||d),e.area({width:s,height:i}),e.fixed(),"obstacle",a==="wall"?"wall":"cover"]);return u.type=a,u.width=s,u.height=i,u}let ps=null,Zr=.3;function kr(){return ps||(ps=new(window.AudioContext||window.webkitAudioContext)),ps}function Mn(){return ps||kr(),ps}function fe(e,t,o="square",s=.3,i={}){const a=Mn(),l=a.currentTime,c=a.createOscillator();c.type=o,c.frequency.setValueAtTime(e,l),i.pitchBend&&c.frequency.exponentialRampToValueAtTime(e*i.pitchBend,l+t);const r=a.createGain(),n=s*Zr,d=i.attack||.01;r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(n,l+d);const u=i.decay||.1;r.gain.setValueAtTime(n,l+t-u),r.gain.exponentialRampToValueAtTime(.01,l+t),c.connect(r),r.connect(a.destination),c.start(l),c.stop(l+t)}function oo(e,t=.3,o={}){const s=Mn(),i=s.currentTime,a=s.sampleRate*e,l=s.createBuffer(1,a,s.sampleRate),c=l.getChannelData(0);for(let f=0;f<a;f++)c[f]=Math.random()*2-1;const r=s.createBufferSource();r.buffer=l;const n=s.createBiquadFilter();n.type=o.filterType||"lowpass",n.frequency.setValueAtTime(o.filterFreq||2e3,i);const d=s.createGain(),u=t*Zr,h=o.attack||.01,y=o.decay||.1;d.gain.setValueAtTime(0,i),d.gain.linearRampToValueAtTime(u,i+h),d.gain.setValueAtTime(u,i+e-y),d.gain.exponentialRampToValueAtTime(.01,i+e),r.connect(n),n.connect(d),d.connect(s.destination),r.start(i),r.stop(i+e)}function le(e,t=.1){return e*(1+(Math.random()-.5)*t)}function el(){const e=Math.random();e<.33?fe(le(150,.2),.08,"square",.15,{attack:.001,decay:.05,pitchBend:.5}):e<.66?fe(le(180,.2),.09,"square",.15,{attack:.001,decay:.06,pitchBend:.6}):fe(le(200,.2),.07,"square",.15,{attack:.001,decay:.04,pitchBend:.4})}function Np(){const e=Math.random();e<.33?fe(le(250,.3),.05,"square",.12,{attack:.001,decay:.03,pitchBend:.4}):e<.66?fe(le(280,.3),.04,"sawtooth",.12,{attack:.001,decay:.025,pitchBend:.5}):fe(le(230,.3),.06,"square",.12,{attack:.001,decay:.04,pitchBend:.3})}function Up(){const e=le(80,.15);fe(e,.15,"sawtooth",.25,{attack:.001,decay:.1,pitchBend:.3}),oo(le(.12,.2),le(.2,.3),{attack:.001,decay:.08,filterType:"lowpass",filterFreq:le(1500,.4)})}function qp(){fe(le(400,.2),.06,"square",.2,{attack:.001,decay:.04,pitchBend:.2}),fe(le(60,.15),.12,"sine",.18,{attack:.001,decay:.08,pitchBend:.5})}function Fp(){oo(.08,le(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:le(800,.5)})}function _p(){fe(le(70,.2),.2,"sawtooth",.22,{attack:.001,decay:.15,pitchBend:.4}),fe(le(120,.2),.15,"square",.18,{attack:.005,decay:.1,pitchBend:.5})}function Xp(){fe(le(300,.3),.12,"sawtooth",.18,{attack:.001,decay:.08,pitchBend:1.8}),oo(le(.1,.3),.15,{attack:.001,decay:.06,filterType:"highpass",filterFreq:le(3e3,.4)})}function Yp(){fe(le(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function Gp(){el()}function Kp(){const e=Math.random();e<.25?fe(le(120,.3),.08,"square",.16,{attack:.001,decay:.05,pitchBend:.5}):e<.5?fe(le(100,.3),.09,"sawtooth",.16,{attack:.001,decay:.06,pitchBend:.6}):e<.75?(fe(le(140,.3),.07,"square",.16,{attack:.001,decay:.04,pitchBend:.4}),oo(.05,.1,{attack:.001,decay:.03,filterFreq:le(1200,.4)})):fe(le(160,.3),.06,"triangle",.16,{attack:.001,decay:.04,pitchBend:.3})}function Ls(){const e=Math.random();e<.33?(fe(le(80,.2),.15,"sawtooth",.25,{attack:.001,decay:.1,pitchBend:.4}),oo(.12,.2,{attack:.001,decay:.08,filterType:"lowpass",filterFreq:le(1e3,.3)})):e<.66?(fe(le(70,.2),.18,"square",.25,{attack:.001,decay:.12,pitchBend:.5}),fe(le(200,.3),.08,"triangle",.15,{attack:.005,decay:.05,pitchBend:.3})):(fe(le(90,.2),.16,"sawtooth",.25,{attack:.001,decay:.11,pitchBend:.6}),oo(.1,.18,{attack:.001,decay:.07,filterType:"bandpass",filterFreq:le(800,.4)}))}function ca(){const e=Math.random();e<.33?fe(le(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(fe(le(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),oo(.15,.12,{attack:.05,decay:.1,filterFreq:le(1500,.4)})):fe(le(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function tl(){fe(le(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),fe(le(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),oo(le(.3,.2),le(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:le(1200,.5)})}function Vp(){const e=Math.random();e<.33?fe(le(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?fe(le(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):fe(le(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function ha(){const e=Math.random();e<.33?(fe(le(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{fe(le(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(fe(le(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),fe(le(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(fe(le(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{fe(le(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function jp(){Mn().currentTime;const t=400;[1,1.25,1.5,2].forEach((s,i)=>{setTimeout(()=>{fe(t*s,.15,"square",.2,{attack:.01,decay:.1})},i*80)})}function Wp(){fe(le(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Ut(){fe(le(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function xt(){fe(le(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function $p(){fe(le(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{fe(le(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function da(){fe(le(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{fe(le(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function Jp(){for(let t=0;t<8;t++)setTimeout(()=>{fe(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{tl()},480)}function Qp(){[400,500,600,800].forEach((t,o)=>{setTimeout(()=>{fe(t,.2,"square",.18,{attack:.01,decay:.15})},o*100)})}function ua(){fe(le(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{fe(le(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function pa(){fe(le(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),oo(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:le(500,.3)})}function Zp(){fe(le(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function fa(){fe(le(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function kp(e){const t=(e==null?void 0:e.toLowerCase())||"";t.includes("pistol")?el():t.includes("smg")||t.includes("submachine")?Np():t.includes("shotgun")?Up():t.includes("sniper")||t.includes("rifle")?qp():t.includes("flame")||t.includes("thrower")?Fp():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?_p():t.includes("chain")||t.includes("lightning")?Xp():t.includes("orbital")?Yp():Gp()}function ks(e,t,o,s={}){const{char:i="*",size:a=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:r=0,lifetime:n=1,fadeStart:d=.3,friction:u=.95,zIndex:h=100}=s,y=e.add([e.text(i,{size:a}),e.pos(t,o),e.anchor("center"),e.color(...l),e.z(h),"particle"]);return y.velocity={x:c.x,y:c.y},y.gravity=r,y.friction=u,y.lifetime=n,y.fadeStart=d,y.age=0,y.initialOpacity=1,y}function e0(e){e.get("particle").forEach(o=>{if(!o.exists())return;if(o.age+=e.dt(),o.age>=o.lifetime){e.destroy(o);return}o.pos.x+=o.velocity.x*e.dt()*60,o.pos.y+=o.velocity.y*e.dt()*60,o.velocity.y+=o.gravity*e.dt()*60,o.velocity.x*=o.friction,o.velocity.y*=o.friction;const s=o.age/o.lifetime;if(s>=o.fadeStart){const i=(s-o.fadeStart)/(1-o.fadeStart);o.opacity=o.initialOpacity*(1-i)}})}function Mo(e,t,o,s={}){const{count:i=8,color:a=[255,50,50],speed:l=2,isCrit:c=!1}=s,r=[".",",","'","`","*"],n=c?i*1.5:i,d=c?l*1.5:l,u=c?[255,200,0]:a;for(let h=0;h<n;h++){const y=Math.PI*2*h/n+(Math.random()-.5)*.5,f=.5+Math.random()*.5,A={x:Math.cos(y)*d*f,y:Math.sin(y)*d*f};ks(e,t,o,{char:r[Math.floor(Math.random()*r.length)],size:8+Math.random()*6,color:u,velocity:A,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function zs(e,t,o,s={}){const{count:i=12,color:a=[255,100,100],speed:l=3,isBoss:c=!1,isMiniboss:r=!1}=s,n=["*","+","x","X","#"],d=c?i*2:r?i*1.5:i,u=c?l*1.5:r?l*1.2:l;for(let y=0;y<d;y++){const f=Math.PI*2*y/d,A=.7+Math.random()*.6,g={x:Math.cos(f)*u*A,y:Math.sin(f)*u*A};ks(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:12+Math.random()*8,color:a,velocity:g,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const h=Math.floor(d/2);for(let y=0;y<h;y++){const f=Math.random()*Math.PI*2,A=.3+Math.random()*.4,g={x:Math.cos(f)*u*A*.5,y:Math.sin(f)*u*A*.5};ks(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:16+Math.random()*8,color:[255,200,100],velocity:g,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}function Si(e,t,o,s,i={}){const{count:a=5,color:l=[255,255,100],speed:c=2.5,isCrit:r=!1}=i,n=["","","",""],d=r?a*2:a,u=r?[255,200,0]:l,h=Math.sqrt(s.x*s.x+s.y*s.y),y=h>0?{x:s.x/h,y:s.y/h}:{x:1,y:0};for(let f=0;f<d;f++){const A=(Math.random()-.5)*Math.PI*.6,g=Math.atan2(y.y,y.x)+A,w=.6+Math.random()*.8,E={x:Math.cos(g)*c*w,y:Math.sin(g)*c*w};ks(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:10+Math.random()*4,color:u,velocity:E,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function ts(e,t,o,s){if(!t||!t.exists())return;const i=20,a=e.width()-i,l=e.height()-i,c=i,r=i,n=t.pos.x+o.x*s,d=t.pos.y+o.y*s,u=Math.max(c,Math.min(a,n)),h=Math.max(r,Math.min(l,d)),y=t.pos.x,f=t.pos.y;t.pos.x=u,t.pos.y=h;const A=e.get("wall"),g=e.get("obstacle"),w=[...A,...g];let E=!1;for(const T of w)if(T.exists()&&t.isColliding&&t.isColliding(T)){E=!0;break}E&&(t.pos.x=y,t.pos.y=f)}function t0(e,t){let o=0;t.weaponKey==="orbital"&&en(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.weaponKey==="orbital"){o0(e,t);return}const s=e.mousePos(),i=e.time(),a=e.vec2(s.x-t.pos.x,s.y-t.pos.y);if(a.len()>0){const c=a.unit();if(i-o>=1/t.fireRate){const r=t.projectileCount||1,n=t.spreadAngle||0,d=[];if(r===1)d.push(c);else if(n>0){const u=r>1?n/(r-1):0,h=-n/2;for(let y=0;y<r;y++){const A=(h+u*y)*(Math.PI/180),g=Math.cos(A),w=Math.sin(A),E=e.vec2(c.x*g-c.y*w,c.x*w+c.y*g);d.push(E.unit())}}else for(let u=0;u<r;u++)d.push(c);d.forEach((u,h)=>{const y=n===0&&r>1?h*gt.MULTISHOT_STAGGER_DELAY:0;e.wait(y,()=>{const f=Wu(t.critChance||0);let A=f?$u(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(A=Math.floor(A*t.piercingDamageBonus));const g=t.weaponRange||Ko.DEFAULT_WEAPON_RANGE;if(kp(t.weaponKey),t.weaponKey==="flamethrower"){const w=Vt(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.piercing||0,t.obstaclePiercing||0,f,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef);const E=Math.floor(A*.3),T=2,z=t.fireDotMultiplier||1;w.burnDamage=Math.floor(E*z),w.burnDuration=T}else if(t.weaponKey==="explosive"){const w=s0(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.explosionRadius,t.explosionDamage,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}else if(t.weaponKey==="chainLightning"){const w=i0(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.chainRange,t.maxJumps,t.chainDamageReduction,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}else{const w=Vt(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.piercing||0,t.obstaclePiercing||0,f,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}})}),o=i,Op(t)}}}),e.onCollide("projectile","wall",(s,i)=>{e.paused||s.isExplosive||s.piercedObstacles&&s.piercedObstacles.has(i)||(s.obstaclePiercing>0?(s.piercedObstacles&&s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)):e.destroy(s))}),e.onCollide("projectile","cover",(s,i)=>{if(!e.paused&&s.obstaclePiercing>0&&s.piercedObstacles){if(s.piercedObstacles.has(i))return;s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)}}),e.onCollide("projectile","obstacle",(s,i)=>{e.paused||s.isExplosive||s.piercedObstacles&&s.piercedObstacles.has(i)||(s.obstaclePiercing>0?(s.piercedObstacles&&s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)):e.destroy(s))}),e.onCollide("projectile","enemy",(s,i)=>{if(e.paused||s.isEnemyProjectile||s.isBossProjectile||s.piercedEnemies&&s.piercedEnemies.has(i))return;Kp(),i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Mo(e,i.pos.x,i.pos.y,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s);const a=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);if(a.len()>0){const c=a.unit(),r=gt.KNOCKBACK_ENEMY_FROM_PROJECTILE;ts(e,i,c,r)}Si(e,i.pos.x,i.pos.y,a,{isCrit:s.isCrit}),i.color=s.isCrit?e.rgb(...gt.CRIT_COLOR):e.rgb(...gt.HIT_COLOR),e.wait(gt.HIT_FLASH_DURATION,()=>{i.exists()&&(i.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(s,i)=>{e.paused||s.isExplosive&&Ri(e,s,i.pos.x,i.pos.y)}),e.onCollide("projectile","boss",(s,i)=>{if(e.paused||!s.isChainLightning||s.chainedEnemies&&s.chainedEnemies.has(i))return;const a=s.chainJumps||0,l=1-(s.chainDamageReduction||.15)*a,c=Math.floor(s.damage*Math.max(.1,l));i.takeDamage?i.takeDamage(c):i.hurt(c),s.chainedEnemies&&s.chainedEnemies.add(i),e.wait(.01,()=>{s.exists()&&(s.chainJumps<s.maxJumps?ga(e,s,i):e.destroy(s))})}),e.onCollide("projectile","miniboss",(s,i)=>{if(e.paused||s.isEnemyProjectile||s.isBossProjectile||s.piercedEnemies&&s.piercedEnemies.has(i))return;let a=s.damage;s.isCrit&&(a=Math.floor(a*1.5)),i.takeDamage(a),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Mo(e,i.pos.x,i.pos.y,{isCrit:s.isCrit});const l=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);Si(e,i.pos.x,i.pos.y,l,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s),i.color=s.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("projectile","boss",(s,i)=>{if(e.paused||s.isExplosive||s.isChainLightning||s.piercedEnemies&&s.piercedEnemies.has(i))return;i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Mo(e,i.pos.x,i.pos.y,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s);const a=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);if(a.len()>0){const c=a.unit(),r=gt.KNOCKBACK_BOSS_FROM_PROJECTILE;ts(e,i,c,r)}Si(e,i.pos.x,i.pos.y,a,{isCrit:s.isCrit}),i.color=s.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("enemy","player",(s,i)=>{if(e.paused||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Ls();const a=s.damage||gt.BASE_ENEMY_DAMAGE,l=vi(a,i.defense||0,i.damageReduction||0);if(i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Mo(e,i.pos.x,i.pos.y,{color:[255,100,100]}),s.lifesteal&&s.exists()){const n=s.hp(),d=s.maxHealth;if(n<d){const u=Math.min(d,n+s.lifesteal);s.setHP(u)}}const c=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(c.len()>0){const n=c.unit(),d=gt.KNOCKBACK_ENEMY;ts(e,s,n,d)}i.color=e.rgb(...gt.HIT_COLOR)}),e.onCollide("miniboss","player",(s,i)=>{if(e.paused||i.invulnerable)return;Ls();let a=gt.BASE_MINIBOSS_DAMAGE;(s.type==="brute"||s.type==="berserker"||s.type==="guardian")&&s.meleeDamage&&(a=s.meleeDamage);const l=vi(a,i.defense||0,0);i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Mo(e,i.pos.x,i.pos.y,{color:[255,100,100]});const c=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(c.len()>0){const n=c.unit(),d=gt.KNOCKBACK_MINIBOSS;ts(e,s,n,d)}i.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(s,i)=>{if(e.paused||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Ls();let a=gt.BASE_BOSS_DAMAGE;if(s.type==="twinGuardianMelee"&&s.meleeDamage){const n=s.enraged?gt.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;a=s.meleeDamage*n}const l=vi(a,i.defense||0,i.damageReduction||0);i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Mo(e,i.pos.x,i.pos.y,{color:[255,100,100]});const c=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(c.len()>0){const n=c.unit(),d=gt.KNOCKBACK_BOSS;ts(e,s,n,d)}i.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(s,i)=>{if(e.paused||!s.isBossProjectile&&!s.isEnemyProjectile||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Ls();const a=s.damage*(1-(i.damageReduction||0)),l=Math.max(1,a-(i.defense||0));i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Mo(e,i.pos.x,i.pos.y,{color:[255,100,100]}),e.destroy(s),i.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(s,i)=>{e.paused||i.exists()&&(s.contactCooldown>0||(i.hurt(s.damage),s.contactCooldown=s.contactCooldownDuration||.2))}),e.onCollide("orbital","boss",(s,i)=>{e.paused||i.exists()&&(s.contactCooldown>0||(i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.contactCooldown=s.contactCooldownDuration||.2))}),e.onCollide("projectile","enemy",(s,i)=>{e.paused||s.isExplosive&&Ri(e,s,i.pos.x,i.pos.y)}),e.onCollide("projectile","wall",(s,i)=>{e.paused||s.isExplosive&&Ri(e,s,s.pos.x,s.pos.y)}),e.onCollide("projectile","enemy",(s,i)=>{if(e.paused||!s.isChainLightning||s.chainedEnemies&&s.chainedEnemies.has(i))return;const a=s.chainJumps||0,l=1-(s.chainDamageReduction||.15)*a,c=Math.floor(s.damage*Math.max(.1,l));i.takeDamage?i.takeDamage(c):i.hurt(c),s.chainedEnemies&&s.chainedEnemies.add(i),s.chainJumps<s.maxJumps?ga(e,s,i):e.destroy(s)})}function en(e,t){var i,a;t.orbitalOrbs||(t.orbitalOrbs=[],t.orbitalAngles=[]);const o=t.projectileCount||1,s=t.orbitRadius||Ko.BASE_ORBIT_RADIUS;for(let l=0;l<o;l++){const c=360/o*l,r=c*Math.PI/180,n=t.pos.x+Math.cos(r)*s,d=t.pos.y+Math.sin(r)*s,u=e.add([e.text(((i=t.weaponDef)==null?void 0:i.char)||"",{size:16}),e.pos(n,d),e.anchor("center"),e.color(...((a=t.weaponDef)==null?void 0:a.color)||[100,200,255]),e.area(),"orbital","playerProjectile"]);u.damage=t.projectileDamage||12,u.contactCooldown=0,u.contactCooldownDuration=Ko.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(u),t.orbitalAngles.push(c)}}function o0(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(a=>{a.exists()&&a.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],en(e,t),t.orbitalNeedsReinit=!1);const o=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==o)&&en(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const s=t.rotationSpeed||Ko.BASE_ROTATION_SPEED,i=t.orbitRadius||Ko.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((a,l)=>{if(!a.exists())return;t.orbitalAngles[l]=(t.orbitalAngles[l]+s*e.dt())%360;const c=t.orbitalAngles[l]*Math.PI/180;a.pos.x=t.pos.x+Math.cos(c)*i,a.pos.y=t.pos.y+Math.sin(c)*i,a.contactCooldown>0&&(a.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(a=>a.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function s0(e,t,o,s,i,a,l,c,r){const n=Vt(e,t,o,s,i,a,0,0,!1,r);return n.isExplosive=!0,n.explosionRadius=l||50,n.explosionDamage=c||15,n}function i0(e,t,o,s,i,a,l,c,r,n){const d=Vt(e,t,o,s,i,a,0,0,!1,n);return d.isChainLightning=!0,d.chainRange=l||70,d.maxJumps=c||3,d.chainDamageReduction=r||.15,d.chainJumps=0,d.chainedEnemies=new Set,d}function Ri(e,t,o,s){if(!t.exists())return;tl();const i=t.explosionRadius||50,a=t.explosionDamage||15,l=e.get("enemy"),c=e.get("boss"),r=[...l,...c];for(const d of r){if(!d.exists())continue;e.vec2(d.pos.x-o,d.pos.y-s).len()<=i&&(d.takeDamage?d.takeDamage(a):d.hurt(a))}const n=e.add([e.text("*",{size:24}),e.pos(o,s),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{n.exists()&&e.destroy(n)}),e.destroy(t)}function ga(e,t,o){if(!t.exists())return;const s=t.chainRange||70,i=e.get("enemy"),a=e.get("boss"),l=[...i,...a];let c=null,r=s;for(const n of l){if(!n.exists()||n===o||t.chainedEnemies&&t.chainedEnemies.has(n))continue;const d=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y).len();d<=s&&d<r&&(c=n,r=d)}if(c){t.chainJumps=(t.chainJumps||0)+1;const n=e.add([e.line(o.pos,c.pos,2),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{n.exists()&&e.destroy(n)}),t.pos.x=c.pos.x,t.pos.y=c.pos.y}else e.destroy(t)}const Be={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10},Vo={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${Be.damage})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.damage)||0,o=e.baseProjectileDamage||((a=e.weaponDef)==null?void 0:a.baseDamage)||10,s=Math.pow(1.25,t);e.projectileDamage=Math.floor(o*s)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${Be.fireRate})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.fireRate)||0,o=e.baseFireRate||((a=e.weaponDef)==null?void 0:a.fireRate)||1.5,s=Math.pow(1.2,t);e.fireRate=o*s}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${Be.speed})`:""}`,apply:e=>{var i,a,l;const t=((i=e.upgradeStacks)==null?void 0:i.speed)||0,o=((l=(a=e.characterData)==null?void 0:a.stats)==null?void 0:l.speed)||150,s=Math.pow(1.15,t);e.speed=Math.floor(o*s),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${Be.health})`:""}`,apply:e=>{var l,c,r;const t=((l=e.upgradeStacks)==null?void 0:l.health)||0,o=((r=(c=e.characterData)==null?void 0:c.stats)==null?void 0:r.health)||100,s=t*20,i=e.maxHealth;e.maxHealth=o+s;const a=e.maxHealth-i;a>0&&e.setHP(e.hp()+a)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${Be.projectileSpeed})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.projectileSpeed)||0,o=e.baseProjectileSpeed||((a=e.weaponDef)==null?void 0:a.projectileSpeed)||300,s=Math.pow(1.25,t);e.projectileSpeed=Math.floor(o*s)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${Be.xpGain})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.xpGain)||0,o=((i=e.characterData)==null?void 0:i.ability)==="xpBoost"?1.1:1;e.xpMultiplier=o+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${Be.pickupRadius})`:""}`,apply:e=>{var i;const t=((i=e.upgradeStacks)==null?void 0:i.pickupRadius)||0,o=30,s=Math.pow(1.5,t);e.pickupRadius=Math.floor(o*s)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${Be.multiShot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.multiShot)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||1;e.projectileCount=o+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${Be.piercing})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.piercing)||0,o=((i=e.weaponDef)==null?void 0:i.piercing)||0;e.piercing=o+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${Be.obstaclePiercing})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.obstaclePiercing)||0,o=((i=e.weaponDef)==null?void 0:i.obstaclePiercing)||0;e.obstaclePiercing=o+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${Be.critChance})`:""}`,apply:e=>{var i,a,l;const t=((i=e.upgradeStacks)==null?void 0:i.critChance)||0;let s=(((a=e.weaponDef)==null?void 0:a.critChance)||.05)+t*.1;((l=e.characterData)==null?void 0:l.ability)==="critBoost"&&(s*=1.5),e.critChance=s}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${Be.critDamage})`:""}`,apply:e=>{var i,a,l;const t=((i=e.upgradeStacks)==null?void 0:i.critDamage)||0;let s=(((a=e.weaponDef)==null?void 0:a.critDamage)||2)+t*.5;((l=e.characterData)==null?void 0:l.ability)==="critBoost"&&(s*=1.25),e.critDamage=s}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${Be.spreadShot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.spreadShot)||0,o=((i=e.weaponDef)==null?void 0:i.spreadAngle)||0;e.spreadAngle=o+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${Be.pelletCount})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.pelletCount)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||3;e.projectileCount=o+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${Be.range})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.range)||0,o=((a=e.weaponDef)==null?void 0:a.range)||600,s=Math.pow(1.25,t);e.weaponRange=Math.floor(o*s)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${Be.dot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.dot)||0,o=((i=e.characterData)==null?void 0:i.ability)==="fireDot"?1.25:1;e.fireDotMultiplier=o+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${Be.orbitalCount})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.orbitalCount)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||1;e.projectileCount=o+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${Be.orbitalSpeed})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.orbitalSpeed)||0,o=((a=e.weaponDef)==null?void 0:a.rotationSpeed)||180,s=Math.pow(1.5,t);e.rotationSpeed=o*s}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${Be.orbitalRadius})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.orbitalRadius)||0,o=((a=e.weaponDef)==null?void 0:a.orbitRadius)||45,s=Math.pow(1.2,t);e.orbitRadius=Math.floor(o*s)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${Be.explosionRadius})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.explosionRadius)||0,o=((a=e.weaponDef)==null?void 0:a.explosionRadius)||50,s=Math.pow(1.25,t);e.explosionRadius=Math.floor(o*s)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${Be.explosionDamage})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.explosionDamage)||0,o=((a=e.weaponDef)==null?void 0:a.explosionDamage)||15,s=Math.pow(1.25,t);e.explosionDamage=Math.floor(o*s)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${Be.chainJumps})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.chainJumps)||0,o=((i=e.weaponDef)==null?void 0:i.maxJumps)||3;e.maxJumps=o+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${Be.chainRange})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.chainRange)||0,o=((a=e.weaponDef)==null?void 0:a.chainRange)||70,s=Math.pow(1.25,t);e.chainRange=Math.floor(o*s)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${Be.chainDamage})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.chainDamage)||0,o=((i=e.weaponDef)==null?void 0:i.chainDamageReduction)||.15;e.chainDamageReduction=Math.max(.05,o-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${Be.defense})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.defense)||0,o=((i=e.characterData)==null?void 0:i.ability)==="tankStats"?.15:0;e.defense=o+t*2}}};function n0(e,t){var o,s,i;if(e.category==="passive"){const a=((o=t.upgradeStacks)==null?void 0:o[e.key])||0,l=e.maxStacks||Be[e.key]||10;return!(a>=l)}if(e.category==="weapon"){const a=((s=t.upgradeStacks)==null?void 0:s[e.key])||0,l=e.maxStacks||Be[e.key]||10;if(a>=l)return!1;const c=((i=t.characterData)==null?void 0:i.weapon)||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(c):e.upgradeCategory?ju(c,e.upgradeCategory):!0}return!0}function a0(e=3,t=null){let s=Object.keys(Vo).map(c=>({key:c,...Vo[c],type:"upgrade"})),i=s;t&&(i=s.filter(c=>n0(c,t))),i.length<e&&(i=s);const a=[],l=new Set;for(;a.length<e&&a.length<i.length;){const c=Math.floor(Math.random()*i.length),r=i[c];l.has(r.key)||(l.add(r.key),a.push(r))}return a}function r0(e,t){const o=Vo[t];o&&(o.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,l0(e))}function l0(e){Object.keys(Vo).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&Vo[t].apply(e)})}function c0(e,t){var o;if(!e)return"";if(e.getDescription){const s=((o=t==null?void 0:t.upgradeStacks)==null?void 0:o[e.key])||0;return e.getDescription(s)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const h0={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}}};function d0(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function ol(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const o=[];for(const[s,i]of Object.entries(h0))i.required.every(l=>t.selectedUpgrades.has(l))&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(s)||(i.apply(t),t.activeSynergies.add(s),o.push(i),u0(e,i)));return o}function u0(e,t){const o=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),s=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{o.exists()&&(e.destroy(o),e.destroy(s))})}const W={TITLE:36,HEADER:24,LABEL:18,BODY:16,SMALL:14,BUTTON:20,HUD:16},O={SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],GOLD:[200,150,50],NEUTRAL:[100,100,120],DANGER:[180,50,50],SUCCESS:[100,255,100],WARNING:[255,200,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100]},p0={BUTTON_VERTICAL:65},_o={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},Do={HEALTH:"HP",FLOOR:"Floor",ROOM:"Room",DAMAGE:"Damage",SPEED:"Speed"};function Ms(e){return e.toUpperCase()}function f0(e,t){return`${e}/${t}`}const B={BACKGROUND:0,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1e3};let Zt=!1;function g0(e,t,o){if(Zt)return;Zt=!0,e.paused=!0,e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()));const s=a0(3,t);console.log("Creating upgrade draft with",s.length,"upgrades"),e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...O.BG_DARK),e.opacity(.9),e.fixed(),e.z(B.MODAL),"upgradeOverlay"]),e.add([e.text("Level Up! Choose an Upgrade",{size:W.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...O.WARNING),e.fixed(),e.z(B.MODAL+1),"upgradeUI"]),console.log("Title created at",e.width()/2,80);const i=200,a=150,l=250,c=e.width()/2-l*(s.length-1)/2,r=e.height()/2;s.forEach((y,f)=>{const A=c+f*l,g=e.add([e.rect(i,a),e.pos(A,r),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.BORDER)),e.fixed(),e.z(B.MODAL+1),e.area(),"upgradeUI","upgradeCard"]);if(y.icon){const E=y.category==="passive"?O.SUCCESS:y.weaponKey?O.WARNING:O.INFO;e.add([e.text(y.icon,{size:48}),e.pos(A,r-50),e.anchor("center"),e.color(...E),e.fixed(),e.z(B.MODAL+2),"upgradeUI"])}e.add([e.text(y.name,{size:W.BUTTON,width:i-20}),e.pos(A,r-5),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.MODAL+2),"upgradeUI"]);const w=c0(y,t);e.add([e.text(w,{size:W.BODY,width:i-20}),e.pos(A,r+30),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.MODAL+2),"upgradeUI"]),e.add([e.text(`${f+1}`,{size:W.HEADER}),e.pos(A+i/2-20,r-a/2+15),e.anchor("center"),e.color(...O.WARNING),e.fixed(),e.z(B.MODAL+2),"upgradeUI"]),g.onClick(()=>{Zt&&n(f)})});function n(y){if(!Zt)return;const f=s[y];$p(),Zt=!1,r0(t,f.key),d0(t,f.key),ol(e,t),e.get("upgradeUI").forEach(A=>e.destroy(A)),e.get("upgradeOverlay").forEach(A=>e.destroy(A)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.paused=!1,e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{o&&o(f)})}const d=()=>{Zt&&s.length>=1&&n(0)},u=()=>{Zt&&s.length>=2&&n(1)},h=()=>{Zt&&s.length>=3&&n(2)};e.onKeyPress("1",d),e.onKeyPress("2",u),e.onKeyPress("3",h)}function ma(){return Zt}function m0(e,t){let o=!1;t.addXP=function(i){if(e.paused||o)return;const a=t.xpMultiplier||1,l=Math.floor(i*a);for(t.xp+=l;t.xp>=t.xpToNext&&!o;){o=!0,t.xp-=t.xpToNext,t.level++;const c=t.level;t.xpToNext=Math.floor(t.xpToNext*to.XP_SCALING_FACTOR),s(e,t,c)}};function s(i,a,l){if(i.paused){o=!1;return}jp();const c=i.add([i.text(`Level ${l}!`,{size:24}),i.pos(i.width()/2,to.LEVEL_UP_NOTIFICATION_Y),i.anchor("center"),i.color(255,255,100),i.fixed()]);i.wait(to.LEVEL_UP_NOTIFICATION_DURATION,()=>{i.destroy(c),g0(i,a,()=>{o=!1})})}}const x0={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:20,turret:15,heavyTank:20,zippy:20,exploder:25},3:{mage:20,shieldBearer:15,golem:15,wraith:15,spawner:15,buffer:20,orbiter:10},4:{healer:25,teleporter:20,freezer:25,leech:30}};function y0(){return{basic:15,rusher:25,tank:30,fast:30}}function w0(e){const t=Object.values(e).reduce((s,i)=>s+i,0);let o=Math.random()*t;for(const[s,i]of Object.entries(e))if(o-=i,o<=0)return s;return Object.keys(e)[0]}function tn(e=1){const t=x0[e]||y0();return w0(t)}const b0=800,A0=600,Hs=20;let Ys=null;const xa={empty:{name:"Empty Room",obstacles:[],spawnDoors:null},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],spawnDoors:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],spawnDoors:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],spawnDoors:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],spawnDoors:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],spawnDoors:null}};function v0(e,t,o,s){const i=o/2,a=s/2,l=Hs+i,c=b0-Hs-i,r=Hs+a,n=A0-Hs-a,d=Math.max(l,Math.min(c,e)),u=Math.max(r,Math.min(n,t));return{x:d,y:u}}function E0(e,t){const o=Math.max(150-t*5,100);return{wallColor:e.rgb(Math.floor(o*.6),Math.floor(o*.4),Math.floor(o*.5)),obstacleColor:e.rgb(Math.floor(o*.7),Math.floor(o*.5),Math.floor(o*.6)),coverColor:e.rgb(Math.floor(o*.8),Math.floor(o*.6),Math.floor(o*.7))}}function sl(e){const t=Object.keys(xa),o=Ys?t.filter(a=>a!==Ys):t,s=o.length>0?o:t,i=s[Math.floor(Math.random()*s.length)];return Ys=i,{key:i,...xa[i]}}function M0(){Ys=null}const ui={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1},floor10:{id:"floor10",name:"Floor 10 Reached",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies",category:"combat",icon:"",unlocked:!1},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies",category:"combat",icon:"",unlocked:!1},kill1000:{id:"kill1000",name:"Genocide",description:"Kill 1000 enemies",category:"combat",icon:"",unlocked:!1},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses",category:"boss",icon:"",unlocked:!1},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1},earn100:{id:"earn100",name:"Rich",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1},earn500:{id:"earn500",name:"Wealthy",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1},earn1000:{id:"earn1000",name:"Millionaire",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1}};function os(e){return Object.values(ui).filter(t=>t.category===e)}function Ns(){const e=new Set;return Object.values(ui).forEach(t=>e.add(t.category)),Array.from(e)}function S0(e){const t=Ur(),o=[];return t.bestFloor>=2&&!ot("floor2")&&st("floor2")&&o.push("floor2"),t.bestFloor>=3&&!ot("floor3")&&st("floor3")&&o.push("floor3"),t.bestFloor>=5&&!ot("floor5")&&st("floor5")&&o.push("floor5"),t.bestFloor>=10&&!ot("floor10")&&st("floor10")&&o.push("floor10"),t.totalEnemiesKilled>=1&&!ot("firstKill")&&st("firstKill")&&o.push("firstKill"),t.totalEnemiesKilled>=100&&!ot("kill100")&&st("kill100")&&o.push("kill100"),t.totalEnemiesKilled>=500&&!ot("kill500")&&st("kill500")&&o.push("kill500"),t.totalEnemiesKilled>=1e3&&!ot("kill1000")&&st("kill1000")&&o.push("kill1000"),t.totalBossesKilled>=1&&!ot("firstBoss")&&st("firstBoss")&&o.push("firstBoss"),t.totalBossesKilled>=5&&!ot("boss5")&&st("boss5")&&o.push("boss5"),t.totalRuns>=1&&!ot("firstRun")&&st("firstRun")&&o.push("firstRun"),t.totalRuns>=10&&!ot("run10")&&st("run10")&&o.push("run10"),t.totalRuns>=50&&!ot("run50")&&st("run50")&&o.push("run50"),t.bestLevel>=10&&!ot("level10")&&st("level10")&&o.push("level10"),t.bestLevel>=20&&!ot("level20")&&st("level20")&&o.push("level20"),t.totalCurrencyEarned>=100&&!ot("earn100")&&st("earn100")&&o.push("earn100"),t.totalCurrencyEarned>=500&&!ot("earn500")&&st("earn500")&&o.push("earn500"),t.totalCurrencyEarned>=1e3&&!ot("earn1000")&&st("earn1000")&&o.push("earn1000"),o.length>0&&e&&o.forEach((s,i)=>{const a=ui[s];a&&e.wait(i*.5,()=>{R0(e,a)})}),o}function R0(e,t){Qp();const o=e.add([e.text("Achievement Unlocked!",{size:20}),e.pos(e.width()/2,e.height()/2-40),e.anchor("center"),e.color(255,255,100),e.fixed(),e.z(3e3)]),s=e.add([e.text(`${t.icon} ${t.name}`,{size:24}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(3e3)]),i=e.add([e.text(t.description,{size:16}),e.pos(e.width()/2,e.height()/2+30),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(3e3)]);e.wait(3,()=>{o.exists()&&e.destroy(o),s.exists()&&e.destroy(s),i.exists()&&e.destroy(i)})}class Us{constructor(t,o,s="combat"){this.position={x:t,y:o},this.type=s,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=s==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:o,y:s}=this.position;switch(t){case"up":return{x:o,y:s-1};case"down":return{x:o,y:s+1};case"right":return{x:o+1,y:s};default:return null}}}class D0{constructor(t,o=6,s=3){this.floor=t,this.width=o,this.height=s,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.generate()}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const o=this.height===1?0:Math.floor(Math.random()*this.height);this.bossPosition={x:this.width-1,y:o};const s=new Us(0,t,"start");this.setRoom(0,t,s);const i=new Us(this.width-1,o,"boss");this.setRoom(this.width-1,o,i),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const o of t)if(!this.getRoom(o.x,o.y)){const s=new Us(o.x,o.y,"combat");this.setRoom(o.x,o.y,s)}}findPath(t,o){const s=[];let i={...t};for(;i.x<o.x||i.y!==o.y;)s.push({...i}),i.x<o.x?i.y!==o.y&&Math.random()<.3?i.y+=i.y<o.y?1:-1:i.x+=1:i.y+=i.y<o.y?1:-1;return s.push({...o}),s}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let o=0;for(let s=1;s<this.width-1;s++)for(let i=0;i<this.height&&!(o>=t);i++){if(this.getRoom(s,i))continue;if(s>0&&this.getRoom(s-1,i)&&Math.random()<.5){const l=new Us(s,i,"combat");this.setRoom(s,i,l),o++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const s=this.getRoom(t,o);s&&(t<this.width-1&&this.getRoom(t+1,o)&&(s.connections.right=!0),o>0&&this.getRoom(t,o-1)&&(s.connections.up=!0),o<this.height-1&&this.getRoom(t,o+1)&&(s.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const s=this.getRoom(t,o);if(s&&(s.type!=="boss"&&(s.template=sl(this.floor)),s.type==="combat")){const i=3+Math.floor(Math.random()*3);s.enemyTypes=[];for(let a=0;a<i;a++)s.enemyTypes.push(tn(this.floor))}}}validate(){const t=new Set,o=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);o.length>0;){const s=o.shift(),i=this.getRoom(s.x,s.y);if(!i)continue;if(i.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const a=["up","down","right"];for(const l of a)if(i.connections[l]){const c=i.getAdjacentPosition(l),r=`${c.x},${c.y}`;t.has(r)||(t.add(r),o.push(c))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,o){return t<0||t>=this.width||o<0||o>=this.height?null:this.grid[o][t]}setRoom(t,o,s){t<0||t>=this.width||o<0||o>=this.height||(this.grid[o][t]=s,this.rooms.set(s.getKey(),s))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const o=[],s=["up","down","right"];for(const i of s)if(t.connections[i]){const a=t.getAdjacentPosition(i),l=this.getRoom(a.x,a.y);l&&!l.visited&&o.push({direction:i,position:a,room:l})}return o}markRoomVisited(t,o){const s=this.getRoom(t,o);s&&(s.visited=!0,this.visitedRooms.add(s.getKey()))}markRoomCleared(t,o){const s=this.getRoom(t,o);s&&(s.cleared=!0)}moveToRoom(t){const o=this.getCurrentRoom();if(!o||!o.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const s=o.getAdjacentPosition(t);return this.getRoom(s.x,s.y)?(this.currentPosition=s,this.markRoomVisited(s.x,s.y),console.log(`[FloorMap] Moved to room (${s.x}, ${s.y})`),!0):(console.warn(`[FloorMap] No room found at ${s.x}, ${s.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let o=0;o<this.height;o++){const s=[];for(let i=0;i<this.width;i++){const a=this.getRoom(i,o);a?i===this.currentPosition.x&&o===this.currentPosition.y?s.push({type:"current",room:a}):a.visited?s.push({type:"visited",room:a}):this.isRoomRevealed(i,o)?s.push({type:"revealed",room:a}):s.push({type:"hidden"}):s.push({type:"empty"})}t.push(s)}return t}isRoomRevealed(t,o){if(!this.getRoom(t,o))return!1;const i=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:a,dy:l}of i){const c=this.getRoom(t+a,o+l);if(c&&c.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let o="";for(let s=0;s<this.width;s++){const i=this.getRoom(s,t);i?i.type==="start"?o+="[S]":i.type==="boss"?o+="[B]":s===this.currentPosition.x&&t===this.currentPosition.y?o+="[]":i.visited?o+="[]":o+="[R]":o+="[ ]",o+=" "}console.log(o)}console.log(`
Connections:`);for(const[t,o]of this.rooms){const s=[];o.connections.up&&s.push(""),o.connections.down&&s.push(""),o.connections.right&&s.push(""),console.log(`  (${o.position.x}, ${o.position.y}): ${s.join(", ")||"none"}`)}}}function T0(e){const t=Math.min(5+Math.floor(e/3),8),o=Math.min(3+Math.floor(e/5),5),s=new D0(e,t,o);return s.debugPrint(),s}const lo={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"};class C0{constructor(t,o){this.k=t,this.floorMap=o,this.mode=lo.MINIMIZED,this.elements=[],this.buttonPos={x:t.width()-50,y:70},this.openPos={x:t.width()-120,y:70},this.maximizedPos={x:t.width()-250,y:70},this.render()}toggle(){try{xt()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===lo.MINIMIZED?this.mode=lo.OPEN:this.mode===lo.OPEN?this.mode=lo.MAXIMIZED:this.mode=lo.MINIMIZED,this.k.wait(0,()=>{this.update()})}update(){this.clear(),this.render()}clear(){this.elements.forEach(t=>{t.exists()&&this.k.destroy(t)}),this.elements=[]}render(){this.mode===lo.MINIMIZED?this.renderMinimized():this.mode===lo.OPEN?this.renderOpen():this.renderMaximized()}renderMinimized(){const{x:t,y:o}=this.buttonPos,s=40,i=this.k.add([this.k.rect(s,s),this.k.pos(t,o),this.k.anchor("center"),this.k.color(30,30,50),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);i.onClick(()=>this.toggle()),this.elements.push(i);const a=this.k.add([this.k.text("",{size:24}),this.k.pos(t,o),this.k.anchor("center"),this.k.color(150,180,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(a);const l=this.k.add([this.k.text(`${this.floorMap.floor}`,{size:10}),this.k.pos(t+12,o-12),this.k.anchor("center"),this.k.color(255,255,100),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(l)}renderOpen(){const{x:t,y:o}=this.openPos,s=12,i=this.floorMap.getGridForMinimap(),a=this.k.add([this.k.rect(140,80),this.k.pos(t-10,o-10),this.k.anchor("topleft"),this.k.color(20,20,30),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);a.onClick(()=>this.toggle()),this.elements.push(a);const l=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t+60,o),this.k.anchor("center"),this.k.color(200,200,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(l);const c=o+15;for(let d=0;d<i.length;d++)for(let u=0;u<i[d].length;u++){const h=i[d][u],y=t+u*s,f=c+d*s;let A="",g=[100,100,100];switch(h.type){case"current":A="",g=[255,255,100];break;case"visited":A=h.room.isBossRoom?"B":"",g=h.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":A=h.room.isBossRoom?"B":"",g=h.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":A="",g=[60,60,80];break;case"empty":A=" ";break}if(A!==" "){const w=this.k.add([this.k.text(A,{size:10}),this.k.pos(y,f),this.k.anchor("topleft"),this.k.color(...g),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(w)}}const r=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:9}),this.k.pos(t+60,o+65),this.k.anchor("center"),this.k.color(180,180,180),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(r);const n=this.k.add([this.k.text("(click to expand)",{size:8}),this.k.pos(t+60,o+75),this.k.anchor("center"),this.k.color(120,120,140),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(n)}renderMaximized(){const{x:t,y:o}=this.maximizedPos,s=18,i=this.floorMap.getGridForMinimap(),a=Math.max(220,i[0].length*s+40),l=Math.max(180,i.length*s+100),c=this.k.add([this.k.rect(a,l),this.k.pos(t,o),this.k.anchor("topleft"),this.k.color(15,15,25),this.k.outline(3,this.k.rgb(100,150,255)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);c.onClick(()=>this.toggle()),this.elements.push(c);const r=this.k.add([this.k.rect(a,30),this.k.pos(t,o),this.k.anchor("topleft"),this.k.color(30,30,50),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(r);const n=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor} - ROOM ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:12}),this.k.pos(t+a/2,o+15),this.k.anchor("center"),this.k.color(200,220,255),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(n);const d=t+20,u=o+50;for(let A=0;A<i.length;A++)for(let g=0;g<i[A].length;g++){const w=i[A][g],E=d+g*s,T=u+A*s;let z=[30,30,40],q=[50,50,60];if(w.type!=="empty"){const b=this.k.add([this.k.rect(s-2,s-2),this.k.pos(E,T),this.k.anchor("topleft"),this.k.color(...z),this.k.outline(1,this.k.rgb(...q)),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(b)}let p="",m=[100,100,100];switch(w.type){case"current":p="",m=[255,255,100];break;case"visited":p=w.room.isBossRoom?"B":"",m=w.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":p=w.room.isBossRoom?"B":"",m=w.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":p="",m=[80,80,100];break}if(p){const b=this.k.add([this.k.text(p,{size:14}),this.k.pos(E+s/2,T+s/2),this.k.anchor("center"),this.k.color(...m),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(b)}}const h=u+i.length*s+20;[{char:"",label:"Current Room",color:[255,255,100]},{char:"",label:"Cleared Room",color:[100,255,100]},{char:"",label:"Available Room",color:[150,150,150]},{char:"B",label:"Boss Room",color:[255,100,100]}].forEach((A,g)=>{const w=t+20,E=h+g*15,T=this.k.add([this.k.text(A.char,{size:10}),this.k.pos(w,E),this.k.anchor("topleft"),this.k.color(...A.color),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(T);const z=this.k.add([this.k.text(A.label,{size:9}),this.k.pos(w+20,E),this.k.anchor("topleft"),this.k.color(180,180,200),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(z)});const f=this.k.add([this.k.text("(click to minimize)",{size:9}),this.k.pos(t+a/2,o+l-10),this.k.anchor("center"),this.k.color(120,120,140),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(f)}destroy(){this.clear()}}function I0(e,t){return new C0(e,t)}const ya={city:{name:"Urban Streets",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.15},{char:"",pattern:"vertical_lines",density:"low",opacity:.12},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"random",count:8,opacity:.1},{char:"",pattern:"random",count:8,opacity:.1}],baseColor:[60,60,70]},mechanical:{name:"Industrial Complex",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.12},{char:"",pattern:"grid",spacing:80,opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.18},{char:"",pattern:"scattered",count:3,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"edges",count:12,opacity:.14}],baseColor:[70,65,60]},futuristic:{name:"Cyber Station",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.13},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.13},{char:"",pattern:"grid",spacing:100,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.15},{char:"",pattern:"corners",opacity:.18},{char:"",pattern:"scattered",count:6,opacity:.14}],baseColor:[55,65,80]},alien:{name:"Alien Vessel",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.12},{char:"~",pattern:"random",count:15,opacity:.1},{char:"",pattern:"scattered",count:4,opacity:.16},{char:"",pattern:"grid",spacing:120,opacity:.13},{char:"",pattern:"corners",opacity:.17},{char:"",pattern:"scattered",count:5,opacity:.14}],baseColor:[65,55,75]}};function P0(e){for(const[t,o]of Object.entries(ya))if(o.floors.includes(e))return{key:t,...o};return{key:"city",...ya.city}}function B0(e,t,o=800,s=600){const i=P0(t),a=[],l=30;return i.decorations.forEach(c=>{const r=i.baseColor,n=e.rgb(r[0]+(Math.random()-.5)*20,r[1]+(Math.random()-.5)*20,r[2]+(Math.random()-.5)*20);switch(c.pattern){case"horizontal_lines":{const d=c.density==="high"?40:c.density==="medium"?80:120;for(let u=l;u<s-l;u+=d)a.push({char:c.char,x:o/2,y:u+(Math.random()-.5)*20,color:n,opacity:c.opacity,size:12});break}case"vertical_lines":{const d=c.density==="high"?40:c.density==="medium"?80:120;for(let u=l;u<o-l;u+=d)a.push({char:c.char,x:u+(Math.random()-.5)*20,y:s/2,color:n,opacity:c.opacity,size:12});break}case"wavy_lines":{for(let u=l;u<s-l;u+=60)for(let h=l;h<o-l;h+=40)a.push({char:c.char,x:h+Math.sin(u*.05)*15,y:u,color:n,opacity:c.opacity,size:10});break}case"grid":{const d=c.spacing||80;for(let u=l;u<s-l;u+=d)for(let h=l;h<o-l;h+=d)a.push({char:c.char,x:h+(Math.random()-.5)*10,y:u+(Math.random()-.5)*10,color:n,opacity:c.opacity,size:14});break}case"scattered":{const d=c.count||5;for(let u=0;u<d;u++)a.push({char:c.char,x:l+Math.random()*(o-l*2),y:l+Math.random()*(s-l*2),color:n,opacity:c.opacity,size:16});break}case"random":{const d=c.count||10;for(let u=0;u<d;u++)a.push({char:c.char,x:l+Math.random()*(o-l*2),y:l+Math.random()*(s-l*2),color:n,opacity:c.opacity,size:10+Math.random()*6});break}case"corners":{[{x:l+40,y:l+40},{x:o-l-40,y:l+40},{x:l+40,y:s-l-40},{x:o-l-40,y:s-l-40}].forEach(u=>{a.push({char:c.char,x:u.x,y:u.y,color:n,opacity:c.opacity,size:18})});break}case"edges":{const d=c.count||8,u=Math.floor(d/4);for(let h=0;h<u;h++)a.push({char:c.char,x:o/u*h+o/(u*2),y:l+20,color:n,opacity:c.opacity,size:12});for(let h=0;h<u;h++)a.push({char:c.char,x:o/u*h+o/(u*2),y:s-l-20,color:n,opacity:c.opacity,size:12});for(let h=0;h<u;h++)a.push({char:c.char,x:l+20,y:s/u*h+s/(u*2),color:n,opacity:c.opacity,size:12});for(let h=0;h<u;h++)a.push({char:c.char,x:o-l-20,y:s/u*h+s/(u*2),color:n,opacity:c.opacity,size:12});break}}}),a}function O0(e,t,o=800,s=600){B0(e,t,o,s).forEach(a=>{e.add([e.text(a.char,{size:a.size}),e.pos(a.x,a.y),e.color(a.color),e.opacity(a.opacity),e.z(0),"floorDecoration"])})}class ei{constructor(t,o){this.playerId=t,this.characterKey=o,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=to.STARTING_LEVEL,this.xp=to.STARTING_XP,this.xpToNext=to.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,health:this.health,maxHealth:this.maxHealth,level:this.level,xp:this.xp,xpToNext:this.xpToNext,weaponKey:this.weaponKey,isDead:this.isDead}}static fromJSON(t){const o=new ei(t.playerId,t.characterKey);return Object.assign(o,t),o}}class ti{constructor(t,o,s,i,a={}){this.id=t,this.type=o,this.x=s,this.y=i,this.data=a,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new ti(t.id,t.type,t.x,t.y,t.data)}}class oi{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,o){const s=new ei(t,o);return this.players.set(t,s),this.localPlayerId===null&&(this.localPlayerId=t),s}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,o,s,i={}){const a=this.generateEntityId(),l=new ti(a,t,o,s,i);return this.entities.set(a,l),l}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(o=>o.type===t&&!o.removed)}removeEntity(t){const o=this.entities.get(t);o&&(o.removed=!0)}cleanupRemovedEntities(){for(const[t,o]of this.entities.entries())o.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,o])=>[t,o.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,o])=>[t,o.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const o=new oi;return o.sessionId=t.sessionId,o.gameMode=t.gameMode,o.isPaused=t.isPaused,o.currentFloor=t.currentFloor,o.currentRoom=t.currentRoom,o.roomCleared=t.roomCleared,o.gameTime=t.gameTime,o.localPlayerId=t.localPlayerId,o.nextEntityId=t.nextEntityId,o.players=new Map(t.players.map(([s,i])=>[s,ei.fromJSON(i)])),o.entities=new Map(t.entities.map(([s,i])=>[s,ti.fromJSON(i)])),o.doors=t.doors,o.obstacles=t.obstacles,o}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class L0{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new oi,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=oi.fromJSON(t),this.gameState}clear(){this.gameState=null}}const wa=new L0;class Sn{constructor(t,o,s){this.playerId=t,this.frameNumber=o,this.timestamp=s,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const o=new Sn(t.playerId,t.frameNumber,t.timestamp);return Object.assign(o,t),o}}class z0{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(s=>{t.onKeyPress(s,()=>{this.keysPressed.add(s)}),t.onKeyRelease(s,()=>{this.keysPressed.delete(s)})}),t.onKeyPress("escape",()=>{this.onPausePressed()}),t.onKeyPress("space",()=>{this.onInteractPressed()}),t.onKeyPress("e",()=>{this.onInteractPressed()})}setupMouseListeners(){const t=this.k;t.onMouseMove(o=>{this.mouseX=o.x,this.mouseY=o.y}),t.onMousePress(()=>{this.mousePressed=!0}),t.onMouseRelease(()=>{this.mousePressed=!1})}collectLocalInput(t){const o=new Sn(t,this.frameNumber,Date.now());return o.moveX=this.getMoveX(),o.moveY=this.getMoveY(),o.aimX=this.mouseX,o.aimY=this.mouseY,o.firing=!0,o}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const o=new Map;for(const s of t){const i=this.inputQueues.get(s);let a;i&&i.length>0?a=i.shift():a=this.collectLocalInput(s),o.set(s,a)}return this.currentInputs=o,this.inputHistory.push(new Map(o)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,o}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class H0{constructor(){this.inputManager=null}init(t){return this.inputManager=new z0,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const ba=new H0,Aa={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class si{constructor(t,o,s=null){this.type=t,this.data=o,this.senderId=s,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const o=new si(t.type,t.data,t.senderId);return o.timestamp=t.timestamp,o}}class N0{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,o){const s=new si(t,o,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",s),this.messageQueue.push(s))}broadcast(t,o){this.send(t,o)}sendTo(t,o,s){const i=new si(o,s,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,i)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const o of t)this.handleMessage(o);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Aa.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Aa.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,o){this.players.set(t,{id:t,...o,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:o})}removePlayer(t){const o=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:o})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,o){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(o)}off(t,o){if(this.eventHandlers.has(t)){const s=this.eventHandlers.get(t),i=s.indexOf(o);i>-1&&s.splice(i,1)}}emit(t,o,s=null){if(this.eventHandlers.has(t)){const i=this.eventHandlers.get(t);for(const a of i)a(o,s)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class U0{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new N0,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const q0=new U0;let ce={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null},It={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0};function va(e,t){const o=kt("startingHealth");o>0&&(t.maxHealth+=o*10,t.setHP(t.maxHealth));const s=kt("startingDamage");s>0&&(t.projectileDamage+=s);const i=kt("startingSpeed");i>0&&(t.speed+=i*10)}function F0(e){e.scene("game",t=>{if(t!=null&&t.resetState){const M=q0.init("local");ba.init(e);const te=wa.init("singleplayer");te.addPlayer(M,"survivor"),console.log("[Game] New architecture initialized:",{playerId:M,sessionId:te.sessionId,gameMode:te.gameMode})}const o=wa.getState();t!=null&&t.resetState&&(ce.currentFloor=1,ce.currentRoom=1,ce.playerStats=null,ce.entryDirection=null,ce.floorMap=null,M0(),It={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0});let s=ce.currentFloor,i=ce.currentRoom;!ce.floorMap||ce.floorMap.floor!==s?(console.log(`[Game] Generating new floor map for floor ${s}`),ce.floorMap=T0(s),ce.minimap&&ce.minimap.destroy(),ce.minimap=I0(e,ce.floorMap),e.gameData&&(e.gameData.minimap=ce.minimap)):ce.minimap&&ce.minimap.update(),s>It.floorsReached&&(It.floorsReached=s);const a=30;let l=e.width()/2,c=e.height()/2;if(ce.entryDirection)switch(ce.entryDirection){case"north":l=e.width()/2,c=a;break;case"south":l=e.width()/2,c=e.height()-a;break;case"west":l=a,c=e.height()/2;break;case"east":l=e.width()-a,c=e.height()/2;break}let r;ce.playerStats?(r=Ei(e,l,c),Object.assign(r,ce.playerStats),r.setHP(ce.playerStats.currentHP||r.maxHealth),ce.playerStats.selectedUpgrades&&(r.selectedUpgrades=new Set(ce.playerStats.selectedUpgrades)),ce.playerStats.activeSynergies&&(r.activeSynergies=new Set(ce.playerStats.activeSynergies))):(r=Ei(e,l,c),va(e,r));const n=jr(),d=tp(),u=Zu();let h=[r];if(d>1&&u.isInitialized){console.log("[Multiplayer] Initializing multiplayer game with",d,"players");const M=n.slots.findIndex(te=>te.isLocal);cp(n.isHost,M,e),ea(M,r),n.slots.forEach((te,ee)=>{if(ee!==M&&te.playerId!==null){const pe=(ee-M)*30,xe=Ei(e,l+pe,c);xe.isRemote=!0,xe.playerName=te.playerName,va(e,xe),ea(ee,xe),h.push(xe);const J=e.add([e.text(te.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]);J.onUpdate(()=>{xe.exists()?J.pos=e.vec2(xe.pos.x,xe.pos.y-30):J.destroy()})}}),console.log("[Multiplayer] Spawned",h.length,"players")}const y=o.localPlayerId,f=o.getPlayer(y);f&&(f.x=r.pos.x,f.y=r.pos.y,f.health=r.hp(),f.maxHealth=r.maxHealth,f.speed=r.speed,f.level=r.level,f.xp=r.xp,f.xpToNext=r.xpToNext,f.xpMultiplier=r.xpMultiplier||1,f.weaponKey="pistol",f.fireRate=r.fireRate,f.projectileSpeed=r.projectileSpeed,f.projectileDamage=r.projectileDamage,f.projectileCount=r.projectileCount||1,f.piercing=r.piercing||0,f.obstaclePiercing=r.obstaclePiercing||0,f.critChance=r.critChance||.05,f.critDamage=r.critDamage||2,f.spreadAngle=r.spreadAngle||0,f.weaponRange=r.weaponRange||600,f.pickupRadius=r.pickupRadius,f.defense=r.defense||0,f.damageReduction=r.damageReduction||0,f.dodgeChance=r.dodgeChance||0,console.log("[Game] Player entity synced to PlayerState:",{playerId:y,position:{x:f.x,y:f.y},health:`${f.health}/${f.maxHealth}`,level:f.level})),t0(e,r),m0(e,r),ce.playerStats&&ce.playerStats.selectedUpgrades&&e.wait(.1,()=>{ol(e,r)});const A=ce.floorMap.getCurrentRoom(),g=A&&A.template?A.template:sl(),w=E0(e,s),E=20;O0(e,s,e.width(),e.height()),e.add([e.rect(e.width()-E*2,2),e.pos(e.width()/2,E),e.anchor("center"),e.color(w.wallColor),e.fixed()]),e.add([e.rect(e.width()-E*2,2),e.pos(e.width()/2,e.height()-E),e.anchor("center"),e.color(w.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-E*2),e.pos(E,e.height()/2),e.anchor("center"),e.color(w.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-E*2),e.pos(e.width()-E,e.height()/2),e.anchor("center"),e.color(w.wallColor),e.fixed()]);const T=i===1&&s===1,z=80;let q=e.width()/2,p=e.height()/2;if(ce.entryDirection)switch(ce.entryDirection){case"north":q=e.width()/2,p=a;break;case"south":q=e.width()/2,p=e.height()-a;break;case"west":q=a,p=e.height()/2;break;case"east":q=e.width()-a,p=e.height()/2;break}T||g.obstacles.forEach(M=>{const te=Math.sqrt(Math.pow(M.x-l,2)+Math.pow(M.y-c,2)),ee=Math.sqrt(Math.pow(M.x-q,2)+Math.pow(M.y-p,2)),pe=Math.max(M.width,M.height)/2;if(te<z+pe||ee<z+pe)return;const xe=v0(M.x,M.y,M.width,M.height),J=M.type==="wall"?w.obstacleColor:w.coverColor;Hp(e,xe.x,xe.y,M.width,M.height,M.type,M.char||"#",J)}),e.add([e.rect(100,40),e.pos(10,10),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(B.UI_BG-1)]);const m=e.add([e.text("",{size:W.HUD}),e.pos(20,20),e.color(...O.WARNING),e.fixed(),e.z(B.UI_TEXT)]),b=e.add([e.text("0/0",{size:W.HUD}),e.pos(40,20),e.color(...O.WARNING),e.fixed(),e.z(B.UI_TEXT)]);e.add([e.rect(120,40),e.pos(e.width()-10,10),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(B.UI_BG-1)]);const S=e.add([e.text("$",{size:W.LABEL}),e.pos(e.width()-20,20),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]),R=e.add([e.text("0",{size:W.HUD}),e.pos(e.width()-40,20),e.anchor("topright"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(950)]);if(eo()){const M=mp(),te=u.isHost?[100,255,100]:[100,200,255],ee=u.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...te),e.fixed(),e.z(B.UI_TEXT)]),e.add([e.text(`${ee} (${M}P)`,{size:W.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...te),e.fixed(),e.z(B.UI_TEXT)])}const P=e.width()-40,D=15,I=e.height()-30;e.add([e.rect(P,D),e.pos(20,I),e.color(...O.BG_DARK),e.outline(2,e.rgb(...O.TEXT_DISABLED)),e.fixed(),e.z(B.UI_BG)]);const C=e.add([e.rect(0,D-4),e.pos(50,I+2),e.color(100,255,100),e.fixed(),e.z(B.UI_BG+1)]),U=e.add([e.text("0/10",{size:W.SMALL-2}),e.pos(e.width()/2,I+D/2),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]),Y=28,G=20+Y/2,K=I+D/2;e.add([e.circle(Y/2),e.pos(G,K),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(100,255,100)),e.fixed(),e.z(B.UI_BG+2)]);const $=e.add([e.text("1",{size:W.SMALL}),e.pos(G,K),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(B.UI_TEXT)]),V=40,ue=8,Q=25,we=e.add([e.rect(V,ue),e.pos(0,0),e.anchor("center"),e.color(...O.BG_DARK),e.outline(1,e.rgb(...O.TEXT_DISABLED)),e.z(B.OVERLAY)]),oe=e.add([e.rect(V-2,ue-2),e.pos(0,0),e.anchor("left"),e.color(100,255,100),e.z(B.OVERLAY+1)]);we.hidden=!0,oe.hidden=!0;const me=48,Se=20,Te=e.height()-85,Ve=e.add([e.rect(me,me),e.pos(Se,Te),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(B.UI_BG)]),it=e.add([e.text("",{size:32}),e.pos(Se+me/2,Te+me/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]),je=220,k=90,se=e.add([e.rect(je,k),e.pos(Se,Te-k-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(B.OVERLAY+5)]),F=e.add([e.text("",{size:24}),e.pos(Se+15,Te-k-10+15),e.color(255,255,255),e.fixed(),e.z(B.OVERLAY+6)]),j=e.add([e.text("Basic Pistol",{size:W.SMALL}),e.pos(Se+50,Te-k-10+10),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+6)]),ie=e.add([e.text("DMG: 10",{size:W.SMALL-2}),e.pos(Se+50,Te-k-10+30),e.color(255,150,150),e.fixed(),e.z(B.OVERLAY+6)]),be=e.add([e.text("RATE: 3.75/s",{size:W.SMALL-2}),e.pos(Se+50,Te-k-10+47),e.color(150,200,255),e.fixed(),e.z(B.OVERLAY+6)]),Re=e.add([e.text("DPS: 37.5",{size:W.SMALL-2}),e.pos(Se+50,Te-k-10+64),e.color(255,255,150),e.fixed(),e.z(B.OVERLAY+6)]);se.hidden=!0,F.hidden=!0,j.hidden=!0,ie.hidden=!0,be.hidden=!0,Re.hidden=!0,Ve.onClick(()=>{se.hidden=!se.hidden,F.hidden=!F.hidden,j.hidden=!j.hidden,ie.hidden=!ie.hidden,be.hidden=!be.hidden,Re.hidden=!Re.hidden});const he=40,Ie=Se,Rt=Te-he-10,io=e.add([e.rect(he,he),e.pos(Ie,Rt),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(B.UI_BG)]),jt=e.add([e.text("",{size:28}),e.pos(Ie+he/2,Rt+he/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]),Wt=e.add([e.text("20",{size:14}),e.pos(Ie+he+5,Rt+he/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(B.UI_TEXT)]);io.hidden=!0,jt.hidden=!0,Wt.hidden=!0;const Jo=Se+me+10,no=Te,nt=32,Ft=40,ao=[];function dt(){if(ao.forEach(te=>{te.exists()&&e.destroy(te)}),ao.length=0,!r.exists())return;const M=[];r.upgradeStacks&&Object.entries(r.upgradeStacks).forEach(([te,ee])=>{ee>0&&M.push({key:te,stacks:ee})}),M.forEach((te,ee)=>{const pe=Jo+ee*Ft,xe=Vo[te.key];if(!xe)return;const J=e.add([e.rect(nt,nt),e.pos(pe,no),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(B.UI_BG)]),ae=e.add([e.text(xe.icon,{size:20}),e.pos(pe+nt/2,no+nt/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]),re=e.add([e.text(te.stacks.toString(),{size:10}),e.pos(pe+nt-4,no+nt-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(B.UI_TEXT+1)]);ao.push(J,ae,re)})}const We=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(B.OVERLAY+10)]),qe=e.add([e.text("",{size:W.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(B.OVERLAY+11)]);We.hidden=!0,qe.hidden=!0;const Uo={level:()=>`Level ${r.level}
XP: ${r.xp}/${r.xpToNext}
Progress: ${Math.floor(r.xp/r.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${It.enemiesKilled}`),currency:()=>`Total Credits: ${mo()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const M=r.weaponDef;return M?`${M.name}
Damage: ${r.projectileDamage}
Fire Rate: ${r.fireRate.toFixed(2)}/s
DPS: ${(r.projectileDamage*r.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(r.hp())}/${r.maxHealth}
Damage Reduction: ${Math.floor(r.damageReduction*100)}%`};function qo(M,te,ee){const pe=Uo[M];if(!pe)return;const xe=pe();qe.text=xe,We.pos.x=Math.min(te+10,e.width()-210),We.pos.y=Math.min(ee+10,e.height()-70),qe.pos.x=We.pos.x+5,qe.pos.y=We.pos.y+5,We.hidden=!1,qe.hidden=!1}function Ss(){We.hidden=!0,qe.hidden=!0}function Rs(){return{hidden:We.hidden,text:qe.text,tooltipX:We.pos.x,tooltipY:We.pos.y,textX:qe.pos.x,textY:qe.pos.y}}function pi(M){M&&(We.hidden=M.hidden,qe.hidden=M.hidden,qe.text=M.text,We.pos.x=M.tooltipX,We.pos.y=M.tooltipY,qe.pos.x=M.textX,qe.pos.y=M.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=Ss,e.gameData.saveTooltipState=Rs,e.gameData.restoreTooltipState=pi,e.gameData.minimap=ce.minimap,e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,e.onUpdate(()=>{if(e.paused||ma())return;const M=e.mousePos();let te=!1;M.x>=20&&M.x<=180&&M.y>=20&&M.y<=35?(qo("level",M.x,M.y),te=!0):M.x>=20&&M.x<=180&&M.y>=40&&M.y<=55&&!b.hidden?(qo("enemies",M.x,M.y),te=!0):M.x>=e.width()-130&&M.x<=e.width()-10&&M.y>=10&&M.y<=50?(qo("currency",M.x,M.y),te=!0):M.x>=Se&&M.x<=Se+me&&M.y>=Te&&M.y<=Te+me&&(qo("weapon",M.x,M.y),te=!0),te||Ss()});const Ht=e.add([e.text("",{size:W.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...O.BOSS_NAME),e.fixed(),e.z(B.OVERLAY)]),Ke=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...O.BG_DARK),e.outline(2,e.rgb(...O.TEXT_DISABLED)),e.fixed(),e.z(B.OVERLAY)]),ze=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...O.HEALTH_LOW),e.fixed(),e.z(B.OVERLAY+1)]),ut=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...O.BG_DARK),e.outline(2,e.rgb(...O.TEXT_DISABLED)),e.fixed(),e.z(B.OVERLAY)]),$e=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.OVERLAY+1)]),Dt=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]),pt=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]),Nt=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...O.BG_DARK),e.outline(2,e.rgb(...O.TEXT_DISABLED)),e.fixed(),e.z(B.OVERLAY)]),at=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...O.XP_BAR),e.fixed(),e.z(B.OVERLAY+1)]),v=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]);Ht.hidden=!0,Ke.hidden=!0,ze.hidden=!0,ut.hidden=!0,$e.hidden=!0,Dt.hidden=!0,pt.hidden=!0,Nt.hidden=!0,at.hidden=!0,v.hidden=!0,e.onUpdate(()=>{e.paused||e0(e)}),e.onUpdate(()=>{e.paused||eo()&&up(e.dt())}),e.onUpdate(()=>{const M=r.exists()?r.hp():0,te=r.maxHealth>0?M/r.maxHealth:1;$.text=`${r.level}`;const ee=r.xpToNext>0?r.xp/r.xpToNext:0;if(C.width=Math.max(0,(P-34)*ee),U.text=f0(r.xp,r.xpToNext),R.text=mo().toString(),te<1&&r.exists()){we.hidden=!1,oe.hidden=!1;const J=r.pos.x,ae=r.pos.y+Q;we.pos=e.vec2(J,ae);const re=J-V/2+1;oe.pos=e.vec2(re,ae),oe.width=Math.max(0,(V-2)*te),te>.6?oe.color=e.rgb(100,255,100):te>.3?oe.color=e.rgb(255,200,0):oe.color=e.rgb(255,50,50)}else we.hidden=!0,oe.hidden=!0;if(!_&&!H){const J=e.get("enemy").length,ae=Z+(ft?1:0),re=e.get("miniboss").length,ye=J+re+Math.max(0,ae-ge-(ft&&Ne?1:0));b.text=`${ye}/${ae}`,b.hidden=!1,m.hidden=!1}else b.hidden=!0,m.hidden=!0;if(r.exists()&&r.weaponDef){const J=r.weaponDef,ae=(r.projectileDamage*r.fireRate).toFixed(1);it.text=J.icon||"",it.color=e.rgb(...J.color),F.text=J.icon||"",F.color=e.rgb(...J.color),j.text=J.name,ie.text=`DMG: ${r.projectileDamage}`,be.text=`RATE: ${r.fireRate.toFixed(2)}/s`,Re.text=`DPS: ${ae}`,e.paused&&(se.hidden=!1,F.hidden=!1,j.hidden=!1,ie.hidden=!1,be.hidden=!1,Re.hidden=!1)}if(r.exists()){Bp(r,e.dt());const J=Lp(r);J?(io.hidden=!1,jt.hidden=!1,Wt.hidden=!1,jt.text=J.icon,jt.color=e.rgb(...J.color),io.outline.color=e.rgb(...J.color),J.isAmmoBased?Wt.text=`${J.ammo}`:J.isTimeBased&&(Wt.text=`${Math.ceil(J.duration)}s`)):(io.hidden=!0,jt.hidden=!0,Wt.hidden=!0)}e.time()%.5<e.dt()&&dt();const pe=e.get("boss"),xe=pe.filter(J=>J.type==="twinGuardianMelee"||J.type==="twinGuardianRanged");if(xe.length>0){const J=xe.find(re=>re.type==="twinGuardianMelee"),ae=xe.find(re=>re.type==="twinGuardianRanged");if(J&&ae&&(J.exists()||ae.exists())){Ht.hidden=!1,Ht.text="THE TWIN GUARDIANS";const re=J.exists()?J.hp():0,ye=ae.exists()?ae.hp():0,de=re+ye,Ae=(J.maxHealth||0)+(ae.maxHealth||0),ve=Ae>0?Math.max(0,Math.min(1,de/Ae)):0;ze.width=296*ve,ze.pos.x=e.width()/2-296*(1-ve)/2,Dt.text=`${Math.max(0,Math.floor(de))}/${Ae}`,Ke.hidden=!1,ze.hidden=!1,Dt.hidden=!1;const He=J.exists()&&J.shieldHealth||0,tt=ae.exists()&&ae.shieldHealth||0,Fe=He+tt,Qe=(J.maxShieldHealth||0)+(ae.maxShieldHealth||0);if(Qe>0){const Qo=Math.max(0,Math.min(1,Fe/Qe));at.width=296*Qo,at.pos.x=e.width()/2-296*(1-Qo)/2,v.text=`Shield: ${Math.max(0,Math.floor(Fe))}/${Qe}`,Nt.hidden=!1,at.hidden=!1,v.hidden=!1}else Nt.hidden=!0,at.hidden=!0,v.hidden=!0;const xi=J.exists()&&J.armorHealth||0,ml=ae.exists()&&ae.armorHealth||0,Bn=xi+ml,yi=(J.maxArmorHealth||0)+(ae.maxArmorHealth||0);if(yi>0){const Qo=Math.max(0,Math.min(1,Bn/yi));$e.width=296*Qo,$e.pos.x=e.width()/2-296*(1-Qo)/2,pt.text=`Armor: ${Math.max(0,Math.floor(Bn))}/${yi}`,ut.hidden=!1,$e.hidden=!1,pt.hidden=!1}else ut.hidden=!0,$e.hidden=!0,pt.hidden=!0;ve>.6?ze.color=e.rgb(255,50,50):ve>.3?ze.color=e.rgb(255,150,50):ze.color=e.rgb(255,200,0)}else{const re=J!=null&&J.exists()?J:ae;if(re){const ye=re.hp(),de=re.maxHealth,Ae=re.shieldHealth||0,ve=re.maxShieldHealth||0,He=re.armorHealth||0,tt=re.maxArmorHealth||0;Ht.hidden=!1,Ht.text=re.enraged?"THE TWIN GUARDIANS (ENRAGED)":"THE TWIN GUARDIANS";const Fe=Math.max(0,Math.min(1,ye/de));if(ze.width=296*Fe,ze.pos.x=e.width()/2-296*(1-Fe)/2,Dt.text=`${Math.max(0,Math.floor(ye))}/${de}`,Ke.hidden=!1,ze.hidden=!1,Dt.hidden=!1,ve>0){const Qe=Math.max(0,Math.min(1,Ae/ve));at.width=296*Qe,at.pos.x=e.width()/2-296*(1-Qe)/2,v.text=`Shield: ${Math.max(0,Math.floor(Ae))}/${ve}`,Nt.hidden=!1,at.hidden=!1,v.hidden=!1}else Nt.hidden=!0,at.hidden=!0,v.hidden=!0;if(tt>0){const Qe=Math.max(0,Math.min(1,He/tt));$e.width=296*Qe,$e.pos.x=e.width()/2-296*(1-Qe)/2,pt.text=`Armor: ${Math.max(0,Math.floor(He))}/${tt}`,ut.hidden=!1,$e.hidden=!1,pt.hidden=!1}else ut.hidden=!0,$e.hidden=!0,pt.hidden=!0;Fe>.6?ze.color=e.rgb(255,50,50):Fe>.3?ze.color=e.rgb(255,150,50):ze.color=e.rgb(255,200,0)}else Ht.hidden=!0,Ke.hidden=!0,ze.hidden=!0,ut.hidden=!0,$e.hidden=!0,Dt.hidden=!0,pt.hidden=!0}}else if(pe.length>0&&pe[0].exists()){const J=pe[0],ae=J.hp(),re=J.maxHealth,ye=J.shieldHealth||0,de=J.maxShieldHealth||0,Ae=J.armorHealth||0,ve=J.maxArmorHealth||0,tt={gatekeeper:"THE GATEKEEPER",swarmQueen:"THE SWARM QUEEN",twinGuardianMelee:"THE TWIN GUARDIANS",twinGuardianRanged:"THE TWIN GUARDIANS"}[J.type]||"BOSS";Ht.hidden=!1,Ke.hidden=!1,ze.hidden=!1,ut.hidden=!1,$e.hidden=!1,Dt.hidden=!1,pt.hidden=!1,Ht.text=tt;const Fe=Math.max(0,Math.min(1,ae/re));if(ze.width=296*Fe,ze.pos.x=e.width()/2-296*(1-Fe)/2,Dt.text=`${Math.max(0,Math.floor(ae))}/${re}`,de>0){const Qe=Math.max(0,Math.min(1,ye/de));at.width=296*Qe,at.pos.x=e.width()/2-296*(1-Qe)/2,v.text=`Shield: ${Math.max(0,Math.floor(ye))}/${de}`,Nt.hidden=!1,at.hidden=!1,v.hidden=!1}else Nt.hidden=!0,at.hidden=!0,v.hidden=!0;if(ve>0){const Qe=Math.max(0,Math.min(1,Ae/ve));$e.width=296*Qe,$e.pos.x=e.width()/2-296*(1-Qe)/2,pt.text=`Armor: ${Math.max(0,Math.floor(Ae))}/${ve}`,ut.hidden=!1,$e.hidden=!1,pt.hidden=!1}else ut.hidden=!0,$e.hidden=!0,pt.hidden=!0;Fe>.6?ze.color=e.rgb(255,50,50):Fe>.3?ze.color=e.rgb(255,150,50):ze.color=e.rgb(255,200,0)}else Ht.hidden=!0,Ke.hidden=!0,ze.hidden=!0,ut.hidden=!0,$e.hidden=!0,Dt.hidden=!0,pt.hidden=!0,Nt.hidden=!0,at.hidden=!0,v.hidden=!0}),e.onUpdate(()=>{if(!r.exists()||e.paused)return;const M=o.getPlayer(y);M&&(M.x=r.pos.x,M.y=r.pos.y,M.velocityX=0,M.velocityY=0,M.health=r.hp(),M.maxHealth=r.maxHealth,M.level=r.level,M.xp=r.xp,M.xpToNext=r.xpToNext,M.projectileDamage=r.projectileDamage,M.fireRate=r.fireRate,M.projectileSpeed=r.projectileSpeed,M.projectileCount=r.projectileCount||1,M.piercing=r.piercing||0,M.critChance=r.critChance||.05,M.critDamage=r.critDamage||2,M.pickupRadius=r.pickupRadius,M.defense=r.defense||0,M.isDead=!r.exists()||r.hp()<=0,M.invulnerable=r.invulnerable||!1,o.updateTime(e.dt()))}),o.currentFloor=s,o.currentRoom=i,o.roomCleared=!1,console.log("[Game] Room state synced:",{floor:o.currentFloor,room:o.currentRoom,isBossRoom:i===3}),e.onUpdate(()=>{if(e.paused)return;const M=ba.getManager(),ee=M.getInputsForFrame([y]).get(y);Math.random()<.01&&console.log("[InputManager] Frame:",M.frameNumber,"Input:",{move:`(${ee.moveX}, ${ee.moveY})`,aim:`(${ee.aimX}, ${ee.aimY})`,firing:ee.firing})});let H=!1;const _=A?A.isBossRoom:i===3;let Z=_?0:24+(s-1)*6,ge=0,Le=2,Je=!1,Ne=!1,ft=!1,Tt=4,bt=0;if(!_&&i!==1){const M=.15+(s-1)*.05;ft=Math.random()<M}ft&&(Z=Math.floor(Z*.5));function ll(M){const te=["brute","sentinel","berserker","guardian","warlock"];if(M>=3)return te[Math.floor(Math.random()*te.length)];{const ee=["brute","berserker","guardian"];return ee[Math.floor(Math.random()*ee.length)]}}function cl(M){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[M]||"gatekeeper"}const rt=[],hl=[{x:e.width()/2,y:a,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-a,direction:"south",gridDir:"down"},{x:a,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-a,y:e.height()/2,direction:"east",gridDir:"right"}],dl=ce.floorMap?ce.floorMap.getAvailableExits():[],ul=new Set(dl.map(M=>M.direction));hl.forEach(M=>{const te=zp(e,M.x,M.y,M.direction);te.open=!1,te.isSpawnDoor=!0,te.gridDirection=M.gridDir,(M.gridDir===null||!ul.has(M.gridDir))&&(te.blocked=!0),te.updateVisual(),rt.push(te)});let Ds=0;const pl=.33;let Rn=!1;e.onUpdate(()=>{if(e.paused||H)return;if(Rn||(bt=e.time(),Rn=!0),_){if(!Je){Je=!0;const J=cl(s);if(J==="twinGuardian"){const ae=rt.filter(Ae=>Ae.direction!==ce.entryDirection);let re,ye;if(ae.length>=2){const Ae=[...ae].sort(()=>Math.random()-.5);re=Ae[0];const ve={north:"south",south:"north",east:"west",west:"east"};ye=ae.find(He=>He.direction===ve[re.direction])||Ae[1]}else re=rt[0],ye=rt[rt.length>1?1:0];Dp(e,re,ye,s),da();const de=e.add([e.text("THE TWIN GUARDIANS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{de.exists()&&e.destroy(de)})}else{let ae=rt.find(ve=>ve.direction==="north");if(!ae||ce.entryDirection==="north"&&rt.length>1){const ve=rt.filter(He=>He.direction!==ce.entryDirection);ve.length>0?ae=ve[Math.floor(Math.random()*ve.length)]:ae=rt[Math.floor(Math.random()*rt.length)]}const re=ae?ae.pos.x:e.width()/2,ye=ae?ae.pos.y:e.height()/2;ki(e,re,ye,J,s),da();const de=J==="gatekeeper"?"THE GATEKEEPER":J==="swarmQueen"?"THE SWARM QUEEN":"THE TWIN GUARDIANS",Ae=e.add([e.text(de,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Ae.exists()&&e.destroy(Ae)})}}e.get("boss").length===0&&!H&&(H=!0,Dn());return}if(ft&&!Ne&&e.time()-bt>=1){Ne=!0;const xe=ll(s),J=rt.filter(He=>He.direction!==ce.entryDirection),ae=J.length>0?J:rt,re=ae[Math.floor(Math.random()*ae.length)],ye=re.pos.x,de=re.pos.y;Cp(e,ye,de,xe,s);const Ae={brute:"MINIBOSS: BRUTE",sentinel:"MINIBOSS: SENTINEL",berserker:"MINIBOSS: BERSERKER",guardian:"MINIBOSS: GUARDIAN",warlock:"MINIBOSS: WARLOCK"},ve=e.add([e.text(Ae[xe]||"MINIBOSS",{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{ve.exists()&&e.destroy(ve)})}const M=e.get("enemy").length,te=e.get("miniboss").length;if(ge>=Z&&M===0&&te===0&&!H&&(H=!0,Dn()),ge<Z){if(Ds+=e.dt(),ge===0&&Ds<Le)return;if(Ds>=pl)if(Ds=0,ge++,rt.length>0){const xe=e.time()-bt,ae=ce.entryDirection&&xe<Tt?rt.filter(Qe=>Qe.direction!==ce.entryDirection):rt,re=ae.length>0?ae:rt,ye=re[Math.floor(Math.random()*re.length)],de=ye.pos.x,Ae=ye.pos.y,ve=15,He=de+(Math.random()-.5)*ve,tt=Ae+(Math.random()-.5)*ve,Fe=tn(s);Co(e,He,tt,Fe,s)}else{const xe=e.rand(0,4);let J,ae;switch(Math.floor(xe)){case 0:J=e.rand(E,e.width()-E),ae=E;break;case 1:J=e.width()-E,ae=e.rand(E,e.height()-E);break;case 2:J=e.rand(E,e.width()-E),ae=e.height()-E;break;case 3:J=E,ae=e.rand(E,e.height()-E);break}const re=tn(s);Co(e,J,ae,re,s)}}}),e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(M=>{if(M.hp()<=0&&!M.isDead){M.isDead=!0;const te=M.xpValue,ee=M.pos.x,pe=M.pos.y;if(M.cleanupHealthBars&&M.cleanupHealthBars(),M.explodes&&M.explosionRadius){const re=M.explosionRadius,ye=M.explosionDamage||15;r.exists()&&Math.sqrt(Math.pow(r.pos.x-ee,2)+Math.pow(r.pos.y-pe,2))<=re&&r.takeDamage(ye),e.get("enemy").forEach(de=>{if(de===M||!de.exists())return;Math.sqrt(Math.pow(de.pos.x-ee,2)+Math.pow(de.pos.y-pe,2))<=re&&de.hurt(ye)}),zs(e,ee,pe,{color:[255,150,50]})}else zs(e,ee,pe,{color:[255,100,100]});if(M.shrapnel&&M.shrapnelCount){const re=M.shrapnelCount,ye=Math.PI*2/re,de=250,Ae=Math.floor((M.explosionDamage||15)*.6);for(let ve=0;ve<re;ve++){const He=ye*ve,tt=e.vec2(Math.cos(He),Math.sin(He)),Fe=Vt(e,ee,pe,tt,de,Ae,0,0,!1);Fe.isEnemyProjectile=!0,Fe.color=e.rgb(...M.originalColor)}}e.destroy(M),ca(),It.enemiesKilled++,Bs(e,ee,pe,te);const xe=Math.floor(Math.random()*3)+1,J=1;for(let re=0;re<xe;re++){const ye=(Math.random()-.5)*20,de=(Math.random()-.5)*20;Os(e,ee+ye,pe+de,J)}const ae=Ip(M.type,s);if(ae){const re=(Math.random()-.5)*30,ye=(Math.random()-.5)*30;la(e,ee+re,pe+ye,ae)}}}),e.get("miniboss").forEach(M=>{if(M.hp()<=0&&!M.isDead){M.isDead=!0;const te=M.xpValue,ee=M.pos.x,pe=M.pos.y;zs(e,ee,pe,{color:[255,150,100],isMiniboss:!0}),e.destroy(M),ca(),It.enemiesKilled++,Bs(e,ee,pe,te);const xe=Math.floor(Math.random()*6)+10,J=1;for(let re=0;re<xe;re++){const ye=Math.PI*2/xe*re,de=30+Math.random()*20,Ae=Math.cos(ye)*de,ve=Math.sin(ye)*de;Os(e,ee+Ae,pe+ve,J)}const ae=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(ee,pe-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{ae.exists()&&e.destroy(ae)})}}),e.get("boss").forEach(M=>{if(M.hp()<=0&&!M.isDead){M.isDead=!0;const te=M.xpValue,ee=M.pos.x,pe=M.pos.y;zs(e,ee,pe,{color:[255,200,100],isBoss:!0}),e.destroy(M),Jp(),It.enemiesKilled++,It.bossesKilled++,Bs(e,ee,pe,te);const xe=Math.floor(Math.random()*11)+20,J=1,ae=Qr();for(let ye=0;ye<xe;ye++){const de=Math.PI*2/xe*ye,Ae=40+Math.random()*30,ve=Math.cos(de)*Ae,He=Math.sin(de)*Ae;Os(e,ee+ve,pe+He,J,ae)}const re=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(ee,pe-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{re.exists()&&e.destroy(re)})}}))}),e.onUpdate(()=>{!r.exists()||e.paused||e.get("xpPickup").forEach(M=>{if(M.collected)return;const te=e.vec2(r.pos.x-M.pos.x,r.pos.y-M.pos.y).len();if(!M.magnetizing&&te<=r.pickupRadius&&(M.magnetizing=!0,M.targetPlayer=r),te<=Xe.COLLECTION_RADIUS){M.collected=!0,Vp(),r.addXP(M.value);const ee=e.add([e.text("+",{size:12}),e.pos(M.pos.x,M.pos.y),e.color(100,255,100),e.fixed(),e.z(B.UI_TEXT+1)]),pe=e.width()/2,xe=I+D/2,J=.4;let ae=0;const re=M.pos.x,ye=M.pos.y;ee.onUpdate(()=>{ae+=e.dt();const de=Math.min(ae/J,1),Ae=de*de;ee.pos.x=re+(pe-re)*Ae,ee.pos.y=ye+(xe-ye)*Ae,ee.opacity=1-de*.5,ee.scale=e.vec2(1-de*.5),de>=1&&(e.destroy(ee),C.color=e.rgb(150,255,150),e.wait(.1,()=>{C.exists()&&(C.color=e.rgb(100,255,100))}))}),e.destroy(M)}})}),e.onUpdate(()=>{!r.exists()||e.paused||(e.get("currencyPickup").forEach(M=>{if(M.collected)return;const te=e.vec2(r.pos.x-M.pos.x,r.pos.y-M.pos.y).len();if(!M.magnetizing&&te<=r.pickupRadius&&(M.magnetizing=!0,M.targetPlayer=r),te<=Xe.COLLECTION_RADIUS){M.collected=!0,ha(),$i(M.value);const ee=e.add([e.text("$",{size:10}),e.pos(M.pos.x,M.pos.y),e.color(255,215,0),e.fixed(),e.z(B.UI_TEXT+1)]),pe=e.width()-20,xe=20,J=.5;let ae=0;const re=M.pos.x,ye=M.pos.y;ee.onUpdate(()=>{ae+=e.dt();const de=Math.min(ae/J,1),Ae=de*de;ee.pos.x=re+(pe-re)*Ae,ee.pos.y=ye+(xe-ye)*Ae,ee.opacity=1,de>=1&&(e.destroy(ee),S.scale=e.vec2(1.3),R.scale=e.vec2(1.2),e.wait(.15,()=>{S.exists()&&(S.scale=e.vec2(1)),R.exists()&&(R.scale=e.vec2(1))}))}),e.destroy(M)}}),e.get("powerupWeaponPickup").forEach(M=>{if(M.collected)return;const te=e.vec2(r.pos.x-M.pos.x,r.pos.y-M.pos.y).len();if(!M.magnetizing&&te<=r.pickupRadius&&(M.magnetizing=!0,M.targetPlayer=r),te<=Xe.COLLECTION_RADIUS){M.collected=!0,ha(),Pp(r,M.powerupKey);const ee=e.add([e.text(M.text(),{size:32}),e.pos(r.pos.x,r.pos.y-30),e.color(...M.color.toArray()),e.anchor("center"),e.z(B.UI_TEXT+1),e.opacity(1)]);let pe=0;ee.onUpdate(()=>{pe+=e.dt(),ee.pos.y-=50*e.dt(),ee.opacity=Math.max(0,1-pe/.8),pe>=.8&&e.destroy(ee)}),e.destroy(M)}}))});let fi=!1;e.onUpdate(()=>{!r.exists()||e.paused||fi||e.get("door").forEach(M=>{if(!M.open||fi||M.isSpawnDoor||M.blocked)return;e.vec2(r.pos.x-M.pos.x,r.pos.y-M.pos.y).len()<=40&&(fi=!0,Wp(),gl(M.direction))})});function fl(){if(!r.exists())return;const M=e.width()/2,te=e.height()/2,ee=5,pe=3,xe=_?3:1,J=_?4:1,ae=s*.5,re=Math.floor((ee+ae)*xe),ye=Math.floor((pe+ae)*J);for(let de=0;de<re;de++){const Ae=Math.PI*2*de/re+Math.random()*.3,ve=40+Math.random()*60,He=M+Math.cos(Ae)*ve,tt=te+Math.sin(Ae)*ve,Fe=Math.floor(1+s*.5);Bs(e,He,tt,Fe)}for(let de=0;de<ye;de++){const Ae=Math.PI*2*de/ye+Math.random()*.3+.5,ve=50+Math.random()*70,He=M+Math.cos(Ae)*ve,tt=te+Math.sin(Ae)*ve,Fe=Math.floor(1+s*.3);Os(e,He,tt,Fe)}if(_){const de=Object.keys(No),Ae=1+Math.floor(Math.random()*2);for(let ve=0;ve<Ae;ve++){const He=Math.random()*Math.PI*2,tt=80+Math.random()*40,Fe=M+Math.cos(He)*tt,Qe=te+Math.sin(He)*tt,xi=de[Math.floor(Math.random()*de.length)];la(e,Fe,Qe,xi)}}}function Dn(){o.roomCleared=!0,o.clearRoom(),console.log("[Game] Room cleared:",{floor:o.currentFloor,room:o.currentRoom,cleared:o.roomCleared}),It.roomsCleared++,ce.floorMap&&A&&ce.floorMap.markRoomCleared(A.position.x,A.position.y),rt.forEach(ee=>{ee.exists()&&!ee.blocked&&(ee.open=!0,ee.isSpawnDoor=!1,ee.updateVisual())}),ce.minimap&&ce.minimap.update(),fl();const M=_?`BOSS DEFEATED! Floor ${s} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",te=e.add([e.text(M,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{te.exists()&&e.destroy(te)})}function gl(M){ce.playerStats={level:r.level,xp:r.xp,xpToNext:r.xpToNext,maxHealth:r.maxHealth,currentHP:r.hp(),speed:r.speed,fireRate:r.fireRate,projectileSpeed:r.projectileSpeed,projectileDamage:r.projectileDamage,pickupRadius:r.pickupRadius,xpMultiplier:r.xpMultiplier||1,projectileCount:r.projectileCount||1,piercing:r.piercing||0,obstaclePiercing:r.obstaclePiercing||0,critChance:r.critChance||0,critDamage:r.critDamage||2,spreadAngle:r.spreadAngle||0,defense:r.defense||0,selectedUpgrades:r.selectedUpgrades?Array.from(r.selectedUpgrades):[],activeSynergies:r.activeSynergies?Array.from(r.activeSynergies):[],piercingDamageBonus:r.piercingDamageBonus||1};const te={north:"south",south:"north",west:"east",east:"west"};if(ce.entryDirection=te[M]||null,ce.floorMap){const pe={north:"up",south:"down",east:"right"}[M];pe?ce.floorMap.moveToRoom(pe)?(ce.floorMap.getCurrentRoom().isBossRoom&&console.log("[Game] Boss room reached - floor complete after this room"),i=ce.floorMap.getVisitedCount()):(console.error("[Game] Failed to move in floor map - should not happen!"),i++):(console.warn("[Game] Invalid door direction:",M),i++),A&&A.isBossRoom&&A.cleared?(s++,Zn(s-1).then(xe=>{if(xe){const J=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{J.exists()&&e.destroy(J)})}}),ce.floorMap=null,ce.entryDirection=null,o.nextFloor(),console.log("[Game] Advanced to next floor:",o.currentFloor)):(o.nextRoom(),console.log("[Game] Advanced to next room:",{floor:o.currentFloor,room:o.currentRoom}))}else i++,i>3?(s++,Zn(s-1).then(ee=>{if(ee){const pe=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{pe.exists()&&e.destroy(pe)})}}),i=1,ce.entryDirection=null,o.nextFloor(),console.log("[Game] Advanced to next floor:",o.currentFloor)):(o.nextRoom(),console.log("[Game] Advanced to next room:",{floor:o.currentFloor,room:o.currentRoom}));ce.currentFloor=s,ce.currentRoom=i,e.go("game")}r.onDeath(()=>{r.orbitalOrbs&&(r.orbitalOrbs.forEach(ee=>{ee.exists()&&e.destroy(ee)}),r.orbitalOrbs=[]);const M=Ku(It),te={...It,level:r.level,currencyEarned:M};Yu(te),$i(M),S0(e),eo()&&ta(),e.go("gameOver",{runStats:{...It},currencyEarned:M})});const gi=e.add([e.rect(270,250),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(0,0,0),e.opacity(.9),e.outline(3,e.rgb(200,200,200)),e.fixed(),e.z(2e3),"pauseOverlay"]),mi=e.add([e.text("PAUSED",{size:48}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2001),"pauseText"]),Ts=e.height()/2,Cs=60,Tn=200,Cn=40,In=e.add([e.rect(Tn,Cn),e.pos(e.width()/2,Ts-Cs/2),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Resume (ESC)",{size:18}),e.pos(e.width()/2,Ts-Cs/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]);const Pn=e.add([e.rect(Tn,Cn),e.pos(e.width()/2,Ts+Cs/2),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Quit to Menu",{size:18}),e.pos(e.width()/2,Ts+Cs/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]),gi.hidden=!0,mi.hidden=!0,e.get("pauseButton").forEach(M=>M.hidden=!0),In.onClick(()=>{!e.paused||In.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),fa(),gi.hidden=!0,mi.hidden=!0,e.get("pauseButton").forEach(M=>M.hidden=!0))}),Pn.onClick(()=>{!e.paused||Pn.hidden||(eo()&&ta(),ce.currentFloor=1,ce.currentRoom=1,ce.playerStats=null,e.go("menu"))}),e.onKeyPress("m",()=>{ce.minimap&&!e.paused&&ce.minimap.toggle()}),e.onKeyPress("escape",()=>{ma()||(e.paused=!e.paused,e.paused?(Zp(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()))):(fa(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0)),gi.hidden=!e.paused,mi.hidden=!e.paused,e.get("pauseButton").forEach(M=>M.hidden=!e.paused))})})}let Ro=!1;function ho(e,t,o,s,i=_o.WIDTH,a=_o.HEIGHT,l=W.BUTTON){const c=O.SECONDARY,r=O.SECONDARY_HOVER,n=O.TEXT_PRIMARY,d=O.BORDER,u=!1,h=e.add([e.rect(i,a),e.pos(o,s),e.anchor("center"),e.color(...c),e.outline(2,e.rgb(...d)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS),"menuButton"]),y=Ms(t),f=[];{const g=e.add([e.text(y,{size:l}),e.pos(o,s),e.anchor("center"),e.color(...n),e.fixed(),e.z(B.UI_TEXT),"menuButtonText"]);f.push(g)}const A=f[0];return h.originalColor=[...c],h.hoverColor=[...r],h.borderColor=[...d],h.isHovered=!1,h.disabled=u,h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,xt()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...O.BORDER_HOVER),h.scale=e.vec2(_o.HOVER_SCALE,_o.HOVER_SCALE),f.forEach(g=>g.scale=e.vec2(_o.HOVER_SCALE,_o.HOVER_SCALE)))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),f.forEach(g=>g.scale=e.vec2(1,1)))}),h.label=A,h.labels=f,h.setDisabled=g=>{h.disabled=g,g?(h.color=e.rgb(...O.BG_DISABLED),f.forEach(w=>w.color=e.rgb(...O.TEXT_DISABLED))):(h.color=e.rgb(...h.originalColor),f.forEach((w,E)=>{w.color=e.rgb(...n)}))},h}function _0(e,t){Ro=!0,t&&t.setDisabled(!0);const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(B.OVERLAY),"joinDialog"]),s=400,i=200,a=e.add([e.rect(s,i),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(3,e.rgb(...O.BORDER)),e.fixed(),e.z(B.OVERLAY+1),"joinDialog"]),l=24,c=e.add([e.rect(l,l),e.pos(e.width()/2+s/2-10,e.height()/2-i/2+10),e.anchor("topright"),e.color(...O.BG_DARK),e.outline(1,e.rgb(...O.BORDER)),e.area(),e.fixed(),e.z(B.OVERLAY+2),"joinDialog"]),r=e.add([e.text("X",{size:W.SMALL}),e.pos(e.width()/2+s/2-10-l/2,e.height()/2-i/2+10+l/2),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+3),"joinDialog"]);c.onHoverUpdate(()=>{c.color=e.rgb(...O.BG_LIGHT),r.color=e.rgb(255,100,100)}),c.onHoverEnd(()=>{c.color=e.rgb(...O.BG_DARK),r.color=e.rgb(...O.TEXT_PRIMARY)}),c.onClick(()=>{f||(xt(),p())});const n=e.add([e.text("Join Party",{size:W.LABEL}),e.pos(e.width()/2,e.height()/2-70),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2),"joinDialog"]),d=e.add([e.text("Enter 6-digit invite code:",{size:W.SMALL}),e.pos(e.width()/2,e.height()/2-30),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.OVERLAY+2),"joinDialog"]);let u="";const h=e.add([e.text("______",{size:W.TITLE}),e.pos(e.width()/2,e.height()/2+10),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.OVERLAY+2),"joinDialog"]),y=e.add([e.text("",{size:W.SMALL-2}),e.pos(e.width()/2,e.height()/2+45),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(B.OVERLAY+2),"joinDialog"]);let f=!1;const A=ho(e,"Cancel",e.width()/2-60,e.height()/2+70,100,30,W.SMALL-2),g=ho(e,"Join",e.width()/2+60,e.height()/2+70,100,30,W.SMALL-2);g.setDisabled(!0),g.color=e.rgb(80,80,90),g.labels.forEach(m=>m.color=e.rgb(150,150,150));const w=[o,a,c,r,n,d,h,y,A,...A.labels,g,...g.labels],E=e.onCharInput(m=>{if(!f&&m>="0"&&m<="9"&&u.length<6){u+=m;const b=u+"______".substring(u.length);h.text=b,y.text="",u.length===6&&(g.setDisabled(!1),g.color=e.rgb(...g.originalColor),g.labels.forEach(S=>S.color=e.rgb(...O.TEXT_PRIMARY)))}}),T=e.onKeyPress("backspace",()=>{if(!f&&u.length>0){u=u.slice(0,-1);const m=u+"______".substring(u.length);h.text=m,u.length<6&&g.setDisabled(!0)}}),z=e.onKeyPress("escape",()=>{f||(xt(),p())}),q=e.onKeyPress("enter",async()=>{f||u.length===6&&g.onClick()});function p(){Ro=!1,w.forEach(m=>{m&&m.exists&&m.exists()&&e.destroy(m)}),E.cancel(),T.cancel(),z.cancel(),q.cancel(),t&&t.setDisabled(!1)}A.onClick(()=>{xt(),p()}),g.onClick(async()=>{if(!f)if(u.length===6){if(!Hu(u)){y.color=e.rgb(255,100,100),y.text="Invalid code format";return}Ut(),f=!0,g.setDisabled(!0),y.color=e.rgb(255,255,100),y.text="Connecting...";try{console.log("Joining party with code:",u);const m=new Promise((S,R)=>{setTimeout(()=>R(new Error("timeout")),1e4)});await Promise.race([sp(u),m])?(y.color=e.rgb(100,255,100),y.text="Connected! Joined party.",e.wait(1,()=>{p(),e.go("menu")})):(y.color=e.rgb(255,100,100),y.text="Failed to find party",f=!1,g.setDisabled(!1))}catch(m){console.error("Join error:",m),y.color=e.rgb(255,100,100),m.message,y.text="Failed to find party",f=!1,g.setDisabled(!1)}}else y.color=e.rgb(255,100,100),y.text="Please enter 6 digits"})}function X0(e){e.scene("menu",()=>{kr();const t=mo(),o=vs();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...O.BG_DARK),e.z(B.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...O.BORDER),e.fixed(),e.z(B.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...O.BORDER),e.fixed(),e.z(B.UI_BACKGROUND)]),ku();const s=20,i=20,a=188,l=24,c=3,r=10,n=r+l*4+c*3+60;e.add([e.rect(a,n),e.pos(s,i),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.BORDER)),e.fixed(),e.z(B.UI_BACKGROUND)]);const d=rp(),u=i+r;d.forEach((k,se)=>{const F=u+se*(l+c);e.add([e.rect(a-20,l),e.pos(s+10,F),e.color(k.isEmpty?O.BG_DARK:O.BG_LIGHT),e.outline(1,e.rgb(...O.TEXT_DISABLED)),e.fixed(),e.z(B.UI_BACKGROUND+1)]),e.add([e.text(`${k.slotNumber}`,{size:W.SMALL}),e.pos(s+20,F+l/2),e.anchor("left"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),e.add([e.text(k.playerName,{size:W.SMALL-2}),e.pos(s+45,F+l/2),e.anchor("left"),e.color(k.isEmpty?O.TEXT_DISABLED:k.isLocal?O.GOLD:O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]),k.isLocal&&e.add([e.text("(You)",{size:W.SMALL-4}),e.pos(s+a-20,F+l/2),e.anchor("right"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)])});const h=u+4*(l+c)+10;e.add([e.text("Invite Code:",{size:W.SMALL-2}),e.pos(s+10,h),e.anchor("left"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]);const y=ws();lp()?e.add([e.text(y,{size:W.SMALL}),e.pos(s+a-10,h),e.anchor("right"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]):e.add([e.text("OFFLINE",{size:W.SMALL-2}),e.pos(s+a-10,h),e.anchor("right"),e.color(...O.TEXT_DISABLED),e.fixed(),e.z(B.UI_TEXT)]);const A=h+25,g=ho(e,"JOIN PARTY",s+a/2,A,120,30,W.SMALL-2);g.onClick(()=>{Ut(),_0(e,g)});const w=e.add([e.text(`${o}: ${t}`,{size:W.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),E=w.width+30,T=40;e.destroy(w),e.add([e.rect(E,T),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.GOLD)),e.fixed(),e.z(B.UI_BACKGROUND)]),e.add([e.text(`${o}: ${t}`,{size:W.LABEL}),e.pos(e.width()-20-E/2,40),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]);const z=130,q=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],p=[],m=12,b=z-q.length*m/2;q.forEach((k,se)=>{const F=e.add([e.text(k,{size:10,font:"monospace"}),e.pos(e.width()/2,b+se*m),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.z(B.UI_TEXT),"titleLine"]);p.push(F)});let S=0;e.onUpdate(()=>{S+=e.dt(),p.forEach((k,se)=>{const F=(S*50+se*20)%360,j=R(F,80,60);k.color=e.rgb(...j);const ie=Math.sin(S*2+se*.3)*2;k.pos.y=b+se*m+ie,Math.random()<.001&&(k.pos.x=e.width()/2+(Math.random()-.5)*10,e.wait(.1,()=>{k.exists()&&(k.pos.x=e.width()/2)}))})});function R(k,se,F){se/=100,F/=100;const j=(1-Math.abs(2*F-1))*se,ie=j*(1-Math.abs(k/60%2-1)),be=F-j/2;let Re=0,he=0,Ie=0;return k>=0&&k<60?(Re=j,he=ie,Ie=0):k>=60&&k<120?(Re=ie,he=j,Ie=0):k>=120&&k<180?(Re=0,he=j,Ie=ie):k>=180&&k<240?(Re=0,he=ie,Ie=j):k>=240&&k<300?(Re=ie,he=0,Ie=j):k>=300&&k<360&&(Re=j,he=0,Ie=ie),[Math.round((Re+be)*255),Math.round((he+be)*255),Math.round((Ie+be)*255)]}const P=280,D=p0.BUTTON_VERTICAL,I=e.width()/2,C=ho(e,"Start Game",I,P,350,55,W.HEADER);C.onClick(()=>{Ut(),e.go("game",{resetState:!0})});const U=ho(e,"Character Select",I,P+D,350,50,W.BUTTON);U.onClick(()=>{Ut(),e.go("characterSelect")});const Y=bn(),G=xo[Y];if(G){const k=po("characters",Y)||G.unlockedByDefault,se=I+175+60,F=P+D,j=50;e.add([e.rect(j,j),e.pos(se,F),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.BORDER)),e.fixed(),e.z(B.UI_BACKGROUND)]),e.add([e.text(G.char,{size:36}),e.pos(se,F),e.anchor("center"),e.color(...k?G.color:O.BG_DISABLED),e.fixed(),e.z(B.UI_TEXT)]),e.add([e.text(G.name,{size:W.SMALL-2}),e.pos(se,F+35),e.anchor("center"),e.color(...k?O.TEXT_PRIMARY:O.TEXT_DISABLED),e.fixed(),e.z(B.UI_TEXT)])}const K=ho(e,"Shop",I,P+D*2,350,50,W.BUTTON);K.onClick(()=>{Ut(),e.go("shop")});const $=ho(e,"Statistics",I,P+D*3,350,50,W.BUTTON);$.onClick(()=>{Ut(),e.go("statistics")});const V=ho(e,"Options",I,P+D*4,350,50,W.BUTTON);V.onClick(()=>{Ut(),e.go("settings")});const ue=[C,U,K,$,V];let Q=0;e.onUpdate(()=>{Q+=e.dt(),ue.forEach((k,se)=>{if(!k.exists()||k.isHovered)return;const F=(Q*60+se*50)%360,j=R(F,70,50);try{const ie=e.rgb(j[0],j[1],j[2]);k.color=ie,k.originalColor=j}catch(ie){console.error("Color update error:",ie)}})});const we=e.onKeyPress("space",()=>{Ro||(Ut(),e.go("game",{resetState:!0}))}),oe=e.onKeyPress("c",()=>{Ro||(xt(),e.go("characterSelect"))}),me=e.onKeyPress("s",()=>{Ro||(xt(),e.go("shop"))}),Se=e.onKeyPress("o",()=>{Ro||(xt(),e.go("settings"))}),Te=e.onKeyPress("t",()=>{Ro||(xt(),e.go("statistics"))});e.onSceneLeave(()=>{we.cancel(),oe.cancel(),me.cancel(),Se.cancel(),Te.cancel()});const Ve=[["<o>","(o)","<O>","(O)"],["~@~","^@^","~o~","^o^"],["[#]","{#}","<#>","(#)"],["===","---","___","~~~"],["<>","><","^v","vA"]];for(let k=0;k<8;k++){const se=Ve[Math.floor(Math.random()*Ve.length)],F=e.add([e.text(se[0],{size:16,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...O.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(B.PARTICLES)]);F.speed=30+Math.random()*50,F.direction=Math.random()<.5?1:-1,F.animFrame=0,F.creatureSet=se,F.onUpdate(()=>{F.pos.x+=F.speed*F.direction*e.dt(),F.animFrame+=e.dt()*4;const j=Math.floor(F.animFrame)%F.creatureSet.length;F.text=F.creatureSet[j],F.direction>0&&F.pos.x>e.width()+50?(F.pos.x=-50,F.pos.y=Math.random()*e.height()):F.direction<0&&F.pos.x<-50&&(F.pos.x=e.width()+50,F.pos.y=Math.random()*e.height())})}for(let k=0;k<15;k++){const se="01".split(""),F=e.add([e.text(se[Math.floor(Math.random()*se.length)],{size:14,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(50+Math.random()*50,100+Math.random()*100,50+Math.random()*50),e.opacity(.2+Math.random()*.3),e.z(B.PARTICLES)]);F.speed=40+Math.random()*80,F.charChangeTimer=0,F.chars=se,F.onUpdate(()=>{F.pos.y+=F.speed*e.dt(),F.charChangeTimer+=e.dt(),F.charChangeTimer>.1&&(F.text=F.chars[Math.floor(Math.random()*F.chars.length)],F.charChangeTimer=0),F.pos.y>e.height()&&(F.pos.y=-20,F.pos.x=Math.random()*e.width())})}const it=["","","","","","","",""];for(let k=0;k<12;k++){const se=e.add([e.text(it[Math.floor(Math.random()*it.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...O.BG_LIGHT),e.opacity(.15),e.z(B.PARTICLES)]);se.pulseTime=Math.random()*Math.PI*2,se.pulseSpeed=1+Math.random()*2,se.onUpdate(()=>{se.pulseTime+=e.dt()*se.pulseSpeed;const F=.8+Math.sin(se.pulseTime)*.3;se.scale=e.vec2(F,F),se.opacity=.1+Math.abs(Math.sin(se.pulseTime))*.15})}for(let k=0;k<20;k++){const se=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...O.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(B.PARTICLES)]);se.speed=10+Math.random()*20,se.onUpdate(()=>{se.pos.y+=se.speed*e.dt(),se.pos.y>e.height()&&(se.pos.y=0,se.pos.x=Math.random()*e.width())})}const je=[];e.loop(5,()=>{if(je.length<3&&Math.random()<.3){const k=["","","","","","",""],se=e.add([e.text(k[Math.floor(Math.random()*k.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(B.PARTICLES)]);se.followSpeed=20+Math.random()*30,se.rotationSpeed=50+Math.random()*100,se.lifetime=15+Math.random()*10,se.onUpdate(()=>{const j=e.mousePos().sub(se.pos),ie=j.len();if(ie>5){const be=j.scale(1/ie);se.pos=se.pos.add(be.scale(se.followSpeed*e.dt()))}if(se.angle+=se.rotationSpeed*e.dt(),se.lifetime-=e.dt(),se.lifetime<=0){e.destroy(se);const be=je.indexOf(se);be>-1&&je.splice(be,1)}}),je.push(se)}}),e.loop(10,()=>{if(Math.random()<.15){const k=100+Math.random()*(e.height()-200),se=Math.random()<.5?1:-1,F=se>0?-50:e.width()+50,j=e.add([e.text("$",{size:24}),e.pos(F,k),e.color(...O.GOLD),e.area({scale:2.5}),e.anchor("center"),e.z(B.PARTICLES+1),"goldenEnemy"]);j.speed=150+Math.random()*100,j.direction=se,j.pulseTime=0,j.onClick(()=>{if(!j.exists())return;$i(1);for(let be=0;be<12;be++){const Re=Math.PI*2*be/12,he=e.add([e.text(["$","","",""][Math.floor(Math.random()*4)],{size:14}),e.pos(j.pos.x,j.pos.y),e.color(...O.GOLD),e.z(B.PARTICLES+2)]),Ie=100+Math.random()*100;he.velocity=e.vec2(Math.cos(Re)*Ie,Math.sin(Re)*Ie),he.life=1,he.onUpdate(()=>{he.pos=he.pos.add(he.velocity.scale(e.dt())),he.life-=e.dt(),he.opacity=he.life,he.life<=0&&e.destroy(he)})}const ie=e.add([e.text("+$1",{size:20}),e.pos(j.pos.x,j.pos.y),e.anchor("center"),e.color(...O.SUCCESS),e.z(B.UI_TEXT)]);ie.life=1.5,ie.onUpdate(()=>{ie.pos.y-=50*e.dt(),ie.life-=e.dt(),ie.opacity=ie.life/1.5,ie.life<=0&&e.destroy(ie)}),e.destroy(j),e.wait(.1,()=>e.go("menu"))}),j.onUpdate(()=>{j.pos.x+=j.speed*j.direction*e.dt(),j.pulseTime+=e.dt();const ie=Math.sin(j.pulseTime*8)*.2;j.scale=e.vec2(1+ie,1+ie),(j.direction>0&&j.pos.x>e.width()+100||j.direction<0&&j.pos.x<-100)&&e.destroy(j)})}})})}function Y0(e){e.scene("gameOver",t=>{const o=(t==null?void 0:t.runStats)||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},s=(t==null?void 0:t.currencyEarned)||0,i=mo(),a=Uu(),l=vs();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...O.BG_DARK),e.opacity(.95),e.fixed(),e.z(B.OVERLAY)]),e.add([e.text("Game Over",{size:48}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...O.DANGER),e.fixed(),e.z(B.MODAL)]);const c=160,r=30;e.add([e.text("Run Statistics",{size:W.HEADER}),e.pos(e.width()/2,c),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`${Do.FLOOR}s Reached: ${o.floorsReached}`,{size:W.LABEL}),e.pos(e.width()/2,c+r),e.anchor("center"),e.color(...O.INFO),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`${Do.ROOM}s Cleared: ${o.roomsCleared}`,{size:W.LABEL}),e.pos(e.width()/2,c+r*2),e.anchor("center"),e.color(...O.INFO),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`Enemies Killed: ${o.enemiesKilled}`,{size:W.LABEL}),e.pos(e.width()/2,c+r*3),e.anchor("center"),e.color(...O.INFO),e.fixed(),e.z(B.MODAL)]),o.bossesKilled>0&&e.add([e.text(`Bosses Defeated: ${o.bossesKilled}`,{size:W.LABEL}),e.pos(e.width()/2,c+r*4),e.anchor("center"),e.color(...O.BOSS_NAME),e.fixed(),e.z(B.MODAL)]);const n=c+r*(o.bossesKilled>0?6:5);e.add([e.text(`${l} Earned: +${s}`,{size:W.BUTTON}),e.pos(e.width()/2,n),e.anchor("center"),e.color(...O.SUCCESS),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`Total ${l}: ${i}`,{size:W.LABEL}),e.pos(e.width()/2,n+30),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.MODAL)]);const d=n+80;e.add([e.text("Lifetime Stats",{size:W.BUTTON}),e.pos(e.width()/2,d),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`Best ${Do.FLOOR}: ${a.stats.bestFloor} | Total Runs: ${a.stats.totalRuns}`,{size:W.BODY}),e.pos(e.width()/2,d+25),e.anchor("center"),e.color(...O.TEXT_TERTIARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text("Press SPACE to Restart",{size:W.HEADER}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...O.TEXT_TERTIARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text("Press T for Statistics | ESC to Return to Menu",{size:W.BODY}),e.pos(e.width()/2,e.height()-30),e.anchor("center"),e.color(...O.TEXT_DISABLED),e.fixed(),e.z(B.MODAL)]),e.onKeyPress("space",()=>{Ut(),e.go("game",{resetState:!0})}),e.onKeyPress("t",()=>{xt(),e.go("statistics")}),e.onKeyPress("escape",()=>{xt(),e.go("menu")})})}function G0(e){e.scene("shop",()=>{const t=mo(),o=vs();let s="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...O.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),e.add([e.text(Ms("Shop"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const i=e.add([e.text(`${o}: ${t}`,{size:W.HEADER}),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]),a=90,l=120,c=100,r=30,n=[{key:"permanentUpgrades",label:"Upgrades"},{key:"characters",label:"Characters"},{key:"weapons",label:"Weapons"}],d=[];n.forEach((g,w)=>{const E=e.width()/2-n.length*l/2+w*l,T=s===g.key,z=e.add([e.rect(c,r),e.pos(E,a),e.anchor("center"),e.color(...T?O.SECONDARY:O.BG_MEDIUM),e.outline(2,e.rgb(...O.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),q=e.add([e.text(g.label,{size:W.BODY}),e.pos(E,a),e.anchor("center"),e.color(...T?O.TEXT_PRIMARY:O.TEXT_TERTIARY),e.fixed(),e.z(B.UI_TEXT)]);z.onClick(()=>{xt(),s=g.key,f()}),d.push({bg:z,label:q,category:g.key})});const u=140,h=e.height()-u-60;let y=[];function f(){d.forEach(m=>{const b=s===m.category;m.bg.color=e.rgb(b?100:50,b?100:50,b?150:80),m.label.color=e.rgb(b?255:150,b?255:150,b?255:150)}),y.forEach(m=>{m.exists()&&e.destroy(m)}),y=[];const g=_r(s),E=Object.keys(g).filter(m=>{const b=g[m];return s==="permanentUpgrades"?!0:!b.unlockedByDefault});if(E.length===0){const m=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,u+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);y.push(m);return}const T=100,z=u+20,q=Math.floor(h/T),p=Math.min(q,E.length);E.forEach((m,b)=>{const S=g[m],R=Math.floor(b/p),P=b%p,D=50+R*350,I=z+P*T,C=e.add([e.rect(320,90),e.pos(D,I),e.anchor("topleft"),e.color(40,40,50),e.outline(2,e.rgb(80,80,100)),e.area(),e.fixed(),e.z(1e3)]),U=e.add([e.text(S.name,{size:18}),e.pos(D+10,I+10),e.anchor("topleft"),e.color(255,255,255),e.fixed(),e.z(1001)]),Y=e.add([e.text(S.description,{size:14,width:300}),e.pos(D+10,I+35),e.anchor("topleft"),e.color(200,200,200),e.fixed(),e.z(1001)]);let G="",K=!1,$=S.cost;if(s==="permanentUpgrades"){const ue=kt(m),Q=S.maxLevel||1;ue>=Q?G=`MAX (${ue}/${Q})`:(G=`Level ${ue}/${Q}`,K=t>=$)}else po(s,m)?G="UNLOCKED":K=t>=$;const V=e.add([e.text(G,{size:14}),e.pos(D+10,I+60),e.anchor("topleft"),e.color(po(s,m)||s==="permanentUpgrades"&&kt(m)>0?100:200,po(s,m)||s==="permanentUpgrades"&&kt(m)>0?255:200,po(s,m)||s==="permanentUpgrades"&&kt(m)>0?100:200),e.fixed(),e.z(1001)]);if(K||s==="permanentUpgrades"&&kt(m)<(S.maxLevel||1)){const ue=e.add([e.rect(80,30),e.pos(D+230,I+55),e.anchor("topleft"),e.color(K?50:30,K?150:30,K?50:30),e.outline(2,e.rgb(K?100:50,K?200:50,K?100:50)),e.area(),e.fixed(),e.z(1001)]),Q=e.add([e.text(`${$} ${o}`,{size:14}),e.pos(D+270,I+70),e.anchor("center"),e.color(K?255:150,K?255:150,K?255:150),e.fixed(),e.z(1002)]);K&&ue.onClick(()=>{let we;if(s==="permanentUpgrades"?we=Xu(m,$,S.maxLevel):we=_u(s,m,$),s==="permanentUpgrades"){if(we&&we.success){ua();const oe=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{oe.exists()&&e.destroy(oe)}),f(),i.text=`${o}: ${mo()}`}else if(we&&we.reason==="insufficientCurrency"){pa();const oe=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{oe.exists()&&e.destroy(oe)})}}else if(we){ua();const oe=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{oe.exists()&&e.destroy(oe)}),f(),i.text=`${o}: ${mo()}`}else{pa();const oe=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{oe.exists()&&e.destroy(oe)})}}),y.push(ue,Q)}y.push(C,U,Y,V)})}f();const A=e.add([e.rect(120,35),e.pos(20,e.height()-40),e.anchor("topleft"),e.color(80,80,100),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(1e3)]);e.add([e.text("Back",{size:16}),e.pos(80,e.height()-22),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(1001)]),A.onClick(()=>{xt(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const il="superSmashTexty_settings",ii={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:1},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showDamageNumbers:!0,compactHUD:!1},gameplay:{autoPause:!1}};function nl(){try{const e=localStorage.getItem(il);if(e){const t=JSON.parse(e);return al(ii,t)}}catch(e){console.error("Error loading settings:",e)}return{...ii}}function al(e,t){const o={...e};return Di(e)&&Di(t)&&Object.keys(t).forEach(s=>{Di(t[s])?s in e?o[s]=al(e[s],t[s]):Object.assign(o,{[s]:t[s]}):Object.assign(o,{[s]:t[s]})}),o}function Di(e){return e&&typeof e=="object"&&!Array.isArray(e)}function rl(e){try{return localStorage.setItem(il,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function Ea(){return nl()}function co(e,t,o){const s=nl();return s[e]||(s[e]={}),s[e][t]=o,rl(s),s}function K0(){return rl({...ii}),{...ii}}function V0(e,t,o){const s=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(B.OVERLAY)]),l=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(3,e.rgb(...O.BORDER)),e.fixed(),e.z(B.OVERLAY+1)]);e.add([e.text("Edit Player Name",{size:W.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]);const c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...O.BG_LIGHT),e.outline(2,e.rgb(...O.GOLD)),e.fixed(),e.z(B.OVERLAY+2)]);let r=t;const n=e.add([e.text(r,{size:W.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.OVERLAY+3)]),d=e.add([e.text("(Max 20 characters)",{size:W.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.OVERLAY+2)]);function u(){e.destroy(s),e.destroy(l),c.destroy(),n.destroy(),d.destroy()}const h=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(B.OVERLAY+2)]);e.add([e.text("Cancel",{size:W.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+3)]),h.onClick(()=>{u()});const y=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.GOLD)),e.area(),e.fixed(),e.z(B.OVERLAY+2)]);e.add([e.text("Save",{size:W.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.OVERLAY+3)]),y.onClick(()=>{r.trim().length>0?(o(r.trim()),u()):(d.text="Name cannot be empty!",d.color=e.rgb(255,100,100))}),e.onCharInput(f=>{r.length<20&&/[a-zA-Z0-9 ]/.test(f)&&(r+=f,n.text=r,d.text="(Max 20 characters)",d.color=e.rgb(...O.TEXT_SECONDARY))}),e.onKeyPress("backspace",()=>{r.length>0&&(r=r.slice(0,-1),n.text=r||" ")}),e.onKeyPress("escape",()=>{u()}),e.onKeyPress("enter",()=>{r.trim().length>0&&(o(r.trim()),u())})}function j0(e){e.scene("settings",t=>{const o=(t==null?void 0:t.fromGame)||!1;let s=Ea(),i="player";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...O.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),e.add([e.text(Ms("Settings"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const a=90,l=120,c=100,r=30,n=[{key:"player",label:"Player"},{key:"audio",label:"Audio"},{key:"controls",label:"Controls"},{key:"visual",label:"Visual"},{key:"gameplay",label:"Gameplay"}],d=(n.length-1)*l,u=e.width()/2-d/2,h=[];n.forEach((p,m)=>{const b=u+m*l,S=i===p.key,R=e.add([e.rect(c,r),e.pos(b,a),e.anchor("center"),e.color(S?100:50,S?100:50,S?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),P=e.add([e.text(p.label,{size:16}),e.pos(b,a),e.anchor("center"),e.color(S?255:150,S?255:150,S?255:150),e.fixed(),e.z(B.UI_TEXT)]);R.onClick(()=>{i=p.key,w()}),h.push({bg:R,label:P,key:p.key})});const y=140,f=50,A=150;let g=[];function w(){h.forEach(b=>{const S=i===b.key;b.bg.color=e.rgb(S?100:50,S?100:50,S?150:80),b.label.color=e.rgb(S?255:150,S?255:150,S?255:150)}),g.forEach(b=>{b.exists()&&e.destroy(b)}),g=[],s=Ea();const p=y+20;let m=p;if(i==="player"){const b=e.add([e.text("Player Name:",{size:W.LABEL}),e.pos(e.width()/2,m),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(b),m+=40;let S=An();const R=e.add([e.rect(300,40),e.pos(e.width()/2,m),e.anchor("center"),e.color(...O.BG_LIGHT),e.outline(2,e.rgb(...O.BORDER)),e.fixed(),e.z(B.UI_ELEMENTS)]),P=e.add([e.text(S,{size:W.LABEL}),e.pos(e.width()/2,m),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]);g.push(R,P),m+=60;const D=e.add([e.rect(140,35),e.pos(e.width()/2-80,m),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),I=e.add([e.text("Edit Name",{size:W.SMALL}),e.pos(e.width()/2-80,m),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);D.onClick(()=>{V0(e,S,V=>{kn(V),P.text=V,S=V})});const C=e.add([e.rect(140,35),e.pos(e.width()/2+80,m),e.anchor("center"),e.color(...O.BG_MEDIUM),e.outline(2,e.rgb(...O.GOLD)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),U=e.add([e.text("Randomize",{size:W.SMALL}),e.pos(e.width()/2+80,m),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]);C.onClick(()=>{const V=ji();kn(V),P.text=V,S=V}),g.push(D,I,C,U),m+=60;const Y=e.add([e.text("Your Invite Code:",{size:W.LABEL}),e.pos(e.width()/2,m),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(Y),m+=40;const G=ws(),K=e.add([e.text(G,{size:W.TITLE}),e.pos(e.width()/2,m),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(K),m+=50;const $=e.add([e.text("Share this code with friends to join your party!",{size:W.SMALL-2}),e.pos(e.width()/2,m),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push($)}else if(i==="audio")m=E(e,"Master Volume",s.audio.masterVolume,m,b=>{co("audio","masterVolume",b)}),m=E(e,"SFX Volume",s.audio.sfxVolume,m,b=>{co("audio","sfxVolume",b)}),m=E(e,"Music Volume",s.audio.musicVolume,m,b=>{co("audio","musicVolume",b)});else if(i==="controls"){const b=s.controls,S=[{label:"Move Up",key:"moveUp",value:b.moveUp},{label:"Move Down",key:"moveDown",value:b.moveDown},{label:"Move Left",key:"moveLeft",value:b.moveLeft},{label:"Move Right",key:"moveRight",value:b.moveRight},{label:"Pause",key:"pause",value:b.pause},{label:"Interact",key:"interact",value:b.interact}];S.forEach((P,D)=>{const I=p+D*f,C=e.add([e.text(P.label+":",{size:16}),e.pos(150,I),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(B.UI_ELEMENTS)]),U=e.add([e.rect(100,30),e.pos(500,I),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(B.UI_ELEMENTS)]),Y=e.add([e.text(P.value.toUpperCase(),{size:16}),e.pos(500,I),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]);g.push(C,U,Y)});const R=p+S.length*f;if(R<e.height()-A){const P=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,R+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(P)}}else if(i==="visual")m=T(e,"Show Particles",s.visual.showParticles,m,b=>{co("visual","showParticles",b)}),m=T(e,"Show Screen Shake",s.visual.showScreenShake,m,b=>{co("visual","showScreenShake",b)}),m=T(e,"Show Damage Numbers",s.visual.showDamageNumbers,m,b=>{co("visual","showDamageNumbers",b)}),m=T(e,"Compact HUD",s.visual.compactHUD,m,b=>{co("visual","compactHUD",b)});else if(i==="gameplay"&&(m=T(e,"Auto-pause on Level Up",s.gameplay.autoPause,m,b=>{co("gameplay","autoPause",b)}),m<e.height()-A)){const b=e.add([e.text("(More gameplay options coming soon)",{size:12}),e.pos(e.width()/2,m+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(b)}}function E(p,m,b,S,R){const P=p.add([p.text(m+":",{size:16}),p.pos(150,S),p.anchor("left"),p.color(200,200,200),p.fixed(),p.z(B.UI_ELEMENTS)]),D=300,I=20,C=p.add([p.rect(D,I),p.pos(500,S),p.anchor("center"),p.color(50,50,70),p.outline(2,p.rgb(100,100,120)),p.area(),p.fixed(),p.z(B.UI_ELEMENTS)]);function U(oe){if(oe<.5){const me=oe*2;return{r:255,g:Math.round(255*me),b:0}}else{const me=(oe-.5)*2;return{r:Math.round(255*(1-me)),g:255,b:0}}}const Y=D*b,G=U(b),K=p.add([p.rect(Y,I-4),p.pos(500-(D-Y)/2,S),p.anchor("center"),p.color(G.r,G.g,G.b),p.fixed(),p.z(B.UI_TEXT)]),$=500-D/2+Y,V=p.add([p.rect(20,I+4),p.pos($,S),p.anchor("center"),p.color(200,200,255),p.outline(2,p.rgb(150,150,200)),p.area(),p.fixed(),p.z(1002)]),ue=p.add([p.text(Math.round(b*100)+"%",{size:14}),p.pos(680,S),p.anchor("left"),p.color(255,255,255),p.fixed(),p.z(B.UI_ELEMENTS)]);let Q=!1;C.onClick(()=>{const oe=p.mousePos().x,me=500-D/2,Se=oe-me,Te=Math.max(0,Math.min(1,Se/D));we(Te)}),V.onClick(()=>{Q=!0}),p.onMouseMove(()=>{if(Q&&p.isMouseDown()){const oe=p.mousePos().x,me=500-D/2,Se=oe-me,Te=Math.max(0,Math.min(1,Se/D));we(Te)}else Q=!1}),p.onMouseRelease(()=>{Q=!1});function we(oe){const me=D*oe;K.width=me,K.pos.x=500-(D-me)/2,V.pos.x=500-D/2+me,ue.text=Math.round(oe*100)+"%";const Se=U(oe);K.color=p.rgb(Se.r,Se.g,Se.b),R(oe)}return g.push(P,C,K,V,ue),S+f}function T(p,m,b,S,R){const P=p.add([p.text(m+":",{size:16,width:250}),p.pos(150,S),p.anchor("left"),p.color(200,200,200),p.fixed(),p.z(B.UI_ELEMENTS)]),D=60,C=p.add([p.rect(D,30),p.pos(500,S),p.anchor("center"),p.color(b?50:70,b?150:50,b?50:70),p.outline(2,p.rgb(100,100,120)),p.area(),p.fixed(),p.z(B.UI_ELEMENTS)]),U=24,Y=b?500+D/2-U/2-4:500-D/2+U/2+4,G=p.add([p.rect(U,U),p.pos(Y,S),p.anchor("center"),p.color(255,255,255),p.outline(1,p.rgb(200,200,200)),p.fixed(),p.z(B.UI_TEXT)]),K=p.add([p.text(b?"ON":"OFF",{size:14}),p.pos(500,S),p.anchor("center"),p.color(b?100:150,b?255:150,b?100:150),p.fixed(),p.z(1002)]);return C.onClick(()=>{const $=!b;C.color=p.rgb($?50:70,$?150:50,$?50:70),G.pos.x=$?500+D/2-U/2-4:500-D/2+U/2+4,K.text=$?"ON":"OFF",K.color=p.rgb($?100:150,$?255:150,$?100:150),R($)}),g.push(P,C,G,K),S+f}const z=e.add([e.rect(150,35),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text("Reset to Defaults",{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(B.UI_TEXT)]),z.onClick(()=>{K0(),w()}),w();const q=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-125),e.anchor("center"),e.color(80,80,100),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text("Back",{size:14}),e.pos(e.width()/2,e.height()-125),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(B.UI_TEXT)]),q.onClick(()=>{o?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{o?e.go("game"):e.go("menu")})})}function W0(e){e.scene("statistics",()=>{const t=Ur(),o=Gu(),s=vs();let i="stats";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...O.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),e.add([e.text(Ms("Statistics & Achievements"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const a=90,l=120,c=150,r=30,n=[{key:"stats",label:"Statistics"},{key:"achievements",label:"Achievements"}],d=(n.length-1)*l,u=e.width()/2-d/2,h=[];n.forEach((R,P)=>{const D=u+P*l,I=i===R.key,C=e.add([e.rect(c,r),e.pos(D,a),e.anchor("center"),e.color(...I?O.SECONDARY:O.BG_MEDIUM),e.outline(2,e.rgb(...O.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),U=e.add([e.text(R.label,{size:W.BODY}),e.pos(D,a),e.anchor("center"),e.color(...I?O.TEXT_PRIMARY:O.TEXT_TERTIARY),e.fixed(),e.z(B.UI_TEXT)]);C.onClick(()=>{i=R.key,z=0,p()}),h.push({bg:C,label:U,key:R.key})});const y=140,f=40,A=60,g=f+A,w=y,E=e.height()-g;let T=[],z=0;const q=50;function p(){if(h.forEach(R=>{const P=i===R.key;R.bg.color=e.rgb(P?100:50,P?100:50,P?150:80),R.label.color=e.rgb(P?255:150,P?255:150,P?255:150)}),T.forEach(R=>{R.exists()&&e.destroy(R)}),T=[],i==="stats"){const R=y+20,P=30;[{label:"Total Runs",value:t.totalRuns||0},{label:"Best Floor",value:t.bestFloor||1},{label:"Best Room",value:t.bestRoom||1},{label:"Best Level",value:t.bestLevel||1},{label:"Total Enemies Killed",value:t.totalEnemiesKilled||0},{label:"Total Bosses Killed",value:t.totalBossesKilled||0},{label:"Total Rooms Cleared",value:t.totalRoomsCleared||0},{label:"Total Floors Reached",value:t.totalFloorsReached||0},{label:`Total ${s} Earned`,value:t.totalCurrencyEarned||0}].forEach((I,C)=>{const U=R+C*P,Y=e.add([e.text(I.label+":",{size:18}),e.pos(200,U),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]),G=e.add([e.text(I.value.toString(),{size:18}),e.pos(500,U),e.anchor("left"),e.color(255,255,255),e.fixed(),e.z(1e3)]);T.push(Y,G)})}else if(i==="achievements"){const R=Ns();let P=y+20-z,D=0;R.forEach(K=>{D+=35;const $=os(K);D+=$.length*50,D+=20});const I=E-w,C=Math.max(0,D-I);z=Math.max(0,Math.min(z,C)),P=y+20-z,R.forEach(K=>{const $=K.charAt(0).toUpperCase()+K.slice(1),V=P;if(V>=w-35&&V<=E){const Q=e.add([e.text($,{size:20}),e.pos(e.width()/2,V),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(1e3)]);T.push(Q)}P+=35;const ue=os(K);ue.forEach((Q,we)=>{const oe=o.includes(Q.id),me=P+we*50,Se=me-22.5;if(me+22.5>=w&&Se<=E){const Ve=e.add([e.rect(700,45),e.pos(e.width()/2,me),e.anchor("center"),e.color(oe?40:30,oe?40:30,oe?50:30),e.outline(2,e.rgb(oe?100:50,oe?100:50,oe?150:50)),e.fixed(),e.z(1e3)]),it=e.add([e.text(Q.icon,{size:24}),e.pos(50,me),e.anchor("left"),e.color(oe?255:100,oe?255:100,oe?255:100),e.fixed(),e.z(1001)]),je=e.add([e.text(Q.name,{size:18}),e.pos(100,me-10),e.anchor("left"),e.color(oe?255:150,oe?255:150,oe?255:150),e.fixed(),e.z(1001)]),k=e.add([e.text(Q.description,{size:14}),e.pos(100,me+10),e.anchor("left"),e.color(oe?200:100,oe?200:100,oe?200:100),e.fixed(),e.z(1001)]),se=e.add([e.text(oe?"UNLOCKED":"LOCKED",{size:14}),e.pos(650,me),e.anchor("right"),e.color(oe?100:150,oe?255:150,oe?100:150),e.fixed(),e.z(1001)]);T.push(Ve,it,je,k,se)}}),P+=ue.length*50+20});const U=Object.keys(ui).length,Y=o.length,G=e.add([e.text(`Progress: ${Y}/${U} (${Math.round(Y/U*100)}%)`,{size:16}),e.pos(e.width()/2,e.height()-A-f/2),e.anchor("center"),e.color(200,200,255),e.fixed(),e.z(1e3)]);T.push(G)}}p();const m=R=>{if(i==="achievements"){R.preventDefault(),R.stopPropagation();const P=z;z+=R.deltaY*.3;const D=Ns();let I=0;D.forEach(Y=>{I+=35;const G=os(Y);I+=G.length*50,I+=20});const C=E-w,U=Math.max(0,I-C);z=Math.max(0,Math.min(z,U)),z!==P&&p()}},b=document.querySelector("#game-container");b&&b.addEventListener("wheel",m,{passive:!1}),e.onDestroy(()=>{b&&b.removeEventListener("wheel",m)}),e.onKeyPress("arrowdown",()=>{if(i==="achievements"){const R=z;z+=q;const P=Ns();let D=0;P.forEach(U=>{D+=35;const Y=os(U);D+=Y.length*50,D+=20});const I=E-w,C=Math.max(0,D-I);z=Math.max(0,Math.min(z,C)),z!==R&&p()}}),e.onKeyPress("arrowup",()=>{if(i==="achievements"){const R=z;z-=q;const P=Ns();let D=0;P.forEach(U=>{D+=35;const Y=os(U);D+=Y.length*50,D+=20});const I=E-w,C=Math.max(0,D-I);z=Math.max(0,Math.min(z,C)),z!==R&&p()}});const S=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(80,80,100),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(1e3)]);e.add([e.text("Back",{size:16}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(1001)]),S.onClick(()=>{e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}function $0(e){e.scene("characterSelect",()=>{const t=mo(),o=vs(),s=bn();e.add([e.text(`${o}: ${t}`,{size:W.LABEL}),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]),e.add([e.text("Select Character",{size:W.TITLE}),e.pos(e.width()/2,60),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.z(B.UI_TEXT)]);const i=Object.keys(xo),l=350+20,c=e.width()-l-20,r=120,n=150,d=100,u=15,h=2,f=3*(d+u),A=Math.ceil(i.length/h);let g=0;const w=[];let E=s,T=[],z=!1;function q(){if(z)return;z=!0;const S=Math.max(0,A*(d+u)-f);w.forEach(V=>{V&&V.exists&&V.exists()&&e.destroy(V)}),w.length=0,T.forEach(V=>{V&&V.exists&&V.exists()&&e.destroy(V)}),T=[],g=Math.max(0,Math.min(g,S)),i.forEach((V,ue)=>{const Q=xo[V],we=po("characters",V)||Q.unlockedByDefault,oe=E===V,me=Math.floor(ue/h),Te=20+ue%h*(n+u),Ve=r+me*(d+u)-g;if(Ve>=r-d&&Ve<=r+f){const it=e.add([e.rect(n,d),e.pos(Te,Ve),e.anchor("topleft"),e.color(...oe?O.BG_MEDIUM:O.BG_DARK),e.outline(2,oe?e.rgb(...O.BORDER_ACTIVE):we?e.rgb(...O.TEXT_DISABLED):e.rgb(...O.BG_DARK)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),je=e.add([e.text(Q.char,{size:W.TITLE}),e.pos(Te+n/2,Ve+30),e.anchor("center"),e.color(...we?Q.color:O.BG_DISABLED),e.fixed(),e.z(B.UI_TEXT)]),k=e.add([e.text(Q.name,{size:W.SMALL}),e.pos(Te+n/2,Ve+70),e.anchor("center"),e.color(...we?O.TEXT_PRIMARY:O.TEXT_DISABLED),e.fixed(),e.z(B.UI_TEXT)]);if(!we){const se=e.add([e.text("",{size:W.BUTTON}),e.pos(Te+n/2,Ve+d/2),e.anchor("center"),e.color(...O.DANGER),e.fixed(),e.z(B.OVERLAY)]);w.push(se)}we&&(it.onClick(()=>{E!==V&&(Ut(),E=V,Fu(V),q())}),it.cursor="pointer"),w.push(it,je,k)}});const R=xo[E],P=po("characters",E)||R.unlockedByDefault;let D=r;const I=e.add([e.text(R.char,{size:72}),e.pos(l+c/2,D+40),e.anchor("center"),e.color(...P?R.color:O.BG_DISABLED),e.fixed(),e.z(B.UI_ELEMENTS)]);T.push(I),D+=100;const C=e.add([e.text(R.name,{size:W.HEADER}),e.pos(l+c/2,D),e.anchor("center"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);T.push(C),D+=40;const U=e.add([e.text(R.description,{size:W.SMALL,width:c-40}),e.pos(l+c/2,D),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]);T.push(U),D+=60;const Y=e.add([e.text("Stats:",{size:W.LABEL}),e.pos(l+20,D),e.anchor("left"),e.color(...O.WARNING),e.fixed(),e.z(B.UI_TEXT)]);T.push(Y),D+=30;const G=e.add([e.text(`${Do.HEALTH}: ${R.stats.health}`,{size:W.BODY}),e.pos(l+40,D),e.anchor("left"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);T.push(G),D+=25;const K=e.add([e.text(`${Do.SPEED}: ${R.stats.speed}`,{size:W.BODY}),e.pos(l+40,D),e.anchor("left"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);T.push(K),D+=25;const $=e.add([e.text(`${Do.DAMAGE}: ${R.stats.damage}`,{size:W.BODY}),e.pos(l+40,D),e.anchor("left"),e.color(...O.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);if(T.push($),D+=40,E===R){const V=e.add([e.text(" SELECTED",{size:W.LABEL}),e.pos(l+c/2,D),e.anchor("center"),e.color(...O.SUCCESS),e.fixed(),e.z(B.UI_TEXT)]);T.push(V)}if(!P&&R.unlockRequirement){const V=e.add([e.text(`Unlock: Complete ${Do.FLOOR} ${R.unlockRequirement.value}`,{size:W.SMALL}),e.pos(l+c/2,D+30),e.anchor("center"),e.color(...O.GOLD),e.fixed(),e.z(B.UI_TEXT)]);T.push(V)}z=!1}q();const p=S=>{S.preventDefault(),S.stopPropagation();const R=g,P=Math.max(0,A*(d+u)-f);g+=S.deltaY*.3,g=Math.max(0,Math.min(g,P)),g!==R&&q()},m=document.querySelector("#game-container");m&&m.addEventListener("wheel",p,{passive:!1}),e.onDestroy(()=>{m&&m.removeEventListener("wheel",p)}),e.onKeyPress("arrowdown",()=>{const S=g,R=Math.max(0,A*(d+u)-f);g+=50,g=Math.max(0,Math.min(g,R)),g!==S&&q()}),e.onKeyPress("arrowup",()=>{const S=g,R=Math.max(0,A*(d+u)-f);g-=50,g=Math.max(0,Math.min(g,R)),g!==S&&q()});const b=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...O.NEUTRAL),e.outline(2,e.rgb(...O.NEUTRAL)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text(Ms("Back"),{size:W.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...O.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),b.onClick(()=>{xt(),e.go("menu")}),e.add([e.text("Click a character to select | Press SPACE to start",{size:W.BODY}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(...O.TEXT_TERTIARY),e.fixed(),e.z(B.UI_TEXT)]),e.onKeyPress("escape",()=>{xt(),e.go("menu")}),e.onKeyPress("space",()=>{Ut(),e.go("game",{resetState:!0})})})}const vo=Bu({width:es.CANVAS_WIDTH,height:es.CANVAS_HEIGHT,background:es.BACKGROUND_COLOR,scale:es.CANVAS_SCALE,debug:es.DEBUG_MODE,root:document.querySelector("#game-container")});X0(vo);F0(vo);Y0(vo);G0(vo);j0(vo);W0(vo);$0(vo);vo.go("menu");
