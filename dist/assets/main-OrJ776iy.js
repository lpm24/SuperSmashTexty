var Al=Object.defineProperty;var vl=(e,t,o)=>t in e?Al(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var L=(e,t,o)=>vl(e,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();var Ml=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return o=>{for(var s=o.length,i=new Uint8Array((s-(o[s-1]=="=")-(o[s-2]=="="))*3/4|0),a=0,l=0;a<s;){var c=e[o.charCodeAt(a++)],r=e[o.charCodeAt(a++)],n=e[o.charCodeAt(a++)],d=e[o.charCodeAt(a++)];i[l++]=c<<2|r>>4,i[l++]=r<<4|n>>2,i[l++]=n<<6|d}return i}})(),El={version:"3001.0.19"};function Qt(e,t,o){return t>o?Qt(e,o,t):Math.min(Math.max(e,t),o)}var Be,Ie=(Be=class{constructor(t,o,s){L(this,"r",255);L(this,"g",255);L(this,"b",255);this.r=Qt(t,0,255),this.g=Qt(o,0,255),this.b=Qt(s,0,255)}static fromArray(t){return new Be(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new Be(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!o)throw new Error("Invalid hex color format");return new Be(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,o,s){if(o==0)return new Be(255*s,255*s,255*s);let i=(d,u,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<1/6?d+(u-d)*6*h:h<1/2?u:h<2/3?d+(u-d)*(2/3-h)*6:d),a=s<.5?s*(1+o):s+o-s*o,l=2*s-a,c=i(l,a,t+1/3),r=i(l,a,t),n=i(l,a,t-1/3);return new Be(Math.round(c*255),Math.round(r*255),Math.round(n*255))}clone(){return new Be(this.r,this.g,this.b)}lighten(t){return new Be(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new Be(255-this.r,255-this.g,255-this.b)}mult(t){return new Be(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,o){return new Be(Rt(this.r,t.r,o),Rt(this.g,t.g,o),Rt(this.b,t.b,o))}toHSL(){let t=this.r/255,o=this.g/255,s=this.b/255,i=Math.max(t,o,s),a=Math.min(t,o,s),l=(i+a)/2,c=l,r=l;if(i==a)l=c=0;else{let n=i-a;switch(c=r>.5?n/(2-i-a):n/(i+a),i){case t:l=(o-s)/n+(o<s?6:0);break;case o:l=(s-t)/n+2;break;case s:l=(t-o)/n+4;break}l/=6}return[l,c,r]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}},L(Be,"RED",new Be(255,0,0)),L(Be,"GREEN",new Be(0,255,0)),L(Be,"BLUE",new Be(0,0,255)),L(Be,"YELLOW",new Be(255,255,0)),L(Be,"MAGENTA",new Be(255,0,255)),L(Be,"CYAN",new Be(0,255,255)),L(Be,"WHITE",new Be(255,255,255)),L(Be,"BLACK",new Be(0,0,0)),Be);function Le(...e){if(e.length===0)return new Ie(255,255,255);if(e.length===1){if(e[0]instanceof Ie)return e[0].clone();if(typeof e[0]=="string")return Ie.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Ie.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof Ie)return e[0].clone()}else if(e.length===3||e.length===4)return new Ie(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var Sl=(e,t,o)=>Ie.fromHSL(e,t,o);function st(e){return e*Math.PI/180}function Bo(e){return e*180/Math.PI}function Rt(e,t,o){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*o;if(e instanceof _&&t instanceof _||e instanceof Ie&&t instanceof Ie)return e.lerp(t,o);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function $t(e,t,o,s,i){return s+(e-t)/(o-t)*(i-s)}function Rl(e,t,o,s,i){return Qt($t(e,t,o,s,i),s,i)}var He,_=(He=class{constructor(t=0,o=t){L(this,"x",0);L(this,"y",0);this.x=t,this.y=o}static fromAngle(t){let o=st(t);return new He(Math.cos(o),Math.sin(o))}static fromArray(t){return new He(t[0],t[1])}clone(){return new He(this.x,this.y)}add(...t){let o=H(...t);return new He(this.x+o.x,this.y+o.y)}sub(...t){let o=H(...t);return new He(this.x-o.x,this.y-o.y)}scale(...t){let o=H(...t);return new He(this.x*o.x,this.y*o.y)}dist(...t){let o=H(...t);return this.sub(o).len()}sdist(...t){let o=H(...t);return this.sub(o).slen()}static sdist(t,o){let s=t.x-o.x,i=t.y-o.y;return s*s+i*i}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new He(0):this.scale(1/t)}normal(){return new He(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,o){return t.x*o.x+t.y*o.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,o){return t.x*o.y-t.y*o.x}angle(...t){let o=H(...t);return Bo(Math.atan2(this.y-o.y,this.x-o.x))}angleBetween(...t){let o=H(...t);return Bo(Math.atan2(this.cross(o),this.dot(o)))}lerp(t,o){return new He(Rt(this.x,t.x,o),Rt(this.y,t.y,o))}slerp(t,o){let s=this.dot(t),i=this.cross(t),a=Math.atan2(i,s);return this.scale(Math.sin((1-o)*a)).add(t.scale(Math.sin(o*a))).scale(1/i)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new He(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Fe(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}},L(He,"ZERO",new He(0,0)),L(He,"ONE",new He(1,1)),L(He,"LEFT",new He(-1,0)),L(He,"RIGHT",new He(1,0)),L(He,"UP",new He(0,-1)),L(He,"DOWN",new He(0,1)),He);function H(...e){if(e.length===1){if(e[0]instanceof _)return new _(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new _(...e[0])}return new _(...e)}var Je=class Pi{constructor(t,o,s,i){L(this,"x",0);L(this,"y",0);L(this,"w",1);L(this,"h",1);this.x=t,this.y=o,this.w=s,this.h=i}scale(t){return new Pi(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new _(this.x,this.y)}clone(){return new Pi(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function ot(e,t,o,s){return new Je(e,t,o,s)}var Ys=class Xo{constructor(t,o,s,i){L(this,"a");L(this,"b");L(this,"c");L(this,"d");this.a=t,this.b=o,this.c=s,this.d=i}mul(t){return new Xo(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return H(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new Xo(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new Xo(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,o=this.det,s=t+Math.sqrt(t*t-o),i=t-Math.sqrt(t*t-o);return[s,i]}eigenvectors(t,o){return this.c!=0?[[t-this.d,this.c],[o-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,o-this.a]]:Math.abs(this.transform(H(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let o=Math.cos(t),s=Math.sin(t);return new Xo(o,s,-s,o)}static scale(t,o){return new Xo(t,0,0,o)}},is=class ns{constructor(t,o,s,i,a,l,c,r,n){L(this,"m11");L(this,"m12");L(this,"m13");L(this,"m21");L(this,"m22");L(this,"m23");L(this,"m31");L(this,"m32");L(this,"m33");this.m11=t,this.m12=o,this.m13=s,this.m21=i,this.m22=a,this.m23=l,this.m31=c,this.m32=r,this.m33=n}static fromMat2(t){return new ns(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new Ys(this.m11,this.m12,this.m21,this.m22)}mul(t){return new ns(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let o=Math.cos(t),s=Math.sin(t),i=this.m11,a=this.m12;return this.m11=o*this.m11+s*this.m21,this.m12=o*this.m12+s*this.m22,this.m21=o*this.m21-s*i,this.m22=o*this.m22-s*a,this}scale(t,o){return this.m11*=t,this.m12*=t,this.m21*=o,this.m22*=o,this}get inverse(){let t=this.det;return new ns((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new ns(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},Zt=class so{constructor(t){L(this,"m",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);t&&(this.m=t)}static translate(t){return new so([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new so([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t);return new so([1,0,0,0,0,o,-s,0,0,s,o,0,0,0,0,1])}static rotateY(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t);return new so([o,0,s,0,0,1,0,0,-s,0,o,0,0,0,0,1])}static rotateZ(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t);return new so([o,-s,0,0,s,o,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t),i=this.m[0],a=this.m[1],l=this.m[4],c=this.m[5];return this.m[0]=i*o+a*s,this.m[1]=-i*s+a*o,this.m[4]=l*o+c*s,this.m[5]=-l*s+c*o,this}mult(t){let o=[];for(let s=0;s<4;s++)for(let i=0;i<4;i++)o[s*4+i]=this.m[0*4+i]*t.m[s*4+0]+this.m[1*4+i]*t.m[s*4+1]+this.m[2*4+i]*t.m[s*4+2]+this.m[3*4+i]*t.m[s*4+3];return new so(o)}multVec2(t){return new _(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new _(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new _(o,t/o)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new _(t/o,o)}else return new _(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return Bo(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return Bo(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new _(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new _(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new _(0,0)}invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],s=this.m[9]*this.m[15]-this.m[13]*this.m[11],i=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],l=this.m[8]*this.m[14]-this.m[12]*this.m[10],c=this.m[8]*this.m[13]-this.m[12]*this.m[9],r=this.m[6]*this.m[15]-this.m[14]*this.m[7],n=this.m[5]*this.m[15]-this.m[13]*this.m[7],d=this.m[5]*this.m[14]-this.m[13]*this.m[6],u=this.m[4]*this.m[15]-this.m[12]*this.m[7],h=this.m[4]*this.m[14]-this.m[12]*this.m[6],x=this.m[5]*this.m[15]-this.m[13]*this.m[7],f=this.m[4]*this.m[13]-this.m[12]*this.m[5],A=this.m[6]*this.m[11]-this.m[10]*this.m[7],g=this.m[5]*this.m[11]-this.m[9]*this.m[7],w=this.m[5]*this.m[10]-this.m[9]*this.m[6],E=this.m[4]*this.m[11]-this.m[8]*this.m[7],T=this.m[4]*this.m[10]-this.m[8]*this.m[6],q=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*s+this.m[7]*i,t[4]=-(this.m[4]*o-this.m[6]*a+this.m[7]*l),t[8]=this.m[4]*s-this.m[5]*a+this.m[7]*c,t[12]=-(this.m[4]*i-this.m[5]*l+this.m[6]*c),t[1]=-(this.m[1]*o-this.m[2]*s+this.m[3]*i),t[5]=this.m[0]*o-this.m[2]*a+this.m[3]*l,t[9]=-(this.m[0]*s-this.m[1]*a+this.m[3]*c),t[13]=this.m[0]*i-this.m[1]*l+this.m[2]*c,t[2]=this.m[1]*r-this.m[2]*n+this.m[3]*d,t[6]=-(this.m[0]*r-this.m[2]*u+this.m[3]*h),t[10]=this.m[0]*x-this.m[1]*u+this.m[3]*f,t[14]=-(this.m[0]*d-this.m[1]*h+this.m[2]*f),t[3]=-(this.m[1]*A-this.m[2]*g+this.m[3]*w),t[7]=this.m[0]*A-this.m[2]*E+this.m[3]*T,t[11]=-(this.m[0]*g-this.m[1]*E+this.m[3]*q),t[15]=this.m[0]*w-this.m[1]*T+this.m[2]*q;let U=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let p=0;p<4;p++)for(let y=0;y<4;y++)t[p*4+y]*=1/U;return new so(t)}clone(){return new so([...this.m])}toString(){return this.m.toString()}};function Ta(e,t,o,s=i=>-Math.cos(i)){return e+(s(o)+1)/2*(t-e)}var Tl=1103515245,Dl=12345,Nn=2147483648,Da=class{constructor(e){L(this,"seed");this.seed=e}gen(){return this.seed=(Tl*this.seed+Dl)%Nn,this.seed/Nn}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new _(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new Ie(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof _)return this.genVec2(H(0,0),e[0]);if(e[0]instanceof Ie)return this.genColor(Le(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof _&&e[1]instanceof _)return this.genVec2(e[0],e[1]);if(e[0]instanceof Ie&&e[1]instanceof Ie)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},Bi=new Da(Date.now());function Cl(e){return e!=null&&(Bi.seed=e),Bi.seed}function ht(...e){return Bi.genAny(...e)}function Ca(...e){return Math.floor(ht(...e.length>0?e:[2]))}function Il(e){return ht()<=e}function Ia(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Pl(e,t){return e.length<=t?e.slice():Ia(e.slice()).slice(0,t)}function Bl(e){return e[Ca(e.length)]}function Pa(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function Ol(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let o=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(o===0)return null;let s=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/o,i=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/o;return s<0||s>1||i<0||i>1?null:s}function an(e,t){let o=Ol(e,t);return o?H(e.p1.x+o*(e.p2.x-e.p1.x),e.p1.y+o*(e.p2.y-e.p1.y)):null}function rn(e,t){let o=t.p2.sub(t.p1),s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;if(o.x!=0){let a=(e.pos.x-t.p1.x)/o.x,l=(e.pos.x+e.width-t.p1.x)/o.x;s=Math.max(s,Math.min(a,l)),i=Math.min(i,Math.max(a,l))}if(o.y!=0){let a=(e.pos.y-t.p1.y)/o.y,l=(e.pos.y+e.height-t.p1.y)/o.y;s=Math.max(s,Math.min(a,l)),i=Math.min(i,Math.max(a,l))}return i>=s&&i>=0&&s<=1}function si(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Ba(e,t){let o=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),s=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return H(o,s).sdist(t.center)<=t.radius*t.radius}function Oa(e,t){return La(t,new At(e.points()))}function ln(e,t){let o=t.sub(e.p1),s=e.p2.sub(e.p1);if(Math.abs(o.cross(s))>Number.EPSILON)return!1;let i=o.dot(s)/s.dot(s);return i>=0&&i<=1}function vs(e,t){let o=e.p2.sub(e.p1),s=o.dot(o),i=e.p1.sub(t.center),a=2*o.dot(i),l=i.dot(i)-t.radius*t.radius,c=a*a-4*s*l;if(s<=Number.EPSILON||c<0)return!1;if(c==0){let r=-a/(2*s);if(r>=0&&r<=1)return!0}else{let r=(-a+Math.sqrt(c))/(2*s),n=(-a-Math.sqrt(c))/(2*s);if(r>=0&&r<=1||n>=0&&n<=1)return!0}return ii(t,e.p1)}function cn(e,t){if(Mo(t,e.p1)||Mo(t,e.p2))return!0;for(let o=0;o<t.pts.length;o++){let s=t.pts[o],i=t.pts[(o+1)%t.pts.length];if(an(e,new Dt(s,i)))return!0}return!1}function ii(e,t){return e.center.sdist(t)<e.radius*e.radius}function Ll(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function ni(e,t){let o=t.pts[t.pts.length-1];for(let s of t.pts){if(vs(new Dt(o,s),e))return!0;o=s}return ii(e,t.pts[0])?!0:Mo(t,e.center)}function La(e,t){for(let o=0;o<e.pts.length;o++)if(cn(new Dt(e.pts[o],e.pts[(o+1)%e.pts.length]),t))return!0;return!!(e.pts.some(o=>Mo(t,o))||t.pts.some(o=>Mo(e,o)))}function Mo(e,t){let o=!1,s=e.pts;for(let i=0,a=s.length-1;i<s.length;a=i++)s[i].y>t.y!=s[a].y>t.y&&t.x<(s[a].x-s[i].x)*(t.y-s[i].y)/(s[a].y-s[i].y)+s[i].x&&(o=!o);return o}function hn(e,t){t=t.sub(e.center);let o=st(e.angle),s=Math.cos(o),i=Math.sin(o),a=t.x*s+t.y*i,l=-t.x*i+t.y*s;return a*a/(e.radiusX*e.radiusX)+l*l/(e.radiusY*e.radiusY)<1}function Xs(e,t){let o=t.center.sub(e.center),s=st(e.angle),i=Math.cos(s),a=Math.sin(s),l=o.x*i+o.y*a,c=-o.x*a+o.y*i;return hn(new uo(H(),e.radiusX+t.radius,e.radiusY+t.radius,0),H(l,c))}function za(e,t){let o=e.toMat2().inverse;return t=new Dt(o.transform(t.p1.sub(e.center)),o.transform(t.p2.sub(e.center))),vs(t,new Tt(H(),1))}function zl(e,t){if(e.radiusX===e.radiusY)return Xs(t,new Tt(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Xs(e,new Tt(t.center,t.radiusX));let o=new is(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),s=new is(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),i=e.center.x,a=e.center.y,l=t.center.x,c=t.center.y,r=st(e.angle),n=st(t.angle),d=new is(Math.cos(r),-Math.sin(r),i,Math.sin(r),Math.cos(r),a,0,0,1),u=new is(Math.cos(n),-Math.sin(n),l,Math.sin(n),Math.cos(n),c,0,0,1),h=d.inverse,x=u.inverse,f=h.transpose.mul(o).mul(h),A=x.transpose.mul(s).mul(x),g=f.m11,w=f.m12,E=f.m13,T=f.m21,q=f.m22,U=f.m23,p=f.m31,y=f.m32,b=f.m33,v=A.m11,D=A.m12,P=A.m13,O=A.m21,I=A.m22,R=A.m23,N=A.m31,Y=A.m32,j=A.m33,k=g*q*b-g*U*y-w*T*b+w*U*p+E*T*y-E*q*p,G=(g*q*j-g*U*Y-g*y*R+g*b*I-w*T*j+w*U*N+w*p*R-w*b*O+E*T*Y-E*q*N-E*p*I+E*y*O+T*y*P-T*b*D-q*p*P+q*b*v+U*p*D-U*y*v)/k,Q=(g*I*j-g*R*Y-w*O*j+w*R*N+E*O*Y-E*I*N-T*D*j+T*P*Y+q*v*j-q*P*N-U*v*Y+U*D*N+p*D*R-p*P*I-y*v*R+y*P*O+b*v*I-b*D*O)/k,pe=(v*I*j-v*R*Y-D*O*j+D*R*N+P*O*Y-P*I*N)/k;if(G>=0){let ee=-3*Q+G**2,De=3*G*pe+Q*G**2-4*Q**2,ye=-27*pe**2+18*pe*G*Q+G**2*Q**2-4*G**3*pe-4*Q**3;return!(ee>0&&De<0&&ye>0)}else{let ee=-3*Q+G**2,De=-27*pe**2+18*pe*G*Q+G**2*Q**2-4*G**3*pe-4*Q**3;return!(ee>0&&De>0)}}function Ha(e,t){return dn(e,new At(t.points()))}function dn(e,t){let o=e.toMat2().inverse;return t=new At(t.pts.map(s=>o.transform(s.sub(e.center)))),ni(new Tt(H(),1),t)}function Hl(e,t){return e.x===t.x&&e.y===t.y}function Nl(e,t){return t instanceof _?Hl(t,e.pt):t instanceof Tt?ii(t,e.pt):t instanceof Dt?ln(t,e.pt):t instanceof Fe?si(t,e.pt):t instanceof At?Mo(t,e.pt):t instanceof uo?hn(t,e.pt):!1}function Ul(e,t){return t instanceof _?ln(e,t):t instanceof Tt?vs(e,t):t instanceof Dt?an(e,t)!=null:t instanceof Fe?rn(t,e):t instanceof At?cn(e,t):t instanceof uo?za(t,e):!1}function ql(e,t){return t instanceof _?ii(e,t):t instanceof Tt?Ll(e,t):t instanceof Dt?vs(t,e):t instanceof Fe?Ba(t,e):t instanceof At?ni(e,t):t instanceof uo?Xs(t,e):!1}function _l(e,t){return t instanceof _?si(e,t):t instanceof Tt?Ba(e,t):t instanceof Dt?rn(e,t):t instanceof Fe?Pa(e,t):t instanceof At?Oa(e,t):t instanceof uo?Ha(t,e):!1}function Fl(e,t){return t instanceof _?Mo(e,t):t instanceof Tt?ni(t,e):t instanceof Dt?cn(t,e):t instanceof Fe?Oa(t,e):t instanceof At?La(t,e):t instanceof uo?dn(t,e):!1}function Yl(e,t){return t instanceof _?hn(e,t):t instanceof Tt?Xs(e,t):t instanceof Dt?za(e,t):t instanceof Fe?Ha(e,t):t instanceof At?dn(e,t):t instanceof uo?zl(t,e):!1}function Na(e,t,o){let s=e,i=o.p1,a=o.p2,l=t,c=a.sub(i),r=l.cross(c);if(Math.abs(r)<Number.EPSILON)return null;let n=i.sub(s),d=n.cross(c)/r;if(d<=0||d>=1)return null;let u=n.cross(l)/r;if(u<=0||u>=1)return null;let h=c.normal().unit();return t.dot(h)>0&&(h.x*=-1,h.y*=-1),{point:s.add(l.scale(d)),normal:h,fraction:d}}function Xl(e,t,o){let s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY,a;if(e.x!=0){let l=(o.pos.x-e.x)/t.x,c=(o.pos.x+o.width-e.x)/t.x;a=H(-Math.sign(t.x),0),s=Math.max(s,Math.min(l,c)),i=Math.min(i,Math.max(l,c))}if(e.y!=0){let l=(o.pos.y-e.y)/t.y,c=(o.pos.y+o.height-e.y)/t.y;Math.min(l,c)>s&&(a=H(0,-Math.sign(t.y))),s=Math.max(s,Math.min(l,c)),i=Math.min(i,Math.max(l,c))}return i>=s&&s>=0&&s<=1?{point:e.add(t.scale(s)),normal:a,fraction:s}:null}function Ua(e,t,o){let s=e,i=o.center,a=t,l=a.dot(a),c=s.sub(i),r=2*a.dot(c),n=c.dot(c)-o.radius*o.radius,d=r*r-4*l*n;if(l<=Number.EPSILON||d<0)return null;if(d==0){let u=-r/(2*l);if(u>=0&&u<=1){let h=s.add(a.scale(u));return{point:h,normal:h.sub(i),fraction:u}}}else{let u=(-r+Math.sqrt(d))/(2*l),h=(-r-Math.sqrt(d))/(2*l),x=null;if(u>=0&&u<=1&&(x=u),h>=0&&h<=1&&(x=Math.min(h,x??h)),x!=null){let f=s.add(a.scale(x));return{point:f,normal:f.sub(i).unit(),fraction:x}}}return null}function Gl(e,t,o){let s=o.pts,i=null,a=s[s.length-1];for(let l=0;l<s.length;l++){let c=s[l],r=Na(e,t,new Dt(a,c));r&&(!i||i.fraction>r.fraction)&&(i=r),a=c}return i}function Kl(e,t,o){let s=o.toMat2(),i=s.inverse,a=i.transform(e.sub(o.center)),l=i.transform(t),c=Ua(a,l,new Tt(H(),1));if(c){let r=Ys.rotation(st(-o.angle)),n=Ys.scale(o.radiusX,o.radiusY).transform(c.point),d=s.transform(c.point).add(o.center),u=d.dist(e)/t.len();return{point:d,normal:r.transform(H(o.radiusY**2*n.x,o.radiusX**2*n.y)).unit(),fraction:u}}return c}function Vl(e,t,o,s=64){let i=e,a=t.len(),l=t.scale(1/a),c=0,r=H(Math.floor(e.x),Math.floor(e.y)),n=H(l.x>0?1:-1,l.y>0?1:-1),d=H(Math.abs(1/l.x),Math.abs(1/l.y)),u=H(n.x>0?r.x+1-e.x:e.x-r.x,n.y>0?r.y+1-e.y:e.y-r.y),h=H(d.x<1/0?d.x*u.x:1/0,d.y<1/0?d.y*u.y:1/0),x=-1;for(;c<=s;){let f=o(r);if(f===!0)return{point:i.add(l.scale(c)),normal:H(x===0?-n.x:0,x===1?-n.y:0),fraction:c/a,gridPos:r};if(f)return f;h.x<h.y?(r.x+=n.x,c=h.x,h.x+=d.x,x=0):(r.y+=n.y,c=h.y,h.y+=d.y,x=1)}return null}var jl=class Oi{constructor(t){L(this,"pt");this.pt=t.clone()}transform(t){return new Oi(t.multVec2(this.pt))}bbox(){return new Fe(this.pt,0,0)}area(){return 0}clone(){return new Oi(this.pt)}collides(t){return Nl(this,t)}contains(t){return this.pt.eq(t)}raycast(t,o){return null}random(){return this.pt.clone()}},Dt=class Li{constructor(t,o){L(this,"p1");L(this,"p2");this.p1=t.clone(),this.p2=o.clone()}transform(t){return new Li(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Fe.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Li(this.p1,this.p2)}collides(t){return Ul(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Na(t,o,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(ht(1)))}},Fe=class zi{constructor(t,o,s){L(this,"pos");L(this,"width");L(this,"height");this.pos=t.clone(),this.width=o,this.height=s}static fromPoints(t,o){return new zi(t.clone(),o.x-t.x,o.y-t.y)}center(){return new _(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new At(this.points().map(o=>t.multVec2(o)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new zi(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let o=this.pos,s=this.pos.add(this.width,this.height),i=Math.max(o.x-t.x,0,t.x-s.x),a=Math.max(o.y-t.y,0,t.y-s.y);return i*i+a*a}collides(t){return _l(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Xl(t,o,this)}random(){return this.pos.add(ht(this.width),ht(this.height))}},Tt=class qa{constructor(t,o){L(this,"center");L(this,"radius");this.center=t.clone(),this.radius=o}transform(t){return new uo(this.center,this.radius,this.radius).transform(t)}bbox(){return Fe.fromPoints(this.center.sub(H(this.radius)),this.center.add(H(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new qa(this.center,this.radius)}collides(t){return ql(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Ua(t,o,this)}random(){return this.center.add(_.fromAngle(ht(360)).scale(ht(this.radius)))}},uo=class Go{constructor(t,o,s,i=0){L(this,"center");L(this,"radiusX");L(this,"radiusY");L(this,"angle");this.center=t.clone(),this.radiusX=o,this.radiusY=s,this.angle=i}static fromMat2(t){let o=t.inverse,s=o.transpose.mul(o),[i,a]=s.eigenvalues,[l,c]=s.eigenvectors(i,a),[r,n]=[1/Math.sqrt(i),1/Math.sqrt(a)];return r>n?new Go(H(),r,n,Bo(Math.atan2(-l[1],l[0]))):new Go(H(),n,r,Bo(Math.atan2(-c[1],c[0])))}toMat2(){let t=st(this.angle),o=Math.cos(t),s=Math.sin(t);return new Ys(o*this.radiusX,-s*this.radiusY,s*this.radiusX,o*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new Go(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let o=this.toMat2(),s=t.getRotation(),i=t.getScale();o=is.fromMat2(o).scale(i.x,i.y).rotate(s).toMat2();let a=Go.fromMat2(o);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return Fe.fromPoints(this.center.sub(H(this.radiusX,this.radiusY)),this.center.add(H(this.radiusX,this.radiusY)));{let t=st(this.angle),o=Math.cos(t),s=Math.sin(t),i=this.radiusX*o,a=this.radiusX*s,l=this.radiusY*s,c=this.radiusY*o,r=Math.sqrt(i*i+l*l),n=Math.sqrt(a*a+c*c);return Fe.fromPoints(this.center.sub(H(r,n)),this.center.add(H(r,n)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new Go(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return Yl(this,t)}contains(t){t=t.sub(this.center);let o=st(this.angle),s=Math.cos(o),i=Math.sin(o),a=t.x*s+t.y*i,l=-t.x*i+t.y*s;return a*a/(this.radiusX*this.radiusX)+l*l/(this.radiusY*this.radiusY)<1}raycast(t,o){return Kl(t,o,this)}random(){return this.center}};function Wl(e,t,o,s){let i=t.sub(e),a=s.sub(o),l=i.cross(a);return l<1e-5&&l>-1e-5||(l=o.sub(e).cross(a)/l,l<0||l>1)?null:e.add(i.scale(l))}var At=class as{constructor(t){L(this,"pts");if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new as(this.pts.map(o=>t.multVec2(o)))}bbox(){let t=H(Number.MAX_VALUE),o=H(-Number.MAX_VALUE);for(let s of this.pts)t.x=Math.min(t.x,s.x),o.x=Math.max(o.x,s.x),t.y=Math.min(t.y,s.y),o.y=Math.max(o.y,s.y);return Fe.fromPoints(t,o)}area(){let t=0,o=this.pts.length;for(let s=0;s<o;s++){let i=this.pts[s],a=this.pts[(s+1)%o];t+=i.x*a.y*.5,t-=a.x*i.y*.5}return Math.abs(t)}clone(){return new as(this.pts.map(t=>t.clone()))}collides(t){return Fl(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Gl(t,o,this)}random(){return H()}cut(t,o){new Dt(t,o);let s=[],i=[],a=o.sub(t),l=this.pts[this.pts.length-1],c=l.sub(t),r=a.cross(c)>0;return this.pts.forEach(n=>{c=n.sub(t);let d=a.cross(c)>0;if(r!=d){let u=Wl(l,n,t,o);s.push(u),i.push(u),r=d}(d?s:i).push(n),l=n}),[s.length?new as(s):null,i.length?new as(i):null]}};function $l(e,t,o,s){let i=s*s,a=1-s,l=a*a;return e.scale(l).add(t.scale(2*a*s)).add(o.scale(i))}function Jl(e,t,o,s){let i=1-s;return t.sub(e).scale(2*i).add(o.sub(t).scale(2*s))}function Ql(e,t,o,s){return o.sub(t.scale(2)).add(e).scale(2)}function un(e,t,o,s,i){let a=i*i,l=a*i,c=1-i,r=c*c,n=r*c;return e.scale(n).add(t.scale(3*r*i)).add(o.scale(3*c*a)).add(s.scale(l))}function Zl(e,t,o,s,i){let a=i*i,l=1-i,c=l*l;return t.sub(e).scale(3*c).add(o.sub(t).scale(6*l*i)).add(s.sub(o).scale(3*a))}function kl(e,t,o,s,i){let a=1-i;return o.sub(t.scale(2)).add(e).scale(6*a).add(s.sub(o.scale(2)).add(t).scale(6*i))}function ec(e,t,o,s,i){let a=.5*(((-i+2)*i-1)*i),l=.5*((3*i-5)*i*i+2),c=.5*(((-3*i+4)*i+1)*i),r=.5*((i-1)*i*i);return e.scale(a).add(t.scale(l)).add(o.scale(c)).add(s.scale(r))}function tc(e,t,o,s,i){let a=.5*((-3*i+4)*i-1),l=.5*((9*i-10)*i),c=.5*((-9*i+8)*i+1),r=.5*((3*i-2)*i);return e.scale(a).add(t.scale(l)).add(o.scale(c)).add(s.scale(r))}function oc(e){let t=_a(e),o=t(1);return s=>{let i=s*o,a=t(i,!0);return e(a)}}function _a(e,t=10,o=10){let s=[0],i=[0],a=1/(t-1)/o,l=0,c=e(0),r=0;for(let n=1;n<t;n++){for(let d=0;d<o;d++){r+=a;let u=e(r),h=u.dist(c);l+=h,c=u}s[n]=l,i[n]=r}return i[t-1]=1,(n,d=!1)=>{if(d){let u=n;if(u<=0)return 0;if(u>=l)return 1;let h=0;for(;s[h+1]<u;)h++;let x=i[h],f=i[h+1],A=s[h],g=s[h+1],w=(u-A)/(g-A);return x+(f-x)*w}else{if(n<=0)return 0;if(n>=1)return s[t-1];let u=0;for(;i[u+1]<n;)u++;let h=i[u],x=i[u+1],f=s[u],A=s[u+1],g=(n-h)/(x-h);return f+(A-f)*g}}}function Ms(e,t,o,s){let i=2*e+t-2*s+o,a=-3*e+3*s-2*t-o,l=t,c=e;return r=>{let n=r*r,d=n*r;return i*d+a*n+l*r+c}}function Fa(e,t,o,s,i,a=Ms){let l=a(t.x,(1-i)*(o.x-e.x),(1-i)*(s.x-t.x),o.x),c=a(t.y,(1-i)*(o.y-e.y),(1-i)*(s.y-t.y),o.y);return r=>new _(l(r),c(r))}function Gs(e,t,o,s,i=Ms){return Fa(e,t,o,s,.5,i)}function sc(e,t,o,s,i=Ms){return Gs(s.add(e.sub(t).scale(6)),e,s,e.add(s.sub(o).scale(6)),i)}function ic(e,t,o,s,i,a,l,c=Ms){let r=c(t.x,.5*(1-i)*(1+l)*(1+a)*(t.x-e.x)+.5*(1-i)*(1-l)*(1-a)*(o.x-t.x),.5*(1-i)*(1+l)*(1-a)*(o.x-t.x)+.5*(1-i)*(1-l)*(1+a)*(s.x-o.x),o.x),n=c(t.y,.5*(1-i)*(1+l)*(1+a)*(t.y-e.y)+.5*(1-i)*(1-l)*(1-a)*(o.y-t.y),.5*(1-i)*(1+l)*(1-a)*(o.y-t.y)+.5*(1-i)*(1-l)*(1+a)*(s.y-o.y),o.y);return d=>new _(r(d),n(d))}function nc(e,t,o,s){let i=2*e+t-2*s+o,a=-3*e+3*s-2*t+o,l=t;return c=>{let r=c*c;return 3*i*r+2*a*c+l}}function ko(e){return 0<=e&&e<=1}function bi(e,t){return Math.abs(e-t)<=Number.EPSILON}function es(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function ac(e,t,o,s){let i=3*e-6*t+3*o,a=-3*e+3*t,l=e,c=-e+3*t-3*o+s;if(bi(c,0)){if(bi(i,0))return bi(a,0)?[]:[-l/a].filter(ko);let g=Math.sqrt(a*a-4*i*l),w=2*i;return[(g-a)/w,(-a-g)/w].filter(ko)}i/=c,a/=c,l/=c;let r=(3*a-i*i)/3,n=r/3,d=(2*i*i*i-9*i*a+27*l)/27,u=d/2,h=u*u+n*n*n;if(h<0){let g=-r/3,w=g*g*g,E=Math.sqrt(w),T=-d/(2*E),q=T<-1?-1:T>1?1:T,U=Math.acos(q),p=2*es(E),y=p*Math.cos(U/3)-i/3,b=p*Math.cos((U+2*Math.PI)/3)-i/3,v=p*Math.cos((U+4*Math.PI)/3)-i/3;return[y,b,v].filter(ko)}if(h===0){let g=u<0?es(-u):-es(u),w=2*g-i/3,E=-g-i/3;return[w,E].filter(ko)}let x=Math.sqrt(h),f=es(x-u),A=es(x+u);return[f-A-i/3].filter(ko)}function rc(e,t,o,s,i){let a=ac(e.x-i,t.x-i,o.x-i,s.x-i);return a.length>0?un(e,t,o,s,a[0]).y:NaN}function lc(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return o=>{if(o<=0||e.length==1||o<=e[0].x)return e[0].y;for(let s=0;s<t;s++)if(e[s].x>=o)return $t(o,e[s-1].x,e[s].x,e[s-1].y,e[s].y);return e[e.length-1].y}}function cc(e,t){return o=>rc(H(0,0),e,t,H(1,1),o)}function hc(e,t="jump-end"){let o=1/e,s=t=="jump-start"||t=="jump-both",i=t=="jump-end"||t=="jump-both",a=1/(e+(i?1:0)),l=s?a:0;return c=>{let r=Math.floor(c/o);return l+r*a}}function dc(e,t){let o=Number.MAX_VALUE,s={normal:H(0),distance:0};for(let i of[e,t])for(let a=0;a<i.pts.length;a++){let l=i.pts[a],c=i.pts[(a+1)%i.pts.length].sub(l).normal().unit(),r=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let x=0;x<e.pts.length;x++){let f=e.pts[x].dot(c);r=Math.min(r,f),n=Math.max(n,f)}let d=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(let x=0;x<t.pts.length;x++){let f=t.pts[x].dot(c);d=Math.min(d,f),u=Math.max(u,f)}let h=Math.min(n,u)-Math.max(r,d);if(h<0)return null;if(h<Math.abs(o)){let x=u-r,f=d-n;o=Math.abs(x)<Math.abs(f)?x:f,s.normal=c,s.distance=o}}return s}function Ya(e,t,o){return(t.x-e.x)*(o.y-e.y)-(t.y-e.y)*(o.x-e.x)>=0}function uc(e){let t=0,o=e[e.length-1];for(let s=0;s<e.length;s++)t+=(e[s].x-o.x)*(e[s].y+o.y),o=e[s];return t<0}function Ai(e,t,o,s){let i=s.x-o.x,a=s.y-o.y,l=i*(e.y-o.y)-a*(e.x-o.x),c=i*(t.y-o.y)-a*(t.x-o.x);return l*c>=0}function pc(e,t,o,s){return Ai(e,t,o,s)&&Ai(e,o,t,s)&&Ai(e,s,t,o)}function fc(e,t,o,s){for(let i of e)if(i!==t&&i!==o&&i!==s&&pc(i,t,o,s))return!0;return!1}function gc(e,t,o,s){return Ya(e,t,o)&&!fc(s,e,t,o)}function Xa(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],o=[],s=0;for(let u=0;u<e.length;u++){let h=e[s],x=e[u];(x.x<h.x||x.x==h.x&&x.y<h.y)&&(s=s),t[u]=u+1,o[u]=u-1}t[t.length-1]=0,o[0]=o.length-1,uc(e)||([t,o]=[o,t]);let i=[];for(let u=0;u<e.length;++u)Ya(e[o[u]],e[u],e[t[u]])||i.push(e[u]);let a=[],l=e.length,c=1,r=0,n,d;for(;l>3;){n=t[c],d=o[c];let u=e[d],h=e[c],x=e[n];if(gc(u,h,x,i))a.push([u,h,x]),t[d]=n,o[n]=d,i.splice(i.indexOf(h),1),--l,r=0;else if(++r>l)return[];c=n}return n=t[c],d=o[c],a.push([e[d],e[c],e[n]]),a}function mc(e){if(e.length<3)return!1;let t=e.length-2,o=e.length-1,s=0,i=e[o].sub(e[t]),a=e[s].sub(e[o]),l=i.cross(a);for(;s+1<e.length;)if(t=o,o=s,s++,i=e[o].sub(e[t]),a=e[s].sub(e[o]),i.cross(a)*l<0)return!1;return!0}var Ga=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ai="topleft",xc="monospace",Ks="monospace",Hi="linear",pn=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],yc=pn.reduce((e,t)=>e+t.size,0),Ka=2048,wc=Ka*4*yc,bc=Ka*6,Ac=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,vc=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Ni=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Ui=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,Mc=new Set(["id","require"]),Ec=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),Un=200,Sc=640,Rc=65536,Va=Symbol.for("kaplay.cancel"),ja=class extends Map{constructor(){super(...arguments);L(this,"lastID",0)}push(t){let o=this.lastID;return this.set(o,t),this.lastID++,o}pushd(t){let o=this.push(t);return()=>this.delete(o)}},Uo=class Wa{constructor(t){L(this,"paused",!1);L(this,"cancel");this.cancel=t}static join(t){let o=new Wa(()=>t.forEach(s=>s.cancel()));return Object.defineProperty(o,"paused",{get:()=>t[0].paused,set:s=>t.forEach(i=>i.paused=s)}),o.paused=!1,o}static replace(t,o){return t.cancel=()=>o.cancel(),o.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>o.paused,set:s=>o.paused=s}),t}},bt=class{constructor(){L(this,"cancellers",new WeakMap);L(this,"handlers",new ja)}add(e){function t(...i){if(!s.paused)return e(...i)}let o=this.handlers.pushd(t),s=new Uo(o);return this.cancellers.set(t,o),s}addOnce(e){let t=this.add((...o)=>{t.cancel(),e(...o)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let o=t(...e),s;o===Va&&(s=this.cancellers.get(t))&&s()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},xs=class{constructor(){L(this,"handlers",{});L(this,"registers",{})}on(e,t){return this.handlers[e]||(this.handlers[e]=new bt),this.handlers[e].add(t)}onOnce(e,t){let o=this.on(e,(...s)=>{o.cancel(),t(...s)});return o}next(e){return new Promise(t=>{this.onOnce(e,(...o)=>t(o[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){var t;return((t=this.handlers[e])==null?void 0:t.numListeners())??0}},Tc=e=>e[0]instanceof Ie,Dc=e=>e[0]instanceof _,Cc=e=>typeof e[0]=="number",$a=class{constructor(e=(t,o)=>t<o){L(this,"_items");L(this,"_compareFn");this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Ic(e){let t=window.atob(e),o=t.length,s=new Uint8Array(o);for(let i=0;i<o;i++)s[i]=t.charCodeAt(i);return s.buffer}function Pc(e){return Ic(e.split(",")[1])}function fn(e,t){let o=document.createElement("a");o.href=t,o.download=e,o.click()}function Ja(e,t){fn(e,"data:text/plain;charset=utf-8,"+t)}function Bc(e,t){Ja(e,JSON.stringify(t))}function qn(e,t){let o=URL.createObjectURL(t);fn(e,o),URL.revokeObjectURL(o)}var Qa=e=>e.match(/^data:\w+\/\w+;base64,.+/),Oc=e=>e.split(".").slice(0,-1).join(".");function gn(e,t){if(e===t)return!0;let o=typeof e,s=typeof t;if(o!==s)return!1;if(o==="object"&&s==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let i=Object.keys(e),a=Object.keys(t);if(i.length!==a.length)return!1;for(let l of i){let c=e[l],r=t[l];if(!gn(c,r))return!1}return!0}return!1}var _n=new Set,Lc=e=>e instanceof Error?e.message:String(e);function zc(e){_n.has(e)||(_n.add(e),console.warn(e))}function $o(e,t){zc(`${e} is deprecated. Use ${t} instead.`)}function qi(e,t){return Number(e.toFixed(t))}function Ve(e,t){return(...o)=>{let s=o.length;if(s===e.length)return e(...o);if(s===t.length)return t(...o)}}var Hc=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function Nc(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],o=0,s=0;for(;o<e.length;){if(s+=Uc(o+s,e),Kc(e[o+s])&&s++,Yc(e[o+s])&&s++,Xc(e[o+s])&&s++,Vc(e[o+s])){s++;continue}t.push(e.substring(o,o+s)),o+=s,s=0}return t}function Uc(e,t){let o=t[e];if(!qc(o)||e===t.length-1)return 1;let s=o+t[e+1],i=t.substring(e+2,e+5);return Fn(s)&&Fn(i)?4:_c(s)&&Gc(i)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:Fc(i)?4:2}function qc(e){return e&&qo(e[0].charCodeAt(0),55296,56319)}function Fn(e){return qo(mn(e),127462,127487)}function _c(e){return qo(mn(e),127988,127988)}function Fc(e){return qo(mn(e),127995,127999)}function Yc(e){return typeof e=="string"&&qo(e.charCodeAt(0),65024,65039)}function Xc(e){return typeof e=="string"&&qo(e.charCodeAt(0),8400,8447)}function Gc(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&qo(t,917504,917631)}function Kc(e){return typeof e=="string"&&Hc.includes(e.charCodeAt(0))}function Vc(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function mn(e){let t=e.charCodeAt(0)-55296,o=e.charCodeAt(1)-56320;return(t<<10)+o+65536}function qo(e,t,o){return e>=t&&e<=o}var Pt=(e,t)=>Array.isArray(e)?e==null?void 0:e.includes(t):e===t,Vt=(e,t)=>Array.isArray(t)?t.some(o=>e.has(o)):e.has(t),Ps=(e,t,o)=>{var s;e.has(t)?(s=e.get(t))==null||s.push(o):e.set(t,[o])},jc=(()=>{let e=0;return()=>e++})(),Wc={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function Za(){let e=m.globalOpt.pixelDensity??1,t=m.globalOpt.width,o=m.globalOpt.height,s=m.gfx.ggl.gl.drawingBufferWidth,i=m.gfx.ggl.gl.drawingBufferHeight,a=s/e,l=i/e,c=0,r=0,n=a,d=l;if(m.globalOpt.letterbox){if(!t||!o)throw new Error("Letterboxing requires width and height defined.");let u=a/l,h=t/o;if(u>h){let x=l*h;c=(a-x)/2,n=x}else{let x=a/h;d=x,r=(l-x)/2}}if(m.globalOpt.stretch&&(!m.globalOpt.width||!m.globalOpt.height))throw new Error("Stretching requires width and height defined.");m.gfx.viewport={x:c,y:r,width:n,height:d,scale:(m.gfx.viewport.width+m.gfx.viewport.height)/(m.gfx.width+m.gfx.height)}}function $c(e){return new _(e.x*m.gfx.viewport.width/m.gfx.width,e.y*m.gfx.viewport.height/m.gfx.height)}function oo(e){return new _((e.x-m.gfx.viewport.x)*m.gfx.width/m.gfx.viewport.width,(e.y-m.gfx.viewport.y)*m.gfx.height/m.gfx.viewport.height)}var Jc=()=>Co.lastInputDevice,Qc=()=>{let e=Co.buttons;for(let t in e){let o=e[t].keyboard&&[e[t].keyboard].flat(),s=e[t].keyboardCode&&[e[t].keyboardCode].flat(),i=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();o&&o.forEach(l=>{Ps(Co.buttonsByKey,l,t)}),s&&s.forEach(l=>{Ps(Co.buttonsByKeyCode,l,t)}),i&&i.forEach(l=>{Ps(Co.buttonsByGamepad,l,t)}),a&&a.forEach(l=>{Ps(Co.buttonsByMouse,l,t)})}},us=class{constructor(){L(this,"pressed",new Set([]));L(this,"pressedRepeat",new Set([]));L(this,"released",new Set([]));L(this,"down",new Set([]))}update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},Zc=class{constructor(){L(this,"buttonState",new us);L(this,"stickState",new Map)}},kc=class{constructor(){L(this,"dts",[]);L(this,"timer",0);L(this,"fps",0)}tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,o)=>t+o)/this.dts.length)),this.dts=[])}},Co,Yn=Wc,eh=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new kc,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new _(0),mouseDeltaPos:new _(0),keyState:new us,mouseState:new us,mergedGamepadState:new Zc,gamepadStates:new Map,lastInputDevice:null,buttonState:new us,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new xs}},th=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=eh(e);Co=t,Qc();function o(){return t.dt*t.timeScale}function s(){return t.fixedDt*t.timeScale}function i(){return t.restDt*t.timeScale}function a(){return t.isHidden}function l(){return t.time}function c(){return t.fpsCounter.fps}function r(){return t.numFrames}function n(){return t.canvas.toDataURL()}function d(M){t.canvas.style.cursor=M}function u(){return t.canvas.style.cursor}function h(M){if(M)try{let z=t.canvas.requestPointerLock();z!=null&&z.catch&&z.catch(F=>console.error(F))}catch(z){console.error(z)}else document.exitPointerLock()}function x(){return!!document.pointerLockElement}function f(M){M.requestFullscreen?M.requestFullscreen():M.webkitRequestFullscreen&&M.webkitRequestFullscreen()}function A(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function g(M=!0){M?f(t.canvas):A()}function w(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function E(){t.stopped=!0;let M=Object.entries(Xe),z=Object.entries(Kt),F=Object.entries(Ne);for(let[Z,we]of M)t.canvas.removeEventListener(Z,we);for(let[Z,we]of z)document.removeEventListener(Z,we);for(let[Z,we]of F)window.removeEventListener(Z,we);_t.disconnect()}function T(M,z){t.loopID!==null&&cancelAnimationFrame(t.loopID);let F=0,Z=0,we=Oe=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(we);return}let it=Oe/1e3,Ge=Math.min(it-t.realTime,.25),Et=e.maxFPS?1/e.maxFPS:0;if(t.realTime=it,Z+=Ge,Z>Et){if(!t.skipTime){for(F+=Z,t.dt=t.fixedDt,t.restDt=0;F>t.fixedDt;)F-=t.fixedDt,F<t.fixedDt&&(t.restDt=F),M();t.restDt=F,t.dt=Z,t.time+=o(),t.fpsCounter.tick(t.dt)}Z=0,t.skipTime=!1,t.numFrames++,z(Ts,fo)}t.loopID=requestAnimationFrame(we)};we(0)}function q(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function U(){return t.mousePos.clone()}function p(){return t.mouseDeltaPos.clone()}function y(M="left"){return t.mouseState.pressed.has(M)}function b(M="left"){return t.mouseState.down.has(M)}function v(M="left"){return t.mouseState.released.has(M)}function D(){return t.isMouseMoved}function P(M){return M===void 0?t.keyState.pressed.size>0:Vt(t.keyState.pressed,M)}function O(M){return M===void 0?t.keyState.pressedRepeat.size>0:Vt(t.keyState.pressedRepeat,M)}function I(M){return M===void 0?t.keyState.down.size>0:Vt(t.keyState.down,M)}function R(M){return M===void 0?t.keyState.released.size>0:Vt(t.keyState.released,M)}function N(M){return M===void 0?t.mergedGamepadState.buttonState.pressed.size>0:Vt(t.mergedGamepadState.buttonState.pressed,M)}function Y(M){return M===void 0?t.mergedGamepadState.buttonState.down.size>0:Vt(t.mergedGamepadState.buttonState.down,M)}function j(M){return M===void 0?t.mergedGamepadState.buttonState.released.size>0:Vt(t.mergedGamepadState.buttonState.released,M)}function k(M){return M===void 0?t.buttonState.pressed.size>0:Vt(t.buttonState.pressed,M)}function G(M){return M===void 0?t.buttonState.down.size>0:Vt(t.buttonState.down,M)}function Q(M){return M===void 0?t.buttonState.released.size>0:Vt(t.buttonState.released,M)}function pe(M){var z;return(z=t.buttons)==null?void 0:z[M]}function ee(M,z){t.buttons[M]={...t.buttons[M],...z}}function De(M){t.buttonState.press(M),t.events.trigger("buttonPress",M)}function ye(M){t.buttonState.release(M),t.events.trigger("buttonRelease",M)}function Se(M){return t.events.on("resize",M)}let Ae=Ve(M=>t.events.on("keyDown",M),(M,z)=>t.events.on("keyDown",F=>Pt(M,F)&&z(F))),Ce=Ve(M=>t.events.on("keyPress",z=>M(z)),(M,z)=>t.events.on("keyPress",F=>Pt(M,F)&&z(F))),Pe=Ve(M=>t.events.on("keyPressRepeat",M),(M,z)=>t.events.on("keyPressRepeat",F=>Pt(M,F)&&z(F))),se=Ve(M=>t.events.on("keyRelease",M),(M,z)=>t.events.on("keyRelease",F=>Pt(M,F)&&z(F))),V=Ve(M=>t.events.on("mouseDown",z=>M(z)),(M,z)=>t.events.on("mouseDown",F=>Pt(M,F)&&z(F))),K=Ve(M=>t.events.on("mousePress",z=>M(z)),(M,z)=>t.events.on("mousePress",F=>Pt(M,F)&&z(F))),te=Ve(M=>t.events.on("mouseRelease",z=>M(z)),(M,z)=>t.events.on("mouseRelease",F=>F===M&&z(F)));function X(M){return t.events.on("mouseMove",()=>M(U(),p()))}function $(M){return t.events.on("charInput",M)}function ae(M){return t.events.on("touchStart",M)}function re(M){return t.events.on("touchMove",M)}function me(M){return t.events.on("touchEnd",M)}function ue(M){return t.events.on("scroll",M)}function qe(M){return t.events.on("hide",M)}function yt(M){return t.events.on("show",M)}let Xt=Ve(M=>t.events.on("gamepadButtonPress",(z,F)=>M(z,F)),(M,z)=>t.events.on("gamepadButtonPress",(F,Z)=>Pt(M,F)&&z(F,Z))),It=Ve(M=>t.events.on("gamepadButtonDown",(z,F)=>M(z,F)),(M,z)=>t.events.on("gamepadButtonDown",(F,Z)=>Pt(M,F)&&z(F,Z))),vt=Ve(M=>t.events.on("gamepadButtonRelease",(z,F)=>M(z,F)),(M,z)=>t.events.on("gamepadButtonRelease",(F,Z)=>Pt(M,F)&&z(F,Z)));function je(M,z){return t.events.on("gamepadStick",(F,Z,we)=>F===M&&z(Z,we))}function eo(M){t.events.on("gamepadConnect",M)}function lt(M){t.events.on("gamepadDisconnect",M)}function Ye(M){return t.mergedGamepadState.stickState.get(M)||new _(0)}function wt(){return[...t.charInputted]}function We(){return[...t.gamepads]}let Gt=Ve(M=>t.events.on("buttonPress",z=>M(z)),(M,z)=>t.events.on("buttonPress",F=>Pt(M,F)&&z(F))),_e=Ve(M=>t.events.on("buttonDown",z=>M(z)),(M,z)=>t.events.on("buttonDown",F=>Pt(M,F)&&z(F))),ke=Ve(M=>t.events.on("buttonRelease",z=>M(z)),(M,z)=>t.events.on("buttonRelease",F=>Pt(M,F)&&z(F)));function Ts(){t.events.trigger("input"),t.keyState.down.forEach(M=>t.events.trigger("keyDown",M)),t.mouseState.down.forEach(M=>t.events.trigger("mouseDown",M)),t.buttonState.down.forEach(M=>{t.events.trigger("buttonDown",M)}),pi()}function fo(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((M,z)=>{t.mergedGamepadState.stickState.set(z,new _(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new _(0),t.gamepadStates.forEach(M=>{M.buttonState.update(),M.stickState.forEach((z,F)=>{M.stickState.set(F,new _(0))})})}function to(M){let z={index:M.index,isPressed:F=>{var Z;return((Z=t.gamepadStates.get(M.index))==null?void 0:Z.buttonState.pressed.has(F))||!1},isDown:F=>{var Z;return((Z=t.gamepadStates.get(M.index))==null?void 0:Z.buttonState.down.has(F))||!1},isReleased:F=>{var Z;return((Z=t.gamepadStates.get(M.index))==null?void 0:Z.buttonState.released.has(F))||!1},getStick:F=>{var Z;return((Z=t.gamepadStates.get(M.index))==null?void 0:Z.stickState.get(F))||H()}};return t.gamepads.push(z),t.gamepadStates.set(M.index,{buttonState:new us,stickState:new Map([["left",new _(0)],["right",new _(0)]])}),z}function ui(M){t.gamepads=t.gamepads.filter(z=>z.index!==M.index),t.gamepadStates.delete(M.index)}function pi(){var M,z;for(let F of navigator.getGamepads())F&&!t.gamepadStates.has(F.index)&&to(F);for(let F of t.gamepads){let Z=navigator.getGamepads()[F.index];if(!Z)continue;let we=(e.gamepads??{})[Z.id]||Yn[Z.id]||Yn.default,Oe=t.gamepadStates.get(F.index);if(Oe){for(let it=0;it<Z.buttons.length;it++){let Ge=we.buttons[it],Et=Z.buttons[it],pt=t.buttonsByGamepad.has(Ge);if(Et.pressed){if(Oe.buttonState.down.has(Ge)){t.events.trigger("gamepadButtonDown",Ge,F);continue}t.lastInputDevice="gamepad",pt&&((M=t.buttonsByGamepad.get(Ge))==null||M.forEach(Ft=>{t.buttonState.press(Ft),t.events.trigger("buttonPress",Ft)})),t.mergedGamepadState.buttonState.press(Ge),Oe.buttonState.press(Ge),t.events.trigger("gamepadButtonPress",Ge,F)}else Oe.buttonState.down.has(Ge)&&(pt&&((z=t.buttonsByGamepad.get(Ge))==null||z.forEach(Ft=>{t.buttonState.release(Ft),t.events.trigger("buttonRelease",Ft)})),t.mergedGamepadState.buttonState.release(Ge),Oe.buttonState.release(Ge),t.events.trigger("gamepadButtonRelease",Ge,F))}for(let it in we.sticks){let Ge=we.sticks[it];if(!Ge)continue;let Et=new _(Z.axes[Ge.x],Z.axes[Ge.y]);Oe.stickState.set(it,Et),t.mergedGamepadState.stickState.set(it,Et),t.events.trigger("gamepadStick",it,Et,F)}}}}let Xe={},Kt={},Ne={},Mt=e.pixelDensity||1;Xe.mousemove=M=>{let z=oo(new _(M.offsetX,M.offsetY)),F=new _(M.movementX,M.movementY);if(w()){let Z=t.canvas.width/Mt,we=t.canvas.height/Mt,Oe=window.innerWidth,it=window.innerHeight,Ge=Oe/it,Et=Z/we;if(Ge>Et){let pt=it/we,Ft=(Oe-Z*pt)/2;z.x=$t(M.offsetX-Ft,0,Z*pt,0,Z),z.y=$t(M.offsetY,0,we*pt,0,we)}else{let pt=Oe/Z,Ft=(it-we*pt)/2;z.x=$t(M.offsetX,0,Z*pt,0,Z),z.y=$t(M.offsetY-Ft,0,we*pt,0,we)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=z,t.mouseDeltaPos=F,t.events.trigger("mouseMove")})};let et=["left","middle","right","back","forward"];Xe.mousedown=M=>{t.events.onOnce("input",()=>{var F;let z=et[M.button];z&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(z)&&((F=t.buttonsByMouse.get(z))==null||F.forEach(Z=>{t.buttonState.press(Z),t.events.trigger("buttonPress",Z)})),t.mouseState.press(z),t.events.trigger("mousePress",z))})},Xe.mouseup=M=>{t.events.onOnce("input",()=>{var F;let z=et[M.button];z&&(t.buttonsByMouse.has(z)&&((F=t.buttonsByMouse.get(z))==null||F.forEach(Z=>{t.buttonState.release(Z),t.events.trigger("buttonRelease",Z)})),t.mouseState.release(z),t.events.trigger("mouseRelease",z))})};let qt=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),ut={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};Xe.keydown=M=>{qt.has(M.key)&&M.preventDefault(),t.events.onOnce("input",()=>{var Z,we;let z=ut[M.key]||M.key.toLowerCase(),F=M.code;if(z===void 0)throw new Error(`Unknown key: ${M.key}`);z.length===1?(t.events.trigger("charInput",z),t.charInputted.push(z)):z==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),M.repeat?(t.keyState.pressRepeat(z),t.events.trigger("keyPressRepeat",z)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(z)&&((Z=t.buttonsByKey.get(z))==null||Z.forEach(Oe=>{t.buttonState.press(Oe),t.events.trigger("buttonPress",Oe)})),t.buttonsByKeyCode.has(F)&&((we=t.buttonsByKeyCode.get(F))==null||we.forEach(Oe=>{t.buttonState.press(Oe),t.events.trigger("buttonPress",Oe)})),t.keyState.press(z),t.events.trigger("keyPressRepeat",z),t.events.trigger("keyPress",z))})},Xe.keyup=M=>{t.events.onOnce("input",()=>{var Z,we;let z=ut[M.key]||M.key.toLowerCase(),F=M.code;t.buttonsByKey.has(z)&&((Z=t.buttonsByKey.get(z))==null||Z.forEach(Oe=>{t.buttonState.release(Oe),t.events.trigger("buttonRelease",Oe)})),t.buttonsByKeyCode.has(F)&&((we=t.buttonsByKeyCode.get(F))==null||we.forEach(Oe=>{t.buttonState.release(Oe),t.events.trigger("buttonRelease",Oe)})),t.keyState.release(z),t.events.trigger("keyRelease",z)})},Xe.touchstart=M=>{M.preventDefault(),t.events.onOnce("input",()=>{var Z;let z=[...M.changedTouches],F=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=oo(new _(z[0].clientX-F.x,z[0].clientY-F.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&((Z=t.buttonsByMouse.get("left"))==null||Z.forEach(we=>{t.buttonState.press(we),t.events.trigger("buttonPress",we)})),t.mouseState.press("left"),t.events.trigger("mousePress","left")),z.forEach(we=>{t.events.trigger("touchStart",oo(new _(we.clientX-F.x,we.clientY-F.y)),we)})})},Xe.touchmove=M=>{M.preventDefault(),t.events.onOnce("input",()=>{let z=[...M.changedTouches],F=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let Z=t.mousePos;t.mousePos=oo(new _(z[0].clientX-F.x,z[0].clientY-F.y)),t.mouseDeltaPos=t.mousePos.sub(Z),t.events.trigger("mouseMove")}z.forEach(Z=>{t.events.trigger("touchMove",oo(new _(Z.clientX-F.x,Z.clientY-F.y)),Z)})})},Xe.touchend=M=>{t.events.onOnce("input",()=>{var Z;let z=[...M.changedTouches],F=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=oo(new _(z[0].clientX-F.x,z[0].clientY-F.y)),t.mouseDeltaPos=new _(0,0),t.buttonsByMouse.has("left")&&((Z=t.buttonsByMouse.get("left"))==null||Z.forEach(we=>{t.buttonState.release(we),t.events.trigger("buttonRelease",we)})),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),z.forEach(we=>{t.events.trigger("touchEnd",oo(new _(we.clientX-F.x,we.clientY-F.y)),we)})})},Xe.touchcancel=M=>{t.events.onOnce("input",()=>{let z=[...M.changedTouches],F=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=oo(new _(z[0].clientX-F.x,z[0].clientY-F.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),z.forEach(Z=>{t.events.trigger("touchEnd",oo(new _(Z.clientX-F.x,Z.clientY-F.y)),Z)})})},Xe.wheel=M=>{M.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new _(M.deltaX,M.deltaY))})},Xe.contextmenu=M=>M.preventDefault(),Kt.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},Ne.gamepadconnected=M=>{let z=to(M.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",z)})},Ne.gamepaddisconnected=M=>{let z=We().filter(F=>F.index===M.gamepad.index)[0];ui(M.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",z)})};for(let[M,z]of Object.entries(Xe))t.canvas.addEventListener(M,z);for(let[M,z]of Object.entries(Kt))document.addEventListener(M,z);for(let[M,z]of Object.entries(Ne))window.addEventListener(M,z);let _t=new ResizeObserver(M=>{for(let z of M)if(z.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return _t.observe(t.canvas),{state:t,dt:o,fixedDt:s,restDt:i,time:l,run:T,canvas:t.canvas,fps:c,numFrames:r,quit:E,isHidden:a,setFullscreen:g,isFullscreen:w,setCursor:d,screenshot:n,getGamepads:We,getCursor:u,setCursorLocked:h,isCursorLocked:x,isTouchscreen:q,mousePos:U,mouseDeltaPos:p,isKeyDown:I,isKeyPressed:P,isKeyPressedRepeat:O,isKeyReleased:R,isMouseDown:b,isMousePressed:y,isMouseReleased:v,isMouseMoved:D,isGamepadButtonPressed:N,isGamepadButtonDown:Y,isGamepadButtonReleased:j,getGamepadStick:Ye,isButtonPressed:k,isButtonDown:G,isButtonReleased:Q,setButton:ee,getButton:pe,pressButton:De,releaseButton:ye,charInputted:wt,onResize:Se,onKeyDown:Ae,onKeyPress:Ce,onKeyPressRepeat:Pe,onKeyRelease:se,onMouseDown:V,onMousePress:K,onMouseRelease:te,onMouseMove:X,onCharInput:$,onTouchStart:ae,onTouchMove:re,onTouchEnd:me,onScroll:ue,onHide:qe,onShow:yt,onGamepadButtonDown:It,onGamepadButtonPress:Xt,onGamepadButtonRelease:vt,onGamepadStick:je,onGamepadConnect:eo,onGamepadDisconnect:lt,onButtonPress:Gt,onButtonDown:_e,onButtonRelease:ke,getLastInputDeviceType:Jc,events:t.events}};function dt(){return m.app.dt()}function _i(){return m.app.fixedDt()}function Fi(){return m.app.restDt()}var oh=new _(-1,-1),sh=new _(0,-1),ih=new _(1,-1),nh=new _(-1,0),ah=new _(0,0),rh=new _(1,0),lh=new _(-1,1),ch=new _(0,1),hh=new _(1,1);function Jo(e){switch(e){case"topleft":return oh;case"top":return sh;case"topright":return ih;case"left":return nh;case"center":return ah;case"right":return rh;case"botleft":return lh;case"bot":return ch;case"botright":return hh;default:return e}}function dh(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function uh(e){return e.createBuffer(1,1,44100)}var Bs=2.5949095,Xn=1.70158+1,Gn=2*Math.PI/3,Kn=2*Math.PI/4.5,Ns={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>Xn*e*e*e-1.70158*e*e,easeOutBack:e=>1+Xn*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((Bs+1)*2*e-Bs)/2:(Math.pow(2*e-2,2)*((Bs+1)*(e*2-2)+Bs)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*Gn),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*Gn)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Kn))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Kn)/2+1,easeInBounce:e=>1-Ns.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Ns.easeOutBounce(1-2*e))/2:(1+Ns.easeOutBounce(2*e-1))/2},ys=Ns;function ph(e,t,o){let s=[],i=t;for(s.push(i);i!==e;){if(i=o.get(i),i==null)return null;s.push(i)}return s.reverse()}function fh(e,t,o){var l;let s=new $a((c,r)=>c.cost<r.cost);s.insert({cost:0,node:t});let i=new Map;i.set(t,t);let a=new Map;for(a.set(t,0);s.length!==0;){let c=(l=s.remove())==null?void 0:l.node;if(c===o)break;let r=e.getNeighbours(c);for(let n of r){let d=(a.get(c)||0)+e.getCost(c,n)+e.getHeuristic(n,o);(!a.has(n)||d<a.get(n))&&(a.set(n,d),s.insert({cost:d,node:n}),i.set(n,c))}}return ph(t,o,i)}var gh=class{constructor(e,t,o){L(this,"a");L(this,"b");L(this,"polygon");this.a=e,this.b=t,this.polygon=new WeakRef(o)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},mh=class{constructor(e){L(this,"_edges");L(this,"_centroid");L(this,"_id");this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,o=0,s=0;for(let i of this._edges){i.polygon=new WeakRef(this);let a=i.a.x*i.b.y-i.a.y*i.b.x;t+=(i.a.x+i.b.x)*a,o+=(i.a.y+i.b.y)*a,s+=a}s/=2,this._centroid=H(t/(6*s),o/(6*s))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let o of this.edges)o.b.y>e.y!=o.a.y>e.y&&e.x<(o.a.x-o.b.x)*(e.y-o.b.y)/(o.a.y-o.b.y)+o.b.x&&(t=!t);return t}},xh=class{constructor(){L(this,"_polygons");L(this,"_pointCache");L(this,"_edgeCache");this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let o=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[o]}_findCommonEdge(e,t){for(let o of e.edges){let s=this._findEdge(o.b,o.a);if(s&&s.polygon.deref().id===t.id)return s}return null}addPolygon(e){let t=new mh(this._polygons.length),o=e.map((s,i)=>new gh(s,e[(i+1)%e.length],t));t.edges=o,this._polygons.push(t);for(let s of t.edges)this._addEdge(s);return t}addRect(e,t){let o=this._addPoint(e),s=this._addPoint(e.add(t.x,0)),i=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([o,s,i,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let o of this._polygons[e].edges){let s=this._findEdge(o.b,o.a);if(s){let i=s.polygon.deref();i&&t.push(i.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let o=this._polygons[e],s=this._polygons[t],i=o.centroid.x-s.centroid.x,a=o.centroid.y-s.centroid.y;return Math.sqrt(i*i+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:fh(this,e,t)}getWaypointPath(e,t,o){let s=(o==null?void 0:o.type)||"centroids",i=this._getLocation(e),a=this._getLocation(t);if(i===void 0||a===void 0)return[];let l=this.getPath(i.id,a.id);if(!l)return[];if(s==="edges"){let c=[];for(let r=1;r<l.length;r++){let n=this._polygons[l[r-1]],d=this._polygons[l[r]],u=this._findCommonEdge(n,d);c.push(u.middle.add(d.centroid.sub(u.middle).unit().scale(4)))}return[e,...c,t]}else return[e,...l.slice(1,-1).map(c=>this._polygons[c].centroid),t]}};function ps(e){let t=new Zt;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function yh(e){return new _(e.x/ft()*2-1,-e.y/xt()*2+1)}function rs(e,t,o,s,i,a=1){s=st(s%360),i=st(i%360),i<=s&&(i+=Math.PI*2);let l=[],c=Math.ceil((i-s)/st(8)*a),r=(i-s)/c,n=H(Math.cos(s),Math.sin(s)),d=H(Math.cos(r),Math.sin(r));for(let u=0;u<=c;u++)l.push(e.add(t*n.x,o*n.y)),n=H(n.x*d.x-n.y*d.y,n.x*d.y+n.y*d.x);return l}function wh(...e){let t=Le(...e),o=e[3]??1;m.gfx.bgColor=t,m.gfx.bgAlpha=o,m.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,o)}function bh(){var e,t;return((t=(e=m.gfx.bgColor)==null?void 0:e.clone)==null?void 0:t.call(e))??null}function Qe(...e){if(e[0]===void 0)return;let t=H(...e);t.x===0&&t.y===0||m.gfx.transform.translate(t)}function Ot(){m.gfx.transformStack.push(m.gfx.transform.clone())}function Ah(e){m.gfx.transform=e.clone()}function ws(...e){if(e[0]===void 0)return;let t=H(...e);t.x===1&&t.y===1||m.gfx.transform.scale(t)}function Ko(e){e&&m.gfx.transform.rotate(e)}function St(){m.gfx.transformStack.length>0&&(m.gfx.transform=m.gfx.transformStack.pop())}function Lt(){m.gfx.renderer.flush()}function ft(){return m.gfx.width}function xt(){return m.gfx.height}function ka(){return(m.gfx.viewport.width+m.gfx.viewport.height)/(m.gfx.width+m.gfx.height)}function Vs(){return H(ft()/2,xt()/2)}var vh=class{constructor(e,t,o,s){L(this,"lastTextureId",0);L(this,"textures",[]);L(this,"bigTextures",[]);L(this,"texturesPosition",new Map);L(this,"canvas");L(this,"c2d");L(this,"x",0);L(this,"y",0);L(this,"curHeight",0);L(this,"gfx");L(this,"padding");this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.textures=[bo.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=s;let i=this.canvas.getContext("2d");if(!i)throw new Error("Failed to get 2d context");this.c2d=i}addSingle(e){let t=bo.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new Je(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,o=e.height+this.padding*2;if(t>this.canvas.width||o>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+o>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(bo.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let s=this.textures[this.textures.length-1],i=new _(this.x+this.padding,this.y+this.padding);return this.x+=t,o>this.curHeight&&(this.curHeight=o),e instanceof ImageData?this.c2d.putImageData(e,i.x,i.y):this.c2d.drawImage(e,i.x,i.y),s.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:i,size:new _(e.width,e.height),texture:s}),this.lastTextureId++,[s,new Je(i.x/this.canvas.width,i.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Nt(e){return typeof e!="string"||Qa(e)?e:m.assets.urlPrefix+e}var Ut=class er{constructor(t){L(this,"loaded",!1);L(this,"data",null);L(this,"error",null);L(this,"onLoadEvents",new bt);L(this,"onErrorEvents",new bt);L(this,"onFinishEvents",new bt);t.then(o=>{this.loaded=!0,this.data=o,this.onLoadEvents.trigger(o)}).catch(o=>{if(this.error=o,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(o);else throw o}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let o=new er(Promise.resolve(t));return o.data=t,o.loaded=!0,o}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},_o=class{constructor(){L(this,"assets",new Map);L(this,"lastUID",0)}add(e,t){let o=e??this.lastUID+++"",s=new Ut(t);return this.assets.set(o,s),s}addLoaded(e,t){let o=e??this.lastUID+++"",s=Ut.loaded(t);return this.assets.set(o,s),s}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function xn(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function ri(e){return xn(e).then(t=>t.json())}function Mh(e){return xn(e).then(t=>t.text())}function Eh(e){return xn(e).then(t=>t.arrayBuffer())}function Sh(e){return e!==void 0&&(m.assets.urlPrefix=e),m.assets.urlPrefix}function Rh(e,t){return m.assets.custom.add(e,ri(Nt(t)))}function li(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((o,s)=>{t.onload=()=>o(t),t.onerror=()=>s(new Error(`Failed to load image from "${e}"`))})}function Oo(){let e=[m.assets.sprites,m.assets.sounds,m.assets.shaders,m.assets.fonts,m.assets.bitmapFonts,m.assets.custom];return e.reduce((t,o)=>t+o.progress(),0)/e.length}function tr(){return[m.assets.sprites,m.assets.sounds,m.assets.shaders,m.assets.fonts,m.assets.bitmapFonts,m.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function Th(e){return m.assets.custom.get(e)??null}function Yi(e){return m.assets.custom.add(null,e)}var Dh=(e,t)=>({urlPrefix:"",sprites:new _o,fonts:new _o,bitmapFonts:new _o,sounds:new _o,shaders:new _o,custom:new _o,music:{},packer:new vh(e,2048,2048,t),loaded:!1}),Ch="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Eo=class ls{constructor(t,o,s={},i=null){L(this,"tex");L(this,"frames",[new Je(0,0,1,1)]);L(this,"anims",{});L(this,"slice9",null);this.tex=t,o&&(this.frames=o),this.anims=s,this.slice9=i}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,o={}){return typeof t=="string"?ls.fromURL(t,o):Promise.resolve(ls.fromImage(t,o))}static fromImage(t,o={}){let[s,i]=o.singular?m.assets.packer.addSingle(t):m.assets.packer.add(t),a=o.frames?o.frames.map(l=>new Je(i.x+l.x*i.w,i.y+l.y*i.h,l.w*i.w,l.h*i.h)):sr(o.sliceX||1,o.sliceY||1,i.x,i.y,i.w,i.h);return new ls(s,a,o.anims,o.slice9)}static fromURL(t,o={}){return li(t).then(s=>ls.fromImage(s,o))}};function Us(e){if(typeof e=="string"){let t=or(e);if(t)return t;if(Oo()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Eo)return Ut.loaded(e);if(e instanceof Ut)return e;throw new Error(`Invalid sprite: ${e}`)}}function or(e){return m.assets.sprites.get(e)??null}function fs(e,t,o={sliceX:1,sliceY:1,anims:{}}){return t=Nt(t),Array.isArray(t)?t.some(s=>typeof s=="string")?m.assets.sprites.add(e,Promise.all(t.map(s=>typeof s=="string"?li(s):Promise.resolve(s))).then(s=>Vn(s,o))):m.assets.sprites.addLoaded(e,Vn(t,o)):typeof t=="string"?m.assets.sprites.add(e,Eo.from(t,o)):m.assets.sprites.addLoaded(e,Eo.fromImage(t,o))}function sr(e=1,t=1,o=0,s=0,i=1,a=1){let l=[],c=i/e,r=a/t;for(let n=0;n<t;n++)for(let d=0;d<e;d++)l.push(new Je(o+d*c,s+n*r,c,r));return l}function Vn(e,t={}){let o=document.createElement("canvas"),s=e[0].width,i=e[0].height;o.width=s*e.length,o.height=i;let a=o.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((c,r)=>{c instanceof ImageData?a.putImageData(c,r*s,0):a.drawImage(c,r*s,0)});let l=a.getImageData(0,0,e.length*s,i);return Eo.fromImage(l,{...t,sliceX:e.length,sliceY:1})}function Ih(e="bean"){return fs(e,Ch)}function Ph(e,t,o){t=Nt(t),o=Nt(o),typeof t=="string"&&!o&&(o=Oc(t)+".json");let s=typeof o=="string"?ri(o):Promise.resolve(o);return m.assets.sprites.add(e,s.then(i=>{let a=i.meta.size,l=i.frames.map(r=>new Je(r.frame.x/a.w,r.frame.y/a.h,r.frame.w/a.w,r.frame.h/a.h)),c={};for(let r of i.meta.frameTags)r.from===r.to?c[r.name]=r.from:c[r.name]={from:r.from,to:r.to,speed:10,loop:!0,pingpong:r.direction==="pingpong"};return Eo.from(t,{frames:l,anims:c})}))}var qs=class{constructor(e,t={}){L(this,"fontface");L(this,"filter",Hi);L(this,"outline",null);L(this,"size",64);if(this.fontface=e,this.filter=t.filter??Hi,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Le(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function ir(e){if(!e)return ir(m.globalOpt.font??xc);if(typeof e=="string"){let t=ar(e),o=nr(e);if(t)return t.data??t;if(o)return o.data??o;if(document.fonts.check(`64px ${e}`))return e;if(Oo()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof Ut)return e.data?e.data:e;return e}function nr(e){return m.assets.fonts.get(e)??null}function Bh(e,t,o={}){let s=Nt(t),i=new FontFace(e,typeof t=="string"?`url(${s})`:s);return document.fonts.add(i),m.assets.fonts.add(e,i.load().catch(a=>{throw new Error(`Failed to load font from "${s}": ${a}`)}).then(a=>new qs(a,o)))}function Oh(e,t,o,s){let i=e.width/t,a={},l=s.split("").entries();for(let[c,r]of l)a[r]=new Je(c%i*t,Math.floor(c/i)*o,t,o);return{tex:e,map:a,size:o}}function ar(e){return m.assets.bitmapFonts.get(e)??null}function Lh(e,t,o,s,i={}){let a=Nt(t);return m.assets.bitmapFonts.add(e,li(a).then(l=>Oh(bo.fromImage(m.gfx.ggl,l,i),o,s,i.chars??Ga)))}function zh(e,t){return t=Nt(t),m.assets.sprites.add(e,new Promise(async o=>{let s=typeof t=="string"?await ri(t):t,i=await Promise.all(s.frames.map(li)),a=document.createElement("canvas");a.width=s.width,a.height=s.height*s.frames.length;let l=a.getContext("2d");if(!l)throw new Error("Failed to create canvas context");i.forEach((r,n)=>{l.drawImage(r,0,n*s.height)});let c=await fs(null,a,{sliceY:s.frames.length,anims:s.anims});o(c)}))}var Hh=class{constructor(e,t,o,s){L(this,"ctx");L(this,"glProgram");this.ctx=e,e.onDestroy(()=>this.free());let i=e.gl,a=i.createShader(i.VERTEX_SHADER),l=i.createShader(i.FRAGMENT_SHADER);if(!a||!l)throw new Error("Failed to create shader");i.shaderSource(a,t),i.shaderSource(l,o),i.compileShader(a),i.compileShader(l);let c=i.createProgram();if(this.glProgram=c,i.attachShader(c,a),i.attachShader(c,l),s.forEach((r,n)=>i.bindAttribLocation(c,n,r)),i.linkProgram(c),!i.getProgramParameter(c,i.LINK_STATUS)){let r=i.getShaderInfoLog(a);if(r)throw new Error("VERTEX SHADER "+r);let n=i.getShaderInfoLog(l);if(n)throw new Error("FRAGMENT SHADER "+n)}i.deleteShader(a),i.deleteShader(l)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let o in e){let s=e[o],i=t.getUniformLocation(this.glProgram,o);if(typeof s=="number")t.uniform1f(i,s);else if(s instanceof Zt)t.uniformMatrix4fv(i,!1,new Float32Array(s.m));else if(s instanceof Ie)t.uniform3f(i,s.r,s.g,s.b);else if(s instanceof _)t.uniform2f(i,s.x,s.y);else if(Array.isArray(s))s[0],Cc(s)?t.uniform1fv(i,s):Dc(s)?t.uniform2fv(i,s.map(a=>[a.x,a.y]).flat()):Tc(s)&&t.uniform3fv(i,s.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function yn(e,t=Ni,o=Ui){let s=Ac.replace("{{user}}",t??Ni),i=vc.replace("{{user}}",o??Ui);try{return new Hh(e,s,i,pn.map(a=>a.name))}catch(a){let l=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,c=Lc(a).match(l);if(!(c!=null&&c.groups))throw a;let r=Number(c.groups.line)-14,n=c.groups.msg.trim(),d=c.groups.type.toLowerCase();throw new Error(`${d} shader line ${r}: ${n}`)}}function Nh(e){if(!e)return m.gfx.defShader;if(typeof e=="string"){let t=rr(e);if(t)return t.data??t;if(Oo()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof Ut)return e.data?e.data:e;return e}function rr(e){return m.assets.shaders.get(e)??null}function Uh(e,t,o){return m.assets.shaders.addLoaded(e,yn(m.gfx.ggl,t,o))}function qh(e,t,o){t=Nt(t),o=Nt(o);let s=a=>a?Mh(a):Promise.resolve(null),i=Promise.all([s(t),s(o)]).then(([a,l])=>yn(m.gfx.ggl,a,l));return m.assets.shaders.add(e,i)}var bs=class _s{constructor(t){L(this,"buf");this.buf=t}static fromArrayBuffer(t){return new Promise((o,s)=>m.audio.ctx.decodeAudioData(t,o,s)).then(o=>new _s(o))}static fromURL(t){return Qa(t)?_s.fromArrayBuffer(Pc(t)):Eh(t).then(o=>_s.fromArrayBuffer(o))}};function _h(e){if(typeof e=="string"){let t=lr(e);if(t)return t;if(Oo()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof bs)return Ut.loaded(e);if(e instanceof Ut)return e;throw new Error(`Invalid sound: ${e}`)}}function lr(e){return m.assets.sounds.get(e)??null}function Fh(e,t){return t=Nt(t),m.assets.sounds.add(e,typeof t=="string"?bs.fromURL(t):bs.fromArrayBuffer(t))}function Yh(e,t){let o=Nt(t),s=new Audio(o);return s.preload="auto",m.assets.music[e]=o}function cr(e,t){return e=Nt(e),Yi(typeof t=="string"?new Promise((o,s)=>{ri(t).then(i=>{cr(e,i).then(o).catch(s)})}):Eo.from(e).then(o=>{let s={};for(let i in t){let a=t[i],l=o.frames[0],c=2048*l.w,r=2048*l.h,n=a.frames?a.frames.map(u=>new Je(l.x+(a.x+u.x)/c*l.w,l.y+(a.y+u.y)/r*l.h,u.w/c*l.w,u.h/r*l.h)):sr(a.sliceX||1,a.sliceY||1,l.x+a.x/c*l.w,l.y+a.y/r*l.h,a.width/c*l.w,a.height/r*l.h),d=new Eo(o.tex,n,a.anims);m.assets.sprites.addLoaded(i,d),s[i]=d}return s}))}function Ro(e,t,o=!1,s,i,a={}){let l=s??m.gfx.defTex,c=i??m.gfx.defShader,r=Nh(c);if(!r||r instanceof Ut)return;let n=m.gfx.fixed||o?m.gfx.transform:m.game.cam.transform.mult(m.gfx.transform),d=[];for(let u of e){let h=yh(n.multVec2(u.pos));d.push(h.x,h.y,u.uv.x,u.uv.y,u.color.r/255,u.color.g/255,u.color.b/255,u.opacity)}m.gfx.renderer.push(m.gfx.ggl.gl.TRIANGLES,d,t,r,l,a)}function wo(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Ot(),Qe(e.pos),ws(e.scale),Ko(e.angle),Qe(e.offset),e.fill!==!1){let o=e.color??Ie.WHITE,s=e.pts.map((a,l)=>({pos:new _(a.x,a.y),uv:e.uv?e.uv[l]:new _(0,0),color:e.colors&&e.colors[l]?e.colors[l].mult(o):o,opacity:e.opacity??1})),i;e.triangulate?i=Xa(e.pts).map(a=>a.map(l=>e.pts.indexOf(l))).flat():i=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),Ro(s,e.indices??i,e.fixed,e.uv?e.tex:m.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&wn({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),St()}}function hr(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,o=e.end??360,s=Jo(e.anchor??"center").scale(new _(-e.radiusX,-e.radiusY)),i=rs(s,e.radiusX,e.radiusY,t,o,e.resolution);i.unshift(s);let a=Object.assign({},e,{pts:i,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(i.length-1).fill(e.gradient[1])]}:{}});if(o-t>=360&&e.outline){e.fill!==!1&&wo(Object.assign({},a,{outline:null})),wo(Object.assign({},a,{pts:i.slice(1),fill:!1}));return}wo(a)}function Qo(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&hr(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function cs(e){let{p1:t,p2:o}=e;if(!t||!o)throw new Error('drawLine() requires properties "p1" and "p2".');let s=e.width||1,i=o.sub(t).unit().normal().scale(s*.5),a=[t.sub(i),t.add(i),o.add(i),o.sub(i)].map(l=>({pos:new _(l.x,l.y),uv:new _(0),color:e.color??Ie.WHITE,opacity:e.opacity??1}));Ro(a,[0,1,3,1,2,3],e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function Xh(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||H(0,0),l;i?l=t[0].sub(t[t.length-2]):l=t[1].sub(t[0]);let c=l.len(),r=l.normal().scale(-s/c),n,d=t[0];if(!i)switch(e.cap){case"square":{let f=l.scale(-s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(-1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)o.push(d),o.push(d.sub(g)),g=H(g.x*w-g.y*E,g.x*E+g.y*w)}}for(let f=1;f<t.length;f++){if(d===t[f]||d.eq(t[f]))continue;n=d,d=t[f];let A=d.sub(n),g=A.len(),w=A.normal().scale(-s/g),E=l.cross(A);if(Math.abs(E)/(c*g)<.05){o.push(n.add(r)),o.push(n.sub(r)),l.dot(A)<0&&(o.push(n.sub(r)),o.push(n.add(r))),l=A,c=g,r=w;continue}let T=w.sub(r).cross(A)/E,q=r.add(l.scale(T));E>0?(o.push(n.add(q)),o.push(n.sub(r)),o.push(n.add(q)),o.push(n.sub(w))):(o.push(n.add(r)),o.push(n.sub(q)),o.push(n.add(w)),o.push(n.sub(q))),l=A,c=g,r=w}if(!i)switch(o.push(d.add(r)),o.push(d.sub(r)),e.cap){case"square":{let f=l.scale(s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)g=H(g.x*w-g.y*E,g.x*E+g.y*w),o.push(d),o.push(d.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:H(),color:e.color||Ie.WHITE,opacity:e.opacity??1})),h=[],x=0;for(let f=0;f<o.length-2;f+=2)h[x++]=f+1,h[x++]=f,h[x++]=f+2,h[x++]=f+2,h[x++]=f+3,h[x++]=f+1;i&&(h[x++]=o.length-1,h[x++]=o.length-2,h[x++]=0,h[x++]=0,h[x++]=1,h[x++]=o.length-1),Ro(u,h,e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function Gh(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||H(0,0),l;i?l=t[0].sub(t[t.length-2]):l=t[1].sub(t[0]);let c=l.len(),r=l.normal().scale(-s/c),n,d=t[0];if(!i)switch(e.cap){case"square":{let f=l.scale(-s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(-1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)o.push(d),o.push(d.sub(g)),g=H(g.x*w-g.y*E,g.x*E+g.y*w)}}for(let f=1;f<t.length;f++){if(d===t[f]||d.eq(t[f]))continue;n=d,d=t[f];let A=d.sub(n),g=A.len(),w=A.normal().scale(-s/g),E=l.cross(A);if(Math.abs(E)/(c*g)<.05){o.push(n.add(r)),o.push(n.sub(r)),l.dot(A)<0&&(o.push(n.sub(r)),o.push(n.add(r))),l=A,c=g,r=w;continue}let T=w.sub(r).cross(A)/E,q=r.add(l.scale(T));if(E>0){let U=n.add(q),p=Math.max(s,10),y=st(r.angleBetween(w)/p),b=r,v=Math.cos(y),D=Math.sin(y);for(let P=0;P<p;P++)o.push(U),o.push(n.sub(b)),b=H(b.x*v-b.y*D,b.x*D+b.y*v)}else{let U=n.sub(q),p=Math.max(s,10),y=st(r.angleBetween(w)/p),b=r,v=Math.cos(y),D=Math.sin(y);for(let P=0;P<p;P++)o.push(n.add(b)),o.push(U),b=H(b.x*v-b.y*D,b.x*D+b.y*v)}l=A,c=g,r=w}if(!i)switch(o.push(d.add(r)),o.push(d.sub(r)),e.cap){case"square":{let f=l.scale(s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)g=H(g.x*w-g.y*E,g.x*E+g.y*w),o.push(d),o.push(d.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:H(),color:e.color||Ie.WHITE,opacity:e.opacity??1})),h=[],x=0;for(let f=0;f<o.length-2;f+=2)h[x++]=f+1,h[x++]=f,h[x++]=f+2,h[x++]=f+2,h[x++]=f+3,h[x++]=f+1;i&&(h[x++]=o.length-1,h[x++]=o.length-2,h[x++]=0,h[x++]=0,h[x++]=1,h[x++]=o.length-1),Ro(u,h,e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function Kh(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||H(0,0),l;i?l=t[0].sub(t[t.length-2]):l=t[1].sub(t[0]);let c=l.len(),r=l.normal().scale(-s/c),n,d=t[0];if(!i)switch(e.cap){case"square":{let f=l.scale(-s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(-1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)o.push(d),o.push(d.sub(g)),g=H(g.x*w-g.y*E,g.x*E+g.y*w)}}for(let f=1;f<t.length;f++){if(d===t[f]||d.eq(t[f]))continue;n=d,d=t[f];let A=d.sub(n),g=A.len(),w=A.normal().scale(-s/g),E=l.cross(A);if(Math.abs(E)/(c*g)<.05){o.push(n.add(r)),o.push(n.sub(r)),l.dot(A)<0&&(o.push(n.sub(r)),o.push(n.add(r))),l=A,c=g,r=w;continue}let T=w.sub(r).cross(A)/E,q=r.add(l.scale(T));o.push(n.add(q)),o.push(n.sub(q)),l=A,c=g,r=w}if(!i)switch(o.push(d.add(r)),o.push(d.sub(r)),e.cap){case"square":{let f=l.scale(s/c);o.push(d.add(f).add(r)),o.push(d.add(f).sub(r));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=r.scale(1),w=Math.cos(A),E=Math.sin(A);for(let T=0;T<f;T++)g=H(g.x*w-g.y*E,g.x*E+g.y*w),o.push(d),o.push(d.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:H(),color:e.color||Ie.WHITE,opacity:e.opacity??1})),h=[],x=0;for(let f=0;f<o.length-2;f+=2)h[x++]=f+1,h[x++]=f,h[x++]=f+2,h[x++]=f+2,h[x++]=f+3,h[x++]=f+1;i&&(h[x++]=o.length-1,h[x++]=o.length-2,h[x++]=0,h[x++]=0,h[x++]=1,h[x++]=o.length-1),Ro(u,h,e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function wn(e){let t=e.pts,o=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return Xh(e);case"round":return Gh(e);case"miter":return Kh(e)}if(e.radius&&t.length>=3){cs(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let s=1;s<t.length-2;s++){let i=t[s],a=t[s+1];cs(Object.assign({},e,{p1:i,p2:a}))}cs(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let s=0;s<t.length-1;s++)cs(Object.assign({},e,{p1:t[s],p2:t[s+1]})),e.join!=="none"&&Qo(Object.assign({},e,{pos:t[s],radius:o/2}))}}function dr(e,t){let o=t.segments??16,s=[];for(let i=0;i<=o;i++)s.push(e(i/o));wn({pts:s,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Vh(e){dr(t=>un(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var bo=class ur{constructor(t,o,s,i={}){L(this,"ctx");L(this,"src",null);L(this,"glTex");L(this,"width");L(this,"height");this.ctx=t;let a=t.gl,l=t.gl.createTexture();if(!l)throw new Error("Failed to create texture");this.glTex=l,t.onDestroy(()=>this.free()),this.width=o,this.height=s;let c={linear:a.LINEAR,nearest:a.NEAREST}[i.filter??t.opts.texFilter??"nearest"],r={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[i.wrap??"clampToEdge"];this.bind(),o&&s&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,o,s,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,r),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,o,s={}){let i=new ur(t,o.width,o.height,s);return i.update(o),i.src=o,i}update(t,o=0,s=0){let i=this.ctx.gl;this.bind(),i.texSubImage2D(i.TEXTURE_2D,0,o,s,i.RGBA,i.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},js=class{constructor(e,t,o,s={}){L(this,"ctx");L(this,"tex");L(this,"glFramebuffer");L(this,"glRenderbuffer");this.ctx=e;let i=e.gl;e.onDestroy(()=>this.free()),this.tex=new bo(e,t,o,s);let a=i.createFramebuffer(),l=i.createRenderbuffer();if(!a||!l)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=l,this.bind(),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t,o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.tex.glTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let o=this.width*4,s=new Uint8Array(o);for(let i=0;i<(this.height/2|0);i++){let a=i*o,l=(this.height-i-1)*o;s.set(t.subarray(a,a+o)),t.copyWithin(a,l,l+o),t.set(s,l)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},jh=class{constructor(e,t,o,s){L(this,"ctx");L(this,"glVBuf");L(this,"glIBuf");L(this,"vqueue",[]);L(this,"iqueue",[]);L(this,"stride");L(this,"maxVertices");L(this,"maxIndices");L(this,"vertexFormat");L(this,"numDraws",0);L(this,"curPrimitive",null);L(this,"curTex",null);L(this,"curShader",null);L(this,"curUniform",{});let i=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((l,c)=>l+c.size,0),this.maxVertices=o,this.maxIndices=s;let a=i.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),i.bufferData(i.ARRAY_BUFFER,o*4,i.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=i.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),i.bufferData(i.ELEMENT_ARRAY_BUFFER,s*4,i.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,o,s,i=null,a={}){(e!==this.curPrimitive||i!==this.curTex||s!==this.curShader||!gn(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+o.length>this.maxIndices)&&this.flush();let l=this.vqueue.length/this.stride;for(let c of t)this.vqueue.push(c);for(let c of o)this.iqueue.push(c+l);this.curPrimitive=e,this.curShader=s,this.curTex=i,this.curUniform=a}flush(){var t,o;if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),(t=this.curTex)==null||t.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),(o=this.curTex)==null||o.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function To(e){let t=[],o=a=>{t.push(a),e(a)},s=()=>{t.pop(),e(i()??null)},i=()=>t[t.length-1];return[o,s,i]}function Wh(e,t={}){let o=[];function s(U){o.push(U)}function i(){o.forEach(p=>p());let U=e.getExtension("WEBGL_lose_context");U&&U.loseContext()}let a=null;function l(U){if(gn(U,a))return;a=U;let p=U.reduce((y,b)=>y+b.size,0);U.reduce((y,b,v)=>(e.vertexAttribPointer(v,b.size,e.FLOAT,!1,p*4,y),e.enableVertexAttribArray(v),y+b.size*4),0)}let[c,r]=To(U=>e.bindTexture(e.TEXTURE_2D,U)),[n,d]=To(U=>e.bindBuffer(e.ARRAY_BUFFER,U)),[u,h]=To(U=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,U)),[x,f]=To(U=>e.bindFramebuffer(e.FRAMEBUFFER,U)),[A,g]=To(U=>e.bindRenderbuffer(e.RENDERBUFFER,U)),[w,E]=To(U=>{if(!U)return;let{x:p,y,w:b,h:v}=U;e.viewport(p,y,b,v)}),[T,q]=To(U=>e.useProgram(U));return w({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:s,destroy:i,pushTexture2D:c,popTexture2D:r,pushArrayBuffer:n,popArrayBuffer:d,pushElementArrayBuffer:u,popElementArrayBuffer:h,pushFramebuffer:x,popFramebuffer:f,pushRenderbuffer:A,popRenderbuffer:g,pushViewport:w,popViewport:E,pushProgram:T,popProgram:q,setVertexFormat:l}}var vi={};function jn(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(H(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function Xi(e){let t={},o="",s=[],i=String(e),a=l=>{s.length>0&&(t[o.length]=s.slice()),o+=l};for(;i!=="";){if(i[0]==="\\"){if(i.length===1)throw new Error("Styled text error: \\ at end of string");a(i[1]),i=i.slice(2);continue}if(i[0]==="["){let l=/^\[(\/)?(\w+?)\]/.exec(i);if(!l){a(i[0]),i=i.slice(1);continue}let[c,r,n]=l;if(r!==void 0){let d=s.pop();if(d!==n)throw d!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${d}], got [/${n}]`):new Error(`Styled text error: stray end tag [/${n}]`)}else s.push(n);i=i.slice(c.length);continue}a(i[0]),i=i.slice(1)}if(s.length>0)throw new Error(`Styled text error: unclosed tags ${s}`);return{charStyleMap:t,text:o}}function Lo(e){var T,q,U;if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=ir(e.font);if(!e.text||e.text===""||t instanceof Ut||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:o,text:s}=Xi(e.text+""),i=Nc(s);if(t instanceof qs||typeof t=="string"){let p=t instanceof qs?t.fontface.family:t,y=t instanceof qs?{outline:t.outline,filter:t.filter}:{outline:null,filter:Hi},b=vi[p]??{font:{tex:new bo(m.gfx.ggl,2048,2048,{filter:y.filter}),map:{},size:64},cursor:new _(0),maxHeight:0,outline:y.outline};vi[p]||(vi[p]=b),t=b.font;for(let v of i)if(!b.font.map[v]){let D=m.fontCacheC2d;if(!D)throw new Error("fontCacheC2d is not defined.");if(!m.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");D.clearRect(0,0,m.fontCacheCanvas.width,m.fontCacheCanvas.height),D.font=`${t.size}px ${p}`,D.textBaseline="top",D.textAlign="left",D.fillStyle="#ffffff";let P=D.measureText(v),O=Math.ceil(P.width);if(!O)continue;let I=Math.ceil(Math.abs(P.actualBoundingBoxAscent))+Math.ceil(Math.abs(P.actualBoundingBoxDescent));b.outline&&b.outline.width&&b.outline.color&&(D.lineJoin="round",D.lineWidth=b.outline.width*2,D.strokeStyle=b.outline.color.toHex(),D.strokeText(v,b.outline.width,b.outline.width),O+=b.outline.width*2,I+=b.outline.width*3),D.fillText(v,((T=b.outline)==null?void 0:T.width)??0,((q=b.outline)==null?void 0:q.width)??0);let R=D.getImageData(0,0,O,I);if(b.cursor.x+O>2048&&(b.cursor.x=0,b.cursor.y+=b.maxHeight,b.maxHeight=0,b.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(R,b.cursor.x,b.cursor.y),t.map[v]=new Je(b.cursor.x,b.cursor.y,O,I),b.cursor.x+=O+1,b.maxHeight=Math.max(b.maxHeight,I)}}let a=e.size||t.size,l=H(e.scale??1).scale(a/t.size),c=e.lineSpacing??0,r=e.letterSpacing??0,n=0,d=0,u=0,h=[],x=[],f=0,A=null,g=0,w;for(;f<i.length;){let p=i[f];if(p===`
`)u+=a+c,h.push({width:n-r,chars:x}),A=null,g=0,n=0,x=[],w=void 0;else{let y=t.map[p];if(y){let b=y.w*l.x;e.width&&n+b>e.width&&(u+=a+c,A!=null&&(f-=x.length-A,p=i[f],y=t.map[p],b=y.w*l.x,x=x.slice(0,A-1),n=g),A=null,g=0,h.push({width:n-r,chars:x}),n=w??0,x=[]),x.push({tex:t.tex,width:y.w,height:y.h,quad:new Je(y.x/t.tex.width,y.y/t.tex.height,y.w/t.tex.width,y.h/t.tex.height),ch:p,pos:new _(n,u),opacity:e.opacity??1,color:e.color??Ie.WHITE,scale:H(l),angle:0}),p===" "&&(A=x.length,g=n),e.indentAll&&w===void 0&&/\S/.test(p)&&(w=n),n+=b,d=Math.max(d,n),n+=r}}f++}h.push({width:n-r,chars:x}),u+=a,e.width&&(d=e.width);let E=[];for(let p=0;p<h.length;p++){let y=(d-h[p].width)*dh(e.align??"left");for(let b of h[p].chars){let v=t.map[b.ch],D=E.length+p;if(b.pos=b.pos.add(y,0).add(v.w*l.x*.5,v.h*l.y*.5),e.transform){let P=typeof e.transform=="function"?e.transform(D,b.ch):e.transform;P&&jn(b,P)}if(o[D]){let P=o[D];for(let O of P){let I=(U=e.styles)==null?void 0:U[O],R=typeof I=="function"?I(D,b.ch):I;R&&jn(b,R)}}E.push(b)}}return{width:d,height:u,chars:E,opt:e,renderedText:s}}function As(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,s=Jo(e.anchor||ai).scale(new _(t,o).scale(-.5)),i=e.quad||new Je(0,0,1,1),a=e.color||Le(255,255,255),l=e.opacity??1,c=e.tex?.1/e.tex.width:0,r=e.tex?.1/e.tex.height:0,n=i.x+c,d=i.y+r,u=i.w-c*2,h=i.h-r*2;Ot(),Qe(e.pos),Ko(e.angle),ws(e.scale),Qe(s),Ro([{pos:new _(-t/2,o/2),uv:new _(e.flipX?n+u:n,e.flipY?d:d+h),color:a,opacity:l},{pos:new _(-t/2,-o/2),uv:new _(e.flipX?n+u:n,e.flipY?d+h:d),color:a,opacity:l},{pos:new _(t/2,-o/2),uv:new _(e.flipX?n:n+u,e.flipY?d+h:d),color:a,opacity:l},{pos:new _(t/2,o/2),uv:new _(e.flipX?n:n+u,e.flipY?d:d+h),color:a,opacity:l}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),St()}function zo(e){Ot(),Qe(e.opt.pos),Ko(e.opt.angle),Qe(Jo(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{As({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),St()}function zt(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,s=Jo(e.anchor||ai).add(1,1).scale(new _(t,o).scale(-.5)),i=[new _(0,0),new _(t,0),new _(t,o),new _(0,o)];if(e.radius){let a=Math.min(t,o)/2,l=Array.isArray(e.radius)?e.radius.map(c=>Math.min(a,c)):new Array(4).fill(Math.min(a,e.radius));i=[new _(l[0],0),...l[1]?rs(new _(t-l[1],l[1]),l[1],l[1],270,360):[H(t,0)],...l[2]?rs(new _(t-l[2],o-l[2]),l[2],l[2],0,90):[H(t,o)],...l[3]?rs(new _(l[3],o-l[3]),l[3],l[3],90,180):[H(0,o)],...l[0]?rs(new _(l[0],l[0]),l[0],l[0],180,270):[]]}wo(Object.assign({},e,{offset:s,pts:i,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function yo(e){Lt();let t=m.gfx.width,o=m.gfx.height;m.gfx.width=m.gfx.viewport.width,m.gfx.height=m.gfx.viewport.height,e(),Lt(),m.gfx.width=t,m.gfx.height=o}function Wn(e,t){yo(()=>{let o=H(8);Ot(),Qe(e);let s=Lo({text:t,font:Ks,size:16,pos:o,color:Le(255,255,255),fixed:!0}),i=s.width+o.x*2,a=s.height+o.x*2;e.x+i>=ft()&&Qe(H(-i,0)),e.y+a>=xt()&&Qe(H(0,-a)),zt({width:i,height:a,color:Le(0,0,0),radius:4,opacity:.8,fixed:!0}),zo(s),St()})}function pr(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return wo(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function $h(){if(m.debug.inspect){let e=null;for(let t of m.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(m.game.root.drawInspect(),e){let t=[],o=e.inspect();for(let s in o)o[s]?t.push(`${o[s]}`):t.push(`${s}`);Wn($c(m.k.mousePos()),t.join(`
`))}Wn(H(8),`FPS: ${m.debug.fps()}`)}m.debug.paused&&yo(()=>{Ot(),Qe(ft(),0),Qe(-8,8);let e=32;zt({width:e,height:e,anchor:"topright",color:Le(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)zt({width:4,height:e*.6,anchor:"center",pos:H(-e/3*t,e*.5),color:Le(255,255,255),radius:2,fixed:!0});St()}),m.debug.timeScale!==1&&yo(()=>{Ot(),Qe(ft(),xt()),Qe(-8,-8);let e=8,t=Lo({text:m.debug.timeScale.toFixed(1),font:Ks,size:16,color:Le(255,255,255),pos:H(-e),anchor:"botright",fixed:!0});zt({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Le(0,0,0),opacity:.8,radius:4,fixed:!0});for(let o=0;o<2;o++){let s=m.debug.timeScale<1;pr({p1:H(-t.width-e*(s?2:3.5),-e),p2:H(-t.width-e*(s?2:3.5),-e-t.height),p3:H(-t.width-e*(s?3.5:2),-e-t.height/2),pos:H(-o*e*1+(s?-e*.5:0),0),color:Le(255,255,255),fixed:!0})}zo(t),St()}),m.debug.curRecording&&yo(()=>{Ot(),Qe(0,xt()),Qe(24,-24),Qo({radius:12,color:Le(255,0,0),opacity:Ta(0,1,m.app.time()*4),fixed:!0}),St()}),m.debug.showLog&&m.game.logs.length>0&&yo(()=>{Ot(),Qe(0,xt()),Qe(8,-8);let e=8,t=[];for(let s of m.game.logs){let i="",a=s.msg instanceof Error?"error":"info";i+=`[time]${s.time.toFixed(2)}[/time]`,i+=" ",i+=`[${a}]${Gi(s.msg)}[/${a}]`,t.push(i)}m.game.logs=m.game.logs.filter(s=>m.app.time()-s.time<(m.globalOpt.logTime||4));let o=Lo({text:t.join(`
`),font:Ks,pos:H(e,-e),anchor:"botleft",size:16,width:ft()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Le(127,127,127)},info:{color:Le(255,255,255)},error:{color:Le(255,0,127)}}});zt({width:o.width+e*2,height:o.height+e*2,anchor:"botleft",color:Le(0,0,0),radius:4,opacity:.8,fixed:!0}),zo(o),St()})}function Gi(e,t=!1,o=new Set){if(o.has(e))return"<recursive>";var s="",i;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(s=["[",e.map(a=>Gi(a,!0,o.union(new Set([e])))).join(", "),"]"].join(""),e=s),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(s+=e.constructor.name+" "),s+=["{",(i=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${Gi(e[a],!0,o.union(new Set([e])))}`).join(", "))?` ${i} `:"","}"].join(""),e=s),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function Jh(){let e=m.game.cam,t=_.fromAngle(ht(0,360)).scale(e.shake);e.shake=Rt(e.shake,0,5*dt()),e.transform=new Zt().translate(Vs()).scale(e.scale).rotate(e.angle).translate((e.pos??Vs()).scale(-1).add(t)),m.game.root.draw(),Lt()}function Qh(){let e=Oo();m.game.events.numListeners("loading")>0?m.game.events.trigger("loading",e):yo(()=>{let t=ft()/2,o=24,s=H(ft()/2,xt()/2).sub(H(t/2,o/2));zt({pos:H(0),width:ft(),height:xt(),color:Le(0,0,0)}),zt({pos:s,width:t,height:o,fill:!1,outline:{width:4}}),zt({pos:s,width:t*e,height:o})})}function fr(e,t,o){let s=m.gfx.ggl.gl;Lt(),s.clear(s.STENCIL_BUFFER_BIT),s.enable(s.STENCIL_TEST),s.stencilFunc(s.NEVER,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),t(),Lt(),s.stencilFunc(o,1,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),e(),Lt(),s.disable(s.STENCIL_TEST)}function Zh(e,t){let o=m.gfx.ggl.gl;fr(e,t,o.EQUAL)}function Ws(e){var a,l;if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new Je(0,0,1,1),o=e.tex.width*t.w,s=e.tex.height*t.h,i=new _(1);if(e.tiled){let c=Jo(e.anchor||ai);(((a=e.pos)==null?void 0:a.x)||0)-(c.x+1)*.5*(e.width||o),(((l=e.pos)==null?void 0:l.y)||0)-(c.y+1)*.5*(e.height||s);let r=(e.width||o)/o,n=(e.height||s)/s,d=Math.floor(r),u=Math.floor(n),h=r-d,x=n-u,f=(d+h?1:0)*(u+x?1:0),A=new Array(f*6),g=new Array(f*4),w=0,E=(T,q,U,p,y)=>{A[w*6+0]=w*4+0,A[w*6+1]=w*4+1,A[w*6+2]=w*4+3,A[w*6+3]=w*4+1,A[w*6+4]=w*4+2,A[w*6+5]=w*4+3,g[w*4+0]={pos:new _(T-c.x,q-c.y),uv:new _(y.x,y.y),color:e.color||Ie.WHITE,opacity:e.opacity||1},g[w*4+1]={pos:new _(T+U-c.x,q-c.y),uv:new _(y.x+y.w,y.y),color:e.color||Ie.WHITE,opacity:e.opacity||1},g[w*4+2]={pos:new _(T+U-c.x,q+p-c.y),uv:new _(y.x+y.w,y.y+y.h),color:e.color||Ie.WHITE,opacity:e.opacity||1},g[w*4+3]={pos:new _(T-c.x,q+p-c.y),uv:new _(y.x,y.y+y.h),color:e.color||Ie.WHITE,opacity:e.opacity||1},w++};for(let T=0;T<u;T++){for(let q=0;q<d;q++)E(q*o,T*s,o,s,t);h&&E(d*o,T*s,o*h,s,new Je(t.x,t.y,t.w*h,t.h))}if(x){for(let T=0;T<d;T++)E(T*o,u*s,o,s*x,new Je(t.x,t.y,t.w,t.h*x));h&&E(d*o,u*s,o*h,s*x,new Je(t.x,t.y,t.w*h,t.h*x))}Ro(g,A,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(i.x=e.width/o,i.y=e.height/s):e.width?(i.x=e.width/o,i.y=i.x):e.height&&(i.y=e.height/s,i.x=i.y),As(Object.assign({},e,{scale:i.scale(e.scale||new _(1)),tex:e.tex,quad:t,width:o,height:s}))}function kh(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Us(e.sprite);if(!t||!t.data)return;let o=t.data.frames[e.frame??0];if(!o)throw new Error(`Frame not found: ${e.frame??0}`);Ws(Object.assign({},e,{tex:t.data.tex,quad:o.scale(e.quad??new Je(0,0,1,1))}))}function ed(e,t){let o=m.gfx.ggl.gl;fr(e,t,o.NOTEQUAL)}function $n(e){zo(Lo(e))}var td=(e,t)=>{let o=yn(t,Ni,Ui),s=e.pixelDensity??1,i=e.scale??1,{gl:a}=t,l=bo.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),c=e.width&&e.height?new js(t,e.width*s*i,e.height*s*i):new js(t,a.drawingBufferWidth,a.drawingBufferHeight),r=null,n=1;e.background&&(typeof e.background=="string"?r=Le(e.background):(r=Le(...e.background),n=e.background[3]??1),a.clearColor(r.r/255,r.g/255,r.b/255,n??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let d=new jh(t,pn,wc,bc),u=bo.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:o,defTex:l,frameBuffer:c,postShader:null,postShaderUniform:null,renderer:d,transform:new Zt,transformStack:[],bgTex:u,bgColor:r,bgAlpha:n,width:e.width??a.drawingBufferWidth/s/i,height:e.height??a.drawingBufferHeight/s/i,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function Po(e){return e.fixed?!0:e.parent?Po(e.parent):!1}function Ho(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function od(e,t={}){return{id:"circle",radius:e,draw(){Qo(Object.assign(Ho(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Fe(new _(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function gr(...e){return{id:"color",color:Le(...e),inspect(){return`color: ${this.color.toString()}`}}}function sd(e){return{add(){this.canvas=e}}}function id(e=1){let t,o=0,s=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){s||(o+=dt(),this.opacity=$t(o,0,e,0,t),o>=e&&(this.opacity=t,s=!0))}}}function nd(e="intersect"){return{id:"mask",mask:e}}function mr(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,o=m.k.easings.linear){return m.game.root.tween(0,this.opacity,t,s=>this.opacity=s,o)},fadeOut(t=1,o=m.k.easings.linear){return m.game.root.tween(this.opacity,0,t,s=>this.opacity=s,o)},inspect(){return`opacity: ${qi(this.opacity,1)}`}}}function ad(e=1,t=Le(0,0,0),o=1,s="miter",i=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:o,join:s,miterLimit:i,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var rd=class{constructor(){L(this,"pos",H(0));L(this,"vel",H(0));L(this,"acc",H(0));L(this,"angle",0);L(this,"angularVelocity",0);L(this,"damping",0);L(this,"t");L(this,"lt",null);L(this,"gc");this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function ld(e,t){let o=t.lifetime,s=[],i=e.colors||[Ie.WHITE],a=e.opacities||[1],l=e.quads||[new Je(0,0,1,1)],c=e.scales||[1],r=e.lifeTime,n=t.direction,d=t.spread,u=e.speed||[0,0],h=e.angle||[0,0],x=e.angularVelocity||[0,0],f=e.acceleration||[H(0),H(0)],A=e.damping||[0,0],g=[],w=new Array(e.max),E=0,T=0;for(let p=0;p<e.max;p++){g[p*6+0]=p*4+0,g[p*6+1]=p*4+1,g[p*6+2]=p*4+3,g[p*6+3]=p*4+1,g[p*6+4]=p*4+2,g[p*6+5]=p*4+3;for(let y=0;y<4;y++)w[p*4+y]={pos:new _(0,0),uv:new _(0,0),color:Le(255,255,255),opacity:1};s[p]=new rd}let q=new bt;function U(p=0){for(;p<e.max;){if(s[p].gc)return p;p++}return null}return{id:"particles",emit(p){let y=0;for(let b=0;b<p;b++){if(y=U(y),y==null)return;let v=ht(n-d,n+d),D=_.fromAngle(v).scale(ht(u[0],u[1])),P=ht(h[0],h[1]),O=ht(x[0],x[1]),I=H(ht(f[0].x,f[1].x),ht(f[0].y,f[1].y)),R=ht(A[0],A[1]),N=r?ht(r[0],r[1]):null,Y=t.shape?t.shape.random():H(),j=s[y];j.lt=N,j.pos=Y,j.vel=D,j.acc=I,j.angle=P,j.angularVelocity=O,j.damping=R,j.angularVelocity=O,j.gc=!1}E+=p},update(){if(o!==void 0&&o<=0)return;let p=dt();for(let y of s)if(!y.gc){if(y.t+=p,y.lt&&y.t>=y.lt){y.gc=!0,E--;continue}y.vel=y.vel.add(y.acc.scale(p)).scale(1-y.damping*p),y.pos=y.pos.add(y.vel.scale(p)),y.angle+=y.angularVelocity*p}for(o!==void 0&&(o-=p,o<=0&&q.trigger()),T+=p;E<e.max&&t.rate&&T>t.rate;)this.emit(1),E++,T-=t.rate},draw(){if(!(o!==void 0&&o<=0)){for(let p=0;p<s.length;p++){let y=s[p];if(y.gc)continue;let b=y.progress,v=Math.floor(y.progress*i.length),D=v<i.length-1?Rt(i[v],i[v+1],$t(b,v/i.length,(v+1)/i.length,0,1)):i[v],P=Math.floor(y.progress*a.length),O=P<a.length-1?Rt(a[P],a[P+1],$t(b,P/a.length,(P+1)/a.length,0,1)):a[P],I=Math.floor(y.progress*l.length),R=l[I],N=Math.floor(y.progress*c.length),Y=c[N],j=Math.cos(y.angle*Math.PI/180),k=Math.sin(y.angle*Math.PI/180),G=(e.texture?e.texture.width:10)*R.w/2,Q=(e.texture?e.texture.height:10)*R.h/2,pe=p*4,ee=w[pe];ee.pos.x=y.pos.x+-G*Y*j- -Q*Y*k,ee.pos.y=y.pos.y+-G*Y*k+-Q*Y*j,ee.uv.x=R.x,ee.uv.y=R.y,ee.color.r=D.r,ee.color.g=D.g,ee.color.b=D.b,ee.opacity=O,ee=w[pe+1],ee.pos.x=y.pos.x+G*Y*j- -Q*Y*k,ee.pos.y=y.pos.y+G*Y*k+-Q*Y*j,ee.uv.x=R.x+R.w,ee.uv.y=R.y,ee.color.r=D.r,ee.color.g=D.g,ee.color.b=D.b,ee.opacity=O,ee=w[pe+2],ee.pos.x=y.pos.x+G*Y*j-Q*Y*k,ee.pos.y=y.pos.y+G*Y*k+Q*Y*j,ee.uv.x=R.x+R.w,ee.uv.y=R.y+R.h,ee.color.r=D.r,ee.color.g=D.g,ee.color.b=D.b,ee.opacity=O,ee=w[pe+3],ee.pos.x=y.pos.x+-G*Y*j-Q*Y*k,ee.pos.y=y.pos.y+-G*Y*k+Q*Y*j,ee.uv.x=R.x,ee.uv.y=R.y+R.h,ee.color.r=D.r,ee.color.g=D.g,ee.color.b=D.b,ee.opacity=O}Ro(w,g,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(p){return q.add(p)},inspect(){return`count: ${E}/${e.max}`}}}function cd(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){wo(Object.assign(Ho(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new At(this.pts)},inspect(){return`polygon: ${this.pts.map(o=>`[${o.x},${o.y}]`).join(",")}`}}}function xr(e,t,o){let s;return m.game.root.get("area").forEach(i=>{if(o&&o.some(l=>i.is(l)))return;let a=i.worldArea().raycast(e,t);a&&(s?a.fraction<s.fraction&&(s=a,s.object=i):(s=a,s.object=i))}),s}function yr(e,t,o={}){return{id:"rect",width:e,height:t,radius:o.radius||0,draw(){zt(Object.assign(Ho(this),{width:this.width,height:this.height,radius:this.radius,fill:o.fill}))},renderArea(){return new Fe(H(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function hd(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function dd(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let o=m.game.root.add([$s(t.pos??H(0))]),s=e.length,i=0,a=null,l=null,c=null,r=null,n=p=>p.x+p.y*i,d=p=>H(Math.floor(p%i),Math.floor(p/i)),u=()=>{a=[];for(let p of o.children)h(p)},h=p=>{let y=n(p.tilePos);a[y]?a[y].push(p):a[y]=[p]},x=p=>{let y=n(p.tilePos);if(a[y]){let b=a[y].indexOf(p);b>=0&&a[y].splice(b,1)}},f=()=>{let p=!1;for(let y of o.children){let b=o.pos2Tile(y.pos);(y.tilePos.x!=b.x||y.tilePos.y!=b.y)&&(p=!0,x(y),y.tilePos.x=b.x,y.tilePos.y=b.y,h(y))}p&&o.trigger("spatialMapChanged")},A=()=>{let p=o.getSpatialMap(),y=o.numRows()*o.numColumns();l?l.length=y:l=new Array(y),l.fill(1,0,y);for(let b=0;b<p.length;b++){let v=p[b];if(v){let D=0;for(let P of v)if(P.isObstacle){D=1/0;break}else D+=P.cost;l[b]=D||1}}},g=()=>{let p=o.getSpatialMap(),y=o.numRows()*o.numColumns();c?c.length=y:c=new Array(y),c.fill(15,0,y);for(let b=0;b<p.length;b++){let v=p[b];if(v){let D=v.length,P=15;for(let O=0;O<D;O++)P|=v[O].edgeMask;c[b]=P}}},w=()=>{let p=o.numRows()*o.numColumns(),y=(v,D)=>{let P=[];for(P.push(v);P.length>0;){let O=P.pop();q(O).forEach(I=>{r[I]<0&&(r[I]=D,P.push(I))})}};r?r.length=p:r=new Array(p),r.fill(-1,0,p);let b=0;for(let v=0;v<l.length;v++){if(r[v]>=0){b++;continue}y(v,b),b++}},E=(p,y)=>l[y],T=(p,y)=>{let b=d(p),v=d(y);return b.dist(v)},q=(p,y)=>{let b=[],v=Math.floor(p%i),D=v>0&&c[p]&1&&l[p-1]!==1/0,P=p>=i&&c[p]&2&&l[p-i]!==1/0,O=v<i-1&&c[p]&4&&l[p+1]!==1/0,I=p<i*s-i-1&&c[p]&8&&l[p+i]!==1/0;return y?(D&&(P&&b.push(p-i-1),b.push(p-1),I&&b.push(p+i-1)),P&&b.push(p-i),O&&(P&&b.push(p-i+1),b.push(p+1),I&&b.push(p+i+1)),I&&b.push(p+i)):(D&&b.push(p-1),P&&b.push(p-i),O&&b.push(p+1),I&&b.push(p+i)),b},U={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(p,...y){let b=H(...y),v=(()=>{if(typeof p=="string"){if(t.tiles[p]){if(typeof t.tiles[p]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[p](b)}else if(t.wildcardTile)return t.wildcardTile(p,b)}else{if(Array.isArray(p))return p;throw new Error("Expected a symbol or a component list")}})();if(!v)return null;let D=!1,P=!1;for(let I of v)I.id==="tile"&&(P=!0),I.id==="pos"&&(D=!0);D||v.push($s(this.tile2Pos(b))),P||v.push(Hr());let O=o.add(v);return D&&(O.tilePosOffset=O.pos.clone()),O.tilePos=b,O.transform=ps(O),a&&(h(O),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),O},numColumns(){return i},numRows(){return s},levelWidth(){return i*this.tileWidth()},levelHeight(){return s*this.tileHeight()},tile2Pos(...p){return H(...p).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...p){let y=H(...p);return H(Math.floor(y.x/this.tileWidth()),Math.floor(y.y/this.tileHeight()))},getSpatialMap(){return a||u(),a},removeFromSpatialMap:x,insertIntoSpatialMap:h,onSpatialMapChanged(p){return this.on("spatialMapChanged",p)},onNavigationMapInvalid(p){return this.on("navigationMapInvalid",p)},getAt(p){a||u();let y=n(p);return a[y]||[]},raycast(p,y){let b=this.toWorld(p),v=this.toWorld(p.add(y)).sub(b),D=1/this.tileWidth(),P=p.scale(D),O=Vl(P,y,I=>{let R=this.getAt(I);if(R.some(Y=>Y.isObstacle))return!0;let N=null;for(let Y of R)if(Y.has("area")){let j=Y.worldArea().raycast(b,v);j&&(N?j.fraction<N.fraction&&(N=j,N.object=Y):(N=j,N.object=Y))}return N&&(N.point=this.fromWorld(N.point).scale(D)),N||!1},64);return O&&(O.point=O.point.scale(this.tileWidth())),O},update(){a&&f()},invalidateNavigationMap(){l=null,c=null,r=null},onNavigationMapChanged(p){return this.on("navigationMapChanged",p)},getTilePath(p,y,b={}){var j;if(l||A(),c||g(),r||w(),p.x<0||p.x>=i||p.y<0||p.y>=s||y.x<0||y.x>=i||y.y<0||y.y>=s)return null;let v=n(p),D=n(y);if(l[D]===1/0)return null;if(v===D)return[];if(r[v]!=-1&&r[v]!==r[D])return null;let P=new $a((k,G)=>k.cost<G.cost);P.insert({cost:0,node:v});let O=new Map;O.set(v,v);let I=new Map;for(I.set(v,0);P.length!==0;){let k=(j=P.remove())==null?void 0:j.node;if(k===D)break;let G=q(k,b.allowDiagonals);for(let Q of G){let pe=(I.get(k)||0)+E(k,Q)+T(Q,D);(!I.has(Q)||pe<I.get(Q))&&(I.set(Q,pe),P.insert({cost:pe,node:Q}),O.set(Q,k))}}let R=[],N=D,Y=d(N);for(R.push(Y);N!==v;){let k=O.get(N);if(k===void 0)throw new Error("Bug in pathfinding algorithm");N=k;let G=d(N);R.push(G)}return R.reverse()},getPath(p,y,b={}){let v=this.tileWidth(),D=this.tileHeight(),P=this.getTilePath(this.pos2Tile(p),this.pos2Tile(y),b);return P?[p,...P.slice(1,-1).map(O=>O.scale(v,D).add(v/2,D/2)),y]:null}};return o.use(U),o.onNavigationMapInvalid(()=>{o.invalidateNavigationMap(),o.trigger("navigationMapChanged")}),e.forEach((p,y)=>{let b=p.split("");i=Math.max(b.length,i),b.forEach((v,D)=>{o.spawn(v,H(D,y))})}),o}function Ct(e,t,o){return m.game.objEvents.registers[e]||(m.game.objEvents.registers[e]=new ja),m.game.objEvents.on(e,(s,...i)=>{s.is(t)&&o(s,...i)})}var ud=(e,t,...o)=>{for(let s of m.game.root.children)s.is(t)&&s.trigger(e,o)},pd=Ve(e=>{let t=m.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ct("fixedUpdate",e,t)),wr=Ve(e=>{let t=m.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ct("update",e,t)),fd=Ve(e=>{let t=m.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(o){t.hidden=o},cancel:()=>t.destroy()}},(e,t)=>Ct("draw",e,t)),br=Ve(e=>m.game.events.on("add",e),(e,t)=>Ct("add",e,t)),gd=Ve(e=>m.game.events.on("destroy",e),(e,t)=>Ct("destroy",e,t)),md=Ve(e=>m.game.events.on("use",e),(e,t)=>Ct("use",e,t)),xd=Ve(e=>m.game.events.on("unuse",e),(e,t)=>Ct("unuse",e,t)),Ar=Ve(e=>m.game.events.on("tag",e),(e,t)=>Ct("tag",e,t)),yd=Ve(e=>m.game.events.on("untag",e),(e,t)=>Ct("untag",e,t));function wd(e,t,o){return Ct("collide",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function bd(e,t,o){return Ct("collideUpdate",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function Ad(e,t,o){return Ct("collideEnd",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function ci(e,t){m.game.root.get(e,{recursive:!0}).forEach(t),br(e,t),Ar((o,s)=>{s===e&&t(o)})}var vd=Ve(e=>m.app.onMousePress(e),(e,t)=>{let o=[];return ci(e,s=>{if(!s.area)throw new Error("onClick() requires the object to have area() component");o.push(s.onClick(()=>t(s)))}),Uo.join(o)});function Md(e,t){let o=[];return ci(e,s=>{if(!s.area)throw new Error("onHover() requires the object to have area() component");o.push(s.onHover(()=>t(s)))}),Uo.join(o)}function Ed(e,t){let o=[];return ci(e,s=>{if(!s.area)throw new Error("onHoverUpdate() requires the object to have area() component");o.push(s.onHoverUpdate(()=>t(s)))}),Uo.join(o)}function Sd(e,t){let o=[];return ci(e,s=>{if(!s.area)throw new Error("onHoverEnd() requires the object to have area() component");o.push(s.onHoverEnd(()=>t(s)))}),Uo.join(o)}function Rd(e){m.game.events.on("loading",e)}function Td(e){m.app.onResize(e)}function Dd(e){m.game.events.on("error",e)}function bn(e){m.assets.loaded?e():m.game.events.on("load",e)}function Cd(e){if(m.assets.loaded)tr().forEach(t=>e(...t));else return m.game.events.on("loadError",e)}function vr(...e){m.game.cam.pos=H(...e)}function Mr(){return m.game.cam.pos?m.game.cam.pos.clone():Vs()}function Er(...e){m.game.cam.scale=H(...e)}function Sr(){return m.game.cam.scale.clone()}function Rr(e){m.game.cam.angle=e}function Tr(){return m.game.cam.angle}function Id(){return m.game.cam.transform.clone()}function Dr(e=Le(255,255,255),t=1){let o=m.game.root.add([yr(ft(),xt()),gr(e),mr(1),qr()]),s=o.fadeOut(t);return s.onEnd(()=>zr(o)),s}function Pd(){return m.game.cam.transform.clone()}function Bd(e=12){m.game.cam.shake+=e}function Ki(e){return m.game.cam.transform.multVec2(e)}function Cr(e){return m.game.cam.transform.invert().multVec2(e)}function Od(...e){return $o("camPos","setCamPos / getCamPos"),e.length>0&&vr(...e),Mr()}function Ld(...e){return $o("camScale","setCamScale / getCamScale"),e.length>0&&Er(...e),Sr()}function zd(e){return $o("camRot","setCamRot / getCamRot"),e!==void 0&&Rr(e),Tr()}function Hd(e=Le(255,255,255),t=1){return $o("camFlash","flash"),Dr(e,t)}function An(e=[]){let t=new Map,o=[],s={},i=new xs,a=[],l=new Set("*"),c=m.globalOpt.tagsAsComponents,r=null,n=!1,d={id:jc(),hidden:!1,transform:new Zt,children:[],parent:null,set paused(h){if(h!==n){n=h;for(let x of a)x.paused=h}},get paused(){return n},get tags(){return Array.from(l)},add(h){let x=Array.isArray(h)?An(h):h;if(x.parent)throw new Error("Cannot add a game obj that already has a parent.");return x.parent=this,x.transform=ps(x),this.children.push(x),x.trigger("add",x),m.game.events.trigger("add",x),x},readd(h){let x=this.children.indexOf(h);return x!==-1&&(this.children.splice(x,1),this.children.push(h)),h},remove(h){let x=this.children.indexOf(h);if(x!==-1){h.parent=null,this.children.splice(x,1);let f=A=>{A.trigger("destroy"),m.game.events.trigger("destroy",A),A.children.forEach(g=>f(g))};f(h)}},removeAll(h){if(h)this.get(h).forEach(x=>this.remove(x));else for(let x of[...this.children])this.remove(x)},fixedUpdate(){this.paused||(this.children.forEach(h=>h.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(h=>h.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Lt(),this.canvas.bind());let h=m.gfx.fixed;this.fixed&&(m.gfx.fixed=!0),Ot(),Qe(this.pos),ws(this.scale),Ko(this.angle);let x=this.children.sort((f,A)=>{let g=f.layerIndex??m.game.defaultLayerIndex,w=A.layerIndex??m.game.defaultLayerIndex;return g-w||(f.z??0)-(A.z??0)});if(this.mask){let f={intersect:m.k.drawMasked,subtract:m.k.drawSubtracted}[this.mask];if(!f)throw new Error(`Invalid mask func: "${this.mask}"`);f(()=>{x.forEach(A=>A.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),x.forEach(f=>f.draw());St(),m.gfx.fixed=h,this.canvas&&(Lt(),this.canvas.unbind())},drawInspect(){this.hidden||(Ot(),Qe(this.pos),ws(this.scale),Ko(this.angle),this.children.forEach(h=>h.drawInspect()),this.trigger("drawInspect"),St())},use(h){var A;if(typeof h=="string")return l.add(h);if(!h||typeof h!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof h}"`);let x=[];h.id?(this.unuse(h.id),s[h.id]=[],x=s[h.id],t.set(h.id,h),c&&l.add(h.id)):o.push(h);for(let g in h){if(Mc.has(g))continue;let w=Object.getOwnPropertyDescriptor(h,g);if(w)if(typeof w.value=="function"&&(h[g]=h[g].bind(this)),w.set&&Object.defineProperty(h,g,{set:w.set.bind(this)}),w.get&&Object.defineProperty(h,g,{get:w.get.bind(this)}),Ec.has(g)){let E=g==="add"?()=>{var T;r=q=>x.push(q),(T=h[g])==null||T.call(h),r=null}:h[g];x.push(this.on(g,E).cancel)}else if(this[g]===void 0)Object.defineProperty(this,g,{get:()=>h[g],set:E=>h[g]=E,configurable:!0,enumerable:!0}),x.push(()=>delete this[g]);else{let E=(A=t.values().find(T=>T[g]!==void 0))==null?void 0:A.id;throw new Error(`Duplicate component property: "${g}" while adding component "${h.id}"`+(E?` (originally added by "${E}")`:""))}}let f=()=>{if(h.require){for(let g of h.require)if(!this.c(g))throw new Error(`Component "${h.id}" requires component "${g}"`)}};h.destroy&&x.push(h.destroy.bind(this)),this.exists()?(f(),h.add&&(r=g=>x.push(g),h.add.call(this),r=null),h.id&&(this.trigger("use",h.id),m.game.events.trigger("use",this,h.id))):h.require&&x.push(this.on("add",f).cancel)},unuse(h){if(t.has(h)){for(let x of t.values())if(x.require&&x.require.includes(h))throw new Error(`Can't unuse. Component "${x.id}" requires component "${h}"`);t.delete(h),this.trigger("unuse",h),m.game.events.trigger("unuse",this,h)}else c&&l.has(h)&&l.delete(h);s[h]&&(s[h].forEach(x=>x()),delete s[h])},c(h){return t.get(h)??null},get(h,x={}){let f=(g,w)=>x.only==="comps"?g.has(w):x.only==="tags"?g.is(w):g.is(w)||g.has(w),A=x.recursive?this.children.flatMap(function g(w){return[w,...w.children.flatMap(g)]}):this.children;if(A=A.filter(g=>h?f(g,h):!0),x.liveUpdate){let g=E=>x.recursive?this.isAncestorOf(E):E.parent===this,w=[];w.push(m.k.onAdd(E=>{g(E)&&f(E,h)&&A.push(E)})),w.push(m.k.onDestroy(E=>{if(g(E)&&f(E,h)){let T=A.findIndex(q=>q.id===E.id);T!==-1&&A.splice(T,1)}})),this.onDestroy(()=>{for(let E of w)E.cancel()})}return A},query(h){let x=h.hierarchy||"children",f=h.include,A=h.exclude,g=[];switch(x){case"children":g=this.children;break;case"siblings":g=this.parent?this.parent.children.filter(E=>E!==this):[];break;case"ancestors":let w=this.parent;for(;w;)g.push(w),w=w.parent;break;case"descendants":g=this.children.flatMap(function E(T){return[T,...T.children.flatMap(E)]});break}if(f&&((h.includeOp||"and")==="and"||!Array.isArray(h.include)?g=g.filter(w=>w.is(f)):g=g.filter(w=>h.include.some(E=>w.is(E)))),A&&((h.includeOp||"and")==="and"||!Array.isArray(h.include)?g=g.filter(w=>!w.is(A)):g=g.filter(w=>!h.exclude.some(E=>w.is(E)))),h.visible===!0&&(g=g.filter(w=>w.visible)),h.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let w=h.distanceOp||"near",E=h.distance*h.distance;w==="near"?g=g.filter(T=>T.pos&&this.pos.sdist(T.pos)<=E):g=g.filter(T=>T.pos&&this.pos.sdist(T.pos)>E)}return h.name&&(g=g.filter(w=>w.name===h.name)),g},isAncestorOf(h){return h.parent?h.parent===this||this.isAncestorOf(h.parent):!1},exists(){return m.game.root.isAncestorOf(this)},is(h,x="and"){return Array.isArray(h)?x==="and"?h.every(f=>l.has(f)):h.some(f=>l.has(f)):l.has(h)},tag(h){if(Array.isArray(h))for(let x of h)l.add(x),this.trigger("tag",x),m.game.events.trigger("tag",this,x);else l.add(h),this.trigger("tag",h),m.game.events.trigger("tag",this,h)},untag(h){if(Array.isArray(h))for(let x of h)l.delete(x),this.trigger("untag",x),m.game.events.trigger("untag",this,x);else l.delete(h),this.trigger("untag",h),m.game.events.trigger("untag",this,h)},has(h,x="and"){return Array.isArray(h)?x==="and"?h.every(f=>t.has(f)):h.some(f=>t.has(f)):t.has(h)},on(h,x){let f=i.on(h,x.bind(this));return r&&r(()=>f.cancel()),f},trigger(h,...x){i.trigger(h,...x),m.game.objEvents.trigger(h,this,...x)},destroy(){this.parent&&this.parent.remove(this)},inspect(){var x;let h={};for(let[f,A]of t)h[f]=((x=A.inspect)==null?void 0:x.call(A))??null;for(let[f,A]of o.entries()){if(A.inspect){h[f]=A.inspect();continue}for(let[g,w]of Object.entries(A))typeof w!="function"&&(h[g]=`${g}: ${w}`)}return h},onAdd(h){return this.on("add",h)},onFixedUpdate(h){return this.on("fixedUpdate",h)},onUpdate(h){return this.on("update",h)},onDraw(h){return this.on("draw",h)},onDestroy(h){return this.on("destroy",h)},onUse(h){return this.on("use",h)},onUnuse(h){return this.on("unuse",h)},clearEvents(){i.clear()}},u=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let h of u)d[h]=(...x)=>{var A,g;let f=(g=(A=m.app)[h])==null?void 0:g.call(A,...x);return a.push(f),d.onDestroy(()=>f.cancel()),d.on("sceneEnter",()=>{var E,T;a.splice(a.indexOf(f),1);let w=(T=(E=m.app)[h])==null?void 0:T.call(E,...x);Uo.replace(f,w),a.push(f)}),f};for(let h of e)d.use(h);return d}var Nd=()=>({events:new xs,objEvents:new xs,root:An([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new _(1),angle:0,shake:0,transform:new Zt}});function Ud(e){m.game.gravity=e?(m.game.gravity||H(0,1)).unit().scale(e):null}function qd(){return m.game.gravity?m.game.gravity.len():0}function _d(e){m.game.gravity=e.unit().scale(m.game.gravity?m.game.gravity.len():1)}function gs(){return m.game.gravity?m.game.gravity.unit():H(0,1)}var Fd=Ml("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Yd=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let o=new bs(uh(e));return e.decodeAudioData(Fd.buffer.slice(0)).then(s=>{o.buf=s}).catch(s=>{console.error("Failed to load burp: ",s)}),{ctx:e,masterNode:t,burpSnd:o}})();function Xd(e,t={}){let o=new bt,s=new Audio(e);s.crossOrigin="anonymous",s.loop=!!t.loop,m.audio.ctx.createMediaElementSource(s).connect(m.audio.masterNode);function i(){m.debug.paused||m.app.isHidden()&&!m.globalOpt.backgroundAudio||m.audio.ctx.resume()}function a(){i(),s.play()}return t.paused||a(),s.onended=()=>o.trigger(),{play(){a()},seek(l){s.currentTime=l},stop(){s.pause(),this.seek(0)},set loop(l){s.loop=l},get loop(){return s.loop},set paused(l){l?s.pause():a()},get paused(){return s.paused},time(){return s.currentTime},duration(){return s.duration},set volume(l){s.volume=Qt(l,0,1)},get volume(){return s.volume},set speed(l){s.playbackRate=Math.max(l,0)},get speed(){return s.playbackRate},set detune(l){},get detune(){return 0},onEnd(l){return o.add(l)},then(l){return this.onEnd(l)}}}function Gd(e,t={}){if(typeof e=="string"&&m.assets.music[e])return Xd(m.assets.music[e],t);let o=m.audio.ctx,s=t.paused??!1,i=o.createBufferSource(),a=new bt,l=o.createGain(),c=o.createStereoPanner(),r=t.seek??0,n=0,d=0,u=!1;i.loop=!!t.loop,i.detune.value=t.detune??0,i.playbackRate.value=t.speed??1,i.connect(c),i.onended=()=>{var g;f()>=(((g=i.buffer)==null?void 0:g.duration)??Number.POSITIVE_INFINITY)&&a.trigger()},c.pan.value=t.pan??0,c.connect(l),l.connect(m.audio.masterNode),l.gain.value=t.volume??1;let h=g=>{i.buffer=g.buf,s||(n=o.currentTime,i.start(0,r),u=!0)},x=_h(e);x instanceof Ut&&x.onLoad(h);let f=()=>{if(!i.buffer)return 0;let g=s?d-n:o.currentTime-n,w=i.buffer.duration;return i.loop?g%w:Math.min(g,w)},A=g=>{let w=o.createBufferSource();return w.buffer=g.buffer,w.loop=g.loop,w.playbackRate.value=g.playbackRate.value,w.detune.value=g.detune.value,w.onended=g.onended,w.connect(c),w};return{stop(){this.paused=!0,this.seek(0)},set paused(g){if(s!==g)if(s=g,g)u&&(i.stop(),u=!1),d=o.currentTime;else{i=A(i);let w=d-n;i.start(0,w),u=!0,n=o.currentTime-w,d=0}},get paused(){return s},play(g=0){this.seek(g),this.paused=!1},seek(g){var w;(w=i.buffer)!=null&&w.duration&&(g>i.buffer.duration||(s?(i=A(i),n=d-g):(i.stop(),i=A(i),n=o.currentTime-g,i.start(0,g),u=!0,d=0)))},set speed(g){i.playbackRate.value=g},get speed(){return i.playbackRate.value},set detune(g){i.detune.value=g},get detune(){return i.detune.value},set volume(g){l.gain.value=Math.max(g,0)},get volume(){return l.gain.value},set pan(g){c.pan.value=g},get pan(){return c.pan.value},set loop(g){i.loop=g},get loop(){return i.loop},duration(){var g;return((g=i.buffer)==null?void 0:g.duration)??0},time(){return f()%this.duration()},onEnd(g){return a.add(g)},then(g){return this.onEnd(g)}}}function Ir(e){return m.k.play(m.audio.burpSnd,e)}function Pr(e){m.audio.masterNode.gain.value=e}function Br(){return m.audio.masterNode.gain.value}function Kd(e){return $o("volume","setVolume / getVolume"),e!==void 0&&Pr(e),Br()}function Or(){m.app.onHide(()=>{m.globalOpt.backgroundAudio||m.audio.ctx.suspend()}),m.app.onShow(()=>{!m.globalOpt.backgroundAudio&&!m.debug.paused&&m.audio.ctx.resume()}),m.app.onResize(()=>{if(m.app.isFullscreen())return;let e=m.globalOpt.width&&m.globalOpt.height;e&&!m.globalOpt.stretch&&!m.globalOpt.letterbox||(m.canvas.width=m.canvas.offsetWidth*m.pixelDensity,m.canvas.height=m.canvas.offsetHeight*m.pixelDensity,Za(),e||(m.gfx.frameBuffer.free(),m.gfx.frameBuffer=new js(m.gfx.ggl,m.gfx.ggl.gl.drawingBufferWidth,m.gfx.ggl.gl.drawingBufferHeight),m.gfx.width=m.gfx.ggl.gl.drawingBufferWidth/m.pixelDensity/m.gscale,m.gfx.height=m.gfx.ggl.gl.drawingBufferHeight/m.pixelDensity/m.gscale))}),m.globalOpt.debug!==!1&&(m.app.onKeyPress(m.globalOpt.debugKey??"f1",()=>m.debug.inspect=!m.debug.inspect),m.app.onKeyPress("f2",()=>m.debug.clearLog()),m.app.onKeyPress("f8",()=>m.debug.paused=!m.debug.paused),m.app.onKeyPress("f7",()=>{m.debug.timeScale=qi(Qt(m.debug.timeScale-.2,0,2),1)}),m.app.onKeyPress("f9",()=>{m.debug.timeScale=qi(Qt(m.debug.timeScale+.2,0,2),1)}),m.app.onKeyPress("f10",()=>m.debug.stepFrame())),m.globalOpt.burp&&m.app.onKeyPress("b",()=>Ir())}function Vd(e,t={}){let o=m.game.root.add([$s(e),Ur()]),s=(t.speed||1)*5,i=t.scale||1;o.add([Vi(m.boomSprite),Js(0),$i("center"),Qn(s,i),...t.comps??[]]);let a=o.add([Vi(m.kaSprite),Js(0),$i("center"),ji(),...t.comps??[]]);return a.wait(.4/s,()=>a.use(Qn(s,i))),a.onDestroy(()=>o.destroy()),o}function Lr(e,t){if(m.game.layers)throw Error("Layers can only be assigned once.");let o=e.indexOf(t);if(o==-1)throw Error("The default layer name should be present in the layers list.");m.game.layers=e,m.game.defaultLayerIndex=o}function jd(){return m.game.layers}function Wd(){var e;return((e=m.game.layers)==null?void 0:e[m.game.defaultLayerIndex])??null}function $d(e,t){$o("layers","setLayers"),Lr(e,t)}function zr(e){e.destroy()}function Jd(){return m.game.root}function Qd(e,t){m.game.scenes[e]=t}function Zd(e,...t){if(!m.game.scenes[e])throw new Error(`Scene not found: ${e}`);m.game.events.onOnce("frameEnd",()=>{m.game.events.trigger("sceneLeave",e),m.app.events.clear(),m.game.events.clear(),m.game.objEvents.clear(),[...m.game.root.children].forEach(o=>{!o.stay||o.scenesToStay&&!o.scenesToStay.includes(e)?m.game.root.remove(o):o.trigger("sceneEnter",e)}),m.game.root.clearEvents(),Or(),m.game.cam={pos:null,scale:H(1),angle:0,shake:0,transform:new Zt},m.game.scenes[e](...t)}),m.game.currentScene=e}function kd(e){return m.game.events.on("sceneLeave",e)}function eu(){return m.game.currentScene}function Vi(e,t={}){let o=null,s=null,i=null,a=new bt;if(!e)throw new Error("Please pass the resource name or data to sprite()");let l=(n,d,u,h)=>{let x=H(1,1);return u&&h?(x.x=u/(n.width*d.w),x.y=h/(n.height*d.h)):u?(x.x=u/(n.width*d.w),x.y=x.x):h&&(x.y=h/(n.height*d.h),x.x=x.y),x},c=(n,d)=>{if(!d)return;let u=d.frames[0].clone();t.quad&&(u=u.scale(t.quad));let h=l(d.tex,u,t.width,t.height);if(n.width=d.tex.width*u.w*h.x,n.height=d.tex.height*u.h*h.y,d.anims)for(let x in d.anims){let f=d.anims[x];typeof f!="number"&&(f.frames=r(f))}o=d,a.trigger(o),t.anim&&n.play(t.anim)},r=n=>{if(n.frames)return n.frames;let d=[];if(n.from===void 0||n.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let u=Math.abs(n.to-n.from)+1;for(let h=0;h<u;h++)d.push(n.from+h*Math.sign(n.to-n.from));if(n.pingpong)for(let h=u-2;h>0;h--)d.push(d[h]);return d};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new Je(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(n){let d=Us(n);d&&d.onLoad(u=>c(this,u))},get animFrame(){if(!o||!s||i===null)return this.frame;let n=o.anims[s.name];return typeof n=="number"?n:n.from===void 0||n.to===void 0?s.frameIndex:this.frame-Math.min(n.from,n.to)},draw(){if(!o)return;let n=o.frames[this.frame??0];if(!n)throw new Error(`Frame not found: ${this.frame??0}`);if(o.slice9){let{left:d,right:u,top:h,bottom:x}=o.slice9,f=o.tex.width*n.w,A=o.tex.height*n.h,g=this.width-d-u,w=this.height-h-x,E=d/f,T=u/f,q=1-E-T,U=h/A,p=x/A,y=1-U-p,b=[ot(0,0,E,U),ot(E,0,q,U),ot(E+q,0,T,U),ot(0,U,E,y),ot(E,U,q,y),ot(E+q,U,T,y),ot(0,U+y,E,p),ot(E,U+y,q,p),ot(E+q,U+y,T,p),ot(0,0,d,h),ot(d,0,g,h),ot(d+g,0,u,h),ot(0,h,d,w),ot(d,h,g,w),ot(d+g,h,u,w),ot(0,h+w,d,x),ot(d,h+w,g,x),ot(d+g,h+w,u,x)];for(let v=0;v<9;v++){let D=b[v],P=b[v+9];Ws(Object.assign(Ho(this),{pos:P.pos(),tex:o.tex,quad:n.scale(D),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:P.w,height:P.h}))}}else Ws(Object.assign(Ho(this),{tex:o.tex,quad:n.scale(this.quad??new Je(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let n=Us(e);n?n.onLoad(d=>c(this,d)):bn(()=>c(this,Us(e).data))},update(){if(!o||!s||i===null)return;let n=o.anims[s.name];if(typeof n=="number"){this.frame=n;return}if(n.speed===0)throw new Error("Sprite anim speed cannot be 0");if(s.timer+=dt()*this.animSpeed,s.timer>=1/s.speed){s.timer=0,s.frameIndex+=i;let d=n.frames;if(s.frameIndex>=d.length)if(s.pingpong&&!n.pingpong)i=-1,s.frameIndex=d.length-2;else if(s.loop)s.frameIndex=0;else{this.frame=d.at(-1),s.onEnd(),this.stop();return}else if(s.frameIndex<0)if(s.pingpong&&s.loop)i=1,s.frameIndex=1;else if(s.loop)s.frameIndex=d.length-1;else{this.frame=d[0],s.onEnd(),this.stop();return}this.frame=d[s.frameIndex]}},play(n,d={}){if(!o){a.add(()=>this.play(n,d));return}let u=o.anims[n];if(u===void 0)throw new Error(`Anim not found: ${n}`);s&&this.stop(),s=typeof u=="number"?{name:n,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:n,timer:0,loop:d.loop??u.loop??!1,pingpong:d.pingpong??u.pingpong??!1,speed:d.speed??u.speed??10,frameIndex:0,onEnd:d.onEnd??(()=>{})},i=typeof u=="number"?null:1,this.frame=typeof u=="number"?u:u.frames[0],this.trigger("animStart",n)},stop(){if(!s)return;let n=s.name;s=null,this.trigger("animEnd",n)},numFrames(){return(o==null?void 0:o.frames.length)??0},getCurAnim(){return s},curAnim(){return s==null?void 0:s.name},getAnim(n){return(o==null?void 0:o.anims[n])??null},hasAnim(n){return!!this.getAnim(n)},onAnimEnd(n){return this.on("animEnd",n)},onAnimStart(n){return this.on("animStart",n)},renderArea(){return new Fe(H(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function tu(e,t={}){function o(i){var l,c;let a=Lo(Object.assign(Ho(i),{text:i.text+"",size:i.textSize,font:i.font,width:t.width&&i.width,align:i.align,letterSpacing:i.letterSpacing,lineSpacing:i.lineSpacing,transform:i.textTransform,styles:i.textStyles,indentAll:t.indentAll}));return t.width||(i.width=a.width/(((l=i.scale)==null?void 0:l.x)||1)),i.height=a.height/(((c=i.scale)==null?void 0:c.y)||1),a}let s={id:"text",set text(i){e=i,o(this),this.renderedText=Xi(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?Xi(e).text:"",add(){bn(()=>o(this))},draw(){zo(o(this))},renderArea(){return new Fe(H(0),this.width,this.height)}};return o(s),s}function ou(e,t){return{id:"rect",width:e,height:t,draw(){As(Object.assign(Ho(this),{width:this.width,height:this.height}))},renderArea(){return new Fe(H(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function su(e={}){let t=null,o=null,s=null,i=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return o&&s?o[s]:null},getPath(){return o?o.slice():null},getTarget(){return t},isNavigationFinished(){return o?s===null:!0},isTargetReachable(){return o!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s=o?0:null,o&&s!==null?(i||(i=this.getLevel().onNavigationMapChanged(()=>{t&&o&&s!==null&&(o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o?(s=0,this.trigger("navigationNext",this,o[s])):(s=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>i==null?void 0:i.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,o[s])):this.trigger("navigationEnded",this)},update(){if(t&&o&&s!==null){if(this.pos.sdist(o[s])<2)if(s===o.length-1){this.pos=t.clone(),s=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else s++,this.trigger("navigationNext",this,o[s]);this.moveTo(o[s],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(o)})}}}function iu(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(o){var s;return(s=this.graph)==null?void 0:s.getWaypointPath(this.pos,o,e.navigationOpt)},get graph(){if(t)return t;let o=this.parent;for(;o;){if(o.has("pathfinderMap"))return o.graph;o=o.parent}},set graph(o){t=o}}}function nu(e={}){let t=e.waypoints,o=e.speed||100,s=e.endBehavior||"stop",i=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return o},set patrolSpeed(l){o=l},get waypoints(){return t},set waypoints(l){t=l,i=0,a=!1},get nextLocation(){return t?t[i]:void 0},update(){let l=this.nextLocation;if(!(!t||!l||a)&&(this.moveTo(l,o),this.pos.sdist(l)<9))switch(s){case"loop":i=(i+1)%t.length;break;case"ping-pong":i=i+1,i==t.length&&(t.reverse(),i=0);break;case"stop":i<t.length-1?i+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(l){return this.on("patrolFinished",l)}}}function au(e,t={}){let o=typeof e=="function"?e:()=>m.game.root.query(e),s=t.checkFrequency||1,i=typeof t.direction=="number"?_.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?_.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(l){this.direction=l!==void 0?_.fromAngle(l):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(l,c,r){let n=(typeof c=="number"?_.fromAngle(c):c)||i,d=r||t.fieldOfView;if(!n||!d||d>=360)return!0;let u=d/2;return l.pos&&n.angleBetween(l.pos.sub(this.pos))<=u},hasLineOfSight(l){let c=xr(this.pos,l.pos.sub(this.pos),t.raycastExclude);return c!=null&&c.object===l},update(){if(a+=dt(),a>s){a-=s;let l=o();if(l.length&&i&&this.fieldOfView&&this.fieldOfView<360){let c=this.fieldOfView/2;l=l.filter(r=>r.pos&&i.angleBetween(r.pos.sub(this.pos))<=c)}l.length&&t.lineOfSight&&(l=l.filter(c=>c.pos&&this.hasLineOfSight(c))),l.length>0&&(this.spotted=l,this.trigger("objectSpotted",l))}},onObjectsSpotted(l){return this.on("objectSpotted",l)}}}function Hr(e={}){let t=H(0),o=e.isObstacle??!1,s=e.cost??0,i=e.edges??[],a=()=>{let c={left:1,top:2,right:4,bottom:8};return i.map(r=>c[r]||0).reduce((r,n)=>r|n,0)},l=a();return{id:"tile",tilePosOffset:e.offset??H(0),set tilePos(c){let r=this.getLevel();t=c.clone(),this.pos=H(this.tilePos.x*r.tileWidth(),this.tilePos.y*r.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(c){o!==c&&(o=c,this.getLevel().invalidateNavigationMap())},get isObstacle(){return o},set cost(c){s!==c&&(s=c,this.getLevel().invalidateNavigationMap())},get cost(){return s},set edges(c){i=c,l=a(),this.getLevel().invalidateNavigationMap()},get edges(){return i},get edgeMask(){return l},getLevel(){return this.parent},tileMove(c){let r=this.getLevel();r.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(c),r.insertIntoSpatialMap(this),r.trigger("spatialMapChanged")},moveLeft(){this.tileMove(H(-1,0))},moveRight(){this.tileMove(H(1,0))},moveUp(){this.tileMove(H(0,-1))},moveDown(){this.tileMove(H(0,1))}}}var vn=class{constructor(e,t,o){L(this,"name");L(this,"duration");L(this,"loops");L(this,"direction");L(this,"easing");L(this,"interpolation");L(this,"isFinished");L(this,"timing");L(this,"easings");L(this,"relative");this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||ys.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=o}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,o){let s=t-1,i=e/this.duration;if(this.loops!==0&&i>=this.loops)return[s,0,!0];let a=Math.trunc(i);if(i-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(i=1-i),o){let l=0;for(;o[l+1]!==void 0&&o[l+1]<i;)l++;return l>=s?[s,0,!0]:[l,(i-o[l])/(o[l+1]-o[l]),!1]}else{let l=Math.floor((t-1)*i);return[l,(i-l/s)*s,!1]}}setValue(e,t,o){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(o);break;case"angle":e.angle=e.base.angle+o;break;case"scale":e.scale=e.base.scale.scale(o);break;case"opacity":e.opacity=e.base.opacity*o;break;default:e[t]=o}else e[t]=o}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=ys.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Jn(e,t){return t.add(t.sub(e))}var ru=class extends vn{constructor(t,o,s,i){super(t,s,i);L(this,"keys");this.keys=o}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(t,this.name,this.keys[s]);else{let l=this.easings?this.easings[s]:this.easing;this.setValue(t,this.name,Rt(this.keys[s],this.keys[s+1],l(i)))}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},lu=class extends vn{constructor(t,o,s,i,a){var l;super(t,s,i);L(this,"keys");L(this,"curves");L(this,"dcurves");if(this.keys=o,this.interpolation==="spline"){this.curves=[],a&&(this.dcurves=[]);for(let c=0;c<this.keys.length-1;c++){let r=this.keys[c],n=c+1,d=this.keys[n],u=c>0?this.keys[c-1]:Jn(d,r),h=n<this.keys.length-1?this.keys[n+1]:Jn(r,d);this.curves.push(Gs(u,r,d,h)),a&&((l=this.dcurves)==null||l.push(Gs(u,r,d,h,nc)))}}}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(t,this.name,this.keys[s]);else{let l=this.easings?this.easings[s]:this.easing;switch(this.interpolation){case"linear":this.setValue(t,this.name,this.keys[s].lerp(this.keys[s+1],l(i)));break;case"slerp":this.setValue(t,this.name,this.keys[s].slerp(this.keys[s+1],l(i)));break;case"spline":if(this.curves){this.setValue(t,this.name,this.curves[s](l(i))),this.dcurves&&this.setValue(t,"angle",this.dcurves[s](l(i)).angle());break}}}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(t=>[t.x,t.y])})}},cu=class extends vn{constructor(t,o,s,i){super(t,s,i);L(this,"keys");this.keys=o}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation=="none")this.setValue(t,this.name,this.keys[s]);else{let l=this.easings?this.easings[s]:this.easing;this.setValue(t,this.name,this.keys[s].lerp(this.keys[s+1],l(i)))}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function hu(e={}){let t=[],o=0,s=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:H(0,0),angle:0,scale:H(1,1),opacity:1},animation:{paused:!1,seek(i){o=Qt(i,0,this.duration),t.forEach(a=>{a.isFinished=!1}),s=!1},get duration(){return t.reduce((i,a)=>Math.max(a.duration,i),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let i=!0,a;o+=dt();for(let l of t)a=l.update(this,o),a&&!l.isFinished&&(l.isFinished=!0,this.trigger("animateChannelFinished",l.name)),i&&(i=a);i&&!s&&(s=!0,this.trigger("animateFinished"))},animate(i,a,l){s=!1,this.unanimate(i),typeof a[0]=="number"?t.push(new ru(i,a,l,e.relative||!1)):a[0]instanceof _?t.push(new lu(i,a,l,e.relative||!1,i==="pos"&&(e.followMotion||!1))):a[0]instanceof Ie&&t.push(new cu(i,a,l,e.relative||!1))},unanimate(i){let a=t.findIndex(l=>l.name===i);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(i){return this.on("animateFinished",i)},onAnimateChannelFinished(i){return this.on("animateChannelFinished",i)},serializeAnimationChannels(){return t.reduce((i,a)=>(i[a.name]=a.serialize(),i),{})},serializeAnimationOptions(){let i={};return e.followMotion&&(i.followMotion=!0),e.relative&&(i.relative=!0),i}}}function Nr(e,t){let o={name:e.name};return e.has("animate")&&(o.channels=e.serializeAnimationChannels(),Object.assign(o,e.serializeAnimationOptions())),e.children.length>0&&(o.children=e.children.filter(s=>s.has("named")).map(s=>Nr(s,s.name))),o}function Qn(e=2,t=1){let o=0;return{require:["scale"],update(){let s=Math.sin(o*e)*t;s<0&&this.destroy(),this.scale=H(s),o+=dt()}}}function du(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(o=1){this.setHP(e-o),this.trigger("hurt",o)},heal(o=1){let s=e;this.setHP(e+o),this.trigger("heal",e-s)},hp(){return e},maxHP(){return t??null},setMaxHP(o){t=o},setHP(o){e=t?Math.min(t,o):o,e<=0&&this.trigger("death")},onHurt(o){return this.on("hurt",o)},onHeal(o){return this.on("heal",o)},onDeath(o){return this.on("death",o)},inspect(){return`health: ${e}`}}}function uu(e,t={}){if(e==null)throw new Error("lifespan() requires time");let o=t.fade??0;return{id:"lifespan",require:["opacity"],add(){m.game.root.wait(e,()=>{this.opacity=this.opacity??1,o>0?m.game.root.tween(this.opacity,0,o,s=>this.opacity=s,ys.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function pu(e){return{id:"named",name:e}}function fu(e,t,o){if(!e)throw new Error("state() requires an initial state");let s={};function i(r){s[r]||(s[r]={enter:new bt,end:new bt,update:new bt,draw:new bt})}function a(r,n,d){return i(n),s[n][r].add(d)}function l(r,n,...d){i(n),s[n][r].trigger(...d)}let c=!1;return{id:"state",state:e,enterState(r,...n){if(c=!0,t&&!t.includes(r))throw new Error(`State not found: ${r}`);let d=this.state;if(o){if(!(o!=null&&o[d]))return;let u=typeof o[d]=="string"?[o[d]]:o[d];if(!u.includes(r))throw new Error(`Cannot transition state from "${d}" to "${r}". Available transitions: ${u.map(h=>`"${h}"`).join(", ")}`)}l("end",d,...n),this.state=r,l("enter",r,...n),l("enter",`${d} -> ${r}`,...n)},onStateTransition(r,n,d){return a("enter",`${r} -> ${n}`,d)},onStateEnter(r,n){return a("enter",r,n)},onStateUpdate(r,n){return a("update",r,n)},onStateDraw(r,n){return a("draw",r,n)},onStateEnd(r,n){return a("end",r,n)},update(){c||(l("enter",e),c=!0),l("update",this.state)},draw(){l("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Ur(e){return{id:"stay",stay:!0,scenesToStay:e}}function gu(e=!0,t){let o,s;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let i=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};o=m.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(m.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,i())}),s=m.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),i())})},destroy(){o.cancel(),s.cancel()}}}function ji(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,o,s=1/0,i=!1){let a=i?0:t,l=new bt,c=this.onUpdate(()=>{a+=m.app.state.dt;for(let r=0;a>=t&&r<this.maxLoopsPerFrame;r++)if(s--,o(),a-=t,s<=0){c.cancel(),l.trigger();return}});return{get paused(){return c.paused},set paused(r){c.paused=r},cancel:c.cancel,onEnd(r){l.add(r)},then(r){return l.add(r),this}}},wait(t,o){return this.loop(t,o??(()=>{}),1,!0)},tween(t,o,s,i,a=ys.linear){let l=0,c=[],r=this.onUpdate(()=>{l+=m.app.state.dt;let n=Math.min(l/s,1);i(Rt(t,o,a(n))),n===1&&(r.cancel(),i(o),c.forEach(d=>d()))});return{get paused(){return r.paused},set paused(n){r.paused=n},onEnd(n){c.push(n)},then(n){return this.onEnd(n),this},cancel(){r.cancel()},finish(){r.cancel(),i(o),c.forEach(n=>n())}}}}}var Wi=0;function mu(){return Wi>0}function xu(e={}){let t={},o=new Set,s=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){Wi++,this.area.cursor&&s.push(this.onHover(()=>m.app.setCursor(this.area.cursor))),s.push(this.onCollideUpdate((i,a)=>{if(!i.id)throw new Error("area() requires the object to have an id");t[i.id]||this.trigger("collide",i,a),a&&(t[i.id]=a,o.add(i.id))}))},destroy(){Wi--;for(let i of s)i.cancel()},fixedUpdate(){for(let i in t)o.has(Number(i))||(this.trigger("collideEnd",t[i].target),delete t[i]);o.clear()},drawInspect(){let i=this.localArea();Ot(),Qe(this.area.offset);let a={outline:{width:4/ka(),color:Le(0,0,255)},anchor:this.anchor,fill:!1,fixed:Po(this)};i instanceof Fe?zt({...a,pos:i.pos,width:i.width*this.area.scale.x,height:i.height*this.area.scale.y}):i instanceof At?wo({...a,pts:i.pts,scale:this.area.scale}):i instanceof Tt&&Qo({...a,pos:i.center,radius:i.radius}),St()},area:{shape:e.shape??null,scale:e.scale?H(e.scale):H(1),offset:e.offset??H(0),cursor:e.cursor??null},isClicked(){return m.app.isMousePressed()&&this.isHovering()},isHovering(){let i=Po(this)?m.k.mousePos():m.k.toWorld(m.k.mousePos());return this.hasPoint(i)},checkCollision(i){if(!i.id)throw new Error("checkCollision() requires the object to have an id");return t[i.id]??null},getCollisions(){return Object.values(t)},isColliding(i){if(!i.id)throw new Error("isColliding() requires the object to have an id");return!!t[i.id]},isOverlapping(i){if(!i.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[i.id];return a&&a.hasOverlap()},onClick(i,a="left"){let l=this.onMousePress(a,()=>{this.isHovering()&&i()});return s.push(l),l},onHover(i){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,i())})},onHoverUpdate(i){return this.onUpdate(()=>{this.isHovering()&&i()})},onHoverEnd(i){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,i()):a=this.isHovering()})},onCollide(i,a){if(typeof i=="function"&&a===void 0)return this.on("collide",i);if(typeof i=="string")return this.onCollide((l,c)=>{l.is(i)&&(a==null||a(l,c))});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(i,a){if(typeof i=="function"&&a===void 0)return this.on("collideUpdate",i);if(typeof i=="string")return this.on("collideUpdate",(l,c)=>l.is(i)&&(a==null?void 0:a(l,c)));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(i,a){if(typeof i=="function"&&a===void 0)return this.on("collideEnd",i);if(typeof i=="string")return this.on("collideEnd",l=>l.is(i)&&(a==null?void 0:a(l)));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(i){return Mo(this.worldArea(),i)},resolveCollision(i){let a=this.checkCollision(i);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let i=this.localArea();if(!(i instanceof At||i instanceof Fe))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale(H(this.area.scale??1));if(i instanceof Fe){let l=Jo(this.anchor||ai).add(1,1).scale(-.5).scale(i.width,i.height);a.translate(l)}return i.transform(a)},screenArea(){let i=this.worldArea();return Po(this)?i:i.transform(m.game.cam.transform)},inspect(){var i,a,l,c,r,n,d;return((i=this.area.scale)==null?void 0:i.x)==((a=this.area.scale)==null?void 0:a.y)?`area: ${(c=(l=this.area.scale)==null?void 0:l.x)==null?void 0:c.toFixed(1)}x`:`area: (${(n=(r=this.area.scale)==null?void 0:r.x)==null?void 0:n.toFixed(1)}x, ${(d=this.area.scale.y)==null?void 0:d.toFixed(1)}y)`}}}function yu(e={}){let t=null,o=null,s=!1,i=H(0),a=null,l=null,c;return{id:"body",require:["pos"],vel:H(0),drag:e.drag??0,jumpForce:e.jumpForce??Sc,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),l=this.pos.clone(),c=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((r,n)=>{if(!n||!r.has("body")||n.resolved)return;this.trigger("beforePhysicsResolve",n);let d=n.reverse();if(r.trigger("beforePhysicsResolve",d),!(n.resolved||d.resolved)&&!(this.isStatic&&r.isStatic)){if(!this.isStatic&&!r.isStatic){let u=this.mass+r.mass;this.pos=this.pos.add(n.displacement.scale(r.mass/u)),r.pos=r.pos.add(n.displacement.scale(-this.mass/u)),this.transform=ps(this),r.transform=ps(r)}else{let u=!this.isStatic&&r.isStatic?n:n.reverse();u.source.pos=u.source.pos.add(u.displacement),u.source.transform=ps(u.source)}n.resolved=!0,this.trigger("physicsResolve",n),r.trigger("physicsResolve",n.reverse())}}),this.onPhysicsResolve(r=>{if(m.game.gravity)if(r.isBottom()&&this.isFalling()){this.vel=this.vel.reject(m.game.gravity.unit());let n=t;t=r.target,n!=t&&(o=r.target.pos),s?s=!1:n||(this.trigger("ground",t),r.target.trigger("land",this))}else r.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(m.game.gravity.unit()),this.trigger("headbutt",r.target),r.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(o&&!t.pos.eq(o)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(o)),o=t.pos);let r=Fi();r&&(this.pos.x==c.x&&(this.pos.x=Rt(a.x,l.x,r/_i()),c.x=this.pos.x),this.pos.y==c.y&&(this.pos.y=Rt(a.y,l.y,r/_i()),c.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==c.x&&(this.pos.x=a.x),this.pos.y==c.y&&(this.pos.y=a.y),a=null),m.game.gravity&&!this.isStatic){s&&(t=null,o=null,this.trigger("fallOff"),s=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(s=!0);let r=this.vel.clone();this.vel=this.vel.add(m.game.gravity.scale(this.gravityScale*dt()));let n=e.maxVelocity??Rc;this.vel.slen()>n*n&&(this.vel=this.vel.unit().scale(n)),r.dot(m.game.gravity)<0&&this.vel.dot(m.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=i.x*dt(),this.vel.y+=i.y*dt(),this.vel.x*=1-this.drag*dt(),this.vel.y*=1-this.drag*dt(),this.move(this.vel),Fi()){a=this.pos.clone();let r=this.vel.add(i.scale(dt()));l=this.pos.add(r.scale(dt())),c=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(r){return this.on("physicsResolve",r)},onBeforePhysicsResolve(r){return this.on("beforePhysicsResolve",r)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(gs())>0},isJumping(){return this.vel.dot(gs())<0},applyImpulse(r){this.isStatic||(this.vel=this.vel.add(r))},addForce(r){this.isStatic||(i.x+=r.x/this.mass,i.y+=r.y/this.mass)},jump(r){this.isStatic||(t=null,o=null,this.vel=gs().scale(-r||-this.jumpForce))},onGround(r){return this.on("ground",r)},onFall(r){return this.on("fall",r)},onFallOff(r){return this.on("fallOff",r)},onHeadbutt(r){return this.on("headbutt",r)},onLand(r){return this.on("land",r)},onHeadbutted(r){return this.on("headbutted",r)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function wu(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(o){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(o))},onDoubleJump(o){return this.on("doubleJump",o)},inspect(){return`jumpsLeft: ${t}`}}}function bu(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,o)=>{var l;let s=o==null?void 0:o.normal.normal(),i=t.vel.project(s),a=(l=s==null?void 0:s.scale(this.speed))==null?void 0:l.sub(i);t.addForce(a==null?void 0:a.scale(t.mass*this.forceScale))})}}}function Au(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{if(!t.has("body"))return;let s=_.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(s),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function vu(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{let s=this.pos.sub(t.pos),i=s.len(),a=i*this.distanceScale/10,l=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,c=s.scale(this.forceMagnitude*l/i);t.addForce(c),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function Mu(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function Eu(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let o=t.target.vel,s=gs().scale(-1).angleBetween(o);Math.abs(s)>this.surfaceArc/2&&t.preventResolution()})}}}function Su(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,o)=>{let s=t,i=s.worldArea(),[a,l]=i.cut(H(-100,this.surfaceLevel),H(100,this.surfaceLevel));a&&(this.applyBuoyancy(s,a),this.applyDrag(s,a)),this.flowMagnitude&&s.addForce(_.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,o){let s=this.density*o.area(),i=H(0,1).scale(-s);t.addForce(i)},applyDrag(t,o){let s=t.vel,i=this.density*this.linearDrag,a=s.scale(-i);t.addForce(a)}}}function $i(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function qr(){return{id:"fixed",fixed:!0}}function Ru(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??H(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Tu(e){var o;let t=(o=m.game.layers)==null?void 0:o.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){var s;return t?((s=m.game.layers)==null?void 0:s[t])??null:null},set layer(s){var i;if(t=(i=m.game.layers)==null?void 0:i.indexOf(s),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function Du(e,t){let o=typeof e=="number"?_.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(o.scale(t))}}}function Cu(e={}){let t=!1,o=new Fe(H(0),ft(),xt()),s=new Fe(H(0),0,0),i=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??Un,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(o.width=ft(),o.height=xt(),!this.offscreenDistance&&this.width&&this.height)return s.width=this.width,s.height=this.height,s.pos=this.pos,s.collides(o);let l=this.offscreenDistance?this.offscreenDistance:Un;return!si(o,a)&&o.sdistToPoint(a)>l*l},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?wr(()=>i(this)):this.onUpdate(()=>i(this))}}}function $s(...e){return{id:"pos",pos:H(...e),moveBy(...t){this.pos=this.pos.add(H(...t))},move(...t){this.moveBy(H(...t).scale(dt()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(H(t[0],t[1]),t[2]);let o=t[0],s=t[1];if(s===void 0){this.pos=H(o);return}let i=o.sub(this.pos);if(i.len()<=s*dt()){this.pos=H(o);return}this.move(i.unit().scale(s))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let o=this.worldPos();return o?Po(this)?o:Ki(o):null}},toScreen(t){let o=this.toWorld(t);return Po(this)?o:Ki(o)},fromScreen(t){return Po(this)?this.fromWorld(t):this.fromWorld(Cr(t))},toOther(t,o){return t.fromWorld(this.toWorld(o))},fromOther(t,o){return t.toOther(this,o)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){Qo({color:Le(255,0,0),radius:4/ka()})}}}function Iu(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function Js(...e){if(e.length===0)return Js(1);let t=H(...e);return{id:"scale",set scale(o){if(!(o instanceof _))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=H(o)},get scale(){return t},scaleTo(...o){t=H(...o)},scaleBy(...o){t=t.scale(H(...o))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function Pu(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Bu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",Ou="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",Lu=El.version,m={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},zu=(e={tagsAsComponents:!0})=>{m.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),m.k.quit()),m.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let o=e.canvas??t.appendChild(document.createElement("canvas"));m.canvas=o;let s=e.scale??1;m.gscale=s;let i=e.width&&e.height&&!e.stretch&&!e.letterbox;i?(o.width=e.width*s,o.height=e.height*s):(o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(i){let X=o.width,$=o.height;a.push(`width: ${X}px`),a.push(`height: ${$}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),o.style.cssText=a.join(";");let l=e.pixelDensity||1;m.pixelDensity=l,o.width*=l,o.height*=l,o.tabIndex=0;let c=document.createElement("canvas");c.width=256,c.height=256,m.fontCacheCanvas=c;let r=c.getContext("2d",{willReadFrequently:!0});m.fontCacheC2d=r;let n=th({canvas:o,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});m.app=n;let d=[],u=n.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!u)throw new Error("WebGL not supported");let h=u,x=Wh(h,{texFilter:e.texFilter}),f=td(e,x);m.gfx=f;let A=Yd();m.audio=A;let g=Dh(x,e.spriteAtlasPadding??0);m.assets=g;let w=Nd();m.game=w,w.root.use(ji());function E(X,$){let ae=new js(x,X,$);return{clear:()=>ae.clear(),free:()=>ae.free(),toDataURL:()=>ae.toDataURL(),toImageData:()=>ae.toImageData(),width:ae.width,height:ae.height,draw:re=>{Lt(),ae.bind(),re(),Lt(),ae.unbind()},get fb(){return ae}}}function T(){h.clear(h.COLOR_BUFFER_BIT),f.frameBuffer.bind(),h.clear(h.COLOR_BUFFER_BIT),f.bgColor||yo(()=>{As({width:ft(),height:xt(),quad:new Je(0,0,ft()/64,xt()/64),tex:f.bgTex,fixed:!0})}),f.renderer.numDraws=0,f.fixed=!1,f.transformStack.length=0,f.transform=new Zt}function q(X,$){f.postShader=X,f.postShaderUniform=$??null}function U(){Lt(),f.lastDrawCalls=f.renderer.numDraws,f.frameBuffer.unbind(),h.viewport(0,0,h.drawingBufferWidth,h.drawingBufferHeight);let X=f.width,$=f.height;f.width=h.drawingBufferWidth/l,f.height=h.drawingBufferHeight/l,Ws({flipY:!0,tex:f.frameBuffer.tex,pos:new _(f.viewport.x,f.viewport.y),width:f.viewport.width,height:f.viewport.height,shader:f.postShader,uniform:typeof f.postShaderUniform=="function"?f.postShaderUniform():f.postShaderUniform,fixed:!0}),Lt(),f.width=X,f.height=$}let p=!1,y={inspect:!1,set timeScale(X){m.app.state.timeScale=X},get timeScale(){return m.app.state.timeScale},showLog:!0,fps:()=>n.fps(),numFrames:()=>n.numFrames(),stepFrame:ye,drawCalls:()=>f.lastDrawCalls,clearLog:()=>w.logs=[],log:(...X)=>{let $=e.logMax??8,ae=X.length>1?X.concat(" ").join(" "):X[0];w.logs.unshift({msg:ae,time:n.time()}),w.logs.length>$&&(w.logs=w.logs.slice(0,$))},error:X=>y.log(new Error(X.toString?X.toString():X)),curRecording:null,numObjects:()=>Y("*",{recursive:!0}).length,get paused(){return p},set paused(X){p=X,X?A.ctx.suspend():A.ctx.resume()}};m.debug=y;function b(X,$){try{return JSON.parse(window.localStorage[X])}catch{return $?(v(X,$),$):null}}function v(X,$){window.localStorage[X]=JSON.stringify($)}function D(X,...$){let ae=X(K),re;typeof ae=="function"?re=ae(...$)(K):re=ae;for(let me in re)K[me]=re[me],e.global!==!1&&(window[me]=re[me]);return K}function P(X){let $=n.canvas.captureStream(X),ae=A.ctx.createMediaStreamDestination();A.masterNode.connect(ae);let re=new MediaRecorder($),me=[];return re.ondataavailable=ue=>{ue.data.size>0&&me.push(ue.data)},re.onerror=()=>{A.masterNode.disconnect(ae),$.getTracks().forEach(ue=>ue.stop())},re.start(),{resume(){re.resume()},pause(){re.pause()},stop(){return re.stop(),A.masterNode.disconnect(ae),$.getTracks().forEach(ue=>ue.stop()),new Promise(ue=>{re.onstop=()=>{ue(new Blob(me,{type:"video/mp4"}))}})},download(ue="kaboom.mp4"){this.stop().then(qe=>qn(ue,qe))}}}function O(){return document.activeElement===n.canvas}let I=w.root.add.bind(w.root),R=w.root.readd.bind(w.root),N=w.root.removeAll.bind(w.root),Y=w.root.get.bind(w.root),j=w.root.wait.bind(w.root),k=w.root.loop.bind(w.root),G=w.root.query.bind(w.root),Q=w.root.tween.bind(w.root),pe=fs(null,Ou),ee=fs(null,Bu);m.kaSprite=pe,m.boomSprite=ee;function De(){w.root.fixedUpdate()}function ye(){w.root.update()}class Se{constructor($,ae,re,me,ue=!1){L(this,"source");L(this,"target");L(this,"normal");L(this,"distance");L(this,"resolved",!1);this.source=$,this.target=ae,this.normal=re,this.distance=me,this.resolved=ue}get displacement(){return this.normal.scale(this.distance)}reverse(){return new Se(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(w.gravity||H(0,1))>0}isRight(){return this.displacement.cross(w.gravity||H(0,1))<0}isTop(){return this.displacement.dot(w.gravity||H(0,1))>0}isBottom(){return this.displacement.dot(w.gravity||H(0,1))<0}preventResolution(){this.resolved=!0}}function Ae(){if(!mu())return;let X={},$=e.hashGridSize||64,ae=new Zt,re=[];function me(ue){if(re.push(ae.clone()),ue.pos&&ae.translate(ue.pos),ue.scale&&ae.scale(ue.scale),ue.angle&&ae.rotate(ue.angle),ue.transform=ae.clone(),ue.c("area")&&!ue.paused){let qe=ue,yt=qe.worldArea().bbox(),Xt=Math.floor(yt.pos.x/$),It=Math.floor(yt.pos.y/$),vt=Math.ceil((yt.pos.x+yt.width)/$),je=Math.ceil((yt.pos.y+yt.height)/$),eo=new Set;for(let lt=Xt;lt<=vt;lt++)for(let Ye=It;Ye<=je;Ye++)if(!X[lt])X[lt]={},X[lt][Ye]=[qe];else if(!X[lt][Ye])X[lt][Ye]=[qe];else{let wt=X[lt][Ye];e:for(let We of wt){if(We.paused||!We.exists()||eo.has(We.id))continue;for(let _e of qe.collisionIgnore)if(We.is(_e))continue e;for(let _e of We.collisionIgnore)if(qe.is(_e))continue e;let Gt=dc(qe.worldArea(),We.worldArea());if(Gt){let _e=new Se(qe,We,Gt.normal,Gt.distance);qe.trigger("collideUpdate",We,_e);let ke=_e.reverse();ke.resolved=_e.resolved,We.trigger("collideUpdate",qe,ke)}eo.add(We.id)}wt.push(qe)}}ue.children.forEach(me),ae=re.pop()}me(w.root)}function Ce(X){console.error(X),A.ctx.suspend();let $=X.message??String(X)??"Unknown error, check console for more info";n.run(()=>{},()=>{T(),yo(()=>{let ae=ft(),re=xt(),me={size:36,width:ae-32*2,letterSpacing:4,lineSpacing:4,font:Ks,fixed:!0};zt({width:ae,height:re,color:Le(0,0,255),fixed:!0});let ue=Lo({...me,text:"Error",pos:H(32),color:Le(255,128,0),fixed:!0});zo(ue),$n({...me,text:$,pos:H(32,32+ue.height+16),fixed:!0}),St(),w.events.trigger("error",X)}),U()})}function Pe(X){d.push(X)}function se(){w.events.onOnce("frameEnd",()=>{n.quit(),h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT|h.STENCIL_BUFFER_BIT);let X=h.getParameter(h.MAX_TEXTURE_IMAGE_UNITS);for(let $=0;$<X;$++)h.activeTexture(h.TEXTURE0+$),h.bindTexture(h.TEXTURE_2D,null),h.bindTexture(h.TEXTURE_CUBE_MAP,null);h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),x.destroy(),d.forEach($=>$())})}let V=!0;n.run(()=>{try{g.loaded&&(y.paused||De(),Ae())}catch(X){Ce(X)}},(X,$)=>{try{X(),g.loaded||Oo()===1&&!V&&(g.loaded=!0,tr().forEach(ae=>w.events.trigger("loadError",...ae)),w.events.trigger("load")),!g.loaded&&e.loadingScreen!==!1||V?(T(),Qh(),U()):(y.paused||ye(),Ae(),T(),Jh(),e.debug!==!1&&$h(),U()),V&&(V=!1),w.events.trigger("frameEnd"),$()}catch(ae){Ce(ae)}}),Za(),Or();let K={_k:m,VERSION:Lu,loadRoot:Sh,loadProgress:Oo,loadSprite:fs,loadSpriteAtlas:cr,loadSound:Fh,loadMusic:Yh,loadBitmapFont:Lh,loadFont:Bh,loadShader:Uh,loadShaderURL:qh,loadAseprite:Ph,loadPedit:zh,loadBean:Ih,loadJSON:Rh,load:Yi,getSound:lr,getFont:nr,getBitmapFont:ar,getSprite:or,getShader:rr,getAsset:Th,Asset:Ut,SpriteData:Eo,SoundData:bs,width:ft,height:xt,center:Vs,dt,fixedDt:_i,restDt:Fi,time:n.time,screenshot:n.screenshot,record:P,isFocused:O,setCursor:n.setCursor,getCursor:n.getCursor,setCursorLocked:n.setCursorLocked,isCursorLocked:n.isCursorLocked,setFullscreen:n.setFullscreen,isFullscreen:n.isFullscreen,isTouchscreen:n.isTouchscreen,onLoad:bn,onLoadError:Cd,onLoading:Rd,onResize:Td,onGamepadConnect:n.onGamepadConnect,onGamepadDisconnect:n.onGamepadDisconnect,onError:Dd,onCleanup:Pe,flash:Dr,setCamPos:vr,getCamPos:Mr,setCamRot:Rr,getCamRot:Tr,setCamScale:Er,getCamScale:Sr,getCamTransform:Id,camPos:Od,camScale:Ld,camFlash:Hd,camRot:zd,camTransform:Pd,shake:Bd,toScreen:Ki,toWorld:Cr,setGravity:Ud,getGravity:qd,setGravityDirection:_d,getGravityDirection:gs,setBackground:wh,getBackground:bh,getGamepads:n.getGamepads,getTreeRoot:Jd,add:I,make:An,destroy:zr,destroyAll:N,get:Y,query:G,readd:R,pos:$s,scale:Js,rotate:Iu,color:gr,opacity:mr,anchor:$i,area:xu,sprite:Vi,text:tu,polygon:cd,rect:yr,circle:od,uvquad:ou,outline:ad,particles:ld,body:yu,platformEffector:Eu,surfaceEffector:bu,areaEffector:Au,pointEffector:vu,buoyancyEffector:Su,constantForce:Mu,doubleJump:wu,shader:hd,textInput:gu,timer:ji,fixed:qr,stay:Ur,health:du,lifespan:uu,named:pu,state:fu,z:Pu,layer:Tu,move:Du,offscreen:Cu,follow:Ru,fadeIn:id,mask:nd,drawon:sd,raycast:xr,tile:Hr,animate:hu,serializeAnimation:Nr,agent:su,sentry:au,patrol:nu,pathfinder:iu,trigger:ud,on:Ct,onFixedUpdate:pd,onUpdate:wr,onDraw:fd,onAdd:br,onDestroy:gd,onTag:Ar,onUntag:yd,onUse:md,onUnuse:xd,onClick:vd,onCollide:wd,onCollideUpdate:bd,onCollideEnd:Ad,onHover:Md,onHoverUpdate:Ed,onHoverEnd:Sd,onKeyDown:n.onKeyDown,onKeyPress:n.onKeyPress,onKeyPressRepeat:n.onKeyPressRepeat,onKeyRelease:n.onKeyRelease,onMouseDown:n.onMouseDown,onMousePress:n.onMousePress,onMouseRelease:n.onMouseRelease,onMouseMove:n.onMouseMove,onCharInput:n.onCharInput,onTouchStart:n.onTouchStart,onTouchMove:n.onTouchMove,onTouchEnd:n.onTouchEnd,onScroll:n.onScroll,onHide:n.onHide,onShow:n.onShow,onGamepadButtonDown:n.onGamepadButtonDown,onGamepadButtonPress:n.onGamepadButtonPress,onGamepadButtonRelease:n.onGamepadButtonRelease,onGamepadStick:n.onGamepadStick,onButtonPress:n.onButtonPress,onButtonDown:n.onButtonDown,onButtonRelease:n.onButtonRelease,mousePos:n.mousePos,mouseDeltaPos:n.mouseDeltaPos,isKeyDown:n.isKeyDown,isKeyPressed:n.isKeyPressed,isKeyPressedRepeat:n.isKeyPressedRepeat,isKeyReleased:n.isKeyReleased,isMouseDown:n.isMouseDown,isMousePressed:n.isMousePressed,isMouseReleased:n.isMouseReleased,isMouseMoved:n.isMouseMoved,isGamepadButtonPressed:n.isGamepadButtonPressed,isGamepadButtonDown:n.isGamepadButtonDown,isGamepadButtonReleased:n.isGamepadButtonReleased,getGamepadStick:n.getGamepadStick,isButtonPressed:n.isButtonPressed,isButtonDown:n.isButtonDown,isButtonReleased:n.isButtonReleased,setButton:n.setButton,getButton:n.getButton,pressButton:n.pressButton,releaseButton:n.releaseButton,getLastInputDeviceType:n.getLastInputDeviceType,charInputted:n.charInputted,loop:k,wait:j,play:Gd,setVolume:Pr,getVolume:Br,volume:Kd,burp:Ir,audioCtx:A.ctx,Line:Dt,Rect:Fe,Circle:Tt,Ellipse:uo,Point:jl,Polygon:At,Vec2:_,Color:Ie,Mat4:Zt,Quad:Je,RNG:Da,rand:ht,randi:Ca,randSeed:Cl,vec2:H,rgb:Le,hsl2rgb:Sl,quad:ot,choose:Bl,chooseMultiple:Pl,shuffle:Ia,chance:Il,lerp:Rt,tween:Q,easings:ys,map:$t,mapc:Rl,wave:Ta,deg2rad:st,rad2deg:Bo,clamp:Qt,evaluateQuadratic:$l,evaluateQuadraticFirstDerivative:Jl,evaluateQuadraticSecondDerivative:Ql,evaluateBezier:un,evaluateBezierFirstDerivative:Zl,evaluateBezierSecondDerivative:kl,evaluateCatmullRom:ec,evaluateCatmullRomFirstDerivative:tc,curveLengthApproximation:_a,normalizedCurve:oc,hermite:Ms,cardinal:Fa,catmullRom:Gs,bezier:sc,kochanekBartels:ic,easingSteps:hc,easingLinear:lc,easingCubicBezier:cc,testLineLine:an,testRectRect:Pa,testRectLine:rn,testRectPoint:si,testCirclePolygon:ni,testLinePoint:ln,testLineCircle:vs,isConvex:mc,triangulate:Xa,NavMesh:xh,drawSprite:kh,drawText:$n,formatText:Lo,drawRect:zt,drawLine:cs,drawLines:wn,drawTriangle:pr,drawCircle:Qo,drawEllipse:hr,drawUVQuad:As,drawPolygon:wo,drawCurve:dr,drawBezier:Vh,drawFormattedText:zo,drawMasked:Zh,drawSubtracted:ed,pushTransform:Ot,popTransform:St,pushTranslate:Qe,pushScale:ws,pushRotate:Ko,pushMatrix:Ah,usePostEffect:q,makeCanvas:E,debug:y,scene:Qd,getSceneName:eu,go:Zd,onSceneLeave:kd,layers:$d,getLayers:jd,setLayers:Lr,getDefaultLayer:Wd,addLevel:dd,getData:b,setData:v,download:fn,downloadJSON:Bc,downloadText:Ja,downloadBlob:qn,plug:D,ASCII_CHARS:Ga,canvas:n.canvas,addKaboom:Vd,LEFT:_.LEFT,RIGHT:_.RIGHT,UP:_.UP,DOWN:_.DOWN,RED:Ie.RED,GREEN:Ie.GREEN,BLUE:Ie.BLUE,YELLOW:Ie.YELLOW,MAGENTA:Ie.MAGENTA,CYAN:Ie.CYAN,WHITE:Ie.WHITE,BLACK:Ie.BLACK,quit:se,KEvent:bt,KEventHandler:xs,KEventController:Uo,cancel:()=>Va};m.k=K;let te=e.plugins;if(te&&te.forEach(D),e.global!==!1)for(let X in K)window[X]=K[X];return e.focus!==!1&&n.canvas.focus(),K},Hu=zu;const Nu="modulepreload",Uu=function(e){return"/SuperSmashTexty/"+e},Zn={},qu=function(t,o,s){let i=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),c=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(o.map(r=>{if(r=Uu(r),r in Zn)return;Zn[r]=!0;const n=r.endsWith(".css"),d=n?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${d}`))return;const u=document.createElement("link");if(u.rel=n?"stylesheet":Nu,n||(u.as="script"),u.crossOrigin="",u.href=r,c&&u.setAttribute("nonce",c),document.head.appendChild(u),n)return new Promise((h,x)=>{u.addEventListener("load",h),u.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${r}`)))})}))}function a(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return i.then(l=>{for(const c of l||[])c.status==="rejected"&&a(c.reason);return t().catch(a)})},kn=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Legendary","Royal","Noble","Rogue","Savage"],ea=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter"];function Ji(){const e=kn[Math.floor(Math.random()*kn.length)],t=ea[Math.floor(Math.random()*ea.length)];return`${e}${t}`}function ta(){return Math.floor(1e5+Math.random()*9e5).toString()}function _u(e){return/^\d{6}$/.test(e)}const _r="superSmashTexty_save",Fu="$",Qi={version:1,currency:0,playerName:null,inviteCode:null,unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0},achievements:[]};function Ze(){try{const t=localStorage.getItem(_r);if(t){const o=JSON.parse(t),s={...Qi,...o};return s.playerName||(s.playerName=Ji(),Ht(s)),s.inviteCode||(s.inviteCode=ta(),Ht(s)),s}}catch(t){console.error("Error loading save:",t)}const e={...Qi};return e.playerName=Ji(),e.inviteCode=ta(),Ht(e),e}function Ht(e){try{return localStorage.setItem(_r,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function Yu(){return Ze()}function Zi(e){const t=Ze();return t.currency+=e,Ht(t),t.currency}function No(){return Ze().currency}function Wt(e,t){const o=Ze();return o.unlocks[e]&&o.unlocks[e].includes(t)}function Xu(e,t){const o=Ze();return o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)?!1:(o.unlocks[e].push(t),Ht(o),!0)}async function oa(e){const{CHARACTER_UNLOCKS:t}=await qu(async()=>{const{CHARACTER_UNLOCKS:s}=await Promise.resolve().then(()=>Zu);return{CHARACTER_UNLOCKS:s}},void 0);Ze();let o=!1;for(const[s,i]of Object.entries(t))i.unlockRequirement&&i.unlockRequirement.type==="floor"&&e>=i.unlockRequirement.value&&(Wt("characters",s)||(Xu("characters",s),o=!0));return o}function Es(){return Ze().selectedCharacter||"survivor"}function Gu(e){const t=Ze();t.selectedCharacter=e,Ht(t)}function no(e){const t=Ze();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function Ku(e,t,o){const s=Ze();return s.currency>=o?(s.currency-=o,s.unlocks[e]||(s.unlocks[e]=[]),s.unlocks[e].includes(t)||s.unlocks[e].push(t),Ht(s),!0):!1}function Vu(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function ju(e,t,o){const s=Ze(),i=no(e);return o&&i>=o?{success:!1,reason:"maxLevel"}:s.currency<t?{success:!1,reason:"insufficientCurrency"}:(s.currency-=t,s.permanentUpgradeLevels||(s.permanentUpgradeLevels={}),s.permanentUpgradeLevels[e]=(i||0)+1,s.permanentUpgradePurchaseHistory||(s.permanentUpgradePurchaseHistory={}),s.permanentUpgradePurchaseHistory[e]||(s.permanentUpgradePurchaseHistory[e]=[]),s.permanentUpgradePurchaseHistory[e].push(t),s.unlocks.permanentUpgrades||(s.unlocks.permanentUpgrades=[]),s.unlocks.permanentUpgrades.includes(e)||s.unlocks.permanentUpgrades.push(e),Ht(s),{success:!0,newLevel:s.permanentUpgradeLevels[e]})}function Fr(){const e=Ze();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(o=>{const s=e.permanentUpgradePurchaseHistory[o];s&&Array.isArray(s)&&s.forEach(i=>{t+=i})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(o=>{const s=e.permanentUpgradeLevels[o]||0;for(let i=0;i<s;i++)t+=Vu(i)}),t}return 0}function Wu(){const e=Ze(),t=Fr();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),Ht(e),{success:!0,refundAmount:t})}function $u(e){const t=Ze();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),Ht(t)}function at(e){const t=Ze();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function rt(e){const t=Ze();return t.achievements||(t.achievements=[]),t.achievements.includes(e)?!1:(t.achievements.push(e),Ht(t),!0)}function Ju(){return Ze().achievements||[]}function Yr(){return Ze().stats||Qi.stats}function Qu(e){let t=0;return t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30),Math.floor(t)}function Mn(){return Fu}function En(){return Ze().playerName||"Player"}function sa(e){const t=Ze();return t.playerName=e,Ht(t),t.playerName}function Vo(){return Ze().inviteCode||"000000"}const Ao={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"}},Xr={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0}},Gr={startingHealth:{name:"Starting Health +10",description:"Begin runs with +10 max health",cost:50,maxLevel:5},startingDamage:{name:"Starting Damage +1",description:"Begin runs with +1 damage",cost:75,maxLevel:5},startingSpeed:{name:"Starting Speed +10",description:"Begin runs with +10 speed",cost:60,maxLevel:5}};function Kr(e){switch(e){case"characters":return Ao;case"weapons":return Xr;case"permanentUpgrades":return Gr;default:return{}}}const Zu=Object.freeze(Object.defineProperty({__proto__:null,CHARACTER_UNLOCKS:Ao,PERMANENT_UPGRADE_UNLOCKS:Gr,WEAPON_UNLOCKS:Xr,getUnlocksForCategory:Kr},Symbol.toStringTag,{value:"Module"})),ki={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]}};function Vr(e){return ki[e]||ki.pistol}function ku(e,t){return Vr(e).upgradeCategories.includes(t)}const ts={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},jt={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},lo={BASE_XP_TO_NEXT_LEVEL:10,XP_SCALING_FACTOR:1.5,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},go={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},mt={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},jo={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},$e={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:200,MAGNETIZE_ACCELERATION:50,COLLECTION_RADIUS:20};function Mi(e,t=0,o=0){const s=e*(1-o);return Math.max(mt.MIN_DAMAGE,s-t)}function ep(e){return Math.random()<e}function tp(e,t=2){return Math.floor(e*t)}function Ei(e,t,o,s=null){const i=s||Es(),a=Ao[i]||Ao.survivor,l=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.z(-1),"playerOutline"]),c=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...a.color),e.area(),e.health(a.stats.health),"player"]);c.outline=l,c.characterKey=i,c.characterData=a,c.speed=a.stats.speed,c.originalSpeed=a.stats.speed,c.slowed=!1,c.maxHealth=a.stats.health,c.level=lo.STARTING_LEVEL,c.xp=lo.STARTING_XP,c.xpToNext=lo.BASE_XP_TO_NEXT_LEVEL,c.pickupRadius=jt.BASE_PICKUP_RADIUS,c.invulnerable=!1,c.invulnerableTime=0,c.invulnerableDuration=jt.INVULNERABILITY_DURATION,c.setHP(c.maxHealth);const r=a.weapon||"pistol",n=Vr(r);c.weaponKey=r,c.weaponDef=n,c.baseFireRate=n.fireRate,c.baseProjectileSpeed=n.projectileSpeed,c.baseProjectileDamage=n.baseDamage;const d=a.stats.damage||10,u=n.baseDamage,h=d/10;c.fireRate=n.fireRate,c.projectileSpeed=n.projectileSpeed,c.projectileDamage=Math.floor(u*h),c.lastFireTime=0,c.projectileCount=n.projectileCount,c.piercing=n.piercing,c.obstaclePiercing=n.obstaclePiercing,c.critChance=n.critChance,c.critDamage=n.critDamage,c.spreadAngle=n.spreadAngle,c.defense=0,c.weaponRange=n.range,c.weaponCategory=n.category,n.orbitRadius&&(c.orbitRadius=n.orbitRadius,c.rotationSpeed=n.rotationSpeed,c.orbitalOrbs=[],c.orbitalAngles=[]),n.explosionRadius&&(c.explosionRadius=n.explosionRadius,c.explosionDamage=n.explosionDamage),n.chainRange&&(c.chainRange=n.chainRange,c.maxJumps=n.maxJumps,c.chainDamageReduction=n.chainDamageReduction),c.xpMultiplier=1,c.dodgeChance=0,c.damageReduction=0,c.weapons=[r],c.passiveUpgrades=[],c.upgradeStacks={},a.ability==="xpBoost"?c.xpMultiplier=go.SURVIVOR_XP_BOOST:a.ability==="speedBoost"?(c.speed=c.speed*go.SCOUT_SPEED_BOOST,c.originalSpeed=c.speed,c.dodgeChance=go.SCOUT_DODGE_CHANCE):a.ability==="tankStats"?(c.maxHealth=Math.floor(c.maxHealth*go.TANK_HEALTH_BOOST),c.setHP(c.maxHealth),c.damageReduction=go.TANK_DAMAGE_REDUCTION):a.ability==="critBoost"?(c.critChance=(c.critChance||0)*go.SNIPER_CRIT_CHANCE_MULTIPLIER,c.critDamage=(c.critDamage||2)*go.SNIPER_CRIT_DAMAGE_MULTIPLIER):a.ability==="fireDot"&&(c.fireDotMultiplier=go.PYRO_FIRE_DOT_MULTIPLIER);let x=e.vec2(0,0);return e.onKeyDown(["w","up"],()=>{c.isRemote||(x.y=-1)}),e.onKeyDown(["s","down"],()=>{c.isRemote||(x.y=1)}),e.onKeyDown(["a","left"],()=>{c.isRemote||(x.x=-1)}),e.onKeyDown(["d","right"],()=>{c.isRemote||(x.x=1)}),e.onKeyRelease(["w","up"],()=>{c.isRemote||!e.isKeyDown("s")&&!e.isKeyDown("down")&&(x.y=0)}),e.onKeyRelease(["s","down"],()=>{c.isRemote||!e.isKeyDown("w")&&!e.isKeyDown("up")&&(x.y=0)}),e.onKeyRelease(["a","left"],()=>{c.isRemote||!e.isKeyDown("d")&&!e.isKeyDown("right")&&(x.x=0)}),e.onKeyRelease(["d","right"],()=>{c.isRemote||!e.isKeyDown("a")&&!e.isKeyDown("left")&&(x.x=0)}),c.onUpdate(()=>{if(c.outline&&c.outline.exists()&&(c.outline.pos=c.pos.clone()),e.paused)return;if(c.invulnerable)if(c.invulnerableTime-=e.dt(),c.invulnerableTime<=0)c.invulnerable=!1,c.color=e.rgb(...jt.NORMAL_COLOR),c.outline&&c.outline.exists()&&(c.outline.opacity=1);else{const w=jt.IMMUNITY_FLASH_RATE;Math.floor(c.invulnerableTime*w)%2===0?(c.color=e.rgb(...jt.NORMAL_COLOR),c.outline&&c.outline.exists()&&(c.outline.opacity=1)):(c.color=e.rgb(...jt.NORMAL_COLOR,jt.IMMUNITY_ALPHA),c.outline&&c.outline.exists()&&(c.outline.opacity=jt.IMMUNITY_ALPHA))}if(x.len()>0){const w=x.len(),T=x.scale(1/w).scale(c.speed*e.dt()),q=c.pos.x+T.x,U=c.pos.y+T.y;let p=!0,y=!0;const b=e.get("obstacle"),v=jt.COLLISION_SIZE;for(const D of b){if(!D.exists())continue;const P=D.pos.x-D.width/2,O=D.pos.x+D.width/2,I=D.pos.y-D.height/2,R=D.pos.y+D.height/2,N=q-v,Y=q+v,j=c.pos.y-v,k=c.pos.y+v;Y>P&&N<O&&k>I&&j<R&&(p=!1);const G=c.pos.x-v,Q=c.pos.x+v,pe=U-v,ee=U+v;Q>P&&G<O&&ee>I&&pe<R&&(y=!1)}p&&(c.pos.x=q),y&&(c.pos.y=U)}const f=e.width(),A=e.height(),g=jt.ROOM_MARGIN;c.pos.x=e.clamp(c.pos.x,g,f-g),c.pos.y=e.clamp(c.pos.y,g,A-g)}),c}const Re={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function jr(e,t=!0){return new Promise((o,s)=>{if(Re.isInitialized){console.warn("Network already initialized"),o();return}const i=`smash-tab-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,a="smash_active_network_tab",l=sessionStorage.getItem(a);if(l&&l!==i){console.warn("Another tab already has an active network connection. Multiplayer disabled in this tab."),s(new Error("Multiple tabs detected - only one tab can host multiplayer"));return}if(sessionStorage.setItem(a,i),typeof Peer>"u"){console.error("PeerJS library not loaded"),s(new Error("PeerJS library not available"));return}Re.isHost=t;const c=t?`smash-${e}`:void 0;try{Re.peer=new Peer(c,{debug:0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:openrelay.metered.ca:80",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443?transport=tcp",username:"openrelayproject",credential:"openrelayproject"}]}}),Re.peer.on("open",r=>{console.log("Peer initialized with ID:",r),Re.peerId=r,Re.isInitialized=!0,o(r)}),Re.peer.on("error",r=>{console.error("Peer error:",r),r.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):r.type==="peer-unavailable"?console.warn("Host not found - check invite code"):r.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),Re.isInitialized||s(new Error(`Multiplayer unavailable: ${r.type||"connection failed"}`))}),t&&Re.peer.on("connection",r=>{console.log("Incoming connection from:",r.peer),op(r)})}catch(r){console.error("Failed to create peer:",r),s(r)}})}function op(e){Re.isHost&&(e.on("open",()=>{console.log("Connection opened with:",e.peer),Re.connections.set(e.peer,e),Re.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{Wr(t,e.peer)}),e.on("close",()=>{console.log("Connection closed with:",e.peer),Re.connections.delete(e.peer),Re.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function sp(e){return new Promise((t,o)=>{if(Re.isHost){o(new Error("Host cannot connect to another host"));return}if(!Re.isInitialized){o(new Error("Network not initialized"));return}const s=`smash-${e}`;console.log("[NetworkSystem] Attempting to connect to host:",s),console.log("[NetworkSystem] Using STUN/TURN servers for NAT traversal...");let i,a=!1;const l=Re.peer.connect(s,{reliable:!0});i=setTimeout(()=>{a||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),l.close(),o(new Error("Connection timeout - could not reach host")))},3e4),l.on("open",()=>{a=!0,clearTimeout(i),console.log("[NetworkSystem] Successfully connected to host!"),Re.hostConnection=l,Re.hostId=s,Sn("join_request",{peerId:Re.peerId}),t()}),l.on("data",c=>{Wr(c,s)}),l.on("close",()=>{console.log("[NetworkSystem] Disconnected from host"),Re.hostConnection=null,Re.hostId=null,Re.connectionCallbacks.forEach(c=>c("host_disconnect"))}),l.on("error",c=>{a=!0,clearTimeout(i),console.error("[NetworkSystem] Connection error:",c),console.error("[NetworkSystem] Error type:",c.type||"unknown"),o(c)})})}function Wr(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const o=Re.messageHandlers.get(e.type);o?o(e.payload,t):console.warn("No handler for message type:",e.type)}function ao(e,t){Re.messageHandlers.set(e,t)}function $r(e){Re.connectionCallbacks.includes(e)||Re.connectionCallbacks.push(e)}function Sn(e,t){if(Re.isHost){console.warn("Host cannot send to itself");return}if(!Re.hostConnection){console.warn("Not connected to host");return}Re.hostConnection.send({type:e,payload:t})}function en(e,t,o){if(!Re.isHost){console.warn("Only host can send to specific peers");return}const s=Re.connections.get(e);s?s.send({type:t,payload:o}):console.warn("No connection to peer:",e)}function Ss(e,t,o=[]){if(!Re.isHost){console.warn("Only host can broadcast");return}Re.connections.forEach((s,i)=>{o.includes(i)||s.send({type:e,payload:t})})}function ip(){return{isInitialized:Re.isInitialized,isHost:Re.isHost,peerId:Re.peerId,hostId:Re.hostId,connectedPeers:Array.from(Re.connections.keys()),peerCount:Re.connections.size}}const Te={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!0,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null};async function np(e=null){if(e&&(Te.kaplayInstance=e),Te.slots[0].playerName=En(),Te.slots[0].inviteCode=Vo(),Te.slots[0].selectedCharacter=Es(),!Te.networkInitialized)try{const t=Vo();await jr(t,!0),Te.networkInitialized=!0,console.log("Party network initialized as host"),ap()}catch(t){console.error("Failed to initialize party network:",t),console.warn("Multiplayer disabled - running in single-player mode")}}function ap(){ao("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const o=rp(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",t);o!==null?(en(t,"party_sync",{slots:Te.slots.map(s=>({playerId:s.playerId,playerName:s.playerName,inviteCode:s.inviteCode,selectedCharacter:s.selectedCharacter,isLocal:!1})),yourSlotIndex:o}),setTimeout(()=>{Sp(t)},100),tn()):en(t,"join_rejected",{reason:"Party full"})}),ao("player_info",(e,t)=>{const o=Te.peerIdToSlot.get(t);o!==void 0&&(e.playerName&&(Te.slots[o].playerName=e.playerName),tn())}),$r((e,t)=>{e==="leave"&&dp(t)})}function Jr(){return Te}function Qr(){return Te.slots.filter(e=>e.playerId!==null).length}function rp(e,t,o,s){for(let i=1;i<Te.slots.length;i++)if(Te.slots[i].playerId===null)return Te.slots[i].playerId=`player_${Date.now()}_${i}`,Te.slots[i].playerName=e,Te.slots[i].inviteCode=t,Te.slots[i].selectedCharacter=o,Te.slots[i].peerId=s,Te.peerIdToSlot.set(s,i),i;return null}async function lp(e){try{return Te.networkInitialized||(await jr("client",!1),Te.networkInitialized=!0,Te.isHost=!1),cp(),await sp(e),Sn("join_request",{playerName:En(),inviteCode:Vo(),selectedCharacter:Es()}),!0}catch(t){return console.error("Failed to join party:",t),!1}}function cp(){ao("party_sync",e=>{console.log("Received party sync:",e),Te.slots=e.slots,e.yourSlotIndex!==void 0&&(Te.slots[e.yourSlotIndex].isLocal=!0),Te.slots[0].isLocal=!1}),ao("party_update",e=>{console.log("Received party update:",e),Te.slots=e.slots}),ao("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),ao("game_start",e=>{console.log("Host started game - joining..."),Te.kaplayInstance?Te.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),$r(e=>{e==="host_disconnect"&&(alert("Host disconnected"),up())})}function tn(){Te.isHost&&Ss("party_update",{slots:Te.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,isLocal:!1}))})}function hp(){Te.isHost&&(console.log("Broadcasting game start to all clients"),Ss("game_start",{}))}function dp(e){const t=Te.peerIdToSlot.get(e);t!==void 0&&(console.log("Player disconnected from slot",t),Zr(t),Te.peerIdToSlot.delete(e),tn())}function Zr(e){if(e>0&&e<Te.slots.length){const t=Te.slots[e].peerId;return t&&Te.peerIdToSlot.delete(t),Te.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},!0}return!1}function up(){for(let e=1;e<Te.slots.length;e++)Zr(e)}function pp(){return Te.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode}))}function fp(){return Te.networkInitialized}const So={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function gp(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const s=1+(t-1)*.1;for(const[i,a]of Object.entries(So)){const l=a.dropChance*s;if(Math.random()<l)return i}return null}function mp(e,t){const o=So[t];if(!o)return;const s=ki[o.weaponKey];s&&(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=o.weaponKey,e.weaponDef=s,e.fireRate=s.fireRate,e.projectileSpeed=s.projectileSpeed,e.projectileDamage=s.baseDamage,e.projectileCount=s.projectileCount,e.piercing=s.piercing,e.obstaclePiercing=s.obstaclePiercing,e.critChance=s.critChance,e.critDamage=s.critDamage,e.spreadAngle=s.spreadAngle,e.weaponRange=s.range,e.weaponCategory=s.category,s.orbitRadius&&(e.orbitRadius=s.orbitRadius,e.rotationSpeed=s.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),s.explosionRadius&&(e.explosionRadius=s.explosionRadius,e.explosionDamage=s.explosionDamage),s.chainRange&&(e.chainRange=s.chainRange,e.maxJumps=s.maxJumps,e.chainDamageReduction=s.chainDamageReduction),o.isAmmoBased?(e.powerupAmmo=o.ammo,e.powerupDuration=null):o.isTimeBased&&(e.powerupDuration=o.duration,e.powerupAmmo=null))}function ia(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function xp(e,t=0){if(!e.powerupWeapon)return!1;const o=So[e.powerupWeapon];return o&&(o.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||o.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(ia(e),!0):!1}function yp(e){if(!e.powerupWeapon)return;const t=So[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function wp(e){if(!e.powerupWeapon)return null;const t=So[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function hs(e,t,o,s){const i=e.add([e.text("+",{size:16}),e.pos(t,o),e.anchor("center"),e.color(...$e.XP_COLOR),e.area(),"xpPickup"]);return i.value=s,i.lifetime=$e.XP_LIFETIME,i.age=0,i.collected=!1,i.magnetizing=!1,i.magnetizeSpeed=0,i.targetPlayer=null,i.velocityY=-150-Math.random()*100,i.gravity=600,i.groundY=o,i.bounceDamping=.5,i.bouncing=!0,i.onUpdate(()=>{if(e.paused){const l=Math.sin(i.age*$e.XP_PULSE_SPEED)*$e.XP_PULSE_AMOUNT;i.scale=e.vec2(1+l);return}i.age+=e.dt();const a=Math.sin(i.age*$e.XP_PULSE_SPEED)*$e.XP_PULSE_AMOUNT;if(i.scale=e.vec2(1+a),!i.magnetizing&&i.bouncing&&(i.velocityY+=i.gravity*e.dt(),i.pos.y+=i.velocityY*e.dt(),i.pos.y>=i.groundY&&(i.pos.y=i.groundY,i.velocityY=-i.velocityY*i.bounceDamping,Math.abs(i.velocityY)<20&&(i.bouncing=!1,i.velocityY=0))),i.magnetizing&&i.targetPlayer&&i.targetPlayer.exists()){i.bouncing=!1;const l=e.vec2(i.targetPlayer.pos.x-i.pos.x,i.targetPlayer.pos.y-i.pos.y),c=l.len();if(c>0){const r=l.scale(1/c);i.magnetizeSpeed=Math.min(i.magnetizeSpeed+$e.MAGNETIZE_ACCELERATION*e.dt(),$e.MAGNETIZE_SPEED),i.pos=i.pos.add(r.scale(i.magnetizeSpeed*e.dt()))}}i.age>=i.lifetime&&e.destroy(i)}),i.pickupType="xp",ro()&&Rs()&&Rn(i,{type:"xpPickup",value:s}),i}const na=["$","","","","","","",""];function kr(){return na[Math.floor(Math.random()*na.length)]}function ds(e,t,o,s,i=null){const a=i||kr(),l=e.add([e.text(a,{size:9}),e.pos(t,o),e.anchor("center"),e.color(...$e.CURRENCY_COLOR),e.area(),"currencyPickup"]);return l.value=s,l.lifetime=$e.CURRENCY_LIFETIME,l.age=0,l.collected=!1,l.magnetizing=!1,l.magnetizeSpeed=0,l.targetPlayer=null,l.velocityY=-150-Math.random()*100,l.gravity=600,l.groundY=o,l.bounceDamping=.5,l.bouncing=!0,l.onUpdate(()=>{if(e.paused){const r=Math.sin(l.age*$e.CURRENCY_PULSE_SPEED)*$e.CURRENCY_PULSE_AMOUNT;l.scale=e.vec2(1+r);return}l.age+=e.dt();const c=Math.sin(l.age*$e.CURRENCY_PULSE_SPEED)*$e.CURRENCY_PULSE_AMOUNT;if(l.scale=e.vec2(1+c),!l.magnetizing&&l.bouncing&&(l.velocityY+=l.gravity*e.dt(),l.pos.y+=l.velocityY*e.dt(),l.pos.y>=l.groundY&&(l.pos.y=l.groundY,l.velocityY=-l.velocityY*l.bounceDamping,Math.abs(l.velocityY)<20&&(l.bouncing=!1,l.velocityY=0))),l.magnetizing&&l.targetPlayer&&l.targetPlayer.exists()){l.bouncing=!1;const r=e.vec2(l.targetPlayer.pos.x-l.pos.x,l.targetPlayer.pos.y-l.pos.y),n=r.len();if(n>0){const d=r.scale(1/n);l.magnetizeSpeed=Math.min(l.magnetizeSpeed+$e.MAGNETIZE_ACCELERATION*e.dt(),$e.MAGNETIZE_SPEED),l.pos=l.pos.add(d.scale(l.magnetizeSpeed*e.dt()))}}l.age>=l.lifetime&&e.destroy(l)}),l.pickupType="currency",ro()&&Rs()&&Rn(l,{type:"currencyPickup",value:s,icon:a}),l}function aa(e,t,o,s){const i=So[s];if(!i)return null;const a=e.add([e.text(i.icon,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...i.color),e.area(),"powerupWeaponPickup"]);return a.powerupKey=s,a.lifetime=$e.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.velocityY=-150-Math.random()*100,a.gravity=600,a.groundY=o,a.bounceDamping=.5,a.bouncing=!0,a.onUpdate(()=>{if(e.paused){const c=Math.sin(a.age*4)*.15;a.scale=e.vec2(1+c),a.angle=Math.sin(a.age*2)*10;return}a.age+=e.dt();const l=Math.sin(a.age*4)*.15;if(a.scale=e.vec2(1+l),a.angle=Math.sin(a.age*2)*10,!a.magnetizing&&a.bouncing&&(a.velocityY+=a.gravity*e.dt(),a.pos.y+=a.velocityY*e.dt(),a.pos.y>=a.groundY&&(a.pos.y=a.groundY,a.velocityY=-a.velocityY*a.bounceDamping,Math.abs(a.velocityY)<20&&(a.bouncing=!1,a.velocityY=0))),a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){a.bouncing=!1;const c=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),r=c.len();if(r>0){const n=c.scale(1/r);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+$e.MAGNETIZE_ACCELERATION*e.dt(),$e.MAGNETIZE_SPEED),a.pos=a.pos.add(n.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="powerup",ro()&&Rs()&&Rn(a),a}const ne={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/20,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null};function bp(e,t=0,o=null){ne.isActive=!0,ne.isHost=e,ne.localPlayerSlot=t,ne.players.clear(),ne.inputBuffer=[],ne.lastSyncTime=0,ne.k=o,ne.enemies.clear(),ne.projectiles.clear(),ne.pickups.clear(),ne.nextEntityId=1,console.log(`Multiplayer initialized - isHost: ${e}, localSlot: ${t}`),e?Ap():vp()}function Ap(){ao("player_input",(e,t)=>{const s=Jr().slots.findIndex(i=>i.peerId===t);if(s!==-1&&ne.players.has(s)){const i=ne.players.get(s);e.move&&(i.move=e.move),e.shoot&&(i.isShooting=e.shoot),e.aimAngle!==void 0&&(i.aimAngle=e.aimAngle)}})}function vp(){ao("game_state",e=>{if(ne.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==ne.localPlayerSlot){const o=ne.players.get(t.slotIndex);o&&o.exists()&&(o.pos.x=t.x,o.pos.y=t.y,o.angle=t.angle||0,t.hp!==void 0&&o.setHP&&o.setHP(t.hp))}}),e.enemies){const t=new Set;e.enemies.forEach(o=>{t.add(o.id);const s=ne.enemies.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y,s.setHP&&o.hp!==void 0&&s.setHP(o.hp))}),ne.enemies.forEach((o,s)=>{!t.has(s)&&o.exists()&&(o.destroy(),ne.enemies.delete(s))})}if(e.projectiles){const t=new Set;e.projectiles.forEach(o=>{t.add(o.id);const s=ne.projectiles.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y,s.angle=o.angle||0)}),ne.projectiles.forEach((o,s)=>{!t.has(s)&&o.exists()&&(o.destroy(),ne.projectiles.delete(s))})}if(e.pickups){const t=new Set;e.pickups.forEach(o=>{t.add(o.id);const s=ne.pickups.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y)}),ne.pickups.forEach((o,s)=>{!t.has(s)&&o.exists()&&(o.destroy(),ne.pickups.delete(s))})}}}),ao("spawn_entity",e=>{if(ne.k){if(e.entityType==="enemy"){const t=vo(ne.k,e.x,e.y,e.type,e.floor);t.mpEntityId=e.id,ne.enemies.set(e.id,t),console.log(`Spawned enemy ${e.id} (${e.type}) at (${e.x}, ${e.y})`)}else if(e.entityType==="xpPickup"){const t=hs(ne.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",ne.pickups.set(e.id,t),console.log(`Spawned XP pickup ${e.id} with value ${e.value}`)}else if(e.entityType==="currencyPickup"){const t=ds(ne.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",ne.pickups.set(e.id,t),console.log(`Spawned currency pickup ${e.id} with value ${e.value}`)}}})}function ra(e,t){ne.players.set(e,t),t.mpSlotIndex=e,console.log(`Registered player for slot ${e}`)}function Mp(e){ne.isActive&&(ne.lastSyncTime+=e,ne.isHost?ne.lastSyncTime>=ne.syncInterval&&(Ep(),ne.lastSyncTime=0):ne.lastSyncTime>=ne.syncInterval&&(Rp(),ne.lastSyncTime=0))}function el(){const e=[],t=[],o=[],s=[];return ne.players.forEach((i,a)=>{i.exists()&&e.push({slotIndex:a,x:i.pos.x,y:i.pos.y,angle:i.angle||0,hp:i.hp||i.maxHealth,level:i.level||1,xp:i.xp||0})}),ne.enemies.forEach((i,a)=>{i.exists()?t.push({id:a,x:i.pos.x,y:i.pos.y,hp:i.hp||0,type:i.enemyType||"basic"}):ne.enemies.delete(a)}),ne.projectiles.forEach((i,a)=>{i.exists()?o.push({id:a,x:i.pos.x,y:i.pos.y,angle:i.angle||0}):ne.projectiles.delete(a)}),ne.pickups.forEach((i,a)=>{i.exists()?s.push({id:a,x:i.pos.x,y:i.pos.y,type:i.pickupType||"xp"}):ne.pickups.delete(a)}),{players:e,enemies:t,projectiles:o,pickups:s}}function Ep(){ne.isHost&&Ss("game_state",el())}function Sp(e){!ne.isHost||!ne.isActive||(console.log("Sending initial game state to new joiner:",e),en(e,"game_state",el()))}function Rp(){if(ne.isHost)return;const e=ne.players.get(ne.localPlayerSlot);!e||!e.exists()||Sn("player_input",{slotIndex:ne.localPlayerSlot,move:e.move||{x:0,y:0},shoot:e.isShooting||!1,aimAngle:e.aimAngle||0})}function ro(){return ne.isActive}function Tp(){return ne.players.size}function la(){ne.isActive=!1,ne.players.clear(),ne.inputBuffer=[],ne.enemies.clear(),ne.projectiles.clear(),ne.pickups.clear(),ne.nextEntityId=1,console.log("Multiplayer session cleaned up")}function Dp(e,t={}){if(!ne.isHost)return null;const o=ne.nextEntityId++;return e.mpEntityId=o,ne.enemies.set(o,e),Ss("spawn_entity",{id:o,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1}),o}function Cp(e){if(!ne.isHost)return null;const t=ne.nextEntityId++;return e.mpEntityId=t,ne.projectiles.set(t,e),t}function Rn(e,t={}){if(!ne.isHost)return null;const o=ne.nextEntityId++;e.mpEntityId=o,ne.pickups.set(o,e);const s={id:o,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(s.icon=t.icon),Ss("spawn_entity",s),o}function Rs(){return ne.isHost}function kt(e,t,o,s,i,a,l=0,c=0,r=!1,n=null){const d=Math.atan2(s.y,s.x)*(180/Math.PI)+90,u=e.add([e.text("*",{size:16}),e.pos(t,o),e.anchor("center"),e.color(255,r?200:255,r?0:100),e.rotate(d),e.area(),"projectile"]);return u.damage=a,u.piercing=l,u.obstaclePiercing=c,u.piercedEnemies=new Set,u.piercedObstacles=new Set,u.isCrit=r,u.maxRange=n||jo.DEFAULT_WEAPON_RANGE,u.distanceTraveled=0,u.direction=s,u.speed=i,u.useWeaponVisual=function(h){h&&h.char&&(u.text=h.char),h&&h.color&&(u.isCrit||(u.color=e.rgb(...h.color))),h&&h.range&&(u.maxRange=h.range)},u.onUpdate(()=>{if(e.paused)return;const h=u.direction.scale(u.speed*e.dt()),x=h.len();if(u.distanceTraveled+=x,u.pos.x+=h.x,u.pos.y+=h.y,u.distanceTraveled>=u.maxRange){e.destroy(u);return}(u.pos.x<0||u.pos.x>e.width()||u.pos.y<0||u.pos.y>e.height())&&e.destroy(u)}),ro()&&Rs()&&Cp(u),u}const ca={rusher:{char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.8,projectileSpeed:200,projectileDamage:7},zombie:{char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},mage:{char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},healer:{char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},basic:{char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function Ip(e){return ca[e]||ca.basic}const Jt=32,Pp=100;class Bp{constructor(){this.elements=[]}enqueue(t,o){this.elements.push({element:t,priority:o}),this.elements.sort((s,i)=>s.priority-i.priority)}dequeue(){var t;return(t=this.elements.shift())==null?void 0:t.element}isEmpty(){return this.elements.length===0}}function ha(e,t){return{gx:Math.floor(e/Jt),gy:Math.floor(t/Jt)}}function tl(e,t){return{x:e*Jt+Jt/2,y:t*Jt+Jt/2}}function Si(e,t,o,s,i){if(t<0||o<0||t>=s||o>=i)return!1;const a=tl(t,o),l=e.get("obstacle");for(const c of l){if(!c.exists())continue;const r=Jt/2,n=a.x-r,d=a.x+r,u=a.y-r,h=a.y+r,x=c.pos.x-c.width/2,f=c.pos.x+c.width/2,A=c.pos.y-c.height/2,g=c.pos.y+c.height/2;if(d>x&&n<f&&h>A&&u<g)return!1}return!0}function Op(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function Lp(e,t,o,s,i){const a=e.width(),l=e.height(),c=Math.ceil(a/Jt),r=Math.ceil(l/Jt),n=ha(t,o),d=ha(s,i);if(!Si(e,n.gx,n.gy,c,r)||!Si(e,d.gx,d.gy,c,r))return[];const u=new Bp;u.enqueue(n,0);const h=new Map,x=new Map,f=T=>`${T.gx},${T.gy}`;h.set(f(n),null),x.set(f(n),0);let A=0;const g=c*r;for(;!u.isEmpty()&&A<g;){A++;const T=u.dequeue();if(T.gx===d.gx&&T.gy===d.gy)break;const q=[{gx:T.gx+1,gy:T.gy},{gx:T.gx-1,gy:T.gy},{gx:T.gx,gy:T.gy+1},{gx:T.gx,gy:T.gy-1},{gx:T.gx+1,gy:T.gy+1},{gx:T.gx+1,gy:T.gy-1},{gx:T.gx-1,gy:T.gy+1},{gx:T.gx-1,gy:T.gy-1}];for(const U of q){if(!Si(e,U.gx,U.gy,c,r))continue;const y=U.gx!==T.gx&&U.gy!==T.gy?1.4:1,b=x.get(f(T))+y,v=f(U);if(!x.has(v)||b<x.get(v)){x.set(v,b);const D=b+Op(U,d);u.enqueue(U,D),h.set(v,T)}}}const w=[];let E=d;for(;E&&h.has(f(E));){const T=tl(E.gx,E.gy);if(w.unshift(T),E=h.get(f(E)),w.length>Pp)break}return w}function zp(e,t,o,s){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=Lp(e,t.pos.x,t.pos.y,o,s),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const l=t.pathfindingPath[t.pathfindingWaypointIndex];if(l){const c=e.vec2(l.x-t.pos.x,l.y-t.pos.y),r=c.len();if(r<Jt/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),r>0)return c.unit()}}const i=e.vec2(o-t.pos.x,s-t.pos.y);return i.len()>0?i.unit():e.vec2(0,0)}function Hp(e,t){const o=e.width(),s=e.height(),i=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:i});const a=t.perimeterMode;t.speed*e.dt();const l=20,c=e.vec2(a.targetX-t.pos.x,a.targetY-t.pos.y),r=c.len();if(r<l)switch(a.side){case"top":a.side="right",a.targetX=o-i,a.targetY=i;break;case"right":a.side="bottom",a.targetX=o-i,a.targetY=s-i;break;case"bottom":a.side="left",a.targetX=i,a.targetY=s-i;break;case"left":a.side="top",a.targetX=i,a.targetY=i;break}return r>0?c.unit():e.vec2(0,0)}function vo(e,t,o,s="basic",i=1){const a=Ip(s),l=1+(i-1)*.3,c={char:a.char,color:a.color,health:Math.floor(a.baseHealth*l),speed:Math.floor(a.baseSpeed*(1+(i-1)*.1)),size:a.size,xpValue:Math.floor(a.baseXPValue*l),behavior:a.behavior};function r(){return c.char}const n=e.add([e.text(r(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"enemy"]);n.originalColor=c.color,n.maxHealth=c.health,n.speed=c.speed,n.xpValue=c.xpValue,n.type=s,n.behavior=c.behavior,n.floor=i,n.pathfindingMode=a.pathfindingMode||"none",a.damage&&(n.damage=a.damage),a.fireRate&&(n.fireRate=a.fireRate),a.projectileSpeed&&(n.projectileSpeed=a.projectileSpeed),a.projectileDamage&&(n.projectileDamage=a.projectileDamage),a.chargeCooldown&&(n.chargeCooldown=a.chargeCooldown),a.splits&&(n.splits=!0),a.explodes&&(n.explodes=!0,n.explosionDamage=a.explosionDamage,n.explosionRadius=a.explosionRadius,a.shrapnel&&(n.shrapnel=!0,n.shrapnelCount=a.shrapnelCount||8));let d=0,u=0,h=0;i>=2&&i>=2&&(s==="zombie"||s==="turret"||s==="heavyTank"||Math.random()<.3)&&(d=Math.floor(15+(i-2)*5)),i>=3&&(s==="shooter"||s==="turret"||s==="wraith"||Math.random()<.2)&&(u=Math.floor(10+(i-3)*5),h=1+(i-3)*.5),i>=4&&(s==="heavyTank"||s==="spawner"||Math.random()<.1)&&(d===0&&(d=Math.floor(20+(i-4)*5)),u===0&&(u=Math.floor(15+(i-4)*5),h=1.5+(i-4)*.5));const x=(a.baseArmorHealth||0)+d;n.armorHealth=Math.floor(x*l),n.maxArmorHealth=Math.floor(x*l),n.damageReduction=a.damageReduction||(x>0?.2:0),n.armorChar=a.armorChar||"[]",n.armorColor=a.armorColor||[200,200,200];const f=(a.baseShieldHealth||0)+u;n.shieldHealth=Math.floor(f*l),n.maxShieldHealth=Math.floor(f*l),n.shieldRegenRate=((a.shieldRegenRate||0)+h)*l,n.shieldChar=a.shieldChar||"{}",n.shieldColor=a.shieldColor||[100,200,255],n.shieldRegenTimer=0,n.shieldRegenCooldown=0,n.lastDamageTime=0,n.originalColor=c.color,n.coreChar=c.char,n.updateVisual=function(){let p="",y="",b="",v="";if(n.shieldHealth>0){const P=n.shieldHealth/n.maxShieldHealth;P>.66?(p="",y=""):P>.33?(p="",y=""):(p="",y="")}if(n.armorHealth>0){const P=n.armorHealth/n.maxArmorHealth;P>.66?(b="",v=""):P>.33?(b="",v=""):(b="",v="")}const D=`${p}${b}${n.coreChar}${v}${y}`;n.text=D,n.shieldHealth>0?n.color=e.rgb(...n.shieldColor):n.color=e.rgb(...n.originalColor)},n.takeDamage=function(p){let y=!1,b=!1;const v=n.shieldHealth,D=n.armorHealth;n.lastDamageTime=e.time();const P=3;if(n.shieldRegenCooldown=P,n.shieldHealth>0){const O=Math.min(p,n.shieldHealth);n.shieldHealth=Math.max(0,n.shieldHealth-O),y=n.shieldHealth!==v;const I=p-O;I>0&&n.takeDamageInternal(I)}else n.takeDamageInternal(p);b=n.armorHealth!==D,(y||b)&&n.updateVisual()},n.takeDamageInternal=function(p){if(n.armorHealth>0){const y=Math.floor(p*(1-n.damageReduction)),b=Math.min(y,n.armorHealth);n.armorHealth=Math.max(0,n.armorHealth-b);const v=p-y;if(v>0){const D=n.armorHealth>0?1-n.damageReduction:1,P=Math.floor(v*D);n.hurt(P)}}else n.hurt(p)},a.blocksProjectiles&&(n.blocksProjectiles=!0),a.teleportCooldown&&(n.teleportCooldown=a.teleportCooldown),a.teleportRange&&(n.teleportRange=a.teleportRange),a.spawnInterval&&(n.spawnInterval=a.spawnInterval),a.spawnType&&(n.spawnType=a.spawnType),a.buffRadius&&(n.buffRadius=a.buffRadius),a.buffAmount&&(n.buffAmount=a.buffAmount),a.healRadius&&(n.healRadius=a.healRadius),a.healAmount&&(n.healAmount=a.healAmount),a.healInterval&&(n.healInterval=a.healInterval),a.slowRadius&&(n.slowRadius=a.slowRadius),a.slowAmount&&(n.slowAmount=a.slowAmount),a.lifesteal&&(n.lifesteal=a.lifesteal),n.updateVisual(),n.attackTimer=0,n.chargeTimer=0,n.isCharging=!1,n.chargeDirection=null,n.chargeDuration=0,n.chargePauseTimer=0,n.teleportTimer=0,n.spawnTimer=0,n.healTimer=0,n.buffedEnemies=new Set,n.stuckTimer=0,n.stuckThreshold=1,n.lastPosition={x:t,y:o},n.lastPositionUpdateTime=0,n.avoidanceDirection=null,n.avoidanceTimer=0;const A=30,g=3,w=-20,E=e.add([e.rect(A,g),e.pos(t,o+w),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),T=e.add([e.rect(A,g),e.pos(t,o+w),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);n.healthBarBg=E,n.healthBar=T,n.showHealthThreshold=.5,E.hidden=!0,T.hidden=!0,n.onUpdate(()=>{if(n.exists()&&n.healthBar&&n.healthBarBg){const p=n.hp()/n.maxHealth;if(p<n.showHealthThreshold&&p>0){n.healthBarBg.hidden=!1,n.healthBar.hidden=!1,n.healthBarBg.pos.x=n.pos.x,n.healthBarBg.pos.y=n.pos.y+w,n.healthBar.pos.x=n.pos.x,n.healthBar.pos.y=n.pos.y+w;const b=A*p;n.healthBar.width=Math.max(1,b),n.healthBar.pos.x=n.pos.x-(A-b)/2}else n.healthBarBg.hidden=!0,n.healthBar.hidden=!0}}),n.cleanupHealthBars=function(){n.healthBarBg&&n.healthBarBg.exists()&&e.destroy(n.healthBarBg),n.healthBar&&n.healthBar.exists()&&e.destroy(n.healthBar)};const q=(p,y)=>{const b=e.get("obstacle"),v=n.size||12;for(const D of b){if(!D.exists())continue;const P=D.pos.x-D.width/2,O=D.pos.x+D.width/2,I=D.pos.y-D.height/2,R=D.pos.y+D.height/2,N=p-v,Y=p+v,j=y-v,k=y+v;if(Y>P&&N<O&&k>I&&j<R)return!1}return!0},U=p=>{const y=p.len(),b=y>0?p.unit():e.vec2(0,0);n.lastPositionUpdateTime+=e.dt(),n.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(n.pos.x-n.lastPosition.x,2)+Math.pow(n.pos.y-n.lastPosition.y,2))<5?n.stuckTimer+=n.lastPositionUpdateTime:n.stuckTimer=0,n.lastPosition={x:n.pos.x,y:n.pos.y},n.lastPositionUpdateTime=0);const v=n.pos.x+p.x,D=n.pos.y+p.y;if(q(v,D))return n.avoidanceDirection=null,n.avoidanceTimer=0,p;if(n.avoidanceTimer-=e.dt(),n.stuckTimer>=n.stuckThreshold||n.avoidanceTimer<=0){const P=e.vec2(-b.y,b.x),O=e.vec2(b.y,-b.x),I=[P.scale(y),O.scale(y),e.vec2(P.x*.7+b.x*.3,P.y*.7+b.y*.3).unit().scale(y),e.vec2(O.x*.7+b.x*.3,O.y*.7+b.y*.3).unit().scale(y),e.vec2(P.x*.5+b.x*.5,P.y*.5+b.y*.5).unit().scale(y),e.vec2(O.x*.5+b.x*.5,O.y*.5+b.y*.5).unit().scale(y)];for(const R of I){const N=n.pos.x+R.x,Y=n.pos.y+R.y;if(q(N,Y))return n.avoidanceDirection=e.vec2(R.x,R.y).unit(),n.avoidanceTimer=.8,R}if(n.avoidanceDirection){const R=n.avoidanceDirection.scale(y),N=n.pos.x+R.x,Y=n.pos.y+R.y;if(q(N,Y))return R}return q(v,n.pos.y)?e.vec2(p.x,0):q(n.pos.x,D)?e.vec2(0,p.y):e.vec2(0,0)}else if(n.avoidanceDirection){const P=n.avoidanceDirection.scale(y),O=n.pos.x+P.x,I=n.pos.y+P.y;if(q(O,I))return P;n.avoidanceDirection=null,n.avoidanceTimer=0}return q(v,n.pos.y)?e.vec2(p.x,0):q(n.pos.x,D)?e.vec2(0,p.y):e.vec2(0,0)};return n.onUpdate(()=>{if(e.paused)return;if(n.shieldRegenRate>0&&n.shieldHealth<n.maxShieldHealth&&n.hp()>0&&!n.isDead&&(n.shieldRegenCooldown>0&&(n.shieldRegenCooldown-=e.dt()),n.shieldRegenCooldown<=0)){n.shieldRegenTimer+=e.dt();const I=1;if(n.shieldRegenTimer>=I){const R=n.shieldRegenRate*I;n.shieldHealth=Math.min(n.maxShieldHealth,n.shieldHealth+R),n.shieldRegenTimer=0,n.shieldHealth>0&&n.updateVisual()}}n.burnDuration>0&&n.hp()>0&&!n.isDead&&(n.burnTimer=(n.burnTimer||0)+e.dt(),n.burnTimer>=.5&&(n.takeDamage?n.takeDamage(n.burnDamage):n.hurt(n.burnDamage),n.color=e.rgb(255,150,50),e.wait(.1,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor))}),n.burnTimer=0),n.burnDuration-=e.dt(),n.burnDuration<=0&&(n.burnDamage=0,n.burnTimer=0));const p=e.get("player")[0];if(!p||!p.exists())return;const y=e.vec2(p.pos.x-n.pos.x,p.pos.y-n.pos.y),b=y.len();if(n.behavior==="turret"){if(n.attackTimer+=e.dt(),b>0&&n.attackTimer>=1/n.fireRate){const I=y.unit(),R=kt(e,n.pos.x,n.pos.y,I,n.projectileSpeed,n.projectileDamage,0,0,!1);R.isEnemyProjectile=!0,R.color=e.rgb(...n.originalColor),n.attackTimer=0}return}if(n.behavior==="shoot"){n.attackTimer+=e.dt();const I=150;let R=e.vec2(0,0);if(b>I*1.2?R=y.unit().scale(n.speed*e.dt()):b<I*.8&&(R=y.unit().scale(-n.speed*e.dt())),b>0&&n.attackTimer>=1/n.fireRate){const N=y.unit(),Y=kt(e,n.pos.x,n.pos.y,N,n.projectileSpeed,n.projectileDamage,0,0,!1);Y.isEnemyProjectile=!0,Y.color=e.rgb(...n.originalColor),n.attackTimer=0}if(R.len()>0){const N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="charge"){if(n.chargeTimer+=e.dt(),n.isCharging)if(n.chargeDuration+=e.dt(),n.chargeDuration>=.8)n.isCharging=!1,n.chargeDuration=0,n.chargePauseTimer=0;else{const R=n.chargeDirection.scale(n.speed*e.dt()),N=U(R);N.len()<R.len()*.3?(n.isCharging=!1,n.chargePauseTimer=.1):(n.pos.x+=N.x,n.pos.y+=N.y)}else if(n.chargePauseTimer>0)n.chargePauseTimer+=e.dt(),n.chargePauseTimer>=1&&(n.chargePauseTimer=0,n.chargeTimer=0);else if(n.chargeTimer>=n.chargeCooldown)n.color=e.rgb(255,255,0),e.wait(.2,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor),b>0&&(n.isCharging=!0,n.chargeDirection=y.unit(),n.chargeDuration=0))}),n.chargeTimer=0;else{const R=y.unit().scale(n.speed*.5*e.dt()),N=U(R);N.len()<R.len()*.5&&n.isCharging&&(n.isCharging=!1,n.chargePauseTimer=.1),n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="erratic"){if(b>0){const I=y.unit(),R=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),Y=e.vec2(I.x+R.x,I.y+R.y).unit().scale(n.speed*e.dt()),j=U(Y);n.pos.x+=j.x,n.pos.y+=j.y}return}if(n.behavior==="shield"){if(b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="teleport"){if(n.teleportTimer+=e.dt(),n.teleportTimer>=n.teleportCooldown&&b>0){const I=y.unit(),R=e.vec2(n.pos.x+I.x*n.teleportRange,n.pos.y+I.y*n.teleportRange);q(R.x,R.y)&&(n.pos.x=R.x,n.pos.y=R.y,n.teleportTimer=0,n.color=e.rgb(255,255,255),e.wait(.1,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor))}))}else if(b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="spawner"){if(n.spawnTimer+=e.dt(),n.spawnTimer>=n.spawnInterval){const I=Math.random()*Math.PI*2,R=30,N=n.pos.x+Math.cos(I)*R,Y=n.pos.y+Math.sin(I)*R;if(q(N,Y)){const j=vo(e,N,Y,n.spawnType||"rusher",n.floor);j.isBossMinion=!0,n.spawnTimer=0}}if(b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="buffer"){if(n.attackTimer+=e.dt(),n.attackTimer>=1){const I=e.get("enemy");for(const R of I){if(!R.exists()||R===n)continue;e.vec2(R.pos.x-n.pos.x,R.pos.y-n.pos.y).len()<=n.buffRadius?(R.buffed||(R.buffed=!0,R.originalSpeed=R.speed,R.originalDamage=R.damage||10),R.speed=R.originalSpeed*(1+n.buffAmount),R.damage=R.originalDamage*(1+n.buffAmount),n.buffedEnemies.add(R)):n.buffedEnemies.has(R)&&(R.buffed&&(R.speed=R.originalSpeed,R.damage=R.originalDamage,R.buffed=!1),n.buffedEnemies.delete(R))}n.attackTimer=0}if(b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="healer"){if(n.healTimer+=e.dt(),n.healTimer>=n.healInterval){const I=e.get("enemy");for(const R of I){if(!R.exists()||R===n)continue;if(e.vec2(R.pos.x-n.pos.x,R.pos.y-n.pos.y).len()<=n.healRadius){const j=R.hp(),k=R.maxHealth;if(j<k){const G=Math.min(k,j+n.healAmount);R.setHP(G);const Q=e.add([e.text("+",{size:16}),e.pos(R.pos.x,R.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{Q.exists()&&e.destroy(Q)})}}}n.healTimer=0}if(b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="teleportPlayer"){if(n.teleportTimer+=e.dt(),n.teleportTimer>=n.teleportCooldown&&b<=80){const I=Math.random()*Math.PI*2,R=p.pos.x+Math.cos(I)*n.teleportRange,N=p.pos.y+Math.sin(I)*n.teleportRange,Y=Math.max(50,Math.min(e.width()-50,R)),j=Math.max(50,Math.min(e.height()-50,N));p.pos.x=Y,p.pos.y=j,n.teleportTimer=0;const k=e.add([e.text("!",{size:24}),e.pos(p.pos.x,p.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{k.exists()&&e.destroy(k)})}if(b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="freeze"){if(b<=n.slowRadius?(p.slowed||(p.slowed=!0,p.originalSpeed=p.speed),p.speed=p.originalSpeed*(1-n.slowAmount)):p.slowed&&(p.speed=p.originalSpeed,p.slowed=!1),b>0){const R=y.unit().scale(n.speed*e.dt()),N=U(R);n.pos.x+=N.x,n.pos.y+=N.y}return}if(n.behavior==="rush"&&b>0){let I;if(n.pathfindingMode==="smart")I=zp(e,n,p.pos.x,p.pos.y);else{const N=y.unit().scale(n.speed*e.dt());I=U(N).unit()}n.pos.x+=I.x*n.speed*e.dt(),n.pos.y+=I.y*n.speed*e.dt()}if(n.behavior==="perimeter"){const I=Hp(e,n);n.pos.x+=I.x*n.speed*e.dt(),n.pos.y+=I.y*n.speed*e.dt()}const v=e.width(),D=e.height(),P=20,O=n.size||12;n.pos.x=e.clamp(n.pos.x,P+O,v-P-O),n.pos.y=e.clamp(n.pos.y,P+O,D-P-O)}),n.isDead=!1,n.onDeath(()=>{if(n.behavior==="buffer"&&n.buffedEnemies)for(const p of n.buffedEnemies)p.exists()&&p.buffed&&(p.speed=p.originalSpeed,p.damage=p.originalDamage,p.buffed=!1)}),n.onDeath(()=>{if(n.splits&&n.hp()<=0)for(let y=0;y<2;y++){const b=Math.PI*2/2*y,v=20,D=n.pos.x+Math.cos(b)*v,P=n.pos.y+Math.sin(b)*v,O=vo(e,D,P,"slime",n.floor);O.maxHealth=Math.floor(O.maxHealth/2),O.setHP(O.maxHealth),O.size=Math.floor(O.size*.8),O.splits=!1}if(n.explodes&&n.hp()<=0){const p=e.get("player")[0];if(p&&p.exists()&&e.vec2(p.pos.x-n.pos.x,p.pos.y-n.pos.y).len()<=n.explosionRadius&&!p.invulnerable){const D=Math.max(1,n.explosionDamage-(p.defense||0));p.hurt(D),p.invulnerable=!0,p.invulnerableTime=p.invulnerableDuration,p.color=e.rgb(255,100,100)}const y=e.add([e.text("*",{size:24}),e.pos(n.pos.x,n.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{y.exists()&&e.destroy(y)})}}),ro()&&Rs()&&(Dp(n,{type:s,floor:i}),n.enemyType=s),n}const da={gatekeeper:{coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function Np(e){return da[e]||da.gatekeeper}function on(e,t,o,s="gatekeeper",i=1){const a=Np(s),l=1+(i-1)*.2,c={coreChar:a.coreChar,armorChar:a.armorChar||"()",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*l),armorHealth:Math.floor((a.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*l),shieldHealth:Math.floor((a.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*l),speed:Math.floor(a.baseSpeed*(1+(i-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*l),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*l};function r(){const d=c.armorHealth>c.maxArmorHealth*.5?"(":"",u=c.armorHealth>0?")":"";return`${d}${c.coreChar}${u}`}const n=e.add([e.text(r(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"boss"]);return n.maxHealth=c.health,n.speed=c.speed,n.xpValue=c.xpValue,n.type=s,n.floor=i,n.textSize=c.size,a.meleeDamage&&(n.meleeDamage=a.meleeDamage),a.projectileDamage&&(n.projectileDamage=a.projectileDamage),a.projectileSpeed&&(n.projectileSpeed=a.projectileSpeed),a.fireRate&&(n.fireRate=a.fireRate),(s==="twinGuardianMelee"||s==="twinGuardianRanged")&&(n.enraged=!1),n.armorHealth=c.armorHealth,n.maxArmorHealth=c.maxArmorHealth,n.damageReduction=c.damageReduction,n.coreChar=c.coreChar,n.armorChar=c.armorChar,n.armorColor=c.armorColor,n.shieldHealth=c.shieldHealth,n.maxShieldHealth=c.maxShieldHealth,n.shieldRegenRate=c.shieldRegenRate,n.shieldChar=c.shieldChar,n.shieldColor=c.shieldColor,n.shieldRegenTimer=0,n.shieldRegenCooldown=0,n.lastDamageTime=0,n.updateVisual=function(){let d="",u="",h="",x="";if(n.shieldHealth>0){const A=n.shieldHealth/n.maxShieldHealth;A>.66?(d="",u=""):A>.33?(d="",u=""):(d="",u="")}if(n.armorHealth>0){const A=n.armorHealth/n.maxArmorHealth;A>.66?(h="",x=""):A>.33?(h="",x=""):(h="",x="")}const f=`${d}${h}${n.coreChar}${x}${u}`;n.text=f,n.shieldHealth>0?n.color=e.rgb(...c.shieldColor):n.color=e.rgb(...c.color)},n.takeDamage=function(d){let u=!1,h=!1;const x=n.shieldHealth,f=n.armorHealth;n.lastDamageTime=e.time();const A=3;if(n.shieldRegenCooldown=A,n.shieldHealth>0){const g=Math.min(d,n.shieldHealth);n.shieldHealth=Math.max(0,n.shieldHealth-g),u=n.shieldHealth!==x;const w=d-g;w>0&&n.takeDamageInternal(w)}else n.takeDamageInternal(d);h=n.armorHealth!==f,(u||h)&&n.updateVisual()},n.takeDamageInternal=function(d){if(n.armorHealth>0){const u=Math.floor(d*(1-n.damageReduction)),h=Math.min(u,n.armorHealth);n.armorHealth=Math.max(0,n.armorHealth-h);const x=d-u;if(x>0){const f=n.armorHealth>0?1-n.damageReduction:1,A=Math.floor(x*f);n.hurt(A)}}else n.hurt(d)},n.attackTimer=0,n.minionSpawnTimer=0,n.chargeCooldownTimer=0,n.chargeDurationTimer=0,n.radialBurstTimer=0,n.isCharging=!1,n.chargeDirection=null,n.chargeSpeed=0,n.spawnedMinions=[],n.enraged=!1,n.twinPartner=null,n.getPhase=function(){const d=n.hp()/n.maxHealth;return d>.75?1:d>.5?2:3},n.spawnMinions=function(){if(!n.exists())return;const d=n.getPhase(),u=d===1?2:3;for(let h=0;h<u;h++){const x=Math.PI*2/u*h+Math.random()*.5,f=40+Math.random()*20,A=n.pos.x+Math.cos(x)*f,g=n.pos.y+Math.sin(x)*f,w=Math.random()<.5?"rusher":"basic",E=vo(e,A,g,w,i);E.isBossMinion=!0,n.spawnedMinions.push(E)}},n.radialBurst=function(){if(!n.exists())return;const d=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];n.getPhase();const u=200,h=12;d.forEach(x=>{const f=kt(e,n.pos.x,n.pos.y,x,u,h,0,0,!1);f.isBossProjectile=!0,f.color=e.rgb(255,100,100)})},n.startCharge=function(d){if(!n.exists())return;n.isCharging=!0;const u=e.vec2(d.x-n.pos.x,d.y-n.pos.y);if(u.len()>0&&(n.chargeDirection=u.unit(),!n.chargeSpeed||n.chargeSpeed===0)){const h=n.getPhase?n.getPhase():1;n.chargeSpeed=n.speed*(h===1?2.5:h===2?3:3.5)}},n.onUpdate(()=>{if(e.paused)return;if(n.shieldRegenRate>0&&n.shieldHealth<n.maxShieldHealth&&n.hp()>0&&!n.isDead&&(n.shieldRegenCooldown>0&&(n.shieldRegenCooldown-=e.dt()),n.shieldRegenCooldown<=0)){n.shieldRegenTimer+=e.dt();const g=1;if(n.shieldRegenTimer>=g){const w=n.shieldRegenRate*g;n.shieldHealth=Math.min(n.maxShieldHealth,n.shieldHealth+w),n.shieldRegenTimer=0,n.shieldHealth>0&&n.updateVisual()}}n.burnDuration>0&&n.hp()>0&&!n.isDead&&(n.burnTimer=(n.burnTimer||0)+e.dt(),n.burnTimer>=.5&&(n.takeDamage?n.takeDamage(n.burnDamage):n.hurt(n.burnDamage),n.color,n.color=e.rgb(255,150,50),e.wait(.1,()=>{n.exists()&&n.updateVisual()}),n.burnTimer=0),n.burnDuration-=e.dt(),n.burnDuration<=0&&(n.burnDamage=0,n.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const u=n.getPhase();if(n.type==="gatekeeper"){n.attackTimer+=e.dt(),n.minionSpawnTimer+=e.dt(),n.radialBurstTimer+=e.dt();const g=u===1?8:u===2?6:5,w=10,E=u===1?8:u===2?6:5;if(n.isCharging){const T=n.chargeDirection.scale(n.chargeSpeed*e.dt());n.pos.x+=T.x,n.pos.y+=T.y,n.chargeDurationTimer+=e.dt(),n.chargeDurationTimer>=1&&(n.isCharging=!1,n.chargeDurationTimer=0,n.chargeCooldownTimer=0)}else{n.chargeCooldownTimer+=e.dt();const T=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y);if(T.len()>0){const U=T.unit(),p=n.speed*(u===1?1:u===2?1.2:1.5),y=U.scale(p*e.dt()),b=n.pos.x+y.x,v=n.pos.y+y.y;let D=!0,P=!0;const O=e.get("obstacle"),I=n.size||14;for(const R of O){if(!R.exists())continue;const N=R.pos.x-R.width/2,Y=R.pos.x+R.width/2,j=R.pos.y-R.height/2,k=R.pos.y+R.height/2,G=b-I,Q=b+I,pe=n.pos.y-I,ee=n.pos.y+I;Q>N&&G<Y&&ee>j&&pe<k&&(D=!1,n.isCharging&&(n.isCharging=!1,n.chargeTimer=0));const De=n.pos.x-I,ye=n.pos.x+I,Se=v-I,Ae=v+I;ye>N&&De<Y&&Ae>j&&Se<k&&(P=!1,n.isCharging&&(n.isCharging=!1,n.chargeTimer=0))}D&&(n.pos.x=b),P&&(n.pos.y=v)}n.minionSpawnTimer>=g&&(n.spawnMinions(),n.minionSpawnTimer=0),n.chargeCooldownTimer>=w&&(n.color=e.rgb(255,255,0),e.wait(.3,()=>{n.exists()&&(n.color=e.rgb(...c.color),n.startCharge(d.pos))}),n.chargeCooldownTimer=0),n.radialBurstTimer>=E&&(n.radialBurst(),n.radialBurstTimer=0)}}else if(n.type==="twinGuardianMelee"){n.attackTimer+=e.dt(),n.chargeCooldownTimer+=e.dt();const g=8,w=150,E=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y),T=E.len();if(n.isCharging){const q=n.chargeDirection.scale(n.chargeSpeed*e.dt());n.pos.x+=q.x,n.pos.y+=q.y,n.chargeDurationTimer+=e.dt(),n.chargeDurationTimer>=1.2&&(n.isCharging=!1,n.chargeDurationTimer=0,n.chargeCooldownTimer=0)}else{if(T>0){const q=E.unit(),U=n.speed*(n.enraged?1.5:1),p=q.scale(U*e.dt()),y=n.pos.x+p.x,b=n.pos.y+p.y;let v=!0,D=!0;const P=e.get("obstacle"),O=n.size||14;for(const I of P){if(!I.exists())continue;const R=I.pos.x-I.width/2,N=I.pos.x+I.width/2,Y=I.pos.y-I.height/2,j=I.pos.y+I.height/2,k=y-O,G=y+O,Q=n.pos.y-O,pe=n.pos.y+O;G>R&&k<N&&pe>Y&&Q<j&&(v=!1);const ee=n.pos.x-O,De=n.pos.x+O,ye=b-O,Se=b+O;De>R&&ee<N&&Se>Y&&ye<j&&(D=!1)}v&&(n.pos.x=y),D&&(n.pos.y=b)}n.chargeCooldownTimer>=g&&T<w&&(n.color=e.rgb(255,255,0),e.wait(.3,()=>{if(n.exists()){n.color=e.rgb(...c.color);const q=n.enraged?3.5:2.5;n.chargeSpeed=n.speed*q,n.startCharge(d.pos)}}),n.chargeCooldownTimer=0)}}else if(n.type==="twinGuardianRanged"){n.attackTimer+=e.dt();const g=200,w=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y),E=w.len();if(E>0){const q=w.unit();let U=n.speed*(n.enraged?1.5:1);if(E<g){const p=q.scale(-U*e.dt()),y=n.pos.x+p.x,b=n.pos.y+p.y;let v=!0,D=!0;const P=e.get("obstacle"),O=n.size||14;for(const I of P){if(!I.exists())continue;const R=I.pos.x-I.width/2,N=I.pos.x+I.width/2,Y=I.pos.y-I.height/2,j=I.pos.y+I.height/2,k=y-O,G=y+O,Q=n.pos.y-O,pe=n.pos.y+O;G>R&&k<N&&pe>Y&&Q<j&&(v=!1);const ee=n.pos.x-O,De=n.pos.x+O,ye=b-O,Se=b+O;De>R&&ee<N&&Se>Y&&ye<j&&(D=!1)}v&&(n.pos.x=y),D&&(n.pos.y=b)}else if(E>g*1.5){const p=q.scale(U*e.dt()),y=n.pos.x+p.x,b=n.pos.y+p.y;let v=!0,D=!0;const P=e.get("obstacle"),O=n.size||14;for(const I of P){if(!I.exists())continue;const R=I.pos.x-I.width/2,N=I.pos.x+I.width/2,Y=I.pos.y-I.height/2,j=I.pos.y+I.height/2,k=y-O,G=y+O,Q=n.pos.y-O,pe=n.pos.y+O;G>R&&k<N&&pe>Y&&Q<j&&(v=!1);const ee=n.pos.x-O,De=n.pos.x+O,ye=b-O,Se=b+O;De>R&&ee<N&&Se>Y&&ye<j&&(D=!1)}v&&(n.pos.x=y),D&&(n.pos.y=b)}}const T=1/(n.fireRate*(n.enraged?1.5:1));if(n.attackTimer>=T){if(E>0){const q=w.unit(),U=kt(e,n.pos.x,n.pos.y,q,n.projectileSpeed,n.projectileDamage*(n.enraged?1.25:1),0,0,!1);U.isBossProjectile=!0,U.color=e.rgb(100,150,255)}n.attackTimer=0}}else if(n.type==="swarmQueen"){n.minionSpawnTimer+=e.dt();const g=n.hp()/n.maxHealth;let w;g>.66?w=5:g>.33?w=3:w=2;const E=n.spawnedMinions.filter(P=>P.exists()&&P.hp()>0);if(n.minionSpawnTimer>=w&&E.length<8){const P=Math.random()<.5?"fast":"basic",O=Math.random()*Math.PI*2,I=50+Math.random()*30,R=n.pos.x+Math.cos(O)*I,N=n.pos.y+Math.sin(O)*I,Y=vo(e,R,N,P,i);Y.isBossMinion=!0,n.spawnedMinions.push(Y),n.spawnedMinions=n.spawnedMinions.filter(j=>j.exists()),n.minionSpawnTimer=0}const q=e.width()/2,U=e.height()/2,p=150,y=e.vec2(q-n.pos.x,U-n.pos.y),b=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y),v=b.len();let D=e.vec2(0,0);if(y.len()>30&&(D=D.add(y.unit().scale(.5))),v<p&&(D=D.add(b.unit().scale(-1))),D.len()>0){const O=D.unit().scale(n.speed*e.dt()),I=n.pos.x+O.x,R=n.pos.y+O.y;let N=!0,Y=!0;const j=e.get("obstacle"),k=n.size||14;for(const G of j){if(!G.exists())continue;const Q=G.pos.x-G.width/2,pe=G.pos.x+G.width/2,ee=G.pos.y-G.height/2,De=G.pos.y+G.height/2,ye=I-k,Se=I+k,Ae=n.pos.y-k,Ce=n.pos.y+k;Se>Q&&ye<pe&&Ce>ee&&Ae<De&&(N=!1);const Pe=n.pos.x-k,se=n.pos.x+k,V=R-k,K=R+k;se>Q&&Pe<pe&&K>ee&&V<De&&(Y=!1)}N&&(n.pos.x=I),Y&&(n.pos.y=R)}}else{const g=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y);if(g.len()>0){const T=g.unit().scale(n.speed*e.dt()),q=n.pos.x+T.x,U=n.pos.y+T.y;let p=!0,y=!0;const b=e.get("obstacle"),v=n.size||14;for(const D of b){if(!D.exists())continue;const P=D.pos.x-D.width/2,O=D.pos.x+D.width/2,I=D.pos.y-D.height/2,R=D.pos.y+D.height/2,N=q-v,Y=q+v,j=n.pos.y-v,k=n.pos.y+v;Y>P&&N<O&&k>I&&j<R&&(p=!1);const G=n.pos.x-v,Q=n.pos.x+v,pe=U-v,ee=U+v;Q>P&&G<O&&ee>I&&pe<R&&(y=!1)}p&&(n.pos.x=q),y&&(n.pos.y=U)}}const h=e.width(),x=e.height(),f=20,A=n.size||14;n.pos.x=e.clamp(n.pos.x,f+A,h-f-A),n.pos.y=e.clamp(n.pos.y,f+A,x-f-A)}),n.isDead=!1,s==="swarmQueen"&&n.onDeath(()=>{const d=8+Math.floor(Math.random()*5);for(let u=0;u<d;u++){const h=Math.PI*2/d*u+Math.random()*.3,x=40+Math.random()*20,f=n.pos.x+Math.cos(h)*x,A=n.pos.y+Math.sin(h)*x,g=Math.random()<.5?"fast":"basic",w=vo(e,f,A,g,i);w.isBossMinion=!0}}),n.updateVisual(),n}function Up(e,t,o,s=1){const i=on(e,t.pos.x,t.pos.y,"twinGuardianMelee",s),a=on(e,o.pos.x,o.pos.y,"twinGuardianRanged",s);return i.twinPartner=a,a.twinPartner=i,i.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enraged=!0,a.speed=Math.floor(a.speed*1.5),a.fireRate=a.fireRate*1.5,a.projectileDamage=Math.floor(a.projectileDamage*1.25),a.color=e.rgb(255,200,0))}),a.onDeath(()=>{i&&i.exists()&&!i.enraged&&(i.enraged=!0,i.speed=Math.floor(i.speed*1.5),i.chargeCooldownTimer=0,i.meleeDamage=Math.floor(i.meleeDamage*1.25),i.color=e.rgb(255,200,0))}),[i,a]}const ua={brute:{coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function qp(e){return ua[e]||ua.brute}function _p(e,t,o,s="brute",i=1){const a=qp(s),l=1+(i-1)*.2,c={coreChar:a.coreChar,armorChar:a.armorChar||"[]",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*l),armorHealth:Math.floor((a.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*l),shieldHealth:Math.floor((a.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*l),speed:Math.floor(a.baseSpeed*(1+(i-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*l),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*l},r=e.add([e.text(c.coreChar,{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"miniboss"]);return r.maxHealth=c.health,r.speed=c.speed,r.xpValue=c.xpValue,r.type=s,r.floor=i,a.meleeDamage&&(r.meleeDamage=a.meleeDamage),a.projectileDamage&&(r.projectileDamage=a.projectileDamage),a.projectileSpeed&&(r.projectileSpeed=a.projectileSpeed),a.fireRate&&(r.fireRate=a.fireRate),r.armorHealth=c.armorHealth,r.maxArmorHealth=c.maxArmorHealth,r.damageReduction=c.damageReduction,r.coreChar=c.coreChar,r.armorChar=c.armorChar,r.armorColor=c.armorColor,r.shieldHealth=c.shieldHealth,r.maxShieldHealth=c.maxShieldHealth,r.shieldRegenRate=c.shieldRegenRate,r.shieldChar=c.shieldChar,r.shieldColor=c.shieldColor,r.shieldRegenTimer=0,r.shieldRegenCooldown=0,r.lastDamageTime=0,r.attackTimer=0,r.chargeCooldownTimer=0,r.chargeDurationTimer=0,r.isCharging=!1,r.chargeDirection=null,r.chargeSpeed=0,r.updateVisual=function(){let n="",d="",u="",h="";if(r.shieldHealth>0){const f=r.shieldHealth/r.maxShieldHealth;f>.66?(n="",d=""):f>.33?(n="",d=""):(n="",d="")}if(r.armorHealth>0){const f=r.armorHealth/r.maxArmorHealth;f>.66?(u="",h=""):f>.33?(u="",h=""):(u="",h="")}const x=`${n}${u}${r.coreChar}${h}${d}`;r.text=x,r.shieldHealth>0?r.color=e.rgb(...c.shieldColor):r.color=e.rgb(...c.color)},r.takeDamage=function(n){let d=!1,u=!1;const h=r.shieldHealth,x=r.armorHealth;r.lastDamageTime=e.time();const f=3;if(r.shieldRegenCooldown=f,r.shieldHealth>0){const A=Math.min(n,r.shieldHealth);r.shieldHealth=Math.max(0,r.shieldHealth-A),d=r.shieldHealth!==h;const g=n-A;g>0&&r.takeDamageInternal(g)}else r.takeDamageInternal(n);u=r.armorHealth!==x,(d||u)&&r.updateVisual()},r.takeDamageInternal=function(n){if(r.armorHealth>0){const d=Math.floor(n*(1-r.damageReduction)),u=Math.min(d,r.armorHealth);r.armorHealth=Math.max(0,r.armorHealth-u);const h=n-d;if(h>0){const x=r.armorHealth>0?1-r.damageReduction:1,f=Math.floor(h*x);r.hurt(f)}}else r.hurt(n)},r.startCharge=function(n){if(!r.exists())return;r.isCharging=!0;const d=e.vec2(n.x-r.pos.x,n.y-r.pos.y);d.len()>0&&(r.chargeDirection=d.unit(),r.chargeSpeed=r.speed*2.5)},r.onUpdate(()=>{if(e.paused)return;if(r.shieldRegenRate>0&&r.shieldHealth<r.maxShieldHealth&&r.hp()>0&&!r.isDead&&(r.shieldRegenCooldown>0&&(r.shieldRegenCooldown-=e.dt()),r.shieldRegenCooldown<=0)){r.shieldRegenTimer+=e.dt();const g=1;if(r.shieldRegenTimer>=g){const w=r.shieldRegenRate*g;r.shieldHealth=Math.min(r.maxShieldHealth,r.shieldHealth+w),r.shieldRegenTimer=0,r.shieldHealth>0&&r.updateVisual()}}r.burnDuration>0&&r.hp()>0&&!r.isDead&&(r.burnTimer=(r.burnTimer||0)+e.dt(),r.burnTimer>=.5&&(r.takeDamage?r.takeDamage(r.burnDamage):r.hurt(r.burnDamage),r.color,r.color=e.rgb(255,150,50),e.wait(.1,()=>{r.exists()&&r.updateVisual()}),r.burnTimer=0),r.burnDuration-=e.dt(),r.burnDuration<=0&&(r.burnDamage=0,r.burnTimer=0));const n=e.get("player")[0];if(!n||!n.exists())return;const d=e.vec2(n.pos.x-r.pos.x,n.pos.y-r.pos.y),u=d.len();if(a.behavior==="charge"){r.attackTimer+=e.dt(),r.chargeCooldownTimer+=e.dt();const g=6,w=200;if(r.isCharging){const E=r.chargeDirection.scale(r.chargeSpeed*e.dt());r.pos.x+=E.x,r.pos.y+=E.y,r.chargeDurationTimer+=e.dt(),r.chargeDurationTimer>=1&&(r.isCharging=!1,r.chargeDurationTimer=0,r.chargeCooldownTimer=0)}else{if(u>0){const T=d.unit().scale(r.speed*e.dt());r.pos.x+=T.x,r.pos.y+=T.y}r.chargeCooldownTimer>=g&&u<w&&(r.color=e.rgb(255,255,0),e.wait(.3,()=>{r.exists()&&(r.color=e.rgb(...c.color),r.startCharge(n.pos))}),r.chargeCooldownTimer=0)}}else if(a.behavior==="shoot"){r.attackTimer+=e.dt();const g=180;if(u>0){const E=d.unit();let T=r.speed;if(u<g){const q=E.scale(-T*e.dt());r.pos.x+=q.x,r.pos.y+=q.y}else if(u>g*1.5){const q=E.scale(T*e.dt());r.pos.x+=q.x,r.pos.y+=q.y}}const w=1/r.fireRate;if(r.attackTimer>=w){if(u>0){const E=d.unit(),T=kt(e,r.pos.x,r.pos.y,E,r.projectileSpeed,r.projectileDamage,0,0,!1);T.isBossProjectile=!0,T.color=e.rgb(...c.color)}r.attackTimer=0}}else if(a.behavior==="rush"&&u>0){const w=d.unit().scale(r.speed*e.dt());r.pos.x+=w.x,r.pos.y+=w.y}const h=e.width(),x=e.height(),f=20,A=r.size||24;r.pos.x=e.clamp(r.pos.x,f+A,h-f-A),r.pos.y=e.clamp(r.pos.y,f+A,x-f-A)}),r.isDead=!1,r.updateVisual(),r}function Fp(e,t,o,s){const i=e.add([e.rect(40,40),e.pos(t,o),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return i.direction=s,i.open=!1,i.isSpawnDoor=!1,i.blocked=!1,i.gridDirection=null,i.parts=[],i.updateVisual=()=>{i.parts.forEach(l=>{l.exists()&&e.destroy(l)}),i.parts=[];let a;if(i.blocked?a=e.rgb(80,80,80):i.open?a=e.rgb(100,255,100):i.isSpawnDoor?a=e.rgb(200,50,50):a=e.rgb(200,200,100),s==="north"||s==="south"){const l=i.blocked?"":i.open?"":"",c=e.add([e.text(l,{size:24}),e.pos(t,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(c);const r=e.add([e.text(i.open?"":"",{size:20}),e.pos(t-35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(r);const n=e.add([e.text(i.open?"":"",{size:20}),e.pos(t+35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(n)}else{const l=i.blocked?["","",""]:i.open?["","",""]:["","",""],c=16;for(let d=0;d<l.length;d++){const u=(d-1)*c,h=e.add([e.text(l[d],{size:24}),e.pos(t,o+u),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(h)}const r=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,o-c*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(r);const n=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,o+c*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(n)}if(i.blocked){const l=e.add([e.text("X",{size:28}),e.pos(t,o),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);i.parts.push(l)}},Object.defineProperty(i,"color",{get:()=>i._color,set:a=>{i._color=a,i.parts.forEach(l=>{l.exists()&&(l.color=a)})}}),Object.defineProperty(i,"text",{get:()=>i._text||"=",set:a=>{i._text=a}}),i.onDestroy(()=>{i.parts.forEach(a=>{a.exists()&&e.destroy(a)}),i.parts=[]}),i.updateVisual(),i}function Yp(e,t,o,s,i,a="wall",l="#",c=null){const r=a==="wall",n=r?e.rgb(100,100,100):e.rgb(140,140,140),d=r?e.rgb(80,80,80):e.rgb(120,120,120),u=e.add([e.rect(s,i),e.pos(t,o),e.anchor("center"),e.color(c||n),e.outline(2,c||d),e.area({width:s,height:i}),e.fixed(),"obstacle",a==="wall"?"wall":"cover"]);return u.type=a,u.width=s,u.height=i,u}let ms=null,ol=.3;function sl(){return ms||(ms=new(window.AudioContext||window.webkitAudioContext)),ms}function Tn(){return ms||sl(),ms}function xe(e,t,o="square",s=.3,i={}){const a=Tn(),l=a.currentTime,c=a.createOscillator();c.type=o,c.frequency.setValueAtTime(e,l),i.pitchBend&&c.frequency.exponentialRampToValueAtTime(e*i.pitchBend,l+t);const r=a.createGain(),n=s*ol,d=i.attack||.01;r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(n,l+d);const u=i.decay||.1;r.gain.setValueAtTime(n,l+t-u),r.gain.exponentialRampToValueAtTime(.01,l+t),c.connect(r),r.connect(a.destination),c.start(l),c.stop(l+t)}function co(e,t=.3,o={}){const s=Tn(),i=s.currentTime,a=s.sampleRate*e,l=s.createBuffer(1,a,s.sampleRate),c=l.getChannelData(0);for(let f=0;f<a;f++)c[f]=Math.random()*2-1;const r=s.createBufferSource();r.buffer=l;const n=s.createBiquadFilter();n.type=o.filterType||"lowpass",n.frequency.setValueAtTime(o.filterFreq||2e3,i);const d=s.createGain(),u=t*ol,h=o.attack||.01,x=o.decay||.1;d.gain.setValueAtTime(0,i),d.gain.linearRampToValueAtTime(u,i+h),d.gain.setValueAtTime(u,i+e-x),d.gain.exponentialRampToValueAtTime(.01,i+e),r.connect(n),n.connect(d),d.connect(s.destination),r.start(i),r.stop(i+e)}function he(e,t=.1){return e*(1+(Math.random()-.5)*t)}function il(){const e=Math.random();e<.33?xe(he(150,.2),.08,"square",.15,{attack:.001,decay:.05,pitchBend:.5}):e<.66?xe(he(180,.2),.09,"square",.15,{attack:.001,decay:.06,pitchBend:.6}):xe(he(200,.2),.07,"square",.15,{attack:.001,decay:.04,pitchBend:.4})}function Xp(){const e=Math.random();e<.33?xe(he(250,.3),.05,"square",.12,{attack:.001,decay:.03,pitchBend:.4}):e<.66?xe(he(280,.3),.04,"sawtooth",.12,{attack:.001,decay:.025,pitchBend:.5}):xe(he(230,.3),.06,"square",.12,{attack:.001,decay:.04,pitchBend:.3})}function Gp(){const e=he(80,.15);xe(e,.15,"sawtooth",.25,{attack:.001,decay:.1,pitchBend:.3}),co(he(.12,.2),he(.2,.3),{attack:.001,decay:.08,filterType:"lowpass",filterFreq:he(1500,.4)})}function Kp(){xe(he(400,.2),.06,"square",.2,{attack:.001,decay:.04,pitchBend:.2}),xe(he(60,.15),.12,"sine",.18,{attack:.001,decay:.08,pitchBend:.5})}function Vp(){co(.08,he(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:he(800,.5)})}function jp(){xe(he(70,.2),.2,"sawtooth",.22,{attack:.001,decay:.15,pitchBend:.4}),xe(he(120,.2),.15,"square",.18,{attack:.005,decay:.1,pitchBend:.5})}function Wp(){xe(he(300,.3),.12,"sawtooth",.18,{attack:.001,decay:.08,pitchBend:1.8}),co(he(.1,.3),.15,{attack:.001,decay:.06,filterType:"highpass",filterFreq:he(3e3,.4)})}function $p(){xe(he(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function Jp(){il()}function Qp(){const e=Math.random();e<.25?xe(he(120,.3),.08,"square",.16,{attack:.001,decay:.05,pitchBend:.5}):e<.5?xe(he(100,.3),.09,"sawtooth",.16,{attack:.001,decay:.06,pitchBend:.6}):e<.75?(xe(he(140,.3),.07,"square",.16,{attack:.001,decay:.04,pitchBend:.4}),co(.05,.1,{attack:.001,decay:.03,filterFreq:he(1200,.4)})):xe(he(160,.3),.06,"triangle",.16,{attack:.001,decay:.04,pitchBend:.3})}function Os(){const e=Math.random();e<.33?(xe(he(80,.2),.15,"sawtooth",.25,{attack:.001,decay:.1,pitchBend:.4}),co(.12,.2,{attack:.001,decay:.08,filterType:"lowpass",filterFreq:he(1e3,.3)})):e<.66?(xe(he(70,.2),.18,"square",.25,{attack:.001,decay:.12,pitchBend:.5}),xe(he(200,.3),.08,"triangle",.15,{attack:.005,decay:.05,pitchBend:.3})):(xe(he(90,.2),.16,"sawtooth",.25,{attack:.001,decay:.11,pitchBend:.6}),co(.1,.18,{attack:.001,decay:.07,filterType:"bandpass",filterFreq:he(800,.4)}))}function pa(){const e=Math.random();e<.33?xe(he(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(xe(he(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),co(.15,.12,{attack:.05,decay:.1,filterFreq:he(1500,.4)})):xe(he(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function nl(){xe(he(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),xe(he(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),co(he(.3,.2),he(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:he(1200,.5)})}function Zp(){const e=Math.random();e<.33?xe(he(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?xe(he(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):xe(he(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function fa(){const e=Math.random();e<.33?(xe(he(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{xe(he(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(xe(he(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),xe(he(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(xe(he(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{xe(he(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function kp(){Tn().currentTime;const t=400;[1,1.25,1.5,2].forEach((s,i)=>{setTimeout(()=>{xe(t*s,.15,"square",.2,{attack:.01,decay:.1})},i*80)})}function e0(){xe(he(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Yt(){xe(he(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function gt(){xe(he(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function t0(){xe(he(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{xe(he(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function ga(){xe(he(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{xe(he(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function o0(){for(let t=0;t<8;t++)setTimeout(()=>{xe(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{nl()},480)}function s0(){[400,500,600,800].forEach((t,o)=>{setTimeout(()=>{xe(t,.2,"square",.18,{attack:.01,decay:.15})},o*100)})}function Ri(){xe(he(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{xe(he(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function Ti(){xe(he(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),co(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:he(500,.3)})}function i0(){xe(he(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function ma(){xe(he(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function n0(e){const t=(e==null?void 0:e.toLowerCase())||"";t.includes("pistol")?il():t.includes("smg")||t.includes("submachine")?Xp():t.includes("shotgun")?Gp():t.includes("sniper")||t.includes("rifle")?Kp():t.includes("flame")||t.includes("thrower")?Vp():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?jp():t.includes("chain")||t.includes("lightning")?Wp():t.includes("orbital")?$p():Jp()}function Qs(e,t,o,s={}){const{char:i="*",size:a=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:r=0,lifetime:n=1,fadeStart:d=.3,friction:u=.95,zIndex:h=100}=s,x=e.add([e.text(i,{size:a}),e.pos(t,o),e.anchor("center"),e.color(...l),e.z(h),"particle"]);return x.velocity={x:c.x,y:c.y},x.gravity=r,x.friction=u,x.lifetime=n,x.fadeStart=d,x.age=0,x.initialOpacity=1,x}function a0(e){e.get("particle").forEach(o=>{if(!o.exists())return;if(o.age+=e.dt(),o.age>=o.lifetime){e.destroy(o);return}o.pos.x+=o.velocity.x*e.dt()*60,o.pos.y+=o.velocity.y*e.dt()*60,o.velocity.y+=o.gravity*e.dt()*60,o.velocity.x*=o.friction,o.velocity.y*=o.friction;const s=o.age/o.lifetime;if(s>=o.fadeStart){const i=(s-o.fadeStart)/(1-o.fadeStart);o.opacity=o.initialOpacity*(1-i)}})}function Do(e,t,o,s={}){const{count:i=8,color:a=[255,50,50],speed:l=2,isCrit:c=!1}=s,r=[".",",","'","`","*"],n=c?i*1.5:i,d=c?l*1.5:l,u=c?[255,200,0]:a;for(let h=0;h<n;h++){const x=Math.PI*2*h/n+(Math.random()-.5)*.5,f=.5+Math.random()*.5,A={x:Math.cos(x)*d*f,y:Math.sin(x)*d*f};Qs(e,t,o,{char:r[Math.floor(Math.random()*r.length)],size:8+Math.random()*6,color:u,velocity:A,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function Ls(e,t,o,s={}){const{count:i=12,color:a=[255,100,100],speed:l=3,isBoss:c=!1,isMiniboss:r=!1}=s,n=["*","+","x","X","#"],d=c?i*2:r?i*1.5:i,u=c?l*1.5:r?l*1.2:l;for(let x=0;x<d;x++){const f=Math.PI*2*x/d,A=.7+Math.random()*.6,g={x:Math.cos(f)*u*A,y:Math.sin(f)*u*A};Qs(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:12+Math.random()*8,color:a,velocity:g,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const h=Math.floor(d/2);for(let x=0;x<h;x++){const f=Math.random()*Math.PI*2,A=.3+Math.random()*.4,g={x:Math.cos(f)*u*A*.5,y:Math.sin(f)*u*A*.5};Qs(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:16+Math.random()*8,color:[255,200,100],velocity:g,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}function Di(e,t,o,s,i={}){const{count:a=5,color:l=[255,255,100],speed:c=2.5,isCrit:r=!1}=i,n=["","","",""],d=r?a*2:a,u=r?[255,200,0]:l,h=Math.sqrt(s.x*s.x+s.y*s.y),x=h>0?{x:s.x/h,y:s.y/h}:{x:1,y:0};for(let f=0;f<d;f++){const A=(Math.random()-.5)*Math.PI*.6,g=Math.atan2(x.y,x.x)+A,w=.6+Math.random()*.8,E={x:Math.cos(g)*c*w,y:Math.sin(g)*c*w};Qs(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:10+Math.random()*4,color:u,velocity:E,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function os(e,t,o,s){if(!t||!t.exists())return;const i=20,a=e.width()-i,l=e.height()-i,c=i,r=i,n=t.pos.x+o.x*s,d=t.pos.y+o.y*s,u=Math.max(c,Math.min(a,n)),h=Math.max(r,Math.min(l,d)),x=t.pos.x,f=t.pos.y;t.pos.x=u,t.pos.y=h;const A=e.get("wall"),g=e.get("obstacle"),w=[...A,...g];let E=!1;for(const T of w)if(T.exists()&&t.isColliding&&t.isColliding(T)){E=!0;break}E&&(t.pos.x=x,t.pos.y=f)}function r0(e,t){let o=0;t.weaponKey==="orbital"&&sn(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.weaponKey==="orbital"){l0(e,t);return}const s=e.mousePos(),i=e.time(),a=e.vec2(s.x-t.pos.x,s.y-t.pos.y);if(a.len()>0){const c=a.unit();if(i-o>=1/t.fireRate){const r=t.projectileCount||1,n=t.spreadAngle||0,d=[];if(r===1)d.push(c);else if(n>0){const u=r>1?n/(r-1):0,h=-n/2;for(let x=0;x<r;x++){const A=(h+u*x)*(Math.PI/180),g=Math.cos(A),w=Math.sin(A),E=e.vec2(c.x*g-c.y*w,c.x*w+c.y*g);d.push(E.unit())}}else for(let u=0;u<r;u++)d.push(c);d.forEach((u,h)=>{const x=n===0&&r>1?h*mt.MULTISHOT_STAGGER_DELAY:0;e.wait(x,()=>{const f=ep(t.critChance||0);let A=f?tp(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(A=Math.floor(A*t.piercingDamageBonus));const g=t.weaponRange||jo.DEFAULT_WEAPON_RANGE;if(n0(t.weaponKey),t.weaponKey==="flamethrower"){const w=kt(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.piercing||0,t.obstaclePiercing||0,f,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef);const E=Math.floor(A*.3),T=2,q=t.fireDotMultiplier||1;w.burnDamage=Math.floor(E*q),w.burnDuration=T}else if(t.weaponKey==="explosive"){const w=c0(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.explosionRadius,t.explosionDamage,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}else if(t.weaponKey==="chainLightning"){const w=h0(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.chainRange,t.maxJumps,t.chainDamageReduction,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}else{const w=kt(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.piercing||0,t.obstaclePiercing||0,f,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}})}),o=i,yp(t)}}}),e.onCollide("projectile","wall",(s,i)=>{e.paused||s.isExplosive||s.piercedObstacles&&s.piercedObstacles.has(i)||(s.obstaclePiercing>0?(s.piercedObstacles&&s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)):e.destroy(s))}),e.onCollide("projectile","cover",(s,i)=>{if(!e.paused&&s.obstaclePiercing>0&&s.piercedObstacles){if(s.piercedObstacles.has(i))return;s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)}}),e.onCollide("projectile","obstacle",(s,i)=>{e.paused||s.isExplosive||s.piercedObstacles&&s.piercedObstacles.has(i)||(s.obstaclePiercing>0?(s.piercedObstacles&&s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)):e.destroy(s))}),e.onCollide("projectile","enemy",(s,i)=>{if(e.paused||s.isEnemyProjectile||s.isBossProjectile||s.piercedEnemies&&s.piercedEnemies.has(i))return;Qp(),i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Do(e,i.pos.x,i.pos.y,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s);const a=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);if(a.len()>0){const c=a.unit(),r=mt.KNOCKBACK_ENEMY_FROM_PROJECTILE;os(e,i,c,r)}Di(e,i.pos.x,i.pos.y,a,{isCrit:s.isCrit}),i.color=s.isCrit?e.rgb(...mt.CRIT_COLOR):e.rgb(...mt.HIT_COLOR),e.wait(mt.HIT_FLASH_DURATION,()=>{i.exists()&&(i.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(s,i)=>{e.paused||s.isExplosive&&Ci(e,s,i.pos.x,i.pos.y)}),e.onCollide("projectile","boss",(s,i)=>{if(e.paused||!s.isChainLightning||s.chainedEnemies&&s.chainedEnemies.has(i))return;const a=s.chainJumps||0,l=1-(s.chainDamageReduction||.15)*a,c=Math.floor(s.damage*Math.max(.1,l));i.takeDamage?i.takeDamage(c):i.hurt(c),s.chainedEnemies&&s.chainedEnemies.add(i),e.wait(.01,()=>{s.exists()&&(s.chainJumps<s.maxJumps?xa(e,s,i):e.destroy(s))})}),e.onCollide("projectile","miniboss",(s,i)=>{if(e.paused||s.isEnemyProjectile||s.isBossProjectile||s.piercedEnemies&&s.piercedEnemies.has(i))return;let a=s.damage;s.isCrit&&(a=Math.floor(a*1.5)),i.takeDamage(a),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Do(e,i.pos.x,i.pos.y,{isCrit:s.isCrit});const l=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);Di(e,i.pos.x,i.pos.y,l,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s),i.color=s.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("projectile","boss",(s,i)=>{if(e.paused||s.isExplosive||s.isChainLightning||s.piercedEnemies&&s.piercedEnemies.has(i))return;i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Do(e,i.pos.x,i.pos.y,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s);const a=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);if(a.len()>0){const c=a.unit(),r=mt.KNOCKBACK_BOSS_FROM_PROJECTILE;os(e,i,c,r)}Di(e,i.pos.x,i.pos.y,a,{isCrit:s.isCrit}),i.color=s.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("enemy","player",(s,i)=>{if(e.paused||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Os();const a=s.damage||mt.BASE_ENEMY_DAMAGE,l=Mi(a,i.defense||0,i.damageReduction||0);if(i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Do(e,i.pos.x,i.pos.y,{color:[255,100,100]}),s.lifesteal&&s.exists()){const n=s.hp(),d=s.maxHealth;if(n<d){const u=Math.min(d,n+s.lifesteal);s.setHP(u)}}const c=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(c.len()>0){const n=c.unit(),d=mt.KNOCKBACK_ENEMY;os(e,s,n,d)}i.color=e.rgb(...mt.HIT_COLOR)}),e.onCollide("miniboss","player",(s,i)=>{if(e.paused||i.invulnerable)return;Os();let a=mt.BASE_MINIBOSS_DAMAGE;(s.type==="brute"||s.type==="berserker"||s.type==="guardian")&&s.meleeDamage&&(a=s.meleeDamage);const l=Mi(a,i.defense||0,0);i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Do(e,i.pos.x,i.pos.y,{color:[255,100,100]});const c=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(c.len()>0){const n=c.unit(),d=mt.KNOCKBACK_MINIBOSS;os(e,s,n,d)}i.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(s,i)=>{if(e.paused||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Os();let a=mt.BASE_BOSS_DAMAGE;if(s.type==="twinGuardianMelee"&&s.meleeDamage){const n=s.enraged?mt.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;a=s.meleeDamage*n}const l=Mi(a,i.defense||0,i.damageReduction||0);i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Do(e,i.pos.x,i.pos.y,{color:[255,100,100]});const c=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(c.len()>0){const n=c.unit(),d=mt.KNOCKBACK_BOSS;os(e,s,n,d)}i.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(s,i)=>{if(e.paused||!s.isBossProjectile&&!s.isEnemyProjectile||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Os();const a=s.damage*(1-(i.damageReduction||0)),l=Math.max(1,a-(i.defense||0));i.hurt(l),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Do(e,i.pos.x,i.pos.y,{color:[255,100,100]}),e.destroy(s),i.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(s,i)=>{e.paused||i.exists()&&(s.contactCooldown>0||(i.hurt(s.damage),s.contactCooldown=s.contactCooldownDuration||.2))}),e.onCollide("orbital","boss",(s,i)=>{e.paused||i.exists()&&(s.contactCooldown>0||(i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.contactCooldown=s.contactCooldownDuration||.2))}),e.onCollide("projectile","enemy",(s,i)=>{e.paused||s.isExplosive&&Ci(e,s,i.pos.x,i.pos.y)}),e.onCollide("projectile","wall",(s,i)=>{e.paused||s.isExplosive&&Ci(e,s,s.pos.x,s.pos.y)}),e.onCollide("projectile","enemy",(s,i)=>{if(e.paused||!s.isChainLightning||s.chainedEnemies&&s.chainedEnemies.has(i))return;const a=s.chainJumps||0,l=1-(s.chainDamageReduction||.15)*a,c=Math.floor(s.damage*Math.max(.1,l));i.takeDamage?i.takeDamage(c):i.hurt(c),s.chainedEnemies&&s.chainedEnemies.add(i),s.chainJumps<s.maxJumps?xa(e,s,i):e.destroy(s)})}function sn(e,t){var i,a;t.orbitalOrbs||(t.orbitalOrbs=[],t.orbitalAngles=[]);const o=t.projectileCount||1,s=t.orbitRadius||jo.BASE_ORBIT_RADIUS;for(let l=0;l<o;l++){const c=360/o*l,r=c*Math.PI/180,n=t.pos.x+Math.cos(r)*s,d=t.pos.y+Math.sin(r)*s,u=e.add([e.text(((i=t.weaponDef)==null?void 0:i.char)||"",{size:16}),e.pos(n,d),e.anchor("center"),e.color(...((a=t.weaponDef)==null?void 0:a.color)||[100,200,255]),e.area(),"orbital","playerProjectile"]);u.damage=t.projectileDamage||12,u.contactCooldown=0,u.contactCooldownDuration=jo.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(u),t.orbitalAngles.push(c)}}function l0(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(a=>{a.exists()&&a.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],sn(e,t),t.orbitalNeedsReinit=!1);const o=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==o)&&sn(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const s=t.rotationSpeed||jo.BASE_ROTATION_SPEED,i=t.orbitRadius||jo.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((a,l)=>{if(!a.exists())return;t.orbitalAngles[l]=(t.orbitalAngles[l]+s*e.dt())%360;const c=t.orbitalAngles[l]*Math.PI/180;a.pos.x=t.pos.x+Math.cos(c)*i,a.pos.y=t.pos.y+Math.sin(c)*i,a.contactCooldown>0&&(a.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(a=>a.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function c0(e,t,o,s,i,a,l,c,r){const n=kt(e,t,o,s,i,a,0,0,!1,r);return n.isExplosive=!0,n.explosionRadius=l||50,n.explosionDamage=c||15,n}function h0(e,t,o,s,i,a,l,c,r,n){const d=kt(e,t,o,s,i,a,0,0,!1,n);return d.isChainLightning=!0,d.chainRange=l||70,d.maxJumps=c||3,d.chainDamageReduction=r||.15,d.chainJumps=0,d.chainedEnemies=new Set,d}function Ci(e,t,o,s){if(!t.exists())return;nl();const i=t.explosionRadius||50,a=t.explosionDamage||15,l=e.get("enemy"),c=e.get("boss"),r=[...l,...c];for(const d of r){if(!d.exists())continue;e.vec2(d.pos.x-o,d.pos.y-s).len()<=i&&(d.takeDamage?d.takeDamage(a):d.hurt(a))}const n=e.add([e.text("*",{size:24}),e.pos(o,s),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{n.exists()&&e.destroy(n)}),e.destroy(t)}function xa(e,t,o){if(!t.exists())return;const s=t.chainRange||70,i=e.get("enemy"),a=e.get("boss"),l=[...i,...a];let c=null,r=s;for(const n of l){if(!n.exists()||n===o||t.chainedEnemies&&t.chainedEnemies.has(n))continue;const d=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y).len();d<=s&&d<r&&(c=n,r=d)}if(c){t.chainJumps=(t.chainJumps||0)+1;const n=e.add([e.line(o.pos,c.pos,2),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{n.exists()&&e.destroy(n)}),t.pos.x=c.pos.x,t.pos.y=c.pos.y}else e.destroy(t)}const ze={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10},Wo={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${ze.damage})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.damage)||0,o=e.baseProjectileDamage||((a=e.weaponDef)==null?void 0:a.baseDamage)||10,s=Math.pow(1.25,t);e.projectileDamage=Math.floor(o*s)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${ze.fireRate})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.fireRate)||0,o=e.baseFireRate||((a=e.weaponDef)==null?void 0:a.fireRate)||1.5,s=Math.pow(1.2,t);e.fireRate=o*s}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${ze.speed})`:""}`,apply:e=>{var i,a,l;const t=((i=e.upgradeStacks)==null?void 0:i.speed)||0,o=((l=(a=e.characterData)==null?void 0:a.stats)==null?void 0:l.speed)||150,s=Math.pow(1.15,t);e.speed=Math.floor(o*s),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${ze.health})`:""}`,apply:e=>{var l,c,r;const t=((l=e.upgradeStacks)==null?void 0:l.health)||0,o=((r=(c=e.characterData)==null?void 0:c.stats)==null?void 0:r.health)||100,s=t*20,i=e.maxHealth;e.maxHealth=o+s;const a=e.maxHealth-i;a>0&&e.setHP(e.hp()+a)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${ze.projectileSpeed})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.projectileSpeed)||0,o=e.baseProjectileSpeed||((a=e.weaponDef)==null?void 0:a.projectileSpeed)||300,s=Math.pow(1.25,t);e.projectileSpeed=Math.floor(o*s)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${ze.xpGain})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.xpGain)||0,o=((i=e.characterData)==null?void 0:i.ability)==="xpBoost"?1.1:1;e.xpMultiplier=o+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${ze.pickupRadius})`:""}`,apply:e=>{var i;const t=((i=e.upgradeStacks)==null?void 0:i.pickupRadius)||0,o=30,s=Math.pow(1.5,t);e.pickupRadius=Math.floor(o*s)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${ze.multiShot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.multiShot)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||1;e.projectileCount=o+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${ze.piercing})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.piercing)||0,o=((i=e.weaponDef)==null?void 0:i.piercing)||0;e.piercing=o+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${ze.obstaclePiercing})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.obstaclePiercing)||0,o=((i=e.weaponDef)==null?void 0:i.obstaclePiercing)||0;e.obstaclePiercing=o+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${ze.critChance})`:""}`,apply:e=>{var i,a,l;const t=((i=e.upgradeStacks)==null?void 0:i.critChance)||0;let s=(((a=e.weaponDef)==null?void 0:a.critChance)||.05)+t*.1;((l=e.characterData)==null?void 0:l.ability)==="critBoost"&&(s*=1.5),e.critChance=s}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${ze.critDamage})`:""}`,apply:e=>{var i,a,l;const t=((i=e.upgradeStacks)==null?void 0:i.critDamage)||0;let s=(((a=e.weaponDef)==null?void 0:a.critDamage)||2)+t*.5;((l=e.characterData)==null?void 0:l.ability)==="critBoost"&&(s*=1.25),e.critDamage=s}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${ze.spreadShot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.spreadShot)||0,o=((i=e.weaponDef)==null?void 0:i.spreadAngle)||0;e.spreadAngle=o+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${ze.pelletCount})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.pelletCount)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||3;e.projectileCount=o+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${ze.range})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.range)||0,o=((a=e.weaponDef)==null?void 0:a.range)||600,s=Math.pow(1.25,t);e.weaponRange=Math.floor(o*s)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${ze.dot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.dot)||0,o=((i=e.characterData)==null?void 0:i.ability)==="fireDot"?1.25:1;e.fireDotMultiplier=o+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${ze.orbitalCount})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.orbitalCount)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||1;e.projectileCount=o+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${ze.orbitalSpeed})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.orbitalSpeed)||0,o=((a=e.weaponDef)==null?void 0:a.rotationSpeed)||180,s=Math.pow(1.5,t);e.rotationSpeed=o*s}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${ze.orbitalRadius})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.orbitalRadius)||0,o=((a=e.weaponDef)==null?void 0:a.orbitRadius)||45,s=Math.pow(1.2,t);e.orbitRadius=Math.floor(o*s)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${ze.explosionRadius})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.explosionRadius)||0,o=((a=e.weaponDef)==null?void 0:a.explosionRadius)||50,s=Math.pow(1.25,t);e.explosionRadius=Math.floor(o*s)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${ze.explosionDamage})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.explosionDamage)||0,o=((a=e.weaponDef)==null?void 0:a.explosionDamage)||15,s=Math.pow(1.25,t);e.explosionDamage=Math.floor(o*s)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${ze.chainJumps})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.chainJumps)||0,o=((i=e.weaponDef)==null?void 0:i.maxJumps)||3;e.maxJumps=o+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${ze.chainRange})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.chainRange)||0,o=((a=e.weaponDef)==null?void 0:a.chainRange)||70,s=Math.pow(1.25,t);e.chainRange=Math.floor(o*s)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${ze.chainDamage})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.chainDamage)||0,o=((i=e.weaponDef)==null?void 0:i.chainDamageReduction)||.15;e.chainDamageReduction=Math.max(.05,o-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${ze.defense})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.defense)||0,o=((i=e.characterData)==null?void 0:i.ability)==="tankStats"?.15:0;e.defense=o+t*2}}};function d0(e,t){var o,s,i;if(e.category==="passive"){const a=((o=t.upgradeStacks)==null?void 0:o[e.key])||0,l=e.maxStacks||ze[e.key]||10;return!(a>=l)}if(e.category==="weapon"){const a=((s=t.upgradeStacks)==null?void 0:s[e.key])||0,l=e.maxStacks||ze[e.key]||10;if(a>=l)return!1;const c=((i=t.characterData)==null?void 0:i.weapon)||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(c):e.upgradeCategory?ku(c,e.upgradeCategory):!0}return!0}function u0(e=3,t=null){let s=Object.keys(Wo).map(c=>({key:c,...Wo[c],type:"upgrade"})),i=s;t&&(i=s.filter(c=>d0(c,t))),i.length<e&&(i=s);const a=[],l=new Set;for(;a.length<e&&a.length<i.length;){const c=Math.floor(Math.random()*i.length),r=i[c];l.has(r.key)||(l.add(r.key),a.push(r))}return a}function p0(e,t){const o=Wo[t];o&&(o.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,f0(e))}function f0(e){Object.keys(Wo).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&Wo[t].apply(e)})}function g0(e,t){var o;if(!e)return"";if(e.getDescription){const s=((o=t==null?void 0:t.upgradeStacks)==null?void 0:o[e.key])||0;return e.getDescription(s)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const m0={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}}};function x0(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function al(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const o=[];for(const[s,i]of Object.entries(m0))i.required.every(l=>t.selectedUpgrades.has(l))&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(s)||(i.apply(t),t.activeSynergies.add(s),o.push(i),y0(e,i)));return o}function y0(e,t){const o=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),s=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{o.exists()&&(e.destroy(o),e.destroy(s))})}const W={TITLE:36,HEADER:24,LABEL:18,BODY:16,SMALL:14,BUTTON:20,HUD:16},C={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},w0={BUTTON_VERTICAL:65},Fo={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},Io={HEALTH:"HP",FLOOR:"Floor",ROOM:"Room",DAMAGE:"Damage",SPEED:"Speed"};function ho(e){return e.toUpperCase()}function b0(e,t){return`${e}/${t}`}const B={BACKGROUND:0,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1e3},ss=["$","","","","","","",""];function hi(e,t={}){const{patternCount:o=12,particleCount:s=20,includeCursorFollowers:i=!1}=t,a=["","","","","","","",""];for(let l=0;l<o;l++){const c=e.add([e.text(a[Math.floor(Math.random()*a.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...C.BG_LIGHT),e.opacity(.15),e.z(B.PARTICLES)]);c.pulseTime=Math.random()*Math.PI*2,c.pulseSpeed=1+Math.random()*2,c.onUpdate(()=>{c.pulseTime+=e.dt()*c.pulseSpeed;const r=.8+Math.sin(c.pulseTime)*.3;c.scale=e.vec2(r,r),c.opacity=.1+Math.abs(Math.sin(c.pulseTime))*.15})}for(let l=0;l<s;l++){const c=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...C.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(B.PARTICLES)]);c.speed=10+Math.random()*20,c.onUpdate(()=>{c.pos.y+=c.speed*e.dt(),c.pos.y>e.height()&&(c.pos.y=0,c.pos.x=Math.random()*e.width())})}if(i){const l=[];e.loop(5,()=>{if(l.length<3&&Math.random()<.3){const c=["","","","","","",""],r=e.add([e.text(c[Math.floor(Math.random()*c.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(B.PARTICLES)]);r.followSpeed=20+Math.random()*30,r.rotationSpeed=50+Math.random()*100,r.lifetime=15+Math.random()*10,r.onUpdate(()=>{const d=e.mousePos().sub(r.pos),u=d.len();if(u>5){const h=d.scale(1/u);r.pos=r.pos.add(h.scale(r.followSpeed*e.dt()))}if(r.angle+=r.rotationSpeed*e.dt(),r.lifetime-=e.dt(),r.lifetime<=0){e.destroy(r);const h=l.indexOf(r);h>-1&&l.splice(h,1)}}),l.push(r)}})}}function Dn(e,t,o){const s=()=>2+Math.random()*3,i=e.add([e.text(`${ss[0]}: ${t}`,{size:W.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),a=i.width+30,l=40;e.destroy(i);const c=e.add([e.rect(a,l),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.GOLD)),e.fixed(),e.z(B.UI_BACKGROUND)]),r=e.add([e.text(`${ss[0]}: ${t}`,{size:W.LABEL}),e.pos(e.width()-20-a/2,40),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.UI_TEXT)]);r.symbolIndex=0,r.timeSinceLastChange=0,r.currentCurrency=t,r.symbolChangeInterval=s();const n=d=>{r.currentCurrency=d,r.text=`${ss[r.symbolIndex]}: ${d}`;const u=r.width+30;Math.abs(u-a)>10&&(c.width=u,r.pos.x=e.width()-20-u/2)};return r.onUpdate(()=>{r.timeSinceLastChange+=e.dt(),r.timeSinceLastChange>=r.symbolChangeInterval&&(r.timeSinceLastChange=0,r.symbolIndex=(r.symbolIndex+1)%ss.length,r.text=`${ss[r.symbolIndex]}: ${r.currentCurrency}`,r.symbolChangeInterval=s())}),{panel:c,text:r,updateCurrency:n}}let io=!1;function A0(e,t,o){if(io)return;io=!0,e.paused=!0,e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()));const s=u0(3,t);console.log("Creating upgrade draft with",s.length,"upgrades"),e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...C.BG_DARK),e.opacity(.9),e.fixed(),e.z(B.MODAL),"upgradeOverlay"]),e.add([e.text("Level Up! Choose an Upgrade",{size:W.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...C.WARNING),e.fixed(),e.z(B.MODAL+1),"upgradeUI"]),console.log("Title created at",e.width()/2,80);const i=200,a=150,l=250,c=e.width()/2-l*(s.length-1)/2,r=e.height()/2;s.forEach((x,f)=>{const A=c+f*l,g=e.add([e.rect(i,a),e.pos(A,r),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.BORDER)),e.fixed(),e.z(B.MODAL+1),e.area(),"upgradeUI","upgradeCard"]);if(x.icon){const E=x.category==="passive"?C.SUCCESS:x.weaponKey?C.WARNING:C.INFO;e.add([e.text(x.icon,{size:48}),e.pos(A,r-50),e.anchor("center"),e.color(...E),e.fixed(),e.z(B.MODAL+2),"upgradeUI"])}e.add([e.text(x.name,{size:W.BUTTON,width:i-20}),e.pos(A,r-5),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.MODAL+2),"upgradeUI"]);const w=g0(x,t);e.add([e.text(w,{size:W.BODY,width:i-20}),e.pos(A,r+30),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.MODAL+2),"upgradeUI"]),e.add([e.text(`${f+1}`,{size:W.HEADER}),e.pos(A+i/2-20,r-a/2+15),e.anchor("center"),e.color(...C.WARNING),e.fixed(),e.z(B.MODAL+2),"upgradeUI"]),g.onClick(()=>{io&&n(f)})});function n(x){if(!io)return;const f=s[x];t0(),io=!1,p0(t,f.key),x0(t,f.key),al(e,t),e.get("upgradeUI").forEach(A=>e.destroy(A)),e.get("upgradeOverlay").forEach(A=>e.destroy(A)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.paused=!1,e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{o&&o(f)})}const d=()=>{io&&s.length>=1&&n(0)},u=()=>{io&&s.length>=2&&n(1)},h=()=>{io&&s.length>=3&&n(2)};e.onKeyPress("1",d),e.onKeyPress("2",u),e.onKeyPress("3",h)}function ya(){return io}function v0(e,t){let o=!1;t.addXP=function(i){if(e.paused||o)return;const a=t.xpMultiplier||1,l=Math.floor(i*a);for(t.xp+=l;t.xp>=t.xpToNext&&!o;){o=!0,t.xp-=t.xpToNext,t.level++;const c=t.level;t.xpToNext=Math.floor(t.xpToNext*lo.XP_SCALING_FACTOR),s(e,t,c)}};function s(i,a,l){if(i.paused){o=!1;return}kp();const c=i.add([i.text(`Level ${l}!`,{size:24}),i.pos(i.width()/2,lo.LEVEL_UP_NOTIFICATION_Y),i.anchor("center"),i.color(255,255,100),i.fixed()]);i.wait(lo.LEVEL_UP_NOTIFICATION_DURATION,()=>{i.destroy(c),A0(i,a,()=>{o=!1})})}}const M0={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:20,turret:15,heavyTank:20,zippy:20,exploder:25},3:{mage:20,shieldBearer:15,golem:15,wraith:15,spawner:15,buffer:20,orbiter:10},4:{healer:25,teleporter:20,freezer:25,leech:30}};function E0(){return{basic:15,rusher:25,tank:30,fast:30}}function S0(e){const t=Object.values(e).reduce((s,i)=>s+i,0);let o=Math.random()*t;for(const[s,i]of Object.entries(e))if(o-=i,o<=0)return s;return Object.keys(e)[0]}function nn(e=1){const t=M0[e]||E0();return S0(t)}const R0=800,T0=600,zs=20;let Fs=null;const wa={empty:{name:"Empty Room",obstacles:[],spawnDoors:null},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],spawnDoors:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],spawnDoors:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],spawnDoors:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],spawnDoors:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],spawnDoors:null}};function D0(e,t,o,s){const i=o/2,a=s/2,l=zs+i,c=R0-zs-i,r=zs+a,n=T0-zs-a,d=Math.max(l,Math.min(c,e)),u=Math.max(r,Math.min(n,t));return{x:d,y:u}}function C0(e,t){const o=Math.max(150-t*5,100);return{wallColor:e.rgb(Math.floor(o*.6),Math.floor(o*.4),Math.floor(o*.5)),obstacleColor:e.rgb(Math.floor(o*.7),Math.floor(o*.5),Math.floor(o*.6)),coverColor:e.rgb(Math.floor(o*.8),Math.floor(o*.6),Math.floor(o*.7))}}function rl(e){const t=Object.keys(wa),o=Fs?t.filter(a=>a!==Fs):t,s=o.length>0?o:t,i=s[Math.floor(Math.random()*s.length)];return Fs=i,{key:i,...wa[i]}}function I0(){Fs=null}const di={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1},floor10:{id:"floor10",name:"Floor 10 Reached",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies",category:"combat",icon:"",unlocked:!1},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies",category:"combat",icon:"",unlocked:!1},kill1000:{id:"kill1000",name:"Genocide",description:"Kill 1000 enemies",category:"combat",icon:"",unlocked:!1},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses",category:"boss",icon:"",unlocked:!1},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1},earn100:{id:"earn100",name:"Rich",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1},earn500:{id:"earn500",name:"Wealthy",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1},earn1000:{id:"earn1000",name:"Millionaire",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1}};function P0(e){return Object.values(di).filter(t=>t.category===e)}function B0(){const e=new Set;return Object.values(di).forEach(t=>e.add(t.category)),Array.from(e)}function O0(e){const t=Yr(),o=[];return t.bestFloor>=2&&!at("floor2")&&rt("floor2")&&o.push("floor2"),t.bestFloor>=3&&!at("floor3")&&rt("floor3")&&o.push("floor3"),t.bestFloor>=5&&!at("floor5")&&rt("floor5")&&o.push("floor5"),t.bestFloor>=10&&!at("floor10")&&rt("floor10")&&o.push("floor10"),t.totalEnemiesKilled>=1&&!at("firstKill")&&rt("firstKill")&&o.push("firstKill"),t.totalEnemiesKilled>=100&&!at("kill100")&&rt("kill100")&&o.push("kill100"),t.totalEnemiesKilled>=500&&!at("kill500")&&rt("kill500")&&o.push("kill500"),t.totalEnemiesKilled>=1e3&&!at("kill1000")&&rt("kill1000")&&o.push("kill1000"),t.totalBossesKilled>=1&&!at("firstBoss")&&rt("firstBoss")&&o.push("firstBoss"),t.totalBossesKilled>=5&&!at("boss5")&&rt("boss5")&&o.push("boss5"),t.totalRuns>=1&&!at("firstRun")&&rt("firstRun")&&o.push("firstRun"),t.totalRuns>=10&&!at("run10")&&rt("run10")&&o.push("run10"),t.totalRuns>=50&&!at("run50")&&rt("run50")&&o.push("run50"),t.bestLevel>=10&&!at("level10")&&rt("level10")&&o.push("level10"),t.bestLevel>=20&&!at("level20")&&rt("level20")&&o.push("level20"),t.totalCurrencyEarned>=100&&!at("earn100")&&rt("earn100")&&o.push("earn100"),t.totalCurrencyEarned>=500&&!at("earn500")&&rt("earn500")&&o.push("earn500"),t.totalCurrencyEarned>=1e3&&!at("earn1000")&&rt("earn1000")&&o.push("earn1000"),o.length>0&&e&&o.forEach((s,i)=>{const a=di[s];a&&e.wait(i*.5,()=>{L0(e,a)})}),o}function L0(e,t){s0();const o=e.add([e.text("Achievement Unlocked!",{size:20}),e.pos(e.width()/2,e.height()/2-40),e.anchor("center"),e.color(255,255,100),e.fixed(),e.z(3e3)]),s=e.add([e.text(`${t.icon} ${t.name}`,{size:24}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(3e3)]),i=e.add([e.text(t.description,{size:16}),e.pos(e.width()/2,e.height()/2+30),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(3e3)]);e.wait(3,()=>{o.exists()&&e.destroy(o),s.exists()&&e.destroy(s),i.exists()&&e.destroy(i)})}class Hs{constructor(t,o,s="combat"){this.position={x:t,y:o},this.type=s,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=s==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:o,y:s}=this.position;switch(t){case"up":return{x:o,y:s-1};case"down":return{x:o,y:s+1};case"right":return{x:o+1,y:s};default:return null}}}class z0{constructor(t,o=6,s=3){this.floor=t,this.width=o,this.height=s,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.generate()}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const o=this.height===1?0:Math.floor(Math.random()*this.height);this.bossPosition={x:this.width-1,y:o};const s=new Hs(0,t,"start");this.setRoom(0,t,s);const i=new Hs(this.width-1,o,"boss");this.setRoom(this.width-1,o,i),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const o of t)if(!this.getRoom(o.x,o.y)){const s=new Hs(o.x,o.y,"combat");this.setRoom(o.x,o.y,s)}}findPath(t,o){const s=[];let i={...t};for(;i.x<o.x||i.y!==o.y;)s.push({...i}),i.x<o.x?i.y!==o.y&&Math.random()<.3?i.y+=i.y<o.y?1:-1:i.x+=1:i.y+=i.y<o.y?1:-1;return s.push({...o}),s}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let o=0;for(let s=1;s<this.width-1;s++)for(let i=0;i<this.height&&!(o>=t);i++){if(this.getRoom(s,i))continue;if(s>0&&this.getRoom(s-1,i)&&Math.random()<.5){const l=new Hs(s,i,"combat");this.setRoom(s,i,l),o++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const s=this.getRoom(t,o);s&&(t<this.width-1&&this.getRoom(t+1,o)&&(s.connections.right=!0),o>0&&this.getRoom(t,o-1)&&(s.connections.up=!0),o<this.height-1&&this.getRoom(t,o+1)&&(s.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const s=this.getRoom(t,o);if(s&&(s.type!=="boss"&&(s.template=rl(this.floor)),s.type==="combat")){const i=3+Math.floor(Math.random()*3);s.enemyTypes=[];for(let a=0;a<i;a++)s.enemyTypes.push(nn(this.floor))}}}validate(){const t=new Set,o=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);o.length>0;){const s=o.shift(),i=this.getRoom(s.x,s.y);if(!i)continue;if(i.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const a=["up","down","right"];for(const l of a)if(i.connections[l]){const c=i.getAdjacentPosition(l),r=`${c.x},${c.y}`;t.has(r)||(t.add(r),o.push(c))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,o){return t<0||t>=this.width||o<0||o>=this.height?null:this.grid[o][t]}setRoom(t,o,s){t<0||t>=this.width||o<0||o>=this.height||(this.grid[o][t]=s,this.rooms.set(s.getKey(),s))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const o=[],s=["up","down","right"];for(const i of s)if(t.connections[i]){const a=t.getAdjacentPosition(i),l=this.getRoom(a.x,a.y);l&&!l.visited&&o.push({direction:i,position:a,room:l})}return o}markRoomVisited(t,o){const s=this.getRoom(t,o);s&&(s.visited=!0,this.visitedRooms.add(s.getKey()))}markRoomCleared(t,o){const s=this.getRoom(t,o);s&&(s.cleared=!0)}moveToRoom(t){const o=this.getCurrentRoom();if(!o||!o.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const s=o.getAdjacentPosition(t);return this.getRoom(s.x,s.y)?(this.currentPosition=s,this.markRoomVisited(s.x,s.y),console.log(`[FloorMap] Moved to room (${s.x}, ${s.y})`),!0):(console.warn(`[FloorMap] No room found at ${s.x}, ${s.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let o=0;o<this.height;o++){const s=[];for(let i=0;i<this.width;i++){const a=this.getRoom(i,o);a?i===this.currentPosition.x&&o===this.currentPosition.y?s.push({type:"current",room:a}):a.visited?s.push({type:"visited",room:a}):this.isRoomRevealed(i,o)?s.push({type:"revealed",room:a}):s.push({type:"hidden"}):s.push({type:"empty"})}t.push(s)}return t}isRoomRevealed(t,o){if(!this.getRoom(t,o))return!1;const i=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:a,dy:l}of i){const c=this.getRoom(t+a,o+l);if(c&&c.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let o="";for(let s=0;s<this.width;s++){const i=this.getRoom(s,t);i?i.type==="start"?o+="[S]":i.type==="boss"?o+="[B]":s===this.currentPosition.x&&t===this.currentPosition.y?o+="[]":i.visited?o+="[]":o+="[R]":o+="[ ]",o+=" "}console.log(o)}console.log(`
Connections:`);for(const[t,o]of this.rooms){const s=[];o.connections.up&&s.push(""),o.connections.down&&s.push(""),o.connections.right&&s.push(""),console.log(`  (${o.position.x}, ${o.position.y}): ${s.join(", ")||"none"}`)}}}function H0(e){const t=Math.min(5+Math.floor(e/3),8),o=Math.min(3+Math.floor(e/5),5),s=new z0(e,t,o);return s.debugPrint(),s}const mo={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"};class N0{constructor(t,o){this.k=t,this.floorMap=o,this.mode=mo.MINIMIZED,this.elements=[],this.buttonPos={x:t.width()-50,y:70},this.openPos={x:t.width()-120,y:70},this.maximizedPos={x:t.width()-250,y:70},this.render()}toggle(){try{gt()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===mo.MINIMIZED?this.mode=mo.OPEN:this.mode===mo.OPEN?this.mode=mo.MAXIMIZED:this.mode=mo.MINIMIZED,this.k.wait(0,()=>{this.update()})}update(){this.clear(),this.render()}clear(){this.elements.forEach(t=>{t.exists()&&this.k.destroy(t)}),this.elements=[]}render(){this.mode===mo.MINIMIZED?this.renderMinimized():this.mode===mo.OPEN?this.renderOpen():this.renderMaximized()}renderMinimized(){const{x:t,y:o}=this.buttonPos,s=40,i=this.k.add([this.k.rect(s,s),this.k.pos(t,o),this.k.anchor("center"),this.k.color(30,30,50),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);i.onClick(()=>this.toggle()),this.elements.push(i);const a=this.k.add([this.k.text("",{size:24}),this.k.pos(t,o),this.k.anchor("center"),this.k.color(150,180,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(a);const l=this.k.add([this.k.text(`${this.floorMap.floor}`,{size:10}),this.k.pos(t+12,o-12),this.k.anchor("center"),this.k.color(255,255,100),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(l)}renderOpen(){const{x:t,y:o}=this.openPos,s=12,i=this.floorMap.getGridForMinimap(),a=this.k.add([this.k.rect(140,80),this.k.pos(t-10,o-10),this.k.anchor("topleft"),this.k.color(20,20,30),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);a.onClick(()=>this.toggle()),this.elements.push(a);const l=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t+60,o),this.k.anchor("center"),this.k.color(200,200,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(l);const c=o+15;for(let d=0;d<i.length;d++)for(let u=0;u<i[d].length;u++){const h=i[d][u],x=t+u*s,f=c+d*s;let A="",g=[100,100,100];switch(h.type){case"current":A="",g=[255,255,100];break;case"visited":A=h.room.isBossRoom?"B":"",g=h.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":A=h.room.isBossRoom?"B":"",g=h.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":A="",g=[60,60,80];break;case"empty":A=" ";break}if(A!==" "){const w=this.k.add([this.k.text(A,{size:10}),this.k.pos(x,f),this.k.anchor("topleft"),this.k.color(...g),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(w)}}const r=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:9}),this.k.pos(t+60,o+65),this.k.anchor("center"),this.k.color(180,180,180),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(r);const n=this.k.add([this.k.text("(click to expand)",{size:8}),this.k.pos(t+60,o+75),this.k.anchor("center"),this.k.color(120,120,140),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(n)}renderMaximized(){const{x:t,y:o}=this.maximizedPos,s=18,i=this.floorMap.getGridForMinimap(),a=Math.max(220,i[0].length*s+40),l=Math.max(180,i.length*s+100),c=this.k.add([this.k.rect(a,l),this.k.pos(t,o),this.k.anchor("topleft"),this.k.color(15,15,25),this.k.outline(3,this.k.rgb(100,150,255)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);c.onClick(()=>this.toggle()),this.elements.push(c);const r=this.k.add([this.k.rect(a,30),this.k.pos(t,o),this.k.anchor("topleft"),this.k.color(30,30,50),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(r);const n=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor} - ROOM ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:12}),this.k.pos(t+a/2,o+15),this.k.anchor("center"),this.k.color(200,220,255),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(n);const d=t+20,u=o+50;for(let A=0;A<i.length;A++)for(let g=0;g<i[A].length;g++){const w=i[A][g],E=d+g*s,T=u+A*s;let q=[30,30,40],U=[50,50,60];if(w.type!=="empty"){const b=this.k.add([this.k.rect(s-2,s-2),this.k.pos(E,T),this.k.anchor("topleft"),this.k.color(...q),this.k.outline(1,this.k.rgb(...U)),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(b)}let p="",y=[100,100,100];switch(w.type){case"current":p="",y=[255,255,100];break;case"visited":p=w.room.isBossRoom?"B":"",y=w.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":p=w.room.isBossRoom?"B":"",y=w.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":p="",y=[80,80,100];break}if(p){const b=this.k.add([this.k.text(p,{size:14}),this.k.pos(E+s/2,T+s/2),this.k.anchor("center"),this.k.color(...y),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(b)}}const h=u+i.length*s+20;[{char:"",label:"Current Room",color:[255,255,100]},{char:"",label:"Cleared Room",color:[100,255,100]},{char:"",label:"Available Room",color:[150,150,150]},{char:"B",label:"Boss Room",color:[255,100,100]}].forEach((A,g)=>{const w=t+20,E=h+g*15,T=this.k.add([this.k.text(A.char,{size:10}),this.k.pos(w,E),this.k.anchor("topleft"),this.k.color(...A.color),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(T);const q=this.k.add([this.k.text(A.label,{size:9}),this.k.pos(w+20,E),this.k.anchor("topleft"),this.k.color(180,180,200),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(q)});const f=this.k.add([this.k.text("(click to minimize)",{size:9}),this.k.pos(t+a/2,o+l-10),this.k.anchor("center"),this.k.color(120,120,140),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(f)}destroy(){this.clear()}}function U0(e,t){return new N0(e,t)}const ba={city:{name:"Urban Streets",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.15},{char:"",pattern:"vertical_lines",density:"low",opacity:.12},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"random",count:8,opacity:.1},{char:"",pattern:"random",count:8,opacity:.1}],baseColor:[60,60,70]},mechanical:{name:"Industrial Complex",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.12},{char:"",pattern:"grid",spacing:80,opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.18},{char:"",pattern:"scattered",count:3,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"edges",count:12,opacity:.14}],baseColor:[70,65,60]},futuristic:{name:"Cyber Station",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.13},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.13},{char:"",pattern:"grid",spacing:100,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.15},{char:"",pattern:"corners",opacity:.18},{char:"",pattern:"scattered",count:6,opacity:.14}],baseColor:[55,65,80]},alien:{name:"Alien Vessel",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.12},{char:"~",pattern:"random",count:15,opacity:.1},{char:"",pattern:"scattered",count:4,opacity:.16},{char:"",pattern:"grid",spacing:120,opacity:.13},{char:"",pattern:"corners",opacity:.17},{char:"",pattern:"scattered",count:5,opacity:.14}],baseColor:[65,55,75]}};function q0(e){for(const[t,o]of Object.entries(ba))if(o.floors.includes(e))return{key:t,...o};return{key:"city",...ba.city}}function _0(e,t,o=800,s=600){const i=q0(t),a=[],l=30;return i.decorations.forEach(c=>{const r=i.baseColor,n=e.rgb(r[0]+(Math.random()-.5)*20,r[1]+(Math.random()-.5)*20,r[2]+(Math.random()-.5)*20);switch(c.pattern){case"horizontal_lines":{const d=c.density==="high"?40:c.density==="medium"?80:120;for(let u=l;u<s-l;u+=d)a.push({char:c.char,x:o/2,y:u+(Math.random()-.5)*20,color:n,opacity:c.opacity,size:12});break}case"vertical_lines":{const d=c.density==="high"?40:c.density==="medium"?80:120;for(let u=l;u<o-l;u+=d)a.push({char:c.char,x:u+(Math.random()-.5)*20,y:s/2,color:n,opacity:c.opacity,size:12});break}case"wavy_lines":{for(let u=l;u<s-l;u+=60)for(let h=l;h<o-l;h+=40)a.push({char:c.char,x:h+Math.sin(u*.05)*15,y:u,color:n,opacity:c.opacity,size:10});break}case"grid":{const d=c.spacing||80;for(let u=l;u<s-l;u+=d)for(let h=l;h<o-l;h+=d)a.push({char:c.char,x:h+(Math.random()-.5)*10,y:u+(Math.random()-.5)*10,color:n,opacity:c.opacity,size:14});break}case"scattered":{const d=c.count||5;for(let u=0;u<d;u++)a.push({char:c.char,x:l+Math.random()*(o-l*2),y:l+Math.random()*(s-l*2),color:n,opacity:c.opacity,size:16});break}case"random":{const d=c.count||10;for(let u=0;u<d;u++)a.push({char:c.char,x:l+Math.random()*(o-l*2),y:l+Math.random()*(s-l*2),color:n,opacity:c.opacity,size:10+Math.random()*6});break}case"corners":{[{x:l+40,y:l+40},{x:o-l-40,y:l+40},{x:l+40,y:s-l-40},{x:o-l-40,y:s-l-40}].forEach(u=>{a.push({char:c.char,x:u.x,y:u.y,color:n,opacity:c.opacity,size:18})});break}case"edges":{const d=c.count||8,u=Math.floor(d/4);for(let h=0;h<u;h++)a.push({char:c.char,x:o/u*h+o/(u*2),y:l+20,color:n,opacity:c.opacity,size:12});for(let h=0;h<u;h++)a.push({char:c.char,x:o/u*h+o/(u*2),y:s-l-20,color:n,opacity:c.opacity,size:12});for(let h=0;h<u;h++)a.push({char:c.char,x:l+20,y:s/u*h+s/(u*2),color:n,opacity:c.opacity,size:12});for(let h=0;h<u;h++)a.push({char:c.char,x:o-l-20,y:s/u*h+s/(u*2),color:n,opacity:c.opacity,size:12});break}}}),a}function F0(e,t,o=800,s=600){_0(e,t,o,s).forEach(a=>{e.add([e.text(a.char,{size:a.size}),e.pos(a.x,a.y),e.color(a.color),e.opacity(a.opacity),e.z(0),"floorDecoration"])})}class Zs{constructor(t,o){this.playerId=t,this.characterKey=o,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=lo.STARTING_LEVEL,this.xp=lo.STARTING_XP,this.xpToNext=lo.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,health:this.health,maxHealth:this.maxHealth,level:this.level,xp:this.xp,xpToNext:this.xpToNext,weaponKey:this.weaponKey,isDead:this.isDead}}static fromJSON(t){const o=new Zs(t.playerId,t.characterKey);return Object.assign(o,t),o}}class ks{constructor(t,o,s,i,a={}){this.id=t,this.type=o,this.x=s,this.y=i,this.data=a,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new ks(t.id,t.type,t.x,t.y,t.data)}}class ei{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,o){const s=new Zs(t,o);return this.players.set(t,s),this.localPlayerId===null&&(this.localPlayerId=t),s}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,o,s,i={}){const a=this.generateEntityId(),l=new ks(a,t,o,s,i);return this.entities.set(a,l),l}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(o=>o.type===t&&!o.removed)}removeEntity(t){const o=this.entities.get(t);o&&(o.removed=!0)}cleanupRemovedEntities(){for(const[t,o]of this.entities.entries())o.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,o])=>[t,o.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,o])=>[t,o.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const o=new ei;return o.sessionId=t.sessionId,o.gameMode=t.gameMode,o.isPaused=t.isPaused,o.currentFloor=t.currentFloor,o.currentRoom=t.currentRoom,o.roomCleared=t.roomCleared,o.gameTime=t.gameTime,o.localPlayerId=t.localPlayerId,o.nextEntityId=t.nextEntityId,o.players=new Map(t.players.map(([s,i])=>[s,Zs.fromJSON(i)])),o.entities=new Map(t.entities.map(([s,i])=>[s,ks.fromJSON(i)])),o.doors=t.doors,o.obstacles=t.obstacles,o}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class Y0{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new ei,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=ei.fromJSON(t),this.gameState}clear(){this.gameState=null}}const Aa=new Y0;class Cn{constructor(t,o,s){this.playerId=t,this.frameNumber=o,this.timestamp=s,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const o=new Cn(t.playerId,t.frameNumber,t.timestamp);return Object.assign(o,t),o}}class X0{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(s=>{t.onKeyPress(s,()=>{this.keysPressed.add(s)}),t.onKeyRelease(s,()=>{this.keysPressed.delete(s)})}),t.onKeyPress("escape",()=>{this.onPausePressed()}),t.onKeyPress("space",()=>{this.onInteractPressed()}),t.onKeyPress("e",()=>{this.onInteractPressed()})}setupMouseListeners(){const t=this.k;t.onMouseMove(o=>{this.mouseX=o.x,this.mouseY=o.y}),t.onMousePress(()=>{this.mousePressed=!0}),t.onMouseRelease(()=>{this.mousePressed=!1})}collectLocalInput(t){const o=new Cn(t,this.frameNumber,Date.now());return o.moveX=this.getMoveX(),o.moveY=this.getMoveY(),o.aimX=this.mouseX,o.aimY=this.mouseY,o.firing=!0,o}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const o=new Map;for(const s of t){const i=this.inputQueues.get(s);let a;i&&i.length>0?a=i.shift():a=this.collectLocalInput(s),o.set(s,a)}return this.currentInputs=o,this.inputHistory.push(new Map(o)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,o}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class G0{constructor(){this.inputManager=null}init(t){return this.inputManager=new X0,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const va=new G0,Ma={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class ti{constructor(t,o,s=null){this.type=t,this.data=o,this.senderId=s,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const o=new ti(t.type,t.data,t.senderId);return o.timestamp=t.timestamp,o}}class K0{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,o){const s=new ti(t,o,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",s),this.messageQueue.push(s))}broadcast(t,o){this.send(t,o)}sendTo(t,o,s){const i=new ti(o,s,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,i)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const o of t)this.handleMessage(o);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Ma.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Ma.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,o){this.players.set(t,{id:t,...o,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:o})}removePlayer(t){const o=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:o})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,o){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(o)}off(t,o){if(this.eventHandlers.has(t)){const s=this.eventHandlers.get(t),i=s.indexOf(o);i>-1&&s.splice(i,1)}}emit(t,o,s=null){if(this.eventHandlers.has(t)){const i=this.eventHandlers.get(t);for(const a of i)a(o,s)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class V0{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new K0,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const j0=new V0;let de={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null},Bt={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0};function Ea(e,t){const o=no("startingHealth");o>0&&(t.maxHealth+=o*10,t.setHP(t.maxHealth));const s=no("startingDamage");s>0&&(t.projectileDamage+=s);const i=no("startingSpeed");i>0&&(t.speed+=i*10)}function W0(e){e.scene("game",t=>{if(t!=null&&t.resetState){const S=j0.init("local");va.init(e);const oe=Aa.init("singleplayer");oe.addPlayer(S,"survivor"),console.log("[Game] New architecture initialized:",{playerId:S,sessionId:oe.sessionId,gameMode:oe.gameMode})}const o=Aa.getState();t!=null&&t.resetState&&(de.currentFloor=1,de.currentRoom=1,de.playerStats=null,de.entryDirection=null,de.floorMap=null,I0(),Bt={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},e.gameData&&(e.gameData.weaponDetailSavedState=void 0));let s=de.currentFloor,i=de.currentRoom;!de.floorMap||de.floorMap.floor!==s?(console.log(`[Game] Generating new floor map for floor ${s}`),de.floorMap=H0(s),de.minimap&&de.minimap.destroy(),de.minimap=U0(e,de.floorMap),e.gameData&&(e.gameData.minimap=de.minimap)):de.minimap&&de.minimap.update(),s>Bt.floorsReached&&(Bt.floorsReached=s);const a=30;let l=e.width()/2,c=e.height()/2;if(de.entryDirection)switch(de.entryDirection){case"north":l=e.width()/2,c=a;break;case"south":l=e.width()/2,c=e.height()-a;break;case"west":l=a,c=e.height()/2;break;case"east":l=e.width()-a,c=e.height()/2;break}let r;de.playerStats?(r=Ei(e,l,c),Object.assign(r,de.playerStats),r.setHP(de.playerStats.currentHP||r.maxHealth),de.playerStats.selectedUpgrades&&(r.selectedUpgrades=new Set(de.playerStats.selectedUpgrades)),de.playerStats.activeSynergies&&(r.activeSynergies=new Set(de.playerStats.activeSynergies))):(r=Ei(e,l,c),Ea(e,r));const n=Jr(),d=Qr(),u=ip();let h=[r];if(d>1&&u.isInitialized){console.log("[Multiplayer] Initializing multiplayer game with",d,"players");const S=n.slots.findIndex(oe=>oe.isLocal);bp(n.isHost,S,e),ra(S,r),n.slots.forEach((oe,ie)=>{if(ie!==S&&oe.playerId!==null){const ge=(ie-S)*30,be=Ei(e,l+ge,c,oe.selectedCharacter);be.isRemote=!0,be.playerName=oe.playerName,Ea(e,be),ra(ie,be),h.push(be);const J=e.add([e.text(oe.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]);J.onUpdate(()=>{be.exists()?J.pos=e.vec2(be.pos.x,be.pos.y-30):J.destroy()})}}),console.log("[Multiplayer] Spawned",h.length,"players")}const x=o.localPlayerId,f=o.getPlayer(x);f&&(f.x=r.pos.x,f.y=r.pos.y,f.health=r.hp(),f.maxHealth=r.maxHealth,f.speed=r.speed,f.level=r.level,f.xp=r.xp,f.xpToNext=r.xpToNext,f.xpMultiplier=r.xpMultiplier||1,f.weaponKey="pistol",f.fireRate=r.fireRate,f.projectileSpeed=r.projectileSpeed,f.projectileDamage=r.projectileDamage,f.projectileCount=r.projectileCount||1,f.piercing=r.piercing||0,f.obstaclePiercing=r.obstaclePiercing||0,f.critChance=r.critChance||.05,f.critDamage=r.critDamage||2,f.spreadAngle=r.spreadAngle||0,f.weaponRange=r.weaponRange||600,f.pickupRadius=r.pickupRadius,f.defense=r.defense||0,f.damageReduction=r.damageReduction||0,f.dodgeChance=r.dodgeChance||0,console.log("[Game] Player entity synced to PlayerState:",{playerId:x,position:{x:f.x,y:f.y},health:`${f.health}/${f.maxHealth}`,level:f.level})),r0(e,r),v0(e,r),de.playerStats&&de.playerStats.selectedUpgrades&&e.wait(.1,()=>{al(e,r)});const A=de.floorMap.getCurrentRoom(),g=A&&A.template?A.template:rl(),w=C0(e,s),E=20;F0(e,s,e.width(),e.height()),e.add([e.rect(e.width()-E*2,2),e.pos(e.width()/2,E),e.anchor("center"),e.color(w.wallColor),e.fixed()]),e.add([e.rect(e.width()-E*2,2),e.pos(e.width()/2,e.height()-E),e.anchor("center"),e.color(w.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-E*2),e.pos(E,e.height()/2),e.anchor("center"),e.color(w.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-E*2),e.pos(e.width()-E,e.height()/2),e.anchor("center"),e.color(w.wallColor),e.fixed()]);const T=i===1&&s===1,q=80;let U=e.width()/2,p=e.height()/2;if(de.entryDirection)switch(de.entryDirection){case"north":U=e.width()/2,p=a;break;case"south":U=e.width()/2,p=e.height()-a;break;case"west":U=a,p=e.height()/2;break;case"east":U=e.width()-a,p=e.height()/2;break}T||g.obstacles.forEach(S=>{const oe=Math.sqrt(Math.pow(S.x-l,2)+Math.pow(S.y-c,2)),ie=Math.sqrt(Math.pow(S.x-U,2)+Math.pow(S.y-p,2)),ge=Math.max(S.width,S.height)/2;if(oe<q+ge||ie<q+ge)return;const be=D0(S.x,S.y,S.width,S.height),J=S.type==="wall"?w.obstacleColor:w.coverColor;Yp(e,be.x,be.y,S.width,S.height,S.type,S.char||"#",J)}),e.add([e.rect(100,40),e.pos(10,10),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(B.UI_BG-1)]);const y=e.add([e.text("",{size:W.HUD}),e.pos(20,20),e.color(...C.WARNING),e.fixed(),e.z(B.UI_TEXT)]),b=e.add([e.text("0/0",{size:W.HUD}),e.pos(40,20),e.color(...C.WARNING),e.fixed(),e.z(B.UI_TEXT)]);e.add([e.rect(120,40),e.pos(e.width()-10,10),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(B.UI_BG-1)]);const v=e.add([e.text("$",{size:W.LABEL}),e.pos(e.width()-20,20),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]),D=e.add([e.text("0",{size:W.HUD}),e.pos(e.width()-40,20),e.anchor("topright"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(950)]);if(ro()){const S=Tp(),oe=u.isHost?[100,255,100]:[100,200,255],ie=u.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...oe),e.fixed(),e.z(B.UI_TEXT)]),e.add([e.text(`${ie} (${S}P)`,{size:W.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...oe),e.fixed(),e.z(B.UI_TEXT)])}const P=e.width()-40,O=15,I=e.height()-30;e.add([e.rect(P,O),e.pos(20,I),e.color(...C.BG_DARK),e.outline(2,e.rgb(...C.TEXT_DISABLED)),e.fixed(),e.z(B.UI_BG)]);const R=e.add([e.rect(0,O-4),e.pos(50,I+2),e.color(100,200,255),e.fixed(),e.z(B.UI_BG+1)]),N=e.add([e.text("0/10",{size:W.SMALL-2}),e.pos(e.width()/2,I+O/2),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]),Y=28,j=20+Y/2,k=I+O/2;e.add([e.circle(Y/2),e.pos(j,k),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(B.UI_BG+2)]);const G=e.add([e.text("1",{size:W.SMALL}),e.pos(j,k),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(B.UI_TEXT)]),Q=40,pe=8,ee=25,De=e.add([e.rect(Q,pe),e.pos(0,0),e.anchor("center"),e.color(...C.BG_DARK),e.outline(1,e.rgb(...C.TEXT_DISABLED)),e.z(B.OVERLAY)]),ye=e.add([e.rect(Q-2,pe-2),e.pos(0,0),e.anchor("left"),e.color(100,255,100),e.z(B.OVERLAY+1)]);De.hidden=!0,ye.hidden=!0;const Se=48,Ae=20,Ce=e.height()-85,Pe=e.add([e.rect(Se,Se),e.pos(Ae,Ce),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(B.UI_BG)]),se=e.add([e.text("",{size:32}),e.pos(Ae+Se/2,Ce+Se/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]),V=220,K=90,te=e.add([e.rect(V,K),e.pos(Ae,Ce-K-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(B.OVERLAY+5)]),X=e.add([e.text("",{size:24}),e.pos(Ae+15,Ce-K-10+15),e.color(255,255,255),e.fixed(),e.z(B.OVERLAY+6)]),$=e.add([e.text("Basic Pistol",{size:W.SMALL,width:160}),e.pos(Ae+50,Ce-K-10+10),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+6)]),ae=e.add([e.text("DMG: 10",{size:W.SMALL-2}),e.pos(Ae+50,Ce-K-10+30),e.color(255,150,150),e.fixed(),e.z(B.OVERLAY+6)]),re=e.add([e.text("RATE: 3.75/s",{size:W.SMALL-2}),e.pos(Ae+50,Ce-K-10+47),e.color(150,200,255),e.fixed(),e.z(B.OVERLAY+6)]),me=e.add([e.text("DPS: 37.5",{size:W.SMALL-2}),e.pos(Ae+50,Ce-K-10+64),e.color(255,255,150),e.fixed(),e.z(B.OVERLAY+6)]);te.hidden=!0,X.hidden=!0,$.hidden=!0,ae.hidden=!0,re.hidden=!0,me.hidden=!0;let ue=!1;t!=null&&t.resetState&&(ue=!1),Pe.onClick(()=>{ue=!ue,te.hidden=!te.hidden,X.hidden=!X.hidden,$.hidden=!$.hidden,ae.hidden=!ae.hidden,re.hidden=!re.hidden,me.hidden=!me.hidden});const qe=40,yt=Ae,Xt=Ce-qe-10,It=e.add([e.rect(qe,qe),e.pos(yt,Xt),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(B.UI_BG)]),vt=e.add([e.text("",{size:28}),e.pos(yt+qe/2,Xt+qe/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]),je=e.add([e.text("20",{size:14}),e.pos(yt+qe+5,Xt+qe/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(B.UI_TEXT)]);It.hidden=!0,vt.hidden=!0,je.hidden=!0;const eo=Ae+Se+10,lt=Ce,Ye=32,wt=40,We=[];function Gt(){if(We.forEach(oe=>{oe.exists()&&e.destroy(oe)}),We.length=0,!r.exists())return;const S=[];r.upgradeStacks&&Object.entries(r.upgradeStacks).forEach(([oe,ie])=>{ie>0&&S.push({key:oe,stacks:ie})}),S.forEach((oe,ie)=>{const ge=eo+ie*wt,be=Wo[oe.key];if(!be)return;const J=e.add([e.rect(Ye,Ye),e.pos(ge,lt),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(B.UI_BG)]),le=e.add([e.text(be.icon,{size:20}),e.pos(ge+Ye/2,lt+Ye/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]),ce=e.add([e.text(oe.stacks.toString(),{size:10}),e.pos(ge+Ye-4,lt+Ye-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(B.UI_TEXT+1)]);We.push(J,le,ce)})}const _e=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(B.OVERLAY+10)]),ke=e.add([e.text("",{size:W.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(B.OVERLAY+11)]);_e.hidden=!0,ke.hidden=!0;const Ts={level:()=>`Level ${r.level}
XP: ${r.xp}/${r.xpToNext}
Progress: ${Math.floor(r.xp/r.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${Bt.enemiesKilled}`),currency:()=>`Total Credits: ${No()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const S=r.weaponDef;return S?`${S.name}
Damage: ${r.projectileDamage}
Fire Rate: ${r.fireRate.toFixed(2)}/s
DPS: ${(r.projectileDamage*r.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(r.hp())}/${r.maxHealth}
Damage Reduction: ${Math.floor(r.damageReduction*100)}%`};function fo(S,oe,ie){const ge=Ts[S];if(!ge)return;const be=ge();ke.text=be,_e.pos.x=Math.min(oe+10,e.width()-210),_e.pos.y=Math.min(ie+10,e.height()-70),ke.pos.x=_e.pos.x+5,ke.pos.y=_e.pos.y+5,_e.hidden=!1,ke.hidden=!1}function to(){_e.hidden=!0,ke.hidden=!0}function ui(){return{hidden:_e.hidden,text:ke.text,tooltipX:_e.pos.x,tooltipY:_e.pos.y,textX:ke.pos.x,textY:ke.pos.y}}function pi(S){S&&(_e.hidden=S.hidden,ke.hidden=S.hidden,ke.text=S.text,_e.pos.x=S.tooltipX,_e.pos.y=S.tooltipY,ke.pos.x=S.textX,ke.pos.y=S.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=to,e.gameData.saveTooltipState=ui,e.gameData.restoreTooltipState=pi,e.gameData.minimap=de.minimap,e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,e.onUpdate(()=>{if(e.paused||ya())return;const S=e.mousePos();let oe=!1;S.x>=20&&S.x<=180&&S.y>=20&&S.y<=35?(fo("level",S.x,S.y),oe=!0):S.x>=20&&S.x<=180&&S.y>=40&&S.y<=55&&!b.hidden?(fo("enemies",S.x,S.y),oe=!0):S.x>=e.width()-130&&S.x<=e.width()-10&&S.y>=10&&S.y<=50?(fo("currency",S.x,S.y),oe=!0):S.x>=Ae&&S.x<=Ae+Se&&S.y>=Ce&&S.y<=Ce+Se&&(fo("weapon",S.x,S.y),oe=!0),oe||to()});const Xe=e.add([e.text("",{size:W.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...C.BOSS_NAME),e.fixed(),e.z(B.OVERLAY)]),Kt=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...C.BG_DARK),e.outline(2,e.rgb(...C.TEXT_DISABLED)),e.fixed(),e.z(B.OVERLAY)]),Ne=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...C.HEALTH_LOW),e.fixed(),e.z(B.OVERLAY+1)]),Mt=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...C.BG_DARK),e.outline(2,e.rgb(...C.TEXT_DISABLED)),e.fixed(),e.z(B.OVERLAY)]),et=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.OVERLAY+1)]),qt=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]),ut=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]),_t=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...C.BG_DARK),e.outline(2,e.rgb(...C.TEXT_DISABLED)),e.fixed(),e.z(B.OVERLAY)]),M=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...C.XP_BAR),e.fixed(),e.z(B.OVERLAY+1)]),z=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]);Xe.hidden=!0,Kt.hidden=!0,Ne.hidden=!0,Mt.hidden=!0,et.hidden=!0,qt.hidden=!0,ut.hidden=!0,_t.hidden=!0,M.hidden=!0,z.hidden=!0,e.onUpdate(()=>{e.paused||a0(e)}),e.onUpdate(()=>{e.paused||ro()&&Mp(e.dt())}),e.onUpdate(()=>{const S=r.exists()?r.hp():0,oe=r.maxHealth>0?S/r.maxHealth:1;G.text=`${r.level}`;const ie=r.xpToNext>0?r.xp/r.xpToNext:0;if(R.width=Math.max(0,(P-34)*ie),N.text=b0(r.xp,r.xpToNext),D.text=No().toString(),oe<1&&r.exists()){De.hidden=!1,ye.hidden=!1;const J=r.pos.x,le=r.pos.y+ee;De.pos=e.vec2(J,le);const ce=J-Q/2+1;ye.pos=e.vec2(ce,le),ye.width=Math.max(0,(Q-2)*oe),oe>.6?ye.color=e.rgb(100,255,100):oe>.3?ye.color=e.rgb(255,200,0):ye.color=e.rgb(255,50,50)}else De.hidden=!0,ye.hidden=!0;if(!Z&&!F){const J=e.get("enemy").length,le=we+(pt?1:0),ce=e.get("miniboss").length,ve=J+ce+Math.max(0,le-Oe-(pt&&Et?1:0));b.text=`${ve}/${le}`,b.hidden=!1,y.hidden=!1}else b.hidden=!0,y.hidden=!0;if(r.exists()&&r.weaponDef){const J=r.weaponDef,le=(r.projectileDamage*r.fireRate).toFixed(1);se.text=J.icon||"",se.color=e.rgb(...J.color),X.text=J.icon||"",X.color=e.rgb(...J.color),$.text=J.name,$.color=e.rgb(...C.TEXT_PRIMARY),ae.text=`DMG: ${r.projectileDamage}`,re.text=`RATE: ${r.fireRate.toFixed(2)}/s`,me.text=`DPS: ${le}`,e.paused?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=ue),te.hidden=!1,X.hidden=!1,$.hidden=!1,ae.hidden=!1,re.hidden=!1,me.hidden=!1):(te.hidden=!ue,X.hidden=!ue,$.hidden=!ue,ae.hidden=!ue,re.hidden=!ue,me.hidden=!ue)}if(r.exists()){xp(r,e.dt());const J=wp(r);J?(It.hidden=!1,vt.hidden=!1,je.hidden=!1,vt.text=J.icon,vt.color=e.rgb(...J.color),It.outline.color=e.rgb(...J.color),J.isAmmoBased?je.text=`${J.ammo}`:J.isTimeBased&&(je.text=`${Math.ceil(J.duration)}s`)):(It.hidden=!0,vt.hidden=!0,je.hidden=!0)}e.time()%.5<e.dt()&&Gt();const ge=e.get("boss"),be=ge.filter(J=>J.type==="twinGuardianMelee"||J.type==="twinGuardianRanged");if(be.length>0){const J=be.find(ce=>ce.type==="twinGuardianMelee"),le=be.find(ce=>ce.type==="twinGuardianRanged");if(J&&le&&(J.exists()||le.exists())){Xe.hidden=!1,Xe.text="THE TWIN GUARDIANS";const ce=J.exists()?J.hp():0,ve=le.exists()?le.hp():0,fe=ce+ve,Me=(J.maxHealth||0)+(le.maxHealth||0),Ee=Me>0?Math.max(0,Math.min(1,fe/Me)):0;Ne.width=296*Ee,Ne.pos.x=e.width()/2-296*(1-Ee)/2,qt.text=`${Math.max(0,Math.floor(fe))}/${Me}`,Kt.hidden=!1,Ne.hidden=!1,qt.hidden=!1;const Ue=J.exists()&&J.shieldHealth||0,nt=le.exists()&&le.shieldHealth||0,Ke=Ue+nt,tt=(J.maxShieldHealth||0)+(le.maxShieldHealth||0);if(tt>0){const Zo=Math.max(0,Math.min(1,Ke/tt));M.width=296*Zo,M.pos.x=e.width()/2-296*(1-Zo)/2,z.text=`Shield: ${Math.max(0,Math.floor(Ke))}/${tt}`,_t.hidden=!1,M.hidden=!1,z.hidden=!1}else _t.hidden=!0,M.hidden=!0,z.hidden=!0;const yi=J.exists()&&J.armorHealth||0,bl=le.exists()&&le.armorHealth||0,Hn=yi+bl,wi=(J.maxArmorHealth||0)+(le.maxArmorHealth||0);if(wi>0){const Zo=Math.max(0,Math.min(1,Hn/wi));et.width=296*Zo,et.pos.x=e.width()/2-296*(1-Zo)/2,ut.text=`Armor: ${Math.max(0,Math.floor(Hn))}/${wi}`,Mt.hidden=!1,et.hidden=!1,ut.hidden=!1}else Mt.hidden=!0,et.hidden=!0,ut.hidden=!0;Ee>.6?Ne.color=e.rgb(255,50,50):Ee>.3?Ne.color=e.rgb(255,150,50):Ne.color=e.rgb(255,200,0)}else{const ce=J!=null&&J.exists()?J:le;if(ce){const ve=ce.hp(),fe=ce.maxHealth,Me=ce.shieldHealth||0,Ee=ce.maxShieldHealth||0,Ue=ce.armorHealth||0,nt=ce.maxArmorHealth||0;Xe.hidden=!1,Xe.text=ce.enraged?"THE TWIN GUARDIANS (ENRAGED)":"THE TWIN GUARDIANS";const Ke=Math.max(0,Math.min(1,ve/fe));if(Ne.width=296*Ke,Ne.pos.x=e.width()/2-296*(1-Ke)/2,qt.text=`${Math.max(0,Math.floor(ve))}/${fe}`,Kt.hidden=!1,Ne.hidden=!1,qt.hidden=!1,Ee>0){const tt=Math.max(0,Math.min(1,Me/Ee));M.width=296*tt,M.pos.x=e.width()/2-296*(1-tt)/2,z.text=`Shield: ${Math.max(0,Math.floor(Me))}/${Ee}`,_t.hidden=!1,M.hidden=!1,z.hidden=!1}else _t.hidden=!0,M.hidden=!0,z.hidden=!0;if(nt>0){const tt=Math.max(0,Math.min(1,Ue/nt));et.width=296*tt,et.pos.x=e.width()/2-296*(1-tt)/2,ut.text=`Armor: ${Math.max(0,Math.floor(Ue))}/${nt}`,Mt.hidden=!1,et.hidden=!1,ut.hidden=!1}else Mt.hidden=!0,et.hidden=!0,ut.hidden=!0;Ke>.6?Ne.color=e.rgb(255,50,50):Ke>.3?Ne.color=e.rgb(255,150,50):Ne.color=e.rgb(255,200,0)}else Xe.hidden=!0,Kt.hidden=!0,Ne.hidden=!0,Mt.hidden=!0,et.hidden=!0,qt.hidden=!0,ut.hidden=!0}}else if(ge.length>0&&ge[0].exists()){const J=ge[0],le=J.hp(),ce=J.maxHealth,ve=J.shieldHealth||0,fe=J.maxShieldHealth||0,Me=J.armorHealth||0,Ee=J.maxArmorHealth||0,nt={gatekeeper:"THE GATEKEEPER",swarmQueen:"THE SWARM QUEEN",twinGuardianMelee:"THE TWIN GUARDIANS",twinGuardianRanged:"THE TWIN GUARDIANS"}[J.type]||"BOSS";Xe.hidden=!1,Kt.hidden=!1,Ne.hidden=!1,Mt.hidden=!1,et.hidden=!1,qt.hidden=!1,ut.hidden=!1,Xe.text=nt;const Ke=Math.max(0,Math.min(1,le/ce));if(Ne.width=296*Ke,Ne.pos.x=e.width()/2-296*(1-Ke)/2,qt.text=`${Math.max(0,Math.floor(le))}/${ce}`,fe>0){const tt=Math.max(0,Math.min(1,ve/fe));M.width=296*tt,M.pos.x=e.width()/2-296*(1-tt)/2,z.text=`Shield: ${Math.max(0,Math.floor(ve))}/${fe}`,_t.hidden=!1,M.hidden=!1,z.hidden=!1}else _t.hidden=!0,M.hidden=!0,z.hidden=!0;if(Ee>0){const tt=Math.max(0,Math.min(1,Me/Ee));et.width=296*tt,et.pos.x=e.width()/2-296*(1-tt)/2,ut.text=`Armor: ${Math.max(0,Math.floor(Me))}/${Ee}`,Mt.hidden=!1,et.hidden=!1,ut.hidden=!1}else Mt.hidden=!0,et.hidden=!0,ut.hidden=!0;Ke>.6?Ne.color=e.rgb(255,50,50):Ke>.3?Ne.color=e.rgb(255,150,50):Ne.color=e.rgb(255,200,0)}else Xe.hidden=!0,Kt.hidden=!0,Ne.hidden=!0,Mt.hidden=!0,et.hidden=!0,qt.hidden=!0,ut.hidden=!0,_t.hidden=!0,M.hidden=!0,z.hidden=!0}),e.onUpdate(()=>{if(!r.exists()||e.paused)return;const S=o.getPlayer(x);S&&(S.x=r.pos.x,S.y=r.pos.y,S.velocityX=0,S.velocityY=0,S.health=r.hp(),S.maxHealth=r.maxHealth,S.level=r.level,S.xp=r.xp,S.xpToNext=r.xpToNext,S.projectileDamage=r.projectileDamage,S.fireRate=r.fireRate,S.projectileSpeed=r.projectileSpeed,S.projectileCount=r.projectileCount||1,S.piercing=r.piercing||0,S.critChance=r.critChance||.05,S.critDamage=r.critDamage||2,S.pickupRadius=r.pickupRadius,S.defense=r.defense||0,S.isDead=!r.exists()||r.hp()<=0,S.invulnerable=r.invulnerable||!1,o.updateTime(e.dt()))}),o.currentFloor=s,o.currentRoom=i,o.roomCleared=!1,console.log("[Game] Room state synced:",{floor:o.currentFloor,room:o.currentRoom,isBossRoom:i===3}),e.onUpdate(()=>{if(e.paused)return;const S=va.getManager(),ie=S.getInputsForFrame([x]).get(x);Math.random()<.01&&console.log("[InputManager] Frame:",S.frameNumber,"Input:",{move:`(${ie.moveX}, ${ie.moveY})`,aim:`(${ie.aimX}, ${ie.aimY})`,firing:ie.firing})});let F=!1;const Z=A?A.isBossRoom:i===3;let we=Z?0:24+(s-1)*6,Oe=0,it=2,Ge=!1,Et=!1,pt=!1,Ft=4,fi=0;if(!Z&&i!==1){const S=.15+(s-1)*.05;pt=Math.random()<S}pt&&(we=Math.floor(we*.5));function ul(S){const oe=["brute","sentinel","berserker","guardian","warlock"];if(S>=3)return oe[Math.floor(Math.random()*oe.length)];{const ie=["brute","berserker","guardian"];return ie[Math.floor(Math.random()*ie.length)]}}function pl(S){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[S]||"gatekeeper"}const ct=[],fl=[{x:e.width()/2,y:a,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-a,direction:"south",gridDir:"down"},{x:a,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-a,y:e.height()/2,direction:"east",gridDir:"right"}],gl=de.floorMap?de.floorMap.getAvailableExits():[],ml=new Set(gl.map(S=>S.direction));fl.forEach(S=>{const oe=Fp(e,S.x,S.y,S.direction);oe.open=!1,oe.isSpawnDoor=!0,oe.gridDirection=S.gridDir,(S.gridDir===null||!ml.has(S.gridDir))&&(oe.blocked=!0),oe.updateVisual(),ct.push(oe)});let Ds=0;const xl=.33;let In=!1;e.onUpdate(()=>{if(e.paused||F)return;if(In||(fi=e.time(),In=!0),Z){if(!Ge){Ge=!0;const J=pl(s);if(J==="twinGuardian"){const le=ct.filter(Me=>Me.direction!==de.entryDirection);let ce,ve;if(le.length>=2){const Me=[...le].sort(()=>Math.random()-.5);ce=Me[0];const Ee={north:"south",south:"north",east:"west",west:"east"};ve=le.find(Ue=>Ue.direction===Ee[ce.direction])||Me[1]}else ce=ct[0],ve=ct[ct.length>1?1:0];Up(e,ce,ve,s),ga();const fe=e.add([e.text("THE TWIN GUARDIANS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{fe.exists()&&e.destroy(fe)})}else{let le=ct.find(Ee=>Ee.direction==="north");if(!le||de.entryDirection==="north"&&ct.length>1){const Ee=ct.filter(Ue=>Ue.direction!==de.entryDirection);Ee.length>0?le=Ee[Math.floor(Math.random()*Ee.length)]:le=ct[Math.floor(Math.random()*ct.length)]}const ce=le?le.pos.x:e.width()/2,ve=le?le.pos.y:e.height()/2;on(e,ce,ve,J,s),ga();const fe=J==="gatekeeper"?"THE GATEKEEPER":J==="swarmQueen"?"THE SWARM QUEEN":"THE TWIN GUARDIANS",Me=e.add([e.text(fe,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Me.exists()&&e.destroy(Me)})}}e.get("boss").length===0&&!F&&(F=!0,Pn());return}if(pt&&!Et&&e.time()-fi>=1){Et=!0;const be=ul(s),J=ct.filter(Ue=>Ue.direction!==de.entryDirection),le=J.length>0?J:ct,ce=le[Math.floor(Math.random()*le.length)],ve=ce.pos.x,fe=ce.pos.y;_p(e,ve,fe,be,s);const Me={brute:"MINIBOSS: BRUTE",sentinel:"MINIBOSS: SENTINEL",berserker:"MINIBOSS: BERSERKER",guardian:"MINIBOSS: GUARDIAN",warlock:"MINIBOSS: WARLOCK"},Ee=e.add([e.text(Me[be]||"MINIBOSS",{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{Ee.exists()&&e.destroy(Ee)})}const S=e.get("enemy").length,oe=e.get("miniboss").length;if(Oe>=we&&S===0&&oe===0&&!F&&(F=!0,Pn()),Oe<we){if(Ds+=e.dt(),Oe===0&&Ds<it)return;if(Ds>=xl)if(Ds=0,Oe++,ct.length>0){const be=e.time()-fi,le=de.entryDirection&&be<Ft?ct.filter(tt=>tt.direction!==de.entryDirection):ct,ce=le.length>0?le:ct,ve=ce[Math.floor(Math.random()*ce.length)],fe=ve.pos.x,Me=ve.pos.y,Ee=15,Ue=fe+(Math.random()-.5)*Ee,nt=Me+(Math.random()-.5)*Ee,Ke=nn(s);vo(e,Ue,nt,Ke,s)}else{const be=e.rand(0,4);let J,le;switch(Math.floor(be)){case 0:J=e.rand(E,e.width()-E),le=E;break;case 1:J=e.width()-E,le=e.rand(E,e.height()-E);break;case 2:J=e.rand(E,e.width()-E),le=e.height()-E;break;case 3:J=E,le=e.rand(E,e.height()-E);break}const ce=nn(s);vo(e,J,le,ce,s)}}}),e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(S=>{if(S.hp()<=0&&!S.isDead){S.isDead=!0;const oe=S.xpValue,ie=S.pos.x,ge=S.pos.y;if(S.cleanupHealthBars&&S.cleanupHealthBars(),S.explodes&&S.explosionRadius){const ce=S.explosionRadius,ve=S.explosionDamage||15;r.exists()&&Math.sqrt(Math.pow(r.pos.x-ie,2)+Math.pow(r.pos.y-ge,2))<=ce&&r.takeDamage(ve),e.get("enemy").forEach(fe=>{if(fe===S||!fe.exists())return;Math.sqrt(Math.pow(fe.pos.x-ie,2)+Math.pow(fe.pos.y-ge,2))<=ce&&fe.hurt(ve)}),Ls(e,ie,ge,{color:[255,150,50]})}else Ls(e,ie,ge,{color:[255,100,100]});if(S.shrapnel&&S.shrapnelCount){const ce=S.shrapnelCount,ve=Math.PI*2/ce,fe=250,Me=Math.floor((S.explosionDamage||15)*.6);for(let Ee=0;Ee<ce;Ee++){const Ue=ve*Ee,nt=e.vec2(Math.cos(Ue),Math.sin(Ue)),Ke=kt(e,ie,ge,nt,fe,Me,0,0,!1);Ke.isEnemyProjectile=!0,Ke.color=e.rgb(...S.originalColor)}}e.destroy(S),pa(),Bt.enemiesKilled++,hs(e,ie,ge,oe);const be=Math.floor(Math.random()*3)+1,J=1;for(let ce=0;ce<be;ce++){const ve=(Math.random()-.5)*20,fe=(Math.random()-.5)*20;ds(e,ie+ve,ge+fe,J)}const le=gp(S.type,s);if(le){const ce=(Math.random()-.5)*30,ve=(Math.random()-.5)*30;aa(e,ie+ce,ge+ve,le)}}}),e.get("miniboss").forEach(S=>{if(S.hp()<=0&&!S.isDead){S.isDead=!0;const oe=S.xpValue,ie=S.pos.x,ge=S.pos.y;Ls(e,ie,ge,{color:[255,150,100],isMiniboss:!0}),e.destroy(S),pa(),Bt.enemiesKilled++,hs(e,ie,ge,oe);const be=Math.floor(Math.random()*6)+10,J=1;for(let ce=0;ce<be;ce++){const ve=Math.PI*2/be*ce,fe=30+Math.random()*20,Me=Math.cos(ve)*fe,Ee=Math.sin(ve)*fe;ds(e,ie+Me,ge+Ee,J)}const le=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(ie,ge-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{le.exists()&&e.destroy(le)})}}),e.get("boss").forEach(S=>{if(S.hp()<=0&&!S.isDead){S.isDead=!0;const oe=S.xpValue,ie=S.pos.x,ge=S.pos.y;Ls(e,ie,ge,{color:[255,200,100],isBoss:!0}),e.destroy(S),o0(),Bt.enemiesKilled++,Bt.bossesKilled++,hs(e,ie,ge,oe);const be=Math.floor(Math.random()*11)+20,J=1,le=kr();for(let ve=0;ve<be;ve++){const fe=Math.PI*2/be*ve,Me=40+Math.random()*30,Ee=Math.cos(fe)*Me,Ue=Math.sin(fe)*Me;ds(e,ie+Ee,ge+Ue,J,le)}const ce=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(ie,ge-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{ce.exists()&&e.destroy(ce)})}}))}),e.onUpdate(()=>{!r.exists()||e.paused||e.get("xpPickup").forEach(S=>{if(S.collected)return;const oe=e.vec2(r.pos.x-S.pos.x,r.pos.y-S.pos.y).len();if(!S.magnetizing&&oe<=r.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=r),oe<=$e.COLLECTION_RADIUS){S.collected=!0,Zp(),r.addXP(S.value);const ie=e.add([e.text("+",{size:12}),e.pos(S.pos.x,S.pos.y),e.color(100,200,255),e.fixed(),e.z(B.UI_TEXT+1)]),ge=e.width()/2,be=I+O/2,J=.4;let le=0;const ce=S.pos.x,ve=S.pos.y;ie.onUpdate(()=>{le+=e.dt();const fe=Math.min(le/J,1),Me=fe*fe;ie.pos.x=ce+(ge-ce)*Me,ie.pos.y=ve+(be-ve)*Me,ie.opacity=1-fe*.5,ie.scale=e.vec2(1-fe*.5),fe>=1&&(e.destroy(ie),R.color=e.rgb(150,230,255),e.wait(.1,()=>{R.exists()&&(R.color=e.rgb(100,200,255))}))}),e.destroy(S)}})}),e.onUpdate(()=>{!r.exists()||e.paused||(e.get("currencyPickup").forEach(S=>{if(S.collected)return;const oe=e.vec2(r.pos.x-S.pos.x,r.pos.y-S.pos.y).len();if(!S.magnetizing&&oe<=r.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=r),oe<=$e.COLLECTION_RADIUS){S.collected=!0,fa(),Zi(S.value);const ie=e.add([e.text("$",{size:10}),e.pos(S.pos.x,S.pos.y),e.color(255,215,0),e.fixed(),e.z(B.UI_TEXT+1)]),ge=e.width()-20,be=20,J=.5;let le=0;const ce=S.pos.x,ve=S.pos.y;ie.onUpdate(()=>{le+=e.dt();const fe=Math.min(le/J,1),Me=fe*fe;ie.pos.x=ce+(ge-ce)*Me,ie.pos.y=ve+(be-ve)*Me,ie.opacity=1,fe>=1&&(e.destroy(ie),v.scale=e.vec2(1.3),D.scale=e.vec2(1.2),e.wait(.15,()=>{v.exists()&&(v.scale=e.vec2(1)),D.exists()&&(D.scale=e.vec2(1))}))}),e.destroy(S)}}),e.get("powerupWeaponPickup").forEach(S=>{if(S.collected)return;const oe=e.vec2(r.pos.x-S.pos.x,r.pos.y-S.pos.y).len();if(!S.magnetizing&&oe<=r.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=r),oe<=$e.COLLECTION_RADIUS){S.collected=!0,fa(),mp(r,S.powerupKey);const ie=So[S.powerupKey],ge=e.add([e.text(ie.icon,{size:32}),e.pos(r.pos.x,r.pos.y-30),e.color(...ie.color),e.anchor("center"),e.z(B.UI_TEXT+1),e.opacity(1)]);let be=0;ge.onUpdate(()=>{be+=e.dt(),ge.pos.y-=50*e.dt(),ge.opacity=Math.max(0,1-be/.8),be>=.8&&e.destroy(ge)}),e.destroy(S)}}))});let gi=!1;e.onUpdate(()=>{!r.exists()||e.paused||gi||e.get("door").forEach(S=>{if(!S.open||gi||S.isSpawnDoor||S.blocked)return;e.vec2(r.pos.x-S.pos.x,r.pos.y-S.pos.y).len()<=40&&(gi=!0,e0(),wl(S.direction))})});function yl(){if(!r.exists())return;const S=e.width()/2,oe=e.height()/2,ie=5,ge=3,be=Z?3:1,J=Z?4:1,le=s*.5,ce=Math.floor((ie+le)*be),ve=Math.floor((ge+le)*J);for(let fe=0;fe<ce;fe++){const Me=Math.PI*2*fe/ce+Math.random()*.3,Ee=40+Math.random()*60,Ue=S+Math.cos(Me)*Ee,nt=oe+Math.sin(Me)*Ee,Ke=Math.floor(1+s*.5);hs(e,Ue,nt,Ke)}for(let fe=0;fe<ve;fe++){const Me=Math.PI*2*fe/ve+Math.random()*.3+.5,Ee=50+Math.random()*70,Ue=S+Math.cos(Me)*Ee,nt=oe+Math.sin(Me)*Ee,Ke=Math.floor(1+s*.3);ds(e,Ue,nt,Ke)}if(Z){const fe=Object.keys(So),Me=1+Math.floor(Math.random()*2);for(let Ee=0;Ee<Me;Ee++){const Ue=Math.random()*Math.PI*2,nt=80+Math.random()*40,Ke=S+Math.cos(Ue)*nt,tt=oe+Math.sin(Ue)*nt,yi=fe[Math.floor(Math.random()*fe.length)];aa(e,Ke,tt,yi)}}}function Pn(){o.roomCleared=!0,o.clearRoom(),console.log("[Game] Room cleared:",{floor:o.currentFloor,room:o.currentRoom,cleared:o.roomCleared}),Bt.roomsCleared++,de.floorMap&&A&&de.floorMap.markRoomCleared(A.position.x,A.position.y),ct.forEach(ie=>{ie.exists()&&!ie.blocked&&(ie.open=!0,ie.isSpawnDoor=!1,ie.updateVisual())}),de.minimap&&de.minimap.update(),yl();const S=Z?`BOSS DEFEATED! Floor ${s} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",oe=e.add([e.text(S,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{oe.exists()&&e.destroy(oe)})}function wl(S){de.playerStats={level:r.level,xp:r.xp,xpToNext:r.xpToNext,maxHealth:r.maxHealth,currentHP:r.hp(),speed:r.speed,fireRate:r.fireRate,projectileSpeed:r.projectileSpeed,projectileDamage:r.projectileDamage,pickupRadius:r.pickupRadius,xpMultiplier:r.xpMultiplier||1,projectileCount:r.projectileCount||1,piercing:r.piercing||0,obstaclePiercing:r.obstaclePiercing||0,critChance:r.critChance||0,critDamage:r.critDamage||2,spreadAngle:r.spreadAngle||0,defense:r.defense||0,selectedUpgrades:r.selectedUpgrades?Array.from(r.selectedUpgrades):[],activeSynergies:r.activeSynergies?Array.from(r.activeSynergies):[],piercingDamageBonus:r.piercingDamageBonus||1};const oe={north:"south",south:"north",west:"east",east:"west"};if(de.entryDirection=oe[S]||null,de.floorMap){const ge={north:"up",south:"down",east:"right"}[S];ge?de.floorMap.moveToRoom(ge)?(de.floorMap.getCurrentRoom().isBossRoom&&console.log("[Game] Boss room reached - floor complete after this room"),i=de.floorMap.getVisitedCount()):(console.error("[Game] Failed to move in floor map - should not happen!"),i++):(console.warn("[Game] Invalid door direction:",S),i++),A&&A.isBossRoom&&A.cleared?(s++,oa(s-1).then(be=>{if(be){const J=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{J.exists()&&e.destroy(J)})}}),de.floorMap=null,de.entryDirection=null,o.nextFloor(),console.log("[Game] Advanced to next floor:",o.currentFloor)):(o.nextRoom(),console.log("[Game] Advanced to next room:",{floor:o.currentFloor,room:o.currentRoom}))}else i++,i>3?(s++,oa(s-1).then(ie=>{if(ie){const ge=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{ge.exists()&&e.destroy(ge)})}}),i=1,de.entryDirection=null,o.nextFloor(),console.log("[Game] Advanced to next floor:",o.currentFloor)):(o.nextRoom(),console.log("[Game] Advanced to next room:",{floor:o.currentFloor,room:o.currentRoom}));de.currentFloor=s,de.currentRoom=i,e.go("game")}r.onDeath(()=>{r.orbitalOrbs&&(r.orbitalOrbs.forEach(ie=>{ie.exists()&&e.destroy(ie)}),r.orbitalOrbs=[]);const S=Qu(Bt),oe={...Bt,level:r.level,currencyEarned:S};$u(oe),Zi(S),O0(e),ro()&&la(),e.go("gameOver",{runStats:{...Bt},currencyEarned:S})});const mi=e.add([e.rect(270,250),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(0,0,0),e.opacity(.9),e.outline(3,e.rgb(200,200,200)),e.fixed(),e.z(2e3),"pauseOverlay"]),xi=e.add([e.text("PAUSED",{size:48}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2001),"pauseText"]),Cs=e.height()/2,Is=60,Bn=200,On=40,Ln=e.add([e.rect(Bn,On),e.pos(e.width()/2,Cs-Is/2),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Resume",{size:18}),e.pos(e.width()/2,Cs-Is/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]);const zn=e.add([e.rect(Bn,On),e.pos(e.width()/2,Cs+Is/2),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Quit to Menu",{size:18}),e.pos(e.width()/2,Cs+Is/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]),mi.hidden=!0,xi.hidden=!0,e.get("pauseButton").forEach(S=>S.hidden=!0),Ln.onClick(()=>{!e.paused||Ln.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(ue=e.gameData.weaponDetailSavedState,te.hidden=!ue,X.hidden=!ue,$.hidden=!ue,ae.hidden=!ue,re.hidden=!ue,me.hidden=!ue,e.gameData.weaponDetailSavedState=void 0),ma(),mi.hidden=!0,xi.hidden=!0,e.get("pauseButton").forEach(S=>S.hidden=!0))}),zn.onClick(()=>{!e.paused||zn.hidden||(ro()&&la(),de.currentFloor=1,de.currentRoom=1,de.playerStats=null,e.go("menu"))}),e.onKeyPress("m",()=>{de.minimap&&!e.paused&&de.minimap.toggle()}),e.onKeyPress("escape",()=>{ya()||(e.paused=!e.paused,e.paused?(i0(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=ue)):(ma(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(ue=e.gameData.weaponDetailSavedState,te.hidden=!ue,X.hidden=!ue,$.hidden=!ue,ae.hidden=!ue,re.hidden=!ue,me.hidden=!ue,e.gameData.weaponDetailSavedState=void 0)),mi.hidden=!e.paused,xi.hidden=!e.paused,e.get("pauseButton").forEach(S=>S.hidden=!e.paused))})})}function Yo(e,t,o,s,i=Fo.WIDTH,a=Fo.HEIGHT,l=W.BUTTON){const c=C.SECONDARY,r=C.SECONDARY_HOVER,n=C.TEXT_PRIMARY,d=C.BORDER,u=!1,h=e.add([e.rect(i,a),e.pos(o,s),e.anchor("center"),e.color(...c),e.outline(2,e.rgb(...d)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS),"menuButton"]),x=ho(t),f=[];{const g=e.add([e.text(x,{size:l}),e.pos(o,s),e.anchor("center"),e.color(...n),e.fixed(),e.z(B.UI_TEXT),"menuButtonText"]);f.push(g)}const A=f[0];return h.originalColor=[...c],h.hoverColor=[...r],h.borderColor=[...d],h.isHovered=!1,h.disabled=u,h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,gt()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...C.BORDER_HOVER),h.scale=e.vec2(Fo.HOVER_SCALE,Fo.HOVER_SCALE),f.forEach(g=>g.scale=e.vec2(Fo.HOVER_SCALE,Fo.HOVER_SCALE)))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),f.forEach(g=>g.scale=e.vec2(1,1)))}),h.label=A,h.labels=f,h.setDisabled=g=>{h.disabled=g,g?(h.color=e.rgb(...C.BG_DISABLED),f.forEach(w=>w.color=e.rgb(...C.TEXT_DISABLED))):(h.color=e.rgb(...h.originalColor),f.forEach((w,E)=>{w.color=e.rgb(...n)}))},h}function $0(e){e.scene("menu",()=>{sl();const t=No();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...C.BG_DARK),e.z(B.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...C.BORDER),e.fixed(),e.z(B.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...C.BORDER),e.fixed(),e.z(B.UI_BACKGROUND)]),np(e);const o=20,s=20,i=188,a=24,l=3,c=10,r=c+a*4+l*3+60;e.add([e.rect(i,r),e.pos(o,s),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.BORDER)),e.fixed(),e.z(B.UI_BACKGROUND)]);const n=s+c,d=[];function u(){d.forEach(V=>{V.forEach(K=>{K.exists()&&e.destroy(K)})}),d.length=0,pp().forEach((V,K)=>{const te=n+K*(a+l),X=[],$=e.add([e.rect(i-20,a),e.pos(o+10,te),e.color(V.isEmpty?C.BG_DARK:C.BG_LIGHT),e.outline(1,e.rgb(...C.TEXT_DISABLED)),e.fixed(),e.z(B.UI_BACKGROUND+1),"partySlotUI"]);X.push($);const ae=e.add([e.text(`${V.slotNumber}`,{size:W.SMALL}),e.pos(o+20,te+a/2),e.anchor("left"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT),"partySlotUI"]);X.push(ae);const re=e.add([e.text(V.playerName,{size:W.SMALL-2}),e.pos(o+45,te+a/2),e.anchor("left"),e.color(V.isEmpty?C.TEXT_DISABLED:V.isLocal?C.GOLD:C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT),"partySlotUI"]);if(X.push(re),V.isLocal){const me=e.add([e.text("(You)",{size:W.SMALL-4}),e.pos(o+i-20,te+a/2),e.anchor("right"),e.color(...C.GOLD),e.fixed(),e.z(B.UI_TEXT),"partySlotUI"]);X.push(me)}d.push(X)})}u();let h=0;e.onUpdate(()=>{h+=e.dt(),h>=1&&(h=0,u())});const x=n+4*(a+l)+10;e.add([e.text("Invite Code:",{size:W.SMALL-2}),e.pos(o+10,x),e.anchor("left"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),Vo();const f=e.add([e.text("OFFLINE",{size:W.SMALL-2}),e.pos(o+i-10,x),e.anchor("right"),e.color(...C.TEXT_DISABLED),e.fixed(),e.z(B.UI_TEXT)]);let A=!1;f.onUpdate(()=>{if(!A&&fp()){const se=Vo();se!=="OFFLINE"&&(f.text=se,f.color=e.rgb(...C.GOLD),f.textSize=W.SMALL,A=!0)}});const g=x+25;Yo(e,"JOIN PARTY",o+i/2,g,120,30,W.SMALL-2).onClick(()=>{Yt(),e.go("joinParty")}),Dn(e,t);const E=130,T=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],q=[],U=12,p=E-T.length*U/2;T.forEach((se,V)=>{const K=e.add([e.text(se,{size:10,font:"monospace"}),e.pos(e.width()/2,p+V*U),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.z(B.UI_TEXT),"titleLine"]);q.push(K)});let y=0;e.onUpdate(()=>{y+=e.dt(),q.forEach((se,V)=>{const K=(y*50+V*20)%360,te=b(K,80,60);se.color=e.rgb(...te);const X=Math.sin(y*2+V*.3)*2;se.pos.y=p+V*U+X,Math.random()<.001&&(se.pos.x=e.width()/2+(Math.random()-.5)*10,e.wait(.1,()=>{se.exists()&&(se.pos.x=e.width()/2)}))})});function b(se,V,K){V/=100,K/=100;const te=(1-Math.abs(2*K-1))*V,X=te*(1-Math.abs(se/60%2-1)),$=K-te/2;let ae=0,re=0,me=0;return se>=0&&se<60?(ae=te,re=X,me=0):se>=60&&se<120?(ae=X,re=te,me=0):se>=120&&se<180?(ae=0,re=te,me=X):se>=180&&se<240?(ae=0,re=X,me=te):se>=240&&se<300?(ae=X,re=0,me=te):se>=300&&se<360&&(ae=te,re=0,me=X),[Math.round((ae+$)*255),Math.round((re+$)*255),Math.round((me+$)*255)]}const v=280,D=w0.BUTTON_VERTICAL,P=e.width()/2,O=Yo(e,"Start Game",P,v,350,55,W.HEADER);O.onClick(()=>{Yt(),Qr()>1&&hp(),e.go("game",{resetState:!0})});const I=Yo(e,"Character Select",P,v+D,350,50,W.BUTTON);I.onClick(()=>{Yt(),e.go("characterSelect")});const R=Es(),N=Ao[R];if(N){const se=Wt("characters",R)||N.unlockedByDefault,V=P+175+60,K=v+D,te=50;e.add([e.rect(te,te),e.pos(V,K),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.BORDER)),e.fixed(),e.z(B.UI_BACKGROUND)]),e.add([e.text(N.char,{size:36}),e.pos(V,K),e.anchor("center"),e.color(...se?N.color:C.BG_DISABLED),e.fixed(),e.z(B.UI_TEXT)]),e.add([e.text(N.name,{size:W.SMALL-2}),e.pos(V,K+35),e.anchor("center"),e.color(...se?C.TEXT_PRIMARY:C.TEXT_DISABLED),e.fixed(),e.z(B.UI_TEXT)])}const Y=Yo(e,"Shop",P,v+D*2,350,50,W.BUTTON);Y.onClick(()=>{Yt(),e.go("shop")});const j=Yo(e,"Statistics",P,v+D*3,350,50,W.BUTTON);j.onClick(()=>{Yt(),e.go("statistics")});const k=Yo(e,"Options",P,v+D*4,350,50,W.BUTTON);k.onClick(()=>{Yt(),e.go("settings")});const G=[O,I,Y,j,k];let Q=0;e.onUpdate(()=>{Q+=e.dt(),G.forEach((se,V)=>{if(!se.exists()||se.isHovered)return;const K=(Q*60+V*50)%360,te=b(K,70,50);try{const X=e.rgb(te[0],te[1],te[2]);se.color=X,se.originalColor=te}catch(X){console.error("Color update error:",X)}})});const pe=e.onKeyPress("space",()=>{Yt(),e.go("game",{resetState:!0})}),ee=e.onKeyPress("c",()=>{gt(),e.go("characterSelect")}),De=e.onKeyPress("s",()=>{gt(),e.go("shop")}),ye=e.onKeyPress("o",()=>{gt(),e.go("settings")}),Se=e.onKeyPress("t",()=>{gt(),e.go("statistics")});e.onSceneLeave(()=>{pe.cancel(),ee.cancel(),De.cancel(),ye.cancel(),Se.cancel()});const Ae=[["<o>","(o)","<O>","(O)"],["~@~","^@^","~o~","^o^"],["[#]","{#}","<#>","(#)"],["===","---","___","~~~"],["<>","><","^v","vA"]];for(let se=0;se<8;se++){const V=Ae[Math.floor(Math.random()*Ae.length)],K=e.add([e.text(V[0],{size:16,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...C.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(B.PARTICLES)]);K.speed=30+Math.random()*50,K.direction=Math.random()<.5?1:-1,K.animFrame=0,K.creatureSet=V,K.onUpdate(()=>{K.pos.x+=K.speed*K.direction*e.dt(),K.animFrame+=e.dt()*4;const te=Math.floor(K.animFrame)%K.creatureSet.length;K.text=K.creatureSet[te],K.direction>0&&K.pos.x>e.width()+50?(K.pos.x=-50,K.pos.y=Math.random()*e.height()):K.direction<0&&K.pos.x<-50&&(K.pos.x=e.width()+50,K.pos.y=Math.random()*e.height())})}for(let se=0;se<15;se++){const V="01".split(""),K=e.add([e.text(V[Math.floor(Math.random()*V.length)],{size:14,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(50+Math.random()*50,100+Math.random()*100,50+Math.random()*50),e.opacity(.2+Math.random()*.3),e.z(B.PARTICLES)]);K.speed=40+Math.random()*80,K.charChangeTimer=0,K.chars=V,K.onUpdate(()=>{K.pos.y+=K.speed*e.dt(),K.charChangeTimer+=e.dt(),K.charChangeTimer>.1&&(K.text=K.chars[Math.floor(Math.random()*K.chars.length)],K.charChangeTimer=0),K.pos.y>e.height()&&(K.pos.y=-20,K.pos.x=Math.random()*e.width())})}const Ce=["","","","","","","",""];for(let se=0;se<12;se++){const V=e.add([e.text(Ce[Math.floor(Math.random()*Ce.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...C.BG_LIGHT),e.opacity(.15),e.z(B.PARTICLES)]);V.pulseTime=Math.random()*Math.PI*2,V.pulseSpeed=1+Math.random()*2,V.onUpdate(()=>{V.pulseTime+=e.dt()*V.pulseSpeed;const K=.8+Math.sin(V.pulseTime)*.3;V.scale=e.vec2(K,K),V.opacity=.1+Math.abs(Math.sin(V.pulseTime))*.15})}for(let se=0;se<20;se++){const V=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...C.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(B.PARTICLES)]);V.speed=10+Math.random()*20,V.onUpdate(()=>{V.pos.y+=V.speed*e.dt(),V.pos.y>e.height()&&(V.pos.y=0,V.pos.x=Math.random()*e.width())})}const Pe=[];e.loop(5,()=>{if(Pe.length<3&&Math.random()<.3){const se=["","","","","","",""],V=e.add([e.text(se[Math.floor(Math.random()*se.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(B.PARTICLES)]);V.followSpeed=20+Math.random()*30,V.rotationSpeed=50+Math.random()*100,V.lifetime=15+Math.random()*10,V.onUpdate(()=>{const te=e.mousePos().sub(V.pos),X=te.len();if(X>5){const $=te.scale(1/X);V.pos=V.pos.add($.scale(V.followSpeed*e.dt()))}if(V.angle+=V.rotationSpeed*e.dt(),V.lifetime-=e.dt(),V.lifetime<=0){e.destroy(V);const $=Pe.indexOf(V);$>-1&&Pe.splice($,1)}}),Pe.push(V)}}),e.loop(10,()=>{if(Math.random()<.15){const se=100+Math.random()*(e.height()-200),V=Math.random()<.5?1:-1,K=V>0?-50:e.width()+50,te=e.add([e.text("$",{size:24}),e.pos(K,se),e.color(...C.GOLD),e.area({scale:2.5}),e.anchor("center"),e.z(B.PARTICLES+1),"goldenEnemy"]);te.speed=150+Math.random()*100,te.direction=V,te.pulseTime=0,te.onClick(()=>{if(!te.exists())return;Zi(1);for(let $=0;$<12;$++){const ae=Math.PI*2*$/12,re=e.add([e.text(["$","","",""][Math.floor(Math.random()*4)],{size:14}),e.pos(te.pos.x,te.pos.y),e.color(...C.GOLD),e.z(B.PARTICLES+2)]),me=100+Math.random()*100;re.velocity=e.vec2(Math.cos(ae)*me,Math.sin(ae)*me),re.life=1,re.onUpdate(()=>{re.pos=re.pos.add(re.velocity.scale(e.dt())),re.life-=e.dt(),re.opacity=re.life,re.life<=0&&e.destroy(re)})}const X=e.add([e.text("+$1",{size:20}),e.pos(te.pos.x,te.pos.y),e.anchor("center"),e.color(...C.SUCCESS),e.z(B.UI_TEXT)]);X.life=1.5,X.onUpdate(()=>{X.pos.y-=50*e.dt(),X.life-=e.dt(),X.opacity=X.life/1.5,X.life<=0&&e.destroy(X)}),e.destroy(te),e.wait(.1,()=>e.go("menu"))}),te.onUpdate(()=>{te.pos.x+=te.speed*te.direction*e.dt(),te.pulseTime+=e.dt();const X=Math.sin(te.pulseTime*8)*.2;te.scale=e.vec2(1+X,1+X),(te.direction>0&&te.pos.x>e.width()+100||te.direction<0&&te.pos.x<-100)&&e.destroy(te)})}})})}function J0(e){e.scene("gameOver",t=>{const o=(t==null?void 0:t.runStats)||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},s=(t==null?void 0:t.currencyEarned)||0,i=No(),a=Yu(),l=Mn();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...C.BG_DARK),e.opacity(.95),e.fixed(),e.z(B.OVERLAY)]),e.add([e.text("Game Over",{size:48}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...C.DANGER),e.fixed(),e.z(B.MODAL)]);const c=160,r=30;e.add([e.text("Run Statistics",{size:W.HEADER}),e.pos(e.width()/2,c),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`${Io.FLOOR}s Reached: ${o.floorsReached}`,{size:W.LABEL}),e.pos(e.width()/2,c+r),e.anchor("center"),e.color(...C.INFO),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`${Io.ROOM}s Cleared: ${o.roomsCleared}`,{size:W.LABEL}),e.pos(e.width()/2,c+r*2),e.anchor("center"),e.color(...C.INFO),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`Enemies Killed: ${o.enemiesKilled}`,{size:W.LABEL}),e.pos(e.width()/2,c+r*3),e.anchor("center"),e.color(...C.INFO),e.fixed(),e.z(B.MODAL)]),o.bossesKilled>0&&e.add([e.text(`Bosses Defeated: ${o.bossesKilled}`,{size:W.LABEL}),e.pos(e.width()/2,c+r*4),e.anchor("center"),e.color(...C.BOSS_NAME),e.fixed(),e.z(B.MODAL)]);const n=c+r*(o.bossesKilled>0?6:5);e.add([e.text(`${l} Earned: +${s}`,{size:W.BUTTON}),e.pos(e.width()/2,n),e.anchor("center"),e.color(...C.SUCCESS),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`Total ${l}: ${i}`,{size:W.LABEL}),e.pos(e.width()/2,n+30),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.MODAL)]);const d=n+80;e.add([e.text("Lifetime Stats",{size:W.BUTTON}),e.pos(e.width()/2,d),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text(`Best ${Io.FLOOR}: ${a.stats.bestFloor} | Total Runs: ${a.stats.totalRuns}`,{size:W.BODY}),e.pos(e.width()/2,d+25),e.anchor("center"),e.color(...C.TEXT_TERTIARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text("Press SPACE to Restart",{size:W.HEADER}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...C.TEXT_TERTIARY),e.fixed(),e.z(B.MODAL)]),e.add([e.text("Press T for Statistics | ESC to Return to Menu",{size:W.BODY}),e.pos(e.width()/2,e.height()-30),e.anchor("center"),e.color(...C.TEXT_DISABLED),e.fixed(),e.z(B.MODAL)]),e.onKeyPress("space",()=>{Yt(),e.go("game",{resetState:!0})}),e.onKeyPress("t",()=>{gt(),e.go("statistics")}),e.onKeyPress("escape",()=>{gt(),e.go("menu")})})}function Q0(e){e.scene("shop",()=>{const t=No(),o=Mn();let s="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...C.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),hi(e,{patternCount:10,particleCount:15}),e.add([e.text(ho("Shop"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const i=Dn(e,t),a=90,l=120,c=100,r=30,n=[{key:"permanentUpgrades",label:"Upgrades"},{key:"characters",label:"Characters"},{key:"weapons",label:"Weapons"}],d=(n.length-1)*l,u=e.width()/2-d/2,h=[];n.forEach((p,y)=>{const b=u+y*l,v=s===p.key,D=e.add([e.rect(c,r),e.pos(b,a),e.anchor("center"),e.color(...v?C.SECONDARY:C.BG_MEDIUM),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),P=e.add([e.text(p.label,{size:W.BODY}),e.pos(b,a),e.anchor("center"),e.color(...v?C.TEXT_PRIMARY:C.TEXT_TERTIARY),e.fixed(),e.z(B.UI_TEXT)]);D.onClick(()=>{gt(),s=p.key,w()}),h.push({bg:D,label:P,category:p.key})});const x=140,f=e.height()-x-60;let A=[],g=!1;function w(){const p=No();i.updateCurrency(p),h.forEach(R=>{const N=s===R.category;R.bg.color=e.rgb(N?100:50,N?100:50,N?150:80),R.label.color=e.rgb(N?255:150,N?255:150,N?255:150)}),q(),A.forEach(R=>{R.exists()&&e.destroy(R)}),A=[];const y=Kr(s),v=Object.keys(y).filter(R=>{const N=y[R];return s==="permanentUpgrades"?!0:!N.unlockedByDefault});if(v.length===0){const R=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,x+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);A.push(R);return}const D=100,P=x+20,O=Math.floor(f/D),I=Math.min(O,v.length);v.forEach((R,N)=>{const Y=y[R],j=Math.floor(N/I),k=N%I,G=50+j*350,Q=P+k*D,pe=s==="characters"&&Wt("characters",R),ee=pe?e.rgb(100,255,100):e.rgb(80,80,100),De=e.add([e.rect(320,90),e.pos(G,Q),e.anchor("topleft"),e.color(40,40,50),e.outline(2,ee),e.area(),e.fixed(),e.z(1e3)]);if(s==="characters"&&Y.char){const $=e.add([e.text(Y.char,{size:32}),e.pos(G+25,Q+45),e.anchor("center"),e.color(...pe&&Y.color?Y.color:[100,100,100]),e.fixed(),e.z(1001)]);A.push($)}const ye=s==="characters"&&Y.char?G+70:G+10,Se=e.add([e.text(Y.name,{size:18}),e.pos(ye,Q+10),e.anchor("topleft"),e.color(255,255,255),e.fixed(),e.z(1001)]),Ae=s==="characters"&&Y.char?G+70:G+10,Ce=s==="characters"&&Y.char?230:300,Pe=e.add([e.text(Y.description,{size:14,width:Ce}),e.pos(Ae,Q+35),e.anchor("topleft"),e.color(200,200,200),e.fixed(),e.z(1001)]);function se($){const ae=[50,65,90,115,160];return $<ae.length?ae[$]:160+($-4)*50}let V="",K=!1,te=Y.cost;if(s==="permanentUpgrades"){const $=no(R),ae=Y.maxLevel||1;$>=ae?V=`MAX (${$}/${ae})`:(V=`Level ${$}/${ae}`,te=se($),K=t>=te)}else s==="characters"?Wt("characters",R)||(K=t>=te):Wt(s,R)?V="UNLOCKED":K=t>=te;let X=null;if(V&&s!=="characters"){const $=s==="characters"&&Y.char?G+70:G+10;X=e.add([e.text(V,{size:14}),e.pos($,Q+60),e.anchor("topleft"),e.color(Wt(s,R)||s==="permanentUpgrades"&&no(R)>0?100:200,Wt(s,R)||s==="permanentUpgrades"&&no(R)>0?255:200,Wt(s,R)||s==="permanentUpgrades"&&no(R)>0?100:200),e.fixed(),e.z(1001)])}if(K||s==="permanentUpgrades"&&no(R)<(Y.maxLevel||1)){const $=e.add([e.rect(80,30),e.pos(G+230,Q+55),e.anchor("topleft"),e.color(K?50:30,K?150:30,K?50:30),e.outline(2,e.rgb(K?100:50,K?200:50,K?100:50)),e.area(),e.fixed(),e.z(1001)]),ae=e.add([e.text(`$${te}`,{size:14}),e.pos(G+270,Q+70),e.anchor("center"),e.color(K?255:150,K?255:150,K?255:150),e.fixed(),e.z(1002)]);K&&$.onClick(()=>{if(g)return;g=!0;let re;if(s==="permanentUpgrades"?re=ju(R,te,Y.maxLevel):re=Ku(s,R,te),s==="permanentUpgrades")if(re&&re.success){Ri();const me=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{me.exists()&&e.destroy(me)}),w(),g=!1}else if(re&&re.reason==="insufficientCurrency"){Ti();const me=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{me.exists()&&e.destroy(me)}),g=!1}else g=!1;else if(re){Ri();const me=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{me.exists()&&e.destroy(me)}),w(),g=!1}else{Ti();const me=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{me.exists()&&e.destroy(me)}),g=!1}}),A.push($,ae)}A.push(De,Se,Pe),X&&A.push(X)})}let E=null,T=null;function q(){const p=Fr();s==="permanentUpgrades"&&p>0?E?(T.text=`REFUND: $${p}`,E.hidden=!1,T.hidden=!1):(E=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),T=e.add([e.text(`REFUND: $${p}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(B.UI_TEXT)]),E.onClick(()=>{Wu().success?(Ri(),w()):Ti()})):E&&(E.hidden=!0,T&&(T.hidden=!0))}w();const U=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.NEUTRAL),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text(ho("Back"),{size:W.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),U.onClick(()=>{gt(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const ll="superSmashTexty_settings",oi={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:1},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showDamageNumbers:!0,compactHUD:!1},gameplay:{autoPause:!1}};function cl(){try{const e=localStorage.getItem(ll);if(e){const t=JSON.parse(e);return hl(oi,t)}}catch(e){console.error("Error loading settings:",e)}return{...oi}}function hl(e,t){const o={...e};return Ii(e)&&Ii(t)&&Object.keys(t).forEach(s=>{Ii(t[s])?s in e?o[s]=hl(e[s],t[s]):Object.assign(o,{[s]:t[s]}):Object.assign(o,{[s]:t[s]})}),o}function Ii(e){return e&&typeof e=="object"&&!Array.isArray(e)}function dl(e){try{return localStorage.setItem(ll,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function Sa(){return cl()}function xo(e,t,o){const s=cl();return s[e]||(s[e]={}),s[e][t]=o,dl(s),s}function Z0(){return dl({...oi}),{...oi}}function k0(e,t){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(B.OVERLAY)]),a=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(3,e.rgb(...C.BORDER)),e.fixed(),e.z(B.OVERLAY+1)]),l=[];function c(){l.forEach(A=>{A&&A.exists&&A.exists()&&e.destroy(A)})}const r=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(B.OVERLAY+2)]),n=e.add([e.text("Cancel",{size:W.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+3)]);r.onClick(()=>{c()}),l.push(o,a,r,n);const d=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(B.OVERLAY+2)]),u=e.add([e.text("Reset",{size:W.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(B.OVERLAY+3)]);d.onClick(()=>{c(),t()}),l.push(d,u);const h=e.add([e.text("Reset to Defaults?",{size:W.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]);l.push(h);const x=e.add([e.text("This will reset all settings to their default values.",{size:W.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.OVERLAY+2)]);l.push(x);const f=e.onKeyPress("escape",()=>{c(),f.cancel()})}function ef(e,t,o){const s=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(B.OVERLAY)]),l=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(3,e.rgb(...C.BORDER)),e.fixed(),e.z(B.OVERLAY+1)]);e.add([e.text("Edit Player Name",{size:W.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+2)]);const c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...C.BG_LIGHT),e.outline(2,e.rgb(...C.GOLD)),e.fixed(),e.z(B.OVERLAY+2)]);let r=t;const n=e.add([e.text(r,{size:W.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.OVERLAY+3)]),d=e.add([e.text("(Max 20 characters)",{size:W.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.OVERLAY+2)]);function u(){e.destroy(s),e.destroy(l),c.destroy(),n.destroy(),d.destroy()}const h=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(B.OVERLAY+2)]);e.add([e.text("Cancel",{size:W.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.OVERLAY+3)]),h.onClick(()=>{u()});const x=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.GOLD)),e.area(),e.fixed(),e.z(B.OVERLAY+2)]);e.add([e.text("Save",{size:W.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.OVERLAY+3)]),x.onClick(()=>{r.trim().length>0?(o(r.trim()),u()):(d.text="Name cannot be empty!",d.color=e.rgb(255,100,100))}),e.onCharInput(f=>{r.length<20&&/[a-zA-Z0-9 ]/.test(f)&&(r+=f,n.text=r,d.text="(Max 20 characters)",d.color=e.rgb(...C.TEXT_SECONDARY))}),e.onKeyPress("backspace",()=>{r.length>0&&(r=r.slice(0,-1),n.text=r||" ")}),e.onKeyPress("escape",()=>{u()}),e.onKeyPress("enter",()=>{r.trim().length>0&&(o(r.trim()),u())})}function tf(e){e.scene("settings",t=>{const o=(t==null?void 0:t.fromGame)||!1;let s=Sa(),i="player";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...C.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),hi(e,{patternCount:10,particleCount:15}),e.add([e.text(ho("Options"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const a=90,l=120,c=100,r=30,n=[{key:"player",label:"Player"},{key:"audio",label:"Audio"},{key:"controls",label:"Controls"},{key:"visual",label:"Visual"},{key:"gameplay",label:"Gameplay"}],d=(n.length-1)*l,u=e.width()/2-d/2,h=[];n.forEach((p,y)=>{const b=u+y*l,v=i===p.key,D=e.add([e.rect(c,r),e.pos(b,a),e.anchor("center"),e.color(v?100:50,v?100:50,v?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),P=e.add([e.text(p.label,{size:16}),e.pos(b,a),e.anchor("center"),e.color(v?255:150,v?255:150,v?255:150),e.fixed(),e.z(B.UI_TEXT)]);D.onClick(()=>{i=p.key,w()}),h.push({bg:D,label:P,key:p.key})});const x=140,f=50,A=150;let g=[];function w(){h.forEach(b=>{const v=i===b.key;b.bg.color=e.rgb(v?100:50,v?100:50,v?150:80),b.label.color=e.rgb(v?255:150,v?255:150,v?255:150)}),g.forEach(b=>{b.exists()&&e.destroy(b)}),g=[],s=Sa();const p=x+20;let y=p;if(i==="player"){const b=e.add([e.text("Player Name:",{size:W.LABEL}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(b),y+=40;let v=En();const D=e.add([e.rect(300,40),e.pos(e.width()/2,y),e.anchor("center"),e.color(...C.BG_LIGHT),e.outline(2,e.rgb(...C.BORDER)),e.fixed(),e.z(B.UI_ELEMENTS)]),P=e.add([e.text(v,{size:W.LABEL}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.UI_TEXT)]);g.push(D,P),y+=60;const O=e.add([e.rect(140,35),e.pos(e.width()/2-80,y),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),I=e.add([e.text("Edit Name",{size:W.SMALL}),e.pos(e.width()/2-80,y),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);O.onClick(()=>{ef(e,v,Q=>{sa(Q),P.text=Q,v=Q})});const R=e.add([e.rect(140,35),e.pos(e.width()/2+80,y),e.anchor("center"),e.color(...C.BG_MEDIUM),e.outline(2,e.rgb(...C.GOLD)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),N=e.add([e.text("Randomize",{size:W.SMALL}),e.pos(e.width()/2+80,y),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.UI_TEXT)]);R.onClick(()=>{const Q=Ji();sa(Q),P.text=Q,v=Q}),g.push(O,I,R,N),y+=60;const Y=e.add([e.text("Your Invite Code:",{size:W.LABEL}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(Y),y+=40;const j=Vo(),k=e.add([e.text(j,{size:W.TITLE}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(k),y+=50;const G=e.add([e.text("Share this code with friends to join your party!",{size:W.SMALL-2}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(G)}else if(i==="audio")y=E(e,"Master Volume",s.audio.masterVolume,y,b=>{xo("audio","masterVolume",b)}),y=E(e,"SFX Volume",s.audio.sfxVolume,y,b=>{xo("audio","sfxVolume",b)}),y=E(e,"Music Volume",s.audio.musicVolume,y,b=>{xo("audio","musicVolume",b)});else if(i==="controls"){const b=s.controls,v=[{label:"Move Up",key:"moveUp",value:b.moveUp},{label:"Move Down",key:"moveDown",value:b.moveDown},{label:"Move Left",key:"moveLeft",value:b.moveLeft},{label:"Move Right",key:"moveRight",value:b.moveRight},{label:"Pause",key:"pause",value:b.pause},{label:"Interact",key:"interact",value:b.interact}];v.forEach((P,O)=>{const I=p+O*f,R=e.add([e.text(P.label+":",{size:16}),e.pos(150,I),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(B.UI_ELEMENTS)]),N=e.add([e.rect(100,30),e.pos(500,I),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(B.UI_ELEMENTS)]),Y=e.add([e.text(P.value.toUpperCase(),{size:16}),e.pos(500,I),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(B.UI_TEXT)]);g.push(R,N,Y)});const D=p+v.length*f;if(D<e.height()-A){const P=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,D+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(P)}}else if(i==="visual")y=T(e,"Show Particles",s.visual.showParticles,y,b=>{xo("visual","showParticles",b)}),y=T(e,"Show Screen Shake",s.visual.showScreenShake,y,b=>{xo("visual","showScreenShake",b)}),y=T(e,"Show Damage Numbers",s.visual.showDamageNumbers,y,b=>{xo("visual","showDamageNumbers",b)}),y=T(e,"Compact HUD",s.visual.compactHUD,y,b=>{xo("visual","compactHUD",b)});else if(i==="gameplay"&&(y=T(e,"Auto-pause on Level Up",s.gameplay.autoPause,y,b=>{xo("gameplay","autoPause",b)}),y<e.height()-A)){const b=e.add([e.text("(More gameplay options coming soon)",{size:12}),e.pos(e.width()/2,y+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(B.UI_ELEMENTS)]);g.push(b)}}function E(p,y,b,v,D){const P=p.add([p.text(y+":",{size:16}),p.pos(150,v),p.anchor("left"),p.color(200,200,200),p.fixed(),p.z(B.UI_ELEMENTS)]),O=300,I=20,R=p.add([p.rect(O,I),p.pos(500,v),p.anchor("center"),p.color(50,50,70),p.outline(2,p.rgb(100,100,120)),p.area(),p.fixed(),p.z(B.UI_ELEMENTS)]);function N(ye){if(ye<.5){const Se=ye*2;return{r:255,g:Math.round(255*Se),b:0}}else{const Se=(ye-.5)*2;return{r:Math.round(255*(1-Se)),g:255,b:0}}}const Y=O*b,j=N(b),k=p.add([p.rect(Y,I-4),p.pos(500-(O-Y)/2,v),p.anchor("center"),p.color(j.r,j.g,j.b),p.fixed(),p.z(B.UI_TEXT)]),G=500-O/2+Y,Q=p.add([p.rect(20,I+4),p.pos(G,v),p.anchor("center"),p.color(200,200,255),p.outline(2,p.rgb(150,150,200)),p.area(),p.fixed(),p.z(1002)]),pe=p.add([p.text(Math.round(b*100)+"%",{size:14}),p.pos(680,v),p.anchor("left"),p.color(255,255,255),p.fixed(),p.z(B.UI_ELEMENTS)]);let ee=!1;R.onClick(()=>{const ye=p.mousePos().x,Se=500-O/2,Ae=ye-Se,Ce=Math.max(0,Math.min(1,Ae/O));De(Ce)}),Q.onClick(()=>{ee=!0}),p.onMouseMove(()=>{if(ee&&p.isMouseDown()){const ye=p.mousePos().x,Se=500-O/2,Ae=ye-Se,Ce=Math.max(0,Math.min(1,Ae/O));De(Ce)}else ee=!1}),p.onMouseRelease(()=>{ee=!1});function De(ye){const Se=O*ye;k.width=Se,k.pos.x=500-(O-Se)/2,Q.pos.x=500-O/2+Se,pe.text=Math.round(ye*100)+"%";const Ae=N(ye);k.color=p.rgb(Ae.r,Ae.g,Ae.b),D(ye)}return g.push(P,R,k,Q,pe),v+f}function T(p,y,b,v,D){const P=p.add([p.text(y+":",{size:16,width:250}),p.pos(150,v),p.anchor("left"),p.color(200,200,200),p.fixed(),p.z(B.UI_ELEMENTS)]),O=60,R=p.add([p.rect(O,30),p.pos(500,v),p.anchor("center"),p.color(b?50:70,b?150:50,b?50:70),p.outline(2,p.rgb(100,100,120)),p.area(),p.fixed(),p.z(B.UI_ELEMENTS)]),N=24,Y=b?500+O/2-N/2-4:500-O/2+N/2+4,j=p.add([p.rect(N,N),p.pos(Y,v),p.anchor("center"),p.color(255,255,255),p.outline(1,p.rgb(200,200,200)),p.fixed(),p.z(B.UI_TEXT)]),k=p.add([p.text(b?"ON":"OFF",{size:14}),p.pos(500,v),p.anchor("center"),p.color(b?100:150,b?255:150,b?100:150),p.fixed(),p.z(1002)]);return R.onClick(()=>{const G=!b;R.color=p.rgb(G?50:70,G?150:50,G?50:70),j.pos.x=G?500+O/2-N/2-4:500-O/2+N/2+4,k.text=G?"ON":"OFF",k.color=p.rgb(G?100:150,G?255:150,G?100:150),D(G)}),g.push(P,R,j,k),v+f}const q=e.add([e.rect(150,35),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text("Reset to Defaults",{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(B.UI_TEXT)]),q.onClick(()=>{k0(e,()=>{Z0(),w()})}),w();const U=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.NEUTRAL),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text(ho("Back"),{size:W.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),U.onClick(()=>{o?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{o?e.go("game"):e.go("menu")})})}function Ra(e,t,o){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),o=Math.max(0,Math.min(1,o));let s,i,a;if(t===0)s=i=a=o;else{const l=(n,d,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?n+(d-n)*6*u:u<.5?d:u<.6666666666666666?n+(d-n)*(.6666666666666666-u)*6:n),c=o<.5?o*(1+t):o+t-o*t,r=2*o-c;s=l(r,c,e+1/3),i=l(r,c,e),a=l(r,c,e-1/3)}return[Math.max(0,Math.min(255,Math.round(s*255))),Math.max(0,Math.min(255,Math.round(i*255))),Math.max(0,Math.min(255,Math.round(a*255)))]}function of(e){e.scene("statistics",()=>{const t=Yr(),o=Ju(),s=Mn();let i="stats";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...C.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),hi(e,{patternCount:10,particleCount:15}),e.add([e.text(ho("Stats & Achievements"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const a=90,l=160,c=150,r=30,n=[{key:"stats",label:"Statistics"},{key:"achievements",label:"Achievements"}],d=(n.length-1)*l,u=e.width()/2-d/2,h=[];n.forEach((p,y)=>{const b=u+y*l,v=i===p.key,D=e.add([e.rect(c,r),e.pos(b,a),e.anchor("center"),e.color(...v?C.SECONDARY:C.BG_MEDIUM),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),P=e.add([e.text(p.label,{size:W.BODY}),e.pos(b,a),e.anchor("center"),e.color(...v?C.TEXT_PRIMARY:C.TEXT_TERTIARY),e.fixed(),e.z(B.UI_TEXT)]);D.onClick(()=>{i=p.key,q()}),h.push({bg:D,label:P,key:p.key})});const x=140,f=40,A=60,g=f+A,w=x,E=e.height()-g;let T=[];function q(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(h.forEach(p=>{const y=i===p.key;p.bg.color=e.rgb(y?100:50,y?100:50,y?150:80),p.label.color=e.rgb(y?255:150,y?255:150,y?255:150)}),T.forEach(p=>{if(p&&typeof p.exists=="function"&&p.exists())try{e.destroy(p)}catch(y){console.warn("Error destroying content item:",y)}}),T=[],i==="stats"){const p=x+20,y=30;[{label:"Total Runs",value:t.totalRuns||0},{label:"Best Floor",value:t.bestFloor||1},{label:"Best Room",value:t.bestRoom||1},{label:"Best Level",value:t.bestLevel||1},{label:"Total Enemies Killed",value:t.totalEnemiesKilled||0},{label:"Total Bosses Killed",value:t.totalBossesKilled||0},{label:"Total Rooms Cleared",value:t.totalRoomsCleared||0},{label:"Total Floors Reached",value:t.totalFloorsReached||0},{label:`Total ${s} Earned`,value:t.totalCurrencyEarned||0}].forEach((v,D)=>{const P=p+D*y,O=e.add([e.text(v.label+":",{size:18}),e.pos(200,P),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]),I=e.add([e.text(v.value.toString(),{size:18}),e.pos(500,P),e.anchor("left"),e.color(255,255,255),e.fixed(),e.z(1e3)]);T.push(O,I)})}else if(i==="achievements")try{const p=B0(),y=50,b=10,v=25,D=25,P=40,O=(e.width()-100-P)/2,I=E-w-20,R=50,N=e.width()/2+P/2;let Y=x+10,j=x+10;p.forEach((Pe,se)=>{const V=P0(Pe);if(V.length===0)return;const K=se%2===0,te=K?R:N;let X=K?Y:j;const $=Pe.charAt(0).toUpperCase()+Pe.slice(1),ae=e.add([e.text($,{size:18}),e.pos(te+O/2,X),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(1e3)]);T.push(ae),X+=D+5;const re=Math.max(1,Math.floor(O/(y+b))),ue=Math.min(re,V.length)*(y+b)-b,qe=te+(O-ue)/2;V.forEach((It,vt)=>{const je=o.includes(It.id),eo=Math.floor(vt/re),lt=vt%re,Ye=qe+lt*(y+b),wt=X+eo*(y+b);if(!isFinite(Ye)||!isFinite(wt)||Ye<0||wt<0){console.warn("Invalid box position:",{boxX:Ye,boxY:wt,index:vt,col:lt,row:eo});return}let We,Gt,_e,ke,Ts;try{We=e.add([e.rect(y,y),e.pos(Ye,wt),e.anchor("topleft"),e.color(je?40:25,je?40:25,je?50:25),e.outline(2,e.rgb(je?150:60,je?150:60,je?200:60)),e.area({width:y,height:y}),e.fixed(),e.z(1e3)])}catch(to){console.error("Error creating boxBg:",to,{boxX:Ye,boxY:wt,boxSize:y});return}try{Gt=e.add([e.text(It.icon,{size:28}),e.pos(Ye+y/2,wt+y/2),e.anchor("center"),e.color(je?255:80,je?255:80,je?255:80),e.fixed(),e.z(1001)])}catch(to){console.error("Error creating iconText:",to),We&&e.destroy(We);return}const fo=e.add([e.text(It.name,{size:12,width:y+20}),e.pos(Ye+y/2,wt+y+12),e.anchor("center"),e.color(je?200:100,je?200:100,je?200:100),e.fixed(),e.z(1001)]);T.push(We,Gt,fo)});const yt=Math.ceil(V.length/re),Xt=D+5+yt*(y+b)+v;K?Y+=Xt:j+=Xt});const k=Object.keys(di).length,G=o.length,Q=G/k,pe=e.height()-A-f/2,ee=600,De=25,ye=e.width()/2,Se=e.add([e.rect(ee,De),e.pos(ye,pe),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(100,100,150)),e.fixed(),e.z(1e3)]);T.push(Se);const Ae=ee*Q;if(Ae>2&&Q>0&&isFinite(Ae)){const Pe=Math.min(15,Math.max(3,Math.floor(Ae/15)));if(Pe>0&&isFinite(Pe)){const se=Ae/Pe;if(se>0&&isFinite(se))for(let V=0;V<Pe;V++){const K=ye-ee/2+V*se,te=V/Pe*360,X=Ra(te/360,1,.5);if(isFinite(K)&&se>0){const $=e.add([e.rect(se,De-4),e.pos(K+se/2,pe),e.anchor("center"),e.color(X[0],X[1],X[2]),e.fixed(),e.z(1001)]);$&&T.push($)}}}}else if(Ae>0&&isFinite(Ae)){const Pe=Ra(0,1,.5),se=ye-ee/2+Ae/2;if(isFinite(se)){const V=e.add([e.rect(Ae,De-4),e.pos(se,pe),e.anchor("center"),e.color(Pe[0],Pe[1],Pe[2]),e.fixed(),e.z(1001)]);V&&T.push(V)}}const Ce=e.add([e.text(`${G}/${k} (${Math.round(Q*100)}%)`,{size:16}),e.pos(ye,pe+De/2+20),e.anchor("center"),e.color(200,200,255),e.fixed(),e.z(1e3)]);T.push(Ce)}catch(p){console.error("Error rendering achievements:",p);const y=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,x+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);T.push(y)}}q();const U=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.NEUTRAL),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text(ho("Back"),{size:W.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),U.onClick(()=>{e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}function sf(e){e.scene("characterSelect",()=>{const t=No(),o=Es();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...C.BG_DARK),e.fixed(),e.z(B.BACKGROUND)]),hi(e,{patternCount:10,particleCount:15}),Dn(e,t),e.add([e.text(ho("Characters"),{size:W.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);const s=Object.keys(Ao),a=350+20,l=e.width()-a-20,c=120,r=150,n=100,d=15,u=2,x=3*(n+d),f=Math.ceil(s.length/u);let A=0;const g=[];let w=o,E=[],T=!1;function q(){if(T)return;T=!0;const b=Math.max(0,f*(n+d)-x);g.forEach(G=>{G&&G.exists&&G.exists()&&e.destroy(G)}),g.length=0,E.forEach(G=>{G&&G.exists&&G.exists()&&e.destroy(G)}),E=[],A=Math.max(0,Math.min(A,b)),s.forEach((G,Q)=>{const pe=Ao[G],ee=Wt("characters",G)||pe.unlockedByDefault,De=w===G,ye=Math.floor(Q/u),Ae=20+Q%u*(r+d),Ce=c+ye*(n+d)-A;if(Ce>=c-n&&Ce<=c+x){const Pe=e.add([e.rect(r,n),e.pos(Ae,Ce),e.anchor("topleft"),e.color(...De?C.BG_MEDIUM:C.BG_DARK),e.outline(2,De?e.rgb(...C.BORDER_ACTIVE):ee?e.rgb(...C.TEXT_DISABLED):e.rgb(...C.BG_DARK)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]),se=e.add([e.text(pe.char,{size:W.TITLE}),e.pos(Ae+r/2,Ce+30),e.anchor("center"),e.color(...ee?pe.color:C.BG_DISABLED),e.fixed(),e.z(B.UI_TEXT)]),V=e.add([e.text(pe.name,{size:W.SMALL}),e.pos(Ae+r/2,Ce+70),e.anchor("center"),e.color(...ee?C.TEXT_PRIMARY:C.TEXT_DISABLED),e.fixed(),e.z(B.UI_TEXT)]);if(!ee){const K=e.add([e.text("",{size:W.BUTTON}),e.pos(Ae+r/2,Ce+n/2),e.anchor("center"),e.color(...C.DANGER),e.fixed(),e.z(B.OVERLAY)]);g.push(K)}ee&&(Pe.onClick(()=>{w!==G&&(Yt(),w=G,Gu(G),q())}),Pe.cursor="pointer"),g.push(Pe,se,V)}});const v=Ao[w],D=Wt("characters",w)||v.unlockedByDefault;let P=c;const O=e.add([e.text(v.char,{size:72}),e.pos(a+l/2,P+40),e.anchor("center"),e.color(...D?v.color:C.BG_DISABLED),e.fixed(),e.z(B.UI_ELEMENTS)]);E.push(O),P+=100;const I=e.add([e.text(v.name,{size:W.HEADER}),e.pos(a+l/2,P),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);E.push(I),P+=40;const R=e.add([e.text(v.description,{size:W.SMALL,width:l-40}),e.pos(a+l/2,P),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]);E.push(R),P+=60;const N=e.add([e.text("Stats:",{size:W.LABEL}),e.pos(a+20,P),e.anchor("left"),e.color(...C.WARNING),e.fixed(),e.z(B.UI_TEXT)]);E.push(N),P+=30;const Y=e.add([e.text(`${Io.HEALTH}: ${v.stats.health}`,{size:W.BODY}),e.pos(a+40,P),e.anchor("left"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);E.push(Y),P+=25;const j=e.add([e.text(`${Io.SPEED}: ${v.stats.speed}`,{size:W.BODY}),e.pos(a+40,P),e.anchor("left"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);E.push(j),P+=25;const k=e.add([e.text(`${Io.DAMAGE}: ${v.stats.damage}`,{size:W.BODY}),e.pos(a+40,P),e.anchor("left"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(B.UI_TEXT)]);if(E.push(k),P+=40,w===v){const G=e.add([e.text(" SELECTED",{size:W.LABEL}),e.pos(a+l/2,P),e.anchor("center"),e.color(...C.SUCCESS),e.fixed(),e.z(B.UI_TEXT)]);E.push(G)}if(!D&&v.unlockRequirement){const G=e.add([e.text(`Unlock: Complete ${Io.FLOOR} ${v.unlockRequirement.value}`,{size:W.SMALL}),e.pos(a+l/2,P+30),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(B.UI_TEXT)]);E.push(G)}T=!1}q();const U=b=>{b.preventDefault(),b.stopPropagation();const v=A,D=Math.max(0,f*(n+d)-x);A+=b.deltaY*.3,A=Math.max(0,Math.min(A,D)),A!==v&&q()},p=document.querySelector("#game-container");p&&p.addEventListener("wheel",U,{passive:!1}),e.onDestroy(()=>{p&&p.removeEventListener("wheel",U)}),e.onKeyPress("arrowdown",()=>{const b=A,v=Math.max(0,f*(n+d)-x);A+=50,A=Math.max(0,Math.min(A,v)),A!==b&&q()}),e.onKeyPress("arrowup",()=>{const b=A,v=Math.max(0,f*(n+d)-x);A-=50,A=Math.max(0,Math.min(A,v)),A!==b&&q()});const y=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.NEUTRAL),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(B.UI_ELEMENTS)]);e.add([e.text(ho("Back"),{size:W.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(B.UI_TEXT)]),y.onClick(()=>{gt(),e.go("menu")}),e.add([e.text("Click a character to select | Press SPACE to start",{size:W.BODY}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(...C.TEXT_TERTIARY),e.fixed(),e.z(B.UI_TEXT)]),e.onKeyPress("escape",()=>{gt(),e.go("menu")}),e.onKeyPress("space",()=>{Yt(),e.go("game",{resetState:!0})})})}function nf(e){e.scene("joinParty",()=>{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...C.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:W.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:W.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...C.TEXT_SECONDARY),e.fixed(),e.z(10)]);let t="";const o=e.add([e.text("______",{size:W.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...C.GOLD),e.fixed(),e.z(10)]),s=e.add([e.text("",{size:W.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:W.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...C.TEXT_DISABLED),e.fixed(),e.z(10)]);let i=!1;function a(){let r="";for(let n=0;n<6;n++)n<t.length?r+=t[n]:r+="_";o.text=r}e.onCharInput(r=>{i||/[a-zA-Z0-9]/.test(r)&&t.length<6&&(gt(),t+=r.toUpperCase(),a(),s.text="",t.length===6&&e.wait(.2,l))}),e.onKeyPress("backspace",()=>{i||t.length>0&&(gt(),t=t.slice(0,-1),a(),s.text="")}),e.onKeyPress("escape",()=>{gt(),i=!1,e.go("menu")}),e.onKeyPress("enter",()=>{i||t.length===6&&l()});async function l(){if(i)return;const r=t.trim();if(!_u(r)){s.text="Invalid invite code format",s.color=e.rgb(255,100,100);return}i=!0,s.text="Joining party...",s.color=e.rgb(...C.GOLD);try{await lp(r)?(Yt(),s.text="Successfully joined party!",s.color=e.rgb(...C.SUCCESS),e.wait(1,()=>{e.go("menu")})):(i=!1,s.text="Failed to join party. Check the code and try again.",s.color=e.rgb(255,100,100),t="",a())}catch(n){i=!1,console.error("[JoinParty] Error joining party:",n),s.text="Connection error. Please try again.",s.color=e.rgb(255,100,100),t="",a()}}const c=e.add([e.rect(200,50),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...C.SECONDARY),e.outline(2,e.rgb(...C.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("Cancel",{size:W.BUTTON}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...C.TEXT_PRIMARY),e.fixed(),e.z(11)]),c.onClick(()=>{gt(),i=!1,e.go("menu")}),c.onHoverUpdate(()=>{i||(c.color=e.rgb(...C.SECONDARY_HOVER))}),c.onHoverEnd(()=>{c.color=e.rgb(...C.SECONDARY)})})}const po=Hu({width:ts.CANVAS_WIDTH,height:ts.CANVAS_HEIGHT,background:ts.BACKGROUND_COLOR,scale:ts.CANVAS_SCALE,debug:ts.DEBUG_MODE,root:document.querySelector("#game-container")});$0(po);W0(po);J0(po);Q0(po);tf(po);of(po);sf(po);nf(po);po.go("menu");
