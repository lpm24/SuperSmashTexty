var ql=Object.defineProperty;var Fl=(e,t,o)=>t in e?ql(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var O=(e,t,o)=>Fl(e,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();var Yl=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return o=>{for(var s=o.length,i=new Uint8Array((s-(o[s-1]=="=")-(o[s-2]=="="))*3/4|0),a=0,r=0;a<s;){var h=e[o.charCodeAt(a++)],l=e[o.charCodeAt(a++)],n=e[o.charCodeAt(a++)],c=e[o.charCodeAt(a++)];i[r++]=h<<2|l>>4,i[r++]=l<<4|n>>2,i[r++]=n<<6|c}return i}})(),Xl={version:"3001.0.19"};function no(e,t,o){return t>o?no(e,o,t):Math.min(Math.max(e,t),o)}var Oe,Be=(Oe=class{constructor(t,o,s){O(this,"r",255);O(this,"g",255);O(this,"b",255);this.r=no(t,0,255),this.g=no(o,0,255),this.b=no(s,0,255)}static fromArray(t){return new Oe(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new Oe(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!o)throw new Error("Invalid hex color format");return new Oe(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,o,s){if(o==0)return new Oe(255*s,255*s,255*s);let i=(c,u,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?c+(u-c)*6*d:d<1/2?u:d<2/3?c+(u-c)*(2/3-d)*6:c),a=s<.5?s*(1+o):s+o-s*o,r=2*s-a,h=i(r,a,t+1/3),l=i(r,a,t),n=i(r,a,t-1/3);return new Oe(Math.round(h*255),Math.round(l*255),Math.round(n*255))}clone(){return new Oe(this.r,this.g,this.b)}lighten(t){return new Oe(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new Oe(255-this.r,255-this.g,255-this.b)}mult(t){return new Oe(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,o){return new Oe(Ct(this.r,t.r,o),Ct(this.g,t.g,o),Ct(this.b,t.b,o))}toHSL(){let t=this.r/255,o=this.g/255,s=this.b/255,i=Math.max(t,o,s),a=Math.min(t,o,s),r=(i+a)/2,h=r,l=r;if(i==a)r=h=0;else{let n=i-a;switch(h=l>.5?n/(2-i-a):n/(i+a),i){case t:r=(o-s)/n+(o<s?6:0);break;case o:r=(s-t)/n+2;break;case s:r=(t-o)/n+4;break}r/=6}return[r,h,l]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}},O(Oe,"RED",new Oe(255,0,0)),O(Oe,"GREEN",new Oe(0,255,0)),O(Oe,"BLUE",new Oe(0,0,255)),O(Oe,"YELLOW",new Oe(255,255,0)),O(Oe,"MAGENTA",new Oe(255,0,255)),O(Oe,"CYAN",new Oe(0,255,255)),O(Oe,"WHITE",new Oe(255,255,255)),O(Oe,"BLACK",new Oe(0,0,0)),Oe);function Ne(...e){if(e.length===0)return new Be(255,255,255);if(e.length===1){if(e[0]instanceof Be)return e[0].clone();if(typeof e[0]=="string")return Be.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Be.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof Be)return e[0].clone()}else if(e.length===3||e.length===4)return new Be(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var Gl=(e,t,o)=>Be.fromHSL(e,t,o);function st(e){return e*Math.PI/180}function zo(e){return e*180/Math.PI}function Ct(e,t,o){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*o;if(e instanceof Y&&t instanceof Y||e instanceof Be&&t instanceof Be)return e.lerp(t,o);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function oo(e,t,o,s,i){return s+(e-t)/(o-t)*(i-s)}function Vl(e,t,o,s,i){return no(oo(e,t,o,s,i),s,i)}var _e,Y=(_e=class{constructor(t=0,o=t){O(this,"x",0);O(this,"y",0);this.x=t,this.y=o}static fromAngle(t){let o=st(t);return new _e(Math.cos(o),Math.sin(o))}static fromArray(t){return new _e(t[0],t[1])}clone(){return new _e(this.x,this.y)}add(...t){let o=H(...t);return new _e(this.x+o.x,this.y+o.y)}sub(...t){let o=H(...t);return new _e(this.x-o.x,this.y-o.y)}scale(...t){let o=H(...t);return new _e(this.x*o.x,this.y*o.y)}dist(...t){let o=H(...t);return this.sub(o).len()}sdist(...t){let o=H(...t);return this.sub(o).slen()}static sdist(t,o){let s=t.x-o.x,i=t.y-o.y;return s*s+i*i}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new _e(0):this.scale(1/t)}normal(){return new _e(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,o){return t.x*o.x+t.y*o.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,o){return t.x*o.y-t.y*o.x}angle(...t){let o=H(...t);return zo(Math.atan2(this.y-o.y,this.x-o.x))}angleBetween(...t){let o=H(...t);return zo(Math.atan2(this.cross(o),this.dot(o)))}lerp(t,o){return new _e(Ct(this.x,t.x,o),Ct(this.y,t.y,o))}slerp(t,o){let s=this.dot(t),i=this.cross(t),a=Math.atan2(i,s);return this.scale(Math.sin((1-o)*a)).add(t.scale(Math.sin(o*a))).scale(1/i)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new _e(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Ye(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}},O(_e,"ZERO",new _e(0,0)),O(_e,"ONE",new _e(1,1)),O(_e,"LEFT",new _e(-1,0)),O(_e,"RIGHT",new _e(1,0)),O(_e,"UP",new _e(0,-1)),O(_e,"DOWN",new _e(0,1)),_e);function H(...e){if(e.length===1){if(e[0]instanceof Y)return new Y(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new Y(...e[0])}return new Y(...e)}var We=class qi{constructor(t,o,s,i){O(this,"x",0);O(this,"y",0);O(this,"w",1);O(this,"h",1);this.x=t,this.y=o,this.w=s,this.h=i}scale(t){return new qi(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new Y(this.x,this.y)}clone(){return new qi(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function ot(e,t,o,s){return new We(e,t,o,s)}var js=class Ko{constructor(t,o,s,i){O(this,"a");O(this,"b");O(this,"c");O(this,"d");this.a=t,this.b=o,this.c=s,this.d=i}mul(t){return new Ko(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return H(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new Ko(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new Ko(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,o=this.det,s=t+Math.sqrt(t*t-o),i=t-Math.sqrt(t*t-o);return[s,i]}eigenvectors(t,o){return this.c!=0?[[t-this.d,this.c],[o-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,o-this.a]]:Math.abs(this.transform(H(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let o=Math.cos(t),s=Math.sin(t);return new Ko(o,s,-s,o)}static scale(t,o){return new Ko(t,0,0,o)}},cs=class hs{constructor(t,o,s,i,a,r,h,l,n){O(this,"m11");O(this,"m12");O(this,"m13");O(this,"m21");O(this,"m22");O(this,"m23");O(this,"m31");O(this,"m32");O(this,"m33");this.m11=t,this.m12=o,this.m13=s,this.m21=i,this.m22=a,this.m23=r,this.m31=h,this.m32=l,this.m33=n}static fromMat2(t){return new hs(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new js(this.m11,this.m12,this.m21,this.m22)}mul(t){return new hs(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let o=Math.cos(t),s=Math.sin(t),i=this.m11,a=this.m12;return this.m11=o*this.m11+s*this.m21,this.m12=o*this.m12+s*this.m22,this.m21=o*this.m21-s*i,this.m22=o*this.m22-s*a,this}scale(t,o){return this.m11*=t,this.m12*=t,this.m21*=o,this.m22*=o,this}get inverse(){let t=this.det;return new hs((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new hs(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},ao=class co{constructor(t){O(this,"m",[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);t&&(this.m=t)}static translate(t){return new co([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new co([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t);return new co([1,0,0,0,0,o,-s,0,0,s,o,0,0,0,0,1])}static rotateY(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t);return new co([o,0,s,0,0,1,0,0,-s,0,o,0,0,0,0,1])}static rotateZ(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t);return new co([o,-s,0,0,s,o,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=st(-t);let o=Math.cos(t),s=Math.sin(t),i=this.m[0],a=this.m[1],r=this.m[4],h=this.m[5];return this.m[0]=i*o+a*s,this.m[1]=-i*s+a*o,this.m[4]=r*o+h*s,this.m[5]=-r*s+h*o,this}mult(t){let o=[];for(let s=0;s<4;s++)for(let i=0;i<4;i++)o[s*4+i]=this.m[0*4+i]*t.m[s*4+0]+this.m[1*4+i]*t.m[s*4+1]+this.m[2*4+i]*t.m[s*4+2]+this.m[3*4+i]*t.m[s*4+3];return new co(o)}multVec2(t){return new Y(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new Y(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new Y(o,t/o)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new Y(t/o,o)}else return new Y(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return zo(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return zo(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new Y(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new Y(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new Y(0,0)}invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],s=this.m[9]*this.m[15]-this.m[13]*this.m[11],i=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],r=this.m[8]*this.m[14]-this.m[12]*this.m[10],h=this.m[8]*this.m[13]-this.m[12]*this.m[9],l=this.m[6]*this.m[15]-this.m[14]*this.m[7],n=this.m[5]*this.m[15]-this.m[13]*this.m[7],c=this.m[5]*this.m[14]-this.m[13]*this.m[6],u=this.m[4]*this.m[15]-this.m[12]*this.m[7],d=this.m[4]*this.m[14]-this.m[12]*this.m[6],x=this.m[5]*this.m[15]-this.m[13]*this.m[7],f=this.m[4]*this.m[13]-this.m[12]*this.m[5],A=this.m[6]*this.m[11]-this.m[10]*this.m[7],g=this.m[5]*this.m[11]-this.m[9]*this.m[7],w=this.m[5]*this.m[10]-this.m[9]*this.m[6],D=this.m[4]*this.m[11]-this.m[8]*this.m[7],R=this.m[4]*this.m[10]-this.m[8]*this.m[6],X=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*s+this.m[7]*i,t[4]=-(this.m[4]*o-this.m[6]*a+this.m[7]*r),t[8]=this.m[4]*s-this.m[5]*a+this.m[7]*h,t[12]=-(this.m[4]*i-this.m[5]*r+this.m[6]*h),t[1]=-(this.m[1]*o-this.m[2]*s+this.m[3]*i),t[5]=this.m[0]*o-this.m[2]*a+this.m[3]*r,t[9]=-(this.m[0]*s-this.m[1]*a+this.m[3]*h),t[13]=this.m[0]*i-this.m[1]*r+this.m[2]*h,t[2]=this.m[1]*l-this.m[2]*n+this.m[3]*c,t[6]=-(this.m[0]*l-this.m[2]*u+this.m[3]*d),t[10]=this.m[0]*x-this.m[1]*u+this.m[3]*f,t[14]=-(this.m[0]*c-this.m[1]*d+this.m[2]*f),t[3]=-(this.m[1]*A-this.m[2]*g+this.m[3]*w),t[7]=this.m[0]*A-this.m[2]*D+this.m[3]*R,t[11]=-(this.m[0]*g-this.m[1]*D+this.m[3]*X),t[15]=this.m[0]*w-this.m[1]*R+this.m[2]*X;let _=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let p=0;p<4;p++)for(let y=0;y<4;y++)t[p*4+y]*=1/_;return new co(t)}clone(){return new co([...this.m])}toString(){return this.m.toString()}};function La(e,t,o,s=i=>-Math.cos(i)){return e+(s(o)+1)/2*(t-e)}var Kl=1103515245,jl=12345,jn=2147483648,za=class{constructor(e){O(this,"seed");this.seed=e}gen(){return this.seed=(Kl*this.seed+jl)%jn,this.seed/jn}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new Y(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new Be(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof Y)return this.genVec2(H(0,0),e[0]);if(e[0]instanceof Be)return this.genColor(Ne(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof Y&&e[1]instanceof Y)return this.genVec2(e[0],e[1]);if(e[0]instanceof Be&&e[1]instanceof Be)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},Fi=new za(Date.now());function Wl(e){return e!=null&&(Fi.seed=e),Fi.seed}function ct(...e){return Fi.genAny(...e)}function Na(...e){return Math.floor(ct(...e.length>0?e:[2]))}function $l(e){return ct()<=e}function Ha(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Jl(e,t){return e.length<=t?e.slice():Ha(e.slice()).slice(0,t)}function Ql(e){return e[Na(e.length)]}function Ua(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function Zl(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let o=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(o===0)return null;let s=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/o,i=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/o;return s<0||s>1||i<0||i>1?null:s}function mn(e,t){let o=Zl(e,t);return o?H(e.p1.x+o*(e.p2.x-e.p1.x),e.p1.y+o*(e.p2.y-e.p1.y)):null}function xn(e,t){let o=t.p2.sub(t.p1),s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;if(o.x!=0){let a=(e.pos.x-t.p1.x)/o.x,r=(e.pos.x+e.width-t.p1.x)/o.x;s=Math.max(s,Math.min(a,r)),i=Math.min(i,Math.max(a,r))}if(o.y!=0){let a=(e.pos.y-t.p1.y)/o.y,r=(e.pos.y+e.height-t.p1.y)/o.y;s=Math.max(s,Math.min(a,r)),i=Math.min(i,Math.max(a,r))}return i>=s&&i>=0&&s<=1}function ci(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function _a(e,t){let o=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),s=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return H(o,s).sdist(t.center)<=t.radius*t.radius}function qa(e,t){return Fa(t,new Mt(e.points()))}function yn(e,t){let o=t.sub(e.p1),s=e.p2.sub(e.p1);if(Math.abs(o.cross(s))>Number.EPSILON)return!1;let i=o.dot(s)/s.dot(s);return i>=0&&i<=1}function Ts(e,t){let o=e.p2.sub(e.p1),s=o.dot(o),i=e.p1.sub(t.center),a=2*o.dot(i),r=i.dot(i)-t.radius*t.radius,h=a*a-4*s*r;if(s<=Number.EPSILON||h<0)return!1;if(h==0){let l=-a/(2*s);if(l>=0&&l<=1)return!0}else{let l=(-a+Math.sqrt(h))/(2*s),n=(-a-Math.sqrt(h))/(2*s);if(l>=0&&l<=1||n>=0&&n<=1)return!0}return hi(t,e.p1)}function wn(e,t){if(Ro(t,e.p1)||Ro(t,e.p2))return!0;for(let o=0;o<t.pts.length;o++){let s=t.pts[o],i=t.pts[(o+1)%t.pts.length];if(mn(e,new Bt(s,i)))return!0}return!1}function hi(e,t){return e.center.sdist(t)<e.radius*e.radius}function kl(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function di(e,t){let o=t.pts[t.pts.length-1];for(let s of t.pts){if(Ts(new Bt(o,s),e))return!0;o=s}return hi(e,t.pts[0])?!0:Ro(t,e.center)}function Fa(e,t){for(let o=0;o<e.pts.length;o++)if(wn(new Bt(e.pts[o],e.pts[(o+1)%e.pts.length]),t))return!0;return!!(e.pts.some(o=>Ro(t,o))||t.pts.some(o=>Ro(e,o)))}function Ro(e,t){let o=!1,s=e.pts;for(let i=0,a=s.length-1;i<s.length;a=i++)s[i].y>t.y!=s[a].y>t.y&&t.x<(s[a].x-s[i].x)*(t.y-s[i].y)/(s[a].y-s[i].y)+s[i].x&&(o=!o);return o}function bn(e,t){t=t.sub(e.center);let o=st(e.angle),s=Math.cos(o),i=Math.sin(o),a=t.x*s+t.y*i,r=-t.x*i+t.y*s;return a*a/(e.radiusX*e.radiusX)+r*r/(e.radiusY*e.radiusY)<1}function Ws(e,t){let o=t.center.sub(e.center),s=st(e.angle),i=Math.cos(s),a=Math.sin(s),r=o.x*i+o.y*a,h=-o.x*a+o.y*i;return bn(new go(H(),e.radiusX+t.radius,e.radiusY+t.radius,0),H(r,h))}function Ya(e,t){let o=e.toMat2().inverse;return t=new Bt(o.transform(t.p1.sub(e.center)),o.transform(t.p2.sub(e.center))),Ts(t,new Pt(H(),1))}function ec(e,t){if(e.radiusX===e.radiusY)return Ws(t,new Pt(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Ws(e,new Pt(t.center,t.radiusX));let o=new cs(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),s=new cs(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),i=e.center.x,a=e.center.y,r=t.center.x,h=t.center.y,l=st(e.angle),n=st(t.angle),c=new cs(Math.cos(l),-Math.sin(l),i,Math.sin(l),Math.cos(l),a,0,0,1),u=new cs(Math.cos(n),-Math.sin(n),r,Math.sin(n),Math.cos(n),h,0,0,1),d=c.inverse,x=u.inverse,f=d.transpose.mul(o).mul(d),A=x.transpose.mul(s).mul(x),g=f.m11,w=f.m12,D=f.m13,R=f.m21,X=f.m22,_=f.m23,p=f.m31,y=f.m32,b=f.m33,E=A.m11,T=A.m12,C=A.m13,N=A.m21,B=A.m22,v=A.m23,z=A.m31,G=A.m32,J=A.m33,se=g*X*b-g*_*y-w*R*b+w*_*p+D*R*y-D*X*p,V=(g*X*J-g*_*G-g*y*v+g*b*B-w*R*J+w*_*z+w*p*v-w*b*N+D*R*G-D*X*z-D*p*B+D*y*N+R*y*C-R*b*T-X*p*C+X*b*E+_*p*T-_*y*E)/se,k=(g*B*J-g*v*G-w*N*J+w*v*z+D*N*G-D*B*z-R*T*J+R*C*G+X*E*J-X*C*z-_*E*G+_*T*z+p*T*v-p*C*B-y*E*v+y*C*N+b*E*B-b*T*N)/se,fe=(E*B*J-E*v*G-T*N*J+T*v*z+C*N*G-C*B*z)/se;if(V>=0){let oe=-3*k+V**2,Ie=3*V*fe+k*V**2-4*k**2,Ee=-27*fe**2+18*fe*V*k+V**2*k**2-4*V**3*fe-4*k**3;return!(oe>0&&Ie<0&&Ee>0)}else{let oe=-3*k+V**2,Ie=-27*fe**2+18*fe*V*k+V**2*k**2-4*V**3*fe-4*k**3;return!(oe>0&&Ie>0)}}function Xa(e,t){return An(e,new Mt(t.points()))}function An(e,t){let o=e.toMat2().inverse;return t=new Mt(t.pts.map(s=>o.transform(s.sub(e.center)))),di(new Pt(H(),1),t)}function tc(e,t){return e.x===t.x&&e.y===t.y}function oc(e,t){return t instanceof Y?tc(t,e.pt):t instanceof Pt?hi(t,e.pt):t instanceof Bt?yn(t,e.pt):t instanceof Ye?ci(t,e.pt):t instanceof Mt?Ro(t,e.pt):t instanceof go?bn(t,e.pt):!1}function sc(e,t){return t instanceof Y?yn(e,t):t instanceof Pt?Ts(e,t):t instanceof Bt?mn(e,t)!=null:t instanceof Ye?xn(t,e):t instanceof Mt?wn(e,t):t instanceof go?Ya(t,e):!1}function ic(e,t){return t instanceof Y?hi(e,t):t instanceof Pt?kl(e,t):t instanceof Bt?Ts(t,e):t instanceof Ye?_a(t,e):t instanceof Mt?di(e,t):t instanceof go?Ws(t,e):!1}function nc(e,t){return t instanceof Y?ci(e,t):t instanceof Pt?_a(e,t):t instanceof Bt?xn(e,t):t instanceof Ye?Ua(e,t):t instanceof Mt?qa(e,t):t instanceof go?Xa(t,e):!1}function ac(e,t){return t instanceof Y?Ro(e,t):t instanceof Pt?di(t,e):t instanceof Bt?wn(t,e):t instanceof Ye?qa(t,e):t instanceof Mt?Fa(t,e):t instanceof go?An(t,e):!1}function rc(e,t){return t instanceof Y?bn(e,t):t instanceof Pt?Ws(e,t):t instanceof Bt?Ya(e,t):t instanceof Ye?Xa(e,t):t instanceof Mt?An(e,t):t instanceof go?ec(t,e):!1}function Ga(e,t,o){let s=e,i=o.p1,a=o.p2,r=t,h=a.sub(i),l=r.cross(h);if(Math.abs(l)<Number.EPSILON)return null;let n=i.sub(s),c=n.cross(h)/l;if(c<=0||c>=1)return null;let u=n.cross(r)/l;if(u<=0||u>=1)return null;let d=h.normal().unit();return t.dot(d)>0&&(d.x*=-1,d.y*=-1),{point:s.add(r.scale(c)),normal:d,fraction:c}}function lc(e,t,o){let s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY,a;if(e.x!=0){let r=(o.pos.x-e.x)/t.x,h=(o.pos.x+o.width-e.x)/t.x;a=H(-Math.sign(t.x),0),s=Math.max(s,Math.min(r,h)),i=Math.min(i,Math.max(r,h))}if(e.y!=0){let r=(o.pos.y-e.y)/t.y,h=(o.pos.y+o.height-e.y)/t.y;Math.min(r,h)>s&&(a=H(0,-Math.sign(t.y))),s=Math.max(s,Math.min(r,h)),i=Math.min(i,Math.max(r,h))}return i>=s&&s>=0&&s<=1?{point:e.add(t.scale(s)),normal:a,fraction:s}:null}function Va(e,t,o){let s=e,i=o.center,a=t,r=a.dot(a),h=s.sub(i),l=2*a.dot(h),n=h.dot(h)-o.radius*o.radius,c=l*l-4*r*n;if(r<=Number.EPSILON||c<0)return null;if(c==0){let u=-l/(2*r);if(u>=0&&u<=1){let d=s.add(a.scale(u));return{point:d,normal:d.sub(i),fraction:u}}}else{let u=(-l+Math.sqrt(c))/(2*r),d=(-l-Math.sqrt(c))/(2*r),x=null;if(u>=0&&u<=1&&(x=u),d>=0&&d<=1&&(x=Math.min(d,x??d)),x!=null){let f=s.add(a.scale(x));return{point:f,normal:f.sub(i).unit(),fraction:x}}}return null}function cc(e,t,o){let s=o.pts,i=null,a=s[s.length-1];for(let r=0;r<s.length;r++){let h=s[r],l=Ga(e,t,new Bt(a,h));l&&(!i||i.fraction>l.fraction)&&(i=l),a=h}return i}function hc(e,t,o){let s=o.toMat2(),i=s.inverse,a=i.transform(e.sub(o.center)),r=i.transform(t),h=Va(a,r,new Pt(H(),1));if(h){let l=js.rotation(st(-o.angle)),n=js.scale(o.radiusX,o.radiusY).transform(h.point),c=s.transform(h.point).add(o.center),u=c.dist(e)/t.len();return{point:c,normal:l.transform(H(o.radiusY**2*n.x,o.radiusX**2*n.y)).unit(),fraction:u}}return h}function dc(e,t,o,s=64){let i=e,a=t.len(),r=t.scale(1/a),h=0,l=H(Math.floor(e.x),Math.floor(e.y)),n=H(r.x>0?1:-1,r.y>0?1:-1),c=H(Math.abs(1/r.x),Math.abs(1/r.y)),u=H(n.x>0?l.x+1-e.x:e.x-l.x,n.y>0?l.y+1-e.y:e.y-l.y),d=H(c.x<1/0?c.x*u.x:1/0,c.y<1/0?c.y*u.y:1/0),x=-1;for(;h<=s;){let f=o(l);if(f===!0)return{point:i.add(r.scale(h)),normal:H(x===0?-n.x:0,x===1?-n.y:0),fraction:h/a,gridPos:l};if(f)return f;d.x<d.y?(l.x+=n.x,h=d.x,d.x+=c.x,x=0):(l.y+=n.y,h=d.y,d.y+=c.y,x=1)}return null}var uc=class Yi{constructor(t){O(this,"pt");this.pt=t.clone()}transform(t){return new Yi(t.multVec2(this.pt))}bbox(){return new Ye(this.pt,0,0)}area(){return 0}clone(){return new Yi(this.pt)}collides(t){return oc(this,t)}contains(t){return this.pt.eq(t)}raycast(t,o){return null}random(){return this.pt.clone()}},Bt=class Xi{constructor(t,o){O(this,"p1");O(this,"p2");this.p1=t.clone(),this.p2=o.clone()}transform(t){return new Xi(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Ye.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Xi(this.p1,this.p2)}collides(t){return sc(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Ga(t,o,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(ct(1)))}},Ye=class Gi{constructor(t,o,s){O(this,"pos");O(this,"width");O(this,"height");this.pos=t.clone(),this.width=o,this.height=s}static fromPoints(t,o){return new Gi(t.clone(),o.x-t.x,o.y-t.y)}center(){return new Y(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new Mt(this.points().map(o=>t.multVec2(o)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Gi(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let o=this.pos,s=this.pos.add(this.width,this.height),i=Math.max(o.x-t.x,0,t.x-s.x),a=Math.max(o.y-t.y,0,t.y-s.y);return i*i+a*a}collides(t){return nc(this,t)}contains(t){return this.collides(t)}raycast(t,o){return lc(t,o,this)}random(){return this.pos.add(ct(this.width),ct(this.height))}},Pt=class Ka{constructor(t,o){O(this,"center");O(this,"radius");this.center=t.clone(),this.radius=o}transform(t){return new go(this.center,this.radius,this.radius).transform(t)}bbox(){return Ye.fromPoints(this.center.sub(H(this.radius)),this.center.add(H(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new Ka(this.center,this.radius)}collides(t){return ic(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Va(t,o,this)}random(){return this.center.add(Y.fromAngle(ct(360)).scale(ct(this.radius)))}},go=class jo{constructor(t,o,s,i=0){O(this,"center");O(this,"radiusX");O(this,"radiusY");O(this,"angle");this.center=t.clone(),this.radiusX=o,this.radiusY=s,this.angle=i}static fromMat2(t){let o=t.inverse,s=o.transpose.mul(o),[i,a]=s.eigenvalues,[r,h]=s.eigenvectors(i,a),[l,n]=[1/Math.sqrt(i),1/Math.sqrt(a)];return l>n?new jo(H(),l,n,zo(Math.atan2(-r[1],r[0]))):new jo(H(),n,l,zo(Math.atan2(-h[1],h[0])))}toMat2(){let t=st(this.angle),o=Math.cos(t),s=Math.sin(t);return new js(o*this.radiusX,-s*this.radiusY,s*this.radiusX,o*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new jo(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let o=this.toMat2(),s=t.getRotation(),i=t.getScale();o=cs.fromMat2(o).scale(i.x,i.y).rotate(s).toMat2();let a=jo.fromMat2(o);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return Ye.fromPoints(this.center.sub(H(this.radiusX,this.radiusY)),this.center.add(H(this.radiusX,this.radiusY)));{let t=st(this.angle),o=Math.cos(t),s=Math.sin(t),i=this.radiusX*o,a=this.radiusX*s,r=this.radiusY*s,h=this.radiusY*o,l=Math.sqrt(i*i+r*r),n=Math.sqrt(a*a+h*h);return Ye.fromPoints(this.center.sub(H(l,n)),this.center.add(H(l,n)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new jo(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return rc(this,t)}contains(t){t=t.sub(this.center);let o=st(this.angle),s=Math.cos(o),i=Math.sin(o),a=t.x*s+t.y*i,r=-t.x*i+t.y*s;return a*a/(this.radiusX*this.radiusX)+r*r/(this.radiusY*this.radiusY)<1}raycast(t,o){return hc(t,o,this)}random(){return this.center}};function pc(e,t,o,s){let i=t.sub(e),a=s.sub(o),r=i.cross(a);return r<1e-5&&r>-1e-5||(r=o.sub(e).cross(a)/r,r<0||r>1)?null:e.add(i.scale(r))}var Mt=class ds{constructor(t){O(this,"pts");if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new ds(this.pts.map(o=>t.multVec2(o)))}bbox(){let t=H(Number.MAX_VALUE),o=H(-Number.MAX_VALUE);for(let s of this.pts)t.x=Math.min(t.x,s.x),o.x=Math.max(o.x,s.x),t.y=Math.min(t.y,s.y),o.y=Math.max(o.y,s.y);return Ye.fromPoints(t,o)}area(){let t=0,o=this.pts.length;for(let s=0;s<o;s++){let i=this.pts[s],a=this.pts[(s+1)%o];t+=i.x*a.y*.5,t-=a.x*i.y*.5}return Math.abs(t)}clone(){return new ds(this.pts.map(t=>t.clone()))}collides(t){return ac(this,t)}contains(t){return this.collides(t)}raycast(t,o){return cc(t,o,this)}random(){return H()}cut(t,o){new Bt(t,o);let s=[],i=[],a=o.sub(t),r=this.pts[this.pts.length-1],h=r.sub(t),l=a.cross(h)>0;return this.pts.forEach(n=>{h=n.sub(t);let c=a.cross(h)>0;if(l!=c){let u=pc(r,n,t,o);s.push(u),i.push(u),l=c}(c?s:i).push(n),r=n}),[s.length?new ds(s):null,i.length?new ds(i):null]}};function fc(e,t,o,s){let i=s*s,a=1-s,r=a*a;return e.scale(r).add(t.scale(2*a*s)).add(o.scale(i))}function gc(e,t,o,s){let i=1-s;return t.sub(e).scale(2*i).add(o.sub(t).scale(2*s))}function mc(e,t,o,s){return o.sub(t.scale(2)).add(e).scale(2)}function vn(e,t,o,s,i){let a=i*i,r=a*i,h=1-i,l=h*h,n=l*h;return e.scale(n).add(t.scale(3*l*i)).add(o.scale(3*h*a)).add(s.scale(r))}function xc(e,t,o,s,i){let a=i*i,r=1-i,h=r*r;return t.sub(e).scale(3*h).add(o.sub(t).scale(6*r*i)).add(s.sub(o).scale(3*a))}function yc(e,t,o,s,i){let a=1-i;return o.sub(t.scale(2)).add(e).scale(6*a).add(s.sub(o.scale(2)).add(t).scale(6*i))}function wc(e,t,o,s,i){let a=.5*(((-i+2)*i-1)*i),r=.5*((3*i-5)*i*i+2),h=.5*(((-3*i+4)*i+1)*i),l=.5*((i-1)*i*i);return e.scale(a).add(t.scale(r)).add(o.scale(h)).add(s.scale(l))}function bc(e,t,o,s,i){let a=.5*((-3*i+4)*i-1),r=.5*((9*i-10)*i),h=.5*((-9*i+8)*i+1),l=.5*((3*i-2)*i);return e.scale(a).add(t.scale(r)).add(o.scale(h)).add(s.scale(l))}function Ac(e){let t=ja(e),o=t(1);return s=>{let i=s*o,a=t(i,!0);return e(a)}}function ja(e,t=10,o=10){let s=[0],i=[0],a=1/(t-1)/o,r=0,h=e(0),l=0;for(let n=1;n<t;n++){for(let c=0;c<o;c++){l+=a;let u=e(l),d=u.dist(h);r+=d,h=u}s[n]=r,i[n]=l}return i[t-1]=1,(n,c=!1)=>{if(c){let u=n;if(u<=0)return 0;if(u>=r)return 1;let d=0;for(;s[d+1]<u;)d++;let x=i[d],f=i[d+1],A=s[d],g=s[d+1],w=(u-A)/(g-A);return x+(f-x)*w}else{if(n<=0)return 0;if(n>=1)return s[t-1];let u=0;for(;i[u+1]<n;)u++;let d=i[u],x=i[u+1],f=s[u],A=s[u+1],g=(n-d)/(x-d);return f+(A-f)*g}}}function Cs(e,t,o,s){let i=2*e+t-2*s+o,a=-3*e+3*s-2*t-o,r=t,h=e;return l=>{let n=l*l,c=n*l;return i*c+a*n+r*l+h}}function Wa(e,t,o,s,i,a=Cs){let r=a(t.x,(1-i)*(o.x-e.x),(1-i)*(s.x-t.x),o.x),h=a(t.y,(1-i)*(o.y-e.y),(1-i)*(s.y-t.y),o.y);return l=>new Y(r(l),h(l))}function $s(e,t,o,s,i=Cs){return Wa(e,t,o,s,.5,i)}function vc(e,t,o,s,i=Cs){return $s(s.add(e.sub(t).scale(6)),e,s,e.add(s.sub(o).scale(6)),i)}function Ec(e,t,o,s,i,a,r,h=Cs){let l=h(t.x,.5*(1-i)*(1+r)*(1+a)*(t.x-e.x)+.5*(1-i)*(1-r)*(1-a)*(o.x-t.x),.5*(1-i)*(1+r)*(1-a)*(o.x-t.x)+.5*(1-i)*(1-r)*(1+a)*(s.x-o.x),o.x),n=h(t.y,.5*(1-i)*(1+r)*(1+a)*(t.y-e.y)+.5*(1-i)*(1-r)*(1-a)*(o.y-t.y),.5*(1-i)*(1+r)*(1-a)*(o.y-t.y)+.5*(1-i)*(1-r)*(1+a)*(s.y-o.y),o.y);return c=>new Y(l(c),n(c))}function Mc(e,t,o,s){let i=2*e+t-2*s+o,a=-3*e+3*s-2*t+o,r=t;return h=>{let l=h*h;return 3*i*l+2*a*h+r}}function is(e){return 0<=e&&e<=1}function Ci(e,t){return Math.abs(e-t)<=Number.EPSILON}function ns(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Sc(e,t,o,s){let i=3*e-6*t+3*o,a=-3*e+3*t,r=e,h=-e+3*t-3*o+s;if(Ci(h,0)){if(Ci(i,0))return Ci(a,0)?[]:[-r/a].filter(is);let g=Math.sqrt(a*a-4*i*r),w=2*i;return[(g-a)/w,(-a-g)/w].filter(is)}i/=h,a/=h,r/=h;let l=(3*a-i*i)/3,n=l/3,c=(2*i*i*i-9*i*a+27*r)/27,u=c/2,d=u*u+n*n*n;if(d<0){let g=-l/3,w=g*g*g,D=Math.sqrt(w),R=-c/(2*D),X=R<-1?-1:R>1?1:R,_=Math.acos(X),p=2*ns(D),y=p*Math.cos(_/3)-i/3,b=p*Math.cos((_+2*Math.PI)/3)-i/3,E=p*Math.cos((_+4*Math.PI)/3)-i/3;return[y,b,E].filter(is)}if(d===0){let g=u<0?ns(-u):-ns(u),w=2*g-i/3,D=-g-i/3;return[w,D].filter(is)}let x=Math.sqrt(d),f=ns(x-u),A=ns(x+u);return[f-A-i/3].filter(is)}function Rc(e,t,o,s,i){let a=Sc(e.x-i,t.x-i,o.x-i,s.x-i);return a.length>0?vn(e,t,o,s,a[0]).y:NaN}function Dc(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return o=>{if(o<=0||e.length==1||o<=e[0].x)return e[0].y;for(let s=0;s<t;s++)if(e[s].x>=o)return oo(o,e[s-1].x,e[s].x,e[s-1].y,e[s].y);return e[e.length-1].y}}function Tc(e,t){return o=>Rc(H(0,0),e,t,H(1,1),o)}function Cc(e,t="jump-end"){let o=1/e,s=t=="jump-start"||t=="jump-both",i=t=="jump-end"||t=="jump-both",a=1/(e+(i?1:0)),r=s?a:0;return h=>{let l=Math.floor(h/o);return r+l*a}}function Ic(e,t){let o=Number.MAX_VALUE,s={normal:H(0),distance:0};for(let i of[e,t])for(let a=0;a<i.pts.length;a++){let r=i.pts[a],h=i.pts[(a+1)%i.pts.length].sub(r).normal().unit(),l=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let x=0;x<e.pts.length;x++){let f=e.pts[x].dot(h);l=Math.min(l,f),n=Math.max(n,f)}let c=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(let x=0;x<t.pts.length;x++){let f=t.pts[x].dot(h);c=Math.min(c,f),u=Math.max(u,f)}let d=Math.min(n,u)-Math.max(l,c);if(d<0)return null;if(d<Math.abs(o)){let x=u-l,f=c-n;o=Math.abs(x)<Math.abs(f)?x:f,s.normal=h,s.distance=o}}return s}function $a(e,t,o){return(t.x-e.x)*(o.y-e.y)-(t.y-e.y)*(o.x-e.x)>=0}function Pc(e){let t=0,o=e[e.length-1];for(let s=0;s<e.length;s++)t+=(e[s].x-o.x)*(e[s].y+o.y),o=e[s];return t<0}function Ii(e,t,o,s){let i=s.x-o.x,a=s.y-o.y,r=i*(e.y-o.y)-a*(e.x-o.x),h=i*(t.y-o.y)-a*(t.x-o.x);return r*h>=0}function Bc(e,t,o,s){return Ii(e,t,o,s)&&Ii(e,o,t,s)&&Ii(e,s,t,o)}function Oc(e,t,o,s){for(let i of e)if(i!==t&&i!==o&&i!==s&&Bc(i,t,o,s))return!0;return!1}function Lc(e,t,o,s){return $a(e,t,o)&&!Oc(s,e,t,o)}function Ja(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],o=[],s=0;for(let u=0;u<e.length;u++){let d=e[s],x=e[u];(x.x<d.x||x.x==d.x&&x.y<d.y)&&(s=s),t[u]=u+1,o[u]=u-1}t[t.length-1]=0,o[0]=o.length-1,Pc(e)||([t,o]=[o,t]);let i=[];for(let u=0;u<e.length;++u)$a(e[o[u]],e[u],e[t[u]])||i.push(e[u]);let a=[],r=e.length,h=1,l=0,n,c;for(;r>3;){n=t[h],c=o[h];let u=e[c],d=e[h],x=e[n];if(Lc(u,d,x,i))a.push([u,d,x]),t[c]=n,o[n]=c,i.splice(i.indexOf(d),1),--r,l=0;else if(++l>r)return[];h=n}return n=t[h],c=o[h],a.push([e[c],e[h],e[n]]),a}function zc(e){if(e.length<3)return!1;let t=e.length-2,o=e.length-1,s=0,i=e[o].sub(e[t]),a=e[s].sub(e[o]),r=i.cross(a);for(;s+1<e.length;)if(t=o,o=s,s++,i=e[o].sub(e[t]),a=e[s].sub(e[o]),i.cross(a)*r<0)return!1;return!0}var Qa=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ui="topleft",Nc="monospace",Js="monospace",Vi="linear",En=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],Hc=En.reduce((e,t)=>e+t.size,0),Za=2048,Uc=Za*4*Hc,_c=Za*6,qc=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,Fc=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Ki=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,ji=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,Yc=new Set(["id","require"]),Xc=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),Wn=200,Gc=640,Vc=65536,ka=Symbol.for("kaplay.cancel"),er=class extends Map{constructor(){super(...arguments);O(this,"lastID",0)}push(t){let o=this.lastID;return this.set(o,t),this.lastID++,o}pushd(t){let o=this.push(t);return()=>this.delete(o)}},Fo=class tr{constructor(t){O(this,"paused",!1);O(this,"cancel");this.cancel=t}static join(t){let o=new tr(()=>t.forEach(s=>s.cancel()));return Object.defineProperty(o,"paused",{get:()=>t[0].paused,set:s=>t.forEach(i=>i.paused=s)}),o.paused=!1,o}static replace(t,o){return t.cancel=()=>o.cancel(),o.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>o.paused,set:s=>o.paused=s}),t}},Et=class{constructor(){O(this,"cancellers",new WeakMap);O(this,"handlers",new er)}add(e){function t(...i){if(!s.paused)return e(...i)}let o=this.handlers.pushd(t),s=new Fo(o);return this.cancellers.set(t,o),s}addOnce(e){let t=this.add((...o)=>{t.cancel(),e(...o)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let o=t(...e),s;o===ka&&(s=this.cancellers.get(t))&&s()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},Es=class{constructor(){O(this,"handlers",{});O(this,"registers",{})}on(e,t){return this.handlers[e]||(this.handlers[e]=new Et),this.handlers[e].add(t)}onOnce(e,t){let o=this.on(e,(...s)=>{o.cancel(),t(...s)});return o}next(e){return new Promise(t=>{this.onOnce(e,(...o)=>t(o[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){var t;return((t=this.handlers[e])==null?void 0:t.numListeners())??0}},Kc=e=>e[0]instanceof Be,jc=e=>e[0]instanceof Y,Wc=e=>typeof e[0]=="number",or=class{constructor(e=(t,o)=>t<o){O(this,"_items");O(this,"_compareFn");this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function $c(e){let t=window.atob(e),o=t.length,s=new Uint8Array(o);for(let i=0;i<o;i++)s[i]=t.charCodeAt(i);return s.buffer}function Jc(e){return $c(e.split(",")[1])}function Mn(e,t){let o=document.createElement("a");o.href=t,o.download=e,o.click()}function sr(e,t){Mn(e,"data:text/plain;charset=utf-8,"+t)}function Qc(e,t){sr(e,JSON.stringify(t))}function $n(e,t){let o=URL.createObjectURL(t);Mn(e,o),URL.revokeObjectURL(o)}var ir=e=>e.match(/^data:\w+\/\w+;base64,.+/),Zc=e=>e.split(".").slice(0,-1).join(".");function Sn(e,t){if(e===t)return!0;let o=typeof e,s=typeof t;if(o!==s)return!1;if(o==="object"&&s==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let i=Object.keys(e),a=Object.keys(t);if(i.length!==a.length)return!1;for(let r of i){let h=e[r],l=t[r];if(!Sn(h,l))return!1}return!0}return!1}var Jn=new Set,kc=e=>e instanceof Error?e.message:String(e);function eh(e){Jn.has(e)||(Jn.add(e),console.warn(e))}function Zo(e,t){eh(`${e} is deprecated. Use ${t} instead.`)}function Wi(e,t){return Number(e.toFixed(t))}function Ge(e,t){return(...o)=>{let s=o.length;if(s===e.length)return e(...o);if(s===t.length)return t(...o)}}var th=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function oh(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],o=0,s=0;for(;o<e.length;){if(s+=sh(o+s,e),hh(e[o+s])&&s++,rh(e[o+s])&&s++,lh(e[o+s])&&s++,dh(e[o+s])){s++;continue}t.push(e.substring(o,o+s)),o+=s,s=0}return t}function sh(e,t){let o=t[e];if(!ih(o)||e===t.length-1)return 1;let s=o+t[e+1],i=t.substring(e+2,e+5);return Qn(s)&&Qn(i)?4:nh(s)&&ch(i)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:ah(i)?4:2}function ih(e){return e&&Yo(e[0].charCodeAt(0),55296,56319)}function Qn(e){return Yo(Rn(e),127462,127487)}function nh(e){return Yo(Rn(e),127988,127988)}function ah(e){return Yo(Rn(e),127995,127999)}function rh(e){return typeof e=="string"&&Yo(e.charCodeAt(0),65024,65039)}function lh(e){return typeof e=="string"&&Yo(e.charCodeAt(0),8400,8447)}function ch(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&Yo(t,917504,917631)}function hh(e){return typeof e=="string"&&th.includes(e.charCodeAt(0))}function dh(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Rn(e){let t=e.charCodeAt(0)-55296,o=e.charCodeAt(1)-56320;return(t<<10)+o+65536}function Yo(e,t,o){return e>=t&&e<=o}var _t=(e,t)=>Array.isArray(e)?e==null?void 0:e.includes(t):e===t,kt=(e,t)=>Array.isArray(t)?t.some(o=>e.has(o)):e.has(t),Ns=(e,t,o)=>{var s;e.has(t)?(s=e.get(t))==null||s.push(o):e.set(t,[o])},uh=(()=>{let e=0;return()=>e++})(),ph={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function nr(){let e=m.globalOpt.pixelDensity??1,t=m.globalOpt.width,o=m.globalOpt.height,s=m.gfx.ggl.gl.drawingBufferWidth,i=m.gfx.ggl.gl.drawingBufferHeight,a=s/e,r=i/e,h=0,l=0,n=a,c=r;if(m.globalOpt.letterbox){if(!t||!o)throw new Error("Letterboxing requires width and height defined.");let u=a/r,d=t/o;if(u>d){let x=r*d;h=(a-x)/2,n=x}else{let x=a/d;c=x,l=(r-x)/2}}if(m.globalOpt.stretch&&(!m.globalOpt.width||!m.globalOpt.height))throw new Error("Stretching requires width and height defined.");m.gfx.viewport={x:h,y:l,width:n,height:c,scale:(m.gfx.viewport.width+m.gfx.viewport.height)/(m.gfx.width+m.gfx.height)}}function fh(e){return new Y(e.x*m.gfx.viewport.width/m.gfx.width,e.y*m.gfx.viewport.height/m.gfx.height)}function lo(e){return new Y((e.x-m.gfx.viewport.x)*m.gfx.width/m.gfx.viewport.width,(e.y-m.gfx.viewport.y)*m.gfx.height/m.gfx.viewport.height)}var gh=()=>Bo.lastInputDevice,mh=()=>{let e=Bo.buttons;for(let t in e){let o=e[t].keyboard&&[e[t].keyboard].flat(),s=e[t].keyboardCode&&[e[t].keyboardCode].flat(),i=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();o&&o.forEach(r=>{Ns(Bo.buttonsByKey,r,t)}),s&&s.forEach(r=>{Ns(Bo.buttonsByKeyCode,r,t)}),i&&i.forEach(r=>{Ns(Bo.buttonsByGamepad,r,t)}),a&&a.forEach(r=>{Ns(Bo.buttonsByMouse,r,t)})}},xs=class{constructor(){O(this,"pressed",new Set([]));O(this,"pressedRepeat",new Set([]));O(this,"released",new Set([]));O(this,"down",new Set([]))}update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},xh=class{constructor(){O(this,"buttonState",new xs);O(this,"stickState",new Map)}},yh=class{constructor(){O(this,"dts",[]);O(this,"timer",0);O(this,"fps",0)}tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,o)=>t+o)/this.dts.length)),this.dts=[])}},Bo,Zn=ph,wh=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new yh,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new Y(0),mouseDeltaPos:new Y(0),keyState:new xs,mouseState:new xs,mergedGamepadState:new xh,gamepadStates:new Map,lastInputDevice:null,buttonState:new xs,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new Es}},bh=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=wh(e);Bo=t,mh();function o(){return t.dt*t.timeScale}function s(){return t.fixedDt*t.timeScale}function i(){return t.restDt*t.timeScale}function a(){return t.isHidden}function r(){return t.time}function h(){return t.fpsCounter.fps}function l(){return t.numFrames}function n(){return t.canvas.toDataURL()}function c(M){t.canvas.style.cursor=M}function u(){return t.canvas.style.cursor}function d(M){if(M)try{let L=t.canvas.requestPointerLock();L!=null&&L.catch&&L.catch(F=>console.error(F))}catch(L){console.error(L)}else document.exitPointerLock()}function x(){return!!document.pointerLockElement}function f(M){M.requestFullscreen?M.requestFullscreen():M.webkitRequestFullscreen&&M.webkitRequestFullscreen()}function A(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function g(M=!0){M?f(t.canvas):A()}function w(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function D(){t.stopped=!0;let M=Object.entries(yt),L=Object.entries(Rt),F=Object.entries(Wt);for(let[te,ye]of M)t.canvas.removeEventListener(te,ye);for(let[te,ye]of L)document.removeEventListener(te,ye);for(let[te,ye]of F)window.removeEventListener(te,ye);ut.disconnect()}function R(M,L){t.loopID!==null&&cancelAnimationFrame(t.loopID);let F=0,te=0,ye=Le=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(ye);return}let Xe=Le/1e3,Ke=Math.min(Xe-t.realTime,.25),Ut=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Xe,te+=Ke,te>Ut){if(!t.skipTime){for(F+=te,t.dt=t.fixedDt,t.restDt=0;F>t.fixedDt;)F-=t.fixedDt,F<t.fixedDt&&(t.restDt=F),M();t.restDt=F,t.dt=te,t.time+=o(),t.fpsCounter.tick(t.dt)}te=0,t.skipTime=!1,t.numFrames++,L(dt,ts)}t.loopID=requestAnimationFrame(ye)};ye(0)}function X(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function _(){return t.mousePos.clone()}function p(){return t.mouseDeltaPos.clone()}function y(M="left"){return t.mouseState.pressed.has(M)}function b(M="left"){return t.mouseState.down.has(M)}function E(M="left"){return t.mouseState.released.has(M)}function T(){return t.isMouseMoved}function C(M){return M===void 0?t.keyState.pressed.size>0:kt(t.keyState.pressed,M)}function N(M){return M===void 0?t.keyState.pressedRepeat.size>0:kt(t.keyState.pressedRepeat,M)}function B(M){return M===void 0?t.keyState.down.size>0:kt(t.keyState.down,M)}function v(M){return M===void 0?t.keyState.released.size>0:kt(t.keyState.released,M)}function z(M){return M===void 0?t.mergedGamepadState.buttonState.pressed.size>0:kt(t.mergedGamepadState.buttonState.pressed,M)}function G(M){return M===void 0?t.mergedGamepadState.buttonState.down.size>0:kt(t.mergedGamepadState.buttonState.down,M)}function J(M){return M===void 0?t.mergedGamepadState.buttonState.released.size>0:kt(t.mergedGamepadState.buttonState.released,M)}function se(M){return M===void 0?t.buttonState.pressed.size>0:kt(t.buttonState.pressed,M)}function V(M){return M===void 0?t.buttonState.down.size>0:kt(t.buttonState.down,M)}function k(M){return M===void 0?t.buttonState.released.size>0:kt(t.buttonState.released,M)}function fe(M){var L;return(L=t.buttons)==null?void 0:L[M]}function oe(M,L){t.buttons[M]={...t.buttons[M],...L}}function Ie(M){t.buttonState.press(M),t.events.trigger("buttonPress",M)}function Ee(M){t.buttonState.release(M),t.events.trigger("buttonRelease",M)}function Re(M){return t.events.on("resize",M)}let Ae=Ge(M=>t.events.on("keyDown",M),(M,L)=>t.events.on("keyDown",F=>_t(M,F)&&L(F))),Ce=Ge(M=>t.events.on("keyPress",L=>M(L)),(M,L)=>t.events.on("keyPress",F=>_t(M,F)&&L(F))),Te=Ge(M=>t.events.on("keyPressRepeat",M),(M,L)=>t.events.on("keyPressRepeat",F=>_t(M,F)&&L(F))),He=Ge(M=>t.events.on("keyRelease",M),(M,L)=>t.events.on("keyRelease",F=>_t(M,F)&&L(F))),ee=Ge(M=>t.events.on("mouseDown",L=>M(L)),(M,L)=>t.events.on("mouseDown",F=>_t(M,F)&&L(F))),K=Ge(M=>t.events.on("mousePress",L=>M(L)),(M,L)=>t.events.on("mousePress",F=>_t(M,F)&&L(F))),Z=Ge(M=>t.events.on("mouseRelease",L=>M(L)),(M,L)=>t.events.on("mouseRelease",F=>F===M&&L(F)));function q(M){return t.events.on("mouseMove",()=>M(_(),p()))}function j(M){return t.events.on("charInput",M)}function ae(M){return t.events.on("touchStart",M)}function ge(M){return t.events.on("touchMove",M)}function he(M){return t.events.on("touchEnd",M)}function me(M){return t.events.on("scroll",M)}function Se(M){return t.events.on("hide",M)}function it(M){return t.events.on("show",M)}let Zt=Ge(M=>t.events.on("gamepadButtonPress",(L,F)=>M(L,F)),(M,L)=>t.events.on("gamepadButtonPress",(F,te)=>_t(M,F)&&L(F,te))),Kt=Ge(M=>t.events.on("gamepadButtonDown",(L,F)=>M(L,F)),(M,L)=>t.events.on("gamepadButtonDown",(F,te)=>_t(M,F)&&L(F,te))),Lt=Ge(M=>t.events.on("gamepadButtonRelease",(L,F)=>M(L,F)),(M,L)=>t.events.on("gamepadButtonRelease",(F,te)=>_t(M,F)&&L(F,te)));function Ve(M,L){return t.events.on("gamepadStick",(F,te,ye)=>F===M&&L(te,ye))}function St(M){t.events.on("gamepadConnect",M)}function xt(M){t.events.on("gamepadDisconnect",M)}function Qe(M){return t.mergedGamepadState.stickState.get(M)||new Y(0)}function ke(){return[...t.charInputted]}function Ze(){return[...t.gamepads]}let zt=Ge(M=>t.events.on("buttonPress",L=>M(L)),(M,L)=>t.events.on("buttonPress",F=>_t(M,F)&&L(F))),Nt=Ge(M=>t.events.on("buttonDown",L=>M(L)),(M,L)=>t.events.on("buttonDown",F=>_t(M,F)&&L(F))),et=Ge(M=>t.events.on("buttonRelease",L=>M(L)),(M,L)=>t.events.on("buttonRelease",F=>_t(M,F)&&L(F)));function dt(){t.events.trigger("input"),t.keyState.down.forEach(M=>t.events.trigger("keyDown",M)),t.mouseState.down.forEach(M=>t.events.trigger("mouseDown",M)),t.buttonState.down.forEach(M=>{t.events.trigger("buttonDown",M)}),vi()}function ts(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((M,L)=>{t.mergedGamepadState.stickState.set(L,new Y(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new Y(0),t.gamepadStates.forEach(M=>{M.buttonState.update(),M.stickState.forEach((L,F)=>{M.stickState.set(F,new Y(0))})})}function jt(M){let L={index:M.index,isPressed:F=>{var te;return((te=t.gamepadStates.get(M.index))==null?void 0:te.buttonState.pressed.has(F))||!1},isDown:F=>{var te;return((te=t.gamepadStates.get(M.index))==null?void 0:te.buttonState.down.has(F))||!1},isReleased:F=>{var te;return((te=t.gamepadStates.get(M.index))==null?void 0:te.buttonState.released.has(F))||!1},getStick:F=>{var te;return((te=t.gamepadStates.get(M.index))==null?void 0:te.stickState.get(F))||H()}};return t.gamepads.push(L),t.gamepadStates.set(M.index,{buttonState:new xs,stickState:new Map([["left",new Y(0)],["right",new Y(0)]])}),L}function Bs(M){t.gamepads=t.gamepads.filter(L=>L.index!==M.index),t.gamepadStates.delete(M.index)}function vi(){var M,L;for(let F of navigator.getGamepads())F&&!t.gamepadStates.has(F.index)&&jt(F);for(let F of t.gamepads){let te=navigator.getGamepads()[F.index];if(!te)continue;let ye=(e.gamepads??{})[te.id]||Zn[te.id]||Zn.default,Le=t.gamepadStates.get(F.index);if(Le){for(let Xe=0;Xe<te.buttons.length;Xe++){let Ke=ye.buttons[Xe],Ut=te.buttons[Xe],vt=t.buttonsByGamepad.has(Ke);if(Ut.pressed){if(Le.buttonState.down.has(Ke)){t.events.trigger("gamepadButtonDown",Ke,F);continue}t.lastInputDevice="gamepad",vt&&((M=t.buttonsByGamepad.get(Ke))==null||M.forEach(wt=>{t.buttonState.press(wt),t.events.trigger("buttonPress",wt)})),t.mergedGamepadState.buttonState.press(Ke),Le.buttonState.press(Ke),t.events.trigger("gamepadButtonPress",Ke,F)}else Le.buttonState.down.has(Ke)&&(vt&&((L=t.buttonsByGamepad.get(Ke))==null||L.forEach(wt=>{t.buttonState.release(wt),t.events.trigger("buttonRelease",wt)})),t.mergedGamepadState.buttonState.release(Ke),Le.buttonState.release(Ke),t.events.trigger("gamepadButtonRelease",Ke,F))}for(let Xe in ye.sticks){let Ke=ye.sticks[Xe];if(!Ke)continue;let Ut=new Y(te.axes[Ke.x],te.axes[Ke.y]);Le.stickState.set(Xe,Ut),t.mergedGamepadState.stickState.set(Xe,Ut),t.events.trigger("gamepadStick",Xe,Ut,F)}}}}let yt={},Rt={},Wt={},Fe=e.pixelDensity||1;yt.mousemove=M=>{let L=lo(new Y(M.offsetX,M.offsetY)),F=new Y(M.movementX,M.movementY);if(w()){let te=t.canvas.width/Fe,ye=t.canvas.height/Fe,Le=window.innerWidth,Xe=window.innerHeight,Ke=Le/Xe,Ut=te/ye;if(Ke>Ut){let vt=Xe/ye,wt=(Le-te*vt)/2;L.x=oo(M.offsetX-wt,0,te*vt,0,te),L.y=oo(M.offsetY,0,ye*vt,0,ye)}else{let vt=Le/te,wt=(Xe-ye*vt)/2;L.x=oo(M.offsetX,0,te*vt,0,te),L.y=oo(M.offsetY-wt,0,ye*vt,0,ye)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=L,t.mouseDeltaPos=F,t.events.trigger("mouseMove")})};let Dt=["left","middle","right","back","forward"];yt.mousedown=M=>{t.events.onOnce("input",()=>{var F;let L=Dt[M.button];L&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(L)&&((F=t.buttonsByMouse.get(L))==null||F.forEach(te=>{t.buttonState.press(te),t.events.trigger("buttonPress",te)})),t.mouseState.press(L),t.events.trigger("mousePress",L))})},yt.mouseup=M=>{t.events.onOnce("input",()=>{var F;let L=Dt[M.button];L&&(t.buttonsByMouse.has(L)&&((F=t.buttonsByMouse.get(L))==null||F.forEach(te=>{t.buttonState.release(te),t.events.trigger("buttonRelease",te)})),t.mouseState.release(L),t.events.trigger("mouseRelease",L))})};let nt=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),Ht={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};yt.keydown=M=>{nt.has(M.key)&&M.preventDefault(),t.events.onOnce("input",()=>{var te,ye;let L=Ht[M.key]||M.key.toLowerCase(),F=M.code;if(L===void 0)throw new Error(`Unknown key: ${M.key}`);L.length===1?(t.events.trigger("charInput",L),t.charInputted.push(L)):L==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),M.repeat?(t.keyState.pressRepeat(L),t.events.trigger("keyPressRepeat",L)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(L)&&((te=t.buttonsByKey.get(L))==null||te.forEach(Le=>{t.buttonState.press(Le),t.events.trigger("buttonPress",Le)})),t.buttonsByKeyCode.has(F)&&((ye=t.buttonsByKeyCode.get(F))==null||ye.forEach(Le=>{t.buttonState.press(Le),t.events.trigger("buttonPress",Le)})),t.keyState.press(L),t.events.trigger("keyPressRepeat",L),t.events.trigger("keyPress",L))})},yt.keyup=M=>{t.events.onOnce("input",()=>{var te,ye;let L=Ht[M.key]||M.key.toLowerCase(),F=M.code;t.buttonsByKey.has(L)&&((te=t.buttonsByKey.get(L))==null||te.forEach(Le=>{t.buttonState.release(Le),t.events.trigger("buttonRelease",Le)})),t.buttonsByKeyCode.has(F)&&((ye=t.buttonsByKeyCode.get(F))==null||ye.forEach(Le=>{t.buttonState.release(Le),t.events.trigger("buttonRelease",Le)})),t.keyState.release(L),t.events.trigger("keyRelease",L)})},yt.touchstart=M=>{M.preventDefault(),t.events.onOnce("input",()=>{var te;let L=[...M.changedTouches],F=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=lo(new Y(L[0].clientX-F.x,L[0].clientY-F.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&((te=t.buttonsByMouse.get("left"))==null||te.forEach(ye=>{t.buttonState.press(ye),t.events.trigger("buttonPress",ye)})),t.mouseState.press("left"),t.events.trigger("mousePress","left")),L.forEach(ye=>{t.events.trigger("touchStart",lo(new Y(ye.clientX-F.x,ye.clientY-F.y)),ye)})})},yt.touchmove=M=>{M.preventDefault(),t.events.onOnce("input",()=>{let L=[...M.changedTouches],F=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let te=t.mousePos;t.mousePos=lo(new Y(L[0].clientX-F.x,L[0].clientY-F.y)),t.mouseDeltaPos=t.mousePos.sub(te),t.events.trigger("mouseMove")}L.forEach(te=>{t.events.trigger("touchMove",lo(new Y(te.clientX-F.x,te.clientY-F.y)),te)})})},yt.touchend=M=>{t.events.onOnce("input",()=>{var te;let L=[...M.changedTouches],F=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=lo(new Y(L[0].clientX-F.x,L[0].clientY-F.y)),t.mouseDeltaPos=new Y(0,0),t.buttonsByMouse.has("left")&&((te=t.buttonsByMouse.get("left"))==null||te.forEach(ye=>{t.buttonState.release(ye),t.events.trigger("buttonRelease",ye)})),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),L.forEach(ye=>{t.events.trigger("touchEnd",lo(new Y(ye.clientX-F.x,ye.clientY-F.y)),ye)})})},yt.touchcancel=M=>{t.events.onOnce("input",()=>{let L=[...M.changedTouches],F=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=lo(new Y(L[0].clientX-F.x,L[0].clientY-F.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),L.forEach(te=>{t.events.trigger("touchEnd",lo(new Y(te.clientX-F.x,te.clientY-F.y)),te)})})},yt.wheel=M=>{M.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new Y(M.deltaX,M.deltaY))})},yt.contextmenu=M=>M.preventDefault(),Rt.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},Wt.gamepadconnected=M=>{let L=jt(M.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",L)})},Wt.gamepaddisconnected=M=>{let L=Ze().filter(F=>F.index===M.gamepad.index)[0];Bs(M.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",L)})};for(let[M,L]of Object.entries(yt))t.canvas.addEventListener(M,L);for(let[M,L]of Object.entries(Rt))document.addEventListener(M,L);for(let[M,L]of Object.entries(Wt))window.addEventListener(M,L);let ut=new ResizeObserver(M=>{for(let L of M)if(L.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return ut.observe(t.canvas),{state:t,dt:o,fixedDt:s,restDt:i,time:r,run:R,canvas:t.canvas,fps:h,numFrames:l,quit:D,isHidden:a,setFullscreen:g,isFullscreen:w,setCursor:c,screenshot:n,getGamepads:Ze,getCursor:u,setCursorLocked:d,isCursorLocked:x,isTouchscreen:X,mousePos:_,mouseDeltaPos:p,isKeyDown:B,isKeyPressed:C,isKeyPressedRepeat:N,isKeyReleased:v,isMouseDown:b,isMousePressed:y,isMouseReleased:E,isMouseMoved:T,isGamepadButtonPressed:z,isGamepadButtonDown:G,isGamepadButtonReleased:J,getGamepadStick:Qe,isButtonPressed:se,isButtonDown:V,isButtonReleased:k,setButton:oe,getButton:fe,pressButton:Ie,releaseButton:Ee,charInputted:ke,onResize:Re,onKeyDown:Ae,onKeyPress:Ce,onKeyPressRepeat:Te,onKeyRelease:He,onMouseDown:ee,onMousePress:K,onMouseRelease:Z,onMouseMove:q,onCharInput:j,onTouchStart:ae,onTouchMove:ge,onTouchEnd:he,onScroll:me,onHide:Se,onShow:it,onGamepadButtonDown:Kt,onGamepadButtonPress:Zt,onGamepadButtonRelease:Lt,onGamepadStick:Ve,onGamepadConnect:St,onGamepadDisconnect:xt,onButtonPress:zt,onButtonDown:Nt,onButtonRelease:et,getLastInputDeviceType:gh,events:t.events}};function ht(){return m.app.dt()}function $i(){return m.app.fixedDt()}function Ji(){return m.app.restDt()}var Ah=new Y(-1,-1),vh=new Y(0,-1),Eh=new Y(1,-1),Mh=new Y(-1,0),Sh=new Y(0,0),Rh=new Y(1,0),Dh=new Y(-1,1),Th=new Y(0,1),Ch=new Y(1,1);function ko(e){switch(e){case"topleft":return Ah;case"top":return vh;case"topright":return Eh;case"left":return Mh;case"center":return Sh;case"right":return Rh;case"botleft":return Dh;case"bot":return Th;case"botright":return Ch;default:return e}}function Ih(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function Ph(e){return e.createBuffer(1,1,44100)}var Hs=2.5949095,kn=1.70158+1,ea=2*Math.PI/3,ta=2*Math.PI/4.5,Ys={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>kn*e*e*e-1.70158*e*e,easeOutBack:e=>1+kn*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((Hs+1)*2*e-Hs)/2:(Math.pow(2*e-2,2)*((Hs+1)*(e*2-2)+Hs)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*ea),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*ea)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*ta))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*ta)/2+1,easeInBounce:e=>1-Ys.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Ys.easeOutBounce(1-2*e))/2:(1+Ys.easeOutBounce(2*e-1))/2},Ms=Ys;function Bh(e,t,o){let s=[],i=t;for(s.push(i);i!==e;){if(i=o.get(i),i==null)return null;s.push(i)}return s.reverse()}function Oh(e,t,o){var r;let s=new or((h,l)=>h.cost<l.cost);s.insert({cost:0,node:t});let i=new Map;i.set(t,t);let a=new Map;for(a.set(t,0);s.length!==0;){let h=(r=s.remove())==null?void 0:r.node;if(h===o)break;let l=e.getNeighbours(h);for(let n of l){let c=(a.get(h)||0)+e.getCost(h,n)+e.getHeuristic(n,o);(!a.has(n)||c<a.get(n))&&(a.set(n,c),s.insert({cost:c,node:n}),i.set(n,h))}}return Bh(t,o,i)}var Lh=class{constructor(e,t,o){O(this,"a");O(this,"b");O(this,"polygon");this.a=e,this.b=t,this.polygon=new WeakRef(o)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},zh=class{constructor(e){O(this,"_edges");O(this,"_centroid");O(this,"_id");this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,o=0,s=0;for(let i of this._edges){i.polygon=new WeakRef(this);let a=i.a.x*i.b.y-i.a.y*i.b.x;t+=(i.a.x+i.b.x)*a,o+=(i.a.y+i.b.y)*a,s+=a}s/=2,this._centroid=H(t/(6*s),o/(6*s))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let o of this.edges)o.b.y>e.y!=o.a.y>e.y&&e.x<(o.a.x-o.b.x)*(e.y-o.b.y)/(o.a.y-o.b.y)+o.b.x&&(t=!t);return t}},Nh=class{constructor(){O(this,"_polygons");O(this,"_pointCache");O(this,"_edgeCache");this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let o=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[o]}_findCommonEdge(e,t){for(let o of e.edges){let s=this._findEdge(o.b,o.a);if(s&&s.polygon.deref().id===t.id)return s}return null}addPolygon(e){let t=new zh(this._polygons.length),o=e.map((s,i)=>new Lh(s,e[(i+1)%e.length],t));t.edges=o,this._polygons.push(t);for(let s of t.edges)this._addEdge(s);return t}addRect(e,t){let o=this._addPoint(e),s=this._addPoint(e.add(t.x,0)),i=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([o,s,i,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let o of this._polygons[e].edges){let s=this._findEdge(o.b,o.a);if(s){let i=s.polygon.deref();i&&t.push(i.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let o=this._polygons[e],s=this._polygons[t],i=o.centroid.x-s.centroid.x,a=o.centroid.y-s.centroid.y;return Math.sqrt(i*i+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:Oh(this,e,t)}getWaypointPath(e,t,o){let s=(o==null?void 0:o.type)||"centroids",i=this._getLocation(e),a=this._getLocation(t);if(i===void 0||a===void 0)return[];let r=this.getPath(i.id,a.id);if(!r)return[];if(s==="edges"){let h=[];for(let l=1;l<r.length;l++){let n=this._polygons[r[l-1]],c=this._polygons[r[l]],u=this._findCommonEdge(n,c);h.push(u.middle.add(c.centroid.sub(u.middle).unit().scale(4)))}return[e,...h,t]}else return[e,...r.slice(1,-1).map(h=>this._polygons[h].centroid),t]}};function ys(e){let t=new ao;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function Hh(e){return new Y(e.x/gt()*2-1,-e.y/At()*2+1)}function us(e,t,o,s,i,a=1){s=st(s%360),i=st(i%360),i<=s&&(i+=Math.PI*2);let r=[],h=Math.ceil((i-s)/st(8)*a),l=(i-s)/h,n=H(Math.cos(s),Math.sin(s)),c=H(Math.cos(l),Math.sin(l));for(let u=0;u<=h;u++)r.push(e.add(t*n.x,o*n.y)),n=H(n.x*c.x-n.y*c.y,n.x*c.y+n.y*c.x);return r}function Uh(...e){let t=Ne(...e),o=e[3]??1;m.gfx.bgColor=t,m.gfx.bgAlpha=o,m.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,o)}function _h(){var e,t;return((t=(e=m.gfx.bgColor)==null?void 0:e.clone)==null?void 0:t.call(e))??null}function Je(...e){if(e[0]===void 0)return;let t=H(...e);t.x===0&&t.y===0||m.gfx.transform.translate(t)}function Ft(){m.gfx.transformStack.push(m.gfx.transform.clone())}function qh(e){m.gfx.transform=e.clone()}function Ss(...e){if(e[0]===void 0)return;let t=H(...e);t.x===1&&t.y===1||m.gfx.transform.scale(t)}function Wo(e){e&&m.gfx.transform.rotate(e)}function Tt(){m.gfx.transformStack.length>0&&(m.gfx.transform=m.gfx.transformStack.pop())}function Yt(){m.gfx.renderer.flush()}function gt(){return m.gfx.width}function At(){return m.gfx.height}function ar(){return(m.gfx.viewport.width+m.gfx.viewport.height)/(m.gfx.width+m.gfx.height)}function Qs(){return H(gt()/2,At()/2)}var Fh=class{constructor(e,t,o,s){O(this,"lastTextureId",0);O(this,"textures",[]);O(this,"bigTextures",[]);O(this,"texturesPosition",new Map);O(this,"canvas");O(this,"c2d");O(this,"x",0);O(this,"y",0);O(this,"curHeight",0);O(this,"gfx");O(this,"padding");this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.textures=[Mo.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=s;let i=this.canvas.getContext("2d");if(!i)throw new Error("Failed to get 2d context");this.c2d=i}addSingle(e){let t=Mo.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new We(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,o=e.height+this.padding*2;if(t>this.canvas.width||o>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+o>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(Mo.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let s=this.textures[this.textures.length-1],i=new Y(this.x+this.padding,this.y+this.padding);return this.x+=t,o>this.curHeight&&(this.curHeight=o),e instanceof ImageData?this.c2d.putImageData(e,i.x,i.y):this.c2d.drawImage(e,i.x,i.y),s.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:i,size:new Y(e.width,e.height),texture:s}),this.lastTextureId++,[s,new We(i.x/this.canvas.width,i.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Gt(e){return typeof e!="string"||ir(e)?e:m.assets.urlPrefix+e}var Vt=class rr{constructor(t){O(this,"loaded",!1);O(this,"data",null);O(this,"error",null);O(this,"onLoadEvents",new Et);O(this,"onErrorEvents",new Et);O(this,"onFinishEvents",new Et);t.then(o=>{this.loaded=!0,this.data=o,this.onLoadEvents.trigger(o)}).catch(o=>{if(this.error=o,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(o);else throw o}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let o=new rr(Promise.resolve(t));return o.data=t,o.loaded=!0,o}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},Xo=class{constructor(){O(this,"assets",new Map);O(this,"lastUID",0)}add(e,t){let o=e??this.lastUID+++"",s=new Vt(t);return this.assets.set(o,s),s}addLoaded(e,t){let o=e??this.lastUID+++"",s=Vt.loaded(t);return this.assets.set(o,s),s}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function Dn(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function pi(e){return Dn(e).then(t=>t.json())}function Yh(e){return Dn(e).then(t=>t.text())}function Xh(e){return Dn(e).then(t=>t.arrayBuffer())}function Gh(e){return e!==void 0&&(m.assets.urlPrefix=e),m.assets.urlPrefix}function Vh(e,t){return m.assets.custom.add(e,pi(Gt(t)))}function fi(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((o,s)=>{t.onload=()=>o(t),t.onerror=()=>s(new Error(`Failed to load image from "${e}"`))})}function No(){let e=[m.assets.sprites,m.assets.sounds,m.assets.shaders,m.assets.fonts,m.assets.bitmapFonts,m.assets.custom];return e.reduce((t,o)=>t+o.progress(),0)/e.length}function lr(){return[m.assets.sprites,m.assets.sounds,m.assets.shaders,m.assets.fonts,m.assets.bitmapFonts,m.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function Kh(e){return m.assets.custom.get(e)??null}function Qi(e){return m.assets.custom.add(null,e)}var jh=(e,t)=>({urlPrefix:"",sprites:new Xo,fonts:new Xo,bitmapFonts:new Xo,sounds:new Xo,shaders:new Xo,custom:new Xo,music:{},packer:new Fh(e,2048,2048,t),loaded:!1}),Wh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Do=class ps{constructor(t,o,s={},i=null){O(this,"tex");O(this,"frames",[new We(0,0,1,1)]);O(this,"anims",{});O(this,"slice9",null);this.tex=t,o&&(this.frames=o),this.anims=s,this.slice9=i}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,o={}){return typeof t=="string"?ps.fromURL(t,o):Promise.resolve(ps.fromImage(t,o))}static fromImage(t,o={}){let[s,i]=o.singular?m.assets.packer.addSingle(t):m.assets.packer.add(t),a=o.frames?o.frames.map(r=>new We(i.x+r.x*i.w,i.y+r.y*i.h,r.w*i.w,r.h*i.h)):hr(o.sliceX||1,o.sliceY||1,i.x,i.y,i.w,i.h);return new ps(s,a,o.anims,o.slice9)}static fromURL(t,o={}){return fi(t).then(s=>ps.fromImage(s,o))}};function Xs(e){if(typeof e=="string"){let t=cr(e);if(t)return t;if(No()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Do)return Vt.loaded(e);if(e instanceof Vt)return e;throw new Error(`Invalid sprite: ${e}`)}}function cr(e){return m.assets.sprites.get(e)??null}function ws(e,t,o={sliceX:1,sliceY:1,anims:{}}){return t=Gt(t),Array.isArray(t)?t.some(s=>typeof s=="string")?m.assets.sprites.add(e,Promise.all(t.map(s=>typeof s=="string"?fi(s):Promise.resolve(s))).then(s=>oa(s,o))):m.assets.sprites.addLoaded(e,oa(t,o)):typeof t=="string"?m.assets.sprites.add(e,Do.from(t,o)):m.assets.sprites.addLoaded(e,Do.fromImage(t,o))}function hr(e=1,t=1,o=0,s=0,i=1,a=1){let r=[],h=i/e,l=a/t;for(let n=0;n<t;n++)for(let c=0;c<e;c++)r.push(new We(o+c*h,s+n*l,h,l));return r}function oa(e,t={}){let o=document.createElement("canvas"),s=e[0].width,i=e[0].height;o.width=s*e.length,o.height=i;let a=o.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((h,l)=>{h instanceof ImageData?a.putImageData(h,l*s,0):a.drawImage(h,l*s,0)});let r=a.getImageData(0,0,e.length*s,i);return Do.fromImage(r,{...t,sliceX:e.length,sliceY:1})}function $h(e="bean"){return ws(e,Wh)}function Jh(e,t,o){t=Gt(t),o=Gt(o),typeof t=="string"&&!o&&(o=Zc(t)+".json");let s=typeof o=="string"?pi(o):Promise.resolve(o);return m.assets.sprites.add(e,s.then(i=>{let a=i.meta.size,r=i.frames.map(l=>new We(l.frame.x/a.w,l.frame.y/a.h,l.frame.w/a.w,l.frame.h/a.h)),h={};for(let l of i.meta.frameTags)l.from===l.to?h[l.name]=l.from:h[l.name]={from:l.from,to:l.to,speed:10,loop:!0,pingpong:l.direction==="pingpong"};return Do.from(t,{frames:r,anims:h})}))}var Gs=class{constructor(e,t={}){O(this,"fontface");O(this,"filter",Vi);O(this,"outline",null);O(this,"size",64);if(this.fontface=e,this.filter=t.filter??Vi,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Ne(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function dr(e){if(!e)return dr(m.globalOpt.font??Nc);if(typeof e=="string"){let t=pr(e),o=ur(e);if(t)return t.data??t;if(o)return o.data??o;if(document.fonts.check(`64px ${e}`))return e;if(No()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof Vt)return e.data?e.data:e;return e}function ur(e){return m.assets.fonts.get(e)??null}function Qh(e,t,o={}){let s=Gt(t),i=new FontFace(e,typeof t=="string"?`url(${s})`:s);return document.fonts.add(i),m.assets.fonts.add(e,i.load().catch(a=>{throw new Error(`Failed to load font from "${s}": ${a}`)}).then(a=>new Gs(a,o)))}function Zh(e,t,o,s){let i=e.width/t,a={},r=s.split("").entries();for(let[h,l]of r)a[l]=new We(h%i*t,Math.floor(h/i)*o,t,o);return{tex:e,map:a,size:o}}function pr(e){return m.assets.bitmapFonts.get(e)??null}function kh(e,t,o,s,i={}){let a=Gt(t);return m.assets.bitmapFonts.add(e,fi(a).then(r=>Zh(Mo.fromImage(m.gfx.ggl,r,i),o,s,i.chars??Qa)))}function ed(e,t){return t=Gt(t),m.assets.sprites.add(e,new Promise(async o=>{let s=typeof t=="string"?await pi(t):t,i=await Promise.all(s.frames.map(fi)),a=document.createElement("canvas");a.width=s.width,a.height=s.height*s.frames.length;let r=a.getContext("2d");if(!r)throw new Error("Failed to create canvas context");i.forEach((l,n)=>{r.drawImage(l,0,n*s.height)});let h=await ws(null,a,{sliceY:s.frames.length,anims:s.anims});o(h)}))}var td=class{constructor(e,t,o,s){O(this,"ctx");O(this,"glProgram");this.ctx=e,e.onDestroy(()=>this.free());let i=e.gl,a=i.createShader(i.VERTEX_SHADER),r=i.createShader(i.FRAGMENT_SHADER);if(!a||!r)throw new Error("Failed to create shader");i.shaderSource(a,t),i.shaderSource(r,o),i.compileShader(a),i.compileShader(r);let h=i.createProgram();if(this.glProgram=h,i.attachShader(h,a),i.attachShader(h,r),s.forEach((l,n)=>i.bindAttribLocation(h,n,l)),i.linkProgram(h),!i.getProgramParameter(h,i.LINK_STATUS)){let l=i.getShaderInfoLog(a);if(l)throw new Error("VERTEX SHADER "+l);let n=i.getShaderInfoLog(r);if(n)throw new Error("FRAGMENT SHADER "+n)}i.deleteShader(a),i.deleteShader(r)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let o in e){let s=e[o],i=t.getUniformLocation(this.glProgram,o);if(typeof s=="number")t.uniform1f(i,s);else if(s instanceof ao)t.uniformMatrix4fv(i,!1,new Float32Array(s.m));else if(s instanceof Be)t.uniform3f(i,s.r,s.g,s.b);else if(s instanceof Y)t.uniform2f(i,s.x,s.y);else if(Array.isArray(s))s[0],Wc(s)?t.uniform1fv(i,s):jc(s)?t.uniform2fv(i,s.map(a=>[a.x,a.y]).flat()):Kc(s)&&t.uniform3fv(i,s.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function Tn(e,t=Ki,o=ji){let s=qc.replace("{{user}}",t??Ki),i=Fc.replace("{{user}}",o??ji);try{return new td(e,s,i,En.map(a=>a.name))}catch(a){let r=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,h=kc(a).match(r);if(!(h!=null&&h.groups))throw a;let l=Number(h.groups.line)-14,n=h.groups.msg.trim(),c=h.groups.type.toLowerCase();throw new Error(`${c} shader line ${l}: ${n}`)}}function od(e){if(!e)return m.gfx.defShader;if(typeof e=="string"){let t=fr(e);if(t)return t.data??t;if(No()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof Vt)return e.data?e.data:e;return e}function fr(e){return m.assets.shaders.get(e)??null}function sd(e,t,o){return m.assets.shaders.addLoaded(e,Tn(m.gfx.ggl,t,o))}function id(e,t,o){t=Gt(t),o=Gt(o);let s=a=>a?Yh(a):Promise.resolve(null),i=Promise.all([s(t),s(o)]).then(([a,r])=>Tn(m.gfx.ggl,a,r));return m.assets.shaders.add(e,i)}var Rs=class Vs{constructor(t){O(this,"buf");this.buf=t}static fromArrayBuffer(t){return new Promise((o,s)=>m.audio.ctx.decodeAudioData(t,o,s)).then(o=>new Vs(o))}static fromURL(t){return ir(t)?Vs.fromArrayBuffer(Jc(t)):Xh(t).then(o=>Vs.fromArrayBuffer(o))}};function nd(e){if(typeof e=="string"){let t=gr(e);if(t)return t;if(No()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof Rs)return Vt.loaded(e);if(e instanceof Vt)return e;throw new Error(`Invalid sound: ${e}`)}}function gr(e){return m.assets.sounds.get(e)??null}function ad(e,t){return t=Gt(t),m.assets.sounds.add(e,typeof t=="string"?Rs.fromURL(t):Rs.fromArrayBuffer(t))}function rd(e,t){let o=Gt(t),s=new Audio(o);return s.preload="auto",m.assets.music[e]=o}function mr(e,t){return e=Gt(e),Qi(typeof t=="string"?new Promise((o,s)=>{pi(t).then(i=>{mr(e,i).then(o).catch(s)})}):Do.from(e).then(o=>{let s={};for(let i in t){let a=t[i],r=o.frames[0],h=2048*r.w,l=2048*r.h,n=a.frames?a.frames.map(u=>new We(r.x+(a.x+u.x)/h*r.w,r.y+(a.y+u.y)/l*r.h,u.w/h*r.w,u.h/l*r.h)):hr(a.sliceX||1,a.sliceY||1,r.x+a.x/h*r.w,r.y+a.y/l*r.h,a.width/h*r.w,a.height/l*r.h),c=new Do(o.tex,n,a.anims);m.assets.sprites.addLoaded(i,c),s[i]=c}return s}))}function Co(e,t,o=!1,s,i,a={}){let r=s??m.gfx.defTex,h=i??m.gfx.defShader,l=od(h);if(!l||l instanceof Vt)return;let n=m.gfx.fixed||o?m.gfx.transform:m.game.cam.transform.mult(m.gfx.transform),c=[];for(let u of e){let d=Hh(n.multVec2(u.pos));c.push(d.x,d.y,u.uv.x,u.uv.y,u.color.r/255,u.color.g/255,u.color.b/255,u.opacity)}m.gfx.renderer.push(m.gfx.ggl.gl.TRIANGLES,c,t,l,r,a)}function Eo(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Ft(),Je(e.pos),Ss(e.scale),Wo(e.angle),Je(e.offset),e.fill!==!1){let o=e.color??Be.WHITE,s=e.pts.map((a,r)=>({pos:new Y(a.x,a.y),uv:e.uv?e.uv[r]:new Y(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(o):o,opacity:e.opacity??1})),i;e.triangulate?i=Ja(e.pts).map(a=>a.map(r=>e.pts.indexOf(r))).flat():i=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),Co(s,e.indices??i,e.fixed,e.uv?e.tex:m.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&Cn({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),Tt()}}function xr(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,o=e.end??360,s=ko(e.anchor??"center").scale(new Y(-e.radiusX,-e.radiusY)),i=us(s,e.radiusX,e.radiusY,t,o,e.resolution);i.unshift(s);let a=Object.assign({},e,{pts:i,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(i.length-1).fill(e.gradient[1])]}:{}});if(o-t>=360&&e.outline){e.fill!==!1&&Eo(Object.assign({},a,{outline:null})),Eo(Object.assign({},a,{pts:i.slice(1),fill:!1}));return}Eo(a)}function es(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&xr(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function fs(e){let{p1:t,p2:o}=e;if(!t||!o)throw new Error('drawLine() requires properties "p1" and "p2".');let s=e.width||1,i=o.sub(t).unit().normal().scale(s*.5),a=[t.sub(i),t.add(i),o.add(i),o.sub(i)].map(r=>({pos:new Y(r.x,r.y),uv:new Y(0),color:e.color??Be.WHITE,opacity:e.opacity??1}));Co(a,[0,1,3,1,2,3],e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function ld(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||H(0,0),r;i?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let h=r.len(),l=r.normal().scale(-s/h),n,c=t[0];if(!i)switch(e.cap){case"square":{let f=r.scale(-s/h);o.push(c.add(f).add(l)),o.push(c.add(f).sub(l));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=l.scale(-1),w=Math.cos(A),D=Math.sin(A);for(let R=0;R<f;R++)o.push(c),o.push(c.sub(g)),g=H(g.x*w-g.y*D,g.x*D+g.y*w)}}for(let f=1;f<t.length;f++){if(c===t[f]||c.eq(t[f]))continue;n=c,c=t[f];let A=c.sub(n),g=A.len(),w=A.normal().scale(-s/g),D=r.cross(A);if(Math.abs(D)/(h*g)<.05){o.push(n.add(l)),o.push(n.sub(l)),r.dot(A)<0&&(o.push(n.sub(l)),o.push(n.add(l))),r=A,h=g,l=w;continue}let R=w.sub(l).cross(A)/D,X=l.add(r.scale(R));D>0?(o.push(n.add(X)),o.push(n.sub(l)),o.push(n.add(X)),o.push(n.sub(w))):(o.push(n.add(l)),o.push(n.sub(X)),o.push(n.add(w)),o.push(n.sub(X))),r=A,h=g,l=w}if(!i)switch(o.push(c.add(l)),o.push(c.sub(l)),e.cap){case"square":{let f=r.scale(s/h);o.push(c.add(f).add(l)),o.push(c.add(f).sub(l));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=l.scale(1),w=Math.cos(A),D=Math.sin(A);for(let R=0;R<f;R++)g=H(g.x*w-g.y*D,g.x*D+g.y*w),o.push(c),o.push(c.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:H(),color:e.color||Be.WHITE,opacity:e.opacity??1})),d=[],x=0;for(let f=0;f<o.length-2;f+=2)d[x++]=f+1,d[x++]=f,d[x++]=f+2,d[x++]=f+2,d[x++]=f+3,d[x++]=f+1;i&&(d[x++]=o.length-1,d[x++]=o.length-2,d[x++]=0,d[x++]=0,d[x++]=1,d[x++]=o.length-1),Co(u,d,e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function cd(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||H(0,0),r;i?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let h=r.len(),l=r.normal().scale(-s/h),n,c=t[0];if(!i)switch(e.cap){case"square":{let f=r.scale(-s/h);o.push(c.add(f).add(l)),o.push(c.add(f).sub(l));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=l.scale(-1),w=Math.cos(A),D=Math.sin(A);for(let R=0;R<f;R++)o.push(c),o.push(c.sub(g)),g=H(g.x*w-g.y*D,g.x*D+g.y*w)}}for(let f=1;f<t.length;f++){if(c===t[f]||c.eq(t[f]))continue;n=c,c=t[f];let A=c.sub(n),g=A.len(),w=A.normal().scale(-s/g),D=r.cross(A);if(Math.abs(D)/(h*g)<.05){o.push(n.add(l)),o.push(n.sub(l)),r.dot(A)<0&&(o.push(n.sub(l)),o.push(n.add(l))),r=A,h=g,l=w;continue}let R=w.sub(l).cross(A)/D,X=l.add(r.scale(R));if(D>0){let _=n.add(X),p=Math.max(s,10),y=st(l.angleBetween(w)/p),b=l,E=Math.cos(y),T=Math.sin(y);for(let C=0;C<p;C++)o.push(_),o.push(n.sub(b)),b=H(b.x*E-b.y*T,b.x*T+b.y*E)}else{let _=n.sub(X),p=Math.max(s,10),y=st(l.angleBetween(w)/p),b=l,E=Math.cos(y),T=Math.sin(y);for(let C=0;C<p;C++)o.push(n.add(b)),o.push(_),b=H(b.x*E-b.y*T,b.x*T+b.y*E)}r=A,h=g,l=w}if(!i)switch(o.push(c.add(l)),o.push(c.sub(l)),e.cap){case"square":{let f=r.scale(s/h);o.push(c.add(f).add(l)),o.push(c.add(f).sub(l));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=l.scale(1),w=Math.cos(A),D=Math.sin(A);for(let R=0;R<f;R++)g=H(g.x*w-g.y*D,g.x*D+g.y*w),o.push(c),o.push(c.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:H(),color:e.color||Be.WHITE,opacity:e.opacity??1})),d=[],x=0;for(let f=0;f<o.length-2;f+=2)d[x++]=f+1,d[x++]=f,d[x++]=f+2,d[x++]=f+2,d[x++]=f+3,d[x++]=f+1;i&&(d[x++]=o.length-1,d[x++]=o.length-2,d[x++]=0,d[x++]=0,d[x++]=1,d[x++]=o.length-1),Co(u,d,e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function hd(e){let t=e.pts,o=[],s=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||H(0,0),r;i?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let h=r.len(),l=r.normal().scale(-s/h),n,c=t[0];if(!i)switch(e.cap){case"square":{let f=r.scale(-s/h);o.push(c.add(f).add(l)),o.push(c.add(f).sub(l));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=l.scale(-1),w=Math.cos(A),D=Math.sin(A);for(let R=0;R<f;R++)o.push(c),o.push(c.sub(g)),g=H(g.x*w-g.y*D,g.x*D+g.y*w)}}for(let f=1;f<t.length;f++){if(c===t[f]||c.eq(t[f]))continue;n=c,c=t[f];let A=c.sub(n),g=A.len(),w=A.normal().scale(-s/g),D=r.cross(A);if(Math.abs(D)/(h*g)<.05){o.push(n.add(l)),o.push(n.sub(l)),r.dot(A)<0&&(o.push(n.sub(l)),o.push(n.add(l))),r=A,h=g,l=w;continue}let R=w.sub(l).cross(A)/D,X=l.add(r.scale(R));o.push(n.add(X)),o.push(n.sub(X)),r=A,h=g,l=w}if(!i)switch(o.push(c.add(l)),o.push(c.sub(l)),e.cap){case"square":{let f=r.scale(s/h);o.push(c.add(f).add(l)),o.push(c.add(f).sub(l));break}case"round":{let f=Math.max(s,10),A=Math.PI/f,g=l.scale(1),w=Math.cos(A),D=Math.sin(A);for(let R=0;R<f;R++)g=H(g.x*w-g.y*D,g.x*D+g.y*w),o.push(c),o.push(c.sub(g))}}if(o.length<4)return;let u=o.map(f=>({pos:a.add(f),uv:H(),color:e.color||Be.WHITE,opacity:e.opacity??1})),d=[],x=0;for(let f=0;f<o.length-2;f+=2)d[x++]=f+1,d[x++]=f,d[x++]=f+2,d[x++]=f+2,d[x++]=f+3,d[x++]=f+1;i&&(d[x++]=o.length-1,d[x++]=o.length-2,d[x++]=0,d[x++]=0,d[x++]=1,d[x++]=o.length-1),Co(u,d,e.fixed,m.gfx.defTex,e.shader,e.uniform??void 0)}function Cn(e){let t=e.pts,o=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return ld(e);case"round":return cd(e);case"miter":return hd(e)}if(e.radius&&t.length>=3){fs(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let s=1;s<t.length-2;s++){let i=t[s],a=t[s+1];fs(Object.assign({},e,{p1:i,p2:a}))}fs(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let s=0;s<t.length-1;s++)fs(Object.assign({},e,{p1:t[s],p2:t[s+1]})),e.join!=="none"&&es(Object.assign({},e,{pos:t[s],radius:o/2}))}}function yr(e,t){let o=t.segments??16,s=[];for(let i=0;i<=o;i++)s.push(e(i/o));Cn({pts:s,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function dd(e){yr(t=>vn(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var Mo=class wr{constructor(t,o,s,i={}){O(this,"ctx");O(this,"src",null);O(this,"glTex");O(this,"width");O(this,"height");this.ctx=t;let a=t.gl,r=t.gl.createTexture();if(!r)throw new Error("Failed to create texture");this.glTex=r,t.onDestroy(()=>this.free()),this.width=o,this.height=s;let h={linear:a.LINEAR,nearest:a.NEAREST}[i.filter??t.opts.texFilter??"nearest"],l={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[i.wrap??"clampToEdge"];this.bind(),o&&s&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,o,s,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,h),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,h),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,l),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,o,s={}){let i=new wr(t,o.width,o.height,s);return i.update(o),i.src=o,i}update(t,o=0,s=0){let i=this.ctx.gl;this.bind(),i.texSubImage2D(i.TEXTURE_2D,0,o,s,i.RGBA,i.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Zs=class{constructor(e,t,o,s={}){O(this,"ctx");O(this,"tex");O(this,"glFramebuffer");O(this,"glRenderbuffer");this.ctx=e;let i=e.gl;e.onDestroy(()=>this.free()),this.tex=new Mo(e,t,o,s);let a=i.createFramebuffer(),r=i.createRenderbuffer();if(!a||!r)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=r,this.bind(),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t,o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.tex.glTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let o=this.width*4,s=new Uint8Array(o);for(let i=0;i<(this.height/2|0);i++){let a=i*o,r=(this.height-i-1)*o;s.set(t.subarray(a,a+o)),t.copyWithin(a,r,r+o),t.set(s,r)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},ud=class{constructor(e,t,o,s){O(this,"ctx");O(this,"glVBuf");O(this,"glIBuf");O(this,"vqueue",[]);O(this,"iqueue",[]);O(this,"stride");O(this,"maxVertices");O(this,"maxIndices");O(this,"vertexFormat");O(this,"numDraws",0);O(this,"curPrimitive",null);O(this,"curTex",null);O(this,"curShader",null);O(this,"curUniform",{});let i=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((r,h)=>r+h.size,0),this.maxVertices=o,this.maxIndices=s;let a=i.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),i.bufferData(i.ARRAY_BUFFER,o*4,i.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=i.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),i.bufferData(i.ELEMENT_ARRAY_BUFFER,s*4,i.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,o,s,i=null,a={}){(e!==this.curPrimitive||i!==this.curTex||s!==this.curShader||!Sn(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+o.length>this.maxIndices)&&this.flush();let r=this.vqueue.length/this.stride;for(let h of t)this.vqueue.push(h);for(let h of o)this.iqueue.push(h+r);this.curPrimitive=e,this.curShader=s,this.curTex=i,this.curUniform=a}flush(){var t,o;if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),(t=this.curTex)==null||t.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),(o=this.curTex)==null||o.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Io(e){let t=[],o=a=>{t.push(a),e(a)},s=()=>{t.pop(),e(i()??null)},i=()=>t[t.length-1];return[o,s,i]}function pd(e,t={}){let o=[];function s(_){o.push(_)}function i(){o.forEach(p=>p());let _=e.getExtension("WEBGL_lose_context");_&&_.loseContext()}let a=null;function r(_){if(Sn(_,a))return;a=_;let p=_.reduce((y,b)=>y+b.size,0);_.reduce((y,b,E)=>(e.vertexAttribPointer(E,b.size,e.FLOAT,!1,p*4,y),e.enableVertexAttribArray(E),y+b.size*4),0)}let[h,l]=Io(_=>e.bindTexture(e.TEXTURE_2D,_)),[n,c]=Io(_=>e.bindBuffer(e.ARRAY_BUFFER,_)),[u,d]=Io(_=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,_)),[x,f]=Io(_=>e.bindFramebuffer(e.FRAMEBUFFER,_)),[A,g]=Io(_=>e.bindRenderbuffer(e.RENDERBUFFER,_)),[w,D]=Io(_=>{if(!_)return;let{x:p,y,w:b,h:E}=_;e.viewport(p,y,b,E)}),[R,X]=Io(_=>e.useProgram(_));return w({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:s,destroy:i,pushTexture2D:h,popTexture2D:l,pushArrayBuffer:n,popArrayBuffer:c,pushElementArrayBuffer:u,popElementArrayBuffer:d,pushFramebuffer:x,popFramebuffer:f,pushRenderbuffer:A,popRenderbuffer:g,pushViewport:w,popViewport:D,pushProgram:R,popProgram:X,setVertexFormat:r}}var Pi={};function sa(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(H(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function Zi(e){let t={},o="",s=[],i=String(e),a=r=>{s.length>0&&(t[o.length]=s.slice()),o+=r};for(;i!=="";){if(i[0]==="\\"){if(i.length===1)throw new Error("Styled text error: \\ at end of string");a(i[1]),i=i.slice(2);continue}if(i[0]==="["){let r=/^\[(\/)?(\w+?)\]/.exec(i);if(!r){a(i[0]),i=i.slice(1);continue}let[h,l,n]=r;if(l!==void 0){let c=s.pop();if(c!==n)throw c!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${c}], got [/${n}]`):new Error(`Styled text error: stray end tag [/${n}]`)}else s.push(n);i=i.slice(h.length);continue}a(i[0]),i=i.slice(1)}if(s.length>0)throw new Error(`Styled text error: unclosed tags ${s}`);return{charStyleMap:t,text:o}}function Ho(e){var R,X,_;if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=dr(e.font);if(!e.text||e.text===""||t instanceof Vt||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:o,text:s}=Zi(e.text+""),i=oh(s);if(t instanceof Gs||typeof t=="string"){let p=t instanceof Gs?t.fontface.family:t,y=t instanceof Gs?{outline:t.outline,filter:t.filter}:{outline:null,filter:Vi},b=Pi[p]??{font:{tex:new Mo(m.gfx.ggl,2048,2048,{filter:y.filter}),map:{},size:64},cursor:new Y(0),maxHeight:0,outline:y.outline};Pi[p]||(Pi[p]=b),t=b.font;for(let E of i)if(!b.font.map[E]){let T=m.fontCacheC2d;if(!T)throw new Error("fontCacheC2d is not defined.");if(!m.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");T.clearRect(0,0,m.fontCacheCanvas.width,m.fontCacheCanvas.height),T.font=`${t.size}px ${p}`,T.textBaseline="top",T.textAlign="left",T.fillStyle="#ffffff";let C=T.measureText(E),N=Math.ceil(C.width);if(!N)continue;let B=Math.ceil(Math.abs(C.actualBoundingBoxAscent))+Math.ceil(Math.abs(C.actualBoundingBoxDescent));b.outline&&b.outline.width&&b.outline.color&&(T.lineJoin="round",T.lineWidth=b.outline.width*2,T.strokeStyle=b.outline.color.toHex(),T.strokeText(E,b.outline.width,b.outline.width),N+=b.outline.width*2,B+=b.outline.width*3),T.fillText(E,((R=b.outline)==null?void 0:R.width)??0,((X=b.outline)==null?void 0:X.width)??0);let v=T.getImageData(0,0,N,B);if(b.cursor.x+N>2048&&(b.cursor.x=0,b.cursor.y+=b.maxHeight,b.maxHeight=0,b.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(v,b.cursor.x,b.cursor.y),t.map[E]=new We(b.cursor.x,b.cursor.y,N,B),b.cursor.x+=N+1,b.maxHeight=Math.max(b.maxHeight,B)}}let a=e.size||t.size,r=H(e.scale??1).scale(a/t.size),h=e.lineSpacing??0,l=e.letterSpacing??0,n=0,c=0,u=0,d=[],x=[],f=0,A=null,g=0,w;for(;f<i.length;){let p=i[f];if(p===`
`)u+=a+h,d.push({width:n-l,chars:x}),A=null,g=0,n=0,x=[],w=void 0;else{let y=t.map[p];if(y){let b=y.w*r.x;e.width&&n+b>e.width&&(u+=a+h,A!=null&&(f-=x.length-A,p=i[f],y=t.map[p],b=y.w*r.x,x=x.slice(0,A-1),n=g),A=null,g=0,d.push({width:n-l,chars:x}),n=w??0,x=[]),x.push({tex:t.tex,width:y.w,height:y.h,quad:new We(y.x/t.tex.width,y.y/t.tex.height,y.w/t.tex.width,y.h/t.tex.height),ch:p,pos:new Y(n,u),opacity:e.opacity??1,color:e.color??Be.WHITE,scale:H(r),angle:0}),p===" "&&(A=x.length,g=n),e.indentAll&&w===void 0&&/\S/.test(p)&&(w=n),n+=b,c=Math.max(c,n),n+=l}}f++}d.push({width:n-l,chars:x}),u+=a,e.width&&(c=e.width);let D=[];for(let p=0;p<d.length;p++){let y=(c-d[p].width)*Ih(e.align??"left");for(let b of d[p].chars){let E=t.map[b.ch],T=D.length+p;if(b.pos=b.pos.add(y,0).add(E.w*r.x*.5,E.h*r.y*.5),e.transform){let C=typeof e.transform=="function"?e.transform(T,b.ch):e.transform;C&&sa(b,C)}if(o[T]){let C=o[T];for(let N of C){let B=(_=e.styles)==null?void 0:_[N],v=typeof B=="function"?B(T,b.ch):B;v&&sa(b,v)}}D.push(b)}}return{width:c,height:u,chars:D,opt:e,renderedText:s}}function Ds(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,s=ko(e.anchor||ui).scale(new Y(t,o).scale(-.5)),i=e.quad||new We(0,0,1,1),a=e.color||Ne(255,255,255),r=e.opacity??1,h=e.tex?.1/e.tex.width:0,l=e.tex?.1/e.tex.height:0,n=i.x+h,c=i.y+l,u=i.w-h*2,d=i.h-l*2;Ft(),Je(e.pos),Wo(e.angle),Ss(e.scale),Je(s),Co([{pos:new Y(-t/2,o/2),uv:new Y(e.flipX?n+u:n,e.flipY?c:c+d),color:a,opacity:r},{pos:new Y(-t/2,-o/2),uv:new Y(e.flipX?n+u:n,e.flipY?c+d:c),color:a,opacity:r},{pos:new Y(t/2,-o/2),uv:new Y(e.flipX?n:n+u,e.flipY?c+d:c),color:a,opacity:r},{pos:new Y(t/2,o/2),uv:new Y(e.flipX?n:n+u,e.flipY?c:c+d),color:a,opacity:r}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),Tt()}function Uo(e){Ft(),Je(e.opt.pos),Wo(e.opt.angle),Je(ko(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{Ds({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),Tt()}function Xt(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,s=ko(e.anchor||ui).add(1,1).scale(new Y(t,o).scale(-.5)),i=[new Y(0,0),new Y(t,0),new Y(t,o),new Y(0,o)];if(e.radius){let a=Math.min(t,o)/2,r=Array.isArray(e.radius)?e.radius.map(h=>Math.min(a,h)):new Array(4).fill(Math.min(a,e.radius));i=[new Y(r[0],0),...r[1]?us(new Y(t-r[1],r[1]),r[1],r[1],270,360):[H(t,0)],...r[2]?us(new Y(t-r[2],o-r[2]),r[2],r[2],0,90):[H(t,o)],...r[3]?us(new Y(r[3],o-r[3]),r[3],r[3],90,180):[H(0,o)],...r[0]?us(new Y(r[0],r[0]),r[0],r[0],180,270):[]]}Eo(Object.assign({},e,{offset:s,pts:i,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function vo(e){Yt();let t=m.gfx.width,o=m.gfx.height;m.gfx.width=m.gfx.viewport.width,m.gfx.height=m.gfx.viewport.height,e(),Yt(),m.gfx.width=t,m.gfx.height=o}function ia(e,t){vo(()=>{let o=H(8);Ft(),Je(e);let s=Ho({text:t,font:Js,size:16,pos:o,color:Ne(255,255,255),fixed:!0}),i=s.width+o.x*2,a=s.height+o.x*2;e.x+i>=gt()&&Je(H(-i,0)),e.y+a>=At()&&Je(H(0,-a)),Xt({width:i,height:a,color:Ne(0,0,0),radius:4,opacity:.8,fixed:!0}),Uo(s),Tt()})}function br(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return Eo(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function fd(){if(m.debug.inspect){let e=null;for(let t of m.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(m.game.root.drawInspect(),e){let t=[],o=e.inspect();for(let s in o)o[s]?t.push(`${o[s]}`):t.push(`${s}`);ia(fh(m.k.mousePos()),t.join(`
`))}ia(H(8),`FPS: ${m.debug.fps()}`)}m.debug.paused&&vo(()=>{Ft(),Je(gt(),0),Je(-8,8);let e=32;Xt({width:e,height:e,anchor:"topright",color:Ne(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)Xt({width:4,height:e*.6,anchor:"center",pos:H(-e/3*t,e*.5),color:Ne(255,255,255),radius:2,fixed:!0});Tt()}),m.debug.timeScale!==1&&vo(()=>{Ft(),Je(gt(),At()),Je(-8,-8);let e=8,t=Ho({text:m.debug.timeScale.toFixed(1),font:Js,size:16,color:Ne(255,255,255),pos:H(-e),anchor:"botright",fixed:!0});Xt({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Ne(0,0,0),opacity:.8,radius:4,fixed:!0});for(let o=0;o<2;o++){let s=m.debug.timeScale<1;br({p1:H(-t.width-e*(s?2:3.5),-e),p2:H(-t.width-e*(s?2:3.5),-e-t.height),p3:H(-t.width-e*(s?3.5:2),-e-t.height/2),pos:H(-o*e*1+(s?-e*.5:0),0),color:Ne(255,255,255),fixed:!0})}Uo(t),Tt()}),m.debug.curRecording&&vo(()=>{Ft(),Je(0,At()),Je(24,-24),es({radius:12,color:Ne(255,0,0),opacity:La(0,1,m.app.time()*4),fixed:!0}),Tt()}),m.debug.showLog&&m.game.logs.length>0&&vo(()=>{Ft(),Je(0,At()),Je(8,-8);let e=8,t=[];for(let s of m.game.logs){let i="",a=s.msg instanceof Error?"error":"info";i+=`[time]${s.time.toFixed(2)}[/time]`,i+=" ",i+=`[${a}]${ki(s.msg)}[/${a}]`,t.push(i)}m.game.logs=m.game.logs.filter(s=>m.app.time()-s.time<(m.globalOpt.logTime||4));let o=Ho({text:t.join(`
`),font:Js,pos:H(e,-e),anchor:"botleft",size:16,width:gt()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Ne(127,127,127)},info:{color:Ne(255,255,255)},error:{color:Ne(255,0,127)}}});Xt({width:o.width+e*2,height:o.height+e*2,anchor:"botleft",color:Ne(0,0,0),radius:4,opacity:.8,fixed:!0}),Uo(o),Tt()})}function ki(e,t=!1,o=new Set){if(o.has(e))return"<recursive>";var s="",i;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(s=["[",e.map(a=>ki(a,!0,o.union(new Set([e])))).join(", "),"]"].join(""),e=s),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(s+=e.constructor.name+" "),s+=["{",(i=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${ki(e[a],!0,o.union(new Set([e])))}`).join(", "))?` ${i} `:"","}"].join(""),e=s),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function gd(){let e=m.game.cam,t=Y.fromAngle(ct(0,360)).scale(e.shake);e.shake=Ct(e.shake,0,5*ht()),e.transform=new ao().translate(Qs()).scale(e.scale).rotate(e.angle).translate((e.pos??Qs()).scale(-1).add(t)),m.game.root.draw(),Yt()}function md(){let e=No();m.game.events.numListeners("loading")>0?m.game.events.trigger("loading",e):vo(()=>{let t=gt()/2,o=24,s=H(gt()/2,At()/2).sub(H(t/2,o/2));Xt({pos:H(0),width:gt(),height:At(),color:Ne(0,0,0)}),Xt({pos:s,width:t,height:o,fill:!1,outline:{width:4}}),Xt({pos:s,width:t*e,height:o})})}function Ar(e,t,o){let s=m.gfx.ggl.gl;Yt(),s.clear(s.STENCIL_BUFFER_BIT),s.enable(s.STENCIL_TEST),s.stencilFunc(s.NEVER,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),t(),Yt(),s.stencilFunc(o,1,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),e(),Yt(),s.disable(s.STENCIL_TEST)}function xd(e,t){let o=m.gfx.ggl.gl;Ar(e,t,o.EQUAL)}function ks(e){var a,r;if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new We(0,0,1,1),o=e.tex.width*t.w,s=e.tex.height*t.h,i=new Y(1);if(e.tiled){let h=ko(e.anchor||ui);(((a=e.pos)==null?void 0:a.x)||0)-(h.x+1)*.5*(e.width||o),(((r=e.pos)==null?void 0:r.y)||0)-(h.y+1)*.5*(e.height||s);let l=(e.width||o)/o,n=(e.height||s)/s,c=Math.floor(l),u=Math.floor(n),d=l-c,x=n-u,f=(c+d?1:0)*(u+x?1:0),A=new Array(f*6),g=new Array(f*4),w=0,D=(R,X,_,p,y)=>{A[w*6+0]=w*4+0,A[w*6+1]=w*4+1,A[w*6+2]=w*4+3,A[w*6+3]=w*4+1,A[w*6+4]=w*4+2,A[w*6+5]=w*4+3,g[w*4+0]={pos:new Y(R-h.x,X-h.y),uv:new Y(y.x,y.y),color:e.color||Be.WHITE,opacity:e.opacity||1},g[w*4+1]={pos:new Y(R+_-h.x,X-h.y),uv:new Y(y.x+y.w,y.y),color:e.color||Be.WHITE,opacity:e.opacity||1},g[w*4+2]={pos:new Y(R+_-h.x,X+p-h.y),uv:new Y(y.x+y.w,y.y+y.h),color:e.color||Be.WHITE,opacity:e.opacity||1},g[w*4+3]={pos:new Y(R-h.x,X+p-h.y),uv:new Y(y.x,y.y+y.h),color:e.color||Be.WHITE,opacity:e.opacity||1},w++};for(let R=0;R<u;R++){for(let X=0;X<c;X++)D(X*o,R*s,o,s,t);d&&D(c*o,R*s,o*d,s,new We(t.x,t.y,t.w*d,t.h))}if(x){for(let R=0;R<c;R++)D(R*o,u*s,o,s*x,new We(t.x,t.y,t.w,t.h*x));d&&D(c*o,u*s,o*d,s*x,new We(t.x,t.y,t.w*d,t.h*x))}Co(g,A,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(i.x=e.width/o,i.y=e.height/s):e.width?(i.x=e.width/o,i.y=i.x):e.height&&(i.y=e.height/s,i.x=i.y),Ds(Object.assign({},e,{scale:i.scale(e.scale||new Y(1)),tex:e.tex,quad:t,width:o,height:s}))}function yd(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Xs(e.sprite);if(!t||!t.data)return;let o=t.data.frames[e.frame??0];if(!o)throw new Error(`Frame not found: ${e.frame??0}`);ks(Object.assign({},e,{tex:t.data.tex,quad:o.scale(e.quad??new We(0,0,1,1))}))}function wd(e,t){let o=m.gfx.ggl.gl;Ar(e,t,o.NOTEQUAL)}function na(e){Uo(Ho(e))}var bd=(e,t)=>{let o=Tn(t,Ki,ji),s=e.pixelDensity??1,i=e.scale??1,{gl:a}=t,r=Mo.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),h=e.width&&e.height?new Zs(t,e.width*s*i,e.height*s*i):new Zs(t,a.drawingBufferWidth,a.drawingBufferHeight),l=null,n=1;e.background&&(typeof e.background=="string"?l=Ne(e.background):(l=Ne(...e.background),n=e.background[3]??1),a.clearColor(l.r/255,l.g/255,l.b/255,n??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let c=new ud(t,En,Uc,_c),u=Mo.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:o,defTex:r,frameBuffer:h,postShader:null,postShaderUniform:null,renderer:c,transform:new ao,transformStack:[],bgTex:u,bgColor:l,bgAlpha:n,width:e.width??a.drawingBufferWidth/s/i,height:e.height??a.drawingBufferHeight/s/i,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function Lo(e){return e.fixed?!0:e.parent?Lo(e.parent):!1}function _o(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Ad(e,t={}){return{id:"circle",radius:e,draw(){es(Object.assign(_o(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Ye(new Y(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function vr(...e){return{id:"color",color:Ne(...e),inspect(){return`color: ${this.color.toString()}`}}}function vd(e){return{add(){this.canvas=e}}}function Ed(e=1){let t,o=0,s=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){s||(o+=ht(),this.opacity=oo(o,0,e,0,t),o>=e&&(this.opacity=t,s=!0))}}}function Md(e="intersect"){return{id:"mask",mask:e}}function Er(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,o=m.k.easings.linear){return m.game.root.tween(0,this.opacity,t,s=>this.opacity=s,o)},fadeOut(t=1,o=m.k.easings.linear){return m.game.root.tween(this.opacity,0,t,s=>this.opacity=s,o)},inspect(){return`opacity: ${Wi(this.opacity,1)}`}}}function Sd(e=1,t=Ne(0,0,0),o=1,s="miter",i=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:o,join:s,miterLimit:i,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var Rd=class{constructor(){O(this,"pos",H(0));O(this,"vel",H(0));O(this,"acc",H(0));O(this,"angle",0);O(this,"angularVelocity",0);O(this,"damping",0);O(this,"t");O(this,"lt",null);O(this,"gc");this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function Dd(e,t){let o=t.lifetime,s=[],i=e.colors||[Be.WHITE],a=e.opacities||[1],r=e.quads||[new We(0,0,1,1)],h=e.scales||[1],l=e.lifeTime,n=t.direction,c=t.spread,u=e.speed||[0,0],d=e.angle||[0,0],x=e.angularVelocity||[0,0],f=e.acceleration||[H(0),H(0)],A=e.damping||[0,0],g=[],w=new Array(e.max),D=0,R=0;for(let p=0;p<e.max;p++){g[p*6+0]=p*4+0,g[p*6+1]=p*4+1,g[p*6+2]=p*4+3,g[p*6+3]=p*4+1,g[p*6+4]=p*4+2,g[p*6+5]=p*4+3;for(let y=0;y<4;y++)w[p*4+y]={pos:new Y(0,0),uv:new Y(0,0),color:Ne(255,255,255),opacity:1};s[p]=new Rd}let X=new Et;function _(p=0){for(;p<e.max;){if(s[p].gc)return p;p++}return null}return{id:"particles",emit(p){let y=0;for(let b=0;b<p;b++){if(y=_(y),y==null)return;let E=ct(n-c,n+c),T=Y.fromAngle(E).scale(ct(u[0],u[1])),C=ct(d[0],d[1]),N=ct(x[0],x[1]),B=H(ct(f[0].x,f[1].x),ct(f[0].y,f[1].y)),v=ct(A[0],A[1]),z=l?ct(l[0],l[1]):null,G=t.shape?t.shape.random():H(),J=s[y];J.lt=z,J.pos=G,J.vel=T,J.acc=B,J.angle=C,J.angularVelocity=N,J.damping=v,J.angularVelocity=N,J.gc=!1}D+=p},update(){if(o!==void 0&&o<=0)return;let p=ht();for(let y of s)if(!y.gc){if(y.t+=p,y.lt&&y.t>=y.lt){y.gc=!0,D--;continue}y.vel=y.vel.add(y.acc.scale(p)).scale(1-y.damping*p),y.pos=y.pos.add(y.vel.scale(p)),y.angle+=y.angularVelocity*p}for(o!==void 0&&(o-=p,o<=0&&X.trigger()),R+=p;D<e.max&&t.rate&&R>t.rate;)this.emit(1),D++,R-=t.rate},draw(){if(!(o!==void 0&&o<=0)){for(let p=0;p<s.length;p++){let y=s[p];if(y.gc)continue;let b=y.progress,E=Math.floor(y.progress*i.length),T=E<i.length-1?Ct(i[E],i[E+1],oo(b,E/i.length,(E+1)/i.length,0,1)):i[E],C=Math.floor(y.progress*a.length),N=C<a.length-1?Ct(a[C],a[C+1],oo(b,C/a.length,(C+1)/a.length,0,1)):a[C],B=Math.floor(y.progress*r.length),v=r[B],z=Math.floor(y.progress*h.length),G=h[z],J=Math.cos(y.angle*Math.PI/180),se=Math.sin(y.angle*Math.PI/180),V=(e.texture?e.texture.width:10)*v.w/2,k=(e.texture?e.texture.height:10)*v.h/2,fe=p*4,oe=w[fe];oe.pos.x=y.pos.x+-V*G*J- -k*G*se,oe.pos.y=y.pos.y+-V*G*se+-k*G*J,oe.uv.x=v.x,oe.uv.y=v.y,oe.color.r=T.r,oe.color.g=T.g,oe.color.b=T.b,oe.opacity=N,oe=w[fe+1],oe.pos.x=y.pos.x+V*G*J- -k*G*se,oe.pos.y=y.pos.y+V*G*se+-k*G*J,oe.uv.x=v.x+v.w,oe.uv.y=v.y,oe.color.r=T.r,oe.color.g=T.g,oe.color.b=T.b,oe.opacity=N,oe=w[fe+2],oe.pos.x=y.pos.x+V*G*J-k*G*se,oe.pos.y=y.pos.y+V*G*se+k*G*J,oe.uv.x=v.x+v.w,oe.uv.y=v.y+v.h,oe.color.r=T.r,oe.color.g=T.g,oe.color.b=T.b,oe.opacity=N,oe=w[fe+3],oe.pos.x=y.pos.x+-V*G*J-k*G*se,oe.pos.y=y.pos.y+-V*G*se+k*G*J,oe.uv.x=v.x,oe.uv.y=v.y+v.h,oe.color.r=T.r,oe.color.g=T.g,oe.color.b=T.b,oe.opacity=N}Co(w,g,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(p){return X.add(p)},inspect(){return`count: ${D}/${e.max}`}}}function Td(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){Eo(Object.assign(_o(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new Mt(this.pts)},inspect(){return`polygon: ${this.pts.map(o=>`[${o.x},${o.y}]`).join(",")}`}}}function Mr(e,t,o){let s;return m.game.root.get("area").forEach(i=>{if(o&&o.some(r=>i.is(r)))return;let a=i.worldArea().raycast(e,t);a&&(s?a.fraction<s.fraction&&(s=a,s.object=i):(s=a,s.object=i))}),s}function Sr(e,t,o={}){return{id:"rect",width:e,height:t,radius:o.radius||0,draw(){Xt(Object.assign(_o(this),{width:this.width,height:this.height,radius:this.radius,fill:o.fill}))},renderArea(){return new Ye(H(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Cd(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function Id(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let o=m.game.root.add([ei(t.pos??H(0))]),s=e.length,i=0,a=null,r=null,h=null,l=null,n=p=>p.x+p.y*i,c=p=>H(Math.floor(p%i),Math.floor(p/i)),u=()=>{a=[];for(let p of o.children)d(p)},d=p=>{let y=n(p.tilePos);a[y]?a[y].push(p):a[y]=[p]},x=p=>{let y=n(p.tilePos);if(a[y]){let b=a[y].indexOf(p);b>=0&&a[y].splice(b,1)}},f=()=>{let p=!1;for(let y of o.children){let b=o.pos2Tile(y.pos);(y.tilePos.x!=b.x||y.tilePos.y!=b.y)&&(p=!0,x(y),y.tilePos.x=b.x,y.tilePos.y=b.y,d(y))}p&&o.trigger("spatialMapChanged")},A=()=>{let p=o.getSpatialMap(),y=o.numRows()*o.numColumns();r?r.length=y:r=new Array(y),r.fill(1,0,y);for(let b=0;b<p.length;b++){let E=p[b];if(E){let T=0;for(let C of E)if(C.isObstacle){T=1/0;break}else T+=C.cost;r[b]=T||1}}},g=()=>{let p=o.getSpatialMap(),y=o.numRows()*o.numColumns();h?h.length=y:h=new Array(y),h.fill(15,0,y);for(let b=0;b<p.length;b++){let E=p[b];if(E){let T=E.length,C=15;for(let N=0;N<T;N++)C|=E[N].edgeMask;h[b]=C}}},w=()=>{let p=o.numRows()*o.numColumns(),y=(E,T)=>{let C=[];for(C.push(E);C.length>0;){let N=C.pop();X(N).forEach(B=>{l[B]<0&&(l[B]=T,C.push(B))})}};l?l.length=p:l=new Array(p),l.fill(-1,0,p);let b=0;for(let E=0;E<r.length;E++){if(l[E]>=0){b++;continue}y(E,b),b++}},D=(p,y)=>r[y],R=(p,y)=>{let b=c(p),E=c(y);return b.dist(E)},X=(p,y)=>{let b=[],E=Math.floor(p%i),T=E>0&&h[p]&1&&r[p-1]!==1/0,C=p>=i&&h[p]&2&&r[p-i]!==1/0,N=E<i-1&&h[p]&4&&r[p+1]!==1/0,B=p<i*s-i-1&&h[p]&8&&r[p+i]!==1/0;return y?(T&&(C&&b.push(p-i-1),b.push(p-1),B&&b.push(p+i-1)),C&&b.push(p-i),N&&(C&&b.push(p-i+1),b.push(p+1),B&&b.push(p+i+1)),B&&b.push(p+i)):(T&&b.push(p-1),C&&b.push(p-i),N&&b.push(p+1),B&&b.push(p+i)),b},_={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(p,...y){let b=H(...y),E=(()=>{if(typeof p=="string"){if(t.tiles[p]){if(typeof t.tiles[p]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[p](b)}else if(t.wildcardTile)return t.wildcardTile(p,b)}else{if(Array.isArray(p))return p;throw new Error("Expected a symbol or a component list")}})();if(!E)return null;let T=!1,C=!1;for(let B of E)B.id==="tile"&&(C=!0),B.id==="pos"&&(T=!0);T||E.push(ei(this.tile2Pos(b))),C||E.push(Xr());let N=o.add(E);return T&&(N.tilePosOffset=N.pos.clone()),N.tilePos=b,N.transform=ys(N),a&&(d(N),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),N},numColumns(){return i},numRows(){return s},levelWidth(){return i*this.tileWidth()},levelHeight(){return s*this.tileHeight()},tile2Pos(...p){return H(...p).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...p){let y=H(...p);return H(Math.floor(y.x/this.tileWidth()),Math.floor(y.y/this.tileHeight()))},getSpatialMap(){return a||u(),a},removeFromSpatialMap:x,insertIntoSpatialMap:d,onSpatialMapChanged(p){return this.on("spatialMapChanged",p)},onNavigationMapInvalid(p){return this.on("navigationMapInvalid",p)},getAt(p){a||u();let y=n(p);return a[y]||[]},raycast(p,y){let b=this.toWorld(p),E=this.toWorld(p.add(y)).sub(b),T=1/this.tileWidth(),C=p.scale(T),N=dc(C,y,B=>{let v=this.getAt(B);if(v.some(G=>G.isObstacle))return!0;let z=null;for(let G of v)if(G.has("area")){let J=G.worldArea().raycast(b,E);J&&(z?J.fraction<z.fraction&&(z=J,z.object=G):(z=J,z.object=G))}return z&&(z.point=this.fromWorld(z.point).scale(T)),z||!1},64);return N&&(N.point=N.point.scale(this.tileWidth())),N},update(){a&&f()},invalidateNavigationMap(){r=null,h=null,l=null},onNavigationMapChanged(p){return this.on("navigationMapChanged",p)},getTilePath(p,y,b={}){var J;if(r||A(),h||g(),l||w(),p.x<0||p.x>=i||p.y<0||p.y>=s||y.x<0||y.x>=i||y.y<0||y.y>=s)return null;let E=n(p),T=n(y);if(r[T]===1/0)return null;if(E===T)return[];if(l[E]!=-1&&l[E]!==l[T])return null;let C=new or((se,V)=>se.cost<V.cost);C.insert({cost:0,node:E});let N=new Map;N.set(E,E);let B=new Map;for(B.set(E,0);C.length!==0;){let se=(J=C.remove())==null?void 0:J.node;if(se===T)break;let V=X(se,b.allowDiagonals);for(let k of V){let fe=(B.get(se)||0)+D(se,k)+R(k,T);(!B.has(k)||fe<B.get(k))&&(B.set(k,fe),C.insert({cost:fe,node:k}),N.set(k,se))}}let v=[],z=T,G=c(z);for(v.push(G);z!==E;){let se=N.get(z);if(se===void 0)throw new Error("Bug in pathfinding algorithm");z=se;let V=c(z);v.push(V)}return v.reverse()},getPath(p,y,b={}){let E=this.tileWidth(),T=this.tileHeight(),C=this.getTilePath(this.pos2Tile(p),this.pos2Tile(y),b);return C?[p,...C.slice(1,-1).map(N=>N.scale(E,T).add(E/2,T/2)),y]:null}};return o.use(_),o.onNavigationMapInvalid(()=>{o.invalidateNavigationMap(),o.trigger("navigationMapChanged")}),e.forEach((p,y)=>{let b=p.split("");i=Math.max(b.length,i),b.forEach((E,T)=>{o.spawn(E,H(T,y))})}),o}function Ot(e,t,o){return m.game.objEvents.registers[e]||(m.game.objEvents.registers[e]=new er),m.game.objEvents.on(e,(s,...i)=>{s.is(t)&&o(s,...i)})}var Pd=(e,t,...o)=>{for(let s of m.game.root.children)s.is(t)&&s.trigger(e,o)},Bd=Ge(e=>{let t=m.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ot("fixedUpdate",e,t)),Rr=Ge(e=>{let t=m.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ot("update",e,t)),Od=Ge(e=>{let t=m.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(o){t.hidden=o},cancel:()=>t.destroy()}},(e,t)=>Ot("draw",e,t)),Dr=Ge(e=>m.game.events.on("add",e),(e,t)=>Ot("add",e,t)),Ld=Ge(e=>m.game.events.on("destroy",e),(e,t)=>Ot("destroy",e,t)),zd=Ge(e=>m.game.events.on("use",e),(e,t)=>Ot("use",e,t)),Nd=Ge(e=>m.game.events.on("unuse",e),(e,t)=>Ot("unuse",e,t)),Tr=Ge(e=>m.game.events.on("tag",e),(e,t)=>Ot("tag",e,t)),Hd=Ge(e=>m.game.events.on("untag",e),(e,t)=>Ot("untag",e,t));function Ud(e,t,o){return Ot("collide",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function _d(e,t,o){return Ot("collideUpdate",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function qd(e,t,o){return Ot("collideEnd",e,(s,i,a)=>i.is(t)&&o(s,i,a))}function gi(e,t){m.game.root.get(e,{recursive:!0}).forEach(t),Dr(e,t),Tr((o,s)=>{s===e&&t(o)})}var Fd=Ge(e=>m.app.onMousePress(e),(e,t)=>{let o=[];return gi(e,s=>{if(!s.area)throw new Error("onClick() requires the object to have area() component");o.push(s.onClick(()=>t(s)))}),Fo.join(o)});function Yd(e,t){let o=[];return gi(e,s=>{if(!s.area)throw new Error("onHover() requires the object to have area() component");o.push(s.onHover(()=>t(s)))}),Fo.join(o)}function Xd(e,t){let o=[];return gi(e,s=>{if(!s.area)throw new Error("onHoverUpdate() requires the object to have area() component");o.push(s.onHoverUpdate(()=>t(s)))}),Fo.join(o)}function Gd(e,t){let o=[];return gi(e,s=>{if(!s.area)throw new Error("onHoverEnd() requires the object to have area() component");o.push(s.onHoverEnd(()=>t(s)))}),Fo.join(o)}function Vd(e){m.game.events.on("loading",e)}function Kd(e){m.app.onResize(e)}function jd(e){m.game.events.on("error",e)}function In(e){m.assets.loaded?e():m.game.events.on("load",e)}function Wd(e){if(m.assets.loaded)lr().forEach(t=>e(...t));else return m.game.events.on("loadError",e)}function Cr(...e){m.game.cam.pos=H(...e)}function Ir(){return m.game.cam.pos?m.game.cam.pos.clone():Qs()}function Pr(...e){m.game.cam.scale=H(...e)}function Br(){return m.game.cam.scale.clone()}function Or(e){m.game.cam.angle=e}function Lr(){return m.game.cam.angle}function $d(){return m.game.cam.transform.clone()}function zr(e=Ne(255,255,255),t=1){let o=m.game.root.add([Sr(gt(),At()),vr(e),Er(1),Kr()]),s=o.fadeOut(t);return s.onEnd(()=>Yr(o)),s}function Jd(){return m.game.cam.transform.clone()}function Qd(e=12){m.game.cam.shake+=e}function en(e){return m.game.cam.transform.multVec2(e)}function Nr(e){return m.game.cam.transform.invert().multVec2(e)}function Zd(...e){return Zo("camPos","setCamPos / getCamPos"),e.length>0&&Cr(...e),Ir()}function kd(...e){return Zo("camScale","setCamScale / getCamScale"),e.length>0&&Pr(...e),Br()}function eu(e){return Zo("camRot","setCamRot / getCamRot"),e!==void 0&&Or(e),Lr()}function tu(e=Ne(255,255,255),t=1){return Zo("camFlash","flash"),zr(e,t)}function Pn(e=[]){let t=new Map,o=[],s={},i=new Es,a=[],r=new Set("*"),h=m.globalOpt.tagsAsComponents,l=null,n=!1,c={id:uh(),hidden:!1,transform:new ao,children:[],parent:null,set paused(d){if(d!==n){n=d;for(let x of a)x.paused=d}},get paused(){return n},get tags(){return Array.from(r)},add(d){let x=Array.isArray(d)?Pn(d):d;if(x.parent)throw new Error("Cannot add a game obj that already has a parent.");return x.parent=this,x.transform=ys(x),this.children.push(x),x.trigger("add",x),m.game.events.trigger("add",x),x},readd(d){let x=this.children.indexOf(d);return x!==-1&&(this.children.splice(x,1),this.children.push(d)),d},remove(d){let x=this.children.indexOf(d);if(x!==-1){d.parent=null,this.children.splice(x,1);let f=A=>{A.trigger("destroy"),m.game.events.trigger("destroy",A),A.children.forEach(g=>f(g))};f(d)}},removeAll(d){if(d)this.get(d).forEach(x=>this.remove(x));else for(let x of[...this.children])this.remove(x)},fixedUpdate(){this.paused||(this.children.forEach(d=>d.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(d=>d.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Yt(),this.canvas.bind());let d=m.gfx.fixed;this.fixed&&(m.gfx.fixed=!0),Ft(),Je(this.pos),Ss(this.scale),Wo(this.angle);let x=this.children.sort((f,A)=>{let g=f.layerIndex??m.game.defaultLayerIndex,w=A.layerIndex??m.game.defaultLayerIndex;return g-w||(f.z??0)-(A.z??0)});if(this.mask){let f={intersect:m.k.drawMasked,subtract:m.k.drawSubtracted}[this.mask];if(!f)throw new Error(`Invalid mask func: "${this.mask}"`);f(()=>{x.forEach(A=>A.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),x.forEach(f=>f.draw());Tt(),m.gfx.fixed=d,this.canvas&&(Yt(),this.canvas.unbind())},drawInspect(){this.hidden||(Ft(),Je(this.pos),Ss(this.scale),Wo(this.angle),this.children.forEach(d=>d.drawInspect()),this.trigger("drawInspect"),Tt())},use(d){var A;if(typeof d=="string")return r.add(d);if(!d||typeof d!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof d}"`);let x=[];d.id?(this.unuse(d.id),s[d.id]=[],x=s[d.id],t.set(d.id,d),h&&r.add(d.id)):o.push(d);for(let g in d){if(Yc.has(g))continue;let w=Object.getOwnPropertyDescriptor(d,g);if(w)if(typeof w.value=="function"&&(d[g]=d[g].bind(this)),w.set&&Object.defineProperty(d,g,{set:w.set.bind(this)}),w.get&&Object.defineProperty(d,g,{get:w.get.bind(this)}),Xc.has(g)){let D=g==="add"?()=>{var R;l=X=>x.push(X),(R=d[g])==null||R.call(d),l=null}:d[g];x.push(this.on(g,D).cancel)}else if(this[g]===void 0)Object.defineProperty(this,g,{get:()=>d[g],set:D=>d[g]=D,configurable:!0,enumerable:!0}),x.push(()=>delete this[g]);else{let D=(A=t.values().find(R=>R[g]!==void 0))==null?void 0:A.id;throw new Error(`Duplicate component property: "${g}" while adding component "${d.id}"`+(D?` (originally added by "${D}")`:""))}}let f=()=>{if(d.require){for(let g of d.require)if(!this.c(g))throw new Error(`Component "${d.id}" requires component "${g}"`)}};d.destroy&&x.push(d.destroy.bind(this)),this.exists()?(f(),d.add&&(l=g=>x.push(g),d.add.call(this),l=null),d.id&&(this.trigger("use",d.id),m.game.events.trigger("use",this,d.id))):d.require&&x.push(this.on("add",f).cancel)},unuse(d){if(t.has(d)){for(let x of t.values())if(x.require&&x.require.includes(d))throw new Error(`Can't unuse. Component "${x.id}" requires component "${d}"`);t.delete(d),this.trigger("unuse",d),m.game.events.trigger("unuse",this,d)}else h&&r.has(d)&&r.delete(d);s[d]&&(s[d].forEach(x=>x()),delete s[d])},c(d){return t.get(d)??null},get(d,x={}){let f=(g,w)=>x.only==="comps"?g.has(w):x.only==="tags"?g.is(w):g.is(w)||g.has(w),A=x.recursive?this.children.flatMap(function g(w){return[w,...w.children.flatMap(g)]}):this.children;if(A=A.filter(g=>d?f(g,d):!0),x.liveUpdate){let g=D=>x.recursive?this.isAncestorOf(D):D.parent===this,w=[];w.push(m.k.onAdd(D=>{g(D)&&f(D,d)&&A.push(D)})),w.push(m.k.onDestroy(D=>{if(g(D)&&f(D,d)){let R=A.findIndex(X=>X.id===D.id);R!==-1&&A.splice(R,1)}})),this.onDestroy(()=>{for(let D of w)D.cancel()})}return A},query(d){let x=d.hierarchy||"children",f=d.include,A=d.exclude,g=[];switch(x){case"children":g=this.children;break;case"siblings":g=this.parent?this.parent.children.filter(D=>D!==this):[];break;case"ancestors":let w=this.parent;for(;w;)g.push(w),w=w.parent;break;case"descendants":g=this.children.flatMap(function D(R){return[R,...R.children.flatMap(D)]});break}if(f&&((d.includeOp||"and")==="and"||!Array.isArray(d.include)?g=g.filter(w=>w.is(f)):g=g.filter(w=>d.include.some(D=>w.is(D)))),A&&((d.includeOp||"and")==="and"||!Array.isArray(d.include)?g=g.filter(w=>!w.is(A)):g=g.filter(w=>!d.exclude.some(D=>w.is(D)))),d.visible===!0&&(g=g.filter(w=>w.visible)),d.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let w=d.distanceOp||"near",D=d.distance*d.distance;w==="near"?g=g.filter(R=>R.pos&&this.pos.sdist(R.pos)<=D):g=g.filter(R=>R.pos&&this.pos.sdist(R.pos)>D)}return d.name&&(g=g.filter(w=>w.name===d.name)),g},isAncestorOf(d){return d.parent?d.parent===this||this.isAncestorOf(d.parent):!1},exists(){return m.game.root.isAncestorOf(this)},is(d,x="and"){return Array.isArray(d)?x==="and"?d.every(f=>r.has(f)):d.some(f=>r.has(f)):r.has(d)},tag(d){if(Array.isArray(d))for(let x of d)r.add(x),this.trigger("tag",x),m.game.events.trigger("tag",this,x);else r.add(d),this.trigger("tag",d),m.game.events.trigger("tag",this,d)},untag(d){if(Array.isArray(d))for(let x of d)r.delete(x),this.trigger("untag",x),m.game.events.trigger("untag",this,x);else r.delete(d),this.trigger("untag",d),m.game.events.trigger("untag",this,d)},has(d,x="and"){return Array.isArray(d)?x==="and"?d.every(f=>t.has(f)):d.some(f=>t.has(f)):t.has(d)},on(d,x){let f=i.on(d,x.bind(this));return l&&l(()=>f.cancel()),f},trigger(d,...x){i.trigger(d,...x),m.game.objEvents.trigger(d,this,...x)},destroy(){this.parent&&this.parent.remove(this)},inspect(){var x;let d={};for(let[f,A]of t)d[f]=((x=A.inspect)==null?void 0:x.call(A))??null;for(let[f,A]of o.entries()){if(A.inspect){d[f]=A.inspect();continue}for(let[g,w]of Object.entries(A))typeof w!="function"&&(d[g]=`${g}: ${w}`)}return d},onAdd(d){return this.on("add",d)},onFixedUpdate(d){return this.on("fixedUpdate",d)},onUpdate(d){return this.on("update",d)},onDraw(d){return this.on("draw",d)},onDestroy(d){return this.on("destroy",d)},onUse(d){return this.on("use",d)},onUnuse(d){return this.on("unuse",d)},clearEvents(){i.clear()}},u=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let d of u)c[d]=(...x)=>{var A,g;let f=(g=(A=m.app)[d])==null?void 0:g.call(A,...x);return a.push(f),c.onDestroy(()=>f.cancel()),c.on("sceneEnter",()=>{var D,R;a.splice(a.indexOf(f),1);let w=(R=(D=m.app)[d])==null?void 0:R.call(D,...x);Fo.replace(f,w),a.push(f)}),f};for(let d of e)c.use(d);return c}var ou=()=>({events:new Es,objEvents:new Es,root:Pn([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new Y(1),angle:0,shake:0,transform:new ao}});function su(e){m.game.gravity=e?(m.game.gravity||H(0,1)).unit().scale(e):null}function iu(){return m.game.gravity?m.game.gravity.len():0}function nu(e){m.game.gravity=e.unit().scale(m.game.gravity?m.game.gravity.len():1)}function bs(){return m.game.gravity?m.game.gravity.unit():H(0,1)}var au=Yl("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),ru=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let o=new Rs(Ph(e));return e.decodeAudioData(au.buffer.slice(0)).then(s=>{o.buf=s}).catch(s=>{console.error("Failed to load burp: ",s)}),{ctx:e,masterNode:t,burpSnd:o}})();function lu(e,t={}){let o=new Et,s=new Audio(e);s.crossOrigin="anonymous",s.loop=!!t.loop,m.audio.ctx.createMediaElementSource(s).connect(m.audio.masterNode);function i(){m.debug.paused||m.app.isHidden()&&!m.globalOpt.backgroundAudio||m.audio.ctx.resume()}function a(){i(),s.play()}return t.paused||a(),s.onended=()=>o.trigger(),{play(){a()},seek(r){s.currentTime=r},stop(){s.pause(),this.seek(0)},set loop(r){s.loop=r},get loop(){return s.loop},set paused(r){r?s.pause():a()},get paused(){return s.paused},time(){return s.currentTime},duration(){return s.duration},set volume(r){s.volume=no(r,0,1)},get volume(){return s.volume},set speed(r){s.playbackRate=Math.max(r,0)},get speed(){return s.playbackRate},set detune(r){},get detune(){return 0},onEnd(r){return o.add(r)},then(r){return this.onEnd(r)}}}function cu(e,t={}){if(typeof e=="string"&&m.assets.music[e])return lu(m.assets.music[e],t);let o=m.audio.ctx,s=t.paused??!1,i=o.createBufferSource(),a=new Et,r=o.createGain(),h=o.createStereoPanner(),l=t.seek??0,n=0,c=0,u=!1;i.loop=!!t.loop,i.detune.value=t.detune??0,i.playbackRate.value=t.speed??1,i.connect(h),i.onended=()=>{var g;f()>=(((g=i.buffer)==null?void 0:g.duration)??Number.POSITIVE_INFINITY)&&a.trigger()},h.pan.value=t.pan??0,h.connect(r),r.connect(m.audio.masterNode),r.gain.value=t.volume??1;let d=g=>{i.buffer=g.buf,s||(n=o.currentTime,i.start(0,l),u=!0)},x=nd(e);x instanceof Vt&&x.onLoad(d);let f=()=>{if(!i.buffer)return 0;let g=s?c-n:o.currentTime-n,w=i.buffer.duration;return i.loop?g%w:Math.min(g,w)},A=g=>{let w=o.createBufferSource();return w.buffer=g.buffer,w.loop=g.loop,w.playbackRate.value=g.playbackRate.value,w.detune.value=g.detune.value,w.onended=g.onended,w.connect(h),w};return{stop(){this.paused=!0,this.seek(0)},set paused(g){if(s!==g)if(s=g,g)u&&(i.stop(),u=!1),c=o.currentTime;else{i=A(i);let w=c-n;i.start(0,w),u=!0,n=o.currentTime-w,c=0}},get paused(){return s},play(g=0){this.seek(g),this.paused=!1},seek(g){var w;(w=i.buffer)!=null&&w.duration&&(g>i.buffer.duration||(s?(i=A(i),n=c-g):(i.stop(),i=A(i),n=o.currentTime-g,i.start(0,g),u=!0,c=0)))},set speed(g){i.playbackRate.value=g},get speed(){return i.playbackRate.value},set detune(g){i.detune.value=g},get detune(){return i.detune.value},set volume(g){r.gain.value=Math.max(g,0)},get volume(){return r.gain.value},set pan(g){h.pan.value=g},get pan(){return h.pan.value},set loop(g){i.loop=g},get loop(){return i.loop},duration(){var g;return((g=i.buffer)==null?void 0:g.duration)??0},time(){return f()%this.duration()},onEnd(g){return a.add(g)},then(g){return this.onEnd(g)}}}function Hr(e){return m.k.play(m.audio.burpSnd,e)}function Ur(e){m.audio.masterNode.gain.value=e}function _r(){return m.audio.masterNode.gain.value}function hu(e){return Zo("volume","setVolume / getVolume"),e!==void 0&&Ur(e),_r()}function qr(){m.app.onHide(()=>{m.globalOpt.backgroundAudio||m.audio.ctx.suspend()}),m.app.onShow(()=>{!m.globalOpt.backgroundAudio&&!m.debug.paused&&m.audio.ctx.resume()}),m.app.onResize(()=>{if(m.app.isFullscreen())return;let e=m.globalOpt.width&&m.globalOpt.height;e&&!m.globalOpt.stretch&&!m.globalOpt.letterbox||(m.canvas.width=m.canvas.offsetWidth*m.pixelDensity,m.canvas.height=m.canvas.offsetHeight*m.pixelDensity,nr(),e||(m.gfx.frameBuffer.free(),m.gfx.frameBuffer=new Zs(m.gfx.ggl,m.gfx.ggl.gl.drawingBufferWidth,m.gfx.ggl.gl.drawingBufferHeight),m.gfx.width=m.gfx.ggl.gl.drawingBufferWidth/m.pixelDensity/m.gscale,m.gfx.height=m.gfx.ggl.gl.drawingBufferHeight/m.pixelDensity/m.gscale))}),m.globalOpt.debug!==!1&&(m.app.onKeyPress(m.globalOpt.debugKey??"f1",()=>m.debug.inspect=!m.debug.inspect),m.app.onKeyPress("f2",()=>m.debug.clearLog()),m.app.onKeyPress("f8",()=>m.debug.paused=!m.debug.paused),m.app.onKeyPress("f7",()=>{m.debug.timeScale=Wi(no(m.debug.timeScale-.2,0,2),1)}),m.app.onKeyPress("f9",()=>{m.debug.timeScale=Wi(no(m.debug.timeScale+.2,0,2),1)}),m.app.onKeyPress("f10",()=>m.debug.stepFrame())),m.globalOpt.burp&&m.app.onKeyPress("b",()=>Hr())}function du(e,t={}){let o=m.game.root.add([ei(e),Vr()]),s=(t.speed||1)*5,i=t.scale||1;o.add([tn(m.boomSprite),ti(0),nn("center"),ra(s,i),...t.comps??[]]);let a=o.add([tn(m.kaSprite),ti(0),nn("center"),on(),...t.comps??[]]);return a.wait(.4/s,()=>a.use(ra(s,i))),a.onDestroy(()=>o.destroy()),o}function Fr(e,t){if(m.game.layers)throw Error("Layers can only be assigned once.");let o=e.indexOf(t);if(o==-1)throw Error("The default layer name should be present in the layers list.");m.game.layers=e,m.game.defaultLayerIndex=o}function uu(){return m.game.layers}function pu(){var e;return((e=m.game.layers)==null?void 0:e[m.game.defaultLayerIndex])??null}function fu(e,t){Zo("layers","setLayers"),Fr(e,t)}function Yr(e){e.destroy()}function gu(){return m.game.root}function mu(e,t){m.game.scenes[e]=t}function xu(e,...t){if(!m.game.scenes[e])throw new Error(`Scene not found: ${e}`);m.game.events.onOnce("frameEnd",()=>{m.game.events.trigger("sceneLeave",e),m.app.events.clear(),m.game.events.clear(),m.game.objEvents.clear(),[...m.game.root.children].forEach(o=>{!o.stay||o.scenesToStay&&!o.scenesToStay.includes(e)?m.game.root.remove(o):o.trigger("sceneEnter",e)}),m.game.root.clearEvents(),qr(),m.game.cam={pos:null,scale:H(1),angle:0,shake:0,transform:new ao},m.game.scenes[e](...t)}),m.game.currentScene=e}function yu(e){return m.game.events.on("sceneLeave",e)}function wu(){return m.game.currentScene}function tn(e,t={}){let o=null,s=null,i=null,a=new Et;if(!e)throw new Error("Please pass the resource name or data to sprite()");let r=(n,c,u,d)=>{let x=H(1,1);return u&&d?(x.x=u/(n.width*c.w),x.y=d/(n.height*c.h)):u?(x.x=u/(n.width*c.w),x.y=x.x):d&&(x.y=d/(n.height*c.h),x.x=x.y),x},h=(n,c)=>{if(!c)return;let u=c.frames[0].clone();t.quad&&(u=u.scale(t.quad));let d=r(c.tex,u,t.width,t.height);if(n.width=c.tex.width*u.w*d.x,n.height=c.tex.height*u.h*d.y,c.anims)for(let x in c.anims){let f=c.anims[x];typeof f!="number"&&(f.frames=l(f))}o=c,a.trigger(o),t.anim&&n.play(t.anim)},l=n=>{if(n.frames)return n.frames;let c=[];if(n.from===void 0||n.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let u=Math.abs(n.to-n.from)+1;for(let d=0;d<u;d++)c.push(n.from+d*Math.sign(n.to-n.from));if(n.pingpong)for(let d=u-2;d>0;d--)c.push(c[d]);return c};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new We(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(n){let c=Xs(n);c&&c.onLoad(u=>h(this,u))},get animFrame(){if(!o||!s||i===null)return this.frame;let n=o.anims[s.name];return typeof n=="number"?n:n.from===void 0||n.to===void 0?s.frameIndex:this.frame-Math.min(n.from,n.to)},draw(){if(!o)return;let n=o.frames[this.frame??0];if(!n)throw new Error(`Frame not found: ${this.frame??0}`);if(o.slice9){let{left:c,right:u,top:d,bottom:x}=o.slice9,f=o.tex.width*n.w,A=o.tex.height*n.h,g=this.width-c-u,w=this.height-d-x,D=c/f,R=u/f,X=1-D-R,_=d/A,p=x/A,y=1-_-p,b=[ot(0,0,D,_),ot(D,0,X,_),ot(D+X,0,R,_),ot(0,_,D,y),ot(D,_,X,y),ot(D+X,_,R,y),ot(0,_+y,D,p),ot(D,_+y,X,p),ot(D+X,_+y,R,p),ot(0,0,c,d),ot(c,0,g,d),ot(c+g,0,u,d),ot(0,d,c,w),ot(c,d,g,w),ot(c+g,d,u,w),ot(0,d+w,c,x),ot(c,d+w,g,x),ot(c+g,d+w,u,x)];for(let E=0;E<9;E++){let T=b[E],C=b[E+9];ks(Object.assign(_o(this),{pos:C.pos(),tex:o.tex,quad:n.scale(T),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:C.w,height:C.h}))}}else ks(Object.assign(_o(this),{tex:o.tex,quad:n.scale(this.quad??new We(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let n=Xs(e);n?n.onLoad(c=>h(this,c)):In(()=>h(this,Xs(e).data))},update(){if(!o||!s||i===null)return;let n=o.anims[s.name];if(typeof n=="number"){this.frame=n;return}if(n.speed===0)throw new Error("Sprite anim speed cannot be 0");if(s.timer+=ht()*this.animSpeed,s.timer>=1/s.speed){s.timer=0,s.frameIndex+=i;let c=n.frames;if(s.frameIndex>=c.length)if(s.pingpong&&!n.pingpong)i=-1,s.frameIndex=c.length-2;else if(s.loop)s.frameIndex=0;else{this.frame=c.at(-1),s.onEnd(),this.stop();return}else if(s.frameIndex<0)if(s.pingpong&&s.loop)i=1,s.frameIndex=1;else if(s.loop)s.frameIndex=c.length-1;else{this.frame=c[0],s.onEnd(),this.stop();return}this.frame=c[s.frameIndex]}},play(n,c={}){if(!o){a.add(()=>this.play(n,c));return}let u=o.anims[n];if(u===void 0)throw new Error(`Anim not found: ${n}`);s&&this.stop(),s=typeof u=="number"?{name:n,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:n,timer:0,loop:c.loop??u.loop??!1,pingpong:c.pingpong??u.pingpong??!1,speed:c.speed??u.speed??10,frameIndex:0,onEnd:c.onEnd??(()=>{})},i=typeof u=="number"?null:1,this.frame=typeof u=="number"?u:u.frames[0],this.trigger("animStart",n)},stop(){if(!s)return;let n=s.name;s=null,this.trigger("animEnd",n)},numFrames(){return(o==null?void 0:o.frames.length)??0},getCurAnim(){return s},curAnim(){return s==null?void 0:s.name},getAnim(n){return(o==null?void 0:o.anims[n])??null},hasAnim(n){return!!this.getAnim(n)},onAnimEnd(n){return this.on("animEnd",n)},onAnimStart(n){return this.on("animStart",n)},renderArea(){return new Ye(H(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function bu(e,t={}){function o(i){var r,h;let a=Ho(Object.assign(_o(i),{text:i.text+"",size:i.textSize,font:i.font,width:t.width&&i.width,align:i.align,letterSpacing:i.letterSpacing,lineSpacing:i.lineSpacing,transform:i.textTransform,styles:i.textStyles,indentAll:t.indentAll}));return t.width||(i.width=a.width/(((r=i.scale)==null?void 0:r.x)||1)),i.height=a.height/(((h=i.scale)==null?void 0:h.y)||1),a}let s={id:"text",set text(i){e=i,o(this),this.renderedText=Zi(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?Zi(e).text:"",add(){In(()=>o(this))},draw(){Uo(o(this))},renderArea(){return new Ye(H(0),this.width,this.height)}};return o(s),s}function Au(e,t){return{id:"rect",width:e,height:t,draw(){Ds(Object.assign(_o(this),{width:this.width,height:this.height}))},renderArea(){return new Ye(H(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function vu(e={}){let t=null,o=null,s=null,i=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return o&&s?o[s]:null},getPath(){return o?o.slice():null},getTarget(){return t},isNavigationFinished(){return o?s===null:!0},isTargetReachable(){return o!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s=o?0:null,o&&s!==null?(i||(i=this.getLevel().onNavigationMapChanged(()=>{t&&o&&s!==null&&(o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o?(s=0,this.trigger("navigationNext",this,o[s])):(s=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>i==null?void 0:i.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,o[s])):this.trigger("navigationEnded",this)},update(){if(t&&o&&s!==null){if(this.pos.sdist(o[s])<2)if(s===o.length-1){this.pos=t.clone(),s=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else s++,this.trigger("navigationNext",this,o[s]);this.moveTo(o[s],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(o)})}}}function Eu(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(o){var s;return(s=this.graph)==null?void 0:s.getWaypointPath(this.pos,o,e.navigationOpt)},get graph(){if(t)return t;let o=this.parent;for(;o;){if(o.has("pathfinderMap"))return o.graph;o=o.parent}},set graph(o){t=o}}}function Mu(e={}){let t=e.waypoints,o=e.speed||100,s=e.endBehavior||"stop",i=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return o},set patrolSpeed(r){o=r},get waypoints(){return t},set waypoints(r){t=r,i=0,a=!1},get nextLocation(){return t?t[i]:void 0},update(){let r=this.nextLocation;if(!(!t||!r||a)&&(this.moveTo(r,o),this.pos.sdist(r)<9))switch(s){case"loop":i=(i+1)%t.length;break;case"ping-pong":i=i+1,i==t.length&&(t.reverse(),i=0);break;case"stop":i<t.length-1?i+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(r){return this.on("patrolFinished",r)}}}function Su(e,t={}){let o=typeof e=="function"?e:()=>m.game.root.query(e),s=t.checkFrequency||1,i=typeof t.direction=="number"?Y.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?Y.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(r){this.direction=r!==void 0?Y.fromAngle(r):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(r,h,l){let n=(typeof h=="number"?Y.fromAngle(h):h)||i,c=l||t.fieldOfView;if(!n||!c||c>=360)return!0;let u=c/2;return r.pos&&n.angleBetween(r.pos.sub(this.pos))<=u},hasLineOfSight(r){let h=Mr(this.pos,r.pos.sub(this.pos),t.raycastExclude);return h!=null&&h.object===r},update(){if(a+=ht(),a>s){a-=s;let r=o();if(r.length&&i&&this.fieldOfView&&this.fieldOfView<360){let h=this.fieldOfView/2;r=r.filter(l=>l.pos&&i.angleBetween(l.pos.sub(this.pos))<=h)}r.length&&t.lineOfSight&&(r=r.filter(h=>h.pos&&this.hasLineOfSight(h))),r.length>0&&(this.spotted=r,this.trigger("objectSpotted",r))}},onObjectsSpotted(r){return this.on("objectSpotted",r)}}}function Xr(e={}){let t=H(0),o=e.isObstacle??!1,s=e.cost??0,i=e.edges??[],a=()=>{let h={left:1,top:2,right:4,bottom:8};return i.map(l=>h[l]||0).reduce((l,n)=>l|n,0)},r=a();return{id:"tile",tilePosOffset:e.offset??H(0),set tilePos(h){let l=this.getLevel();t=h.clone(),this.pos=H(this.tilePos.x*l.tileWidth(),this.tilePos.y*l.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(h){o!==h&&(o=h,this.getLevel().invalidateNavigationMap())},get isObstacle(){return o},set cost(h){s!==h&&(s=h,this.getLevel().invalidateNavigationMap())},get cost(){return s},set edges(h){i=h,r=a(),this.getLevel().invalidateNavigationMap()},get edges(){return i},get edgeMask(){return r},getLevel(){return this.parent},tileMove(h){let l=this.getLevel();l.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(h),l.insertIntoSpatialMap(this),l.trigger("spatialMapChanged")},moveLeft(){this.tileMove(H(-1,0))},moveRight(){this.tileMove(H(1,0))},moveUp(){this.tileMove(H(0,-1))},moveDown(){this.tileMove(H(0,1))}}}var Bn=class{constructor(e,t,o){O(this,"name");O(this,"duration");O(this,"loops");O(this,"direction");O(this,"easing");O(this,"interpolation");O(this,"isFinished");O(this,"timing");O(this,"easings");O(this,"relative");this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||Ms.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=o}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,o){let s=t-1,i=e/this.duration;if(this.loops!==0&&i>=this.loops)return[s,0,!0];let a=Math.trunc(i);if(i-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(i=1-i),o){let r=0;for(;o[r+1]!==void 0&&o[r+1]<i;)r++;return r>=s?[s,0,!0]:[r,(i-o[r])/(o[r+1]-o[r]),!1]}else{let r=Math.floor((t-1)*i);return[r,(i-r/s)*s,!1]}}setValue(e,t,o){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(o);break;case"angle":e.angle=e.base.angle+o;break;case"scale":e.scale=e.base.scale.scale(o);break;case"opacity":e.opacity=e.base.opacity*o;break;default:e[t]=o}else e[t]=o}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=Ms.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function aa(e,t){return t.add(t.sub(e))}var Ru=class extends Bn{constructor(t,o,s,i){super(t,s,i);O(this,"keys");this.keys=o}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(t,this.name,this.keys[s]);else{let r=this.easings?this.easings[s]:this.easing;this.setValue(t,this.name,Ct(this.keys[s],this.keys[s+1],r(i)))}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},Du=class extends Bn{constructor(t,o,s,i,a){var r;super(t,s,i);O(this,"keys");O(this,"curves");O(this,"dcurves");if(this.keys=o,this.interpolation==="spline"){this.curves=[],a&&(this.dcurves=[]);for(let h=0;h<this.keys.length-1;h++){let l=this.keys[h],n=h+1,c=this.keys[n],u=h>0?this.keys[h-1]:aa(c,l),d=n<this.keys.length-1?this.keys[n+1]:aa(l,c);this.curves.push($s(u,l,c,d)),a&&((r=this.dcurves)==null||r.push($s(u,l,c,d,Mc)))}}}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation==="none")this.setValue(t,this.name,this.keys[s]);else{let r=this.easings?this.easings[s]:this.easing;switch(this.interpolation){case"linear":this.setValue(t,this.name,this.keys[s].lerp(this.keys[s+1],r(i)));break;case"slerp":this.setValue(t,this.name,this.keys[s].slerp(this.keys[s+1],r(i)));break;case"spline":if(this.curves){this.setValue(t,this.name,this.curves[s](r(i))),this.dcurves&&this.setValue(t,"angle",this.dcurves[s](r(i)).angle());break}}}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(t=>[t.x,t.y])})}},Tu=class extends Bn{constructor(t,o,s,i){super(t,s,i);O(this,"keys");this.keys=o}update(t,o){let[s,i,a]=this.getLowerKeyIndexAndRelativeTime(o,this.keys.length,this.timing);if(i==0||this.interpolation=="none")this.setValue(t,this.name,this.keys[s]);else{let r=this.easings?this.easings[s]:this.easing;this.setValue(t,this.name,this.keys[s].lerp(this.keys[s+1],r(i)))}return a}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function Cu(e={}){let t=[],o=0,s=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:H(0,0),angle:0,scale:H(1,1),opacity:1},animation:{paused:!1,seek(i){o=no(i,0,this.duration),t.forEach(a=>{a.isFinished=!1}),s=!1},get duration(){return t.reduce((i,a)=>Math.max(a.duration,i),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let i=!0,a;o+=ht();for(let r of t)a=r.update(this,o),a&&!r.isFinished&&(r.isFinished=!0,this.trigger("animateChannelFinished",r.name)),i&&(i=a);i&&!s&&(s=!0,this.trigger("animateFinished"))},animate(i,a,r){s=!1,this.unanimate(i),typeof a[0]=="number"?t.push(new Ru(i,a,r,e.relative||!1)):a[0]instanceof Y?t.push(new Du(i,a,r,e.relative||!1,i==="pos"&&(e.followMotion||!1))):a[0]instanceof Be&&t.push(new Tu(i,a,r,e.relative||!1))},unanimate(i){let a=t.findIndex(r=>r.name===i);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(i){return this.on("animateFinished",i)},onAnimateChannelFinished(i){return this.on("animateChannelFinished",i)},serializeAnimationChannels(){return t.reduce((i,a)=>(i[a.name]=a.serialize(),i),{})},serializeAnimationOptions(){let i={};return e.followMotion&&(i.followMotion=!0),e.relative&&(i.relative=!0),i}}}function Gr(e,t){let o={name:e.name};return e.has("animate")&&(o.channels=e.serializeAnimationChannels(),Object.assign(o,e.serializeAnimationOptions())),e.children.length>0&&(o.children=e.children.filter(s=>s.has("named")).map(s=>Gr(s,s.name))),o}function ra(e=2,t=1){let o=0;return{require:["scale"],update(){let s=Math.sin(o*e)*t;s<0&&this.destroy(),this.scale=H(s),o+=ht()}}}function Iu(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(o=1){this.setHP(e-o),this.trigger("hurt",o)},heal(o=1){let s=e;this.setHP(e+o),this.trigger("heal",e-s)},hp(){return e},maxHP(){return t??null},setMaxHP(o){t=o},setHP(o){e=t?Math.min(t,o):o,e<=0&&this.trigger("death")},onHurt(o){return this.on("hurt",o)},onHeal(o){return this.on("heal",o)},onDeath(o){return this.on("death",o)},inspect(){return`health: ${e}`}}}function Pu(e,t={}){if(e==null)throw new Error("lifespan() requires time");let o=t.fade??0;return{id:"lifespan",require:["opacity"],add(){m.game.root.wait(e,()=>{this.opacity=this.opacity??1,o>0?m.game.root.tween(this.opacity,0,o,s=>this.opacity=s,Ms.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function Bu(e){return{id:"named",name:e}}function Ou(e,t,o){if(!e)throw new Error("state() requires an initial state");let s={};function i(l){s[l]||(s[l]={enter:new Et,end:new Et,update:new Et,draw:new Et})}function a(l,n,c){return i(n),s[n][l].add(c)}function r(l,n,...c){i(n),s[n][l].trigger(...c)}let h=!1;return{id:"state",state:e,enterState(l,...n){if(h=!0,t&&!t.includes(l))throw new Error(`State not found: ${l}`);let c=this.state;if(o){if(!(o!=null&&o[c]))return;let u=typeof o[c]=="string"?[o[c]]:o[c];if(!u.includes(l))throw new Error(`Cannot transition state from "${c}" to "${l}". Available transitions: ${u.map(d=>`"${d}"`).join(", ")}`)}r("end",c,...n),this.state=l,r("enter",l,...n),r("enter",`${c} -> ${l}`,...n)},onStateTransition(l,n,c){return a("enter",`${l} -> ${n}`,c)},onStateEnter(l,n){return a("enter",l,n)},onStateUpdate(l,n){return a("update",l,n)},onStateDraw(l,n){return a("draw",l,n)},onStateEnd(l,n){return a("end",l,n)},update(){h||(r("enter",e),h=!0),r("update",this.state)},draw(){r("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Vr(e){return{id:"stay",stay:!0,scenesToStay:e}}function Lu(e=!0,t){let o,s;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let i=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};o=m.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(m.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,i())}),s=m.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),i())})},destroy(){o.cancel(),s.cancel()}}}function on(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,o,s=1/0,i=!1){let a=i?0:t,r=new Et,h=this.onUpdate(()=>{a+=m.app.state.dt;for(let l=0;a>=t&&l<this.maxLoopsPerFrame;l++)if(s--,o(),a-=t,s<=0){h.cancel(),r.trigger();return}});return{get paused(){return h.paused},set paused(l){h.paused=l},cancel:h.cancel,onEnd(l){r.add(l)},then(l){return r.add(l),this}}},wait(t,o){return this.loop(t,o??(()=>{}),1,!0)},tween(t,o,s,i,a=Ms.linear){let r=0,h=[],l=this.onUpdate(()=>{r+=m.app.state.dt;let n=Math.min(r/s,1);i(Ct(t,o,a(n))),n===1&&(l.cancel(),i(o),h.forEach(c=>c()))});return{get paused(){return l.paused},set paused(n){l.paused=n},onEnd(n){h.push(n)},then(n){return this.onEnd(n),this},cancel(){l.cancel()},finish(){l.cancel(),i(o),h.forEach(n=>n())}}}}}var sn=0;function zu(){return sn>0}function Nu(e={}){let t={},o=new Set,s=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){sn++,this.area.cursor&&s.push(this.onHover(()=>m.app.setCursor(this.area.cursor))),s.push(this.onCollideUpdate((i,a)=>{if(!i.id)throw new Error("area() requires the object to have an id");t[i.id]||this.trigger("collide",i,a),a&&(t[i.id]=a,o.add(i.id))}))},destroy(){sn--;for(let i of s)i.cancel()},fixedUpdate(){for(let i in t)o.has(Number(i))||(this.trigger("collideEnd",t[i].target),delete t[i]);o.clear()},drawInspect(){let i=this.localArea();Ft(),Je(this.area.offset);let a={outline:{width:4/ar(),color:Ne(0,0,255)},anchor:this.anchor,fill:!1,fixed:Lo(this)};i instanceof Ye?Xt({...a,pos:i.pos,width:i.width*this.area.scale.x,height:i.height*this.area.scale.y}):i instanceof Mt?Eo({...a,pts:i.pts,scale:this.area.scale}):i instanceof Pt&&es({...a,pos:i.center,radius:i.radius}),Tt()},area:{shape:e.shape??null,scale:e.scale?H(e.scale):H(1),offset:e.offset??H(0),cursor:e.cursor??null},isClicked(){return m.app.isMousePressed()&&this.isHovering()},isHovering(){let i=Lo(this)?m.k.mousePos():m.k.toWorld(m.k.mousePos());return this.hasPoint(i)},checkCollision(i){if(!i.id)throw new Error("checkCollision() requires the object to have an id");return t[i.id]??null},getCollisions(){return Object.values(t)},isColliding(i){if(!i.id)throw new Error("isColliding() requires the object to have an id");return!!t[i.id]},isOverlapping(i){if(!i.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[i.id];return a&&a.hasOverlap()},onClick(i,a="left"){let r=this.onMousePress(a,()=>{this.isHovering()&&i()});return s.push(r),r},onHover(i){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,i())})},onHoverUpdate(i){return this.onUpdate(()=>{this.isHovering()&&i()})},onHoverEnd(i){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,i()):a=this.isHovering()})},onCollide(i,a){if(typeof i=="function"&&a===void 0)return this.on("collide",i);if(typeof i=="string")return this.onCollide((r,h)=>{r.is(i)&&(a==null||a(r,h))});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(i,a){if(typeof i=="function"&&a===void 0)return this.on("collideUpdate",i);if(typeof i=="string")return this.on("collideUpdate",(r,h)=>r.is(i)&&(a==null?void 0:a(r,h)));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(i,a){if(typeof i=="function"&&a===void 0)return this.on("collideEnd",i);if(typeof i=="string")return this.on("collideEnd",r=>r.is(i)&&(a==null?void 0:a(r)));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(i){return Ro(this.worldArea(),i)},resolveCollision(i){let a=this.checkCollision(i);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let i=this.localArea();if(!(i instanceof Mt||i instanceof Ye))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale(H(this.area.scale??1));if(i instanceof Ye){let r=ko(this.anchor||ui).add(1,1).scale(-.5).scale(i.width,i.height);a.translate(r)}return i.transform(a)},screenArea(){let i=this.worldArea();return Lo(this)?i:i.transform(m.game.cam.transform)},inspect(){var i,a,r,h,l,n,c;return((i=this.area.scale)==null?void 0:i.x)==((a=this.area.scale)==null?void 0:a.y)?`area: ${(h=(r=this.area.scale)==null?void 0:r.x)==null?void 0:h.toFixed(1)}x`:`area: (${(n=(l=this.area.scale)==null?void 0:l.x)==null?void 0:n.toFixed(1)}x, ${(c=this.area.scale.y)==null?void 0:c.toFixed(1)}y)`}}}function Hu(e={}){let t=null,o=null,s=!1,i=H(0),a=null,r=null,h;return{id:"body",require:["pos"],vel:H(0),drag:e.drag??0,jumpForce:e.jumpForce??Gc,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),r=this.pos.clone(),h=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((l,n)=>{if(!n||!l.has("body")||n.resolved)return;this.trigger("beforePhysicsResolve",n);let c=n.reverse();if(l.trigger("beforePhysicsResolve",c),!(n.resolved||c.resolved)&&!(this.isStatic&&l.isStatic)){if(!this.isStatic&&!l.isStatic){let u=this.mass+l.mass;this.pos=this.pos.add(n.displacement.scale(l.mass/u)),l.pos=l.pos.add(n.displacement.scale(-this.mass/u)),this.transform=ys(this),l.transform=ys(l)}else{let u=!this.isStatic&&l.isStatic?n:n.reverse();u.source.pos=u.source.pos.add(u.displacement),u.source.transform=ys(u.source)}n.resolved=!0,this.trigger("physicsResolve",n),l.trigger("physicsResolve",n.reverse())}}),this.onPhysicsResolve(l=>{if(m.game.gravity)if(l.isBottom()&&this.isFalling()){this.vel=this.vel.reject(m.game.gravity.unit());let n=t;t=l.target,n!=t&&(o=l.target.pos),s?s=!1:n||(this.trigger("ground",t),l.target.trigger("land",this))}else l.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(m.game.gravity.unit()),this.trigger("headbutt",l.target),l.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(o&&!t.pos.eq(o)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(o)),o=t.pos);let l=Ji();l&&(this.pos.x==h.x&&(this.pos.x=Ct(a.x,r.x,l/$i()),h.x=this.pos.x),this.pos.y==h.y&&(this.pos.y=Ct(a.y,r.y,l/$i()),h.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==h.x&&(this.pos.x=a.x),this.pos.y==h.y&&(this.pos.y=a.y),a=null),m.game.gravity&&!this.isStatic){s&&(t=null,o=null,this.trigger("fallOff"),s=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(s=!0);let l=this.vel.clone();this.vel=this.vel.add(m.game.gravity.scale(this.gravityScale*ht()));let n=e.maxVelocity??Vc;this.vel.slen()>n*n&&(this.vel=this.vel.unit().scale(n)),l.dot(m.game.gravity)<0&&this.vel.dot(m.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=i.x*ht(),this.vel.y+=i.y*ht(),this.vel.x*=1-this.drag*ht(),this.vel.y*=1-this.drag*ht(),this.move(this.vel),Ji()){a=this.pos.clone();let l=this.vel.add(i.scale(ht()));r=this.pos.add(l.scale(ht())),h=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(l){return this.on("physicsResolve",l)},onBeforePhysicsResolve(l){return this.on("beforePhysicsResolve",l)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(bs())>0},isJumping(){return this.vel.dot(bs())<0},applyImpulse(l){this.isStatic||(this.vel=this.vel.add(l))},addForce(l){this.isStatic||(i.x+=l.x/this.mass,i.y+=l.y/this.mass)},jump(l){this.isStatic||(t=null,o=null,this.vel=bs().scale(-l||-this.jumpForce))},onGround(l){return this.on("ground",l)},onFall(l){return this.on("fall",l)},onFallOff(l){return this.on("fallOff",l)},onHeadbutt(l){return this.on("headbutt",l)},onLand(l){return this.on("land",l)},onHeadbutted(l){return this.on("headbutted",l)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function Uu(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(o){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(o))},onDoubleJump(o){return this.on("doubleJump",o)},inspect(){return`jumpsLeft: ${t}`}}}function _u(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,o)=>{var r;let s=o==null?void 0:o.normal.normal(),i=t.vel.project(s),a=(r=s==null?void 0:s.scale(this.speed))==null?void 0:r.sub(i);t.addForce(a==null?void 0:a.scale(t.mass*this.forceScale))})}}}function qu(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{if(!t.has("body"))return;let s=Y.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(s),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function Fu(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{let s=this.pos.sub(t.pos),i=s.len(),a=i*this.distanceScale/10,r=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,h=s.scale(this.forceMagnitude*r/i);t.addForce(h),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function Yu(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function Xu(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let o=t.target.vel,s=bs().scale(-1).angleBetween(o);Math.abs(s)>this.surfaceArc/2&&t.preventResolution()})}}}function Gu(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,o)=>{let s=t,i=s.worldArea(),[a,r]=i.cut(H(-100,this.surfaceLevel),H(100,this.surfaceLevel));a&&(this.applyBuoyancy(s,a),this.applyDrag(s,a)),this.flowMagnitude&&s.addForce(Y.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,o){let s=this.density*o.area(),i=H(0,1).scale(-s);t.addForce(i)},applyDrag(t,o){let s=t.vel,i=this.density*this.linearDrag,a=s.scale(-i);t.addForce(a)}}}function nn(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function Kr(){return{id:"fixed",fixed:!0}}function Vu(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??H(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Ku(e){var o;let t=(o=m.game.layers)==null?void 0:o.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){var s;return t?((s=m.game.layers)==null?void 0:s[t])??null:null},set layer(s){var i;if(t=(i=m.game.layers)==null?void 0:i.indexOf(s),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function ju(e,t){let o=typeof e=="number"?Y.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(o.scale(t))}}}function Wu(e={}){let t=!1,o=new Ye(H(0),gt(),At()),s=new Ye(H(0),0,0),i=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??Wn,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(o.width=gt(),o.height=At(),!this.offscreenDistance&&this.width&&this.height)return s.width=this.width,s.height=this.height,s.pos=this.pos,s.collides(o);let r=this.offscreenDistance?this.offscreenDistance:Wn;return!ci(o,a)&&o.sdistToPoint(a)>r*r},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?Rr(()=>i(this)):this.onUpdate(()=>i(this))}}}function ei(...e){return{id:"pos",pos:H(...e),moveBy(...t){this.pos=this.pos.add(H(...t))},move(...t){this.moveBy(H(...t).scale(ht()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(H(t[0],t[1]),t[2]);let o=t[0],s=t[1];if(s===void 0){this.pos=H(o);return}let i=o.sub(this.pos);if(i.len()<=s*ht()){this.pos=H(o);return}this.move(i.unit().scale(s))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let o=this.worldPos();return o?Lo(this)?o:en(o):null}},toScreen(t){let o=this.toWorld(t);return Lo(this)?o:en(o)},fromScreen(t){return Lo(this)?this.fromWorld(t):this.fromWorld(Nr(t))},toOther(t,o){return t.fromWorld(this.toWorld(o))},fromOther(t,o){return t.toOther(this,o)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){es({color:Ne(255,0,0),radius:4/ar()})}}}function $u(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function ti(...e){if(e.length===0)return ti(1);let t=H(...e);return{id:"scale",set scale(o){if(!(o instanceof Y))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=H(o)},get scale(){return t},scaleTo(...o){t=H(...o)},scaleBy(...o){t=t.scale(H(...o))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function Ju(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Qu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",Zu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",ku=Xl.version,m={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},ep=(e={tagsAsComponents:!0})=>{m.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),m.k.quit()),m.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let o=e.canvas??t.appendChild(document.createElement("canvas"));m.canvas=o;let s=e.scale??1;m.gscale=s;let i=e.width&&e.height&&!e.stretch&&!e.letterbox;i?(o.width=e.width*s,o.height=e.height*s):(o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(i){let q=o.width,j=o.height;a.push(`width: ${q}px`),a.push(`height: ${j}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),o.style.cssText=a.join(";");let r=e.pixelDensity||1;m.pixelDensity=r,o.width*=r,o.height*=r,o.tabIndex=0;let h=document.createElement("canvas");h.width=256,h.height=256,m.fontCacheCanvas=h;let l=h.getContext("2d",{willReadFrequently:!0});m.fontCacheC2d=l;let n=bh({canvas:o,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});m.app=n;let c=[],u=n.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!u)throw new Error("WebGL not supported");let d=u,x=pd(d,{texFilter:e.texFilter}),f=bd(e,x);m.gfx=f;let A=ru();m.audio=A;let g=jh(x,e.spriteAtlasPadding??0);m.assets=g;let w=ou();m.game=w,w.root.use(on());function D(q,j){let ae=new Zs(x,q,j);return{clear:()=>ae.clear(),free:()=>ae.free(),toDataURL:()=>ae.toDataURL(),toImageData:()=>ae.toImageData(),width:ae.width,height:ae.height,draw:ge=>{Yt(),ae.bind(),ge(),Yt(),ae.unbind()},get fb(){return ae}}}function R(){d.clear(d.COLOR_BUFFER_BIT),f.frameBuffer.bind(),d.clear(d.COLOR_BUFFER_BIT),f.bgColor||vo(()=>{Ds({width:gt(),height:At(),quad:new We(0,0,gt()/64,At()/64),tex:f.bgTex,fixed:!0})}),f.renderer.numDraws=0,f.fixed=!1,f.transformStack.length=0,f.transform=new ao}function X(q,j){f.postShader=q,f.postShaderUniform=j??null}function _(){Yt(),f.lastDrawCalls=f.renderer.numDraws,f.frameBuffer.unbind(),d.viewport(0,0,d.drawingBufferWidth,d.drawingBufferHeight);let q=f.width,j=f.height;f.width=d.drawingBufferWidth/r,f.height=d.drawingBufferHeight/r,ks({flipY:!0,tex:f.frameBuffer.tex,pos:new Y(f.viewport.x,f.viewport.y),width:f.viewport.width,height:f.viewport.height,shader:f.postShader,uniform:typeof f.postShaderUniform=="function"?f.postShaderUniform():f.postShaderUniform,fixed:!0}),Yt(),f.width=q,f.height=j}let p=!1,y={inspect:!1,set timeScale(q){m.app.state.timeScale=q},get timeScale(){return m.app.state.timeScale},showLog:!0,fps:()=>n.fps(),numFrames:()=>n.numFrames(),stepFrame:Ee,drawCalls:()=>f.lastDrawCalls,clearLog:()=>w.logs=[],log:(...q)=>{let j=e.logMax??8,ae=q.length>1?q.concat(" ").join(" "):q[0];w.logs.unshift({msg:ae,time:n.time()}),w.logs.length>j&&(w.logs=w.logs.slice(0,j))},error:q=>y.log(new Error(q.toString?q.toString():q)),curRecording:null,numObjects:()=>G("*",{recursive:!0}).length,get paused(){return p},set paused(q){p=q,q?A.ctx.suspend():A.ctx.resume()}};m.debug=y;function b(q,j){try{return JSON.parse(window.localStorage[q])}catch{return j?(E(q,j),j):null}}function E(q,j){window.localStorage[q]=JSON.stringify(j)}function T(q,...j){let ae=q(K),ge;typeof ae=="function"?ge=ae(...j)(K):ge=ae;for(let he in ge)K[he]=ge[he],e.global!==!1&&(window[he]=ge[he]);return K}function C(q){let j=n.canvas.captureStream(q),ae=A.ctx.createMediaStreamDestination();A.masterNode.connect(ae);let ge=new MediaRecorder(j),he=[];return ge.ondataavailable=me=>{me.data.size>0&&he.push(me.data)},ge.onerror=()=>{A.masterNode.disconnect(ae),j.getTracks().forEach(me=>me.stop())},ge.start(),{resume(){ge.resume()},pause(){ge.pause()},stop(){return ge.stop(),A.masterNode.disconnect(ae),j.getTracks().forEach(me=>me.stop()),new Promise(me=>{ge.onstop=()=>{me(new Blob(he,{type:"video/mp4"}))}})},download(me="kaboom.mp4"){this.stop().then(Se=>$n(me,Se))}}}function N(){return document.activeElement===n.canvas}let B=w.root.add.bind(w.root),v=w.root.readd.bind(w.root),z=w.root.removeAll.bind(w.root),G=w.root.get.bind(w.root),J=w.root.wait.bind(w.root),se=w.root.loop.bind(w.root),V=w.root.query.bind(w.root),k=w.root.tween.bind(w.root),fe=ws(null,Zu),oe=ws(null,Qu);m.kaSprite=fe,m.boomSprite=oe;function Ie(){w.root.fixedUpdate()}function Ee(){w.root.update()}class Re{constructor(j,ae,ge,he,me=!1){O(this,"source");O(this,"target");O(this,"normal");O(this,"distance");O(this,"resolved",!1);this.source=j,this.target=ae,this.normal=ge,this.distance=he,this.resolved=me}get displacement(){return this.normal.scale(this.distance)}reverse(){return new Re(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(w.gravity||H(0,1))>0}isRight(){return this.displacement.cross(w.gravity||H(0,1))<0}isTop(){return this.displacement.dot(w.gravity||H(0,1))>0}isBottom(){return this.displacement.dot(w.gravity||H(0,1))<0}preventResolution(){this.resolved=!0}}function Ae(){if(!zu())return;let q={},j=e.hashGridSize||64,ae=new ao,ge=[];function he(me){if(ge.push(ae.clone()),me.pos&&ae.translate(me.pos),me.scale&&ae.scale(me.scale),me.angle&&ae.rotate(me.angle),me.transform=ae.clone(),me.c("area")&&!me.paused){let Se=me,it=Se.worldArea().bbox(),Zt=Math.floor(it.pos.x/j),Kt=Math.floor(it.pos.y/j),Lt=Math.ceil((it.pos.x+it.width)/j),Ve=Math.ceil((it.pos.y+it.height)/j),St=new Set;for(let xt=Zt;xt<=Lt;xt++)for(let Qe=Kt;Qe<=Ve;Qe++)if(!q[xt])q[xt]={},q[xt][Qe]=[Se];else if(!q[xt][Qe])q[xt][Qe]=[Se];else{let ke=q[xt][Qe];e:for(let Ze of ke){if(Ze.paused||!Ze.exists()||St.has(Ze.id))continue;for(let Nt of Se.collisionIgnore)if(Ze.is(Nt))continue e;for(let Nt of Ze.collisionIgnore)if(Se.is(Nt))continue e;let zt=Ic(Se.worldArea(),Ze.worldArea());if(zt){let Nt=new Re(Se,Ze,zt.normal,zt.distance);Se.trigger("collideUpdate",Ze,Nt);let et=Nt.reverse();et.resolved=Nt.resolved,Ze.trigger("collideUpdate",Se,et)}St.add(Ze.id)}ke.push(Se)}}me.children.forEach(he),ae=ge.pop()}he(w.root)}function Ce(q){console.error(q),A.ctx.suspend();let j=q.message??String(q)??"Unknown error, check console for more info";n.run(()=>{},()=>{R(),vo(()=>{let ae=gt(),ge=At(),he={size:36,width:ae-32*2,letterSpacing:4,lineSpacing:4,font:Js,fixed:!0};Xt({width:ae,height:ge,color:Ne(0,0,255),fixed:!0});let me=Ho({...he,text:"Error",pos:H(32),color:Ne(255,128,0),fixed:!0});Uo(me),na({...he,text:j,pos:H(32,32+me.height+16),fixed:!0}),Tt(),w.events.trigger("error",q)}),_()})}function Te(q){c.push(q)}function He(){w.events.onOnce("frameEnd",()=>{n.quit(),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT|d.STENCIL_BUFFER_BIT);let q=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS);for(let j=0;j<q;j++)d.activeTexture(d.TEXTURE0+j),d.bindTexture(d.TEXTURE_2D,null),d.bindTexture(d.TEXTURE_CUBE_MAP,null);d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),d.bindRenderbuffer(d.RENDERBUFFER,null),d.bindFramebuffer(d.FRAMEBUFFER,null),x.destroy(),c.forEach(j=>j())})}let ee=!0;n.run(()=>{try{g.loaded&&(y.paused||Ie(),Ae())}catch(q){Ce(q)}},(q,j)=>{try{q(),g.loaded||No()===1&&!ee&&(g.loaded=!0,lr().forEach(ae=>w.events.trigger("loadError",...ae)),w.events.trigger("load")),!g.loaded&&e.loadingScreen!==!1||ee?(R(),md(),_()):(y.paused||Ee(),Ae(),R(),gd(),e.debug!==!1&&fd(),_()),ee&&(ee=!1),w.events.trigger("frameEnd"),j()}catch(ae){Ce(ae)}}),nr(),qr();let K={_k:m,VERSION:ku,loadRoot:Gh,loadProgress:No,loadSprite:ws,loadSpriteAtlas:mr,loadSound:ad,loadMusic:rd,loadBitmapFont:kh,loadFont:Qh,loadShader:sd,loadShaderURL:id,loadAseprite:Jh,loadPedit:ed,loadBean:$h,loadJSON:Vh,load:Qi,getSound:gr,getFont:ur,getBitmapFont:pr,getSprite:cr,getShader:fr,getAsset:Kh,Asset:Vt,SpriteData:Do,SoundData:Rs,width:gt,height:At,center:Qs,dt:ht,fixedDt:$i,restDt:Ji,time:n.time,screenshot:n.screenshot,record:C,isFocused:N,setCursor:n.setCursor,getCursor:n.getCursor,setCursorLocked:n.setCursorLocked,isCursorLocked:n.isCursorLocked,setFullscreen:n.setFullscreen,isFullscreen:n.isFullscreen,isTouchscreen:n.isTouchscreen,onLoad:In,onLoadError:Wd,onLoading:Vd,onResize:Kd,onGamepadConnect:n.onGamepadConnect,onGamepadDisconnect:n.onGamepadDisconnect,onError:jd,onCleanup:Te,flash:zr,setCamPos:Cr,getCamPos:Ir,setCamRot:Or,getCamRot:Lr,setCamScale:Pr,getCamScale:Br,getCamTransform:$d,camPos:Zd,camScale:kd,camFlash:tu,camRot:eu,camTransform:Jd,shake:Qd,toScreen:en,toWorld:Nr,setGravity:su,getGravity:iu,setGravityDirection:nu,getGravityDirection:bs,setBackground:Uh,getBackground:_h,getGamepads:n.getGamepads,getTreeRoot:gu,add:B,make:Pn,destroy:Yr,destroyAll:z,get:G,query:V,readd:v,pos:ei,scale:ti,rotate:$u,color:vr,opacity:Er,anchor:nn,area:Nu,sprite:tn,text:bu,polygon:Td,rect:Sr,circle:Ad,uvquad:Au,outline:Sd,particles:Dd,body:Hu,platformEffector:Xu,surfaceEffector:_u,areaEffector:qu,pointEffector:Fu,buoyancyEffector:Gu,constantForce:Yu,doubleJump:Uu,shader:Cd,textInput:Lu,timer:on,fixed:Kr,stay:Vr,health:Iu,lifespan:Pu,named:Bu,state:Ou,z:Ju,layer:Ku,move:ju,offscreen:Wu,follow:Vu,fadeIn:Ed,mask:Md,drawon:vd,raycast:Mr,tile:Xr,animate:Cu,serializeAnimation:Gr,agent:vu,sentry:Su,patrol:Mu,pathfinder:Eu,trigger:Pd,on:Ot,onFixedUpdate:Bd,onUpdate:Rr,onDraw:Od,onAdd:Dr,onDestroy:Ld,onTag:Tr,onUntag:Hd,onUse:zd,onUnuse:Nd,onClick:Fd,onCollide:Ud,onCollideUpdate:_d,onCollideEnd:qd,onHover:Yd,onHoverUpdate:Xd,onHoverEnd:Gd,onKeyDown:n.onKeyDown,onKeyPress:n.onKeyPress,onKeyPressRepeat:n.onKeyPressRepeat,onKeyRelease:n.onKeyRelease,onMouseDown:n.onMouseDown,onMousePress:n.onMousePress,onMouseRelease:n.onMouseRelease,onMouseMove:n.onMouseMove,onCharInput:n.onCharInput,onTouchStart:n.onTouchStart,onTouchMove:n.onTouchMove,onTouchEnd:n.onTouchEnd,onScroll:n.onScroll,onHide:n.onHide,onShow:n.onShow,onGamepadButtonDown:n.onGamepadButtonDown,onGamepadButtonPress:n.onGamepadButtonPress,onGamepadButtonRelease:n.onGamepadButtonRelease,onGamepadStick:n.onGamepadStick,onButtonPress:n.onButtonPress,onButtonDown:n.onButtonDown,onButtonRelease:n.onButtonRelease,mousePos:n.mousePos,mouseDeltaPos:n.mouseDeltaPos,isKeyDown:n.isKeyDown,isKeyPressed:n.isKeyPressed,isKeyPressedRepeat:n.isKeyPressedRepeat,isKeyReleased:n.isKeyReleased,isMouseDown:n.isMouseDown,isMousePressed:n.isMousePressed,isMouseReleased:n.isMouseReleased,isMouseMoved:n.isMouseMoved,isGamepadButtonPressed:n.isGamepadButtonPressed,isGamepadButtonDown:n.isGamepadButtonDown,isGamepadButtonReleased:n.isGamepadButtonReleased,getGamepadStick:n.getGamepadStick,isButtonPressed:n.isButtonPressed,isButtonDown:n.isButtonDown,isButtonReleased:n.isButtonReleased,setButton:n.setButton,getButton:n.getButton,pressButton:n.pressButton,releaseButton:n.releaseButton,getLastInputDeviceType:n.getLastInputDeviceType,charInputted:n.charInputted,loop:se,wait:J,play:cu,setVolume:Ur,getVolume:_r,volume:hu,burp:Hr,audioCtx:A.ctx,Line:Bt,Rect:Ye,Circle:Pt,Ellipse:go,Point:uc,Polygon:Mt,Vec2:Y,Color:Be,Mat4:ao,Quad:We,RNG:za,rand:ct,randi:Na,randSeed:Wl,vec2:H,rgb:Ne,hsl2rgb:Gl,quad:ot,choose:Ql,chooseMultiple:Jl,shuffle:Ha,chance:$l,lerp:Ct,tween:k,easings:Ms,map:oo,mapc:Vl,wave:La,deg2rad:st,rad2deg:zo,clamp:no,evaluateQuadratic:fc,evaluateQuadraticFirstDerivative:gc,evaluateQuadraticSecondDerivative:mc,evaluateBezier:vn,evaluateBezierFirstDerivative:xc,evaluateBezierSecondDerivative:yc,evaluateCatmullRom:wc,evaluateCatmullRomFirstDerivative:bc,curveLengthApproximation:ja,normalizedCurve:Ac,hermite:Cs,cardinal:Wa,catmullRom:$s,bezier:vc,kochanekBartels:Ec,easingSteps:Cc,easingLinear:Dc,easingCubicBezier:Tc,testLineLine:mn,testRectRect:Ua,testRectLine:xn,testRectPoint:ci,testCirclePolygon:di,testLinePoint:yn,testLineCircle:Ts,isConvex:zc,triangulate:Ja,NavMesh:Nh,drawSprite:yd,drawText:na,formatText:Ho,drawRect:Xt,drawLine:fs,drawLines:Cn,drawTriangle:br,drawCircle:es,drawEllipse:xr,drawUVQuad:Ds,drawPolygon:Eo,drawCurve:yr,drawBezier:dd,drawFormattedText:Uo,drawMasked:xd,drawSubtracted:wd,pushTransform:Ft,popTransform:Tt,pushTranslate:Je,pushScale:Ss,pushRotate:Wo,pushMatrix:qh,usePostEffect:X,makeCanvas:D,debug:y,scene:mu,getSceneName:wu,go:xu,onSceneLeave:yu,layers:fu,getLayers:uu,setLayers:Fr,getDefaultLayer:pu,addLevel:Id,getData:b,setData:E,download:Mn,downloadJSON:Qc,downloadText:sr,downloadBlob:$n,plug:T,ASCII_CHARS:Qa,canvas:n.canvas,addKaboom:du,LEFT:Y.LEFT,RIGHT:Y.RIGHT,UP:Y.UP,DOWN:Y.DOWN,RED:Be.RED,GREEN:Be.GREEN,BLUE:Be.BLUE,YELLOW:Be.YELLOW,MAGENTA:Be.MAGENTA,CYAN:Be.CYAN,WHITE:Be.WHITE,BLACK:Be.BLACK,quit:He,KEvent:Et,KEventHandler:Es,KEventController:Fo,cancel:()=>ka};m.k=K;let Z=e.plugins;if(Z&&Z.forEach(T),e.global!==!1)for(let q in K)window[q]=K[q];return e.focus!==!1&&n.canvas.focus(),K},tp=ep;const op="modulepreload",sp=function(e){return"/SuperSmashTexty/"+e},la={},mi=function(t,o,s){let i=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),h=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=Promise.allSettled(o.map(l=>{if(l=sp(l),l in la)return;la[l]=!0;const n=l.endsWith(".css"),c=n?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${c}`))return;const u=document.createElement("link");if(u.rel=n?"stylesheet":op,n||(u.as="script"),u.crossOrigin="",u.href=l,h&&u.setAttribute("nonce",h),document.head.appendChild(u),n)return new Promise((d,x)=>{u.addEventListener("load",d),u.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(r){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=r,window.dispatchEvent(h),!h.defaultPrevented)throw r}return i.then(r=>{for(const h of r||[])h.status==="rejected"&&a(h.reason);return t().catch(a)})},ca=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Legendary","Royal","Noble","Rogue","Savage"],ha=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter"];function an(){const e=ca[Math.floor(Math.random()*ca.length)],t=ha[Math.floor(Math.random()*ha.length)];return`${e}${t}`}function rn(){return Math.floor(1e5+Math.random()*9e5).toString()}function ip(e){return/^\d{6}$/.test(e)}const jr="superSmashTexty_save",np="$",ln={version:1,currency:0,playerName:null,inviteCode:null,unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0},achievements:[]};function $e(){try{const t=localStorage.getItem(jr);if(t){const o=JSON.parse(t),s={...ln,...o};return s.playerName||(s.playerName=an(),It(s)),s.inviteCode||(s.inviteCode=rn(),It(s)),s}}catch(t){console.error("Error loading save:",t)}const e={...ln};return e.playerName=an(),e.inviteCode=rn(),It(e),e}function It(e){try{return localStorage.setItem(jr,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function ap(){return $e()}function cn(e){const t=$e();return t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+e),It(t),t.currency}function qo(){return $e().currency}function to(e,t){const o=$e();return o.unlocks[e]&&o.unlocks[e].includes(t)}function rp(e,t){const o=$e();return o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)?!1:(o.unlocks[e].push(t),It(o),!0)}async function da(e){const{CHARACTER_UNLOCKS:t}=await mi(async()=>{const{CHARACTER_UNLOCKS:s}=await Promise.resolve().then(()=>xp);return{CHARACTER_UNLOCKS:s}},void 0);$e();let o=!1;for(const[s,i]of Object.entries(t))i.unlockRequirement&&i.unlockRequirement.type==="floor"&&e>=i.unlockRequirement.value&&(to("characters",s)||(rp("characters",s),o=!0));return o}function Is(){return $e().selectedCharacter||"survivor"}function lp(e){const t=$e();t.selectedCharacter=e,It(t)}function uo(e){const t=$e();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function cp(e,t,o){const s=$e();return s.currency>=o?(s.currency-=o,s.unlocks[e]||(s.unlocks[e]=[]),s.unlocks[e].includes(t)||s.unlocks[e].push(t),It(s),!0):!1}function hp(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function dp(e,t,o){const s=$e(),i=uo(e);return o&&i>=o?{success:!1,reason:"maxLevel"}:s.currency<t?{success:!1,reason:"insufficientCurrency"}:(s.currency-=t,s.permanentUpgradeLevels||(s.permanentUpgradeLevels={}),s.permanentUpgradeLevels[e]=(i||0)+1,s.permanentUpgradePurchaseHistory||(s.permanentUpgradePurchaseHistory={}),s.permanentUpgradePurchaseHistory[e]||(s.permanentUpgradePurchaseHistory[e]=[]),s.permanentUpgradePurchaseHistory[e].push(t),s.unlocks.permanentUpgrades||(s.unlocks.permanentUpgrades=[]),s.unlocks.permanentUpgrades.includes(e)||s.unlocks.permanentUpgrades.push(e),It(s),{success:!0,newLevel:s.permanentUpgradeLevels[e]})}function Wr(){const e=$e();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(o=>{const s=e.permanentUpgradePurchaseHistory[o];s&&Array.isArray(s)&&s.forEach(i=>{t+=i})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(o=>{const s=e.permanentUpgradeLevels[o]||0;for(let i=0;i<s;i++)t+=hp(i)}),t}return 0}function up(){const e=$e(),t=Wr();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),It(e),{success:!0,refundAmount:t})}function pp(e){const t=$e();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),It(t)}function rt(e){const t=$e();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function lt(e){const t=$e();return t.achievements||(t.achievements=[]),t.achievements.includes(e)?!1:(t.achievements.push(e),It(t),!0)}function fp(){return $e().achievements||[]}function $r(){return $e().stats||ln.stats}function gp(e){let t=0;return t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30),Math.floor(t)}function On(){return np}function Ln(){return $e().playerName||"Player"}function ua(e){const t=$e();return t.playerName=e,It(t),t.playerName}function $o(){return $e().inviteCode||"000000"}function mp(e){const t=$e();return t.inviteCode=e,It(t),t.inviteCode}const ro={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"}},Jr={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0}},Qr={startingHealth:{name:"Starting Health +10",description:"Begin runs with +10 max health",cost:50,maxLevel:5},startingDamage:{name:"Starting Damage +1",description:"Begin runs with +1 damage",cost:75,maxLevel:5},startingSpeed:{name:"Starting Speed +10",description:"Begin runs with +10 speed",cost:60,maxLevel:5}};function Zr(e){switch(e){case"characters":return ro;case"weapons":return Jr;case"permanentUpgrades":return Qr;default:return{}}}const xp=Object.freeze(Object.defineProperty({__proto__:null,CHARACTER_UNLOCKS:ro,PERMANENT_UPGRADE_UNLOCKS:Qr,WEAPON_UNLOCKS:Jr,getUnlocksForCategory:Zr},Symbol.toStringTag,{value:"Module"})),hn={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]}};function kr(e){return hn[e]||hn.pistol}function yp(e,t){return kr(e).upgradeCategories.includes(t)}const as={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},eo={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},so={BASE_XP_TO_NEXT_LEVEL:10,XP_SCALING_FACTOR:1.5,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},yo={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},bt={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},Jo={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},je={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:200,MAGNETIZE_ACCELERATION:50,COLLECTION_RADIUS:20};function Bi(e,t=0,o=0){const s=e*(1-o);return Math.max(bt.MIN_DAMAGE,s-t)}function wp(e){return Math.random()<e}function bp(e,t=2){return Math.floor(e*t)}function Oi(e,t,o,s=null){const i=s||Is(),a=ro[i]||ro.survivor,r=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.z(-1),"playerOutline"]),h=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...a.color),e.area(),e.health(a.stats.health),"player"]);h.outline=r,h.characterKey=i,h.characterData=a,h.speed=a.stats.speed,h.originalSpeed=a.stats.speed,h.slowed=!1,h.maxHealth=a.stats.health,h.level=so.STARTING_LEVEL,h.xp=so.STARTING_XP,h.xpToNext=so.BASE_XP_TO_NEXT_LEVEL,h.pickupRadius=eo.BASE_PICKUP_RADIUS,h.invulnerable=!1,h.invulnerableTime=0,h.invulnerableDuration=eo.INVULNERABILITY_DURATION,h.setHP(h.maxHealth);const l=a.weapon||"pistol",n=kr(l);h.weaponKey=l,h.weaponDef=n,h.baseFireRate=n.fireRate,h.baseProjectileSpeed=n.projectileSpeed,h.baseProjectileDamage=n.baseDamage;const c=a.stats.damage||10,u=n.baseDamage,d=c/10;h.fireRate=n.fireRate,h.projectileSpeed=n.projectileSpeed,h.projectileDamage=Math.floor(u*d),h.lastFireTime=0,h.projectileCount=n.projectileCount,h.piercing=n.piercing,h.obstaclePiercing=n.obstaclePiercing,h.critChance=n.critChance,h.critDamage=n.critDamage,h.spreadAngle=n.spreadAngle,h.defense=0,h.weaponRange=n.range,h.weaponCategory=n.category,n.orbitRadius&&(h.orbitRadius=n.orbitRadius,h.rotationSpeed=n.rotationSpeed,h.orbitalOrbs=[],h.orbitalAngles=[]),n.explosionRadius&&(h.explosionRadius=n.explosionRadius,h.explosionDamage=n.explosionDamage),n.chainRange&&(h.chainRange=n.chainRange,h.maxJumps=n.maxJumps,h.chainDamageReduction=n.chainDamageReduction),h.xpMultiplier=1,h.dodgeChance=0,h.damageReduction=0,h.weapons=[l],h.passiveUpgrades=[],h.upgradeStacks={},a.ability==="xpBoost"?h.xpMultiplier=yo.SURVIVOR_XP_BOOST:a.ability==="speedBoost"?(h.speed=h.speed*yo.SCOUT_SPEED_BOOST,h.originalSpeed=h.speed,h.dodgeChance=yo.SCOUT_DODGE_CHANCE):a.ability==="tankStats"?(h.maxHealth=Math.floor(h.maxHealth*yo.TANK_HEALTH_BOOST),h.setHP(h.maxHealth),h.damageReduction=yo.TANK_DAMAGE_REDUCTION):a.ability==="critBoost"?(h.critChance=(h.critChance||0)*yo.SNIPER_CRIT_CHANCE_MULTIPLIER,h.critDamage=(h.critDamage||2)*yo.SNIPER_CRIT_DAMAGE_MULTIPLIER):a.ability==="fireDot"&&(h.fireDotMultiplier=yo.PYRO_FIRE_DOT_MULTIPLIER);let x=e.vec2(0,0);return e.onKeyDown(["w","up"],()=>{h.isRemote||(x.y=-1)}),e.onKeyDown(["s","down"],()=>{h.isRemote||(x.y=1)}),e.onKeyDown(["a","left"],()=>{h.isRemote||(x.x=-1)}),e.onKeyDown(["d","right"],()=>{h.isRemote||(x.x=1)}),e.onKeyRelease(["w","up"],()=>{h.isRemote||!e.isKeyDown("s")&&!e.isKeyDown("down")&&(x.y=0)}),e.onKeyRelease(["s","down"],()=>{h.isRemote||!e.isKeyDown("w")&&!e.isKeyDown("up")&&(x.y=0)}),e.onKeyRelease(["a","left"],()=>{h.isRemote||!e.isKeyDown("d")&&!e.isKeyDown("right")&&(x.x=0)}),e.onKeyRelease(["d","right"],()=>{h.isRemote||!e.isKeyDown("a")&&!e.isKeyDown("left")&&(x.x=0)}),h.onUpdate(()=>{if(h.outline&&h.outline.exists()&&(h.outline.pos=h.pos.clone()),e.paused)return;if(h.invulnerable)if(h.invulnerableTime-=e.dt(),h.invulnerableTime<=0)h.invulnerable=!1,h.color=e.rgb(...eo.NORMAL_COLOR),h.outline&&h.outline.exists()&&(h.outline.opacity=1);else{const w=eo.IMMUNITY_FLASH_RATE;Math.floor(h.invulnerableTime*w)%2===0?(h.color=e.rgb(...eo.NORMAL_COLOR),h.outline&&h.outline.exists()&&(h.outline.opacity=1)):(h.color=e.rgb(...eo.NORMAL_COLOR,eo.IMMUNITY_ALPHA),h.outline&&h.outline.exists()&&(h.outline.opacity=eo.IMMUNITY_ALPHA))}if(x.len()>0){const w=x.len(),R=x.scale(1/w).scale(h.speed*e.dt()),X=h.pos.x+R.x,_=h.pos.y+R.y;let p=!0,y=!0;const b=e.get("obstacle"),E=eo.COLLISION_SIZE;for(const T of b){if(!T.exists())continue;const C=T.pos.x-T.width/2,N=T.pos.x+T.width/2,B=T.pos.y-T.height/2,v=T.pos.y+T.height/2,z=X-E,G=X+E,J=h.pos.y-E,se=h.pos.y+E;G>C&&z<N&&se>B&&J<v&&(p=!1);const V=h.pos.x-E,k=h.pos.x+E,fe=_-E,oe=_+E;k>C&&V<N&&oe>B&&fe<v&&(y=!1)}p&&(h.pos.x=X),y&&(h.pos.y=_)}const f=e.width(),A=e.height(),g=eo.ROOM_MARGIN;h.pos.x=e.clamp(h.pos.x,g,f-g),h.pos.y=e.clamp(h.pos.y,g,A-g)}),h}const xe={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function xi(e,t=!0){return new Promise((o,s)=>{if(xe.isInitialized){console.warn("Network already initialized"),o(e);return}if(window.addEventListener("beforeunload",()=>{ol()}),typeof Peer>"u"){console.error("PeerJS library not loaded"),s(new Error("PeerJS library not available"));return}xe.isHost=t;const i=t?`smash-${e}`:void 0;try{xe.peer=new Peer(i,{debug:0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}],iceTransportPolicy:"all"}}),xe.peer.on("open",a=>{console.log("Peer initialized with ID:",a),xe.peerId=a,xe.isInitialized=!0;const r=t&&a.startsWith("smash-")?a.substring(6):a;o(r)}),xe.peer.on("error",a=>{if(console.error("Peer error:",a),a.type==="unavailable-id"&&t){console.warn("Peer ID already taken - generating new code and retrying..."),xe.peer&&(xe.peer.destroy(),xe.isInitialized=!1),setTimeout(()=>{const r=rn();console.log(`Retrying with new invite code: ${r}`),xi(r,t).then(o).catch(s)},1e3);return}a.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):a.type==="peer-unavailable"?console.warn("Host not found - check invite code"):a.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),xe.isInitialized||s(new Error(`Multiplayer unavailable: ${a.type||"connection failed"}`))}),t&&xe.peer.on("connection",a=>{console.log("Incoming connection from:",a.peer),Ap(a)})}catch(a){console.error("Failed to create peer:",a),s(a)}})}function Ap(e){xe.isHost&&(e.on("open",()=>{console.log("Connection opened with:",e.peer),xe.connections.set(e.peer,e),xe.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{tl(t,e.peer)}),e.on("close",()=>{console.log("Connection closed with:",e.peer),xe.connections.delete(e.peer),xe.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function el(e){return new Promise((t,o)=>{if(xe.isHost){o(new Error("Host cannot connect to another host"));return}if(!xe.isInitialized){o(new Error("Network not initialized"));return}const s=`smash-${e}`;console.log("[NetworkSystem] Attempting to connect to host:",s),console.log("[NetworkSystem] Using STUN/TURN servers for NAT traversal...");let i,a=!1;const r=xe.peer.connect(s,{reliable:!0});i=setTimeout(()=>{a||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),r.close(),o(new Error("Connection timeout - could not reach host")))},3e4),r.on("open",()=>{a=!0,clearTimeout(i),console.log("[NetworkSystem] Successfully connected to host!"),xe.hostConnection=r,xe.hostId=s,t()}),r.on("data",h=>{tl(h,s)}),r.on("close",()=>{console.log("[NetworkSystem] Disconnected from host"),xe.hostConnection=null,xe.hostId=null,xe.connectionCallbacks.forEach(h=>h("host_disconnect"))}),r.on("error",h=>{a=!0,clearTimeout(i),console.error("[NetworkSystem] Connection error:",h),console.error("[NetworkSystem] Error type:",h.type||"unknown"),o(h)})})}function tl(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const o=xe.messageHandlers.get(e.type);o?o(e.payload,t):console.warn("No handler for message type:",e.type)}function ft(e,t){xe.messageHandlers.set(e,t)}function zn(e){xe.connectionCallbacks.includes(e)||xe.connectionCallbacks.push(e)}function yi(e,t){if(xe.isHost){console.warn("Host cannot send to itself");return}if(!xe.hostConnection){console.warn("Not connected to host");return}xe.hostConnection.send({type:e,payload:t})}function oi(e,t,o){if(!xe.isHost){console.warn("Only host can send to specific peers");return}const s=xe.connections.get(e);s?s.send({type:t,payload:o}):console.warn("No connection to peer:",e)}function mo(e,t,o=[]){if(!xe.isHost){console.warn("Only host can broadcast");return}xe.connections.forEach((s,i)=>{o.includes(i)||s.send({type:e,payload:t})})}function ol(){xe.isHost?(xe.connections.forEach(e=>e.close()),xe.connections.clear()):xe.hostConnection&&(xe.hostConnection.close(),xe.hostConnection=null,xe.hostId=null),xe.peer&&(xe.peer.destroy(),xe.peer=null),xe.messageHandlers.clear(),xe.connectionCallbacks=[],xe.isInitialized=!1,xe.peerId=null}function sl(){return{isInitialized:xe.isInitialized,isHost:xe.isHost,peerId:xe.peerId,hostId:xe.hostId,connectedPeers:Array.from(xe.connections.keys()),peerCount:xe.connections.size}}const vp=Object.freeze(Object.defineProperty({__proto__:null,broadcast:mo,connectToHost:el,disconnect:ol,getNetworkInfo:sl,initNetwork:xi,onConnectionChange:zn,onMessage:ft,sendToHost:yi,sendToPeer:oi},Symbol.toStringTag,{value:"Module"})),we={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!0,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null};async function Ep(e=null){if(e&&(we.kaplayInstance=e),we.slots[0].playerName=Ln(),we.slots[0].inviteCode=$o(),we.slots[0].selectedCharacter=Is(),!we.networkInitialized)try{console.log("[PartySystem] Initializing network as host...");const t=$o(),o=await xi(t,!0);o!==t&&(console.log(`[PartySystem] Invite code changed: ${t} -> ${o}`),mp(o),we.slots[0].inviteCode=o),we.networkInitialized=!0,we.isHost=!0,Mp(),console.log("[PartySystem] Network initialized as host - ready to accept connections")}catch(t){console.error("[PartySystem] Failed to initialize network as host:",t),console.log("[PartySystem] Multiplayer disabled - running in single-player mode")}}function Mp(){ft("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const o=Sp(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",t);o!==null?(oi(t,"party_sync",{slots:we.slots.map(s=>({playerId:s.playerId,playerName:s.playerName,inviteCode:s.inviteCode,selectedCharacter:s.selectedCharacter,isLocal:!1})),yourSlotIndex:o}),setTimeout(()=>{dl(t)},100),As()):oi(t,"join_rejected",{reason:"Party full"})}),ft("player_info",(e,t)=>{const o=we.peerIdToSlot.get(t);o!==void 0&&(e.playerName&&(we.slots[o].playerName=e.playerName),As())}),ft("character_change",(e,t)=>{const o=we.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} changed character to:`,e.selectedCharacter),we.slots[o].selectedCharacter=e.selectedCharacter,As())}),zn((e,t)=>{e==="leave"&&Cp(t)})}function il(){return we}function nl(){return we.slots.filter(e=>e.playerId!==null).length}function Sp(e,t,o,s){for(let i=1;i<we.slots.length;i++)if(we.slots[i].playerId===null)return we.slots[i].playerId=`player_${Date.now()}_${i}`,we.slots[i].playerName=e,we.slots[i].inviteCode=t,we.slots[i].selectedCharacter=o,we.slots[i].peerId=s,we.peerIdToSlot.set(s,i),i;return null}async function Rp(e){try{if(we.networkInitialized&&we.isHost){console.log("[PartySystem] Switching from host to client - disconnecting current peer...");const{disconnect:t}=await mi(async()=>{const{disconnect:o}=await Promise.resolve().then(()=>vp);return{disconnect:o}},void 0);t(),we.networkInitialized=!1,we.isHost=!1;for(let o=0;o<we.slots.length;o++)we.slots[o]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null}}return we.networkInitialized||(await xi("client",!1),we.networkInitialized=!0,we.isHost=!1),Dp(),await el(e),yi("join_request",{playerName:Ln(),inviteCode:$o(),selectedCharacter:Is()}),!0}catch(t){return console.error("Failed to join party:",t),!1}}function Dp(){ft("party_sync",e=>{console.log("Received party sync:",e),we.slots=e.slots,e.yourSlotIndex!==void 0&&(we.slots[e.yourSlotIndex].isLocal=!0),we.slots[0].isLocal=!1}),ft("party_update",e=>{console.log("Received party update:",e),we.slots=e.slots}),ft("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),ft("game_start",e=>{console.log("Host started game - joining..."),we.kaplayInstance?we.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),zn(e=>{e==="host_disconnect"&&(alert("Host disconnected"),Ip())})}function As(){we.isHost&&mo("party_update",{slots:we.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,isLocal:!1}))})}function Tp(){we.isHost&&(console.log("Broadcasting game start to all clients"),mo("game_start",{}))}function Cp(e){const t=we.peerIdToSlot.get(e);t!==void 0&&(console.log("Player disconnected from slot",t),al(t),we.peerIdToSlot.delete(e),As())}function al(e){if(e>0&&e<we.slots.length){const t=we.slots[e].peerId;return t&&we.peerIdToSlot.delete(t),we.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},!0}return!1}function Ip(){for(let e=1;e<we.slots.length;e++)al(e)}function Pp(){return we.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter||"survivor"}))}function Bp(e){we.slots[0].selectedCharacter=e,we.networkInitialized&&(we.isHost?As():yi("character_change",{selectedCharacter:e}))}const To={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function Op(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const s=1+(t-1)*.1;for(const[i,a]of Object.entries(To)){const r=a.dropChance*s;if(Math.random()<r)return i}return null}function Lp(e,t){const o=To[t];if(!o)return;const s=hn[o.weaponKey];s&&(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=o.weaponKey,e.weaponDef=s,e.fireRate=s.fireRate,e.projectileSpeed=s.projectileSpeed,e.projectileDamage=s.baseDamage,e.projectileCount=s.projectileCount,e.piercing=s.piercing,e.obstaclePiercing=s.obstaclePiercing,e.critChance=s.critChance,e.critDamage=s.critDamage,e.spreadAngle=s.spreadAngle,e.weaponRange=s.range,e.weaponCategory=s.category,s.orbitRadius&&(e.orbitRadius=s.orbitRadius,e.rotationSpeed=s.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),s.explosionRadius&&(e.explosionRadius=s.explosionRadius,e.explosionDamage=s.explosionDamage),s.chainRange&&(e.chainRange=s.chainRange,e.maxJumps=s.maxJumps,e.chainDamageReduction=s.chainDamageReduction),o.isAmmoBased?(e.powerupAmmo=o.ammo,e.powerupDuration=null):o.isTimeBased&&(e.powerupDuration=o.duration,e.powerupAmmo=null))}function pa(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function zp(e,t=0){if(!e.powerupWeapon)return!1;const o=To[e.powerupWeapon];return o&&(o.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||o.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(pa(e),!0):!1}function Np(e){if(!e.powerupWeapon)return;const t=To[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function Hp(e){if(!e.powerupWeapon)return null;const t=To[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function gs(e,t,o,s){const i=e.add([e.text("+",{size:16}),e.pos(t,o),e.anchor("center"),e.color(...je.XP_COLOR),e.area(),"xpPickup"]);return i.value=s,i.lifetime=je.XP_LIFETIME,i.age=0,i.collected=!1,i.magnetizing=!1,i.magnetizeSpeed=0,i.targetPlayer=null,i.velocityY=-150-Math.random()*100,i.gravity=600,i.groundY=o,i.bounceDamping=.5,i.bouncing=!0,i.onUpdate(()=>{if(e.paused){const r=Math.sin(i.age*je.XP_PULSE_SPEED)*je.XP_PULSE_AMOUNT;i.scale=e.vec2(1+r);return}i.age+=e.dt();const a=Math.sin(i.age*je.XP_PULSE_SPEED)*je.XP_PULSE_AMOUNT;if(i.scale=e.vec2(1+a),!i.magnetizing&&i.bouncing&&(i.velocityY+=i.gravity*e.dt(),i.pos.y+=i.velocityY*e.dt(),i.pos.y>=i.groundY&&(i.pos.y=i.groundY,i.velocityY=-i.velocityY*i.bounceDamping,Math.abs(i.velocityY)<20&&(i.bouncing=!1,i.velocityY=0))),i.magnetizing&&i.targetPlayer&&i.targetPlayer.exists()){i.bouncing=!1;const r=e.vec2(i.targetPlayer.pos.x-i.pos.x,i.targetPlayer.pos.y-i.pos.y),h=r.len();if(h>0){const l=r.scale(1/h);i.magnetizeSpeed=Math.min(i.magnetizeSpeed+je.MAGNETIZE_ACCELERATION*e.dt(),je.MAGNETIZE_SPEED),i.pos=i.pos.add(l.scale(i.magnetizeSpeed*e.dt()))}}i.age>=i.lifetime&&e.destroy(i)}),i.pickupType="xp",pt()&&Jt()&&wi(i,{type:"xpPickup",value:s}),i}const fa=["$","","","","","","",""];function rl(){return fa[Math.floor(Math.random()*fa.length)]}function ms(e,t,o,s,i=null){const a=i||rl(),r=e.add([e.text(a,{size:9}),e.pos(t,o),e.anchor("center"),e.color(...je.CURRENCY_COLOR),e.area(),"currencyPickup"]);return r.value=s,r.lifetime=je.CURRENCY_LIFETIME,r.age=0,r.collected=!1,r.magnetizing=!1,r.magnetizeSpeed=0,r.targetPlayer=null,r.velocityY=-150-Math.random()*100,r.gravity=600,r.groundY=o,r.bounceDamping=.5,r.bouncing=!0,r.onUpdate(()=>{if(e.paused){const l=Math.sin(r.age*je.CURRENCY_PULSE_SPEED)*je.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+l);return}r.age+=e.dt();const h=Math.sin(r.age*je.CURRENCY_PULSE_SPEED)*je.CURRENCY_PULSE_AMOUNT;if(r.scale=e.vec2(1+h),!r.magnetizing&&r.bouncing&&(r.velocityY+=r.gravity*e.dt(),r.pos.y+=r.velocityY*e.dt(),r.pos.y>=r.groundY&&(r.pos.y=r.groundY,r.velocityY=-r.velocityY*r.bounceDamping,Math.abs(r.velocityY)<20&&(r.bouncing=!1,r.velocityY=0))),r.magnetizing&&r.targetPlayer&&r.targetPlayer.exists()){r.bouncing=!1;const l=e.vec2(r.targetPlayer.pos.x-r.pos.x,r.targetPlayer.pos.y-r.pos.y),n=l.len();if(n>0){const c=l.scale(1/n);r.magnetizeSpeed=Math.min(r.magnetizeSpeed+je.MAGNETIZE_ACCELERATION*e.dt(),je.MAGNETIZE_SPEED),r.pos=r.pos.add(c.scale(r.magnetizeSpeed*e.dt()))}}r.age>=r.lifetime&&e.destroy(r)}),r.pickupType="currency",pt()&&Jt()&&wi(r,{type:"currencyPickup",value:s,icon:a}),r}function ga(e,t,o,s){const i=To[s];if(!i)return null;const a=e.add([e.text(i.icon,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...i.color),e.area(),"powerupWeaponPickup"]);return a.powerupKey=s,a.lifetime=je.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.velocityY=-150-Math.random()*100,a.gravity=600,a.groundY=o,a.bounceDamping=.5,a.bouncing=!0,a.onUpdate(()=>{if(e.paused){const h=Math.sin(a.age*4)*.15;a.scale=e.vec2(1+h),a.angle=Math.sin(a.age*2)*10;return}a.age+=e.dt();const r=Math.sin(a.age*4)*.15;if(a.scale=e.vec2(1+r),a.angle=Math.sin(a.age*2)*10,!a.magnetizing&&a.bouncing&&(a.velocityY+=a.gravity*e.dt(),a.pos.y+=a.velocityY*e.dt(),a.pos.y>=a.groundY&&(a.pos.y=a.groundY,a.velocityY=-a.velocityY*a.bounceDamping,Math.abs(a.velocityY)<20&&(a.bouncing=!1,a.velocityY=0))),a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){a.bouncing=!1;const h=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),l=h.len();if(l>0){const n=h.scale(1/l);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+je.MAGNETIZE_ACCELERATION*e.dt(),je.MAGNETIZE_SPEED),a.pos=a.pos.add(n.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="powerup",pt()&&Jt()&&wi(a),a}class Ps{constructor(t){this.seed=t>>>0,this.originalSeed=this.seed}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}range(t,o){return o<=t?(console.warn(`SeededRandom.range: Invalid range [${t}, ${o}). Returning min.`),t):Math.floor(t+this.next()*(o-t))}rangeFloat(t,o){return t+this.next()*(o-t)}choose(t){if(!(!t||t.length===0))return t[this.range(0,t.length)]}shuffle(t){const o=[...t];for(let s=o.length-1;s>0;s--){const i=this.range(0,s+1);[o[s],o[i]]=[o[i],o[s]]}return o}probability(t){return this.next()<t}reset(){this.seed=this.originalSeed}getState(){return this.seed}setState(t){this.seed=t>>>0}}function Nn(...e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e[o]|0;return t>>>0}const U={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/20,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null,gameSeed:0,floorRng:null,currentFloor:1,currentRoom:{x:0,y:0}};function ll(e,t=0,o=null,s=null){U.isActive=!0,U.isHost=e,U.localPlayerSlot=t,U.players.clear(),U.inputBuffer=[],U.lastSyncTime=0,U.k=o,U.enemies.clear(),U.projectiles.clear(),U.pickups.clear(),U.nextEntityId=1,s!==null?U.gameSeed=s:e&&(U.gameSeed=Math.floor(Math.random()*4294967295),console.log(`[Multiplayer] Generated game seed: ${U.gameSeed}`)),U.floorRng=new Ps(U.gameSeed),U.currentFloor=1,U.currentRoom={x:0,y:0},console.log(`Multiplayer initialized - isHost: ${e}, localSlot: ${t}, seed: ${U.gameSeed}`),e?Up():_p()}function Up(){ft("player_input",(e,t)=>{const s=il().slots.findIndex(i=>i.peerId===t);if(s!==-1&&U.players.has(s)){const i=U.players.get(s);e.move&&(i.move=e.move),e.shoot&&(i.isShooting=e.shoot),e.aimAngle!==void 0&&(i.aimAngle=e.aimAngle)}})}function _p(){ft("game_state",e=>{if(U.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==U.localPlayerSlot){const o=U.players.get(t.slotIndex);o&&o.exists()&&(o.pos.x=t.x,o.pos.y=t.y,o.angle=t.angle||0,t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.weapons&&(o.weapons=t.weapons),t.passiveUpgrades&&(o.passiveUpgrades=t.passiveUpgrades),t.upgradeStacks&&(o.upgradeStacks=t.upgradeStacks),t.speed!==void 0&&(o.speed=t.speed),t.damage!==void 0&&(o.damage=t.damage),t.pickupRadius!==void 0&&(o.pickupRadius=t.pickupRadius))}}),e.enemies){const t=new Set;e.enemies.forEach(o=>{t.add(o.id);const s=U.enemies.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y,s.setHP&&o.hp!==void 0&&s.setHP(o.hp))}),U.enemies.forEach((o,s)=>{!t.has(s)&&o.exists()&&(U.k.destroy(o),U.enemies.delete(s))})}if(e.projectiles){const t=new Set;e.projectiles.forEach(o=>{t.add(o.id);const s=U.projectiles.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y,s.angle=o.angle||0)}),U.projectiles.forEach((o,s)=>{!t.has(s)&&o.exists()&&(U.k.destroy(o),U.projectiles.delete(s))})}if(e.pickups){const t=new Set;e.pickups.forEach(o=>{t.add(o.id);const s=U.pickups.get(o.id);s&&s.exists()&&(s.pos.x=o.x,s.pos.y=o.y)}),U.pickups.forEach((o,s)=>{!t.has(s)&&o.exists()&&(U.k.destroy(o),U.pickups.delete(s))})}}}),ft("spawn_entity",e=>{if(U.k){if(e.entityType==="enemy"){const t=So(U.k,e.x,e.y,e.type,e.floor);t.mpEntityId=e.id,U.enemies.set(e.id,t),console.log(`Spawned enemy ${e.id} (${e.type}) at (${e.x}, ${e.y})`)}else if(e.entityType==="xpPickup"){const t=gs(U.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",U.pickups.set(e.id,t),console.log(`Spawned XP pickup ${e.id} with value ${e.value}`)}else if(e.entityType==="currencyPickup"){const t=ms(U.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",U.pickups.set(e.id,t),console.log(`Spawned currency pickup ${e.id} with value ${e.value}`)}}}),ft("spawn_projectile",e=>{U.k&&mi(async()=>{const{createProjectile:t}=await Promise.resolve().then(()=>Gp);return{createProjectile:t}},void 0).then(({createProjectile:t})=>{const o=U.k.vec2(e.directionX,e.directionY),s=t(U.k,e.x,e.y,o,e.speed,e.damage,e.piercing,e.obstaclePiercing,e.isCrit,e.maxRange);(e.char||e.color)&&(s.text=e.char,e.color&&(s.color=U.k.rgb(...e.color))),s.mpEntityId=e.id,U.projectiles.set(e.id,s),console.log(`Spawned projectile ${e.id} at (${e.x}, ${e.y})`)})}),ft("damage_dealt",e=>{if(!U.k)return;const t=U.k.add([U.k.text(e.damage.toString(),{size:e.isCrit?24:18}),U.k.pos(e.x,e.y),U.k.anchor("center"),U.k.color((e.isCrit,255),e.isCrit?200:255,e.isCrit?0:255),U.k.lifespan(.8),U.k.z(1e3)]);t.onUpdate(()=>{t.pos.y-=50*U.k.dt(),t.opacity-=1.25*U.k.dt()});const o=U.enemies.get(e.targetId)||U.players.get(e.targetId);if(o&&o.exists()){const s=o.color;o.color=U.k.rgb(255,255,255),U.k.wait(.1,()=>{o.exists()&&(o.color=s)})}console.log(`Damage: ${e.damage}${e.isCrit?" CRIT!":""} to ${e.targetType} ${e.targetId}`)}),ft("entity_destroyed",e=>{if(!U.k)return;console.log(`Entity destroyed: ${e.entityType} ${e.entityId} at (${e.x}, ${e.y})`);const t=U.enemies.get(e.entityId)||U.players.get(e.entityId);t&&t.exists()&&(t.onDeath&&typeof t.onDeath=="function"&&t.onDeath(),U.k.destroy(t)),U.enemies.delete(e.entityId),U.projectiles.delete(e.entityId),U.pickups.delete(e.entityId)}),ft("players_revived",e=>{U.k&&(console.log("[Multiplayer] Received player revival event - reviving all dead players"),U.players.forEach((t,o)=>{if(t&&t.exists()&&(t.hp()<=0||t.isDead)){t.setHP(t.maxHealth),t.isDead=!1,t.isRemote||(t.canMove=!0,t.canShoot=!0);const s=U.k.add([U.k.text(" REVIVED ",{size:16}),U.k.pos(t.pos.x,t.pos.y-40),U.k.anchor("center"),U.k.color(100,255,100),U.k.lifespan(2),U.k.z(1e3)]);s.onUpdate(()=>{s.pos.y-=30*U.k.dt(),s.opacity-=.5*U.k.dt()}),t.opacity=1,t.characterData&&(t.color=U.k.rgb(...t.characterData.color)),t.outline&&t.outline.exists()&&(t.outline.opacity=1),console.log(`[Revival] Client: Player slot ${o} revived`)}}))}),ft("game_seed",e=>{console.log(`[Multiplayer] Received game seed from host: ${e.seed}`),U.gameSeed=e.seed,U.floorRng=new Ps(U.gameSeed),console.log("[Multiplayer] Synchronized RNG with host")})}function dn(e,t){U.players.set(e,t),t.mpSlotIndex=e,console.log(`Registered player for slot ${e}`)}function cl(e){U.isActive&&(U.lastSyncTime+=e,U.isHost?U.lastSyncTime>=U.syncInterval&&(qp(),U.lastSyncTime=0):U.lastSyncTime>=U.syncInterval&&(Fp(),U.lastSyncTime=0))}function hl(){const e=[],t=[],o=[],s=[];return U.players.forEach((i,a)=>{i.exists()&&e.push({slotIndex:Number(a),x:Number(i.pos.x),y:Number(i.pos.y),angle:Number(i.angle||0),hp:Number(i.hp||i.maxHealth),level:Number(i.level||1),xp:Number(i.xp||0),weapons:i.weapons||[],passiveUpgrades:i.passiveUpgrades||[],upgradeStacks:i.upgradeStacks||{},speed:Number(i.speed||0),damage:Number(i.damage||0),pickupRadius:Number(i.pickupRadius||0)})}),U.enemies.forEach((i,a)=>{i.exists()?t.push({id:Number(a),x:Number(i.pos.x),y:Number(i.pos.y),hp:Number(i.hp||0),type:String(i.enemyType||"basic")}):U.enemies.delete(a)}),U.projectiles.forEach((i,a)=>{i.exists()?o.push({id:Number(a),x:Number(i.pos.x),y:Number(i.pos.y),angle:Number(i.angle||0)}):U.projectiles.delete(a)}),U.pickups.forEach((i,a)=>{i.exists()?s.push({id:Number(a),x:Number(i.pos.x),y:Number(i.pos.y),type:String(i.pickupType||"xp")}):U.pickups.delete(a)}),{players:e,enemies:t,projectiles:o,pickups:s}}function qp(){U.isHost&&mo("game_state",hl())}function dl(e){!U.isHost||!U.isActive||(console.log("Sending initial game state to new joiner:",e),oi(e,"game_state",hl()))}function Fp(){if(U.isHost)return;const e=U.players.get(U.localPlayerSlot);!e||!e.exists()||yi("player_input",{slotIndex:U.localPlayerSlot,move:e.move||{x:0,y:0},shoot:e.isShooting||!1,aimAngle:e.aimAngle||0})}function pt(){return U.isActive}function ul(){return U.players.size}function un(){U.isActive=!1,U.players.clear(),U.inputBuffer=[],U.enemies.clear(),U.projectiles.clear(),U.pickups.clear(),U.nextEntityId=1,console.log("Multiplayer session cleaned up")}function pl(e,t={}){if(!U.isHost)return null;const o=U.nextEntityId++;return e.mpEntityId=o,U.enemies.set(o,e),mo("spawn_entity",{id:o,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1}),o}function fl(e,t={}){if(!U.isHost)return null;const o=U.nextEntityId++;return e.mpEntityId=o,U.projectiles.set(o,e),mo("spawn_projectile",{id:Number(o),x:Number(e.pos.x),y:Number(e.pos.y),directionX:Number(e.direction.x),directionY:Number(e.direction.y),speed:Number(e.speed),damage:Number(e.damage),piercing:Number(e.piercing||0),obstaclePiercing:Number(e.obstaclePiercing||0),isCrit:!!e.isCrit,maxRange:Number(e.maxRange),angle:Number(e.angle||0),char:t.char||"*",color:t.color||[255,255,100]}),o}function wi(e,t={}){if(!U.isHost)return null;const o=U.nextEntityId++;e.mpEntityId=o,U.pickups.set(o,e);const s={id:o,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(s.icon=t.icon),mo("spawn_entity",s),o}function Jt(){return U.isHost}function gl(e){!U.isHost||!U.isActive||mo("damage_dealt",{targetId:Number(e.targetId),targetType:String(e.targetType),damage:Number(e.damage),isCrit:!!e.isCrit,attackerId:e.attackerId!==void 0?Number(e.attackerId):null,x:Number(e.x),y:Number(e.y)})}function Yp(){!U.isHost||!U.isActive||(mo("players_revived",{timestamp:Date.now()}),console.log("[Multiplayer] Broadcasted player revival event"))}function ml(e){U.currentFloor=e;const t=Nn(U.gameSeed,e);U.floorRng=new Ps(t),console.log(`[Multiplayer] Set floor ${e}, seed: ${t}`)}function Ao(){const e=Nn(U.gameSeed,U.currentFloor,U.currentRoom.x,U.currentRoom.y);return new Ps(e)}function xl(){return U.floorRng}function yl(e,t){const o=Nn(U.gameSeed,e,t);return new Ps(o)}const Xp=Object.freeze(Object.defineProperty({__proto__:null,broadcastDamageEvent:gl,broadcastRevivalEvent:Yp,cleanupMultiplayer:un,getFloorRNG:xl,getPlayerCount:ul,getRoomRNG:Ao,getUpgradeRNG:yl,initMultiplayerGame:ll,isHost:Jt,isMultiplayerActive:pt,registerEnemy:pl,registerPickup:wi,registerPlayer:dn,registerProjectile:fl,sendInitialGameState:dl,setCurrentFloor:ml,updateMultiplayer:cl},Symbol.toStringTag,{value:"Module"}));function Qt(e,t,o,s,i,a,r=0,h=0,l=!1,n=null){const c=Math.atan2(s.y,s.x)*(180/Math.PI)+90,u=e.add([e.text("*",{size:16}),e.pos(t,o),e.anchor("center"),e.color(255,l?200:255,l?0:100),e.rotate(c),e.area(),"projectile"]);return u.damage=a,u.piercing=r,u.obstaclePiercing=h,u.piercedEnemies=new Set,u.piercedObstacles=new Set,u.isCrit=l,u.maxRange=n||Jo.DEFAULT_WEAPON_RANGE,u.distanceTraveled=0,u.direction=s,u.speed=i,u.useWeaponVisual=function(d){d&&d.char&&(u.text=d.char),d&&d.color&&(u.isCrit||(u.color=e.rgb(...d.color))),d&&d.range&&(u.maxRange=d.range)},u.onUpdate(()=>{if(e.paused)return;const d=u.direction.scale(u.speed*e.dt()),x=d.len();if(u.distanceTraveled+=x,u.pos.x+=d.x,u.pos.y+=d.y,u.distanceTraveled>=u.maxRange){e.destroy(u);return}(u.pos.x<0||u.pos.x>e.width()||u.pos.y<0||u.pos.y>e.height())&&e.destroy(u)}),pt()&&Jt()&&fl(u),u}const Gp=Object.freeze(Object.defineProperty({__proto__:null,createProjectile:Qt},Symbol.toStringTag,{value:"Module"})),ma={rusher:{char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.8,projectileSpeed:200,projectileDamage:7},zombie:{char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},mage:{char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},healer:{char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},basic:{char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function Vp(e){return ma[e]||ma.basic}const io=32,Kp=100;class jp{constructor(){this.elements=[]}enqueue(t,o){this.elements.push({element:t,priority:o}),this.elements.sort((s,i)=>s.priority-i.priority)}dequeue(){var t;return(t=this.elements.shift())==null?void 0:t.element}isEmpty(){return this.elements.length===0}}function xa(e,t){return{gx:Math.floor(e/io),gy:Math.floor(t/io)}}function wl(e,t){return{x:e*io+io/2,y:t*io+io/2}}function Li(e,t,o,s,i){if(t<0||o<0||t>=s||o>=i)return!1;const a=wl(t,o),r=e.get("obstacle");for(const h of r){if(!h.exists())continue;const l=io/2,n=a.x-l,c=a.x+l,u=a.y-l,d=a.y+l,x=h.pos.x-h.width/2,f=h.pos.x+h.width/2,A=h.pos.y-h.height/2,g=h.pos.y+h.height/2;if(c>x&&n<f&&d>A&&u<g)return!1}return!0}function Wp(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function $p(e,t,o,s,i){const a=e.width(),r=e.height(),h=Math.ceil(a/io),l=Math.ceil(r/io),n=xa(t,o),c=xa(s,i);if(!Li(e,n.gx,n.gy,h,l)||!Li(e,c.gx,c.gy,h,l))return[];const u=new jp;u.enqueue(n,0);const d=new Map,x=new Map,f=R=>`${R.gx},${R.gy}`;d.set(f(n),null),x.set(f(n),0);let A=0;const g=h*l;for(;!u.isEmpty()&&A<g;){A++;const R=u.dequeue();if(R.gx===c.gx&&R.gy===c.gy)break;const X=[{gx:R.gx+1,gy:R.gy},{gx:R.gx-1,gy:R.gy},{gx:R.gx,gy:R.gy+1},{gx:R.gx,gy:R.gy-1},{gx:R.gx+1,gy:R.gy+1},{gx:R.gx+1,gy:R.gy-1},{gx:R.gx-1,gy:R.gy+1},{gx:R.gx-1,gy:R.gy-1}];for(const _ of X){if(!Li(e,_.gx,_.gy,h,l))continue;const y=_.gx!==R.gx&&_.gy!==R.gy?1.4:1,b=x.get(f(R))+y,E=f(_);if(!x.has(E)||b<x.get(E)){x.set(E,b);const T=b+Wp(_,c);u.enqueue(_,T),d.set(E,R)}}}const w=[];let D=c;for(;D&&d.has(f(D));){const R=wl(D.gx,D.gy);if(w.unshift(R),D=d.get(f(D)),w.length>Kp)break}return w}function Jp(e,t,o,s){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=$p(e,t.pos.x,t.pos.y,o,s),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const r=t.pathfindingPath[t.pathfindingWaypointIndex];if(r){const h=e.vec2(r.x-t.pos.x,r.y-t.pos.y),l=h.len();if(l<io/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),l>0)return h.unit()}}const i=e.vec2(o-t.pos.x,s-t.pos.y);return i.len()>0?i.unit():e.vec2(0,0)}function Qp(e,t){const o=e.width(),s=e.height(),i=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:i});const a=t.perimeterMode;t.speed*e.dt();const r=20,h=e.vec2(a.targetX-t.pos.x,a.targetY-t.pos.y),l=h.len();if(l<r)switch(a.side){case"top":a.side="right",a.targetX=o-i,a.targetY=i;break;case"right":a.side="bottom",a.targetX=o-i,a.targetY=s-i;break;case"bottom":a.side="left",a.targetX=i,a.targetY=s-i;break;case"left":a.side="top",a.targetX=i,a.targetY=i;break}return l>0?h.unit():e.vec2(0,0)}function So(e,t,o,s="basic",i=1){const a=Vp(s),r=1+(i-1)*.3,h={char:a.char,color:a.color,health:Math.floor(a.baseHealth*r),speed:Math.floor(a.baseSpeed*(1+(i-1)*.1)),size:a.size,xpValue:Math.floor(a.baseXPValue*r),behavior:a.behavior};function l(){return h.char}const n=e.add([e.text(l(),{size:h.size}),e.pos(t,o),e.anchor("center"),e.color(...h.color),e.area(),e.health(h.health),"enemy"]);n.originalColor=h.color,n.maxHealth=h.health,n.speed=h.speed,n.xpValue=h.xpValue,n.type=s,n.behavior=h.behavior,n.floor=i,n.pathfindingMode=a.pathfindingMode||"none",a.damage&&(n.damage=a.damage),a.fireRate&&(n.fireRate=a.fireRate),a.projectileSpeed&&(n.projectileSpeed=a.projectileSpeed),a.projectileDamage&&(n.projectileDamage=a.projectileDamage),a.chargeCooldown&&(n.chargeCooldown=a.chargeCooldown),a.splits&&(n.splits=!0),a.explodes&&(n.explodes=!0,n.explosionDamage=a.explosionDamage,n.explosionRadius=a.explosionRadius,a.shrapnel&&(n.shrapnel=!0,n.shrapnelCount=a.shrapnelCount||8));let c=0,u=0,d=0;i>=2&&i>=2&&(s==="zombie"||s==="turret"||s==="heavyTank"||Math.random()<.3)&&(c=Math.floor(15+(i-2)*5)),i>=3&&(s==="shooter"||s==="turret"||s==="wraith"||Math.random()<.2)&&(u=Math.floor(10+(i-3)*5),d=1+(i-3)*.5),i>=4&&(s==="heavyTank"||s==="spawner"||Math.random()<.1)&&(c===0&&(c=Math.floor(20+(i-4)*5)),u===0&&(u=Math.floor(15+(i-4)*5),d=1.5+(i-4)*.5));const x=(a.baseArmorHealth||0)+c;n.armorHealth=Math.floor(x*r),n.maxArmorHealth=Math.floor(x*r),n.damageReduction=a.damageReduction||(x>0?.2:0),n.armorChar=a.armorChar||"[]",n.armorColor=a.armorColor||[200,200,200];const f=(a.baseShieldHealth||0)+u;n.shieldHealth=Math.floor(f*r),n.maxShieldHealth=Math.floor(f*r),n.shieldRegenRate=((a.shieldRegenRate||0)+d)*r,n.shieldChar=a.shieldChar||"{}",n.shieldColor=a.shieldColor||[100,200,255],n.shieldRegenTimer=0,n.shieldRegenCooldown=0,n.lastDamageTime=0,n.originalColor=h.color,n.coreChar=h.char,n.updateVisual=function(){let p="",y="",b="",E="";if(n.shieldHealth>0){const C=n.shieldHealth/n.maxShieldHealth;C>.66?(p="",y=""):C>.33?(p="",y=""):(p="",y="")}if(n.armorHealth>0){const C=n.armorHealth/n.maxArmorHealth;C>.66?(b="",E=""):C>.33?(b="",E=""):(b="",E="")}const T=`${p}${b}${n.coreChar}${E}${y}`;n.text=T,n.shieldHealth>0?n.color=e.rgb(...n.shieldColor):n.color=e.rgb(...n.originalColor)},n.takeDamage=function(p){let y=!1,b=!1;const E=n.shieldHealth,T=n.armorHealth;n.lastDamageTime=e.time();const C=3;if(n.shieldRegenCooldown=C,n.shieldHealth>0){const N=Math.min(p,n.shieldHealth);n.shieldHealth=Math.max(0,n.shieldHealth-N),y=n.shieldHealth!==E;const B=p-N;B>0&&n.takeDamageInternal(B)}else n.takeDamageInternal(p);b=n.armorHealth!==T,(y||b)&&n.updateVisual()},n.takeDamageInternal=function(p){if(n.armorHealth>0){const y=Math.floor(p*(1-n.damageReduction)),b=Math.min(y,n.armorHealth);n.armorHealth=Math.max(0,n.armorHealth-b);const E=p-y;if(E>0){const T=n.armorHealth>0?1-n.damageReduction:1,C=Math.floor(E*T);n.hurt(C)}}else n.hurt(p)},a.blocksProjectiles&&(n.blocksProjectiles=!0),a.teleportCooldown&&(n.teleportCooldown=a.teleportCooldown),a.teleportRange&&(n.teleportRange=a.teleportRange),a.spawnInterval&&(n.spawnInterval=a.spawnInterval),a.spawnType&&(n.spawnType=a.spawnType),a.buffRadius&&(n.buffRadius=a.buffRadius),a.buffAmount&&(n.buffAmount=a.buffAmount),a.healRadius&&(n.healRadius=a.healRadius),a.healAmount&&(n.healAmount=a.healAmount),a.healInterval&&(n.healInterval=a.healInterval),a.slowRadius&&(n.slowRadius=a.slowRadius),a.slowAmount&&(n.slowAmount=a.slowAmount),a.lifesteal&&(n.lifesteal=a.lifesteal),n.updateVisual(),n.attackTimer=0,n.chargeTimer=0,n.isCharging=!1,n.chargeDirection=null,n.chargeDuration=0,n.chargePauseTimer=0,n.teleportTimer=0,n.spawnTimer=0,n.healTimer=0,n.buffedEnemies=new Set,n.stuckTimer=0,n.stuckThreshold=1,n.lastPosition={x:t,y:o},n.lastPositionUpdateTime=0,n.avoidanceDirection=null,n.avoidanceTimer=0;const A=30,g=3,w=-20,D=e.add([e.rect(A,g),e.pos(t,o+w),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),R=e.add([e.rect(A,g),e.pos(t,o+w),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);n.healthBarBg=D,n.healthBar=R,n.showHealthThreshold=.5,D.hidden=!0,R.hidden=!0,n.onUpdate(()=>{if(n.exists()&&n.healthBar&&n.healthBarBg){const p=n.hp()/n.maxHealth;if(p<n.showHealthThreshold&&p>0){n.healthBarBg.hidden=!1,n.healthBar.hidden=!1,n.healthBarBg.pos.x=n.pos.x,n.healthBarBg.pos.y=n.pos.y+w,n.healthBar.pos.x=n.pos.x,n.healthBar.pos.y=n.pos.y+w;const b=A*p;n.healthBar.width=Math.max(1,b),n.healthBar.pos.x=n.pos.x-(A-b)/2}else n.healthBarBg.hidden=!0,n.healthBar.hidden=!0}}),n.cleanupHealthBars=function(){n.healthBarBg&&n.healthBarBg.exists()&&e.destroy(n.healthBarBg),n.healthBar&&n.healthBar.exists()&&e.destroy(n.healthBar)};const X=(p,y)=>{const b=e.get("obstacle"),E=n.size||12;for(const T of b){if(!T.exists())continue;const C=T.pos.x-T.width/2,N=T.pos.x+T.width/2,B=T.pos.y-T.height/2,v=T.pos.y+T.height/2,z=p-E,G=p+E,J=y-E,se=y+E;if(G>C&&z<N&&se>B&&J<v)return!1}return!0},_=p=>{const y=p.len(),b=y>0?p.unit():e.vec2(0,0);n.lastPositionUpdateTime+=e.dt(),n.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(n.pos.x-n.lastPosition.x,2)+Math.pow(n.pos.y-n.lastPosition.y,2))<5?n.stuckTimer+=n.lastPositionUpdateTime:n.stuckTimer=0,n.lastPosition={x:n.pos.x,y:n.pos.y},n.lastPositionUpdateTime=0);const E=n.pos.x+p.x,T=n.pos.y+p.y;if(X(E,T))return n.avoidanceDirection=null,n.avoidanceTimer=0,p;if(n.avoidanceTimer-=e.dt(),n.stuckTimer>=n.stuckThreshold||n.avoidanceTimer<=0){const C=e.vec2(-b.y,b.x),N=e.vec2(b.y,-b.x),B=[C.scale(y),N.scale(y),e.vec2(C.x*.7+b.x*.3,C.y*.7+b.y*.3).unit().scale(y),e.vec2(N.x*.7+b.x*.3,N.y*.7+b.y*.3).unit().scale(y),e.vec2(C.x*.5+b.x*.5,C.y*.5+b.y*.5).unit().scale(y),e.vec2(N.x*.5+b.x*.5,N.y*.5+b.y*.5).unit().scale(y)];for(const v of B){const z=n.pos.x+v.x,G=n.pos.y+v.y;if(X(z,G))return n.avoidanceDirection=e.vec2(v.x,v.y).unit(),n.avoidanceTimer=.8,v}if(n.avoidanceDirection){const v=n.avoidanceDirection.scale(y),z=n.pos.x+v.x,G=n.pos.y+v.y;if(X(z,G))return v}return X(E,n.pos.y)?e.vec2(p.x,0):X(n.pos.x,T)?e.vec2(0,p.y):e.vec2(0,0)}else if(n.avoidanceDirection){const C=n.avoidanceDirection.scale(y),N=n.pos.x+C.x,B=n.pos.y+C.y;if(X(N,B))return C;n.avoidanceDirection=null,n.avoidanceTimer=0}return X(E,n.pos.y)?e.vec2(p.x,0):X(n.pos.x,T)?e.vec2(0,p.y):e.vec2(0,0)};return n.onUpdate(()=>{if(e.paused)return;if(n.shieldRegenRate>0&&n.shieldHealth<n.maxShieldHealth&&n.hp()>0&&!n.isDead&&(n.shieldRegenCooldown>0&&(n.shieldRegenCooldown-=e.dt()),n.shieldRegenCooldown<=0)){n.shieldRegenTimer+=e.dt();const B=1;if(n.shieldRegenTimer>=B){const v=n.shieldRegenRate*B;n.shieldHealth=Math.min(n.maxShieldHealth,n.shieldHealth+v),n.shieldRegenTimer=0,n.shieldHealth>0&&n.updateVisual()}}n.burnDuration>0&&n.hp()>0&&!n.isDead&&(n.burnTimer=(n.burnTimer||0)+e.dt(),n.burnTimer>=.5&&(n.takeDamage?n.takeDamage(n.burnDamage):n.hurt(n.burnDamage),n.color=e.rgb(255,150,50),e.wait(.1,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor))}),n.burnTimer=0),n.burnDuration-=e.dt(),n.burnDuration<=0&&(n.burnDamage=0,n.burnTimer=0));const p=e.get("player")[0];if(!p||!p.exists())return;const y=e.vec2(p.pos.x-n.pos.x,p.pos.y-n.pos.y),b=y.len();if(n.behavior==="turret"){if(n.attackTimer+=e.dt(),b>0&&n.attackTimer>=1/n.fireRate){const B=y.unit(),v=Qt(e,n.pos.x,n.pos.y,B,n.projectileSpeed,n.projectileDamage,0,0,!1);v.isEnemyProjectile=!0,v.color=e.rgb(...n.originalColor),n.attackTimer=0}return}if(n.behavior==="shoot"){n.attackTimer+=e.dt();const B=150;let v=e.vec2(0,0);if(b>B*1.2?v=y.unit().scale(n.speed*e.dt()):b<B*.8&&(v=y.unit().scale(-n.speed*e.dt())),b>0&&n.attackTimer>=1/n.fireRate){const z=y.unit(),G=Qt(e,n.pos.x,n.pos.y,z,n.projectileSpeed,n.projectileDamage,0,0,!1);G.isEnemyProjectile=!0,G.color=e.rgb(...n.originalColor),n.attackTimer=0}if(v.len()>0){const z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="charge"){if(n.chargeTimer+=e.dt(),n.isCharging)if(n.chargeDuration+=e.dt(),n.chargeDuration>=.8)n.isCharging=!1,n.chargeDuration=0,n.chargePauseTimer=0;else{const v=n.chargeDirection.scale(n.speed*e.dt()),z=_(v);z.len()<v.len()*.3?(n.isCharging=!1,n.chargePauseTimer=.1):(n.pos.x+=z.x,n.pos.y+=z.y)}else if(n.chargePauseTimer>0)n.chargePauseTimer+=e.dt(),n.chargePauseTimer>=1&&(n.chargePauseTimer=0,n.chargeTimer=0);else if(n.chargeTimer>=n.chargeCooldown)n.color=e.rgb(255,255,0),e.wait(.2,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor),b>0&&(n.isCharging=!0,n.chargeDirection=y.unit(),n.chargeDuration=0))}),n.chargeTimer=0;else{const v=y.unit().scale(n.speed*.5*e.dt()),z=_(v);z.len()<v.len()*.5&&n.isCharging&&(n.isCharging=!1,n.chargePauseTimer=.1),n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="erratic"){if(b>0){const B=y.unit(),v=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),G=e.vec2(B.x+v.x,B.y+v.y).unit().scale(n.speed*e.dt()),J=_(G);n.pos.x+=J.x,n.pos.y+=J.y}return}if(n.behavior==="shield"){if(b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="teleport"){if(n.teleportTimer+=e.dt(),n.teleportTimer>=n.teleportCooldown&&b>0){const B=y.unit(),v=e.vec2(n.pos.x+B.x*n.teleportRange,n.pos.y+B.y*n.teleportRange);X(v.x,v.y)&&(n.pos.x=v.x,n.pos.y=v.y,n.teleportTimer=0,n.color=e.rgb(255,255,255),e.wait(.1,()=>{n.exists()&&(n.color=e.rgb(...n.originalColor))}))}else if(b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="spawner"){if(n.spawnTimer+=e.dt(),n.spawnTimer>=n.spawnInterval){const B=Math.random()*Math.PI*2,v=30,z=n.pos.x+Math.cos(B)*v,G=n.pos.y+Math.sin(B)*v;if(X(z,G)){const J=So(e,z,G,n.spawnType||"rusher",n.floor);J.isBossMinion=!0,n.spawnTimer=0}}if(b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="buffer"){if(n.attackTimer+=e.dt(),n.attackTimer>=1){const B=e.get("enemy");for(const v of B){if(!v.exists()||v===n)continue;e.vec2(v.pos.x-n.pos.x,v.pos.y-n.pos.y).len()<=n.buffRadius?(v.buffed||(v.buffed=!0,v.originalSpeed=v.speed,v.originalDamage=v.damage||10),v.speed=v.originalSpeed*(1+n.buffAmount),v.damage=v.originalDamage*(1+n.buffAmount),n.buffedEnemies.add(v)):n.buffedEnemies.has(v)&&(v.buffed&&(v.speed=v.originalSpeed,v.damage=v.originalDamage,v.buffed=!1),n.buffedEnemies.delete(v))}n.attackTimer=0}if(b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="healer"){if(n.healTimer+=e.dt(),n.healTimer>=n.healInterval){const B=e.get("enemy");for(const v of B){if(!v.exists()||v===n)continue;if(e.vec2(v.pos.x-n.pos.x,v.pos.y-n.pos.y).len()<=n.healRadius){const J=v.hp(),se=v.maxHealth;if(J<se){const V=Math.min(se,J+n.healAmount);v.setHP(V);const k=e.add([e.text("+",{size:16}),e.pos(v.pos.x,v.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{k.exists()&&e.destroy(k)})}}}n.healTimer=0}if(b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="teleportPlayer"){if(n.teleportTimer+=e.dt(),n.teleportTimer>=n.teleportCooldown&&b<=80){const B=Math.random()*Math.PI*2,v=p.pos.x+Math.cos(B)*n.teleportRange,z=p.pos.y+Math.sin(B)*n.teleportRange,G=Math.max(50,Math.min(e.width()-50,v)),J=Math.max(50,Math.min(e.height()-50,z));p.pos.x=G,p.pos.y=J,n.teleportTimer=0;const se=e.add([e.text("!",{size:24}),e.pos(p.pos.x,p.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{se.exists()&&e.destroy(se)})}if(b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="freeze"){if(b<=n.slowRadius?(p.slowed||(p.slowed=!0,p.originalSpeed=p.speed),p.speed=p.originalSpeed*(1-n.slowAmount)):p.slowed&&(p.speed=p.originalSpeed,p.slowed=!1),b>0){const v=y.unit().scale(n.speed*e.dt()),z=_(v);n.pos.x+=z.x,n.pos.y+=z.y}return}if(n.behavior==="rush"&&b>0){let B;if(n.pathfindingMode==="smart")B=Jp(e,n,p.pos.x,p.pos.y);else{const z=y.unit().scale(n.speed*e.dt());B=_(z).unit()}n.pos.x+=B.x*n.speed*e.dt(),n.pos.y+=B.y*n.speed*e.dt()}if(n.behavior==="perimeter"){const B=Qp(e,n);n.pos.x+=B.x*n.speed*e.dt(),n.pos.y+=B.y*n.speed*e.dt()}const E=e.width(),T=e.height(),C=20,N=n.size||12;n.pos.x=e.clamp(n.pos.x,C+N,E-C-N),n.pos.y=e.clamp(n.pos.y,C+N,T-C-N)}),n.isDead=!1,n.onDeath(()=>{if(n.behavior==="buffer"&&n.buffedEnemies)for(const p of n.buffedEnemies)p.exists()&&p.buffed&&(p.speed=p.originalSpeed,p.damage=p.originalDamage,p.buffed=!1)}),n.onDeath(()=>{if(n.splits&&n.hp()<=0)for(let y=0;y<2;y++){const b=Math.PI*2/2*y,E=20,T=n.pos.x+Math.cos(b)*E,C=n.pos.y+Math.sin(b)*E,N=So(e,T,C,"slime",n.floor);N.maxHealth=Math.floor(N.maxHealth/2),N.setHP(N.maxHealth),N.size=Math.floor(N.size*.8),N.splits=!1}if(n.explodes&&n.hp()<=0){const p=e.get("player")[0];if(p&&p.exists()&&e.vec2(p.pos.x-n.pos.x,p.pos.y-n.pos.y).len()<=n.explosionRadius&&!p.invulnerable){const T=Math.max(1,n.explosionDamage-(p.defense||0));p.hurt(T),p.invulnerable=!0,p.invulnerableTime=p.invulnerableDuration,p.color=e.rgb(255,100,100)}const y=e.add([e.text("*",{size:24}),e.pos(n.pos.x,n.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{y.exists()&&e.destroy(y)})}}),pt()&&Jt()&&(pl(n,{type:s,floor:i}),n.enemyType=s),n}const ya={gatekeeper:{coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function Zp(e){return ya[e]||ya.gatekeeper}function pn(e,t,o,s="gatekeeper",i=1,a=null){const r=Zp(s),h=1+(i-1)*.2,l={coreChar:r.coreChar,armorChar:r.armorChar||"()",shieldChar:r.shieldChar||"{}",color:r.color,armorColor:r.armorColor||[200,200,200],shieldColor:r.shieldColor||[100,200,255],health:Math.floor(r.baseHealth*h),armorHealth:Math.floor((r.baseArmorHealth||0)*h),maxArmorHealth:Math.floor((r.baseArmorHealth||0)*h),shieldHealth:Math.floor((r.baseShieldHealth||0)*h),maxShieldHealth:Math.floor((r.baseShieldHealth||0)*h),speed:Math.floor(r.baseSpeed*(1+(i-1)*.05)),size:r.size,xpValue:Math.floor(r.baseXPValue*h),damageReduction:r.damageReduction||0,shieldRegenRate:(r.shieldRegenRate||0)*h};function n(){const u=l.armorHealth>l.maxArmorHealth*.5?"(":"",d=l.armorHealth>0?")":"";return`${u}${l.coreChar}${d}`}const c=e.add([e.text(n(),{size:l.size}),e.pos(t,o),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"boss"]);return c.maxHealth=l.health,c.speed=l.speed,c.xpValue=l.xpValue,c.type=s,c.floor=i,c.textSize=l.size,c.rng=a,r.meleeDamage&&(c.meleeDamage=r.meleeDamage),r.projectileDamage&&(c.projectileDamage=r.projectileDamage),r.projectileSpeed&&(c.projectileSpeed=r.projectileSpeed),r.fireRate&&(c.fireRate=r.fireRate),(s==="twinGuardianMelee"||s==="twinGuardianRanged")&&(c.enraged=!1),c.armorHealth=l.armorHealth,c.maxArmorHealth=l.maxArmorHealth,c.damageReduction=l.damageReduction,c.coreChar=l.coreChar,c.armorChar=l.armorChar,c.armorColor=l.armorColor,c.shieldHealth=l.shieldHealth,c.maxShieldHealth=l.maxShieldHealth,c.shieldRegenRate=l.shieldRegenRate,c.shieldChar=l.shieldChar,c.shieldColor=l.shieldColor,c.shieldRegenTimer=0,c.shieldRegenCooldown=0,c.lastDamageTime=0,c.updateVisual=function(){let u="",d="",x="",f="";if(c.shieldHealth>0){const g=c.shieldHealth/c.maxShieldHealth;g>.66?(u="",d=""):g>.33?(u="",d=""):(u="",d="")}if(c.armorHealth>0){const g=c.armorHealth/c.maxArmorHealth;g>.66?(x="",f=""):g>.33?(x="",f=""):(x="",f="")}const A=`${u}${x}${c.coreChar}${f}${d}`;c.text=A,c.shieldHealth>0?c.color=e.rgb(...l.shieldColor):c.color=e.rgb(...l.color)},c.takeDamage=function(u){let d=!1,x=!1;const f=c.shieldHealth,A=c.armorHealth;c.lastDamageTime=e.time();const g=3;if(c.shieldRegenCooldown=g,c.shieldHealth>0){const w=Math.min(u,c.shieldHealth);c.shieldHealth=Math.max(0,c.shieldHealth-w),d=c.shieldHealth!==f;const D=u-w;D>0&&c.takeDamageInternal(D)}else c.takeDamageInternal(u);x=c.armorHealth!==A,(d||x)&&c.updateVisual()},c.takeDamageInternal=function(u){if(c.armorHealth>0){const d=Math.floor(u*(1-c.damageReduction)),x=Math.min(d,c.armorHealth);c.armorHealth=Math.max(0,c.armorHealth-x);const f=u-d;if(f>0){const A=c.armorHealth>0?1-c.damageReduction:1,g=Math.floor(f*A);c.hurt(g)}}else c.hurt(u)},c.attackTimer=0,c.minionSpawnTimer=0,c.chargeCooldownTimer=0,c.chargeDurationTimer=0,c.radialBurstTimer=0,c.isCharging=!1,c.chargeDirection=null,c.chargeSpeed=0,c.spawnedMinions=[],c.enraged=!1,c.twinPartner=null,c.getPhase=function(){const u=c.hp()/c.maxHealth;return u>.75?1:u>.5?2:3},c.spawnMinions=function(){if(!c.exists())return;const u=c.getPhase(),d=u===1?2:3;for(let x=0;x<d;x++){const f=c.rng?c.rng.next()*.5:Math.random()*.5,A=Math.PI*2/d*x+f,w=40+(c.rng?c.rng.next()*20:Math.random()*20),D=c.pos.x+Math.cos(A)*w,R=c.pos.y+Math.sin(A)*w,_=(c.rng?c.rng.next():Math.random())<.5?"rusher":"basic",p=So(e,D,R,_,i);p.isBossMinion=!0,c.spawnedMinions.push(p)}},c.radialBurst=function(){if(!c.exists())return;const u=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];c.getPhase();const d=200,x=12;u.forEach(f=>{const A=Qt(e,c.pos.x,c.pos.y,f,d,x,0,0,!1);A.isBossProjectile=!0,A.color=e.rgb(255,100,100)})},c.startCharge=function(u){if(!c.exists())return;c.isCharging=!0;const d=e.vec2(u.x-c.pos.x,u.y-c.pos.y);if(d.len()>0&&(c.chargeDirection=d.unit(),!c.chargeSpeed||c.chargeSpeed===0)){const x=c.getPhase?c.getPhase():1;c.chargeSpeed=c.speed*(x===1?2.5:x===2?3:3.5)}},c.onUpdate(()=>{if(e.paused)return;if(c.shieldRegenRate>0&&c.shieldHealth<c.maxShieldHealth&&c.hp()>0&&!c.isDead&&(c.shieldRegenCooldown>0&&(c.shieldRegenCooldown-=e.dt()),c.shieldRegenCooldown<=0)){c.shieldRegenTimer+=e.dt();const w=1;if(c.shieldRegenTimer>=w){const D=c.shieldRegenRate*w;c.shieldHealth=Math.min(c.maxShieldHealth,c.shieldHealth+D),c.shieldRegenTimer=0,c.shieldHealth>0&&c.updateVisual()}}c.burnDuration>0&&c.hp()>0&&!c.isDead&&(c.burnTimer=(c.burnTimer||0)+e.dt(),c.burnTimer>=.5&&(c.takeDamage?c.takeDamage(c.burnDamage):c.hurt(c.burnDamage),c.color,c.color=e.rgb(255,150,50),e.wait(.1,()=>{c.exists()&&c.updateVisual()}),c.burnTimer=0),c.burnDuration-=e.dt(),c.burnDuration<=0&&(c.burnDamage=0,c.burnTimer=0));const u=e.get("player")[0];if(!u||!u.exists())return;const d=c.getPhase();if(c.type==="gatekeeper"){c.attackTimer+=e.dt(),c.minionSpawnTimer+=e.dt(),c.radialBurstTimer+=e.dt();const w=d===1?8:d===2?6:5,D=10,R=d===1?8:d===2?6:5;if(c.isCharging){const X=c.chargeDirection.scale(c.chargeSpeed*e.dt());c.pos.x+=X.x,c.pos.y+=X.y,c.chargeDurationTimer+=e.dt(),c.chargeDurationTimer>=1&&(c.isCharging=!1,c.chargeDurationTimer=0,c.chargeCooldownTimer=0)}else{c.chargeCooldownTimer+=e.dt();const X=e.vec2(u.pos.x-c.pos.x,u.pos.y-c.pos.y);if(X.len()>0){const p=X.unit(),y=c.speed*(d===1?1:d===2?1.2:1.5),b=p.scale(y*e.dt()),E=c.pos.x+b.x,T=c.pos.y+b.y;let C=!0,N=!0;const B=e.get("obstacle"),v=c.size||14;for(const z of B){if(!z.exists())continue;const G=z.pos.x-z.width/2,J=z.pos.x+z.width/2,se=z.pos.y-z.height/2,V=z.pos.y+z.height/2,k=E-v,fe=E+v,oe=c.pos.y-v,Ie=c.pos.y+v;fe>G&&k<J&&Ie>se&&oe<V&&(C=!1,c.isCharging&&(c.isCharging=!1,c.chargeTimer=0));const Ee=c.pos.x-v,Re=c.pos.x+v,Ae=T-v,Ce=T+v;Re>G&&Ee<J&&Ce>se&&Ae<V&&(N=!1,c.isCharging&&(c.isCharging=!1,c.chargeTimer=0))}C&&(c.pos.x=E),N&&(c.pos.y=T)}c.minionSpawnTimer>=w&&(c.spawnMinions(),c.minionSpawnTimer=0),c.chargeCooldownTimer>=D&&(c.color=e.rgb(255,255,0),e.wait(.3,()=>{c.exists()&&(c.color=e.rgb(...l.color),c.startCharge(u.pos))}),c.chargeCooldownTimer=0),c.radialBurstTimer>=R&&(c.radialBurst(),c.radialBurstTimer=0)}}else if(c.type==="twinGuardianMelee"){c.attackTimer+=e.dt(),c.chargeCooldownTimer+=e.dt();const w=8,D=150,R=e.vec2(u.pos.x-c.pos.x,u.pos.y-c.pos.y),X=R.len();if(c.isCharging){const _=c.chargeDirection.scale(c.chargeSpeed*e.dt());c.pos.x+=_.x,c.pos.y+=_.y,c.chargeDurationTimer+=e.dt(),c.chargeDurationTimer>=1.2&&(c.isCharging=!1,c.chargeDurationTimer=0,c.chargeCooldownTimer=0)}else{if(X>0){const _=R.unit(),p=c.speed*(c.enraged?1.5:1),y=_.scale(p*e.dt()),b=c.pos.x+y.x,E=c.pos.y+y.y;let T=!0,C=!0;const N=e.get("obstacle"),B=c.size||14;for(const v of N){if(!v.exists())continue;const z=v.pos.x-v.width/2,G=v.pos.x+v.width/2,J=v.pos.y-v.height/2,se=v.pos.y+v.height/2,V=b-B,k=b+B,fe=c.pos.y-B,oe=c.pos.y+B;k>z&&V<G&&oe>J&&fe<se&&(T=!1);const Ie=c.pos.x-B,Ee=c.pos.x+B,Re=E-B,Ae=E+B;Ee>z&&Ie<G&&Ae>J&&Re<se&&(C=!1)}T&&(c.pos.x=b),C&&(c.pos.y=E)}c.chargeCooldownTimer>=w&&X<D&&(c.color=e.rgb(255,255,0),e.wait(.3,()=>{if(c.exists()){c.color=e.rgb(...l.color);const _=c.enraged?3.5:2.5;c.chargeSpeed=c.speed*_,c.startCharge(u.pos)}}),c.chargeCooldownTimer=0)}}else if(c.type==="twinGuardianRanged"){c.attackTimer+=e.dt();const w=200,D=e.vec2(u.pos.x-c.pos.x,u.pos.y-c.pos.y),R=D.len();if(R>0){const _=D.unit();let p=c.speed*(c.enraged?1.5:1);if(R<w){const y=_.scale(-p*e.dt()),b=c.pos.x+y.x,E=c.pos.y+y.y;let T=!0,C=!0;const N=e.get("obstacle"),B=c.size||14;for(const v of N){if(!v.exists())continue;const z=v.pos.x-v.width/2,G=v.pos.x+v.width/2,J=v.pos.y-v.height/2,se=v.pos.y+v.height/2,V=b-B,k=b+B,fe=c.pos.y-B,oe=c.pos.y+B;k>z&&V<G&&oe>J&&fe<se&&(T=!1);const Ie=c.pos.x-B,Ee=c.pos.x+B,Re=E-B,Ae=E+B;Ee>z&&Ie<G&&Ae>J&&Re<se&&(C=!1)}T&&(c.pos.x=b),C&&(c.pos.y=E)}else if(R>w*1.5){const y=_.scale(p*e.dt()),b=c.pos.x+y.x,E=c.pos.y+y.y;let T=!0,C=!0;const N=e.get("obstacle"),B=c.size||14;for(const v of N){if(!v.exists())continue;const z=v.pos.x-v.width/2,G=v.pos.x+v.width/2,J=v.pos.y-v.height/2,se=v.pos.y+v.height/2,V=b-B,k=b+B,fe=c.pos.y-B,oe=c.pos.y+B;k>z&&V<G&&oe>J&&fe<se&&(T=!1);const Ie=c.pos.x-B,Ee=c.pos.x+B,Re=E-B,Ae=E+B;Ee>z&&Ie<G&&Ae>J&&Re<se&&(C=!1)}T&&(c.pos.x=b),C&&(c.pos.y=E)}}const X=1/(c.fireRate*(c.enraged?1.5:1));if(c.attackTimer>=X){if(R>0){const _=D.unit(),p=Qt(e,c.pos.x,c.pos.y,_,c.projectileSpeed,c.projectileDamage*(c.enraged?1.25:1),0,0,!1);p.isBossProjectile=!0,p.color=e.rgb(100,150,255)}c.attackTimer=0}}else if(c.type==="swarmQueen"){c.minionSpawnTimer+=e.dt();const w=c.hp()/c.maxHealth;let D;w>.66?D=5:w>.33?D=3:D=2;const R=c.spawnedMinions.filter(N=>N.exists()&&N.hp()>0);if(c.minionSpawnTimer>=D&&R.length<8){const N=Math.random()<.5?"fast":"basic",B=Math.random()*Math.PI*2,v=50+Math.random()*30,z=c.pos.x+Math.cos(B)*v,G=c.pos.y+Math.sin(B)*v,J=So(e,z,G,N,i);J.isBossMinion=!0,c.spawnedMinions.push(J),c.spawnedMinions=c.spawnedMinions.filter(se=>se.exists()),c.minionSpawnTimer=0}const _=e.width()/2,p=e.height()/2,y=150,b=e.vec2(_-c.pos.x,p-c.pos.y),E=e.vec2(u.pos.x-c.pos.x,u.pos.y-c.pos.y),T=E.len();let C=e.vec2(0,0);if(b.len()>30&&(C=C.add(b.unit().scale(.5))),T<y&&(C=C.add(E.unit().scale(-1))),C.len()>0){const B=C.unit().scale(c.speed*e.dt()),v=c.pos.x+B.x,z=c.pos.y+B.y;let G=!0,J=!0;const se=e.get("obstacle"),V=c.size||14;for(const k of se){if(!k.exists())continue;const fe=k.pos.x-k.width/2,oe=k.pos.x+k.width/2,Ie=k.pos.y-k.height/2,Ee=k.pos.y+k.height/2,Re=v-V,Ae=v+V,Ce=c.pos.y-V,Te=c.pos.y+V;Ae>fe&&Re<oe&&Te>Ie&&Ce<Ee&&(G=!1);const He=c.pos.x-V,ee=c.pos.x+V,K=z-V,Z=z+V;ee>fe&&He<oe&&Z>Ie&&K<Ee&&(J=!1)}G&&(c.pos.x=v),J&&(c.pos.y=z)}}else{const w=e.vec2(u.pos.x-c.pos.x,u.pos.y-c.pos.y);if(w.len()>0){const X=w.unit().scale(c.speed*e.dt()),_=c.pos.x+X.x,p=c.pos.y+X.y;let y=!0,b=!0;const E=e.get("obstacle"),T=c.size||14;for(const C of E){if(!C.exists())continue;const N=C.pos.x-C.width/2,B=C.pos.x+C.width/2,v=C.pos.y-C.height/2,z=C.pos.y+C.height/2,G=_-T,J=_+T,se=c.pos.y-T,V=c.pos.y+T;J>N&&G<B&&V>v&&se<z&&(y=!1);const k=c.pos.x-T,fe=c.pos.x+T,oe=p-T,Ie=p+T;fe>N&&k<B&&Ie>v&&oe<z&&(b=!1)}y&&(c.pos.x=_),b&&(c.pos.y=p)}}const x=e.width(),f=e.height(),A=20,g=c.size||14;c.pos.x=e.clamp(c.pos.x,A+g,x-A-g),c.pos.y=e.clamp(c.pos.y,A+g,f-A-g)}),c.isDead=!1,s==="swarmQueen"&&c.onDeath(()=>{const u=8+Math.floor(Math.random()*5);for(let d=0;d<u;d++){const x=Math.PI*2/u*d+Math.random()*.3,f=40+Math.random()*20,A=c.pos.x+Math.cos(x)*f,g=c.pos.y+Math.sin(x)*f,w=Math.random()<.5?"fast":"basic",D=So(e,A,g,w,i);D.isBossMinion=!0}}),c.updateVisual(),c}function kp(e,t,o,s=1,i=null){const a=pn(e,t.pos.x,t.pos.y,"twinGuardianMelee",s,i),r=pn(e,o.pos.x,o.pos.y,"twinGuardianRanged",s,i);return a.twinPartner=r,r.twinPartner=a,a.onDeath(()=>{r&&r.exists()&&!r.enraged&&(r.enraged=!0,r.speed=Math.floor(r.speed*1.5),r.fireRate=r.fireRate*1.5,r.projectileDamage=Math.floor(r.projectileDamage*1.25),r.color=e.rgb(255,200,0))}),r.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enraged=!0,a.speed=Math.floor(a.speed*1.5),a.chargeCooldownTimer=0,a.meleeDamage=Math.floor(a.meleeDamage*1.25),a.color=e.rgb(255,200,0))}),[a,r]}const wa={brute:{coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function e0(e){return wa[e]||wa.brute}function t0(e,t,o,s="brute",i=1){const a=e0(s),r=1+(i-1)*.2,h={coreChar:a.coreChar,armorChar:a.armorChar||"[]",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*r),armorHealth:Math.floor((a.baseArmorHealth||0)*r),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*r),shieldHealth:Math.floor((a.baseShieldHealth||0)*r),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*r),speed:Math.floor(a.baseSpeed*(1+(i-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*r),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*r},l=e.add([e.text(h.coreChar,{size:h.size}),e.pos(t,o),e.anchor("center"),e.color(...h.color),e.area(),e.health(h.health),"miniboss"]);return l.maxHealth=h.health,l.speed=h.speed,l.xpValue=h.xpValue,l.type=s,l.floor=i,a.meleeDamage&&(l.meleeDamage=a.meleeDamage),a.projectileDamage&&(l.projectileDamage=a.projectileDamage),a.projectileSpeed&&(l.projectileSpeed=a.projectileSpeed),a.fireRate&&(l.fireRate=a.fireRate),l.armorHealth=h.armorHealth,l.maxArmorHealth=h.maxArmorHealth,l.damageReduction=h.damageReduction,l.coreChar=h.coreChar,l.armorChar=h.armorChar,l.armorColor=h.armorColor,l.shieldHealth=h.shieldHealth,l.maxShieldHealth=h.maxShieldHealth,l.shieldRegenRate=h.shieldRegenRate,l.shieldChar=h.shieldChar,l.shieldColor=h.shieldColor,l.shieldRegenTimer=0,l.shieldRegenCooldown=0,l.lastDamageTime=0,l.attackTimer=0,l.chargeCooldownTimer=0,l.chargeDurationTimer=0,l.isCharging=!1,l.chargeDirection=null,l.chargeSpeed=0,l.updateVisual=function(){let n="",c="",u="",d="";if(l.shieldHealth>0){const f=l.shieldHealth/l.maxShieldHealth;f>.66?(n="",c=""):f>.33?(n="",c=""):(n="",c="")}if(l.armorHealth>0){const f=l.armorHealth/l.maxArmorHealth;f>.66?(u="",d=""):f>.33?(u="",d=""):(u="",d="")}const x=`${n}${u}${l.coreChar}${d}${c}`;l.text=x,l.shieldHealth>0?l.color=e.rgb(...h.shieldColor):l.color=e.rgb(...h.color)},l.takeDamage=function(n){let c=!1,u=!1;const d=l.shieldHealth,x=l.armorHealth;l.lastDamageTime=e.time();const f=3;if(l.shieldRegenCooldown=f,l.shieldHealth>0){const A=Math.min(n,l.shieldHealth);l.shieldHealth=Math.max(0,l.shieldHealth-A),c=l.shieldHealth!==d;const g=n-A;g>0&&l.takeDamageInternal(g)}else l.takeDamageInternal(n);u=l.armorHealth!==x,(c||u)&&l.updateVisual()},l.takeDamageInternal=function(n){if(l.armorHealth>0){const c=Math.floor(n*(1-l.damageReduction)),u=Math.min(c,l.armorHealth);l.armorHealth=Math.max(0,l.armorHealth-u);const d=n-c;if(d>0){const x=l.armorHealth>0?1-l.damageReduction:1,f=Math.floor(d*x);l.hurt(f)}}else l.hurt(n)},l.startCharge=function(n){if(!l.exists())return;l.isCharging=!0;const c=e.vec2(n.x-l.pos.x,n.y-l.pos.y);c.len()>0&&(l.chargeDirection=c.unit(),l.chargeSpeed=l.speed*2.5)},l.onUpdate(()=>{if(e.paused)return;if(l.shieldRegenRate>0&&l.shieldHealth<l.maxShieldHealth&&l.hp()>0&&!l.isDead&&(l.shieldRegenCooldown>0&&(l.shieldRegenCooldown-=e.dt()),l.shieldRegenCooldown<=0)){l.shieldRegenTimer+=e.dt();const g=1;if(l.shieldRegenTimer>=g){const w=l.shieldRegenRate*g;l.shieldHealth=Math.min(l.maxShieldHealth,l.shieldHealth+w),l.shieldRegenTimer=0,l.shieldHealth>0&&l.updateVisual()}}l.burnDuration>0&&l.hp()>0&&!l.isDead&&(l.burnTimer=(l.burnTimer||0)+e.dt(),l.burnTimer>=.5&&(l.takeDamage?l.takeDamage(l.burnDamage):l.hurt(l.burnDamage),l.color,l.color=e.rgb(255,150,50),e.wait(.1,()=>{l.exists()&&l.updateVisual()}),l.burnTimer=0),l.burnDuration-=e.dt(),l.burnDuration<=0&&(l.burnDamage=0,l.burnTimer=0));const n=e.get("player")[0];if(!n||!n.exists())return;const c=e.vec2(n.pos.x-l.pos.x,n.pos.y-l.pos.y),u=c.len();if(a.behavior==="charge"){l.attackTimer+=e.dt(),l.chargeCooldownTimer+=e.dt();const g=6,w=200;if(l.isCharging){const D=l.chargeDirection.scale(l.chargeSpeed*e.dt());l.pos.x+=D.x,l.pos.y+=D.y,l.chargeDurationTimer+=e.dt(),l.chargeDurationTimer>=1&&(l.isCharging=!1,l.chargeDurationTimer=0,l.chargeCooldownTimer=0)}else{if(u>0){const R=c.unit().scale(l.speed*e.dt());l.pos.x+=R.x,l.pos.y+=R.y}l.chargeCooldownTimer>=g&&u<w&&(l.color=e.rgb(255,255,0),e.wait(.3,()=>{l.exists()&&(l.color=e.rgb(...h.color),l.startCharge(n.pos))}),l.chargeCooldownTimer=0)}}else if(a.behavior==="shoot"){l.attackTimer+=e.dt();const g=180;if(u>0){const D=c.unit();let R=l.speed;if(u<g){const X=D.scale(-R*e.dt());l.pos.x+=X.x,l.pos.y+=X.y}else if(u>g*1.5){const X=D.scale(R*e.dt());l.pos.x+=X.x,l.pos.y+=X.y}}const w=1/l.fireRate;if(l.attackTimer>=w){if(u>0){const D=c.unit(),R=Qt(e,l.pos.x,l.pos.y,D,l.projectileSpeed,l.projectileDamage,0,0,!1);R.isBossProjectile=!0,R.color=e.rgb(...h.color)}l.attackTimer=0}}else if(a.behavior==="rush"&&u>0){const w=c.unit().scale(l.speed*e.dt());l.pos.x+=w.x,l.pos.y+=w.y}const d=e.width(),x=e.height(),f=20,A=l.size||24;l.pos.x=e.clamp(l.pos.x,f+A,d-f-A),l.pos.y=e.clamp(l.pos.y,f+A,x-f-A)}),l.isDead=!1,l.updateVisual(),l}function o0(e,t,o,s){const i=e.add([e.rect(40,40),e.pos(t,o),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return i.direction=s,i.open=!1,i.isSpawnDoor=!1,i.blocked=!1,i.gridDirection=null,i.parts=[],i.updateVisual=()=>{i.parts.forEach(r=>{r.exists()&&e.destroy(r)}),i.parts=[];let a;if(i.blocked?a=e.rgb(80,80,80):i.open?a=e.rgb(100,255,100):i.isSpawnDoor?a=e.rgb(200,50,50):a=e.rgb(200,200,100),s==="north"||s==="south"){const r=i.blocked?"":i.open?"":"",h=e.add([e.text(r,{size:24}),e.pos(t,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(h);const l=e.add([e.text(i.open?"":"",{size:20}),e.pos(t-35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(l);const n=e.add([e.text(i.open?"":"",{size:20}),e.pos(t+35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(n)}else{const r=i.blocked?["","",""]:i.open?["","",""]:["","",""],h=16;for(let c=0;c<r.length;c++){const u=(c-1)*h,d=e.add([e.text(r[c],{size:24}),e.pos(t,o+u),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(d)}const l=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,o-h*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(l);const n=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,o+h*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);i.parts.push(n)}if(i.blocked){const r=e.add([e.text("X",{size:28}),e.pos(t,o),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);i.parts.push(r)}},Object.defineProperty(i,"color",{get:()=>i._color,set:a=>{i._color=a,i.parts.forEach(r=>{r.exists()&&(r.color=a)})}}),Object.defineProperty(i,"text",{get:()=>i._text||"=",set:a=>{i._text=a}}),i.onDestroy(()=>{i.parts.forEach(a=>{a.exists()&&e.destroy(a)}),i.parts=[]}),i.updateVisual(),i}function s0(e,t,o,s,i,a="wall",r="#",h=null){const l=a==="wall",n=l?e.rgb(100,100,100):e.rgb(140,140,140),c=l?e.rgb(80,80,80):e.rgb(120,120,120),u=e.add([e.rect(s,i),e.pos(t,o),e.anchor("center"),e.color(h||n),e.outline(2,h||c),e.area({width:s,height:i}),e.fixed(),"obstacle",a==="wall"?"wall":"cover"]);return u.type=a,u.width=s,u.height=i,u}let vs=null,bl=.3;function Al(){return vs||(vs=new(window.AudioContext||window.webkitAudioContext)),vs}function Hn(){return vs||Al(),vs}function be(e,t,o="square",s=.3,i={}){const a=Hn(),r=a.currentTime,h=a.createOscillator();h.type=o,h.frequency.setValueAtTime(e,r),i.pitchBend&&h.frequency.exponentialRampToValueAtTime(e*i.pitchBend,r+t);const l=a.createGain(),n=s*bl,c=i.attack||.01;l.gain.setValueAtTime(0,r),l.gain.linearRampToValueAtTime(n,r+c);const u=i.decay||.1;l.gain.setValueAtTime(n,r+t-u),l.gain.exponentialRampToValueAtTime(.01,r+t),h.connect(l),l.connect(a.destination),h.start(r),h.stop(r+t)}function po(e,t=.3,o={}){const s=Hn(),i=s.currentTime,a=s.sampleRate*e,r=s.createBuffer(1,a,s.sampleRate),h=r.getChannelData(0);for(let f=0;f<a;f++)h[f]=Math.random()*2-1;const l=s.createBufferSource();l.buffer=r;const n=s.createBiquadFilter();n.type=o.filterType||"lowpass",n.frequency.setValueAtTime(o.filterFreq||2e3,i);const c=s.createGain(),u=t*bl,d=o.attack||.01,x=o.decay||.1;c.gain.setValueAtTime(0,i),c.gain.linearRampToValueAtTime(u,i+d),c.gain.setValueAtTime(u,i+e-x),c.gain.exponentialRampToValueAtTime(.01,i+e),l.connect(n),n.connect(c),c.connect(s.destination),l.start(i),l.stop(i+e)}function ce(e,t=.1){return e*(1+(Math.random()-.5)*t)}function vl(){const e=Math.random();e<.33?be(ce(150,.2),.08,"square",.15,{attack:.001,decay:.05,pitchBend:.5}):e<.66?be(ce(180,.2),.09,"square",.15,{attack:.001,decay:.06,pitchBend:.6}):be(ce(200,.2),.07,"square",.15,{attack:.001,decay:.04,pitchBend:.4})}function i0(){const e=Math.random();e<.33?be(ce(250,.3),.05,"square",.12,{attack:.001,decay:.03,pitchBend:.4}):e<.66?be(ce(280,.3),.04,"sawtooth",.12,{attack:.001,decay:.025,pitchBend:.5}):be(ce(230,.3),.06,"square",.12,{attack:.001,decay:.04,pitchBend:.3})}function n0(){const e=ce(80,.15);be(e,.15,"sawtooth",.25,{attack:.001,decay:.1,pitchBend:.3}),po(ce(.12,.2),ce(.2,.3),{attack:.001,decay:.08,filterType:"lowpass",filterFreq:ce(1500,.4)})}function a0(){be(ce(400,.2),.06,"square",.2,{attack:.001,decay:.04,pitchBend:.2}),be(ce(60,.15),.12,"sine",.18,{attack:.001,decay:.08,pitchBend:.5})}function r0(){po(.08,ce(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:ce(800,.5)})}function l0(){be(ce(70,.2),.2,"sawtooth",.22,{attack:.001,decay:.15,pitchBend:.4}),be(ce(120,.2),.15,"square",.18,{attack:.005,decay:.1,pitchBend:.5})}function c0(){be(ce(300,.3),.12,"sawtooth",.18,{attack:.001,decay:.08,pitchBend:1.8}),po(ce(.1,.3),.15,{attack:.001,decay:.06,filterType:"highpass",filterFreq:ce(3e3,.4)})}function h0(){be(ce(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function d0(){vl()}function u0(){const e=Math.random();e<.25?be(ce(120,.3),.08,"square",.16,{attack:.001,decay:.05,pitchBend:.5}):e<.5?be(ce(100,.3),.09,"sawtooth",.16,{attack:.001,decay:.06,pitchBend:.6}):e<.75?(be(ce(140,.3),.07,"square",.16,{attack:.001,decay:.04,pitchBend:.4}),po(.05,.1,{attack:.001,decay:.03,filterFreq:ce(1200,.4)})):be(ce(160,.3),.06,"triangle",.16,{attack:.001,decay:.04,pitchBend:.3})}function Us(){const e=Math.random();e<.33?(be(ce(80,.2),.15,"sawtooth",.25,{attack:.001,decay:.1,pitchBend:.4}),po(.12,.2,{attack:.001,decay:.08,filterType:"lowpass",filterFreq:ce(1e3,.3)})):e<.66?(be(ce(70,.2),.18,"square",.25,{attack:.001,decay:.12,pitchBend:.5}),be(ce(200,.3),.08,"triangle",.15,{attack:.005,decay:.05,pitchBend:.3})):(be(ce(90,.2),.16,"sawtooth",.25,{attack:.001,decay:.11,pitchBend:.6}),po(.1,.18,{attack:.001,decay:.07,filterType:"bandpass",filterFreq:ce(800,.4)}))}function ba(){const e=Math.random();e<.33?be(ce(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(be(ce(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),po(.15,.12,{attack:.05,decay:.1,filterFreq:ce(1500,.4)})):be(ce(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function El(){be(ce(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),be(ce(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),po(ce(.3,.2),ce(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:ce(1200,.5)})}function p0(){const e=Math.random();e<.33?be(ce(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?be(ce(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):be(ce(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function Aa(){const e=Math.random();e<.33?(be(ce(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{be(ce(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(be(ce(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),be(ce(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(be(ce(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{be(ce(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function f0(){Hn().currentTime;const t=400;[1,1.25,1.5,2].forEach((s,i)=>{setTimeout(()=>{be(t*s,.15,"square",.2,{attack:.01,decay:.1})},i*80)})}function g0(){be(ce(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function $t(){be(ce(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function mt(){be(ce(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function m0(){be(ce(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{be(ce(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function va(){be(ce(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{be(ce(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function x0(){for(let t=0;t<8;t++)setTimeout(()=>{be(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{El()},480)}function y0(){[400,500,600,800].forEach((t,o)=>{setTimeout(()=>{be(t,.2,"square",.18,{attack:.01,decay:.15})},o*100)})}function zi(){be(ce(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{be(ce(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function Ni(){be(ce(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),po(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:ce(500,.3)})}function w0(){be(ce(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function Ea(){be(ce(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function b0(e){const t=(e==null?void 0:e.toLowerCase())||"";t.includes("pistol")?vl():t.includes("smg")||t.includes("submachine")?i0():t.includes("shotgun")?n0():t.includes("sniper")||t.includes("rifle")?a0():t.includes("flame")||t.includes("thrower")?r0():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?l0():t.includes("chain")||t.includes("lightning")?c0():t.includes("orbital")?h0():d0()}function si(e,t,o,s={}){const{char:i="*",size:a=12,color:r=[255,255,255],velocity:h={x:0,y:0},gravity:l=0,lifetime:n=1,fadeStart:c=.3,friction:u=.95,zIndex:d=100}=s,x=e.add([e.text(i,{size:a}),e.pos(t,o),e.anchor("center"),e.color(...r),e.z(d),"particle"]);return x.velocity={x:h.x,y:h.y},x.gravity=l,x.friction=u,x.lifetime=n,x.fadeStart=c,x.age=0,x.initialOpacity=1,x}function A0(e){e.get("particle").forEach(o=>{if(!o.exists())return;if(o.age+=e.dt(),o.age>=o.lifetime){e.destroy(o);return}o.pos.x+=o.velocity.x*e.dt()*60,o.pos.y+=o.velocity.y*e.dt()*60,o.velocity.y+=o.gravity*e.dt()*60,o.velocity.x*=o.friction,o.velocity.y*=o.friction;const s=o.age/o.lifetime;if(s>=o.fadeStart){const i=(s-o.fadeStart)/(1-o.fadeStart);o.opacity=o.initialOpacity*(1-i)}})}function Po(e,t,o,s={}){const{count:i=8,color:a=[255,50,50],speed:r=2,isCrit:h=!1}=s,l=[".",",","'","`","*"],n=h?i*1.5:i,c=h?r*1.5:r,u=h?[255,200,0]:a;for(let d=0;d<n;d++){const x=Math.PI*2*d/n+(Math.random()-.5)*.5,f=.5+Math.random()*.5,A={x:Math.cos(x)*c*f,y:Math.sin(x)*c*f};si(e,t,o,{char:l[Math.floor(Math.random()*l.length)],size:8+Math.random()*6,color:u,velocity:A,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function _s(e,t,o,s={}){const{count:i=12,color:a=[255,100,100],speed:r=3,isBoss:h=!1,isMiniboss:l=!1}=s,n=["*","+","x","X","#"],c=h?i*2:l?i*1.5:i,u=h?r*1.5:l?r*1.2:r;for(let x=0;x<c;x++){const f=Math.PI*2*x/c,A=.7+Math.random()*.6,g={x:Math.cos(f)*u*A,y:Math.sin(f)*u*A};si(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:12+Math.random()*8,color:a,velocity:g,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const d=Math.floor(c/2);for(let x=0;x<d;x++){const f=Math.random()*Math.PI*2,A=.3+Math.random()*.4,g={x:Math.cos(f)*u*A*.5,y:Math.sin(f)*u*A*.5};si(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:16+Math.random()*8,color:[255,200,100],velocity:g,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}function Hi(e,t,o,s,i={}){const{count:a=5,color:r=[255,255,100],speed:h=2.5,isCrit:l=!1}=i,n=["","","",""],c=l?a*2:a,u=l?[255,200,0]:r,d=Math.sqrt(s.x*s.x+s.y*s.y),x=d>0?{x:s.x/d,y:s.y/d}:{x:1,y:0};for(let f=0;f<c;f++){const A=(Math.random()-.5)*Math.PI*.6,g=Math.atan2(x.y,x.x)+A,w=.6+Math.random()*.8,D={x:Math.cos(g)*h*w,y:Math.sin(g)*h*w};si(e,t,o,{char:n[Math.floor(Math.random()*n.length)],size:10+Math.random()*4,color:u,velocity:D,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function rs(e,t,o,s){if(!t||!t.exists())return;const i=20,a=e.width()-i,r=e.height()-i,h=i,l=i,n=t.pos.x+o.x*s,c=t.pos.y+o.y*s,u=Math.max(h,Math.min(a,n)),d=Math.max(l,Math.min(r,c)),x=t.pos.x,f=t.pos.y;t.pos.x=u,t.pos.y=d;const A=e.get("wall"),g=e.get("obstacle"),w=[...A,...g];let D=!1;for(const R of w)if(R.exists()&&t.isColliding&&t.isColliding(R)){D=!0;break}D&&(t.pos.x=x,t.pos.y=f)}function v0(e,t){let o=0;t.weaponKey==="orbital"&&fn(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.weaponKey==="orbital"){E0(e,t);return}const s=e.mousePos(),i=e.time(),a=e.vec2(s.x-t.pos.x,s.y-t.pos.y);if(a.len()>0){const h=a.unit();if(i-o>=1/t.fireRate){const l=t.projectileCount||1,n=t.spreadAngle||0,c=[];if(l===1)c.push(h);else if(n>0){const u=l>1?n/(l-1):0,d=-n/2;for(let x=0;x<l;x++){const A=(d+u*x)*(Math.PI/180),g=Math.cos(A),w=Math.sin(A),D=e.vec2(h.x*g-h.y*w,h.x*w+h.y*g);c.push(D.unit())}}else for(let u=0;u<l;u++)c.push(h);c.forEach((u,d)=>{const x=n===0&&l>1?d*bt.MULTISHOT_STAGGER_DELAY:0;e.wait(x,()=>{const f=wp(t.critChance||0);let A=f?bp(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(A=Math.floor(A*t.piercingDamageBonus));const g=t.weaponRange||Jo.DEFAULT_WEAPON_RANGE;if(b0(t.weaponKey),t.weaponKey==="flamethrower"){const w=Qt(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.piercing||0,t.obstaclePiercing||0,f,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef);const D=Math.floor(A*.3),R=2,X=t.fireDotMultiplier||1;w.burnDamage=Math.floor(D*X),w.burnDuration=R}else if(t.weaponKey==="explosive"){const w=M0(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.explosionRadius,t.explosionDamage,g,f);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}else if(t.weaponKey==="chainLightning"){const w=S0(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.chainRange,t.maxJumps,t.chainDamageReduction,g,f);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}else{const w=Qt(e,t.pos.x,t.pos.y,u,t.projectileSpeed,A,t.piercing||0,t.obstaclePiercing||0,f,g);t.weaponDef&&w.useWeaponVisual(t.weaponDef)}})}),o=i,Np(t)}}}),e.onCollide("projectile","wall",(s,i)=>{e.paused||s.isExplosive||s.piercedObstacles&&s.piercedObstacles.has(i)||(s.obstaclePiercing>0?(s.piercedObstacles&&s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)):e.destroy(s))}),e.onCollide("projectile","cover",(s,i)=>{if(!e.paused&&s.obstaclePiercing>0&&s.piercedObstacles){if(s.piercedObstacles.has(i))return;s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)}}),e.onCollide("projectile","obstacle",(s,i)=>{e.paused||s.isExplosive||s.piercedObstacles&&s.piercedObstacles.has(i)||(s.obstaclePiercing>0?(s.piercedObstacles&&s.piercedObstacles.add(i),s.piercedObstacles.size>(s.obstaclePiercing||0)&&e.destroy(s)):e.destroy(s))}),e.onCollide("projectile","enemy",(s,i)=>{if(e.paused||s.isEnemyProjectile||s.isBossProjectile||s.piercedEnemies&&s.piercedEnemies.has(i))return;u0(),i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),pt()&&Jt()&&gl({targetId:i.mpEntityId,targetType:"enemy",damage:s.damage,isCrit:s.isCrit||!1,x:i.pos.x,y:i.pos.y}),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Po(e,i.pos.x,i.pos.y,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s);const a=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);if(a.len()>0){const h=a.unit(),l=bt.KNOCKBACK_ENEMY_FROM_PROJECTILE;rs(e,i,h,l)}Hi(e,i.pos.x,i.pos.y,a,{isCrit:s.isCrit}),i.color=s.isCrit?e.rgb(...bt.CRIT_COLOR):e.rgb(...bt.HIT_COLOR),e.wait(bt.HIT_FLASH_DURATION,()=>{i.exists()&&(i.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(s,i)=>{e.paused||s.isExplosive&&Ui(e,s,i.pos.x,i.pos.y)}),e.onCollide("projectile","boss",(s,i)=>{if(e.paused||!s.isChainLightning||s.chainedEnemies&&s.chainedEnemies.has(i))return;const a=s.chainJumps||0,r=1-(s.chainDamageReduction||.15)*a,h=Math.floor(s.damage*Math.max(.1,r));i.takeDamage?i.takeDamage(h):i.hurt(h),s.chainedEnemies&&s.chainedEnemies.add(i),e.wait(.01,()=>{s.exists()&&(s.chainJumps<s.maxJumps?Ma(e,s,i):e.destroy(s))})}),e.onCollide("projectile","miniboss",(s,i)=>{if(e.paused||s.isEnemyProjectile||s.isBossProjectile||s.piercedEnemies&&s.piercedEnemies.has(i))return;let a=s.damage;s.isCrit&&(a=Math.floor(a*1.5)),i.takeDamage(a),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Po(e,i.pos.x,i.pos.y,{isCrit:s.isCrit});const r=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);Hi(e,i.pos.x,i.pos.y,r,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s),i.color=s.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("projectile","boss",(s,i)=>{if(e.paused||s.isExplosive||s.isChainLightning||s.piercedEnemies&&s.piercedEnemies.has(i))return;i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.burnDamage&&s.burnDuration&&(i.burnDamage=s.burnDamage,i.burnDuration=s.burnDuration,i.burnTimer=0),Po(e,i.pos.x,i.pos.y,{isCrit:s.isCrit}),s.piercedEnemies&&s.piercedEnemies.add(i),s.piercedEnemies.size>(s.piercing||0)&&e.destroy(s);const a=e.vec2(i.pos.x-s.pos.x,i.pos.y-s.pos.y);if(a.len()>0){const h=a.unit(),l=bt.KNOCKBACK_BOSS_FROM_PROJECTILE;rs(e,i,h,l)}Hi(e,i.pos.x,i.pos.y,a,{isCrit:s.isCrit}),i.color=s.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("enemy","player",(s,i)=>{if(e.paused||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Us();const a=s.damage||bt.BASE_ENEMY_DAMAGE,r=Bi(a,i.defense||0,i.damageReduction||0);if(i.hurt(r),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Po(e,i.pos.x,i.pos.y,{color:[255,100,100]}),s.lifesteal&&s.exists()){const n=s.hp(),c=s.maxHealth;if(n<c){const u=Math.min(c,n+s.lifesteal);s.setHP(u)}}const h=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(h.len()>0){const n=h.unit(),c=bt.KNOCKBACK_ENEMY;rs(e,s,n,c)}i.color=e.rgb(...bt.HIT_COLOR)}),e.onCollide("miniboss","player",(s,i)=>{if(e.paused||i.invulnerable)return;Us();let a=bt.BASE_MINIBOSS_DAMAGE;(s.type==="brute"||s.type==="berserker"||s.type==="guardian")&&s.meleeDamage&&(a=s.meleeDamage);const r=Bi(a,i.defense||0,0);i.hurt(r),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Po(e,i.pos.x,i.pos.y,{color:[255,100,100]});const h=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(h.len()>0){const n=h.unit(),c=bt.KNOCKBACK_MINIBOSS;rs(e,s,n,c)}i.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(s,i)=>{if(e.paused||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Us();let a=bt.BASE_BOSS_DAMAGE;if(s.type==="twinGuardianMelee"&&s.meleeDamage){const n=s.enraged?bt.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;a=s.meleeDamage*n}const r=Bi(a,i.defense||0,i.damageReduction||0);i.hurt(r),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Po(e,i.pos.x,i.pos.y,{color:[255,100,100]});const h=e.vec2(s.pos.x-i.pos.x,s.pos.y-i.pos.y);if(h.len()>0){const n=h.unit(),c=bt.KNOCKBACK_BOSS;rs(e,s,n,c)}i.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(s,i)=>{if(e.paused||!s.isBossProjectile&&!s.isEnemyProjectile||i.invulnerable||i.dodgeChance&&Math.random()<i.dodgeChance)return;Us();const a=s.damage*(1-(i.damageReduction||0)),r=Math.max(1,a-(i.defense||0));i.hurt(r),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Po(e,i.pos.x,i.pos.y,{color:[255,100,100]}),e.destroy(s),i.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(s,i)=>{e.paused||i.exists()&&(s.contactCooldown>0||(i.hurt(s.damage),s.contactCooldown=s.contactCooldownDuration||.2))}),e.onCollide("orbital","boss",(s,i)=>{e.paused||i.exists()&&(s.contactCooldown>0||(i.takeDamage?i.takeDamage(s.damage):i.hurt(s.damage),s.contactCooldown=s.contactCooldownDuration||.2))}),e.onCollide("projectile","enemy",(s,i)=>{e.paused||s.isExplosive&&Ui(e,s,i.pos.x,i.pos.y)}),e.onCollide("projectile","wall",(s,i)=>{e.paused||s.isExplosive&&Ui(e,s,s.pos.x,s.pos.y)}),e.onCollide("projectile","enemy",(s,i)=>{if(e.paused||!s.isChainLightning||s.chainedEnemies&&s.chainedEnemies.has(i))return;const a=s.chainJumps||0,r=1-(s.chainDamageReduction||.15)*a,h=Math.floor(s.damage*Math.max(.1,r));i.takeDamage?i.takeDamage(h):i.hurt(h),s.chainedEnemies&&s.chainedEnemies.add(i),s.chainJumps<s.maxJumps?Ma(e,s,i):e.destroy(s)})}function fn(e,t){var i,a;t.orbitalOrbs||(t.orbitalOrbs=[],t.orbitalAngles=[]);const o=t.projectileCount||1,s=t.orbitRadius||Jo.BASE_ORBIT_RADIUS;for(let r=0;r<o;r++){const h=360/o*r,l=h*Math.PI/180,n=t.pos.x+Math.cos(l)*s,c=t.pos.y+Math.sin(l)*s,u=e.add([e.text(((i=t.weaponDef)==null?void 0:i.char)||"",{size:16}),e.pos(n,c),e.anchor("center"),e.color(...((a=t.weaponDef)==null?void 0:a.color)||[100,200,255]),e.area(),"orbital","playerProjectile"]);u.damage=t.projectileDamage||12,u.contactCooldown=0,u.contactCooldownDuration=Jo.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(u),t.orbitalAngles.push(h)}}function E0(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(a=>{a.exists()&&a.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],fn(e,t),t.orbitalNeedsReinit=!1);const o=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==o)&&fn(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const s=t.rotationSpeed||Jo.BASE_ROTATION_SPEED,i=t.orbitRadius||Jo.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((a,r)=>{if(!a.exists())return;t.orbitalAngles[r]=(t.orbitalAngles[r]+s*e.dt())%360;const h=t.orbitalAngles[r]*Math.PI/180;a.pos.x=t.pos.x+Math.cos(h)*i,a.pos.y=t.pos.y+Math.sin(h)*i,a.contactCooldown>0&&(a.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(a=>a.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function M0(e,t,o,s,i,a,r,h,l,n=!1){const c=Qt(e,t,o,s,i,a,0,0,n,l);return c.isExplosive=!0,c.explosionRadius=r||50,c.explosionDamage=h||15,c}function S0(e,t,o,s,i,a,r,h,l,n,c=!1){const u=Qt(e,t,o,s,i,a,0,0,c,n);return u.isChainLightning=!0,u.chainRange=r||70,u.maxJumps=h||3,u.chainDamageReduction=l||.15,u.chainJumps=0,u.chainedEnemies=new Set,u}function Ui(e,t,o,s){if(!t.exists())return;El();const i=t.explosionRadius||50,a=t.explosionDamage||15,r=e.get("enemy"),h=e.get("boss"),l=[...r,...h];for(const c of l){if(!c.exists())continue;e.vec2(c.pos.x-o,c.pos.y-s).len()<=i&&(c.takeDamage?c.takeDamage(a):c.hurt(a))}const n=e.add([e.text("*",{size:24}),e.pos(o,s),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{n.exists()&&e.destroy(n)}),e.destroy(t)}function Ma(e,t,o){if(!t.exists())return;const s=t.chainRange||70,i=e.get("enemy"),a=e.get("boss"),r=[...i,...a];let h=null,l=s;for(const n of r){if(!n.exists()||n===o||t.chainedEnemies&&t.chainedEnemies.has(n))continue;const c=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y).len();c<=s&&c<l&&(h=n,l=c)}if(h){t.chainJumps=(t.chainJumps||0)+1;const n=e.add([e.line(o.pos,h.pos,2),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{n.exists()&&e.destroy(n)}),t.pos.x=h.pos.x,t.pos.y=h.pos.y}else e.destroy(t)}const Ue={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10},Qo={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${Ue.damage})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.damage)||0,o=e.baseProjectileDamage||((a=e.weaponDef)==null?void 0:a.baseDamage)||10,s=Math.pow(1.25,t);e.projectileDamage=Math.floor(o*s)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${Ue.fireRate})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.fireRate)||0,o=e.baseFireRate||((a=e.weaponDef)==null?void 0:a.fireRate)||1.5,s=Math.pow(1.2,t);e.fireRate=o*s}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${Ue.speed})`:""}`,apply:e=>{var i,a,r;const t=((i=e.upgradeStacks)==null?void 0:i.speed)||0,o=((r=(a=e.characterData)==null?void 0:a.stats)==null?void 0:r.speed)||150,s=Math.pow(1.15,t);e.speed=Math.floor(o*s),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${Ue.health})`:""}`,apply:e=>{var r,h,l;const t=((r=e.upgradeStacks)==null?void 0:r.health)||0,o=((l=(h=e.characterData)==null?void 0:h.stats)==null?void 0:l.health)||100,s=t*20,i=e.maxHealth;e.maxHealth=o+s;const a=e.maxHealth-i;a>0&&e.setHP(e.hp()+a)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${Ue.projectileSpeed})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.projectileSpeed)||0,o=e.baseProjectileSpeed||((a=e.weaponDef)==null?void 0:a.projectileSpeed)||300,s=Math.pow(1.25,t);e.projectileSpeed=Math.floor(o*s)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${Ue.xpGain})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.xpGain)||0,o=((i=e.characterData)==null?void 0:i.ability)==="xpBoost"?1.1:1;e.xpMultiplier=o+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${Ue.pickupRadius})`:""}`,apply:e=>{var i;const t=((i=e.upgradeStacks)==null?void 0:i.pickupRadius)||0,o=30,s=Math.pow(1.5,t);e.pickupRadius=Math.floor(o*s)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${Ue.multiShot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.multiShot)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||1;e.projectileCount=o+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${Ue.piercing})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.piercing)||0,o=((i=e.weaponDef)==null?void 0:i.piercing)||0;e.piercing=o+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${Ue.obstaclePiercing})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.obstaclePiercing)||0,o=((i=e.weaponDef)==null?void 0:i.obstaclePiercing)||0;e.obstaclePiercing=o+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${Ue.critChance})`:""}`,apply:e=>{var i,a,r;const t=((i=e.upgradeStacks)==null?void 0:i.critChance)||0;let s=(((a=e.weaponDef)==null?void 0:a.critChance)||.05)+t*.1;((r=e.characterData)==null?void 0:r.ability)==="critBoost"&&(s*=1.5),e.critChance=s}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${Ue.critDamage})`:""}`,apply:e=>{var i,a,r;const t=((i=e.upgradeStacks)==null?void 0:i.critDamage)||0;let s=(((a=e.weaponDef)==null?void 0:a.critDamage)||2)+t*.5;((r=e.characterData)==null?void 0:r.ability)==="critBoost"&&(s*=1.25),e.critDamage=s}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${Ue.spreadShot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.spreadShot)||0,o=((i=e.weaponDef)==null?void 0:i.spreadAngle)||0;e.spreadAngle=o+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${Ue.pelletCount})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.pelletCount)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||3;e.projectileCount=o+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${Ue.range})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.range)||0,o=((a=e.weaponDef)==null?void 0:a.range)||600,s=Math.pow(1.25,t);e.weaponRange=Math.floor(o*s)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${Ue.dot})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.dot)||0,o=((i=e.characterData)==null?void 0:i.ability)==="fireDot"?1.25:1;e.fireDotMultiplier=o+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${Ue.orbitalCount})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.orbitalCount)||0,o=((i=e.weaponDef)==null?void 0:i.projectileCount)||1;e.projectileCount=o+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${Ue.orbitalSpeed})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.orbitalSpeed)||0,o=((a=e.weaponDef)==null?void 0:a.rotationSpeed)||180,s=Math.pow(1.5,t);e.rotationSpeed=o*s}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${Ue.orbitalRadius})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.orbitalRadius)||0,o=((a=e.weaponDef)==null?void 0:a.orbitRadius)||45,s=Math.pow(1.2,t);e.orbitRadius=Math.floor(o*s)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${Ue.explosionRadius})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.explosionRadius)||0,o=((a=e.weaponDef)==null?void 0:a.explosionRadius)||50,s=Math.pow(1.25,t);e.explosionRadius=Math.floor(o*s)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${Ue.explosionDamage})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.explosionDamage)||0,o=((a=e.weaponDef)==null?void 0:a.explosionDamage)||15,s=Math.pow(1.25,t);e.explosionDamage=Math.floor(o*s)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${Ue.chainJumps})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.chainJumps)||0,o=((i=e.weaponDef)==null?void 0:i.maxJumps)||3;e.maxJumps=o+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${Ue.chainRange})`:""}`,apply:e=>{var i,a;const t=((i=e.upgradeStacks)==null?void 0:i.chainRange)||0,o=((a=e.weaponDef)==null?void 0:a.chainRange)||70,s=Math.pow(1.25,t);e.chainRange=Math.floor(o*s)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${Ue.chainDamage})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.chainDamage)||0,o=((i=e.weaponDef)==null?void 0:i.chainDamageReduction)||.15;e.chainDamageReduction=Math.max(.05,o-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${Ue.defense})`:""}`,apply:e=>{var s,i;const t=((s=e.upgradeStacks)==null?void 0:s.defense)||0,o=((i=e.characterData)==null?void 0:i.ability)==="tankStats"?.15:0;e.defense=o+t*2}}};function R0(e,t){var o,s,i;if(e.category==="passive"){const a=((o=t.upgradeStacks)==null?void 0:o[e.key])||0,r=e.maxStacks||Ue[e.key]||10;return!(a>=r)}if(e.category==="weapon"){const a=((s=t.upgradeStacks)==null?void 0:s[e.key])||0,r=e.maxStacks||Ue[e.key]||10;if(a>=r)return!1;const h=((i=t.characterData)==null?void 0:i.weapon)||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(h):e.upgradeCategory?yp(h,e.upgradeCategory):!0}return!0}function D0(e=3,t=null,o=null){let i=Object.keys(Qo).map(l=>({key:l,...Qo[l],type:"upgrade"})),a=i;t&&(a=i.filter(l=>R0(l,t))),a.length<e&&(a=i);const r=[],h=new Set;for(;r.length<e&&r.length<a.length;){const l=o?o.range(0,a.length):Math.floor(Math.random()*a.length),n=a[l];h.has(n.key)||(h.add(n.key),r.push(n))}return r}function T0(e,t){const o=Qo[t];o&&(o.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,Ml(e))}function Ml(e){Object.keys(Qo).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&Qo[t].apply(e)})}function C0(e,t){var o;if(!e)return"";if(e.getDescription){const s=((o=t==null?void 0:t.upgradeStacks)==null?void 0:o[e.key])||0;return e.getDescription(s)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const I0={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}}};function P0(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function Sl(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const o=[];for(const[s,i]of Object.entries(I0))i.required.every(r=>t.selectedUpgrades.has(r))&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(s)||(i.apply(t),t.activeSynergies.add(s),o.push(i),B0(e,i)));return o}function B0(e,t){const o=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),s=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{o.exists()&&(e.destroy(o),e.destroy(s))})}const Q={TITLE:36,HEADER:24,LABEL:18,BODY:16,SMALL:14,BUTTON:20,HUD:16},I={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},O0={BUTTON_VERTICAL:65},Go={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},Oo={HEALTH:"HP",FLOOR:"Floor",ROOM:"Room",DAMAGE:"Damage",SPEED:"Speed"};function fo(e){return e.toUpperCase()}function L0(e,t){return`${e}/${t}`}const P={BACKGROUND:0,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1e3},ls=["$","","","","","","",""];function bi(e,t={}){const{patternCount:o=12,particleCount:s=20,includeCursorFollowers:i=!1}=t,a=["","","","","","","",""];for(let r=0;r<o;r++){const h=e.add([e.text(a[Math.floor(Math.random()*a.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...I.BG_LIGHT),e.opacity(.15),e.z(P.PARTICLES)]);h.pulseTime=Math.random()*Math.PI*2,h.pulseSpeed=1+Math.random()*2,h.onUpdate(()=>{h.pulseTime+=e.dt()*h.pulseSpeed;const l=.8+Math.sin(h.pulseTime)*.3;h.scale=e.vec2(l,l),h.opacity=.1+Math.abs(Math.sin(h.pulseTime))*.15})}for(let r=0;r<s;r++){const h=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...I.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(P.PARTICLES)]);h.speed=10+Math.random()*20,h.onUpdate(()=>{h.pos.y+=h.speed*e.dt(),h.pos.y>e.height()&&(h.pos.y=0,h.pos.x=Math.random()*e.width())})}if(i){const r=[];e.loop(5,()=>{if(r.length<3&&Math.random()<.3){const h=["","","","","","",""],l=e.add([e.text(h[Math.floor(Math.random()*h.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(P.PARTICLES)]);l.followSpeed=20+Math.random()*30,l.rotationSpeed=50+Math.random()*100,l.lifetime=15+Math.random()*10,l.onUpdate(()=>{const c=e.mousePos().sub(l.pos),u=c.len();if(u>5){const d=c.scale(1/u);l.pos=l.pos.add(d.scale(l.followSpeed*e.dt()))}if(l.angle+=l.rotationSpeed*e.dt(),l.lifetime-=e.dt(),l.lifetime<=0){e.destroy(l);const d=r.indexOf(l);d>-1&&r.splice(d,1)}}),r.push(l)}})}}function Un(e,t,o){const s=()=>2+Math.random()*3,i=e.add([e.text(`${ls[0]}: ${t}`,{size:Q.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),a=i.width+30,r=40;e.destroy(i);const h=e.add([e.rect(a,r),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.GOLD)),e.fixed(),e.z(P.UI_BACKGROUND)]),l=e.add([e.text(`${ls[0]}: ${t}`,{size:Q.LABEL}),e.pos(e.width()-20-a/2,40),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.UI_TEXT)]);l.symbolIndex=0,l.timeSinceLastChange=0,l.currentCurrency=t,l.symbolChangeInterval=s();const n=c=>{l.currentCurrency=c,l.text=`${ls[l.symbolIndex]}: ${c}`;const u=l.width+30;Math.abs(u-a)>10&&(h.width=u,l.pos.x=e.width()-20-u/2)};return l.onUpdate(()=>{l.timeSinceLastChange+=e.dt(),l.timeSinceLastChange>=l.symbolChangeInterval&&(l.timeSinceLastChange=0,l.symbolIndex=(l.symbolIndex+1)%ls.length,l.text=`${ls[l.symbolIndex]}: ${l.currentCurrency}`,l.symbolChangeInterval=s())}),{panel:h,text:l,updateCurrency:n}}let ho=!1;function z0(e,t,o){if(ho)return;ho=!0,e.paused=!0,e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()));let s=null;if(pt()){const f=t.playerIndex!==void 0?t.playerIndex:0,A=t.level||1;s=yl(f,A)}const i=D0(3,t,s);console.log("Creating upgrade draft with",i.length,"upgrades"),e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...I.BG_DARK),e.opacity(.9),e.fixed(),e.z(P.MODAL),"upgradeOverlay"]),e.add([e.text("Level Up! Choose an Upgrade",{size:Q.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...I.WARNING),e.fixed(),e.z(P.MODAL+1),"upgradeUI"]),console.log("Title created at",e.width()/2,80);const a=200,r=150,h=250,l=e.width()/2-h*(i.length-1)/2,n=e.height()/2;i.forEach((f,A)=>{const g=l+A*h,w=e.add([e.rect(a,r),e.pos(g,n),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.BORDER)),e.fixed(),e.z(P.MODAL+1),e.area(),"upgradeUI","upgradeCard"]);if(f.icon){const R=f.category==="passive"?I.SUCCESS:f.weaponKey?I.WARNING:I.INFO;e.add([e.text(f.icon,{size:48}),e.pos(g,n-50),e.anchor("center"),e.color(...R),e.fixed(),e.z(P.MODAL+2),"upgradeUI"])}e.add([e.text(f.name,{size:Q.BUTTON,width:a-20}),e.pos(g,n-5),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.MODAL+2),"upgradeUI"]);const D=C0(f,t);e.add([e.text(D,{size:Q.BODY,width:a-20}),e.pos(g,n+30),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.MODAL+2),"upgradeUI"]),e.add([e.text(`${A+1}`,{size:Q.HEADER}),e.pos(g+a/2-20,n-r/2+15),e.anchor("center"),e.color(...I.WARNING),e.fixed(),e.z(P.MODAL+2),"upgradeUI"]),w.onClick(()=>{ho&&c(A)})});function c(f){if(!ho)return;const A=i[f];m0(),ho=!1,T0(t,A.key),P0(t,A.key),Sl(e,t),e.get("upgradeUI").forEach(g=>e.destroy(g)),e.get("upgradeOverlay").forEach(g=>e.destroy(g)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.paused=!1,e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{o&&o(A)})}const u=()=>{ho&&i.length>=1&&c(0)},d=()=>{ho&&i.length>=2&&c(1)},x=()=>{ho&&i.length>=3&&c(2)};e.onKeyPress("1",u),e.onKeyPress("2",d),e.onKeyPress("3",x)}function Sa(){return ho}function N0(e,t,o=null,s=!1){let i=!1;t.addXP=function(r){if(e.paused||i)return;const h=t.xpMultiplier||1,l=Math.floor(r*h);for(t.xp+=l;t.xp>=t.xpToNext&&!i&&t.xpToNext>0;){i=!0,t.xp-=t.xpToNext,t.level++;const n=t.level;t.xpToNext=Math.max(1,Math.floor(t.xpToNext*so.XP_SCALING_FACTOR)),a(e,t,n)}};function a(r,h,l){if(r.paused&&!s){i=!1;return}f0(),o&&o();const n=r.add([r.text(`Level ${l}!`,{size:24}),r.pos(r.width()/2,so.LEVEL_UP_NOTIFICATION_Y),r.anchor("center"),r.color(255,255,100),r.fixed(),r.z(1e3)]);s?r.wait(so.LEVEL_UP_NOTIFICATION_DURATION*2,()=>{n.exists()&&r.destroy(n),i=!1}):r.wait(so.LEVEL_UP_NOTIFICATION_DURATION,()=>{r.destroy(n),z0(r,h,()=>{i=!1})})}}const H0={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:20,turret:15,heavyTank:20,zippy:20,exploder:25},3:{mage:20,shieldBearer:15,golem:15,wraith:15,spawner:15,buffer:20,orbiter:10},4:{healer:25,teleporter:20,freezer:25,leech:30}};function U0(){return{basic:15,rusher:25,tank:30,fast:30}}function _0(e){const t=Object.values(e).reduce((s,i)=>s+i,0);let o=Math.random()*t;for(const[s,i]of Object.entries(e))if(o-=i,o<=0)return s;return Object.keys(e)[0]}function gn(e=1){const t=H0[e]||U0();return _0(t)}const q0=800,F0=600,qs=20;let Ks=null;const Ra={empty:{name:"Empty Room",obstacles:[],spawnDoors:null},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],spawnDoors:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],spawnDoors:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],spawnDoors:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],spawnDoors:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],spawnDoors:null}};function Y0(e,t,o,s){const i=o/2,a=s/2,r=qs+i,h=q0-qs-i,l=qs+a,n=F0-qs-a,c=Math.max(r,Math.min(h,e)),u=Math.max(l,Math.min(n,t));return{x:c,y:u}}function X0(e,t){const o=Math.max(150-t*5,100);return{wallColor:e.rgb(Math.floor(o*.6),Math.floor(o*.4),Math.floor(o*.5)),obstacleColor:e.rgb(Math.floor(o*.7),Math.floor(o*.5),Math.floor(o*.6)),coverColor:e.rgb(Math.floor(o*.8),Math.floor(o*.6),Math.floor(o*.7))}}function Rl(e,t=null){const o=Object.keys(Ra),s=Ks?o.filter(h=>h!==Ks):o,i=s.length>0?s:o,a=t?t.range(0,i.length):Math.floor(Math.random()*i.length),r=i[a];return Ks=r,{key:r,...Ra[r]}}function G0(){Ks=null}const Ai={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1},floor10:{id:"floor10",name:"Floor 10 Reached",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies",category:"combat",icon:"",unlocked:!1},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies",category:"combat",icon:"",unlocked:!1},kill1000:{id:"kill1000",name:"Genocide",description:"Kill 1000 enemies",category:"combat",icon:"",unlocked:!1},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses",category:"boss",icon:"",unlocked:!1},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1},earn100:{id:"earn100",name:"Rich",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1},earn500:{id:"earn500",name:"Wealthy",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1},earn1000:{id:"earn1000",name:"Millionaire",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1}};function V0(e){return Object.values(Ai).filter(t=>t.category===e)}function K0(){const e=new Set;return Object.values(Ai).forEach(t=>e.add(t.category)),Array.from(e)}function j0(e){const t=$r(),o=[];return t.bestFloor>=2&&!rt("floor2")&&lt("floor2")&&o.push("floor2"),t.bestFloor>=3&&!rt("floor3")&&lt("floor3")&&o.push("floor3"),t.bestFloor>=5&&!rt("floor5")&&lt("floor5")&&o.push("floor5"),t.bestFloor>=10&&!rt("floor10")&&lt("floor10")&&o.push("floor10"),t.totalEnemiesKilled>=1&&!rt("firstKill")&&lt("firstKill")&&o.push("firstKill"),t.totalEnemiesKilled>=100&&!rt("kill100")&&lt("kill100")&&o.push("kill100"),t.totalEnemiesKilled>=500&&!rt("kill500")&&lt("kill500")&&o.push("kill500"),t.totalEnemiesKilled>=1e3&&!rt("kill1000")&&lt("kill1000")&&o.push("kill1000"),t.totalBossesKilled>=1&&!rt("firstBoss")&&lt("firstBoss")&&o.push("firstBoss"),t.totalBossesKilled>=5&&!rt("boss5")&&lt("boss5")&&o.push("boss5"),t.totalRuns>=1&&!rt("firstRun")&&lt("firstRun")&&o.push("firstRun"),t.totalRuns>=10&&!rt("run10")&&lt("run10")&&o.push("run10"),t.totalRuns>=50&&!rt("run50")&&lt("run50")&&o.push("run50"),t.bestLevel>=10&&!rt("level10")&&lt("level10")&&o.push("level10"),t.bestLevel>=20&&!rt("level20")&&lt("level20")&&o.push("level20"),t.totalCurrencyEarned>=100&&!rt("earn100")&&lt("earn100")&&o.push("earn100"),t.totalCurrencyEarned>=500&&!rt("earn500")&&lt("earn500")&&o.push("earn500"),t.totalCurrencyEarned>=1e3&&!rt("earn1000")&&lt("earn1000")&&o.push("earn1000"),o.length>0&&e&&o.forEach((s,i)=>{const a=Ai[s];a&&e.wait(i*.5,()=>{W0(e,a)})}),o}function W0(e,t){y0();const o=e.add([e.text("Achievement Unlocked!",{size:20}),e.pos(e.width()/2,e.height()/2-40),e.anchor("center"),e.color(255,255,100),e.fixed(),e.z(3e3)]),s=e.add([e.text(`${t.icon} ${t.name}`,{size:24}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(3e3)]),i=e.add([e.text(t.description,{size:16}),e.pos(e.width()/2,e.height()/2+30),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(3e3)]);e.wait(3,()=>{o.exists()&&e.destroy(o),s.exists()&&e.destroy(s),i.exists()&&e.destroy(i)})}class Fs{constructor(t,o,s="combat"){this.position={x:t,y:o},this.type=s,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=s==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:o,y:s}=this.position;switch(t){case"up":return{x:o,y:s-1};case"down":return{x:o,y:s+1};case"right":return{x:o+1,y:s};default:return null}}}class $0{constructor(t,o=6,s=3,i=null){this.floor=t,this.width=o,this.height=s,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.rng=i,this.generate()}random(){return this.rng?this.rng.next():Math.random()}randomRange(t,o){return this.rng?this.rng.range(t,o):Math.floor(Math.random()*(o-t))+t}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const o=this.height===1?0:this.randomRange(0,this.height);this.bossPosition={x:this.width-1,y:o};const s=new Fs(0,t,"start");this.setRoom(0,t,s);const i=new Fs(this.width-1,o,"boss");this.setRoom(this.width-1,o,i),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const o of t)if(!this.getRoom(o.x,o.y)){const s=new Fs(o.x,o.y,"combat");this.setRoom(o.x,o.y,s)}}findPath(t,o){const s=[];let i={...t};for(;i.x<o.x||i.y!==o.y;)s.push({...i}),i.x<o.x?i.y!==o.y&&this.random()<.3?i.y+=i.y<o.y?1:-1:i.x+=1:i.y+=i.y<o.y?1:-1;return s.push({...o}),s}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let o=0;for(let s=1;s<this.width-1;s++)for(let i=0;i<this.height&&!(o>=t);i++){if(this.getRoom(s,i))continue;if(s>0&&this.getRoom(s-1,i)&&this.random()<.5){const r=new Fs(s,i,"combat");this.setRoom(s,i,r),o++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const s=this.getRoom(t,o);s&&(t<this.width-1&&this.getRoom(t+1,o)&&(s.connections.right=!0),o>0&&this.getRoom(t,o-1)&&(s.connections.up=!0),o<this.height-1&&this.getRoom(t,o+1)&&(s.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const s=this.getRoom(t,o);if(s&&(s.type!=="boss"&&(s.template=Rl(this.floor,this.rng)),s.type==="combat")){const i=this.randomRange(3,6);s.enemyTypes=[];for(let a=0;a<i;a++)s.enemyTypes.push(gn(this.floor))}}}validate(){const t=new Set,o=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);o.length>0;){const s=o.shift(),i=this.getRoom(s.x,s.y);if(!i)continue;if(i.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const a=["up","down","right"];for(const r of a)if(i.connections[r]){const h=i.getAdjacentPosition(r),l=`${h.x},${h.y}`;t.has(l)||(t.add(l),o.push(h))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,o){return t<0||t>=this.width||o<0||o>=this.height?null:this.grid[o][t]}setRoom(t,o,s){t<0||t>=this.width||o<0||o>=this.height||(this.grid[o][t]=s,this.rooms.set(s.getKey(),s))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const o=[],s=["up","down","right"];for(const i of s)if(t.connections[i]){const a=t.getAdjacentPosition(i),r=this.getRoom(a.x,a.y);r&&!r.visited&&o.push({direction:i,position:a,room:r})}return o}markRoomVisited(t,o){const s=this.getRoom(t,o);s&&(s.visited=!0,this.visitedRooms.add(s.getKey()))}markRoomCleared(t,o){const s=this.getRoom(t,o);s&&(s.cleared=!0)}moveToRoom(t){const o=this.getCurrentRoom();if(!o||!o.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const s=o.getAdjacentPosition(t);return this.getRoom(s.x,s.y)?(this.currentPosition=s,this.markRoomVisited(s.x,s.y),console.log(`[FloorMap] Moved to room (${s.x}, ${s.y})`),!0):(console.warn(`[FloorMap] No room found at ${s.x}, ${s.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let o=0;o<this.height;o++){const s=[];for(let i=0;i<this.width;i++){const a=this.getRoom(i,o);a?i===this.currentPosition.x&&o===this.currentPosition.y?s.push({type:"current",room:a}):a.visited?s.push({type:"visited",room:a}):this.isRoomRevealed(i,o)?s.push({type:"revealed",room:a}):s.push({type:"hidden"}):s.push({type:"empty"})}t.push(s)}return t}isRoomRevealed(t,o){if(!this.getRoom(t,o))return!1;const i=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:a,dy:r}of i){const h=this.getRoom(t+a,o+r);if(h&&h.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let o="";for(let s=0;s<this.width;s++){const i=this.getRoom(s,t);i?i.type==="start"?o+="[S]":i.type==="boss"?o+="[B]":s===this.currentPosition.x&&t===this.currentPosition.y?o+="[]":i.visited?o+="[]":o+="[R]":o+="[ ]",o+=" "}console.log(o)}console.log(`
Connections:`);for(const[t,o]of this.rooms){const s=[];o.connections.up&&s.push(""),o.connections.down&&s.push(""),o.connections.right&&s.push(""),console.log(`  (${o.position.x}, ${o.position.y}): ${s.join(", ")||"none"}`)}}}function J0(e,t=null){const o=Math.min(5+Math.floor(e/3),8),s=Math.min(3+Math.floor(e/5),5),i=new $0(e,o,s,t);return i.debugPrint(),i}const wo={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"};class Q0{constructor(t,o){this.k=t,this.floorMap=o,this.mode=wo.MINIMIZED,this.elements=[],this.buttonPos={x:t.width()-50,y:70},this.openPos={x:t.width()-120,y:70},this.maximizedPos={x:t.width()-250,y:70},this.render()}toggle(){try{mt()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===wo.MINIMIZED?this.mode=wo.OPEN:this.mode===wo.OPEN?this.mode=wo.MAXIMIZED:this.mode=wo.MINIMIZED,this.k.wait(0,()=>{this.update()})}update(){this.clear(),this.render()}clear(){this.elements.forEach(t=>{t.exists()&&this.k.destroy(t)}),this.elements=[]}render(){this.mode===wo.MINIMIZED?this.renderMinimized():this.mode===wo.OPEN?this.renderOpen():this.renderMaximized()}renderMinimized(){const{x:t,y:o}=this.buttonPos,s=40,i=this.k.add([this.k.rect(s,s),this.k.pos(t,o),this.k.anchor("center"),this.k.color(30,30,50),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);i.onClick(()=>this.toggle()),this.elements.push(i);const a=this.k.add([this.k.text("",{size:24}),this.k.pos(t,o),this.k.anchor("center"),this.k.color(150,180,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(a);const r=this.k.add([this.k.text(`${this.floorMap.floor}`,{size:10}),this.k.pos(t+12,o-12),this.k.anchor("center"),this.k.color(255,255,100),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(r)}renderOpen(){const{x:t,y:o}=this.openPos,s=12,i=this.floorMap.getGridForMinimap(),a=this.k.add([this.k.rect(140,80),this.k.pos(t-10,o-10),this.k.anchor("topleft"),this.k.color(20,20,30),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);a.onClick(()=>this.toggle()),this.elements.push(a);const r=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t+60,o),this.k.anchor("center"),this.k.color(200,200,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(r);const h=o+15;for(let c=0;c<i.length;c++)for(let u=0;u<i[c].length;u++){const d=i[c][u],x=t+u*s,f=h+c*s;let A="",g=[100,100,100];switch(d.type){case"current":A="",g=[255,255,100];break;case"visited":A=d.room.isBossRoom?"B":"",g=d.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":A=d.room.isBossRoom?"B":"",g=d.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":A="",g=[60,60,80];break;case"empty":A=" ";break}if(A!==" "){const w=this.k.add([this.k.text(A,{size:10}),this.k.pos(x,f),this.k.anchor("topleft"),this.k.color(...g),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(w)}}const l=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:9}),this.k.pos(t+60,o+65),this.k.anchor("center"),this.k.color(180,180,180),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(l);const n=this.k.add([this.k.text("(click to expand)",{size:8}),this.k.pos(t+60,o+75),this.k.anchor("center"),this.k.color(120,120,140),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(n)}renderMaximized(){const{x:t,y:o}=this.maximizedPos,s=18,i=this.floorMap.getGridForMinimap(),a=Math.max(220,i[0].length*s+40),r=Math.max(180,i.length*s+100),h=this.k.add([this.k.rect(a,r),this.k.pos(t,o),this.k.anchor("topleft"),this.k.color(15,15,25),this.k.outline(3,this.k.rgb(100,150,255)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);h.onClick(()=>this.toggle()),this.elements.push(h);const l=this.k.add([this.k.rect(a,30),this.k.pos(t,o),this.k.anchor("topleft"),this.k.color(30,30,50),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(l);const n=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor} - ROOM ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:12}),this.k.pos(t+a/2,o+15),this.k.anchor("center"),this.k.color(200,220,255),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(n);const c=t+20,u=o+50;for(let A=0;A<i.length;A++)for(let g=0;g<i[A].length;g++){const w=i[A][g],D=c+g*s,R=u+A*s;let X=[30,30,40],_=[50,50,60];if(w.type!=="empty"){const b=this.k.add([this.k.rect(s-2,s-2),this.k.pos(D,R),this.k.anchor("topleft"),this.k.color(...X),this.k.outline(1,this.k.rgb(..._)),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(b)}let p="",y=[100,100,100];switch(w.type){case"current":p="",y=[255,255,100];break;case"visited":p=w.room.isBossRoom?"B":"",y=w.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":p=w.room.isBossRoom?"B":"",y=w.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":p="",y=[80,80,100];break}if(p){const b=this.k.add([this.k.text(p,{size:14}),this.k.pos(D+s/2,R+s/2),this.k.anchor("center"),this.k.color(...y),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(b)}}const d=u+i.length*s+20;[{char:"",label:"Current Room",color:[255,255,100]},{char:"",label:"Cleared Room",color:[100,255,100]},{char:"",label:"Available Room",color:[150,150,150]},{char:"B",label:"Boss Room",color:[255,100,100]}].forEach((A,g)=>{const w=t+20,D=d+g*15,R=this.k.add([this.k.text(A.char,{size:10}),this.k.pos(w,D),this.k.anchor("topleft"),this.k.color(...A.color),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(R);const X=this.k.add([this.k.text(A.label,{size:9}),this.k.pos(w+20,D),this.k.anchor("topleft"),this.k.color(180,180,200),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(X)});const f=this.k.add([this.k.text("(click to minimize)",{size:9}),this.k.pos(t+a/2,o+r-10),this.k.anchor("center"),this.k.color(120,120,140),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(f)}destroy(){this.clear()}}function Z0(e,t){return new Q0(e,t)}const Da={city:{name:"Urban Streets",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.15},{char:"",pattern:"vertical_lines",density:"low",opacity:.12},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"random",count:8,opacity:.1},{char:"",pattern:"random",count:8,opacity:.1}],baseColor:[60,60,70]},mechanical:{name:"Industrial Complex",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.12},{char:"",pattern:"grid",spacing:80,opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.18},{char:"",pattern:"scattered",count:3,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"edges",count:12,opacity:.14}],baseColor:[70,65,60]},futuristic:{name:"Cyber Station",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.13},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.13},{char:"",pattern:"grid",spacing:100,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.15},{char:"",pattern:"corners",opacity:.18},{char:"",pattern:"scattered",count:6,opacity:.14}],baseColor:[55,65,80]},alien:{name:"Alien Vessel",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.12},{char:"~",pattern:"random",count:15,opacity:.1},{char:"",pattern:"scattered",count:4,opacity:.16},{char:"",pattern:"grid",spacing:120,opacity:.13},{char:"",pattern:"corners",opacity:.17},{char:"",pattern:"scattered",count:5,opacity:.14}],baseColor:[65,55,75]}};function k0(e){for(const[t,o]of Object.entries(Da))if(o.floors.includes(e))return{key:t,...o};return{key:"city",...Da.city}}function ef(e,t,o=800,s=600){const i=k0(t),a=[],r=30;return i.decorations.forEach(h=>{const l=i.baseColor,n=e.rgb(l[0]+(Math.random()-.5)*20,l[1]+(Math.random()-.5)*20,l[2]+(Math.random()-.5)*20);switch(h.pattern){case"horizontal_lines":{const c=h.density==="high"?40:h.density==="medium"?80:120;for(let u=r;u<s-r;u+=c)a.push({char:h.char,x:o/2,y:u+(Math.random()-.5)*20,color:n,opacity:h.opacity,size:12});break}case"vertical_lines":{const c=h.density==="high"?40:h.density==="medium"?80:120;for(let u=r;u<o-r;u+=c)a.push({char:h.char,x:u+(Math.random()-.5)*20,y:s/2,color:n,opacity:h.opacity,size:12});break}case"wavy_lines":{for(let u=r;u<s-r;u+=60)for(let d=r;d<o-r;d+=40)a.push({char:h.char,x:d+Math.sin(u*.05)*15,y:u,color:n,opacity:h.opacity,size:10});break}case"grid":{const c=h.spacing||80;for(let u=r;u<s-r;u+=c)for(let d=r;d<o-r;d+=c)a.push({char:h.char,x:d+(Math.random()-.5)*10,y:u+(Math.random()-.5)*10,color:n,opacity:h.opacity,size:14});break}case"scattered":{const c=h.count||5;for(let u=0;u<c;u++)a.push({char:h.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(s-r*2),color:n,opacity:h.opacity,size:16});break}case"random":{const c=h.count||10;for(let u=0;u<c;u++)a.push({char:h.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(s-r*2),color:n,opacity:h.opacity,size:10+Math.random()*6});break}case"corners":{[{x:r+40,y:r+40},{x:o-r-40,y:r+40},{x:r+40,y:s-r-40},{x:o-r-40,y:s-r-40}].forEach(u=>{a.push({char:h.char,x:u.x,y:u.y,color:n,opacity:h.opacity,size:18})});break}case"edges":{const c=h.count||8,u=Math.floor(c/4);for(let d=0;d<u;d++)a.push({char:h.char,x:o/u*d+o/(u*2),y:r+20,color:n,opacity:h.opacity,size:12});for(let d=0;d<u;d++)a.push({char:h.char,x:o/u*d+o/(u*2),y:s-r-20,color:n,opacity:h.opacity,size:12});for(let d=0;d<u;d++)a.push({char:h.char,x:r+20,y:s/u*d+s/(u*2),color:n,opacity:h.opacity,size:12});for(let d=0;d<u;d++)a.push({char:h.char,x:o-r-20,y:s/u*d+s/(u*2),color:n,opacity:h.opacity,size:12});break}}}),a}function tf(e,t,o=800,s=600){ef(e,t,o,s).forEach(a=>{e.add([e.text(a.char,{size:a.size}),e.pos(a.x,a.y),e.color(a.color),e.opacity(a.opacity),e.z(0),"floorDecoration"])})}class ii{constructor(t,o){this.playerId=t,this.characterKey=o,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=so.STARTING_LEVEL,this.xp=so.STARTING_XP,this.xpToNext=so.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,velocityX:this.velocityX,velocityY:this.velocityY,health:this.health,maxHealth:this.maxHealth,speed:this.speed,level:this.level,xp:this.xp,xpToNext:this.xpToNext,xpMultiplier:this.xpMultiplier,weaponKey:this.weaponKey,fireRate:this.fireRate,projectileSpeed:this.projectileSpeed,projectileDamage:this.projectileDamage,projectileCount:this.projectileCount,piercing:this.piercing,obstaclePiercing:this.obstaclePiercing,critChance:this.critChance,critDamage:this.critDamage,spreadAngle:this.spreadAngle,weaponRange:this.weaponRange,pickupRadius:this.pickupRadius,defense:this.defense,damageReduction:this.damageReduction,dodgeChance:this.dodgeChance,invulnerable:this.invulnerable,invulnerableTime:this.invulnerableTime,slowed:this.slowed,isDead:this.isDead,weapons:this.weapons,passiveUpgrades:this.passiveUpgrades,upgradeStacks:this.upgradeStacks}}static fromJSON(t){const o=new ii(t.playerId,t.characterKey);return Object.assign(o,t),o}}class ni{constructor(t,o,s,i,a={}){this.id=t,this.type=o,this.x=s,this.y=i,this.data=a,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new ni(t.id,t.type,t.x,t.y,t.data)}}class ai{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,o){const s=new ii(t,o);return this.players.set(t,s),this.localPlayerId===null&&(this.localPlayerId=t),s}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,o,s,i={}){const a=this.generateEntityId(),r=new ni(a,t,o,s,i);return this.entities.set(a,r),r}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(o=>o.type===t&&!o.removed)}removeEntity(t){const o=this.entities.get(t);o&&(o.removed=!0)}cleanupRemovedEntities(){for(const[t,o]of this.entities.entries())o.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,o])=>[t,o.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,o])=>[t,o.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const o=new ai;return o.sessionId=t.sessionId,o.gameMode=t.gameMode,o.isPaused=t.isPaused,o.currentFloor=t.currentFloor,o.currentRoom=t.currentRoom,o.roomCleared=t.roomCleared,o.gameTime=t.gameTime,o.localPlayerId=t.localPlayerId,o.nextEntityId=t.nextEntityId,o.players=new Map(t.players.map(([s,i])=>[s,ii.fromJSON(i)])),o.entities=new Map(t.entities.map(([s,i])=>[s,ni.fromJSON(i)])),o.doors=t.doors,o.obstacles=t.obstacles,o}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class of{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new ai,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=ai.fromJSON(t),this.gameState}clear(){this.gameState=null}}const Ta=new of;class _n{constructor(t,o,s){this.playerId=t,this.frameNumber=o,this.timestamp=s,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const o=new _n(t.playerId,t.frameNumber,t.timestamp);return Object.assign(o,t),o}}class sf{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(s=>{t.onKeyPress(s,()=>{this.keysPressed.add(s)}),t.onKeyRelease(s,()=>{this.keysPressed.delete(s)})}),t.onKeyPress("escape",()=>{this.onPausePressed()}),t.onKeyPress("space",()=>{this.onInteractPressed()}),t.onKeyPress("e",()=>{this.onInteractPressed()})}setupMouseListeners(){const t=this.k;t.onMouseMove(o=>{this.mouseX=o.x,this.mouseY=o.y}),t.onMousePress(()=>{this.mousePressed=!0}),t.onMouseRelease(()=>{this.mousePressed=!1})}collectLocalInput(t){const o=new _n(t,this.frameNumber,Date.now());return o.moveX=this.getMoveX(),o.moveY=this.getMoveY(),o.aimX=this.mouseX,o.aimY=this.mouseY,o.firing=!0,o}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const o=new Map;for(const s of t){const i=this.inputQueues.get(s);let a;i&&i.length>0?a=i.shift():a=this.collectLocalInput(s),o.set(s,a)}return this.currentInputs=o,this.inputHistory.push(new Map(o)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,o}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class nf{constructor(){this.inputManager=null}init(t){return this.inputManager=new sf,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const Ca=new nf,Ia={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class ri{constructor(t,o,s=null){this.type=t,this.data=o,this.senderId=s,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const o=new ri(t.type,t.data,t.senderId);return o.timestamp=t.timestamp,o}}class af{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,o){const s=new ri(t,o,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",s),this.messageQueue.push(s))}broadcast(t,o){this.send(t,o)}sendTo(t,o,s){const i=new ri(o,s,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,i)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const o of t)this.handleMessage(o);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Ia.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Ia.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,o){this.players.set(t,{id:t,...o,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:o})}removePlayer(t){const o=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:o})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,o){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(o)}off(t,o){if(this.eventHandlers.has(t)){const s=this.eventHandlers.get(t),i=s.indexOf(o);i>-1&&s.splice(i,1)}}emit(t,o,s=null){if(this.eventHandlers.has(t)){const i=this.eventHandlers.get(t);for(const a of i)a(o,s)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class rf{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new af,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const lf=new rf;let pe={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null},qt={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0};function Pa(e,t){const o=uo("startingHealth");o>0&&(t.maxHealth+=o*10,t.setHP(t.maxHealth));const s=uo("startingDamage");s>0&&(t.projectileDamage+=s);const i=uo("startingSpeed");i>0&&(t.speed+=i*10)}function cf(e){e.scene("game",t=>{if(t!=null&&t.resetState){const S=lf.init("local");Ca.init(e);const W=Ta.init("singleplayer");W.addPlayer(S,"survivor"),console.log("[Game] New architecture initialized:",{playerId:S,sessionId:W.sessionId,gameMode:W.gameMode})}const o=Ta.getState();t!=null&&t.resetState&&(pe.currentFloor=1,pe.currentRoom=1,pe.playerStats=null,pe.entryDirection=null,pe.floorMap=null,G0(),qt={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},e.gameData&&(e.gameData.weaponDetailSavedState=void 0));let s=pe.currentFloor,i=pe.currentRoom;const a=nl();if(!pe.floorMap||pe.floorMap.floor!==s){console.log(`[Game] Generating new floor map for floor ${s}`),a>1&&ml(s);const S=a>1?xl():null;pe.floorMap=J0(s,S),pe.minimap&&pe.minimap.destroy(),pe.minimap=Z0(e,pe.floorMap),e.gameData&&(e.gameData.minimap=pe.minimap)}else pe.minimap&&pe.minimap.update();s>qt.floorsReached&&(qt.floorsReached=s);const r=30;let h=e.width()/2,l=e.height()/2;if(pe.entryDirection)switch(pe.entryDirection){case"north":h=e.width()/2,l=r;break;case"south":h=e.width()/2,l=e.height()-r;break;case"west":h=r,l=e.height()/2;break;case"east":h=e.width()-r,l=e.height()/2;break}let n;pe.playerStats?(n=Oi(e,h,l),Object.assign(n,pe.playerStats),n.setHP(pe.playerStats.currentHP||n.maxHealth),pe.playerStats.selectedUpgrades&&(n.selectedUpgrades=new Set(pe.playerStats.selectedUpgrades)),pe.playerStats.activeSynergies&&(n.activeSynergies=new Set(pe.playerStats.activeSynergies)),n.upgradeStacks&&Object.keys(n.upgradeStacks).length>0&&Ml(n)):(n=Oi(e,h,l),Pa(e,n));const c=il(),u=sl();let d=[n];if(a>1&&u.isInitialized){console.log("[Multiplayer] Initializing multiplayer game with",a,"players");const S=c.slots.findIndex(W=>W.isLocal);ll(c.isHost,S,e),dn(S,n),c.slots.forEach((W,ie)=>{if(ie!==S&&W.playerId!==null){const de=(ie-S)*30,ne=Oi(e,h+de,l,W.selectedCharacter);ne.isRemote=!0,ne.playerName=W.playerName,Pa(e,ne),dn(ie,ne),d.push(ne);const $=e.add([e.text(W.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]);$.onUpdate(()=>{ne.exists()?$.pos=e.vec2(ne.pos.x,ne.pos.y-30):$.destroy()})}}),console.log("[Multiplayer] Spawned",d.length,"players")}const x=o.localPlayerId,f=o.getPlayer(x);f&&(f.x=n.pos.x,f.y=n.pos.y,f.health=n.hp(),f.maxHealth=n.maxHealth,f.speed=n.speed,f.level=n.level,f.xp=n.xp,f.xpToNext=n.xpToNext,f.xpMultiplier=n.xpMultiplier||1,f.weaponKey="pistol",f.fireRate=n.fireRate,f.projectileSpeed=n.projectileSpeed,f.projectileDamage=n.projectileDamage,f.projectileCount=n.projectileCount||1,f.piercing=n.piercing||0,f.obstaclePiercing=n.obstaclePiercing||0,f.critChance=n.critChance||.05,f.critDamage=n.critDamage||2,f.spreadAngle=n.spreadAngle||0,f.weaponRange=n.weaponRange||600,f.pickupRadius=n.pickupRadius,f.defense=n.defense||0,f.damageReduction=n.damageReduction||0,f.dodgeChance=n.dodgeChance||0,console.log("[Game] Player entity synced to PlayerState:",{playerId:x,position:{x:f.x,y:f.y},health:`${f.health}/${f.maxHealth}`,level:f.level}));const A=()=>{if(a<=1)return;let S=0;d.forEach((W,ie)=>{if(W.exists()&&W.hp()<=0||W.exists()&&W.isDead){W.setHP(W.maxHealth),W.isDead=!1,W.isRemote||(W.canMove=!0,W.canShoot=!0);const de=e.add([e.text(" REVIVED ",{size:16}),e.pos(W.pos.x,W.pos.y-40),e.anchor("center"),e.color(100,255,100),e.lifespan(2),e.z(1e3)]);de.onUpdate(()=>{de.pos.y-=30*e.dt(),de.opacity-=.5*e.dt()}),W.characterData&&W.characterData.color&&(W.color=e.rgb(...W.characterData.color)),W.outline&&W.outline.exists()&&(W.outline.opacity=1),S++,console.log(`[Revival] Player ${ie} revived (${W.playerName||"Local"})`)}}),S>0&&pt()&&Jt()&&mi(async()=>{const{broadcastRevivalEvent:W}=await Promise.resolve().then(()=>Xp);return{broadcastRevivalEvent:W}},void 0).then(({broadcastRevivalEvent:W})=>{W&&W()})};v0(e,n),N0(e,n,A,a>1),pe.playerStats&&pe.playerStats.selectedUpgrades&&e.wait(.1,()=>{Sl(e,n)});const g=pe.floorMap.getCurrentRoom();let w;if(g&&g.template)w=g.template;else{const S=a>1?Ao():null;w=Rl(s,S)}const D=X0(e,s),R=20;tf(e,s,e.width(),e.height()),e.add([e.rect(e.width()-R*2,2),e.pos(e.width()/2,R),e.anchor("center"),e.color(D.wallColor),e.fixed()]),e.add([e.rect(e.width()-R*2,2),e.pos(e.width()/2,e.height()-R),e.anchor("center"),e.color(D.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-R*2),e.pos(R,e.height()/2),e.anchor("center"),e.color(D.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-R*2),e.pos(e.width()-R,e.height()/2),e.anchor("center"),e.color(D.wallColor),e.fixed()]);const X=i===1&&s===1,_=80;let p=e.width()/2,y=e.height()/2;if(pe.entryDirection)switch(pe.entryDirection){case"north":p=e.width()/2,y=r;break;case"south":p=e.width()/2,y=e.height()-r;break;case"west":p=r,y=e.height()/2;break;case"east":p=e.width()-r,y=e.height()/2;break}X||w.obstacles.forEach(S=>{const W=Math.sqrt(Math.pow(S.x-h,2)+Math.pow(S.y-l,2)),ie=Math.sqrt(Math.pow(S.x-p,2)+Math.pow(S.y-y,2)),de=Math.max(S.width,S.height)/2;if(W<_+de||ie<_+de)return;const ne=Y0(S.x,S.y,S.width,S.height),$=S.type==="wall"?D.obstacleColor:D.coverColor;s0(e,ne.x,ne.y,S.width,S.height,S.type,S.char||"#",$)}),e.add([e.rect(100,40),e.pos(10,10),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(P.UI_BG-1)]);const b=e.add([e.text("",{size:Q.HUD}),e.pos(20,20),e.color(...I.WARNING),e.fixed(),e.z(P.UI_TEXT)]),E=e.add([e.text("0/0",{size:Q.HUD}),e.pos(40,20),e.color(...I.WARNING),e.fixed(),e.z(P.UI_TEXT)]);e.add([e.rect(120,40),e.pos(e.width()-10,10),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(P.UI_BG-1)]);const T=e.add([e.text("$",{size:Q.LABEL}),e.pos(e.width()-20,20),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]),C=e.add([e.text("0",{size:Q.HUD}),e.pos(e.width()-40,20),e.anchor("topright"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(950)]);if(pt()){const S=ul(),W=u.isHost?[100,255,100]:[100,200,255],ie=u.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...W),e.fixed(),e.z(P.UI_TEXT)]),e.add([e.text(`${ie} (${S}P)`,{size:Q.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...W),e.fixed(),e.z(P.UI_TEXT)])}const N=e.width()-40,B=15,v=e.height()-30;e.add([e.rect(N,B),e.pos(20,v),e.color(...I.BG_DARK),e.outline(2,e.rgb(...I.TEXT_DISABLED)),e.fixed(),e.z(P.UI_BG)]);const z=e.add([e.rect(0,B-4),e.pos(50,v+2),e.color(100,200,255),e.fixed(),e.z(P.UI_BG+1)]),G=e.add([e.text("0/10",{size:Q.SMALL-2}),e.pos(e.width()/2,v+B/2),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]),J=28,se=20+J/2,V=v+B/2;e.add([e.circle(J/2),e.pos(se,V),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(P.UI_BG+2)]);const k=e.add([e.text("1",{size:Q.SMALL}),e.pos(se,V),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(P.UI_TEXT)]),fe=40,oe=8,Ie=25,Ee=e.add([e.rect(fe,oe),e.pos(0,0),e.anchor("center"),e.color(...I.BG_DARK),e.outline(1,e.rgb(...I.TEXT_DISABLED)),e.z(P.OVERLAY)]),Re=e.add([e.rect(fe-2,oe-2),e.pos(0,0),e.anchor("left"),e.color(100,255,100),e.z(P.OVERLAY+1)]);Ee.hidden=!0,Re.hidden=!0;const Ae=48,Ce=20,Te=e.height()-85,He=e.add([e.rect(Ae,Ae),e.pos(Ce,Te),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(P.UI_BG)]),ee=e.add([e.text("",{size:32}),e.pos(Ce+Ae/2,Te+Ae/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(P.UI_TEXT)]),K=220,Z=90,q=e.add([e.rect(K,Z),e.pos(Ce,Te-Z-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(P.OVERLAY+5)]),j=e.add([e.text("",{size:24}),e.pos(Ce+15,Te-Z-10+15),e.color(255,255,255),e.fixed(),e.z(P.OVERLAY+6)]),ae=e.add([e.text("Basic Pistol",{size:Q.SMALL,width:160}),e.pos(Ce+50,Te-Z-10+10),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+6)]),ge=e.add([e.text("DMG: 10",{size:Q.SMALL-2}),e.pos(Ce+50,Te-Z-10+30),e.color(255,150,150),e.fixed(),e.z(P.OVERLAY+6)]),he=e.add([e.text("RATE: 3.75/s",{size:Q.SMALL-2}),e.pos(Ce+50,Te-Z-10+47),e.color(150,200,255),e.fixed(),e.z(P.OVERLAY+6)]),me=e.add([e.text("DPS: 37.5",{size:Q.SMALL-2}),e.pos(Ce+50,Te-Z-10+64),e.color(255,255,150),e.fixed(),e.z(P.OVERLAY+6)]);q.hidden=!0,j.hidden=!0,ae.hidden=!0,ge.hidden=!0,he.hidden=!0,me.hidden=!0;let Se=!1;t!=null&&t.resetState&&(Se=!1),He.onClick(()=>{Se=!Se,q.hidden=!q.hidden,j.hidden=!j.hidden,ae.hidden=!ae.hidden,ge.hidden=!ge.hidden,he.hidden=!he.hidden,me.hidden=!me.hidden});const it=40,Zt=Ce,Kt=Te-it-10,Lt=e.add([e.rect(it,it),e.pos(Zt,Kt),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(P.UI_BG)]),Ve=e.add([e.text("",{size:28}),e.pos(Zt+it/2,Kt+it/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(P.UI_TEXT)]),St=e.add([e.text("20",{size:14}),e.pos(Zt+it+5,Kt+it/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(P.UI_TEXT)]);Lt.hidden=!0,Ve.hidden=!0,St.hidden=!0;const xt=Ce+Ae+10,Qe=Te,ke=32,Ze=40,zt=[];function Nt(){if(zt.forEach(W=>{W.exists()&&e.destroy(W)}),zt.length=0,!n.exists())return;const S=[];n.upgradeStacks&&Object.entries(n.upgradeStacks).forEach(([W,ie])=>{ie>0&&S.push({key:W,stacks:ie})}),S.forEach((W,ie)=>{const de=xt+ie*Ze,ne=Qo[W.key];if(!ne)return;const $=e.add([e.rect(ke,ke),e.pos(de,Qe),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(P.UI_BG)]),re=e.add([e.text(ne.icon,{size:20}),e.pos(de+ke/2,Qe+ke/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(P.UI_TEXT)]),le=e.add([e.text(W.stacks.toString(),{size:10}),e.pos(de+ke-4,Qe+ke-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(P.UI_TEXT+1)]);zt.push($,re,le)})}const et=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(P.OVERLAY+10)]),dt=e.add([e.text("",{size:Q.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(P.OVERLAY+11)]);et.hidden=!0,dt.hidden=!0;const ts={level:()=>`Level ${n.level}
XP: ${n.xp}/${n.xpToNext}
Progress: ${Math.floor(n.xp/n.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${qt.enemiesKilled}`),currency:()=>`Total Credits: ${qo()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const S=n.weaponDef;return S?`${S.name}
Damage: ${n.projectileDamage}
Fire Rate: ${n.fireRate.toFixed(2)}/s
DPS: ${(n.projectileDamage*n.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(n.hp())}/${n.maxHealth}
Damage Reduction: ${Math.floor(n.damageReduction*100)}%`};function jt(S,W,ie){const de=ts[S];if(!de)return;const ne=de();dt.text=ne,et.pos.x=Math.min(W+10,e.width()-210),et.pos.y=Math.min(ie+10,e.height()-70),dt.pos.x=et.pos.x+5,dt.pos.y=et.pos.y+5,et.hidden=!1,dt.hidden=!1}function Bs(){et.hidden=!0,dt.hidden=!0}function vi(){return{hidden:et.hidden,text:dt.text,tooltipX:et.pos.x,tooltipY:et.pos.y,textX:dt.pos.x,textY:dt.pos.y}}function yt(S){S&&(et.hidden=S.hidden,dt.hidden=S.hidden,dt.text=S.text,et.pos.x=S.tooltipX,et.pos.y=S.tooltipY,dt.pos.x=S.textX,dt.pos.y=S.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=Bs,e.gameData.saveTooltipState=vi,e.gameData.restoreTooltipState=yt,e.gameData.minimap=pe.minimap,e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,e.onUpdate(()=>{if(e.paused||Sa())return;const S=e.mousePos();let W=!1;S.x>=20&&S.x<=180&&S.y>=20&&S.y<=35?(jt("level",S.x,S.y),W=!0):S.x>=20&&S.x<=180&&S.y>=40&&S.y<=55&&!E.hidden?(jt("enemies",S.x,S.y),W=!0):S.x>=e.width()-130&&S.x<=e.width()-10&&S.y>=10&&S.y<=50?(jt("currency",S.x,S.y),W=!0):S.x>=Ce&&S.x<=Ce+Ae&&S.y>=Te&&S.y<=Te+Ae&&(jt("weapon",S.x,S.y),W=!0),W||Bs()});const Rt=e.add([e.text("",{size:Q.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...I.BOSS_NAME),e.fixed(),e.z(P.OVERLAY)]),Wt=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...I.BG_DARK),e.outline(2,e.rgb(...I.TEXT_DISABLED)),e.fixed(),e.z(P.OVERLAY)]),Fe=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...I.HEALTH_LOW),e.fixed(),e.z(P.OVERLAY+1)]),Dt=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...I.BG_DARK),e.outline(2,e.rgb(...I.TEXT_DISABLED)),e.fixed(),e.z(P.OVERLAY)]),nt=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.OVERLAY+1)]),Ht=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+2)]),ut=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+2)]),M=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...I.BG_DARK),e.outline(2,e.rgb(...I.TEXT_DISABLED)),e.fixed(),e.z(P.OVERLAY)]),L=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...I.XP_BAR),e.fixed(),e.z(P.OVERLAY+1)]),F=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+2)]);Rt.hidden=!0,Wt.hidden=!0,Fe.hidden=!0,Dt.hidden=!0,nt.hidden=!0,Ht.hidden=!0,ut.hidden=!0,M.hidden=!0,L.hidden=!0,F.hidden=!0,e.onUpdate(()=>{e.paused||A0(e)}),e.onUpdate(()=>{e.paused||pt()&&cl(e.dt())}),e.onUpdate(()=>{const S=n.exists()?n.hp():0,W=n.maxHealth>0?S/n.maxHealth:1;k.text=`${n.level}`;const ie=n.xpToNext>0?n.xp/n.xpToNext:0;if(z.width=Math.max(0,(N-34)*ie),G.text=L0(n.xp,n.xpToNext),C.text=qo().toString(),W<1&&n.exists()){Ee.hidden=!1,Re.hidden=!1;const $=n.pos.x,re=n.pos.y+Ie;Ee.pos=e.vec2($,re);const le=$-fe/2+1;Re.pos=e.vec2(le,re),Re.width=Math.max(0,(fe-2)*W),W>.6?Re.color=e.rgb(100,255,100):W>.3?Re.color=e.rgb(255,200,0):Re.color=e.rgb(255,50,50)}else Ee.hidden=!0,Re.hidden=!0;if(!ye&&!te){const $=e.get("enemy").length,re=Le+(wt?1:0),le=e.get("miniboss").length,ve=$+le+Math.max(0,re-Xe-(wt&&vt?1:0));E.text=`${ve}/${re}`,E.hidden=!1,b.hidden=!1}else E.hidden=!0,b.hidden=!0;if(n.exists()&&n.weaponDef){const $=n.weaponDef,re=(n.projectileDamage*n.fireRate).toFixed(1);ee.text=$.icon||"",ee.color=e.rgb(...$.color),j.text=$.icon||"",j.color=e.rgb(...$.color),ae.text=$.name,ae.color=e.rgb(...I.TEXT_PRIMARY),ge.text=`DMG: ${n.projectileDamage}`,he.text=`RATE: ${n.fireRate.toFixed(2)}/s`,me.text=`DPS: ${re}`,e.paused?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Se),q.hidden=!1,j.hidden=!1,ae.hidden=!1,ge.hidden=!1,he.hidden=!1,me.hidden=!1):(q.hidden=!Se,j.hidden=!Se,ae.hidden=!Se,ge.hidden=!Se,he.hidden=!Se,me.hidden=!Se)}if(n.exists()){zp(n,e.dt());const $=Hp(n);$?(Lt.hidden=!1,Ve.hidden=!1,St.hidden=!1,Ve.text=$.icon,Ve.color=e.rgb(...$.color),Lt.outline.color=e.rgb(...$.color),$.isAmmoBased?St.text=`${$.ammo}`:$.isTimeBased&&(St.text=`${Math.ceil($.duration)}s`)):(Lt.hidden=!0,Ve.hidden=!0,St.hidden=!0)}e.time()%.5<e.dt()&&Nt();const de=e.get("boss"),ne=de.filter($=>$.type==="twinGuardianMelee"||$.type==="twinGuardianRanged");if(ne.length>0){const $=ne.find(le=>le.type==="twinGuardianMelee"),re=ne.find(le=>le.type==="twinGuardianRanged");if($&&re&&($.exists()||re.exists())){Rt.hidden=!1,Rt.text="THE TWIN GUARDIANS";const le=$.exists()?$.hp():0,ve=re.exists()?re.hp():0,ue=le+ve,De=($.maxHealth||0)+(re.maxHealth||0),Me=De>0?Math.max(0,Math.min(1,ue/De)):0;Fe.width=296*Me,Fe.pos.x=e.width()/2-296*(1-Me)/2,Ht.text=`${Math.max(0,Math.floor(ue))}/${De}`,Wt.hidden=!1,Fe.hidden=!1,Ht.hidden=!1;const ze=$.exists()&&$.shieldHealth||0,Pe=re.exists()&&re.shieldHealth||0,qe=ze+Pe,tt=($.maxShieldHealth||0)+(re.maxShieldHealth||0);if(tt>0){const ss=Math.max(0,Math.min(1,qe/tt));L.width=296*ss,L.pos.x=e.width()/2-296*(1-ss)/2,F.text=`Shield: ${Math.max(0,Math.floor(qe))}/${tt}`,M.hidden=!1,L.hidden=!1,F.hidden=!1}else M.hidden=!0,L.hidden=!0,F.hidden=!0;const os=$.exists()&&$.armorHealth||0,Di=re.exists()&&re.armorHealth||0,Kn=os+Di,Ti=($.maxArmorHealth||0)+(re.maxArmorHealth||0);if(Ti>0){const ss=Math.max(0,Math.min(1,Kn/Ti));nt.width=296*ss,nt.pos.x=e.width()/2-296*(1-ss)/2,ut.text=`Armor: ${Math.max(0,Math.floor(Kn))}/${Ti}`,Dt.hidden=!1,nt.hidden=!1,ut.hidden=!1}else Dt.hidden=!0,nt.hidden=!0,ut.hidden=!0;Me>.6?Fe.color=e.rgb(255,50,50):Me>.3?Fe.color=e.rgb(255,150,50):Fe.color=e.rgb(255,200,0)}else{const le=$!=null&&$.exists()?$:re;if(le){const ve=le.hp(),ue=le.maxHealth,De=le.shieldHealth||0,Me=le.maxShieldHealth||0,ze=le.armorHealth||0,Pe=le.maxArmorHealth||0;Rt.hidden=!1,Rt.text=le.enraged?"THE TWIN GUARDIANS (ENRAGED)":"THE TWIN GUARDIANS";const qe=Math.max(0,Math.min(1,ve/ue));if(Fe.width=296*qe,Fe.pos.x=e.width()/2-296*(1-qe)/2,Ht.text=`${Math.max(0,Math.floor(ve))}/${ue}`,Wt.hidden=!1,Fe.hidden=!1,Ht.hidden=!1,Me>0){const tt=Math.max(0,Math.min(1,De/Me));L.width=296*tt,L.pos.x=e.width()/2-296*(1-tt)/2,F.text=`Shield: ${Math.max(0,Math.floor(De))}/${Me}`,M.hidden=!1,L.hidden=!1,F.hidden=!1}else M.hidden=!0,L.hidden=!0,F.hidden=!0;if(Pe>0){const tt=Math.max(0,Math.min(1,ze/Pe));nt.width=296*tt,nt.pos.x=e.width()/2-296*(1-tt)/2,ut.text=`Armor: ${Math.max(0,Math.floor(ze))}/${Pe}`,Dt.hidden=!1,nt.hidden=!1,ut.hidden=!1}else Dt.hidden=!0,nt.hidden=!0,ut.hidden=!0;qe>.6?Fe.color=e.rgb(255,50,50):qe>.3?Fe.color=e.rgb(255,150,50):Fe.color=e.rgb(255,200,0)}else Rt.hidden=!0,Wt.hidden=!0,Fe.hidden=!0,Dt.hidden=!0,nt.hidden=!0,Ht.hidden=!0,ut.hidden=!0}}else if(de.length>0&&de[0].exists()){const $=de[0],re=$.hp(),le=$.maxHealth,ve=$.shieldHealth||0,ue=$.maxShieldHealth||0,De=$.armorHealth||0,Me=$.maxArmorHealth||0,Pe={gatekeeper:"THE GATEKEEPER",swarmQueen:"THE SWARM QUEEN",twinGuardianMelee:"THE TWIN GUARDIANS",twinGuardianRanged:"THE TWIN GUARDIANS"}[$.type]||"BOSS";Rt.hidden=!1,Wt.hidden=!1,Fe.hidden=!1,Dt.hidden=!1,nt.hidden=!1,Ht.hidden=!1,ut.hidden=!1,Rt.text=Pe;const qe=Math.max(0,Math.min(1,re/le));if(Fe.width=296*qe,Fe.pos.x=e.width()/2-296*(1-qe)/2,Ht.text=`${Math.max(0,Math.floor(re))}/${le}`,ue>0){const tt=Math.max(0,Math.min(1,ve/ue));L.width=296*tt,L.pos.x=e.width()/2-296*(1-tt)/2,F.text=`Shield: ${Math.max(0,Math.floor(ve))}/${ue}`,M.hidden=!1,L.hidden=!1,F.hidden=!1}else M.hidden=!0,L.hidden=!0,F.hidden=!0;if(Me>0){const tt=Math.max(0,Math.min(1,De/Me));nt.width=296*tt,nt.pos.x=e.width()/2-296*(1-tt)/2,ut.text=`Armor: ${Math.max(0,Math.floor(De))}/${Me}`,Dt.hidden=!1,nt.hidden=!1,ut.hidden=!1}else Dt.hidden=!0,nt.hidden=!0,ut.hidden=!0;qe>.6?Fe.color=e.rgb(255,50,50):qe>.3?Fe.color=e.rgb(255,150,50):Fe.color=e.rgb(255,200,0)}else Rt.hidden=!0,Wt.hidden=!0,Fe.hidden=!0,Dt.hidden=!0,nt.hidden=!0,Ht.hidden=!0,ut.hidden=!0,M.hidden=!0,L.hidden=!0,F.hidden=!0}),e.onUpdate(()=>{if(!n.exists()||e.paused)return;const S=o.getPlayer(x);S&&(S.x=n.pos.x,S.y=n.pos.y,S.velocityX=0,S.velocityY=0,S.health=n.hp(),S.maxHealth=n.maxHealth,S.level=n.level,S.xp=n.xp,S.xpToNext=n.xpToNext,S.projectileDamage=n.projectileDamage,S.fireRate=n.fireRate,S.projectileSpeed=n.projectileSpeed,S.projectileCount=n.projectileCount||1,S.piercing=n.piercing||0,S.critChance=n.critChance||.05,S.critDamage=n.critDamage||2,S.pickupRadius=n.pickupRadius,S.defense=n.defense||0,S.isDead=!n.exists()||n.hp()<=0,S.invulnerable=n.invulnerable||!1,o.updateTime(e.dt()))}),o.currentFloor=s,o.currentRoom=i,o.roomCleared=!1,console.log("[Game] Room state synced:",{floor:o.currentFloor,room:o.currentRoom,isBossRoom:i===3}),e.onUpdate(()=>{if(e.paused)return;const S=Ca.getManager(),ie=S.getInputsForFrame([x]).get(x);Math.random()<.01&&console.log("[InputManager] Frame:",S.frameNumber,"Input:",{move:`(${ie.moveX}, ${ie.moveY})`,aim:`(${ie.aimX}, ${ie.aimY})`,firing:ie.firing})});let te=!1;const ye=g?g.isBossRoom:i===3;let Le=ye?0:24+(s-1)*6,Xe=0,Ke=2,Ut=!1,vt=!1,wt=!1,Pl=4,Ei=0;if(!ye&&i!==1){const S=.15+(s-1)*.05;wt=Math.random()<S}wt&&(Le=Math.floor(Le*.5));function Bl(S){const W=["brute","sentinel","berserker","guardian","warlock"];if(S>=3)return W[Math.floor(Math.random()*W.length)];{const ie=["brute","berserker","guardian"];return ie[Math.floor(Math.random()*ie.length)]}}function Ol(S){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[S]||"gatekeeper"}const at=[],Ll=[{x:e.width()/2,y:r,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-r,direction:"south",gridDir:"down"},{x:r,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-r,y:e.height()/2,direction:"east",gridDir:"right"}],zl=pe.floorMap?pe.floorMap.getAvailableExits():[],Nl=new Set(zl.map(S=>S.direction));Ll.forEach(S=>{const W=o0(e,S.x,S.y,S.direction);W.open=!1,W.isSpawnDoor=!0,W.gridDirection=S.gridDir,(S.gridDir===null||!Nl.has(S.gridDir))&&(W.blocked=!0),W.updateVisual(),at.push(W)});let Os=0;const Hl=.33;let qn=!1;e.onUpdate(()=>{if(e.paused||te)return;if(qn||(Ei=e.time(),qn=!0),ye){if(!Ut){Ut=!0;const $=Ol(s),re=a>1?Ao():null;if($==="twinGuardian"){const le=at.filter(Me=>Me.direction!==pe.entryDirection);let ve,ue;if(le.length>=2){const Me=[...le];for(let Pe=Me.length-1;Pe>0;Pe--){const qe=re?re.range(0,Pe+1):Math.floor(Math.random()*(Pe+1));[Me[Pe],Me[qe]]=[Me[qe],Me[Pe]]}ve=Me[0];const ze={north:"south",south:"north",east:"west",west:"east"};ue=le.find(Pe=>Pe.direction===ze[ve.direction])||Me[1]}else ve=at[0],ue=at[at.length>1?1:0];kp(e,ve,ue,s,re),va();const De=e.add([e.text("THE TWIN GUARDIANS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{De.exists()&&e.destroy(De)})}else{let le=at.find(ze=>ze.direction==="north");if(!le||pe.entryDirection==="north"&&at.length>1){const ze=at.filter(Pe=>Pe.direction!==pe.entryDirection);if(ze.length>0){const Pe=re?re.range(0,ze.length):Math.floor(Math.random()*ze.length);le=ze[Pe]}else{const Pe=re?re.range(0,at.length):Math.floor(Math.random()*at.length);le=at[Pe]}}const ve=le?le.pos.x:e.width()/2,ue=le?le.pos.y:e.height()/2;pn(e,ve,ue,$,s,re),va();const De=$==="gatekeeper"?"THE GATEKEEPER":$==="swarmQueen"?"THE SWARM QUEEN":"THE TWIN GUARDIANS",Me=e.add([e.text(De,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Me.exists()&&e.destroy(Me)})}}e.get("boss").length===0&&!te&&(te=!0,Fn());return}if(wt&&!vt&&e.time()-Ei>=1){vt=!0;const ne=Bl(s),$=a>1?Ao():null,re=at.filter(qe=>qe.direction!==pe.entryDirection),le=re.length>0?re:at,ve=$?$.range(0,le.length):Math.floor(Math.random()*le.length),ue=le[ve],De=ue.pos.x,Me=ue.pos.y;t0(e,De,Me,ne,s);const ze={brute:"MINIBOSS: BRUTE",sentinel:"MINIBOSS: SENTINEL",berserker:"MINIBOSS: BERSERKER",guardian:"MINIBOSS: GUARDIAN",warlock:"MINIBOSS: WARLOCK"},Pe=e.add([e.text(ze[ne]||"MINIBOSS",{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{Pe.exists()&&e.destroy(Pe)})}const S=e.get("enemy").length,W=e.get("miniboss").length;if(Xe>=Le&&S===0&&W===0&&!te&&(te=!0,Fn()),Xe<Le){if(Os+=e.dt(),Xe===0&&Os<Ke)return;if(Os>=Hl){Os=0,Xe++;const ne=a>1?Ao():null;if(ne)for(let $=0;$<Xe-1;$++)ne.next();if(at.length>0){const $=e.time()-Ei,le=pe.entryDirection&&$<Pl?at.filter(Di=>Di.direction!==pe.entryDirection):at,ve=le.length>0?le:at,ue=ne?ne.range(0,ve.length):Math.floor(Math.random()*ve.length),De=ve[ue],Me=De.pos.x,ze=De.pos.y,Pe=15,qe=Me+(ne?ne.next()-.5:Math.random()-.5)*Pe,tt=ze+(ne?ne.next()-.5:Math.random()-.5)*Pe,os=gn(s);So(e,qe,tt,os,s)}else{const $=ne?ne.range(0,4):Math.floor(e.rand(0,4));let re,le;switch($){case 0:re=ne?ne.rangeFloat(R,e.width()-R):e.rand(R,e.width()-R),le=R;break;case 1:re=e.width()-R,le=ne?ne.rangeFloat(R,e.height()-R):e.rand(R,e.height()-R);break;case 2:re=ne?ne.rangeFloat(R,e.width()-R):e.rand(R,e.width()-R),le=e.height()-R;break;case 3:re=R,le=ne?ne.rangeFloat(R,e.height()-R):e.rand(R,e.height()-R);break}const ve=gn(s);So(e,re,le,ve,s)}}}}),e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(S=>{if(S.hp()<=0&&!S.isDead){S.isDead=!0;const W=S.xpValue,ie=S.pos.x,de=S.pos.y;if(S.cleanupHealthBars&&S.cleanupHealthBars(),S.explodes&&S.explosionRadius){const ne=S.explosionRadius,$=S.explosionDamage||15;n.exists()&&Math.sqrt(Math.pow(n.pos.x-ie,2)+Math.pow(n.pos.y-de,2))<=ne&&n.takeDamage($),e.get("enemy").forEach(re=>{if(re===S||!re.exists())return;Math.sqrt(Math.pow(re.pos.x-ie,2)+Math.pow(re.pos.y-de,2))<=ne&&re.hurt($)}),_s(e,ie,de,{color:[255,150,50]})}else _s(e,ie,de,{color:[255,100,100]});if(S.shrapnel&&S.shrapnelCount){const ne=S.shrapnelCount,$=Math.PI*2/ne,re=250,le=Math.floor((S.explosionDamage||15)*.6);for(let ve=0;ve<ne;ve++){const ue=$*ve,De=e.vec2(Math.cos(ue),Math.sin(ue)),Me=Qt(e,ie,de,De,re,le,0,0,!1);Me.isEnemyProjectile=!0,Me.color=e.rgb(...S.originalColor)}}if(e.destroy(S),ba(),qt.enemiesKilled++,!pt()||Jt()){const ne=a>1?Ao():null;gs(e,ie,de,W);const $=ne?ne.range(1,4):Math.floor(Math.random()*3)+1,re=1;for(let ve=0;ve<$;ve++){const ue=ne?(ne.next()-.5)*20:(Math.random()-.5)*20,De=ne?(ne.next()-.5)*20:(Math.random()-.5)*20;ms(e,ie+ue,de+De,re)}const le=Op(S.type,s);if(le){const ve=ne?(ne.next()-.5)*30:(Math.random()-.5)*30,ue=ne?(ne.next()-.5)*30:(Math.random()-.5)*30;ga(e,ie+ve,de+ue,le)}}}}),e.get("miniboss").forEach(S=>{if(S.hp()<=0&&!S.isDead){S.isDead=!0;const W=S.xpValue,ie=S.pos.x,de=S.pos.y;if(_s(e,ie,de,{color:[255,150,100],isMiniboss:!0}),e.destroy(S),ba(),qt.enemiesKilled++,!pt()||Jt()){const $=a>1?Ao():null;gs(e,ie,de,W);const re=$?$.range(10,16):Math.floor(Math.random()*6)+10,le=1;for(let ve=0;ve<re;ve++){const ue=Math.PI*2/re*ve,De=$?30+$.next()*20:30+Math.random()*20,Me=Math.cos(ue)*De,ze=Math.sin(ue)*De;ms(e,ie+Me,de+ze,le)}}const ne=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(ie,de-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{ne.exists()&&e.destroy(ne)})}}),e.get("boss").forEach(S=>{if(S.hp()<=0&&!S.isDead){S.isDead=!0;const W=S.xpValue,ie=S.pos.x,de=S.pos.y;if(_s(e,ie,de,{color:[255,200,100],isBoss:!0}),e.destroy(S),x0(),qt.enemiesKilled++,qt.bossesKilled++,!pt()||Jt()){const $=a>1?Ao():null;gs(e,ie,de,W);const re=$?$.range(20,31):Math.floor(Math.random()*11)+20,le=1,ve=rl();for(let ue=0;ue<re;ue++){const De=Math.PI*2/re*ue,Me=$?40+$.next()*30:40+Math.random()*30,ze=Math.cos(De)*Me,Pe=Math.sin(De)*Me;ms(e,ie+ze,de+Pe,le,ve)}}const ne=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(ie,de-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{ne.exists()&&e.destroy(ne)})}}))}),e.onUpdate(()=>{!n.exists()||e.paused||e.get("xpPickup").forEach(S=>{if(S.collected)return;const W=e.vec2(n.pos.x-S.pos.x,n.pos.y-S.pos.y).len();if(!S.magnetizing&&W<=n.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=n),W<=je.COLLECTION_RADIUS&&!S.collected){S.collected=!0,p0(),a>1?d.forEach(ue=>{ue.exists()&&!ue.isDead&&ue.addXP&&ue.addXP(S.value)}):n.addXP(S.value);const ie=e.add([e.text("+",{size:12}),e.pos(S.pos.x,S.pos.y),e.color(100,200,255),e.fixed(),e.z(P.UI_TEXT+1)]),de=e.width()/2,ne=v+B/2,$=.4;let re=0;const le=S.pos.x,ve=S.pos.y;ie.onUpdate(()=>{re+=e.dt();const ue=Math.min(re/$,1),De=ue*ue;ie.pos.x=le+(de-le)*De,ie.pos.y=ve+(ne-ve)*De,ie.opacity=1-ue*.5,ie.scale=e.vec2(1-ue*.5),ue>=1&&(e.destroy(ie),z.color=e.rgb(150,230,255),e.wait(.1,()=>{z.exists()&&(z.color=e.rgb(100,200,255))}))}),e.destroy(S)}})}),e.onUpdate(()=>{!n.exists()||e.paused||(e.get("currencyPickup").forEach(S=>{if(S.collected)return;const W=e.vec2(n.pos.x-S.pos.x,n.pos.y-S.pos.y).len();if(!S.magnetizing&&W<=n.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=n),W<=je.COLLECTION_RADIUS&&!S.collected){S.collected=!0,Aa(),cn(S.value);const ie=e.add([e.text("$",{size:10}),e.pos(S.pos.x,S.pos.y),e.color(255,215,0),e.fixed(),e.z(P.UI_TEXT+1)]),de=e.width()-20,ne=20,$=.5;let re=0;const le=S.pos.x,ve=S.pos.y;ie.onUpdate(()=>{re+=e.dt();const ue=Math.min(re/$,1),De=ue*ue;ie.pos.x=le+(de-le)*De,ie.pos.y=ve+(ne-ve)*De,ie.opacity=1,ue>=1&&(e.destroy(ie),T.scale=e.vec2(1.3),C.scale=e.vec2(1.2),e.wait(.15,()=>{T.exists()&&(T.scale=e.vec2(1)),C.exists()&&(C.scale=e.vec2(1))}))}),e.destroy(S)}}),e.get("powerupWeaponPickup").forEach(S=>{if(S.collected)return;const W=e.vec2(n.pos.x-S.pos.x,n.pos.y-S.pos.y).len();if(!S.magnetizing&&W<=n.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=n),W<=je.COLLECTION_RADIUS&&!S.collected){S.collected=!0,Aa(),Lp(n,S.powerupKey);const ie=To[S.powerupKey],de=e.add([e.text(ie.icon,{size:32}),e.pos(n.pos.x,n.pos.y-30),e.color(...ie.color),e.anchor("center"),e.z(P.UI_TEXT+1),e.opacity(1)]);let ne=0;de.onUpdate(()=>{ne+=e.dt(),de.pos.y-=50*e.dt(),de.opacity=Math.max(0,1-ne/.8),ne>=.8&&e.destroy(de)}),e.destroy(S)}}))});let Mi=!1;e.onUpdate(()=>{!n.exists()||e.paused||Mi||e.get("door").forEach(S=>{if(!S.open||Mi||S.isSpawnDoor||S.blocked)return;e.vec2(n.pos.x-S.pos.x,n.pos.y-S.pos.y).len()<=40&&(Mi=!0,g0(),_l(S.direction))})});function Ul(){if(!n.exists())return;const S=e.width()/2,W=e.height()/2,ie=5,de=3,ne=ye?3:1,$=ye?4:1,re=s*.5,le=Math.floor((ie+re)*ne),ve=Math.floor((de+re)*$);for(let ue=0;ue<le;ue++){const De=Math.PI*2*ue/le+Math.random()*.3,Me=40+Math.random()*60,ze=S+Math.cos(De)*Me,Pe=W+Math.sin(De)*Me,qe=Math.floor(1+s*.5);gs(e,ze,Pe,qe)}for(let ue=0;ue<ve;ue++){const De=Math.PI*2*ue/ve+Math.random()*.3+.5,Me=50+Math.random()*70,ze=S+Math.cos(De)*Me,Pe=W+Math.sin(De)*Me,qe=Math.floor(1+s*.3);ms(e,ze,Pe,qe)}if(ye){const ue=Object.keys(To),De=1+Math.floor(Math.random()*2);for(let Me=0;Me<De;Me++){const ze=Math.random()*Math.PI*2,Pe=80+Math.random()*40,qe=S+Math.cos(ze)*Pe,tt=W+Math.sin(ze)*Pe,os=ue[Math.floor(Math.random()*ue.length)];ga(e,qe,tt,os)}}}function Fn(){o.roomCleared=!0,o.clearRoom(),console.log("[Game] Room cleared:",{floor:o.currentFloor,room:o.currentRoom,cleared:o.roomCleared}),qt.roomsCleared++,pe.floorMap&&g&&pe.floorMap.markRoomCleared(g.position.x,g.position.y),at.forEach(ie=>{ie.exists()&&!ie.blocked&&(ie.open=!0,ie.isSpawnDoor=!1,ie.updateVisual())}),pe.minimap&&pe.minimap.update(),Ul();const S=ye?`BOSS DEFEATED! Floor ${s} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",W=e.add([e.text(S,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{W.exists()&&e.destroy(W)})}function _l(S){pe.playerStats={level:n.level,xp:n.xp,xpToNext:n.xpToNext,maxHealth:n.maxHealth,currentHP:n.hp(),speed:n.speed,fireRate:n.fireRate,projectileSpeed:n.projectileSpeed,projectileDamage:n.projectileDamage,pickupRadius:n.pickupRadius,xpMultiplier:n.xpMultiplier||1,projectileCount:n.projectileCount||1,piercing:n.piercing||0,obstaclePiercing:n.obstaclePiercing||0,critChance:n.critChance||0,critDamage:n.critDamage||2,spreadAngle:n.spreadAngle||0,defense:n.defense||0,weaponRange:n.weaponRange||600,weapons:n.weapons||[],passiveUpgrades:n.passiveUpgrades||[],upgradeStacks:n.upgradeStacks||{},selectedUpgrades:n.selectedUpgrades?Array.from(n.selectedUpgrades):[],activeSynergies:n.activeSynergies?Array.from(n.activeSynergies):[],piercingDamageBonus:n.piercingDamageBonus||1,characterData:n.characterData,weaponDef:n.weaponDef,baseProjectileDamage:n.baseProjectileDamage,baseFireRate:n.baseFireRate,baseProjectileSpeed:n.baseProjectileSpeed};const W={north:"south",south:"north",west:"east",east:"west"};if(pe.entryDirection=W[S]||null,pe.floorMap){const de={north:"up",south:"down",east:"right"}[S];de?pe.floorMap.moveToRoom(de)?(pe.floorMap.getCurrentRoom().isBossRoom&&console.log("[Game] Boss room reached - floor complete after this room"),i=pe.floorMap.getVisitedCount()):(console.error("[Game] Failed to move in floor map - should not happen!"),i++):(console.warn("[Game] Invalid door direction:",S),i++),g&&g.isBossRoom&&g.cleared?(s++,da(s-1).then(ne=>{if(ne){const $=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{$.exists()&&e.destroy($)})}}),pe.floorMap=null,pe.entryDirection=null,o.nextFloor(),console.log("[Game] Advanced to next floor:",o.currentFloor)):(o.nextRoom(),console.log("[Game] Advanced to next room:",{floor:o.currentFloor,room:o.currentRoom}))}else i++,i>3?(s++,da(s-1).then(ie=>{if(ie){const de=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{de.exists()&&e.destroy(de)})}}),i=1,pe.entryDirection=null,o.nextFloor(),console.log("[Game] Advanced to next floor:",o.currentFloor)):(o.nextRoom(),console.log("[Game] Advanced to next room:",{floor:o.currentFloor,room:o.currentRoom}));pe.currentFloor=s,pe.currentRoom=i,e.go("game")}n.onDeath(()=>{if(n.orbitalOrbs&&(n.orbitalOrbs.forEach(ie=>{ie.exists()&&e.destroy(ie)}),n.orbitalOrbs=[]),a>1){if(n.isDead=!0,n.canMove=!1,n.canShoot=!1,n.opacity=.5,n.outline&&n.outline.exists()&&(n.outline.opacity=.5),console.log("[Multiplayer] Player died - checking if any players are still alive"),d.some(de=>de.exists()&&de.hp()>0&&!de.isDead)){console.log("[Multiplayer] At least one player is still alive - continuing game");return}console.log("[Multiplayer] All players are dead - game over")}const S=gp(qt),W={...qt,level:n.level,currencyEarned:S};pp(W),cn(S),j0(e),pt()&&un(),e.go("gameOver",{runStats:{...qt},currencyEarned:S})});const Si=e.add([e.rect(270,250),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(0,0,0),e.opacity(.9),e.outline(3,e.rgb(200,200,200)),e.fixed(),e.z(2e3),"pauseOverlay"]),Ri=e.add([e.text("PAUSED",{size:48}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2001),"pauseText"]),Ls=e.height()/2,zs=60,Yn=200,Xn=40,Gn=e.add([e.rect(Yn,Xn),e.pos(e.width()/2,Ls-zs/2),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Resume",{size:18}),e.pos(e.width()/2,Ls-zs/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]);const Vn=e.add([e.rect(Yn,Xn),e.pos(e.width()/2,Ls+zs/2),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Quit to Menu",{size:18}),e.pos(e.width()/2,Ls+zs/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]),Si.hidden=!0,Ri.hidden=!0,e.get("pauseButton").forEach(S=>S.hidden=!0),Gn.onClick(()=>{!e.paused||Gn.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Se=e.gameData.weaponDetailSavedState,q.hidden=!Se,j.hidden=!Se,ae.hidden=!Se,ge.hidden=!Se,he.hidden=!Se,me.hidden=!Se,e.gameData.weaponDetailSavedState=void 0),Ea(),Si.hidden=!0,Ri.hidden=!0,e.get("pauseButton").forEach(S=>S.hidden=!0))}),Vn.onClick(()=>{!e.paused||Vn.hidden||(pt()&&un(),pe.currentFloor=1,pe.currentRoom=1,pe.playerStats=null,e.go("menu"))}),e.onKeyPress("m",()=>{pe.minimap&&!e.paused&&pe.minimap.toggle()}),e.onKeyPress("escape",()=>{Sa()||(e.paused=!e.paused,e.paused?(w0(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Se)):(Ea(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Se=e.gameData.weaponDetailSavedState,q.hidden=!Se,j.hidden=!Se,ae.hidden=!Se,ge.hidden=!Se,he.hidden=!Se,me.hidden=!Se,e.gameData.weaponDetailSavedState=void 0)),Si.hidden=!e.paused,Ri.hidden=!e.paused,e.get("pauseButton").forEach(S=>S.hidden=!e.paused))})})}function Vo(e,t,o,s,i=Go.WIDTH,a=Go.HEIGHT,r=Q.BUTTON){const h=I.SECONDARY,l=I.SECONDARY_HOVER,n=I.TEXT_PRIMARY,c=I.BORDER,u=!1,d=e.add([e.rect(i,a),e.pos(o,s),e.anchor("center"),e.color(...h),e.outline(2,e.rgb(...c)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS),"menuButton"]),x=fo(t),f=[];{const g=e.add([e.text(x,{size:r}),e.pos(o,s),e.anchor("center"),e.color(...n),e.fixed(),e.z(P.UI_TEXT),"menuButtonText"]);f.push(g)}const A=f[0];return d.originalColor=[...h],d.hoverColor=[...l],d.borderColor=[...c],d.isHovered=!1,d.disabled=u,d.onHoverUpdate(()=>{d.disabled||(d.isHovered||(d.isHovered=!0,mt()),d.color=e.rgb(...d.hoverColor),d.outline.color=e.rgb(...I.BORDER_HOVER),d.scale=e.vec2(Go.HOVER_SCALE,Go.HOVER_SCALE),f.forEach(g=>g.scale=e.vec2(Go.HOVER_SCALE,Go.HOVER_SCALE)))}),d.onHoverEnd(()=>{d.disabled||(d.isHovered=!1,d.color=e.rgb(...d.originalColor),d.outline.color=e.rgb(...d.borderColor),d.scale=e.vec2(1,1),f.forEach(g=>g.scale=e.vec2(1,1)))}),d.label=A,d.labels=f,d.setDisabled=g=>{d.disabled=g,g?(d.color=e.rgb(...I.BG_DISABLED),f.forEach(w=>w.color=e.rgb(...I.TEXT_DISABLED))):(d.color=e.rgb(...d.originalColor),f.forEach((w,D)=>{w.color=e.rgb(...n)}))},d}function hf(e){e.scene("menu",()=>{Al();const t=qo();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...I.BG_DARK),e.z(P.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...I.BORDER),e.fixed(),e.z(P.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...I.BORDER),e.fixed(),e.z(P.UI_BACKGROUND)]),Ep(e);const o=20,s=20,i=188,a=24,r=3,h=10,l=h+a*4+r*3+60;e.add([e.rect(i,l),e.pos(o,s),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.BORDER)),e.fixed(),e.z(P.UI_BACKGROUND)]);const n=s+h,c=[];function u(){c.forEach(K=>{K.forEach(Z=>{Z.exists()&&e.destroy(Z)})}),c.length=0,Pp().forEach((K,Z)=>{const q=n+Z*(a+r),j=[],ae=e.add([e.rect(i-20,a),e.pos(o+10,q),e.color(K.isEmpty?I.BG_DARK:I.BG_LIGHT),e.outline(1,e.rgb(...I.TEXT_DISABLED)),e.fixed(),e.z(P.UI_BACKGROUND+1),"partySlotUI"]);j.push(ae);const ge=e.add([e.text(`${K.slotNumber}`,{size:Q.SMALL}),e.pos(o+20,q+a/2),e.anchor("left"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT),"partySlotUI"]);if(j.push(ge),!K.isEmpty){const me=ro[K.selectedCharacter]||ro.survivor,Se=e.add([e.text(me.char,{size:Q.SMALL}),e.pos(o+38,q+a/2),e.anchor("left"),e.color(...me.color),e.fixed(),e.z(P.UI_TEXT),"partySlotUI"]);j.push(Se)}const he=e.add([e.text(K.playerName,{size:Q.SMALL-2}),e.pos(o+(K.isEmpty?45:55),q+a/2),e.anchor("left"),e.color(K.isEmpty?I.TEXT_DISABLED:K.isLocal?I.GOLD:I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT),"partySlotUI"]);if(j.push(he),K.isLocal){const me=e.add([e.text("(You)",{size:Q.SMALL-4}),e.pos(o+i-20,q+a/2),e.anchor("right"),e.color(...I.GOLD),e.fixed(),e.z(P.UI_TEXT),"partySlotUI"]);j.push(me)}c.push(j)})}u();let d=0;e.onUpdate(()=>{d+=e.dt(),d>=1&&(d=0,u())});const x=n+4*(a+r)+10;e.add([e.text("Invite Code:",{size:Q.SMALL-2}),e.pos(o+10,x),e.anchor("left"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT)]);const f=$o(),A=e.add([e.text(f,{size:Q.SMALL-2}),e.pos(o+i-10,x),e.anchor("right"),e.color(f==="OFFLINE"?[...I.TEXT_DISABLED]:[...I.GOLD]),e.fixed(),e.z(P.UI_TEXT)]);let g=f!=="OFFLINE";A.onUpdate(()=>{if(!g){const ee=$o();ee!=="OFFLINE"&&(A.text=ee,A.color=e.rgb(...I.GOLD),g=!0)}});const w=x+25;Vo(e,"JOIN PARTY",o+i/2,w,120,30,Q.SMALL-2).onClick(()=>{$t(),e.go("joinParty")}),Un(e,t);const R=130,X=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],_=[],p=12,y=R-X.length*p/2;X.forEach((ee,K)=>{const Z=e.add([e.text(ee,{size:10,font:"monospace"}),e.pos(e.width()/2,y+K*p),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.z(P.UI_TEXT),"titleLine"]);_.push(Z)});let b=0;e.onUpdate(()=>{b+=e.dt(),_.forEach((ee,K)=>{const Z=(b*50+K*20)%360,q=E(Z,80,60);ee.color=e.rgb(...q);const j=Math.sin(b*2+K*.3)*2;ee.pos.y=y+K*p+j,Math.random()<.001&&(ee.pos.x=e.width()/2+(Math.random()-.5)*10,e.wait(.1,()=>{ee.exists()&&(ee.pos.x=e.width()/2)}))})});function E(ee,K,Z){K/=100,Z/=100;const q=(1-Math.abs(2*Z-1))*K,j=q*(1-Math.abs(ee/60%2-1)),ae=Z-q/2;let ge=0,he=0,me=0;return ee>=0&&ee<60?(ge=q,he=j,me=0):ee>=60&&ee<120?(ge=j,he=q,me=0):ee>=120&&ee<180?(ge=0,he=q,me=j):ee>=180&&ee<240?(ge=0,he=j,me=q):ee>=240&&ee<300?(ge=j,he=0,me=q):ee>=300&&ee<360&&(ge=q,he=0,me=j),[Math.round((ge+ae)*255),Math.round((he+ae)*255),Math.round((me+ae)*255)]}const T=280,C=O0.BUTTON_VERTICAL,N=e.width()/2,B=Vo(e,"Start Game",N,T,350,55,Q.HEADER);B.onClick(()=>{$t(),nl()>1&&Tp(),e.go("game",{resetState:!0})});const v=Vo(e,"Character Select",N,T+C,350,50,Q.BUTTON);v.onClick(()=>{$t(),e.go("characterSelect")});const z=Is(),G=ro[z];if(G){const ee=to("characters",z)||G.unlockedByDefault,K=N+175+60,Z=T+C,q=50;e.add([e.rect(q,q),e.pos(K,Z),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.BORDER)),e.fixed(),e.z(P.UI_BACKGROUND)]),e.add([e.text(G.char,{size:36}),e.pos(K,Z),e.anchor("center"),e.color(...ee?G.color:I.BG_DISABLED),e.fixed(),e.z(P.UI_TEXT)]),e.add([e.text(G.name,{size:Q.SMALL-2}),e.pos(K,Z+35),e.anchor("center"),e.color(...ee?I.TEXT_PRIMARY:I.TEXT_DISABLED),e.fixed(),e.z(P.UI_TEXT)])}const J=Vo(e,"Shop",N,T+C*2,350,50,Q.BUTTON);J.onClick(()=>{$t(),e.go("shop")});const se=Vo(e,"Statistics",N,T+C*3,350,50,Q.BUTTON);se.onClick(()=>{$t(),e.go("statistics")});const V=Vo(e,"Options",N,T+C*4,350,50,Q.BUTTON);V.onClick(()=>{$t(),e.go("settings")});const k=[B,v,J,se,V];let fe=0;e.onUpdate(()=>{fe+=e.dt(),k.forEach((ee,K)=>{if(!ee.exists()||ee.isHovered)return;const Z=(fe*60+K*50)%360,q=E(Z,70,50);try{const j=e.rgb(q[0],q[1],q[2]);ee.color=j,ee.originalColor=q}catch(j){console.error("Color update error:",j)}})});const oe=e.onKeyPress("space",()=>{$t(),e.go("game",{resetState:!0})}),Ie=e.onKeyPress("c",()=>{mt(),e.go("characterSelect")}),Ee=e.onKeyPress("s",()=>{mt(),e.go("shop")}),Re=e.onKeyPress("o",()=>{mt(),e.go("settings")}),Ae=e.onKeyPress("t",()=>{mt(),e.go("statistics")});e.onSceneLeave(()=>{oe.cancel(),Ie.cancel(),Ee.cancel(),Re.cancel(),Ae.cancel()});const Ce=[["<o>","(o)","<O>","(O)"],["~@~","^@^","~o~","^o^"],["[#]","{#}","<#>","(#)"],["===","---","___","~~~"],["<>","><","^v","vA"]];for(let ee=0;ee<8;ee++){const K=Ce[Math.floor(Math.random()*Ce.length)],Z=e.add([e.text(K[0],{size:16,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...I.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(P.PARTICLES)]);Z.speed=30+Math.random()*50,Z.direction=Math.random()<.5?1:-1,Z.animFrame=0,Z.creatureSet=K,Z.onUpdate(()=>{Z.pos.x+=Z.speed*Z.direction*e.dt(),Z.animFrame+=e.dt()*4;const q=Math.floor(Z.animFrame)%Z.creatureSet.length;Z.text=Z.creatureSet[q],Z.direction>0&&Z.pos.x>e.width()+50?(Z.pos.x=-50,Z.pos.y=Math.random()*e.height()):Z.direction<0&&Z.pos.x<-50&&(Z.pos.x=e.width()+50,Z.pos.y=Math.random()*e.height())})}for(let ee=0;ee<15;ee++){const K="01".split(""),Z=e.add([e.text(K[Math.floor(Math.random()*K.length)],{size:14,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(50+Math.random()*50,100+Math.random()*100,50+Math.random()*50),e.opacity(.2+Math.random()*.3),e.z(P.PARTICLES)]);Z.speed=40+Math.random()*80,Z.charChangeTimer=0,Z.chars=K,Z.onUpdate(()=>{Z.pos.y+=Z.speed*e.dt(),Z.charChangeTimer+=e.dt(),Z.charChangeTimer>.1&&(Z.text=Z.chars[Math.floor(Math.random()*Z.chars.length)],Z.charChangeTimer=0),Z.pos.y>e.height()&&(Z.pos.y=-20,Z.pos.x=Math.random()*e.width())})}const Te=["","","","","","","",""];for(let ee=0;ee<12;ee++){const K=e.add([e.text(Te[Math.floor(Math.random()*Te.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...I.BG_LIGHT),e.opacity(.15),e.z(P.PARTICLES)]);K.pulseTime=Math.random()*Math.PI*2,K.pulseSpeed=1+Math.random()*2,K.onUpdate(()=>{K.pulseTime+=e.dt()*K.pulseSpeed;const Z=.8+Math.sin(K.pulseTime)*.3;K.scale=e.vec2(Z,Z),K.opacity=.1+Math.abs(Math.sin(K.pulseTime))*.15})}for(let ee=0;ee<20;ee++){const K=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...I.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(P.PARTICLES)]);K.speed=10+Math.random()*20,K.onUpdate(()=>{K.pos.y+=K.speed*e.dt(),K.pos.y>e.height()&&(K.pos.y=0,K.pos.x=Math.random()*e.width())})}const He=[];e.loop(5,()=>{if(He.length<3&&Math.random()<.3){const ee=["","","","","","",""],K=e.add([e.text(ee[Math.floor(Math.random()*ee.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(P.PARTICLES)]);K.followSpeed=20+Math.random()*30,K.rotationSpeed=50+Math.random()*100,K.lifetime=15+Math.random()*10,K.onUpdate(()=>{const q=e.mousePos().sub(K.pos),j=q.len();if(j>5){const ae=q.scale(1/j);K.pos=K.pos.add(ae.scale(K.followSpeed*e.dt()))}if(K.angle+=K.rotationSpeed*e.dt(),K.lifetime-=e.dt(),K.lifetime<=0){e.destroy(K);const ae=He.indexOf(K);ae>-1&&He.splice(ae,1)}}),He.push(K)}}),e.loop(10,()=>{if(Math.random()<.15){const ee=100+Math.random()*(e.height()-200),K=Math.random()<.5?1:-1,Z=K>0?-50:e.width()+50,q=e.add([e.text("$",{size:24}),e.pos(Z,ee),e.color(...I.GOLD),e.area({scale:2.5}),e.anchor("center"),e.z(P.PARTICLES+1),"goldenEnemy"]);q.speed=150+Math.random()*100,q.direction=K,q.pulseTime=0,q.onClick(()=>{if(!q.exists())return;cn(1);for(let ae=0;ae<12;ae++){const ge=Math.PI*2*ae/12,he=e.add([e.text(["$","","",""][Math.floor(Math.random()*4)],{size:14}),e.pos(q.pos.x,q.pos.y),e.color(...I.GOLD),e.z(P.PARTICLES+2)]),me=100+Math.random()*100;he.velocity=e.vec2(Math.cos(ge)*me,Math.sin(ge)*me),he.life=1,he.onUpdate(()=>{he.pos=he.pos.add(he.velocity.scale(e.dt())),he.life-=e.dt(),he.opacity=he.life,he.life<=0&&e.destroy(he)})}const j=e.add([e.text("+$1",{size:20}),e.pos(q.pos.x,q.pos.y),e.anchor("center"),e.color(...I.SUCCESS),e.z(P.UI_TEXT)]);j.life=1.5,j.onUpdate(()=>{j.pos.y-=50*e.dt(),j.life-=e.dt(),j.opacity=j.life/1.5,j.life<=0&&e.destroy(j)}),e.destroy(q),e.wait(.1,()=>e.go("menu"))}),q.onUpdate(()=>{q.pos.x+=q.speed*q.direction*e.dt(),q.pulseTime+=e.dt();const j=Math.sin(q.pulseTime*8)*.2;q.scale=e.vec2(1+j,1+j),(q.direction>0&&q.pos.x>e.width()+100||q.direction<0&&q.pos.x<-100)&&e.destroy(q)})}})})}function df(e){e.scene("gameOver",t=>{const o=(t==null?void 0:t.runStats)||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},s=(t==null?void 0:t.currencyEarned)||0,i=qo(),a=ap(),r=On();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...I.BG_DARK),e.opacity(.95),e.fixed(),e.z(P.OVERLAY)]),e.add([e.text("Game Over",{size:48}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...I.DANGER),e.fixed(),e.z(P.MODAL)]);const h=160,l=30;e.add([e.text("Run Statistics",{size:Q.HEADER}),e.pos(e.width()/2,h),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.MODAL)]),e.add([e.text(`${Oo.FLOOR}s Reached: ${o.floorsReached}`,{size:Q.LABEL}),e.pos(e.width()/2,h+l),e.anchor("center"),e.color(...I.INFO),e.fixed(),e.z(P.MODAL)]),e.add([e.text(`${Oo.ROOM}s Cleared: ${o.roomsCleared}`,{size:Q.LABEL}),e.pos(e.width()/2,h+l*2),e.anchor("center"),e.color(...I.INFO),e.fixed(),e.z(P.MODAL)]),e.add([e.text(`Enemies Killed: ${o.enemiesKilled}`,{size:Q.LABEL}),e.pos(e.width()/2,h+l*3),e.anchor("center"),e.color(...I.INFO),e.fixed(),e.z(P.MODAL)]),o.bossesKilled>0&&e.add([e.text(`Bosses Defeated: ${o.bossesKilled}`,{size:Q.LABEL}),e.pos(e.width()/2,h+l*4),e.anchor("center"),e.color(...I.BOSS_NAME),e.fixed(),e.z(P.MODAL)]);const n=h+l*(o.bossesKilled>0?6:5);e.add([e.text(`${r} Earned: +${s}`,{size:Q.BUTTON}),e.pos(e.width()/2,n),e.anchor("center"),e.color(...I.SUCCESS),e.fixed(),e.z(P.MODAL)]),e.add([e.text(`Total ${r}: ${i}`,{size:Q.LABEL}),e.pos(e.width()/2,n+30),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.MODAL)]);const c=n+80;e.add([e.text("Lifetime Stats",{size:Q.BUTTON}),e.pos(e.width()/2,c),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.MODAL)]),e.add([e.text(`Best ${Oo.FLOOR}: ${a.stats.bestFloor} | Total Runs: ${a.stats.totalRuns}`,{size:Q.BODY}),e.pos(e.width()/2,c+25),e.anchor("center"),e.color(...I.TEXT_TERTIARY),e.fixed(),e.z(P.MODAL)]),e.add([e.text("Press SPACE to Restart",{size:Q.HEADER}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...I.TEXT_TERTIARY),e.fixed(),e.z(P.MODAL)]),e.add([e.text("Press T for Statistics | ESC to Return to Menu",{size:Q.BODY}),e.pos(e.width()/2,e.height()-30),e.anchor("center"),e.color(...I.TEXT_DISABLED),e.fixed(),e.z(P.MODAL)]),e.onKeyPress("space",()=>{$t(),e.go("game",{resetState:!0})}),e.onKeyPress("t",()=>{mt(),e.go("statistics")}),e.onKeyPress("escape",()=>{mt(),e.go("menu")})})}function uf(e){e.scene("shop",()=>{const t=qo(),o=On();let s="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...I.BG_DARK),e.fixed(),e.z(P.BACKGROUND)]),bi(e,{patternCount:10,particleCount:15}),e.add([e.text(fo("Shop"),{size:Q.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);const i=Un(e,t),a=90,r=120,h=100,l=30,n=[{key:"permanentUpgrades",label:"Upgrades"},{key:"characters",label:"Characters"},{key:"weapons",label:"Weapons"}],c=(n.length-1)*r,u=e.width()/2-c/2,d=[];n.forEach((p,y)=>{const b=u+y*r,E=s===p.key,T=e.add([e.rect(h,l),e.pos(b,a),e.anchor("center"),e.color(...E?I.SECONDARY:I.BG_MEDIUM),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),C=e.add([e.text(p.label,{size:Q.BODY}),e.pos(b,a),e.anchor("center"),e.color(...E?I.TEXT_PRIMARY:I.TEXT_TERTIARY),e.fixed(),e.z(P.UI_TEXT)]);T.onClick(()=>{mt(),s=p.key,w()}),d.push({bg:T,label:C,category:p.key})});const x=140,f=e.height()-x-60;let A=[],g=!1;function w(){const p=qo();i.updateCurrency(p),d.forEach(v=>{const z=s===v.category;v.bg.color=e.rgb(z?100:50,z?100:50,z?150:80),v.label.color=e.rgb(z?255:150,z?255:150,z?255:150)}),X(),A.forEach(v=>{v.exists()&&e.destroy(v)}),A=[];const y=Zr(s),E=Object.keys(y).filter(v=>{const z=y[v];return s==="permanentUpgrades"?!0:!z.unlockedByDefault});if(E.length===0){const v=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,x+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);A.push(v);return}const T=100,C=x+20,N=Math.floor(f/T),B=Math.min(N,E.length);E.forEach((v,z)=>{const G=y[v],J=Math.floor(z/B),se=z%B,V=50+J*350,k=C+se*T,fe=s==="characters"&&to("characters",v),oe=fe?e.rgb(100,255,100):e.rgb(80,80,100),Ie=e.add([e.rect(320,90),e.pos(V,k),e.anchor("topleft"),e.color(40,40,50),e.outline(2,oe),e.area(),e.fixed(),e.z(1e3)]);if(s==="characters"&&G.char){const j=e.add([e.text(G.char,{size:32}),e.pos(V+25,k+45),e.anchor("center"),e.color(...fe&&G.color?G.color:[100,100,100]),e.fixed(),e.z(1001)]);A.push(j)}const Ee=s==="characters"&&G.char?V+70:V+10,Re=e.add([e.text(G.name,{size:18}),e.pos(Ee,k+10),e.anchor("topleft"),e.color(255,255,255),e.fixed(),e.z(1001)]),Ae=s==="characters"&&G.char?V+70:V+10,Ce=s==="characters"&&G.char?230:300,Te=e.add([e.text(G.description,{size:14,width:Ce}),e.pos(Ae,k+35),e.anchor("topleft"),e.color(200,200,200),e.fixed(),e.z(1001)]);function He(j){const ae=[50,65,90,115,160];return j<ae.length?ae[j]:160+(j-4)*50}let ee="",K=!1,Z=G.cost;if(s==="permanentUpgrades"){const j=uo(v),ae=G.maxLevel||1;j>=ae?ee=`MAX (${j}/${ae})`:(ee=`Level ${j}/${ae}`,Z=He(j),K=t>=Z)}else s==="characters"?to("characters",v)||(K=t>=Z):to(s,v)?ee="UNLOCKED":K=t>=Z;let q=null;if(ee&&s!=="characters"){const j=s==="characters"&&G.char?V+70:V+10;q=e.add([e.text(ee,{size:14}),e.pos(j,k+60),e.anchor("topleft"),e.color(to(s,v)||s==="permanentUpgrades"&&uo(v)>0?100:200,to(s,v)||s==="permanentUpgrades"&&uo(v)>0?255:200,to(s,v)||s==="permanentUpgrades"&&uo(v)>0?100:200),e.fixed(),e.z(1001)])}if(K||s==="permanentUpgrades"&&uo(v)<(G.maxLevel||1)){const j=e.add([e.rect(80,30),e.pos(V+230,k+55),e.anchor("topleft"),e.color(K?50:30,K?150:30,K?50:30),e.outline(2,e.rgb(K?100:50,K?200:50,K?100:50)),e.area(),e.fixed(),e.z(1001)]),ae=e.add([e.text(`$${Z}`,{size:14}),e.pos(V+270,k+70),e.anchor("center"),e.color(K?255:150,K?255:150,K?255:150),e.fixed(),e.z(1002)]);K&&j.onClick(()=>{if(g)return;g=!0;let ge;if(s==="permanentUpgrades"?ge=dp(v,Z,G.maxLevel):ge=cp(s,v,Z),s==="permanentUpgrades")if(ge&&ge.success){zi();const he=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{he.exists()&&e.destroy(he)}),w(),g=!1}else if(ge&&ge.reason==="insufficientCurrency"){Ni();const he=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{he.exists()&&e.destroy(he)}),g=!1}else g=!1;else if(ge){zi();const he=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{he.exists()&&e.destroy(he)}),w(),g=!1}else{Ni();const he=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{he.exists()&&e.destroy(he)}),g=!1}}),A.push(j,ae)}A.push(Ie,Re,Te),q&&A.push(q)})}let D=null,R=null;function X(){const p=Wr();s==="permanentUpgrades"&&p>0?D?(R.text=`REFUND: $${p}`,D.hidden=!1,R.hidden=!1):(D=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),R=e.add([e.text(`REFUND: $${p}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(P.UI_TEXT)]),D.onClick(()=>{up().success?(zi(),w()):Ni()})):D&&(D.hidden=!0,R&&(R.hidden=!0))}w();const _=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.NEUTRAL),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]);e.add([e.text(fo("Back"),{size:Q.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT)]),_.onClick(()=>{mt(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const Dl="superSmashTexty_settings",li={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:1},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showDamageNumbers:!0,compactHUD:!1},gameplay:{autoPause:!1}};function Tl(){try{const e=localStorage.getItem(Dl);if(e){const t=JSON.parse(e);return Cl(li,t)}}catch(e){console.error("Error loading settings:",e)}return{...li}}function Cl(e,t){const o={...e};return _i(e)&&_i(t)&&Object.keys(t).forEach(s=>{_i(t[s])?s in e?o[s]=Cl(e[s],t[s]):Object.assign(o,{[s]:t[s]}):Object.assign(o,{[s]:t[s]})}),o}function _i(e){return e&&typeof e=="object"&&!Array.isArray(e)}function Il(e){try{return localStorage.setItem(Dl,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function Ba(){return Tl()}function bo(e,t,o){const s=Tl();return s[e]||(s[e]={}),s[e][t]=o,Il(s),s}function pf(){return Il({...li}),{...li}}function ff(e,t){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(P.OVERLAY)]),a=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(3,e.rgb(...I.BORDER)),e.fixed(),e.z(P.OVERLAY+1)]),r=[];function h(){r.forEach(A=>{A&&A.exists&&A.exists()&&e.destroy(A)})}const l=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(P.OVERLAY+2)]),n=e.add([e.text("Cancel",{size:Q.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+3)]);l.onClick(()=>{h()}),r.push(o,a,l,n);const c=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(P.OVERLAY+2)]),u=e.add([e.text("Reset",{size:Q.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(P.OVERLAY+3)]);c.onClick(()=>{h(),t()}),r.push(c,u);const d=e.add([e.text("Reset to Defaults?",{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+2)]);r.push(d);const x=e.add([e.text("This will reset all settings to their default values.",{size:Q.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.OVERLAY+2)]);r.push(x);const f=e.onKeyPress("escape",()=>{h(),f.cancel()})}function gf(e,t,o){const s=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(P.OVERLAY)]),r=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(3,e.rgb(...I.BORDER)),e.fixed(),e.z(P.OVERLAY+1)]);e.add([e.text("Edit Player Name",{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+2)]);const h=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...I.BG_LIGHT),e.outline(2,e.rgb(...I.GOLD)),e.fixed(),e.z(P.OVERLAY+2)]);let l=t;const n=e.add([e.text(l,{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.OVERLAY+3)]),c=e.add([e.text("(Max 20 characters)",{size:Q.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.OVERLAY+2)]);function u(){e.destroy(s),e.destroy(r),h.destroy(),n.destroy(),c.destroy()}const d=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(P.OVERLAY+2)]);e.add([e.text("Cancel",{size:Q.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.OVERLAY+3)]),d.onClick(()=>{u()});const x=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.GOLD)),e.area(),e.fixed(),e.z(P.OVERLAY+2)]);e.add([e.text("Save",{size:Q.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.OVERLAY+3)]),x.onClick(()=>{l.trim().length>0?(o(l.trim()),u()):(c.text="Name cannot be empty!",c.color=e.rgb(255,100,100))}),e.onCharInput(f=>{l.length<20&&/[a-zA-Z0-9 ]/.test(f)&&(l+=f,n.text=l,c.text="(Max 20 characters)",c.color=e.rgb(...I.TEXT_SECONDARY))}),e.onKeyPress("backspace",()=>{l.length>0&&(l=l.slice(0,-1),n.text=l||" ")}),e.onKeyPress("escape",()=>{u()}),e.onKeyPress("enter",()=>{l.trim().length>0&&(o(l.trim()),u())})}function mf(e){e.scene("settings",t=>{const o=(t==null?void 0:t.fromGame)||!1;let s=Ba(),i="player";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...I.BG_DARK),e.fixed(),e.z(P.BACKGROUND)]),bi(e,{patternCount:10,particleCount:15}),e.add([e.text(fo("Options"),{size:Q.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);const a=90,r=120,h=100,l=30,n=[{key:"player",label:"Player"},{key:"audio",label:"Audio"},{key:"controls",label:"Controls"},{key:"visual",label:"Visual"},{key:"gameplay",label:"Gameplay"}],c=(n.length-1)*r,u=e.width()/2-c/2,d=[];n.forEach((p,y)=>{const b=u+y*r,E=i===p.key,T=e.add([e.rect(h,l),e.pos(b,a),e.anchor("center"),e.color(E?100:50,E?100:50,E?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),C=e.add([e.text(p.label,{size:16}),e.pos(b,a),e.anchor("center"),e.color(E?255:150,E?255:150,E?255:150),e.fixed(),e.z(P.UI_TEXT)]);T.onClick(()=>{i=p.key,w()}),d.push({bg:T,label:C,key:p.key})});const x=140,f=50,A=150;let g=[];function w(){d.forEach(b=>{const E=i===b.key;b.bg.color=e.rgb(E?100:50,E?100:50,E?150:80),b.label.color=e.rgb(E?255:150,E?255:150,E?255:150)}),g.forEach(b=>{b.exists()&&e.destroy(b)}),g=[],s=Ba();const p=x+20;let y=p;if(i==="player"){const b=e.add([e.text("Player Name:",{size:Q.LABEL}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_ELEMENTS)]);g.push(b),y+=40;let E=Ln();const T=e.add([e.rect(300,40),e.pos(e.width()/2,y),e.anchor("center"),e.color(...I.BG_LIGHT),e.outline(2,e.rgb(...I.BORDER)),e.fixed(),e.z(P.UI_ELEMENTS)]),C=e.add([e.text(E,{size:Q.LABEL}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.UI_TEXT)]);g.push(T,C),y+=60;const N=e.add([e.rect(140,35),e.pos(e.width()/2-80,y),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),B=e.add([e.text("Edit Name",{size:Q.SMALL}),e.pos(e.width()/2-80,y),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);N.onClick(()=>{gf(e,E,k=>{ua(k),C.text=k,E=k})});const v=e.add([e.rect(140,35),e.pos(e.width()/2+80,y),e.anchor("center"),e.color(...I.BG_MEDIUM),e.outline(2,e.rgb(...I.GOLD)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),z=e.add([e.text("Randomize",{size:Q.SMALL}),e.pos(e.width()/2+80,y),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.UI_TEXT)]);v.onClick(()=>{const k=an();ua(k),C.text=k,E=k}),g.push(N,B,v,z),y+=60;const G=e.add([e.text("Your Invite Code:",{size:Q.LABEL}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_ELEMENTS)]);g.push(G),y+=40;const J=$o(),se=e.add([e.text(J,{size:Q.TITLE}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.UI_ELEMENTS)]);g.push(se),y+=50;const V=e.add([e.text("Share this code with friends to join your party!",{size:Q.SMALL-2}),e.pos(e.width()/2,y),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_ELEMENTS)]);g.push(V)}else if(i==="audio")y=D(e,"Master Volume",s.audio.masterVolume,y,b=>{bo("audio","masterVolume",b)}),y=D(e,"SFX Volume",s.audio.sfxVolume,y,b=>{bo("audio","sfxVolume",b)}),y=D(e,"Music Volume",s.audio.musicVolume,y,b=>{bo("audio","musicVolume",b)});else if(i==="controls"){const b=s.controls,E=[{label:"Move Up",key:"moveUp",value:b.moveUp},{label:"Move Down",key:"moveDown",value:b.moveDown},{label:"Move Left",key:"moveLeft",value:b.moveLeft},{label:"Move Right",key:"moveRight",value:b.moveRight},{label:"Pause",key:"pause",value:b.pause},{label:"Interact",key:"interact",value:b.interact}];E.forEach((C,N)=>{const B=p+N*f,v=e.add([e.text(C.label+":",{size:16}),e.pos(150,B),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(P.UI_ELEMENTS)]),z=e.add([e.rect(100,30),e.pos(500,B),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(P.UI_ELEMENTS)]),G=e.add([e.text(C.value.toUpperCase(),{size:16}),e.pos(500,B),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(P.UI_TEXT)]);g.push(v,z,G)});const T=p+E.length*f;if(T<e.height()-A){const C=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,T+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(P.UI_ELEMENTS)]);g.push(C)}}else if(i==="visual")y=R(e,"Show Particles",s.visual.showParticles,y,b=>{bo("visual","showParticles",b)}),y=R(e,"Show Screen Shake",s.visual.showScreenShake,y,b=>{bo("visual","showScreenShake",b)}),y=R(e,"Show Damage Numbers",s.visual.showDamageNumbers,y,b=>{bo("visual","showDamageNumbers",b)}),y=R(e,"Compact HUD",s.visual.compactHUD,y,b=>{bo("visual","compactHUD",b)});else if(i==="gameplay"&&(y=R(e,"Auto-pause on Level Up",s.gameplay.autoPause,y,b=>{bo("gameplay","autoPause",b)}),y<e.height()-A)){const b=e.add([e.text("(More gameplay options coming soon)",{size:12}),e.pos(e.width()/2,y+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(P.UI_ELEMENTS)]);g.push(b)}}function D(p,y,b,E,T){const C=p.add([p.text(y+":",{size:16}),p.pos(150,E),p.anchor("left"),p.color(200,200,200),p.fixed(),p.z(P.UI_ELEMENTS)]),N=300,B=20,v=p.add([p.rect(N,B),p.pos(500,E),p.anchor("center"),p.color(50,50,70),p.outline(2,p.rgb(100,100,120)),p.area(),p.fixed(),p.z(P.UI_ELEMENTS)]);function z(Ee){if(Ee<.5){const Re=Ee*2;return{r:255,g:Math.round(255*Re),b:0}}else{const Re=(Ee-.5)*2;return{r:Math.round(255*(1-Re)),g:255,b:0}}}const G=N*b,J=z(b),se=p.add([p.rect(G,B-4),p.pos(500-(N-G)/2,E),p.anchor("center"),p.color(J.r,J.g,J.b),p.fixed(),p.z(P.UI_TEXT)]),V=500-N/2+G,k=p.add([p.rect(20,B+4),p.pos(V,E),p.anchor("center"),p.color(200,200,255),p.outline(2,p.rgb(150,150,200)),p.area(),p.fixed(),p.z(1002)]),fe=p.add([p.text(Math.round(b*100)+"%",{size:14}),p.pos(680,E),p.anchor("left"),p.color(255,255,255),p.fixed(),p.z(P.UI_ELEMENTS)]);let oe=!1;v.onClick(()=>{const Ee=p.mousePos().x,Re=500-N/2,Ae=Ee-Re,Ce=Math.max(0,Math.min(1,Ae/N));Ie(Ce)}),k.onClick(()=>{oe=!0}),p.onMouseMove(()=>{if(oe&&p.isMouseDown()){const Ee=p.mousePos().x,Re=500-N/2,Ae=Ee-Re,Ce=Math.max(0,Math.min(1,Ae/N));Ie(Ce)}else oe=!1}),p.onMouseRelease(()=>{oe=!1});function Ie(Ee){const Re=N*Ee;se.width=Re,se.pos.x=500-(N-Re)/2,k.pos.x=500-N/2+Re,fe.text=Math.round(Ee*100)+"%";const Ae=z(Ee);se.color=p.rgb(Ae.r,Ae.g,Ae.b),T(Ee)}return g.push(C,v,se,k,fe),E+f}function R(p,y,b,E,T){const C=p.add([p.text(y+":",{size:16,width:250}),p.pos(150,E),p.anchor("left"),p.color(200,200,200),p.fixed(),p.z(P.UI_ELEMENTS)]),N=60,v=p.add([p.rect(N,30),p.pos(500,E),p.anchor("center"),p.color(b?50:70,b?150:50,b?50:70),p.outline(2,p.rgb(100,100,120)),p.area(),p.fixed(),p.z(P.UI_ELEMENTS)]),z=24,G=b?500+N/2-z/2-4:500-N/2+z/2+4,J=p.add([p.rect(z,z),p.pos(G,E),p.anchor("center"),p.color(255,255,255),p.outline(1,p.rgb(200,200,200)),p.fixed(),p.z(P.UI_TEXT)]),se=p.add([p.text(b?"ON":"OFF",{size:14}),p.pos(500,E),p.anchor("center"),p.color(b?100:150,b?255:150,b?100:150),p.fixed(),p.z(1002)]);return v.onClick(()=>{const V=!b;v.color=p.rgb(V?50:70,V?150:50,V?50:70),J.pos.x=V?500+N/2-z/2-4:500-N/2+z/2+4,se.text=V?"ON":"OFF",se.color=p.rgb(V?100:150,V?255:150,V?100:150),T(V)}),g.push(C,v,J,se),E+f}const X=e.add([e.rect(150,35),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]);e.add([e.text("Reset to Defaults",{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(P.UI_TEXT)]),X.onClick(()=>{ff(e,()=>{pf(),w()})}),w();const _=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.NEUTRAL),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]);e.add([e.text(fo("Back"),{size:Q.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT)]),_.onClick(()=>{o?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{o?e.go("game"):e.go("menu")})})}function Oa(e,t,o){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),o=Math.max(0,Math.min(1,o));let s,i,a;if(t===0)s=i=a=o;else{const r=(n,c,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?n+(c-n)*6*u:u<.5?c:u<.6666666666666666?n+(c-n)*(.6666666666666666-u)*6:n),h=o<.5?o*(1+t):o+t-o*t,l=2*o-h;s=r(l,h,e+1/3),i=r(l,h,e),a=r(l,h,e-1/3)}return[Math.max(0,Math.min(255,Math.round(s*255))),Math.max(0,Math.min(255,Math.round(i*255))),Math.max(0,Math.min(255,Math.round(a*255)))]}function xf(e){e.scene("statistics",()=>{const t=$r(),o=fp(),s=On();let i="stats";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...I.BG_DARK),e.fixed(),e.z(P.BACKGROUND)]),bi(e,{patternCount:10,particleCount:15}),e.add([e.text(fo("Stats & Achievements"),{size:Q.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);const a=90,r=160,h=150,l=30,n=[{key:"stats",label:"Statistics"},{key:"achievements",label:"Achievements"}],c=(n.length-1)*r,u=e.width()/2-c/2,d=[];n.forEach((p,y)=>{const b=u+y*r,E=i===p.key,T=e.add([e.rect(h,l),e.pos(b,a),e.anchor("center"),e.color(...E?I.SECONDARY:I.BG_MEDIUM),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),C=e.add([e.text(p.label,{size:Q.BODY}),e.pos(b,a),e.anchor("center"),e.color(...E?I.TEXT_PRIMARY:I.TEXT_TERTIARY),e.fixed(),e.z(P.UI_TEXT)]);T.onClick(()=>{i=p.key,X()}),d.push({bg:T,label:C,key:p.key})});const x=140,f=40,A=60,g=f+A,w=x,D=e.height()-g;let R=[];function X(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(d.forEach(p=>{const y=i===p.key;p.bg.color=e.rgb(y?100:50,y?100:50,y?150:80),p.label.color=e.rgb(y?255:150,y?255:150,y?255:150)}),R.forEach(p=>{if(p&&typeof p.exists=="function"&&p.exists())try{e.destroy(p)}catch(y){console.warn("Error destroying content item:",y)}}),R=[],i==="stats"){const p=x+20,y=30;[{label:"Total Runs",value:t.totalRuns||0},{label:"Best Floor",value:t.bestFloor||1},{label:"Best Room",value:t.bestRoom||1},{label:"Best Level",value:t.bestLevel||1},{label:"Total Enemies Killed",value:t.totalEnemiesKilled||0},{label:"Total Bosses Killed",value:t.totalBossesKilled||0},{label:"Total Rooms Cleared",value:t.totalRoomsCleared||0},{label:"Total Floors Reached",value:t.totalFloorsReached||0},{label:`Total ${s} Earned`,value:t.totalCurrencyEarned||0}].forEach((E,T)=>{const C=p+T*y,N=e.add([e.text(E.label+":",{size:18}),e.pos(200,C),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]),B=e.add([e.text(E.value.toString(),{size:18}),e.pos(500,C),e.anchor("left"),e.color(255,255,255),e.fixed(),e.z(1e3)]);R.push(N,B)})}else if(i==="achievements")try{const p=K0(),y=50,b=10,E=25,T=25,C=40,N=(e.width()-100-C)/2,B=D-w-20,v=50,z=e.width()/2+C/2;let G=x+10,J=x+10;p.forEach((Te,He)=>{const ee=V0(Te);if(ee.length===0)return;const K=He%2===0,Z=K?v:z;let q=K?G:J;const j=Te.charAt(0).toUpperCase()+Te.slice(1),ae=e.add([e.text(j,{size:18}),e.pos(Z+N/2,q),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(1e3)]);R.push(ae),q+=T+5;const ge=Math.max(1,Math.floor(N/(y+b))),me=Math.min(ge,ee.length)*(y+b)-b,Se=Z+(N-me)/2;ee.forEach((Kt,Lt)=>{const Ve=o.includes(Kt.id),St=Math.floor(Lt/ge),xt=Lt%ge,Qe=Se+xt*(y+b),ke=q+St*(y+b);if(!isFinite(Qe)||!isFinite(ke)||Qe<0||ke<0){console.warn("Invalid box position:",{boxX:Qe,boxY:ke,index:Lt,col:xt,row:St});return}let Ze,zt,Nt,et,dt;try{Ze=e.add([e.rect(y,y),e.pos(Qe,ke),e.anchor("topleft"),e.color(Ve?40:25,Ve?40:25,Ve?50:25),e.outline(2,e.rgb(Ve?150:60,Ve?150:60,Ve?200:60)),e.area({width:y,height:y}),e.fixed(),e.z(1e3)])}catch(jt){console.error("Error creating boxBg:",jt,{boxX:Qe,boxY:ke,boxSize:y});return}try{zt=e.add([e.text(Kt.icon,{size:28}),e.pos(Qe+y/2,ke+y/2),e.anchor("center"),e.color(Ve?255:80,Ve?255:80,Ve?255:80),e.fixed(),e.z(1001)])}catch(jt){console.error("Error creating iconText:",jt),Ze&&e.destroy(Ze);return}const ts=e.add([e.text(Kt.name,{size:12,width:y+20}),e.pos(Qe+y/2,ke+y+12),e.anchor("center"),e.color(Ve?200:100,Ve?200:100,Ve?200:100),e.fixed(),e.z(1001)]);R.push(Ze,zt,ts)});const it=Math.ceil(ee.length/ge),Zt=T+5+it*(y+b)+E;K?G+=Zt:J+=Zt});const se=Object.keys(Ai).length,V=o.length,k=V/se,fe=e.height()-A-f/2,oe=600,Ie=25,Ee=e.width()/2,Re=e.add([e.rect(oe,Ie),e.pos(Ee,fe),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(100,100,150)),e.fixed(),e.z(1e3)]);R.push(Re);const Ae=oe*k;if(Ae>2&&k>0&&isFinite(Ae)){const Te=Math.min(15,Math.max(3,Math.floor(Ae/15)));if(Te>0&&isFinite(Te)){const He=Ae/Te;if(He>0&&isFinite(He))for(let ee=0;ee<Te;ee++){const K=Ee-oe/2+ee*He,Z=ee/Te*360,q=Oa(Z/360,1,.5);if(isFinite(K)&&He>0){const j=e.add([e.rect(He,Ie-4),e.pos(K+He/2,fe),e.anchor("center"),e.color(q[0],q[1],q[2]),e.fixed(),e.z(1001)]);j&&R.push(j)}}}}else if(Ae>0&&isFinite(Ae)){const Te=Oa(0,1,.5),He=Ee-oe/2+Ae/2;if(isFinite(He)){const ee=e.add([e.rect(Ae,Ie-4),e.pos(He,fe),e.anchor("center"),e.color(Te[0],Te[1],Te[2]),e.fixed(),e.z(1001)]);ee&&R.push(ee)}}const Ce=e.add([e.text(`${V}/${se} (${Math.round(k*100)}%)`,{size:16}),e.pos(Ee,fe+Ie/2+20),e.anchor("center"),e.color(200,200,255),e.fixed(),e.z(1e3)]);R.push(Ce)}catch(p){console.error("Error rendering achievements:",p);const y=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,x+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);R.push(y)}}X();const _=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.NEUTRAL),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]);e.add([e.text(fo("Back"),{size:Q.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT)]),_.onClick(()=>{e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}function yf(e){e.scene("characterSelect",()=>{const t=qo(),o=Is();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...I.BG_DARK),e.fixed(),e.z(P.BACKGROUND)]),bi(e,{patternCount:10,particleCount:15}),Un(e,t),e.add([e.text(fo("Characters"),{size:Q.TITLE}),e.pos(e.width()/2,40),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);const s=Object.keys(ro),a=350+20,r=e.width()-a-20,h=120,l=150,n=100,c=15,u=2,x=3*(n+c),f=Math.ceil(s.length/u);let A=0;const g=[];let w=o,D=[],R=!1;function X(){if(R)return;R=!0;const b=Math.max(0,f*(n+c)-x);g.forEach(V=>{V&&V.exists&&V.exists()&&e.destroy(V)}),g.length=0,D.forEach(V=>{V&&V.exists&&V.exists()&&e.destroy(V)}),D=[],A=Math.max(0,Math.min(A,b)),s.forEach((V,k)=>{const fe=ro[V],oe=to("characters",V)||fe.unlockedByDefault,Ie=w===V,Ee=Math.floor(k/u),Ae=20+k%u*(l+c),Ce=h+Ee*(n+c)-A;if(Ce>=h-n&&Ce<=h+x){const Te=e.add([e.rect(l,n),e.pos(Ae,Ce),e.anchor("topleft"),e.color(...Ie?I.BG_MEDIUM:I.BG_DARK),e.outline(2,Ie?e.rgb(...I.BORDER_ACTIVE):oe?e.rgb(...I.TEXT_DISABLED):e.rgb(...I.BG_DARK)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]),He=e.add([e.text(fe.char,{size:Q.TITLE}),e.pos(Ae+l/2,Ce+30),e.anchor("center"),e.color(...oe?fe.color:I.BG_DISABLED),e.fixed(),e.z(P.UI_TEXT)]),ee=e.add([e.text(fe.name,{size:Q.SMALL}),e.pos(Ae+l/2,Ce+70),e.anchor("center"),e.color(...oe?I.TEXT_PRIMARY:I.TEXT_DISABLED),e.fixed(),e.z(P.UI_TEXT)]);if(!oe){const K=e.add([e.text("",{size:Q.BUTTON}),e.pos(Ae+l/2,Ce+n/2),e.anchor("center"),e.color(...I.DANGER),e.fixed(),e.z(P.OVERLAY)]);g.push(K)}oe&&(Te.onClick(()=>{w!==V&&($t(),w=V,lp(V),Bp(V),X())}),Te.cursor="pointer"),g.push(Te,He,ee)}});const E=ro[w],T=to("characters",w)||E.unlockedByDefault;let C=h;const N=e.add([e.text(E.char,{size:72}),e.pos(a+r/2,C+40),e.anchor("center"),e.color(...T?E.color:I.BG_DISABLED),e.fixed(),e.z(P.UI_ELEMENTS)]);D.push(N),C+=100;const B=e.add([e.text(E.name,{size:Q.HEADER}),e.pos(a+r/2,C),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);D.push(B),C+=40;const v=e.add([e.text(E.description,{size:Q.SMALL,width:r-40}),e.pos(a+r/2,C),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT)]);D.push(v),C+=60;const z=e.add([e.text("Stats:",{size:Q.LABEL}),e.pos(a+20,C),e.anchor("left"),e.color(...I.WARNING),e.fixed(),e.z(P.UI_TEXT)]);D.push(z),C+=30;const G=e.add([e.text(`${Oo.HEALTH}: ${E.stats.health}`,{size:Q.BODY}),e.pos(a+40,C),e.anchor("left"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);D.push(G),C+=25;const J=e.add([e.text(`${Oo.SPEED}: ${E.stats.speed}`,{size:Q.BODY}),e.pos(a+40,C),e.anchor("left"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);D.push(J),C+=25;const se=e.add([e.text(`${Oo.DAMAGE}: ${E.stats.damage}`,{size:Q.BODY}),e.pos(a+40,C),e.anchor("left"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(P.UI_TEXT)]);if(D.push(se),C+=40,w===E){const V=e.add([e.text(" SELECTED",{size:Q.LABEL}),e.pos(a+r/2,C),e.anchor("center"),e.color(...I.SUCCESS),e.fixed(),e.z(P.UI_TEXT)]);D.push(V)}if(!T&&E.unlockRequirement){const V=e.add([e.text(`Unlock: Complete ${Oo.FLOOR} ${E.unlockRequirement.value}`,{size:Q.SMALL}),e.pos(a+r/2,C+30),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(P.UI_TEXT)]);D.push(V)}R=!1}X();const _=b=>{b.preventDefault(),b.stopPropagation();const E=A,T=Math.max(0,f*(n+c)-x);A+=b.deltaY*.3,A=Math.max(0,Math.min(A,T)),A!==E&&X()},p=document.querySelector("#game-container");p&&p.addEventListener("wheel",_,{passive:!1}),e.onDestroy(()=>{p&&p.removeEventListener("wheel",_)}),e.onKeyPress("arrowdown",()=>{const b=A,E=Math.max(0,f*(n+c)-x);A+=50,A=Math.max(0,Math.min(A,E)),A!==b&&X()}),e.onKeyPress("arrowup",()=>{const b=A,E=Math.max(0,f*(n+c)-x);A-=50,A=Math.max(0,Math.min(A,E)),A!==b&&X()});const y=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.NEUTRAL),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(P.UI_ELEMENTS)]);e.add([e.text(fo("Back"),{size:Q.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(P.UI_TEXT)]),y.onClick(()=>{mt(),e.go("menu")}),e.add([e.text("Click a character to select | Press SPACE to start",{size:Q.BODY}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(...I.TEXT_TERTIARY),e.fixed(),e.z(P.UI_TEXT)]),e.onKeyPress("escape",()=>{mt(),e.go("menu")}),e.onKeyPress("space",()=>{$t(),e.go("game",{resetState:!0})})})}function wf(e){e.scene("joinParty",()=>{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...I.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:Q.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:Q.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...I.TEXT_SECONDARY),e.fixed(),e.z(10)]);let t="";const o=e.add([e.text("______",{size:Q.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...I.GOLD),e.fixed(),e.z(10)]),s=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:Q.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...I.TEXT_DISABLED),e.fixed(),e.z(10)]);let i=!1;function a(){let l="";for(let n=0;n<6;n++)n<t.length?l+=t[n]:l+="_";o.text=l}e.onCharInput(l=>{i||/[a-zA-Z0-9]/.test(l)&&t.length<6&&(mt(),t+=l.toUpperCase(),a(),s.text="",t.length===6&&e.wait(.2,r))}),e.onKeyPress("backspace",()=>{i||t.length>0&&(mt(),t=t.slice(0,-1),a(),s.text="")}),e.onKeyPress("escape",()=>{mt(),i=!1,e.go("menu")}),e.onKeyPress("enter",()=>{i||t.length===6&&r()});async function r(){if(i)return;const l=t.trim();if(!ip(l)){s.text="Invalid invite code format",s.color=e.rgb(255,100,100);return}i=!0,s.text="Joining party...",s.color=e.rgb(...I.GOLD);try{await Rp(l)?($t(),s.text="Successfully joined party!",s.color=e.rgb(...I.SUCCESS),e.wait(1,()=>{e.go("menu")})):(i=!1,s.text="Failed to join party. Check the code and try again.",s.color=e.rgb(255,100,100),t="",a())}catch(n){i=!1,console.error("[JoinParty] Error joining party:",n),s.text="Connection error. Please try again.",s.color=e.rgb(255,100,100),t="",a()}}const h=e.add([e.rect(200,50),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...I.SECONDARY),e.outline(2,e.rgb(...I.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("Cancel",{size:Q.BUTTON}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...I.TEXT_PRIMARY),e.fixed(),e.z(11)]),h.onClick(()=>{mt(),i=!1,e.go("menu")}),h.onHoverUpdate(()=>{i||(h.color=e.rgb(...I.SECONDARY_HOVER))}),h.onHoverEnd(()=>{h.color=e.rgb(...I.SECONDARY)})})}const xo=tp({width:as.CANVAS_WIDTH,height:as.CANVAS_HEIGHT,background:as.BACKGROUND_COLOR,scale:as.CANVAS_SCALE,debug:as.DEBUG_MODE,root:document.querySelector("#game-container")});hf(xo);cf(xo);df(xo);uf(xo);mf(xo);xf(xo);yf(xo);wf(xo);xo.go("menu");
