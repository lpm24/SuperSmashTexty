(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();var _d=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return s=>{for(var o=s.length,n=new Uint8Array((o-(s[o-1]=="=")-(s[o-2]=="="))*3/4|0),r=0,a=0;r<o;){var c=e[s.charCodeAt(r++)],l=e[s.charCodeAt(r++)],d=e[s.charCodeAt(r++)],i=e[s.charCodeAt(r++)];n[a++]=c<<2|l>>4,n[a++]=l<<4|d>>2,n[a++]=d<<6|i}return n}})(),Fd={version:"3001.0.19"};function ms(e,t,s){return t>s?ms(e,s,t):Math.min(Math.max(e,t),s)}var He=class ut{r=255;g=255;b=255;constructor(t,s,o){this.r=ms(t,0,255),this.g=ms(s,0,255),this.b=ms(o,0,255)}static fromArray(t){return new ut(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new ut(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!s)throw new Error("Invalid hex color format");return new ut(parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,s,o){if(s==0)return new ut(255*o,255*o,255*o);let n=(i,p,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<1/6?i+(p-i)*6*h:h<1/2?p:h<2/3?i+(p-i)*(2/3-h)*6:i),r=o<.5?o*(1+s):o+s-o*s,a=2*o-r,c=n(a,r,t+1/3),l=n(a,r,t),d=n(a,r,t-1/3);return new ut(Math.round(c*255),Math.round(l*255),Math.round(d*255))}static RED=new ut(255,0,0);static GREEN=new ut(0,255,0);static BLUE=new ut(0,0,255);static YELLOW=new ut(255,255,0);static MAGENTA=new ut(255,0,255);static CYAN=new ut(0,255,255);static WHITE=new ut(255,255,255);static BLACK=new ut(0,0,0);clone(){return new ut(this.r,this.g,this.b)}lighten(t){return new ut(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new ut(255-this.r,255-this.g,255-this.b)}mult(t){return new ut(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,s){return new ut(Ft(this.r,t.r,s),Ft(this.g,t.g,s),Ft(this.b,t.b,s))}toHSL(){let t=this.r/255,s=this.g/255,o=this.b/255,n=Math.max(t,s,o),r=Math.min(t,s,o),a=(n+r)/2,c=a,l=a;if(n==r)a=c=0;else{let d=n-r;switch(c=l>.5?d/(2-n-r):d/(n+r),n){case t:a=(s-o)/d+(s<o?6:0);break;case s:a=(o-t)/d+2;break;case o:a=(t-s)/d+4;break}a/=6}return[a,c,l]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function Fe(...e){if(e.length===0)return new He(255,255,255);if(e.length===1){if(e[0]instanceof He)return e[0].clone();if(typeof e[0]=="string")return He.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return He.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof He)return e[0].clone()}else if(e.length===3||e.length===4)return new He(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var qd=(e,t,s)=>He.fromHSL(e,t,s);function mt(e){return e*Math.PI/180}function oo(e){return e*180/Math.PI}function Ft(e,t,s){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*s;if(e instanceof Q&&t instanceof Q||e instanceof He&&t instanceof He)return e.lerp(t,s);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function fs(e,t,s,o,n){return o+(e-t)/(s-t)*(n-o)}function Yd(e,t,s,o,n){return ms(fs(e,t,s,o,n),o,n)}var Q=class bt{x=0;y=0;constructor(t=0,s=t){this.x=t,this.y=s}static fromAngle(t){let s=mt(t);return new bt(Math.cos(s),Math.sin(s))}static fromArray(t){return new bt(t[0],t[1])}static ZERO=new bt(0,0);static ONE=new bt(1,1);static LEFT=new bt(-1,0);static RIGHT=new bt(1,0);static UP=new bt(0,-1);static DOWN=new bt(0,1);clone(){return new bt(this.x,this.y)}add(...t){let s=X(...t);return new bt(this.x+s.x,this.y+s.y)}sub(...t){let s=X(...t);return new bt(this.x-s.x,this.y-s.y)}scale(...t){let s=X(...t);return new bt(this.x*s.x,this.y*s.y)}dist(...t){let s=X(...t);return this.sub(s).len()}sdist(...t){let s=X(...t);return this.sub(s).slen()}static sdist(t,s){let o=t.x-s.x,n=t.y-s.y;return o*o+n*n}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new bt(0):this.scale(1/t)}normal(){return new bt(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,s){return t.x*s.x+t.y*s.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,s){return t.x*s.y-t.y*s.x}angle(...t){let s=X(...t);return oo(Math.atan2(this.y-s.y,this.x-s.x))}angleBetween(...t){let s=X(...t);return oo(Math.atan2(this.cross(s),this.dot(s)))}lerp(t,s){return new bt(Ft(this.x,t.x,s),Ft(this.y,t.y,s))}slerp(t,s){let o=this.dot(t),n=this.cross(t),r=Math.atan2(n,o);return this.scale(Math.sin((1-s)*r)).add(t.scale(Math.sin(s*r))).scale(1/n)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new bt(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Qe(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function X(...e){if(e.length===1){if(e[0]instanceof Q)return new Q(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new Q(...e[0])}return new Q(...e)}var it=class Wi{x=0;y=0;w=1;h=1;constructor(t,s,o,n){this.x=t,this.y=s,this.w=o,this.h=n}scale(t){return new Wi(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new Q(this.x,this.y)}clone(){return new Wi(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function pt(e,t,s,o){return new it(e,t,s,o)}var jn=class vo{a;b;c;d;constructor(t,s,o,n){this.a=t,this.b=s,this.c=o,this.d=n}mul(t){return new vo(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return X(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new vo(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new vo(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,s=this.det,o=t+Math.sqrt(t*t-s),n=t-Math.sqrt(t*t-s);return[o,n]}eigenvectors(t,s){return this.c!=0?[[t-this.d,this.c],[s-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,s-this.a]]:Math.abs(this.transform(X(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let s=Math.cos(t),o=Math.sin(t);return new vo(s,o,-o,s)}static scale(t,s){return new vo(t,0,0,s)}},jo=class $o{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,s,o,n,r,a,c,l,d){this.m11=t,this.m12=s,this.m13=o,this.m21=n,this.m22=r,this.m23=a,this.m31=c,this.m32=l,this.m33=d}static fromMat2(t){return new $o(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new jn(this.m11,this.m12,this.m21,this.m22)}mul(t){return new $o(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let s=Math.cos(t),o=Math.sin(t),n=this.m11,r=this.m12;return this.m11=s*this.m11+o*this.m21,this.m12=s*this.m12+o*this.m22,this.m21=s*this.m21-o*n,this.m22=s*this.m22-o*r,this}scale(t,s){return this.m11*=t,this.m12*=t,this.m21*=s,this.m22*=s,this}get inverse(){let t=this.det;return new $o((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new $o(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},xs=class Es{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new Es([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new Es([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=mt(-t);let s=Math.cos(t),o=Math.sin(t);return new Es([1,0,0,0,0,s,-o,0,0,o,s,0,0,0,0,1])}static rotateY(t){t=mt(-t);let s=Math.cos(t),o=Math.sin(t);return new Es([s,0,o,0,0,1,0,0,-o,0,s,0,0,0,0,1])}static rotateZ(t){t=mt(-t);let s=Math.cos(t),o=Math.sin(t);return new Es([s,-o,0,0,o,s,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=mt(-t);let s=Math.cos(t),o=Math.sin(t),n=this.m[0],r=this.m[1],a=this.m[4],c=this.m[5];return this.m[0]=n*s+r*o,this.m[1]=-n*o+r*s,this.m[4]=a*s+c*o,this.m[5]=-a*o+c*s,this}mult(t){let s=[];for(let o=0;o<4;o++)for(let n=0;n<4;n++)s[o*4+n]=this.m[0+n]*t.m[o*4+0]+this.m[4+n]*t.m[o*4+1]+this.m[8+n]*t.m[o*4+2]+this.m[12+n]*t.m[o*4+3];return new Es(s)}multVec2(t){return new Q(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new Q(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],s=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new Q(s,t/s)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],s=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new Q(t/s,s)}else return new Q(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return oo(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return oo(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new Q(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new Q(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new Q(0,0)}invert(){let t=[],s=this.m[10]*this.m[15]-this.m[14]*this.m[11],o=this.m[9]*this.m[15]-this.m[13]*this.m[11],n=this.m[9]*this.m[14]-this.m[13]*this.m[10],r=this.m[8]*this.m[15]-this.m[12]*this.m[11],a=this.m[8]*this.m[14]-this.m[12]*this.m[10],c=this.m[8]*this.m[13]-this.m[12]*this.m[9],l=this.m[6]*this.m[15]-this.m[14]*this.m[7],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],i=this.m[5]*this.m[14]-this.m[13]*this.m[6],p=this.m[4]*this.m[15]-this.m[12]*this.m[7],h=this.m[4]*this.m[14]-this.m[12]*this.m[6],f=this.m[5]*this.m[15]-this.m[13]*this.m[7],g=this.m[4]*this.m[13]-this.m[12]*this.m[5],u=this.m[6]*this.m[11]-this.m[10]*this.m[7],w=this.m[5]*this.m[11]-this.m[9]*this.m[7],v=this.m[5]*this.m[10]-this.m[9]*this.m[6],A=this.m[4]*this.m[11]-this.m[8]*this.m[7],D=this.m[4]*this.m[10]-this.m[8]*this.m[6],Y=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*s-this.m[6]*o+this.m[7]*n,t[4]=-(this.m[4]*s-this.m[6]*r+this.m[7]*a),t[8]=this.m[4]*o-this.m[5]*r+this.m[7]*c,t[12]=-(this.m[4]*n-this.m[5]*a+this.m[6]*c),t[1]=-(this.m[1]*s-this.m[2]*o+this.m[3]*n),t[5]=this.m[0]*s-this.m[2]*r+this.m[3]*a,t[9]=-(this.m[0]*o-this.m[1]*r+this.m[3]*c),t[13]=this.m[0]*n-this.m[1]*a+this.m[2]*c,t[2]=this.m[1]*l-this.m[2]*d+this.m[3]*i,t[6]=-(this.m[0]*l-this.m[2]*p+this.m[3]*h),t[10]=this.m[0]*f-this.m[1]*p+this.m[3]*g,t[14]=-(this.m[0]*i-this.m[1]*h+this.m[2]*g),t[3]=-(this.m[1]*u-this.m[2]*w+this.m[3]*v),t[7]=this.m[0]*u-this.m[2]*A+this.m[3]*D,t[11]=-(this.m[0]*w-this.m[1]*A+this.m[3]*Y),t[15]=this.m[0]*v-this.m[1]*D+this.m[2]*Y;let P=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let m=0;m<4;m++)for(let x=0;x<4;x++)t[m*4+x]*=1/P;return new Es(t)}clone(){return new Es([...this.m])}toString(){return this.m.toString()}};function sl(e,t,s,o=n=>-Math.cos(n)){return e+(o(s)+1)/2*(t-e)}var Xd=1103515245,Gd=12345,fa=2147483648,ol=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(Xd*this.seed+Gd)%fa,this.seed/fa}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new Q(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new He(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof Q)return this.genVec2(X(0,0),e[0]);if(e[0]instanceof He)return this.genColor(Fe(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof Q&&e[1]instanceof Q)return this.genVec2(e[0],e[1]);if(e[0]instanceof He&&e[1]instanceof He)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},ji=new ol(Date.now());function Kd(e){return e!=null&&(ji.seed=e),ji.seed}function vt(...e){return ji.genAny(...e)}function nl(...e){return Math.floor(vt(...e.length>0?e:[2]))}function Vd(e){return vt()<=e}function il(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function Wd(e,t){return e.length<=t?e.slice():il(e.slice()).slice(0,t)}function jd(e){return e[nl(e.length)]}function rl(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function $d(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let s=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(s===0)return null;let o=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/s,n=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/s;return o<0||o>1||n<0||n>1?null:o}function Pr(e,t){let s=$d(e,t);return s?X(e.p1.x+s*(e.p2.x-e.p1.x),e.p1.y+s*(e.p2.y-e.p1.y)):null}function Ir(e,t){let s=t.p2.sub(t.p1),o=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY;if(s.x!=0){let r=(e.pos.x-t.p1.x)/s.x,a=(e.pos.x+e.width-t.p1.x)/s.x;o=Math.max(o,Math.min(r,a)),n=Math.min(n,Math.max(r,a))}if(s.y!=0){let r=(e.pos.y-t.p1.y)/s.y,a=(e.pos.y+e.height-t.p1.y)/s.y;o=Math.max(o,Math.min(r,a)),n=Math.min(n,Math.max(r,a))}return n>=o&&n>=0&&o<=1}function pi(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function al(e,t){let s=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),o=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return X(s,o).sdist(t.center)<=t.radius*t.radius}function ll(e,t){return cl(t,new Ht(e.points()))}function Br(e,t){let s=t.sub(e.p1),o=e.p2.sub(e.p1);if(Math.abs(s.cross(o))>Number.EPSILON)return!1;let n=s.dot(o)/o.dot(o);return n>=0&&n<=1}function bn(e,t){let s=e.p2.sub(e.p1),o=s.dot(s),n=e.p1.sub(t.center),r=2*s.dot(n),a=n.dot(n)-t.radius*t.radius,c=r*r-4*o*a;if(o<=Number.EPSILON||c<0)return!1;if(c==0){let l=-r/(2*o);if(l>=0&&l<=1)return!0}else{let l=(-r+Math.sqrt(c))/(2*o),d=(-r-Math.sqrt(c))/(2*o);if(l>=0&&l<=1||d>=0&&d<=1)return!0}return fi(t,e.p1)}function Or(e,t){if(Xs(t,e.p1)||Xs(t,e.p2))return!0;for(let s=0;s<t.pts.length;s++){let o=t.pts[s],n=t.pts[(s+1)%t.pts.length];if(Pr(e,new Yt(o,n)))return!0}return!1}function fi(e,t){return e.center.sdist(t)<e.radius*e.radius}function Jd(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function gi(e,t){let s=t.pts[t.pts.length-1];for(let o of t.pts){if(bn(new Yt(s,o),e))return!0;s=o}return fi(e,t.pts[0])?!0:Xs(t,e.center)}function cl(e,t){for(let s=0;s<e.pts.length;s++)if(Or(new Yt(e.pts[s],e.pts[(s+1)%e.pts.length]),t))return!0;return!!(e.pts.some(s=>Xs(t,s))||t.pts.some(s=>Xs(e,s)))}function Xs(e,t){let s=!1,o=e.pts;for(let n=0,r=o.length-1;n<o.length;r=n++)o[n].y>t.y!=o[r].y>t.y&&t.x<(o[r].x-o[n].x)*(t.y-o[n].y)/(o[r].y-o[n].y)+o[n].x&&(s=!s);return s}function Lr(e,t){t=t.sub(e.center);let s=mt(e.angle),o=Math.cos(s),n=Math.sin(s),r=t.x*o+t.y*n,a=-t.x*n+t.y*o;return r*r/(e.radiusX*e.radiusX)+a*a/(e.radiusY*e.radiusY)<1}function $n(e,t){let s=t.center.sub(e.center),o=mt(e.angle),n=Math.cos(o),r=Math.sin(o),a=s.x*n+s.y*r,c=-s.x*r+s.y*n;return Lr(new Ts(X(),e.radiusX+t.radius,e.radiusY+t.radius,0),X(a,c))}function dl(e,t){let s=e.toMat2().inverse;return t=new Yt(s.transform(t.p1.sub(e.center)),s.transform(t.p2.sub(e.center))),bn(t,new qt(X(),1))}function Qd(e,t){if(e.radiusX===e.radiusY)return $n(t,new qt(e.center,e.radiusX));if(t.radiusX===t.radiusY)return $n(e,new qt(t.center,t.radiusX));let s=new jo(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),o=new jo(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),n=e.center.x,r=e.center.y,a=t.center.x,c=t.center.y,l=mt(e.angle),d=mt(t.angle),i=new jo(Math.cos(l),-Math.sin(l),n,Math.sin(l),Math.cos(l),r,0,0,1),p=new jo(Math.cos(d),-Math.sin(d),a,Math.sin(d),Math.cos(d),c,0,0,1),h=i.inverse,f=p.inverse,g=h.transpose.mul(s).mul(h),u=f.transpose.mul(o).mul(f),w=g.m11,v=g.m12,A=g.m13,D=g.m21,Y=g.m22,P=g.m23,m=g.m31,x=g.m32,E=g.m33,S=u.m11,I=u.m12,T=u.m13,z=u.m21,_=u.m22,j=u.m23,q=u.m31,k=u.m32,U=u.m33,F=w*Y*E-w*P*x-v*D*E+v*P*m+A*D*x-A*Y*m,O=(w*Y*U-w*P*k-w*x*j+w*E*_-v*D*U+v*P*q+v*m*j-v*E*z+A*D*k-A*Y*q-A*m*_+A*x*z+D*x*T-D*E*I-Y*m*T+Y*E*S+P*m*I-P*x*S)/F,J=(w*_*U-w*j*k-v*z*U+v*j*q+A*z*k-A*_*q-D*I*U+D*T*k+Y*S*U-Y*T*q-P*S*k+P*I*q+m*I*j-m*T*_-x*S*j+x*T*z+E*S*_-E*I*z)/F,ne=(S*_*U-S*j*k-I*z*U+I*j*q+T*z*k-T*_*q)/F;if(O>=0){let se=-3*J+O**2,Ee=3*O*ne+J*O**2-4*J**2,xe=-27*ne**2+18*ne*O*J+O**2*J**2-4*O**3*ne-4*J**3;return!(se>0&&Ee<0&&xe>0)}else{let se=-3*J+O**2,Ee=-27*ne**2+18*ne*O*J+O**2*J**2-4*O**3*ne-4*J**3;return!(se>0&&Ee>0)}}function hl(e,t){return Hr(e,new Ht(t.points()))}function Hr(e,t){let s=e.toMat2().inverse;return t=new Ht(t.pts.map(o=>s.transform(o.sub(e.center)))),gi(new qt(X(),1),t)}function Zd(e,t){return e.x===t.x&&e.y===t.y}function kd(e,t){return t instanceof Q?Zd(t,e.pt):t instanceof qt?fi(t,e.pt):t instanceof Yt?Br(t,e.pt):t instanceof Qe?pi(t,e.pt):t instanceof Ht?Xs(t,e.pt):t instanceof Ts?Lr(t,e.pt):!1}function eh(e,t){return t instanceof Q?Br(e,t):t instanceof qt?bn(e,t):t instanceof Yt?Pr(e,t)!=null:t instanceof Qe?Ir(t,e):t instanceof Ht?Or(e,t):t instanceof Ts?dl(t,e):!1}function th(e,t){return t instanceof Q?fi(e,t):t instanceof qt?Jd(e,t):t instanceof Yt?bn(t,e):t instanceof Qe?al(t,e):t instanceof Ht?gi(e,t):t instanceof Ts?$n(t,e):!1}function sh(e,t){return t instanceof Q?pi(e,t):t instanceof qt?al(e,t):t instanceof Yt?Ir(e,t):t instanceof Qe?rl(e,t):t instanceof Ht?ll(e,t):t instanceof Ts?hl(t,e):!1}function oh(e,t){return t instanceof Q?Xs(e,t):t instanceof qt?gi(t,e):t instanceof Yt?Or(t,e):t instanceof Qe?ll(t,e):t instanceof Ht?cl(t,e):t instanceof Ts?Hr(t,e):!1}function nh(e,t){return t instanceof Q?Lr(e,t):t instanceof qt?$n(e,t):t instanceof Yt?dl(e,t):t instanceof Qe?hl(e,t):t instanceof Ht?Hr(e,t):t instanceof Ts?Qd(t,e):!1}function ul(e,t,s){let o=e,n=s.p1,r=s.p2,a=t,c=r.sub(n),l=a.cross(c);if(Math.abs(l)<Number.EPSILON)return null;let d=n.sub(o),i=d.cross(c)/l;if(i<=0||i>=1)return null;let p=d.cross(a)/l;if(p<=0||p>=1)return null;let h=c.normal().unit();return t.dot(h)>0&&(h.x*=-1,h.y*=-1),{point:o.add(a.scale(i)),normal:h,fraction:i}}function ih(e,t,s){let o=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,r;if(e.x!=0){let a=(s.pos.x-e.x)/t.x,c=(s.pos.x+s.width-e.x)/t.x;r=X(-Math.sign(t.x),0),o=Math.max(o,Math.min(a,c)),n=Math.min(n,Math.max(a,c))}if(e.y!=0){let a=(s.pos.y-e.y)/t.y,c=(s.pos.y+s.height-e.y)/t.y;Math.min(a,c)>o&&(r=X(0,-Math.sign(t.y))),o=Math.max(o,Math.min(a,c)),n=Math.min(n,Math.max(a,c))}return n>=o&&o>=0&&o<=1?{point:e.add(t.scale(o)),normal:r,fraction:o}:null}function pl(e,t,s){let o=e,n=s.center,r=t,a=r.dot(r),c=o.sub(n),l=2*r.dot(c),d=c.dot(c)-s.radius*s.radius,i=l*l-4*a*d;if(a<=Number.EPSILON||i<0)return null;if(i==0){let p=-l/(2*a);if(p>=0&&p<=1){let h=o.add(r.scale(p));return{point:h,normal:h.sub(n),fraction:p}}}else{let p=(-l+Math.sqrt(i))/(2*a),h=(-l-Math.sqrt(i))/(2*a),f=null;if(p>=0&&p<=1&&(f=p),h>=0&&h<=1&&(f=Math.min(h,f??h)),f!=null){let g=o.add(r.scale(f));return{point:g,normal:g.sub(n).unit(),fraction:f}}}return null}function rh(e,t,s){let o=s.pts,n=null,r=o[o.length-1];for(let a=0;a<o.length;a++){let c=o[a],l=ul(e,t,new Yt(r,c));l&&(!n||n.fraction>l.fraction)&&(n=l),r=c}return n}function ah(e,t,s){let o=s.toMat2(),n=o.inverse,r=n.transform(e.sub(s.center)),a=n.transform(t),c=pl(r,a,new qt(X(),1));if(c){let l=jn.rotation(mt(-s.angle)),d=jn.scale(s.radiusX,s.radiusY).transform(c.point),i=o.transform(c.point).add(s.center),p=i.dist(e)/t.len();return{point:i,normal:l.transform(X(s.radiusY**2*d.x,s.radiusX**2*d.y)).unit(),fraction:p}}return c}function lh(e,t,s,o=64){let n=e,r=t.len(),a=t.scale(1/r),c=0,l=X(Math.floor(e.x),Math.floor(e.y)),d=X(a.x>0?1:-1,a.y>0?1:-1),i=X(Math.abs(1/a.x),Math.abs(1/a.y)),p=X(d.x>0?l.x+1-e.x:e.x-l.x,d.y>0?l.y+1-e.y:e.y-l.y),h=X(i.x<1/0?i.x*p.x:1/0,i.y<1/0?i.y*p.y:1/0),f=-1;for(;c<=o;){let g=s(l);if(g===!0)return{point:n.add(a.scale(c)),normal:X(f===0?-d.x:0,f===1?-d.y:0),fraction:c/r,gridPos:l};if(g)return g;h.x<h.y?(l.x+=d.x,c=h.x,h.x+=i.x,f=0):(l.y+=d.y,c=h.y,h.y+=i.y,f=1)}return null}var ch=class $i{pt;constructor(t){this.pt=t.clone()}transform(t){return new $i(t.multVec2(this.pt))}bbox(){return new Qe(this.pt,0,0)}area(){return 0}clone(){return new $i(this.pt)}collides(t){return kd(this,t)}contains(t){return this.pt.eq(t)}raycast(t,s){return null}random(){return this.pt.clone()}},Yt=class Ji{p1;p2;constructor(t,s){this.p1=t.clone(),this.p2=s.clone()}transform(t){return new Ji(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Qe.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Ji(this.p1,this.p2)}collides(t){return eh(this,t)}contains(t){return this.collides(t)}raycast(t,s){return ul(t,s,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(vt(1)))}},Qe=class Qi{pos;width;height;constructor(t,s,o){this.pos=t.clone(),this.width=s,this.height=o}static fromPoints(t,s){return new Qi(t.clone(),s.x-t.x,s.y-t.y)}center(){return new Q(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new Ht(this.points().map(s=>t.multVec2(s)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Qi(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let s=this.pos,o=this.pos.add(this.width,this.height),n=Math.max(s.x-t.x,0,t.x-o.x),r=Math.max(s.y-t.y,0,t.y-o.y);return n*n+r*r}collides(t){return sh(this,t)}contains(t){return this.collides(t)}raycast(t,s){return ih(t,s,this)}random(){return this.pos.add(vt(this.width),vt(this.height))}},qt=class fl{center;radius;constructor(t,s){this.center=t.clone(),this.radius=s}transform(t){return new Ts(this.center,this.radius,this.radius).transform(t)}bbox(){return Qe.fromPoints(this.center.sub(X(this.radius)),this.center.add(X(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new fl(this.center,this.radius)}collides(t){return th(this,t)}contains(t){return this.collides(t)}raycast(t,s){return pl(t,s,this)}random(){return this.center.add(Q.fromAngle(vt(360)).scale(vt(this.radius)))}},Ts=class Ao{center;radiusX;radiusY;angle;constructor(t,s,o,n=0){this.center=t.clone(),this.radiusX=s,this.radiusY=o,this.angle=n}static fromMat2(t){let s=t.inverse,o=s.transpose.mul(s),[n,r]=o.eigenvalues,[a,c]=o.eigenvectors(n,r),[l,d]=[1/Math.sqrt(n),1/Math.sqrt(r)];return l>d?new Ao(X(),l,d,oo(Math.atan2(-a[1],a[0]))):new Ao(X(),d,l,oo(Math.atan2(-c[1],c[0])))}toMat2(){let t=mt(this.angle),s=Math.cos(t),o=Math.sin(t);return new jn(s*this.radiusX,-o*this.radiusY,o*this.radiusX,s*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new Ao(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let s=this.toMat2(),o=t.getRotation(),n=t.getScale();s=jo.fromMat2(s).scale(n.x,n.y).rotate(o).toMat2();let r=Ao.fromMat2(s);return r.center=t.multVec2(this.center),r}}bbox(){if(this.angle==0)return Qe.fromPoints(this.center.sub(X(this.radiusX,this.radiusY)),this.center.add(X(this.radiusX,this.radiusY)));{let t=mt(this.angle),s=Math.cos(t),o=Math.sin(t),n=this.radiusX*s,r=this.radiusX*o,a=this.radiusY*o,c=this.radiusY*s,l=Math.sqrt(n*n+a*a),d=Math.sqrt(r*r+c*c);return Qe.fromPoints(this.center.sub(X(l,d)),this.center.add(X(l,d)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new Ao(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return nh(this,t)}contains(t){t=t.sub(this.center);let s=mt(this.angle),o=Math.cos(s),n=Math.sin(s),r=t.x*o+t.y*n,a=-t.x*n+t.y*o;return r*r/(this.radiusX*this.radiusX)+a*a/(this.radiusY*this.radiusY)<1}raycast(t,s){return ah(t,s,this)}random(){return this.center}};function dh(e,t,s,o){let n=t.sub(e),r=o.sub(s),a=n.cross(r);return a<1e-5&&a>-1e-5||(a=s.sub(e).cross(r)/a,a<0||a>1)?null:e.add(n.scale(a))}var Ht=class Jo{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new Jo(this.pts.map(s=>t.multVec2(s)))}bbox(){let t=X(Number.MAX_VALUE),s=X(-Number.MAX_VALUE);for(let o of this.pts)t.x=Math.min(t.x,o.x),s.x=Math.max(s.x,o.x),t.y=Math.min(t.y,o.y),s.y=Math.max(s.y,o.y);return Qe.fromPoints(t,s)}area(){let t=0,s=this.pts.length;for(let o=0;o<s;o++){let n=this.pts[o],r=this.pts[(o+1)%s];t+=n.x*r.y*.5,t-=r.x*n.y*.5}return Math.abs(t)}clone(){return new Jo(this.pts.map(t=>t.clone()))}collides(t){return oh(this,t)}contains(t){return this.collides(t)}raycast(t,s){return rh(t,s,this)}random(){return X()}cut(t,s){new Yt(t,s);let o=[],n=[],r=s.sub(t),a=this.pts[this.pts.length-1],c=a.sub(t),l=r.cross(c)>0;return this.pts.forEach(d=>{c=d.sub(t);let i=r.cross(c)>0;if(l!=i){let p=dh(a,d,t,s);o.push(p),n.push(p),l=i}(i?o:n).push(d),a=d}),[o.length?new Jo(o):null,n.length?new Jo(n):null]}};function hh(e,t,s,o){let n=o*o,r=1-o,a=r*r;return e.scale(a).add(t.scale(2*r*o)).add(s.scale(n))}function uh(e,t,s,o){let n=1-o;return t.sub(e).scale(2*n).add(s.sub(t).scale(2*o))}function ph(e,t,s,o){return s.sub(t.scale(2)).add(e).scale(2)}function zr(e,t,s,o,n){let r=n*n,a=r*n,c=1-n,l=c*c,d=l*c;return e.scale(d).add(t.scale(3*l*n)).add(s.scale(3*c*r)).add(o.scale(a))}function fh(e,t,s,o,n){let r=n*n,a=1-n,c=a*a;return t.sub(e).scale(3*c).add(s.sub(t).scale(6*a*n)).add(o.sub(s).scale(3*r))}function gh(e,t,s,o,n){let r=1-n;return s.sub(t.scale(2)).add(e).scale(6*r).add(o.sub(s.scale(2)).add(t).scale(6*n))}function mh(e,t,s,o,n){let r=.5*(((-n+2)*n-1)*n),a=.5*((3*n-5)*n*n+2),c=.5*(((-3*n+4)*n+1)*n),l=.5*((n-1)*n*n);return e.scale(r).add(t.scale(a)).add(s.scale(c)).add(o.scale(l))}function xh(e,t,s,o,n){let r=.5*((-3*n+4)*n-1),a=.5*((9*n-10)*n),c=.5*((-9*n+8)*n+1),l=.5*((3*n-2)*n);return e.scale(r).add(t.scale(a)).add(s.scale(c)).add(o.scale(l))}function yh(e){let t=gl(e),s=t(1);return o=>{let n=o*s,r=t(n,!0);return e(r)}}function gl(e,t=10,s=10){let o=[0],n=[0],r=1/(t-1)/s,a=0,c=e(0),l=0;for(let d=1;d<t;d++){for(let i=0;i<s;i++){l+=r;let p=e(l),h=p.dist(c);a+=h,c=p}o[d]=a,n[d]=l}return n[t-1]=1,(d,i=!1)=>{if(i){let p=d;if(p<=0)return 0;if(p>=a)return 1;let h=0;for(;o[h+1]<p;)h++;let f=n[h],g=n[h+1],u=o[h],w=o[h+1],v=(p-u)/(w-u);return f+(g-f)*v}else{if(d<=0)return 0;if(d>=1)return o[t-1];let p=0;for(;n[p+1]<d;)p++;let h=n[p],f=n[p+1],g=o[p],u=o[p+1],w=(d-h)/(f-h);return g+(u-g)*w}}}function vn(e,t,s,o){let n=2*e+t-2*o+s,r=-3*e+3*o-2*t-s,a=t,c=e;return l=>{let d=l*l,i=d*l;return n*i+r*d+a*l+c}}function ml(e,t,s,o,n,r=vn){let a=r(t.x,(1-n)*(s.x-e.x),(1-n)*(o.x-t.x),s.x),c=r(t.y,(1-n)*(s.y-e.y),(1-n)*(o.y-t.y),s.y);return l=>new Q(a(l),c(l))}function Jn(e,t,s,o,n=vn){return ml(e,t,s,o,.5,n)}function wh(e,t,s,o,n=vn){return Jn(o.add(e.sub(t).scale(6)),e,o,e.add(o.sub(s).scale(6)),n)}function bh(e,t,s,o,n,r,a,c=vn){let l=c(t.x,.5*(1-n)*(1+a)*(1+r)*(t.x-e.x)+.5*(1-n)*(1-a)*(1-r)*(s.x-t.x),.5*(1-n)*(1+a)*(1-r)*(s.x-t.x)+.5*(1-n)*(1-a)*(1+r)*(o.x-s.x),s.x),d=c(t.y,.5*(1-n)*(1+a)*(1+r)*(t.y-e.y)+.5*(1-n)*(1-a)*(1-r)*(s.y-t.y),.5*(1-n)*(1+a)*(1-r)*(s.y-t.y)+.5*(1-n)*(1-a)*(1+r)*(o.y-s.y),s.y);return i=>new Q(l(i),d(i))}function vh(e,t,s,o){let n=2*e+t-2*o+s,r=-3*e+3*o-2*t+s,a=t;return c=>{let l=c*c;return 3*n*l+2*r*c+a}}function qo(e){return 0<=e&&e<=1}function Li(e,t){return Math.abs(e-t)<=Number.EPSILON}function Yo(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Ah(e,t,s,o){let n=3*e-6*t+3*s,r=-3*e+3*t,a=e,c=-e+3*t-3*s+o;if(Li(c,0)){if(Li(n,0))return Li(r,0)?[]:[-a/r].filter(qo);let w=Math.sqrt(r*r-4*n*a),v=2*n;return[(w-r)/v,(-r-w)/v].filter(qo)}n/=c,r/=c,a/=c;let l=(3*r-n*n)/3,d=l/3,i=(2*n*n*n-9*n*r+27*a)/27,p=i/2,h=p*p+d*d*d;if(h<0){let w=-l/3,v=w*w*w,A=Math.sqrt(v),D=-i/(2*A),Y=D<-1?-1:D>1?1:D,P=Math.acos(Y),m=2*Yo(A),x=m*Math.cos(P/3)-n/3,E=m*Math.cos((P+2*Math.PI)/3)-n/3,S=m*Math.cos((P+4*Math.PI)/3)-n/3;return[x,E,S].filter(qo)}if(h===0){let w=p<0?Yo(-p):-Yo(p),v=2*w-n/3,A=-w-n/3;return[v,A].filter(qo)}let f=Math.sqrt(h),g=Yo(f-p),u=Yo(f+p);return[g-u-n/3].filter(qo)}function Sh(e,t,s,o,n){let r=Ah(e.x-n,t.x-n,s.x-n,o.x-n);return r.length>0?zr(e,t,s,o,r[0]).y:NaN}function Eh(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return s=>{if(s<=0||e.length==1||s<=e[0].x)return e[0].y;for(let o=0;o<t;o++)if(e[o].x>=s)return fs(s,e[o-1].x,e[o].x,e[o-1].y,e[o].y);return e[e.length-1].y}}function Mh(e,t){return s=>Sh(X(0,0),e,t,X(1,1),s)}function Dh(e,t="jump-end"){let s=1/e,o=t=="jump-start"||t=="jump-both",n=t=="jump-end"||t=="jump-both",r=1/(e+(n?1:0)),a=o?r:0;return c=>{let l=Math.floor(c/s);return a+l*r}}function Rh(e,t){let s=Number.MAX_VALUE,o={normal:X(0),distance:0};for(let n of[e,t])for(let r=0;r<n.pts.length;r++){let a=n.pts[r],c=n.pts[(r+1)%n.pts.length].sub(a).normal().unit(),l=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let f=0;f<e.pts.length;f++){let g=e.pts[f].dot(c);l=Math.min(l,g),d=Math.max(d,g)}let i=Number.MAX_VALUE,p=-Number.MAX_VALUE;for(let f=0;f<t.pts.length;f++){let g=t.pts[f].dot(c);i=Math.min(i,g),p=Math.max(p,g)}let h=Math.min(d,p)-Math.max(l,i);if(h<0)return null;if(h<Math.abs(s)){let f=p-l,g=i-d;s=Math.abs(f)<Math.abs(g)?f:g,o.normal=c,o.distance=s}}return o}function xl(e,t,s){return(t.x-e.x)*(s.y-e.y)-(t.y-e.y)*(s.x-e.x)>=0}function Ch(e){let t=0,s=e[e.length-1];for(let o=0;o<e.length;o++)t+=(e[o].x-s.x)*(e[o].y+s.y),s=e[o];return t<0}function Hi(e,t,s,o){let n=o.x-s.x,r=o.y-s.y,a=n*(e.y-s.y)-r*(e.x-s.x),c=n*(t.y-s.y)-r*(t.x-s.x);return a*c>=0}function Th(e,t,s,o){return Hi(e,t,s,o)&&Hi(e,s,t,o)&&Hi(e,o,t,s)}function Ph(e,t,s,o){for(let n of e)if(n!==t&&n!==s&&n!==o&&Th(n,t,s,o))return!0;return!1}function Ih(e,t,s,o){return xl(e,t,s)&&!Ph(o,e,t,s)}function yl(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],s=[],o=0;for(let p=0;p<e.length;p++){let h=e[o],f=e[p];(f.x<h.x||f.x==h.x&&f.y<h.y)&&(o=o),t[p]=p+1,s[p]=p-1}t[t.length-1]=0,s[0]=s.length-1,Ch(e)||([t,s]=[s,t]);let n=[];for(let p=0;p<e.length;++p)xl(e[s[p]],e[p],e[t[p]])||n.push(e[p]);let r=[],a=e.length,c=1,l=0,d,i;for(;a>3;){d=t[c],i=s[c];let p=e[i],h=e[c],f=e[d];if(Ih(p,h,f,n))r.push([p,h,f]),t[i]=d,s[d]=i,n.splice(n.indexOf(h),1),--a,l=0;else if(++l>a)return[];c=d}return d=t[c],i=s[c],r.push([e[i],e[c],e[d]]),r}function Bh(e){if(e.length<3)return!1;let t=e.length-2,s=e.length-1,o=0,n=e[s].sub(e[t]),r=e[o].sub(e[s]),a=n.cross(r);for(;o+1<e.length;)if(t=s,s=o,o++,n=e[s].sub(e[t]),r=e[o].sub(e[s]),n.cross(r)*a<0)return!1;return!0}var wl=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",mi="topleft",Oh="monospace",Qn="monospace",Zi="linear",Ur=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],Lh=Ur.reduce((e,t)=>e+t.size,0),bl=2048,Hh=bl*4*Lh,zh=bl*6,Uh=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,Nh=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,ki=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,er=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,_h=new Set(["id","require"]),Fh=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),ga=200,qh=640,Yh=65536,vl=Symbol.for("kaplay.cancel"),Al=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},ho=class Sl{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let s=new Sl(()=>t.forEach(o=>o.cancel()));return Object.defineProperty(s,"paused",{get:()=>t[0].paused,set:o=>t.forEach(n=>n.paused=o)}),s.paused=!1,s}static replace(t,s){return t.cancel=()=>s.cancel(),s.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>s.paused,set:o=>s.paused=o}),t}},Lt=class{cancellers=new WeakMap;handlers=new Al;add(e){function t(...n){if(!o.paused)return e(...n)}let s=this.handlers.pushd(t),o=new ho(s);return this.cancellers.set(t,s),o}addOnce(e){let t=this.add((...s)=>{t.cancel(),e(...s)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let s=t(...e),o;s===vl&&(o=this.cancellers.get(t))&&o()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},un=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new Lt),this.handlers[e].add(t)}onOnce(e,t){let s=this.on(e,(...o)=>{s.cancel(),t(...o)});return s}next(e){return new Promise(t=>{this.onOnce(e,(...s)=>t(s[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},Xh=e=>e[0]instanceof He,Gh=e=>e[0]instanceof Q,Kh=e=>typeof e[0]=="number",El=class{_items;_compareFn;constructor(e=(t,s)=>t<s){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Vh(e){let t=window.atob(e),s=t.length,o=new Uint8Array(s);for(let n=0;n<s;n++)o[n]=t.charCodeAt(n);return o.buffer}function Wh(e){return Vh(e.split(",")[1])}function Nr(e,t){let s=document.createElement("a");s.href=t,s.download=e,s.click()}function Ml(e,t){Nr(e,"data:text/plain;charset=utf-8,"+t)}function jh(e,t){Ml(e,JSON.stringify(t))}function ma(e,t){let s=URL.createObjectURL(t);Nr(e,s),URL.revokeObjectURL(s)}var Dl=e=>e.match(/^data:\w+\/\w+;base64,.+/),$h=e=>e.split(".").slice(0,-1).join(".");function _r(e,t){if(e===t)return!0;let s=typeof e,o=typeof t;if(s!==o)return!1;if(s==="object"&&o==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(let a of n){let c=e[a],l=t[a];if(!_r(c,l))return!1}return!0}return!1}var xa=new Set,Jh=e=>e instanceof Error?e.message:String(e);function Qh(e){xa.has(e)||(xa.add(e),console.warn(e))}function To(e,t){Qh(`${e} is deprecated. Use ${t} instead.`)}function tr(e,t){return Number(e.toFixed(t))}function et(e,t){return(...s)=>{let o=s.length;if(o===e.length)return e(...s);if(o===t.length)return t(...s)}}var Zh=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function kh(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],s=0,o=0;for(;s<e.length;){if(o+=eu(s+o,e),au(e[s+o])&&o++,nu(e[s+o])&&o++,iu(e[s+o])&&o++,lu(e[s+o])){o++;continue}t.push(e.substring(s,s+o)),s+=o,o=0}return t}function eu(e,t){let s=t[e];if(!tu(s)||e===t.length-1)return 1;let o=s+t[e+1],n=t.substring(e+2,e+5);return ya(o)&&ya(n)?4:su(o)&&ru(n)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:ou(n)?4:2}function tu(e){return e&&uo(e[0].charCodeAt(0),55296,56319)}function ya(e){return uo(Fr(e),127462,127487)}function su(e){return uo(Fr(e),127988,127988)}function ou(e){return uo(Fr(e),127995,127999)}function nu(e){return typeof e=="string"&&uo(e.charCodeAt(0),65024,65039)}function iu(e){return typeof e=="string"&&uo(e.charCodeAt(0),8400,8447)}function ru(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&uo(t,917504,917631)}function au(e){return typeof e=="string"&&Zh.includes(e.charCodeAt(0))}function lu(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Fr(e){let t=e.charCodeAt(0)-55296,s=e.charCodeAt(1)-56320;return(t<<10)+s+65536}function uo(e,t,s){return e>=t&&e<=s}var Gt=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,hs=(e,t)=>Array.isArray(t)?t.some(s=>e.has(s)):e.has(t),Bn=(e,t,s)=>{e.has(t)?e.get(t)?.push(s):e.set(t,[s])},cu=(()=>{let e=0;return()=>e++})(),du={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function Rl(){let e=y.globalOpt.pixelDensity??1,t=y.globalOpt.width,s=y.globalOpt.height,o=y.gfx.ggl.gl.drawingBufferWidth,n=y.gfx.ggl.gl.drawingBufferHeight,r=o/e,a=n/e,c=0,l=0,d=r,i=a;if(y.globalOpt.letterbox){if(!t||!s)throw new Error("Letterboxing requires width and height defined.");let p=r/a,h=t/s;if(p>h){let f=a*h;c=(r-f)/2,d=f}else{let f=r/h;i=f,l=(a-f)/2}}if(y.globalOpt.stretch&&(!y.globalOpt.width||!y.globalOpt.height))throw new Error("Stretching requires width and height defined.");y.gfx.viewport={x:c,y:l,width:d,height:i,scale:(y.gfx.viewport.width+y.gfx.viewport.height)/(y.gfx.width+y.gfx.height)}}function hu(e){return new Q(e.x*y.gfx.viewport.width/y.gfx.width,e.y*y.gfx.viewport.height/y.gfx.height)}function As(e){return new Q((e.x-y.gfx.viewport.x)*y.gfx.width/y.gfx.viewport.width,(e.y-y.gfx.viewport.y)*y.gfx.height/y.gfx.viewport.height)}var uu=()=>Zs.lastInputDevice,pu=()=>{let e=Zs.buttons;for(let t in e){let s=e[t].keyboard&&[e[t].keyboard].flat(),o=e[t].keyboardCode&&[e[t].keyboardCode].flat(),n=e[t].gamepad&&[e[t].gamepad].flat(),r=e[t].mouse&&[e[t].mouse].flat();s&&s.forEach(a=>{Bn(Zs.buttonsByKey,a,t)}),o&&o.forEach(a=>{Bn(Zs.buttonsByKeyCode,a,t)}),n&&n.forEach(a=>{Bn(Zs.buttonsByGamepad,a,t)}),r&&r.forEach(a=>{Bn(Zs.buttonsByMouse,a,t)})}},on=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},fu=class{buttonState=new on;stickState=new Map},gu=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,s)=>t+s)/this.dts.length)),this.dts=[])}},Zs,wa=du,mu=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new gu,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new Q(0),mouseDeltaPos:new Q(0),keyState:new on,mouseState:new on,mergedGamepadState:new fu,gamepadStates:new Map,lastInputDevice:null,buttonState:new on,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new un}},xu=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=mu(e);Zs=t,pu();function s(){return t.dt*t.timeScale}function o(){return t.fixedDt*t.timeScale}function n(){return t.restDt*t.timeScale}function r(){return t.isHidden}function a(){return t.time}function c(){return t.fpsCounter.fps}function l(){return t.numFrames}function d(){return t.canvas.toDataURL()}function i(C){t.canvas.style.cursor=C}function p(){return t.canvas.style.cursor}function h(C){if(C)try{let G=t.canvas.requestPointerLock();G?.catch&&G.catch(Z=>console.error(Z))}catch(G){console.error(G)}else document.exitPointerLock()}function f(){return!!document.pointerLockElement}function g(C){C.requestFullscreen?C.requestFullscreen():C.webkitRequestFullscreen&&C.webkitRequestFullscreen()}function u(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function w(C=!0){C?g(t.canvas):u()}function v(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function A(){t.stopped=!0;let C=Object.entries(ht),G=Object.entries(Ho),Z=Object.entries(Bs);for(let[ue,Ue]of C)t.canvas.removeEventListener(ue,Ue);for(let[ue,Ue]of G)document.removeEventListener(ue,Ue);for(let[ue,Ue]of Z)window.removeEventListener(ue,Ue);ls.disconnect()}function D(C,G){t.loopID!==null&&cancelAnimationFrame(t.loopID);let Z=0,ue=0,Ue=Ve=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(Ue);return}let Rt=Ve/1e3,es=Math.min(Rt-t.realTime,.25),Ct=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Rt,ue+=es,ue>Ct){if(!t.skipTime){for(Z+=ue,t.dt=t.fixedDt,t.restDt=0;Z>t.fixedDt;)Z-=t.fixedDt,Z<t.fixedDt&&(t.restDt=Z),C();t.restDt=Z,t.dt=ue,t.time+=s(),t.fpsCounter.tick(t.dt)}ue=0,t.skipTime=!1,t.numFrames++,G(rs,js)}t.loopID=requestAnimationFrame(Ue)};Ue(0)}function Y(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function P(){return t.mousePos.clone()}function m(){return t.mouseDeltaPos.clone()}function x(C="left"){return t.mouseState.pressed.has(C)}function E(C="left"){return t.mouseState.down.has(C)}function S(C="left"){return t.mouseState.released.has(C)}function I(){return t.isMouseMoved}function T(C){return C===void 0?t.keyState.pressed.size>0:hs(t.keyState.pressed,C)}function z(C){return C===void 0?t.keyState.pressedRepeat.size>0:hs(t.keyState.pressedRepeat,C)}function _(C){return C===void 0?t.keyState.down.size>0:hs(t.keyState.down,C)}function j(C){return C===void 0?t.keyState.released.size>0:hs(t.keyState.released,C)}function q(C){return C===void 0?t.mergedGamepadState.buttonState.pressed.size>0:hs(t.mergedGamepadState.buttonState.pressed,C)}function k(C){return C===void 0?t.mergedGamepadState.buttonState.down.size>0:hs(t.mergedGamepadState.buttonState.down,C)}function U(C){return C===void 0?t.mergedGamepadState.buttonState.released.size>0:hs(t.mergedGamepadState.buttonState.released,C)}function F(C){return C===void 0?t.buttonState.pressed.size>0:hs(t.buttonState.pressed,C)}function O(C){return C===void 0?t.buttonState.down.size>0:hs(t.buttonState.down,C)}function J(C){return C===void 0?t.buttonState.released.size>0:hs(t.buttonState.released,C)}function ne(C){return t.buttons?.[C]}function se(C,G){t.buttons[C]={...t.buttons[C],...G}}function Ee(C){t.buttonState.press(C),t.events.trigger("buttonPress",C)}function xe(C){t.buttonState.release(C),t.events.trigger("buttonRelease",C)}function Ae(C){return t.events.on("resize",C)}let Me=et(C=>t.events.on("keyDown",C),(C,G)=>t.events.on("keyDown",Z=>Gt(C,Z)&&G(Z))),Oe=et(C=>t.events.on("keyPress",G=>C(G)),(C,G)=>t.events.on("keyPress",Z=>Gt(C,Z)&&G(Z))),Be=et(C=>t.events.on("keyPressRepeat",C),(C,G)=>t.events.on("keyPressRepeat",Z=>Gt(C,Z)&&G(Z))),_e=et(C=>t.events.on("keyRelease",C),(C,G)=>t.events.on("keyRelease",Z=>Gt(C,Z)&&G(Z))),ze=et(C=>t.events.on("mouseDown",G=>C(G)),(C,G)=>t.events.on("mouseDown",Z=>Gt(C,Z)&&G(Z))),ae=et(C=>t.events.on("mousePress",G=>C(G)),(C,G)=>t.events.on("mousePress",Z=>Gt(C,Z)&&G(Z))),oe=et(C=>t.events.on("mouseRelease",G=>C(G)),(C,G)=>t.events.on("mouseRelease",Z=>Z===C&&G(Z)));function V(C){return t.events.on("mouseMove",()=>C(P(),m()))}function ee(C){return t.events.on("charInput",C)}function te(C){return t.events.on("touchStart",C)}function ve(C){return t.events.on("touchMove",C)}function Ce(C){return t.events.on("touchEnd",C)}function ce(C){return t.events.on("scroll",C)}function Te(C){return t.events.on("hide",C)}function qe(C){return t.events.on("show",C)}let tt=et(C=>t.events.on("gamepadButtonPress",(G,Z)=>C(G,Z)),(C,G)=>t.events.on("gamepadButtonPress",(Z,ue)=>Gt(C,Z)&&G(Z,ue))),is=et(C=>t.events.on("gamepadButtonDown",(G,Z)=>C(G,Z)),(C,G)=>t.events.on("gamepadButtonDown",(Z,ue)=>Gt(C,Z)&&G(Z,ue))),kt=et(C=>t.events.on("gamepadButtonRelease",(G,Z)=>C(G,Z)),(C,G)=>t.events.on("gamepadButtonRelease",(Z,ue)=>Gt(C,Z)&&G(Z,ue)));function st(C,G){return t.events.on("gamepadStick",(Z,ue,Ue)=>Z===C&&G(ue,Ue))}function xt(C){t.events.on("gamepadConnect",C)}function rt(C){t.events.on("gamepadDisconnect",C)}function Ge(C){return t.mergedGamepadState.stickState.get(C)||new Q(0)}function ot(){return[...t.charInputted]}function Xe(){return[...t.gamepads]}let yt=et(C=>t.events.on("buttonPress",G=>C(G)),(C,G)=>t.events.on("buttonPress",Z=>Gt(C,Z)&&G(Z))),dt=et(C=>t.events.on("buttonDown",G=>C(G)),(C,G)=>t.events.on("buttonDown",Z=>Gt(C,Z)&&G(Z))),Ne=et(C=>t.events.on("buttonRelease",G=>C(G)),(C,G)=>t.events.on("buttonRelease",Z=>Gt(C,Z)&&G(Z)));function rs(){t.events.trigger("input"),t.keyState.down.forEach(C=>t.events.trigger("keyDown",C)),t.mouseState.down.forEach(C=>t.events.trigger("mouseDown",C)),t.buttonState.down.forEach(C=>{t.events.trigger("buttonDown",C)}),$s()}function js(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((C,G)=>{t.mergedGamepadState.stickState.set(G,new Q(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new Q(0),t.gamepadStates.forEach(C=>{C.buttonState.update(),C.stickState.forEach((G,Z)=>{C.stickState.set(Z,new Q(0))})})}function as(C){let G={index:C.index,isPressed:Z=>t.gamepadStates.get(C.index)?.buttonState.pressed.has(Z)||!1,isDown:Z=>t.gamepadStates.get(C.index)?.buttonState.down.has(Z)||!1,isReleased:Z=>t.gamepadStates.get(C.index)?.buttonState.released.has(Z)||!1,getStick:Z=>t.gamepadStates.get(C.index)?.stickState.get(Z)||X()};return t.gamepads.push(G),t.gamepadStates.set(C.index,{buttonState:new on,stickState:new Map([["left",new Q(0)],["right",new Q(0)]])}),G}function fo(C){t.gamepads=t.gamepads.filter(G=>G.index!==C.index),t.gamepadStates.delete(C.index)}function $s(){for(let C of navigator.getGamepads())C&&!t.gamepadStates.has(C.index)&&as(C);for(let C of t.gamepads){let G=navigator.getGamepads()[C.index];if(!G)continue;let Z=(e.gamepads??{})[G.id]||wa[G.id]||wa.default,ue=t.gamepadStates.get(C.index);if(ue){for(let Ue=0;Ue<G.buttons.length;Ue++){let Ve=Z.buttons[Ue],Rt=G.buttons[Ue],es=t.buttonsByGamepad.has(Ve);if(Rt.pressed){if(ue.buttonState.down.has(Ve)){t.events.trigger("gamepadButtonDown",Ve,C);continue}t.lastInputDevice="gamepad",es&&t.buttonsByGamepad.get(Ve)?.forEach(Ct=>{t.buttonState.press(Ct),t.events.trigger("buttonPress",Ct)}),t.mergedGamepadState.buttonState.press(Ve),ue.buttonState.press(Ve),t.events.trigger("gamepadButtonPress",Ve,C)}else ue.buttonState.down.has(Ve)&&(es&&t.buttonsByGamepad.get(Ve)?.forEach(Ct=>{t.buttonState.release(Ct),t.events.trigger("buttonRelease",Ct)}),t.mergedGamepadState.buttonState.release(Ve),ue.buttonState.release(Ve),t.events.trigger("gamepadButtonRelease",Ve,C))}for(let Ue in Z.sticks){let Ve=Z.sticks[Ue];if(!Ve)continue;let Rt=new Q(G.axes[Ve.x],G.axes[Ve.y]);ue.stickState.set(Ue,Rt),t.mergedGamepadState.stickState.set(Ue,Rt),t.events.trigger("gamepadStick",Ue,Rt,C)}}}}let ht={},Ho={},Bs={},ws=e.pixelDensity||1;ht.mousemove=C=>{let G=As(new Q(C.offsetX,C.offsetY)),Z=new Q(C.movementX,C.movementY);if(v()){let ue=t.canvas.width/ws,Ue=t.canvas.height/ws,Ve=window.innerWidth,Rt=window.innerHeight,es=Ve/Rt,Ct=ue/Ue;if(es>Ct){let cs=Rt/Ue,wt=(Ve-ue*cs)/2;G.x=fs(C.offsetX-wt,0,ue*cs,0,ue),G.y=fs(C.offsetY,0,Ue*cs,0,Ue)}else{let cs=Ve/ue,wt=(Rt-Ue*cs)/2;G.x=fs(C.offsetX,0,ue*cs,0,ue),G.y=fs(C.offsetY-wt,0,Ue*cs,0,Ue)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=G,t.mouseDeltaPos=Z,t.events.trigger("mouseMove")})};let An=["left","middle","right","back","forward"];ht.mousedown=C=>{t.events.onOnce("input",()=>{let G=An[C.button];G&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(G)&&t.buttonsByMouse.get(G)?.forEach(Z=>{t.buttonState.press(Z),t.events.trigger("buttonPress",Z)}),t.mouseState.press(G),t.events.trigger("mousePress",G))})},ht.mouseup=C=>{t.events.onOnce("input",()=>{let G=An[C.button];G&&(t.buttonsByMouse.has(G)&&t.buttonsByMouse.get(G)?.forEach(Z=>{t.buttonState.release(Z),t.events.trigger("buttonRelease",Z)}),t.mouseState.release(G),t.events.trigger("mouseRelease",G))})};let zo=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),Sn={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};ht.keydown=C=>{zo.has(C.key)&&C.preventDefault(),t.events.onOnce("input",()=>{let G=Sn[C.key]||C.key.toLowerCase(),Z=C.code;if(G===void 0)throw new Error(`Unknown key: ${C.key}`);G.length===1?(t.events.trigger("charInput",G),t.charInputted.push(G)):G==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),C.repeat?(t.keyState.pressRepeat(G),t.events.trigger("keyPressRepeat",G)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(G)&&t.buttonsByKey.get(G)?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.buttonsByKeyCode.has(Z)&&t.buttonsByKeyCode.get(Z)?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.keyState.press(G),t.events.trigger("keyPressRepeat",G),t.events.trigger("keyPress",G))})},ht.keyup=C=>{t.events.onOnce("input",()=>{let G=Sn[C.key]||C.key.toLowerCase(),Z=C.code;t.buttonsByKey.has(G)&&t.buttonsByKey.get(G)?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.buttonsByKeyCode.has(Z)&&t.buttonsByKeyCode.get(Z)?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.keyState.release(G),t.events.trigger("keyRelease",G)})},ht.touchstart=C=>{C.preventDefault(),t.events.onOnce("input",()=>{let G=[...C.changedTouches],Z=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=As(new Q(G[0].clientX-Z.x,G[0].clientY-Z.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),G.forEach(ue=>{t.events.trigger("touchStart",As(new Q(ue.clientX-Z.x,ue.clientY-Z.y)),ue)})})},ht.touchmove=C=>{C.preventDefault(),t.events.onOnce("input",()=>{let G=[...C.changedTouches],Z=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let ue=t.mousePos;t.mousePos=As(new Q(G[0].clientX-Z.x,G[0].clientY-Z.y)),t.mouseDeltaPos=t.mousePos.sub(ue),t.events.trigger("mouseMove")}G.forEach(ue=>{t.events.trigger("touchMove",As(new Q(ue.clientX-Z.x,ue.clientY-Z.y)),ue)})})},ht.touchend=C=>{t.events.onOnce("input",()=>{let G=[...C.changedTouches],Z=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=As(new Q(G[0].clientX-Z.x,G[0].clientY-Z.y)),t.mouseDeltaPos=new Q(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),G.forEach(ue=>{t.events.trigger("touchEnd",As(new Q(ue.clientX-Z.x,ue.clientY-Z.y)),ue)})})},ht.touchcancel=C=>{t.events.onOnce("input",()=>{let G=[...C.changedTouches],Z=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=As(new Q(G[0].clientX-Z.x,G[0].clientY-Z.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),G.forEach(ue=>{t.events.trigger("touchEnd",As(new Q(ue.clientX-Z.x,ue.clientY-Z.y)),ue)})})},ht.wheel=C=>{C.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new Q(C.deltaX,C.deltaY))})},ht.contextmenu=C=>C.preventDefault(),Ho.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},Bs.gamepadconnected=C=>{let G=as(C.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",G)})},Bs.gamepaddisconnected=C=>{let G=Xe().filter(Z=>Z.index===C.gamepad.index)[0];fo(C.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",G)})};for(let[C,G]of Object.entries(ht))t.canvas.addEventListener(C,G);for(let[C,G]of Object.entries(Ho))document.addEventListener(C,G);for(let[C,G]of Object.entries(Bs))window.addEventListener(C,G);let ls=new ResizeObserver(C=>{for(let G of C)if(G.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return ls.observe(t.canvas),{state:t,dt:s,fixedDt:o,restDt:n,time:a,run:D,canvas:t.canvas,fps:c,numFrames:l,quit:A,isHidden:r,setFullscreen:w,isFullscreen:v,setCursor:i,screenshot:d,getGamepads:Xe,getCursor:p,setCursorLocked:h,isCursorLocked:f,isTouchscreen:Y,mousePos:P,mouseDeltaPos:m,isKeyDown:_,isKeyPressed:T,isKeyPressedRepeat:z,isKeyReleased:j,isMouseDown:E,isMousePressed:x,isMouseReleased:S,isMouseMoved:I,isGamepadButtonPressed:q,isGamepadButtonDown:k,isGamepadButtonReleased:U,getGamepadStick:Ge,isButtonPressed:F,isButtonDown:O,isButtonReleased:J,setButton:se,getButton:ne,pressButton:Ee,releaseButton:xe,charInputted:ot,onResize:Ae,onKeyDown:Me,onKeyPress:Oe,onKeyPressRepeat:Be,onKeyRelease:_e,onMouseDown:ze,onMousePress:ae,onMouseRelease:oe,onMouseMove:V,onCharInput:ee,onTouchStart:te,onTouchMove:ve,onTouchEnd:Ce,onScroll:ce,onHide:Te,onShow:qe,onGamepadButtonDown:is,onGamepadButtonPress:tt,onGamepadButtonRelease:kt,onGamepadStick:st,onGamepadConnect:xt,onGamepadDisconnect:rt,onButtonPress:yt,onButtonDown:dt,onButtonRelease:Ne,getLastInputDeviceType:uu,events:t.events}};function At(){return y.app.dt()}function sr(){return y.app.fixedDt()}function or(){return y.app.restDt()}var yu=new Q(-1,-1),wu=new Q(0,-1),bu=new Q(1,-1),vu=new Q(-1,0),Au=new Q(0,0),Su=new Q(1,0),Eu=new Q(-1,1),Mu=new Q(0,1),Du=new Q(1,1);function Po(e){switch(e){case"topleft":return yu;case"top":return wu;case"topright":return bu;case"left":return vu;case"center":return Au;case"right":return Su;case"botleft":return Eu;case"bot":return Mu;case"botright":return Du;default:return e}}function Ru(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function Cu(e){return e.createBuffer(1,1,44100)}var On=2.5949095,ba=1.70158+1,va=2*Math.PI/3,Aa=2*Math.PI/4.5,Fn={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>ba*e*e*e-1.70158*e*e,easeOutBack:e=>1+ba*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((On+1)*2*e-On)/2:(Math.pow(2*e-2,2)*((On+1)*(e*2-2)+On)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*va),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*va)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Aa))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Aa)/2+1,easeInBounce:e=>1-Fn.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Fn.easeOutBounce(1-2*e))/2:(1+Fn.easeOutBounce(2*e-1))/2},pn=Fn;function Tu(e,t,s){let o=[],n=t;for(o.push(n);n!==e;){if(n=s.get(n),n==null)return null;o.push(n)}return o.reverse()}function Pu(e,t,s){let o=new El((a,c)=>a.cost<c.cost);o.insert({cost:0,node:t});let n=new Map;n.set(t,t);let r=new Map;for(r.set(t,0);o.length!==0;){let a=o.remove()?.node;if(a===s)break;let c=e.getNeighbours(a);for(let l of c){let d=(r.get(a)||0)+e.getCost(a,l)+e.getHeuristic(l,s);(!r.has(l)||d<r.get(l))&&(r.set(l,d),o.insert({cost:d,node:l}),n.set(l,a))}}return Tu(t,s,n)}var Iu=class{a;b;polygon;constructor(e,t,s){this.a=e,this.b=t,this.polygon=new WeakRef(s)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},Bu=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,s=0,o=0;for(let n of this._edges){n.polygon=new WeakRef(this);let r=n.a.x*n.b.y-n.a.y*n.b.x;t+=(n.a.x+n.b.x)*r,s+=(n.a.y+n.b.y)*r,o+=r}o/=2,this._centroid=X(t/(6*o),s/(6*o))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let s of this.edges)s.b.y>e.y!=s.a.y>e.y&&e.x<(s.a.x-s.b.x)*(e.y-s.b.y)/(s.a.y-s.b.y)+s.b.x&&(t=!t);return t}},Ou=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let s=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[s]}_findCommonEdge(e,t){for(let s of e.edges){let o=this._findEdge(s.b,s.a);if(o&&o.polygon.deref().id===t.id)return o}return null}addPolygon(e){let t=new Bu(this._polygons.length),s=e.map((o,n)=>new Iu(o,e[(n+1)%e.length],t));t.edges=s,this._polygons.push(t);for(let o of t.edges)this._addEdge(o);return t}addRect(e,t){let s=this._addPoint(e),o=this._addPoint(e.add(t.x,0)),n=this._addPoint(e.add(t)),r=this._addPoint(e.add(0,t.y));return this.addPolygon([s,o,n,r])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let s of this._polygons[e].edges){let o=this._findEdge(s.b,s.a);if(o){let n=o.polygon.deref();n&&t.push(n.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let s=this._polygons[e],o=this._polygons[t],n=s.centroid.x-o.centroid.x,r=s.centroid.y-o.centroid.y;return Math.sqrt(n*n+r*r)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:Pu(this,e,t)}getWaypointPath(e,t,s){let o=s?.type||"centroids",n=this._getLocation(e),r=this._getLocation(t);if(n===void 0||r===void 0)return[];let a=this.getPath(n.id,r.id);if(!a)return[];if(o==="edges"){let c=[];for(let l=1;l<a.length;l++){let d=this._polygons[a[l-1]],i=this._polygons[a[l]],p=this._findCommonEdge(d,i);c.push(p.middle.add(i.centroid.sub(p.middle).unit().scale(4)))}return[e,...c,t]}else return[e,...a.slice(1,-1).map(c=>this._polygons[c].centroid),t]}};function nn(e){let t=new xs;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function Lu(e){return new Q(e.x/Mt()*2-1,-e.y/Tt()*2+1)}function Qo(e,t,s,o,n,r=1){o=mt(o%360),n=mt(n%360),n<=o&&(n+=Math.PI*2);let a=[],c=Math.ceil((n-o)/mt(8)*r),l=(n-o)/c,d=X(Math.cos(o),Math.sin(o)),i=X(Math.cos(l),Math.sin(l));for(let p=0;p<=c;p++)a.push(e.add(t*d.x,s*d.y)),d=X(d.x*i.x-d.y*i.y,d.x*i.y+d.y*i.x);return a}function Hu(...e){let t=Fe(...e),s=e[3]??1;y.gfx.bgColor=t,y.gfx.bgAlpha=s,y.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,s)}function zu(){return y.gfx.bgColor?.clone?.()??null}function lt(...e){if(e[0]===void 0)return;let t=X(...e);t.x===0&&t.y===0||y.gfx.transform.translate(t)}function Vt(){y.gfx.transformStack.push(y.gfx.transform.clone())}function Uu(e){y.gfx.transform=e.clone()}function fn(...e){if(e[0]===void 0)return;let t=X(...e);t.x===1&&t.y===1||y.gfx.transform.scale(t)}function Do(e){e&&y.gfx.transform.rotate(e)}function _t(){y.gfx.transformStack.length>0&&(y.gfx.transform=y.gfx.transformStack.pop())}function Wt(){y.gfx.renderer.flush()}function Mt(){return y.gfx.width}function Tt(){return y.gfx.height}function Cl(){return(y.gfx.viewport.width+y.gfx.viewport.height)/(y.gfx.width+y.gfx.height)}function Zn(){return X(Mt()/2,Tt()/2)}var Nu=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,s,o){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=s,this.textures=[qs.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=o;let n=this.canvas.getContext("2d");if(!n)throw new Error("Failed to get 2d context");this.c2d=n}addSingle(e){let t=qs.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new it(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,s=e.height+this.padding*2;if(t>this.canvas.width||s>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+s>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(qs.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let o=this.textures[this.textures.length-1],n=new Q(this.x+this.padding,this.y+this.padding);return this.x+=t,s>this.curHeight&&(this.curHeight=s),e instanceof ImageData?this.c2d.putImageData(e,n.x,n.y):this.c2d.drawImage(e,n.x,n.y),o.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:n,size:new Q(e.width,e.height),texture:o}),this.lastTextureId++,[o,new it(n.x/this.canvas.width,n.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Jt(e){return typeof e!="string"||Dl(e)?e:y.assets.urlPrefix+e}var Qt=class Tl{loaded=!1;data=null;error=null;onLoadEvents=new Lt;onErrorEvents=new Lt;onFinishEvents=new Lt;constructor(t){t.then(s=>{this.loaded=!0,this.data=s,this.onLoadEvents.trigger(s)}).catch(s=>{if(this.error=s,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(s);else throw s}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let s=new Tl(Promise.resolve(t));return s.data=t,s.loaded=!0,s}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},yo=class{assets=new Map;lastUID=0;add(e,t){let s=e??this.lastUID+++"",o=new Qt(t);return this.assets.set(s,o),o}addLoaded(e,t){let s=e??this.lastUID+++"",o=Qt.loaded(t);return this.assets.set(s,o),o}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function qr(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function xi(e){return qr(e).then(t=>t.json())}function _u(e){return qr(e).then(t=>t.text())}function Fu(e){return qr(e).then(t=>t.arrayBuffer())}function qu(e){return e!==void 0&&(y.assets.urlPrefix=e),y.assets.urlPrefix}function Yu(e,t){return y.assets.custom.add(e,xi(Jt(t)))}function yi(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((s,o)=>{t.onload=()=>s(t),t.onerror=()=>o(new Error(`Failed to load image from "${e}"`))})}function no(){let e=[y.assets.sprites,y.assets.sounds,y.assets.shaders,y.assets.fonts,y.assets.bitmapFonts,y.assets.custom];return e.reduce((t,s)=>t+s.progress(),0)/e.length}function Pl(){return[y.assets.sprites,y.assets.sounds,y.assets.shaders,y.assets.fonts,y.assets.bitmapFonts,y.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function Xu(e){return y.assets.custom.get(e)??null}function nr(e){return y.assets.custom.add(null,e)}var Gu=(e,t)=>({urlPrefix:"",sprites:new yo,fonts:new yo,bitmapFonts:new yo,sounds:new yo,shaders:new yo,custom:new yo,music:{},packer:new Nu(e,2048,2048,t),loaded:!1}),Ku="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Gs=class Zo{tex;frames=[new it(0,0,1,1)];anims={};slice9=null;constructor(t,s,o={},n=null){this.tex=t,s&&(this.frames=s),this.anims=o,this.slice9=n}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,s={}){return typeof t=="string"?Zo.fromURL(t,s):Promise.resolve(Zo.fromImage(t,s))}static fromImage(t,s={}){let[o,n]=s.singular?y.assets.packer.addSingle(t):y.assets.packer.add(t),r=s.frames?s.frames.map(a=>new it(n.x+a.x*n.w,n.y+a.y*n.h,a.w*n.w,a.h*n.h)):Bl(s.sliceX||1,s.sliceY||1,n.x,n.y,n.w,n.h);return new Zo(o,r,s.anims,s.slice9)}static fromURL(t,s={}){return yi(t).then(o=>Zo.fromImage(o,s))}};function qn(e){if(typeof e=="string"){let t=Il(e);if(t)return t;if(no()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Gs)return Qt.loaded(e);if(e instanceof Qt)return e;throw new Error(`Invalid sprite: ${e}`)}}function Il(e){return y.assets.sprites.get(e)??null}function rn(e,t,s={sliceX:1,sliceY:1,anims:{}}){return t=Jt(t),Array.isArray(t)?t.some(o=>typeof o=="string")?y.assets.sprites.add(e,Promise.all(t.map(o=>typeof o=="string"?yi(o):Promise.resolve(o))).then(o=>Sa(o,s))):y.assets.sprites.addLoaded(e,Sa(t,s)):typeof t=="string"?y.assets.sprites.add(e,Gs.from(t,s)):y.assets.sprites.addLoaded(e,Gs.fromImage(t,s))}function Bl(e=1,t=1,s=0,o=0,n=1,r=1){let a=[],c=n/e,l=r/t;for(let d=0;d<t;d++)for(let i=0;i<e;i++)a.push(new it(s+i*c,o+d*l,c,l));return a}function Sa(e,t={}){let s=document.createElement("canvas"),o=e[0].width,n=e[0].height;s.width=o*e.length,s.height=n;let r=s.getContext("2d");if(!r)throw new Error("Failed to create canvas context");e.forEach((c,l)=>{c instanceof ImageData?r.putImageData(c,l*o,0):r.drawImage(c,l*o,0)});let a=r.getImageData(0,0,e.length*o,n);return Gs.fromImage(a,{...t,sliceX:e.length,sliceY:1})}function Vu(e="bean"){return rn(e,Ku)}function Wu(e,t,s){t=Jt(t),s=Jt(s),typeof t=="string"&&!s&&(s=$h(t)+".json");let o=typeof s=="string"?xi(s):Promise.resolve(s);return y.assets.sprites.add(e,o.then(n=>{let r=n.meta.size,a=n.frames.map(l=>new it(l.frame.x/r.w,l.frame.y/r.h,l.frame.w/r.w,l.frame.h/r.h)),c={};for(let l of n.meta.frameTags)l.from===l.to?c[l.name]=l.from:c[l.name]={from:l.from,to:l.to,speed:10,loop:!0,pingpong:l.direction==="pingpong"};return Gs.from(t,{frames:a,anims:c})}))}var Yn=class{fontface;filter=Zi;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??Zi,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Fe(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function Ol(e){if(!e)return Ol(y.globalOpt.font??Oh);if(typeof e=="string"){let t=Hl(e),s=Ll(e);if(t)return t.data??t;if(s)return s.data??s;if(document.fonts.check(`64px ${e}`))return e;if(no()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof Qt)return e.data?e.data:e;return e}function Ll(e){return y.assets.fonts.get(e)??null}function ju(e,t,s={}){let o=Jt(t),n=new FontFace(e,typeof t=="string"?`url(${o})`:o);return document.fonts.add(n),y.assets.fonts.add(e,n.load().catch(r=>{throw new Error(`Failed to load font from "${o}": ${r}`)}).then(r=>new Yn(r,s)))}function $u(e,t,s,o){let n=e.width/t,r={},a=o.split("").entries();for(let[c,l]of a)r[l]=new it(c%n*t,Math.floor(c/n)*s,t,s);return{tex:e,map:r,size:s}}function Hl(e){return y.assets.bitmapFonts.get(e)??null}function Ju(e,t,s,o,n={}){let r=Jt(t);return y.assets.bitmapFonts.add(e,yi(r).then(a=>$u(qs.fromImage(y.gfx.ggl,a,n),s,o,n.chars??wl)))}function Qu(e,t){return t=Jt(t),y.assets.sprites.add(e,new Promise(async s=>{let o=typeof t=="string"?await xi(t):t,n=await Promise.all(o.frames.map(yi)),r=document.createElement("canvas");r.width=o.width,r.height=o.height*o.frames.length;let a=r.getContext("2d");if(!a)throw new Error("Failed to create canvas context");n.forEach((l,d)=>{a.drawImage(l,0,d*o.height)});let c=await rn(null,r,{sliceY:o.frames.length,anims:o.anims});s(c)}))}var Zu=class{ctx;glProgram;constructor(e,t,s,o){this.ctx=e,e.onDestroy(()=>this.free());let n=e.gl,r=n.createShader(n.VERTEX_SHADER),a=n.createShader(n.FRAGMENT_SHADER);if(!r||!a)throw new Error("Failed to create shader");n.shaderSource(r,t),n.shaderSource(a,s),n.compileShader(r),n.compileShader(a);let c=n.createProgram();if(this.glProgram=c,n.attachShader(c,r),n.attachShader(c,a),o.forEach((l,d)=>n.bindAttribLocation(c,d,l)),n.linkProgram(c),!n.getProgramParameter(c,n.LINK_STATUS)){let l=n.getShaderInfoLog(r);if(l)throw new Error("VERTEX SHADER "+l);let d=n.getShaderInfoLog(a);if(d)throw new Error("FRAGMENT SHADER "+d)}n.deleteShader(r),n.deleteShader(a)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let s in e){let o=e[s],n=t.getUniformLocation(this.glProgram,s);if(typeof o=="number")t.uniform1f(n,o);else if(o instanceof xs)t.uniformMatrix4fv(n,!1,new Float32Array(o.m));else if(o instanceof He)t.uniform3f(n,o.r,o.g,o.b);else if(o instanceof Q)t.uniform2f(n,o.x,o.y);else if(Array.isArray(o))o[0],Kh(o)?t.uniform1fv(n,o):Gh(o)?t.uniform2fv(n,o.map(r=>[r.x,r.y]).flat()):Xh(o)&&t.uniform3fv(n,o.map(r=>[r.r,r.g,r.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function Yr(e,t=ki,s=er){let o=Uh.replace("{{user}}",t??ki),n=Nh.replace("{{user}}",s??er);try{return new Zu(e,o,n,Ur.map(r=>r.name))}catch(r){let a=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,c=Jh(r).match(a);if(!c?.groups)throw r;let l=Number(c.groups.line)-14,d=c.groups.msg.trim(),i=c.groups.type.toLowerCase();throw new Error(`${i} shader line ${l}: ${d}`)}}function ku(e){if(!e)return y.gfx.defShader;if(typeof e=="string"){let t=zl(e);if(t)return t.data??t;if(no()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof Qt)return e.data?e.data:e;return e}function zl(e){return y.assets.shaders.get(e)??null}function ep(e,t,s){return y.assets.shaders.addLoaded(e,Yr(y.gfx.ggl,t,s))}function tp(e,t,s){t=Jt(t),s=Jt(s);let o=r=>r?_u(r):Promise.resolve(null),n=Promise.all([o(t),o(s)]).then(([r,a])=>Yr(y.gfx.ggl,r,a));return y.assets.shaders.add(e,n)}var gn=class Xn{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((s,o)=>y.audio.ctx.decodeAudioData(t,s,o)).then(s=>new Xn(s))}static fromURL(t){return Dl(t)?Xn.fromArrayBuffer(Wh(t)):Fu(t).then(s=>Xn.fromArrayBuffer(s))}};function sp(e){if(typeof e=="string"){let t=Ul(e);if(t)return t;if(no()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof gn)return Qt.loaded(e);if(e instanceof Qt)return e;throw new Error(`Invalid sound: ${e}`)}}function Ul(e){return y.assets.sounds.get(e)??null}function op(e,t){return t=Jt(t),y.assets.sounds.add(e,typeof t=="string"?gn.fromURL(t):gn.fromArrayBuffer(t))}function np(e,t){let s=Jt(t),o=new Audio(s);return o.preload="auto",y.assets.music[e]=s}function Nl(e,t){return e=Jt(e),nr(typeof t=="string"?new Promise((s,o)=>{xi(t).then(n=>{Nl(e,n).then(s).catch(o)})}):Gs.from(e).then(s=>{let o={};for(let n in t){let r=t[n],a=s.frames[0],c=2048*a.w,l=2048*a.h,d=r.frames?r.frames.map(p=>new it(a.x+(r.x+p.x)/c*a.w,a.y+(r.y+p.y)/l*a.h,p.w/c*a.w,p.h/l*a.h)):Bl(r.sliceX||1,r.sliceY||1,a.x+r.x/c*a.w,a.y+r.y/l*a.h,r.width/c*a.w,r.height/l*a.h),i=new Gs(s.tex,d,r.anims);y.assets.sprites.addLoaded(n,i),o[n]=i}return o}))}function Ws(e,t,s=!1,o,n,r={}){let a=o??y.gfx.defTex,c=n??y.gfx.defShader,l=ku(c);if(!l||l instanceof Qt)return;let d=y.gfx.fixed||s?y.gfx.transform:y.game.cam.transform.mult(y.gfx.transform),i=[];for(let p of e){let h=Lu(d.multVec2(p.pos));i.push(h.x,h.y,p.uv.x,p.uv.y,p.color.r/255,p.color.g/255,p.color.b/255,p.opacity)}y.gfx.renderer.push(y.gfx.ggl.gl.TRIANGLES,i,t,l,a,r)}function Fs(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Vt(),lt(e.pos),fn(e.scale),Do(e.angle),lt(e.offset),e.fill!==!1){let s=e.color??He.WHITE,o=e.pts.map((r,a)=>({pos:new Q(r.x,r.y),uv:e.uv?e.uv[a]:new Q(0,0),color:e.colors&&e.colors[a]?e.colors[a].mult(s):s,opacity:e.opacity??1})),n;e.triangulate?n=yl(e.pts).map(r=>r.map(a=>e.pts.indexOf(a))).flat():n=[...Array(t-2).keys()].map(r=>[0,r+1,r+2]).flat(),Ws(o,e.indices??n,e.fixed,e.uv?e.tex:y.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&Xr({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),_t()}}function _l(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,s=e.end??360,o=Po(e.anchor??"center").scale(new Q(-e.radiusX,-e.radiusY)),n=Qo(o,e.radiusX,e.radiusY,t,s,e.resolution);n.unshift(o);let r=Object.assign({},e,{pts:n,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(n.length-1).fill(e.gradient[1])]}:{}});if(s-t>=360&&e.outline){e.fill!==!1&&Fs(Object.assign({},r,{outline:null})),Fs(Object.assign({},r,{pts:n.slice(1),fill:!1}));return}Fs(r)}function Io(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&_l(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function ko(e){let{p1:t,p2:s}=e;if(!t||!s)throw new Error('drawLine() requires properties "p1" and "p2".');let o=e.width||1,n=s.sub(t).unit().normal().scale(o*.5),r=[t.sub(n),t.add(n),s.add(n),s.sub(n)].map(a=>({pos:new Q(a.x,a.y),uv:new Q(0),color:e.color??He.WHITE,opacity:e.opacity??1}));Ws(r,[0,1,3,1,2,3],e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function ip(e){let t=e.pts,s=[],o=(e.width||1)*.5,n=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),r=e.pos||X(0,0),a;n?a=t[0].sub(t[t.length-2]):a=t[1].sub(t[0]);let c=a.len(),l=a.normal().scale(-o/c),d,i=t[0];if(!n)switch(e.cap){case"square":{let g=a.scale(-o/c);s.push(i.add(g).add(l)),s.push(i.add(g).sub(l));break}case"round":{let g=Math.max(o,10),u=Math.PI/g,w=l.scale(-1),v=Math.cos(u),A=Math.sin(u);for(let D=0;D<g;D++)s.push(i),s.push(i.sub(w)),w=X(w.x*v-w.y*A,w.x*A+w.y*v)}}for(let g=1;g<t.length;g++){if(i===t[g]||i.eq(t[g]))continue;d=i,i=t[g];let u=i.sub(d),w=u.len(),v=u.normal().scale(-o/w),A=a.cross(u);if(Math.abs(A)/(c*w)<.05){s.push(d.add(l)),s.push(d.sub(l)),a.dot(u)<0&&(s.push(d.sub(l)),s.push(d.add(l))),a=u,c=w,l=v;continue}let D=v.sub(l).cross(u)/A,Y=l.add(a.scale(D));A>0?(s.push(d.add(Y)),s.push(d.sub(l)),s.push(d.add(Y)),s.push(d.sub(v))):(s.push(d.add(l)),s.push(d.sub(Y)),s.push(d.add(v)),s.push(d.sub(Y))),a=u,c=w,l=v}if(!n)switch(s.push(i.add(l)),s.push(i.sub(l)),e.cap){case"square":{let g=a.scale(o/c);s.push(i.add(g).add(l)),s.push(i.add(g).sub(l));break}case"round":{let g=Math.max(o,10),u=Math.PI/g,w=l.scale(1),v=Math.cos(u),A=Math.sin(u);for(let D=0;D<g;D++)w=X(w.x*v-w.y*A,w.x*A+w.y*v),s.push(i),s.push(i.sub(w))}}if(s.length<4)return;let p=s.map(g=>({pos:r.add(g),uv:X(),color:e.color||He.WHITE,opacity:e.opacity??1})),h=[],f=0;for(let g=0;g<s.length-2;g+=2)h[f++]=g+1,h[f++]=g,h[f++]=g+2,h[f++]=g+2,h[f++]=g+3,h[f++]=g+1;n&&(h[f++]=s.length-1,h[f++]=s.length-2,h[f++]=0,h[f++]=0,h[f++]=1,h[f++]=s.length-1),Ws(p,h,e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function rp(e){let t=e.pts,s=[],o=(e.width||1)*.5,n=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),r=e.pos||X(0,0),a;n?a=t[0].sub(t[t.length-2]):a=t[1].sub(t[0]);let c=a.len(),l=a.normal().scale(-o/c),d,i=t[0];if(!n)switch(e.cap){case"square":{let g=a.scale(-o/c);s.push(i.add(g).add(l)),s.push(i.add(g).sub(l));break}case"round":{let g=Math.max(o,10),u=Math.PI/g,w=l.scale(-1),v=Math.cos(u),A=Math.sin(u);for(let D=0;D<g;D++)s.push(i),s.push(i.sub(w)),w=X(w.x*v-w.y*A,w.x*A+w.y*v)}}for(let g=1;g<t.length;g++){if(i===t[g]||i.eq(t[g]))continue;d=i,i=t[g];let u=i.sub(d),w=u.len(),v=u.normal().scale(-o/w),A=a.cross(u);if(Math.abs(A)/(c*w)<.05){s.push(d.add(l)),s.push(d.sub(l)),a.dot(u)<0&&(s.push(d.sub(l)),s.push(d.add(l))),a=u,c=w,l=v;continue}let D=v.sub(l).cross(u)/A,Y=l.add(a.scale(D));if(A>0){let P=d.add(Y),m=Math.max(o,10),x=mt(l.angleBetween(v)/m),E=l,S=Math.cos(x),I=Math.sin(x);for(let T=0;T<m;T++)s.push(P),s.push(d.sub(E)),E=X(E.x*S-E.y*I,E.x*I+E.y*S)}else{let P=d.sub(Y),m=Math.max(o,10),x=mt(l.angleBetween(v)/m),E=l,S=Math.cos(x),I=Math.sin(x);for(let T=0;T<m;T++)s.push(d.add(E)),s.push(P),E=X(E.x*S-E.y*I,E.x*I+E.y*S)}a=u,c=w,l=v}if(!n)switch(s.push(i.add(l)),s.push(i.sub(l)),e.cap){case"square":{let g=a.scale(o/c);s.push(i.add(g).add(l)),s.push(i.add(g).sub(l));break}case"round":{let g=Math.max(o,10),u=Math.PI/g,w=l.scale(1),v=Math.cos(u),A=Math.sin(u);for(let D=0;D<g;D++)w=X(w.x*v-w.y*A,w.x*A+w.y*v),s.push(i),s.push(i.sub(w))}}if(s.length<4)return;let p=s.map(g=>({pos:r.add(g),uv:X(),color:e.color||He.WHITE,opacity:e.opacity??1})),h=[],f=0;for(let g=0;g<s.length-2;g+=2)h[f++]=g+1,h[f++]=g,h[f++]=g+2,h[f++]=g+2,h[f++]=g+3,h[f++]=g+1;n&&(h[f++]=s.length-1,h[f++]=s.length-2,h[f++]=0,h[f++]=0,h[f++]=1,h[f++]=s.length-1),Ws(p,h,e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function ap(e){let t=e.pts,s=[],o=(e.width||1)*.5,n=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),r=e.pos||X(0,0),a;n?a=t[0].sub(t[t.length-2]):a=t[1].sub(t[0]);let c=a.len(),l=a.normal().scale(-o/c),d,i=t[0];if(!n)switch(e.cap){case"square":{let g=a.scale(-o/c);s.push(i.add(g).add(l)),s.push(i.add(g).sub(l));break}case"round":{let g=Math.max(o,10),u=Math.PI/g,w=l.scale(-1),v=Math.cos(u),A=Math.sin(u);for(let D=0;D<g;D++)s.push(i),s.push(i.sub(w)),w=X(w.x*v-w.y*A,w.x*A+w.y*v)}}for(let g=1;g<t.length;g++){if(i===t[g]||i.eq(t[g]))continue;d=i,i=t[g];let u=i.sub(d),w=u.len(),v=u.normal().scale(-o/w),A=a.cross(u);if(Math.abs(A)/(c*w)<.05){s.push(d.add(l)),s.push(d.sub(l)),a.dot(u)<0&&(s.push(d.sub(l)),s.push(d.add(l))),a=u,c=w,l=v;continue}let D=v.sub(l).cross(u)/A,Y=l.add(a.scale(D));s.push(d.add(Y)),s.push(d.sub(Y)),a=u,c=w,l=v}if(!n)switch(s.push(i.add(l)),s.push(i.sub(l)),e.cap){case"square":{let g=a.scale(o/c);s.push(i.add(g).add(l)),s.push(i.add(g).sub(l));break}case"round":{let g=Math.max(o,10),u=Math.PI/g,w=l.scale(1),v=Math.cos(u),A=Math.sin(u);for(let D=0;D<g;D++)w=X(w.x*v-w.y*A,w.x*A+w.y*v),s.push(i),s.push(i.sub(w))}}if(s.length<4)return;let p=s.map(g=>({pos:r.add(g),uv:X(),color:e.color||He.WHITE,opacity:e.opacity??1})),h=[],f=0;for(let g=0;g<s.length-2;g+=2)h[f++]=g+1,h[f++]=g,h[f++]=g+2,h[f++]=g+2,h[f++]=g+3,h[f++]=g+1;n&&(h[f++]=s.length-1,h[f++]=s.length-2,h[f++]=0,h[f++]=0,h[f++]=1,h[f++]=s.length-1),Ws(p,h,e.fixed,y.gfx.defTex,e.shader,e.uniform??void 0)}function Xr(e){let t=e.pts,s=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return ip(e);case"round":return rp(e);case"miter":return ap(e)}if(e.radius&&t.length>=3){ko(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let o=1;o<t.length-2;o++){let n=t[o],r=t[o+1];ko(Object.assign({},e,{p1:n,p2:r}))}ko(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let o=0;o<t.length-1;o++)ko(Object.assign({},e,{p1:t[o],p2:t[o+1]})),e.join!=="none"&&Io(Object.assign({},e,{pos:t[o],radius:s/2}))}}function Fl(e,t){let s=t.segments??16,o=[];for(let n=0;n<=s;n++)o.push(e(n/s));Xr({pts:o,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function lp(e){Fl(t=>zr(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var qs=class ql{ctx;src=null;glTex;width;height;constructor(t,s,o,n={}){this.ctx=t;let r=t.gl,a=t.gl.createTexture();if(!a)throw new Error("Failed to create texture");this.glTex=a,t.onDestroy(()=>this.free()),this.width=s,this.height=o;let c={linear:r.LINEAR,nearest:r.NEAREST}[n.filter??t.opts.texFilter??"nearest"],l={repeat:r.REPEAT,clampToEdge:r.CLAMP_TO_EDGE}[n.wrap??"clampToEdge"];this.bind(),s&&o&&r.texImage2D(r.TEXTURE_2D,0,r.RGBA,s,o,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,c),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,c),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,l),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,l),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,s,o={}){let n=new ql(t,s.width,s.height,o);return n.update(s),n.src=s,n}update(t,s=0,o=0){let n=this.ctx.gl;this.bind(),n.texSubImage2D(n.TEXTURE_2D,0,s,o,n.RGBA,n.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},kn=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,s,o={}){this.ctx=e;let n=e.gl;e.onDestroy(()=>this.free()),this.tex=new qs(e,t,s,o);let r=n.createFramebuffer(),a=n.createRenderbuffer();if(!r||!a)throw new Error("Failed to create framebuffer");this.glFramebuffer=r,this.glRenderbuffer=a,this.bind(),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,t,s),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.tex.glTex,0),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let s=this.width*4,o=new Uint8Array(s);for(let n=0;n<(this.height/2|0);n++){let r=n*s,a=(this.height-n-1)*s;o.set(t.subarray(r,r+s)),t.copyWithin(r,a,a+s),t.set(o,a)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},cp=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,s,o){let n=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((a,c)=>a+c.size,0),this.maxVertices=s,this.maxIndices=o;let r=n.createBuffer();if(!r)throw new Error("Failed to create vertex buffer");this.glVBuf=r,e.pushArrayBuffer(this.glVBuf),n.bufferData(n.ARRAY_BUFFER,s*4,n.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=n.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),n.bufferData(n.ELEMENT_ARRAY_BUFFER,o*4,n.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,s,o,n=null,r={}){(e!==this.curPrimitive||n!==this.curTex||o!==this.curShader||!_r(this.curUniform,r)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+s.length>this.maxIndices)&&this.flush();let a=this.vqueue.length/this.stride;for(let c of t)this.vqueue.push(c);for(let c of s)this.iqueue.push(c+a);this.curPrimitive=e,this.curShader=o,this.curTex=n,this.curUniform=r}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Qs(e){let t=[],s=r=>{t.push(r),e(r)},o=()=>{t.pop(),e(n()??null)},n=()=>t[t.length-1];return[s,o,n]}function dp(e,t={}){let s=[];function o(P){s.push(P)}function n(){s.forEach(m=>m());let P=e.getExtension("WEBGL_lose_context");P&&P.loseContext()}let r=null;function a(P){if(_r(P,r))return;r=P;let m=P.reduce((x,E)=>x+E.size,0);P.reduce((x,E,S)=>(e.vertexAttribPointer(S,E.size,e.FLOAT,!1,m*4,x),e.enableVertexAttribArray(S),x+E.size*4),0)}let[c,l]=Qs(P=>e.bindTexture(e.TEXTURE_2D,P)),[d,i]=Qs(P=>e.bindBuffer(e.ARRAY_BUFFER,P)),[p,h]=Qs(P=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,P)),[f,g]=Qs(P=>e.bindFramebuffer(e.FRAMEBUFFER,P)),[u,w]=Qs(P=>e.bindRenderbuffer(e.RENDERBUFFER,P)),[v,A]=Qs(P=>{if(!P)return;let{x:m,y:x,w:E,h:S}=P;e.viewport(m,x,E,S)}),[D,Y]=Qs(P=>e.useProgram(P));return v({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:o,destroy:n,pushTexture2D:c,popTexture2D:l,pushArrayBuffer:d,popArrayBuffer:i,pushElementArrayBuffer:p,popElementArrayBuffer:h,pushFramebuffer:f,popFramebuffer:g,pushRenderbuffer:u,popRenderbuffer:w,pushViewport:v,popViewport:A,pushProgram:D,popProgram:Y,setVertexFormat:a}}var zi={};function Ea(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(X(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function ir(e){let t={},s="",o=[],n=String(e),r=a=>{o.length>0&&(t[s.length]=o.slice()),s+=a};for(;n!=="";){if(n[0]==="\\"){if(n.length===1)throw new Error("Styled text error: \\ at end of string");r(n[1]),n=n.slice(2);continue}if(n[0]==="["){let a=/^\[(\/)?(\w+?)\]/.exec(n);if(!a){r(n[0]),n=n.slice(1);continue}let[c,l,d]=a;if(l!==void 0){let i=o.pop();if(i!==d)throw i!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${i}], got [/${d}]`):new Error(`Styled text error: stray end tag [/${d}]`)}else o.push(d);n=n.slice(c.length);continue}r(n[0]),n=n.slice(1)}if(o.length>0)throw new Error(`Styled text error: unclosed tags ${o}`);return{charStyleMap:t,text:s}}function io(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=Ol(e.font);if(!e.text||e.text===""||t instanceof Qt||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:s,text:o}=ir(e.text+""),n=kh(o);if(t instanceof Yn||typeof t=="string"){let D=t instanceof Yn?t.fontface.family:t,Y=t instanceof Yn?{outline:t.outline,filter:t.filter}:{outline:null,filter:Zi},P=zi[D]??{font:{tex:new qs(y.gfx.ggl,2048,2048,{filter:Y.filter}),map:{},size:64},cursor:new Q(0),maxHeight:0,outline:Y.outline};zi[D]||(zi[D]=P),t=P.font;for(let m of n)if(!P.font.map[m]){let x=y.fontCacheC2d;if(!x)throw new Error("fontCacheC2d is not defined.");if(!y.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");x.clearRect(0,0,y.fontCacheCanvas.width,y.fontCacheCanvas.height),x.font=`${t.size}px ${D}`,x.textBaseline="top",x.textAlign="left",x.fillStyle="#ffffff";let E=x.measureText(m),S=Math.ceil(E.width);if(!S)continue;let I=Math.ceil(Math.abs(E.actualBoundingBoxAscent))+Math.ceil(Math.abs(E.actualBoundingBoxDescent));P.outline&&P.outline.width&&P.outline.color&&(x.lineJoin="round",x.lineWidth=P.outline.width*2,x.strokeStyle=P.outline.color.toHex(),x.strokeText(m,P.outline.width,P.outline.width),S+=P.outline.width*2,I+=P.outline.width*3),x.fillText(m,P.outline?.width??0,P.outline?.width??0);let T=x.getImageData(0,0,S,I);if(P.cursor.x+S>2048&&(P.cursor.x=0,P.cursor.y+=P.maxHeight,P.maxHeight=0,P.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(T,P.cursor.x,P.cursor.y),t.map[m]=new it(P.cursor.x,P.cursor.y,S,I),P.cursor.x+=S+1,P.maxHeight=Math.max(P.maxHeight,I)}}let r=e.size||t.size,a=X(e.scale??1).scale(r/t.size),c=e.lineSpacing??0,l=e.letterSpacing??0,d=0,i=0,p=0,h=[],f=[],g=0,u=null,w=0,v;for(;g<n.length;){let D=n[g];if(D===`
`)p+=r+c,h.push({width:d-l,chars:f}),u=null,w=0,d=0,f=[],v=void 0;else{let Y=t.map[D];if(Y){let P=Y.w*a.x;e.width&&d+P>e.width&&(p+=r+c,u!=null&&(g-=f.length-u,D=n[g],Y=t.map[D],P=Y.w*a.x,f=f.slice(0,u-1),d=w),u=null,w=0,h.push({width:d-l,chars:f}),d=v??0,f=[]),f.push({tex:t.tex,width:Y.w,height:Y.h,quad:new it(Y.x/t.tex.width,Y.y/t.tex.height,Y.w/t.tex.width,Y.h/t.tex.height),ch:D,pos:new Q(d,p),opacity:e.opacity??1,color:e.color??He.WHITE,scale:X(a),angle:0}),D===" "&&(u=f.length,w=d),e.indentAll&&v===void 0&&/\S/.test(D)&&(v=d),d+=P,i=Math.max(i,d),d+=l}}g++}h.push({width:d-l,chars:f}),p+=r,e.width&&(i=e.width);let A=[];for(let D=0;D<h.length;D++){let Y=(i-h[D].width)*Ru(e.align??"left");for(let P of h[D].chars){let m=t.map[P.ch],x=A.length+D;if(P.pos=P.pos.add(Y,0).add(m.w*a.x*.5,m.h*a.y*.5),e.transform){let E=typeof e.transform=="function"?e.transform(x,P.ch):e.transform;E&&Ea(P,E)}if(s[x]){let E=s[x];for(let S of E){let I=e.styles?.[S],T=typeof I=="function"?I(x,P.ch):I;T&&Ea(P,T)}}A.push(P)}}return{width:i,height:p,chars:A,opt:e,renderedText:o}}function mn(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,s=e.height,o=Po(e.anchor||mi).scale(new Q(t,s).scale(-.5)),n=e.quad||new it(0,0,1,1),r=e.color||Fe(255,255,255),a=e.opacity??1,c=e.tex?.1/e.tex.width:0,l=e.tex?.1/e.tex.height:0,d=n.x+c,i=n.y+l,p=n.w-c*2,h=n.h-l*2;Vt(),lt(e.pos),Do(e.angle),fn(e.scale),lt(o),Ws([{pos:new Q(-t/2,s/2),uv:new Q(e.flipX?d+p:d,e.flipY?i:i+h),color:r,opacity:a},{pos:new Q(-t/2,-s/2),uv:new Q(e.flipX?d+p:d,e.flipY?i+h:i),color:r,opacity:a},{pos:new Q(t/2,-s/2),uv:new Q(e.flipX?d:d+p,e.flipY?i+h:i),color:r,opacity:a},{pos:new Q(t/2,s/2),uv:new Q(e.flipX?d:d+p,e.flipY?i:i+h),color:r,opacity:a}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),_t()}function ro(e){Vt(),lt(e.opt.pos),Do(e.opt.angle),lt(Po(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{mn({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),_t()}function jt(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,s=e.height,o=Po(e.anchor||mi).add(1,1).scale(new Q(t,s).scale(-.5)),n=[new Q(0,0),new Q(t,0),new Q(t,s),new Q(0,s)];if(e.radius){let r=Math.min(t,s)/2,a=Array.isArray(e.radius)?e.radius.map(c=>Math.min(r,c)):new Array(4).fill(Math.min(r,e.radius));n=[new Q(a[0],0),...a[1]?Qo(new Q(t-a[1],a[1]),a[1],a[1],270,360):[X(t,0)],...a[2]?Qo(new Q(t-a[2],s-a[2]),a[2],a[2],0,90):[X(t,s)],...a[3]?Qo(new Q(a[3],s-a[3]),a[3],a[3],90,180):[X(0,s)],...a[0]?Qo(new Q(a[0],a[0]),a[0],a[0],180,270):[]]}Fs(Object.assign({},e,{offset:o,pts:n,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function Ns(e){Wt();let t=y.gfx.width,s=y.gfx.height;y.gfx.width=y.gfx.viewport.width,y.gfx.height=y.gfx.viewport.height,e(),Wt(),y.gfx.width=t,y.gfx.height=s}function Ma(e,t){Ns(()=>{let s=X(8);Vt(),lt(e);let o=io({text:t,font:Qn,size:16,pos:s,color:Fe(255,255,255),fixed:!0}),n=o.width+s.x*2,r=o.height+s.x*2;e.x+n>=Mt()&&lt(X(-n,0)),e.y+r>=Tt()&&lt(X(0,-r)),jt({width:n,height:r,color:Fe(0,0,0),radius:4,opacity:.8,fixed:!0}),ro(o),_t()})}function Yl(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return Fs(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function hp(){if(y.debug.inspect){let e=null;for(let t of y.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(y.game.root.drawInspect(),e){let t=[],s=e.inspect();for(let o in s)s[o]?t.push(`${s[o]}`):t.push(`${o}`);Ma(hu(y.k.mousePos()),t.join(`
`))}Ma(X(8),`FPS: ${y.debug.fps()}`)}y.debug.paused&&Ns(()=>{Vt(),lt(Mt(),0),lt(-8,8);let e=32;jt({width:e,height:e,anchor:"topright",color:Fe(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)jt({width:4,height:e*.6,anchor:"center",pos:X(-e/3*t,e*.5),color:Fe(255,255,255),radius:2,fixed:!0});_t()}),y.debug.timeScale!==1&&Ns(()=>{Vt(),lt(Mt(),Tt()),lt(-8,-8);let e=8,t=io({text:y.debug.timeScale.toFixed(1),font:Qn,size:16,color:Fe(255,255,255),pos:X(-e),anchor:"botright",fixed:!0});jt({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Fe(0,0,0),opacity:.8,radius:4,fixed:!0});for(let s=0;s<2;s++){let o=y.debug.timeScale<1;Yl({p1:X(-t.width-e*(o?2:3.5),-e),p2:X(-t.width-e*(o?2:3.5),-e-t.height),p3:X(-t.width-e*(o?3.5:2),-e-t.height/2),pos:X(-s*e*1+(o?-e*.5:0),0),color:Fe(255,255,255),fixed:!0})}ro(t),_t()}),y.debug.curRecording&&Ns(()=>{Vt(),lt(0,Tt()),lt(24,-24),Io({radius:12,color:Fe(255,0,0),opacity:sl(0,1,y.app.time()*4),fixed:!0}),_t()}),y.debug.showLog&&y.game.logs.length>0&&Ns(()=>{Vt(),lt(0,Tt()),lt(8,-8);let e=8,t=[];for(let o of y.game.logs){let n="",r=o.msg instanceof Error?"error":"info";n+=`[time]${o.time.toFixed(2)}[/time]`,n+=" ",n+=`[${r}]${rr(o.msg)}[/${r}]`,t.push(n)}y.game.logs=y.game.logs.filter(o=>y.app.time()-o.time<(y.globalOpt.logTime||4));let s=io({text:t.join(`
`),font:Qn,pos:X(e,-e),anchor:"botleft",size:16,width:Mt()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Fe(127,127,127)},info:{color:Fe(255,255,255)},error:{color:Fe(255,0,127)}}});jt({width:s.width+e*2,height:s.height+e*2,anchor:"botleft",color:Fe(0,0,0),radius:4,opacity:.8,fixed:!0}),ro(s),_t()})}function rr(e,t=!1,s=new Set){if(s.has(e))return"<recursive>";var o="",n;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(o=["[",e.map(r=>rr(r,!0,s.union(new Set([e])))).join(", "),"]"].join(""),e=o),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(o+=e.constructor.name+" "),o+=["{",(n=Object.getOwnPropertyNames(e).map(r=>`${/^\w+$/.test(r)?r:JSON.stringify(r)}: ${rr(e[r],!0,s.union(new Set([e])))}`).join(", "))?` ${n} `:"","}"].join(""),e=o),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function up(){let e=y.game.cam,t=Q.fromAngle(vt(0,360)).scale(e.shake);e.shake=Ft(e.shake,0,5*At()),e.transform=new xs().translate(Zn()).scale(e.scale).rotate(e.angle).translate((e.pos??Zn()).scale(-1).add(t)),y.game.root.draw(),Wt()}function pp(){let e=no();y.game.events.numListeners("loading")>0?y.game.events.trigger("loading",e):Ns(()=>{let t=Mt()/2,s=24,o=X(Mt()/2,Tt()/2).sub(X(t/2,s/2));jt({pos:X(0),width:Mt(),height:Tt(),color:Fe(0,0,0)}),jt({pos:o,width:t,height:s,fill:!1,outline:{width:4}}),jt({pos:o,width:t*e,height:s})})}function Xl(e,t,s){let o=y.gfx.ggl.gl;Wt(),o.clear(o.STENCIL_BUFFER_BIT),o.enable(o.STENCIL_TEST),o.stencilFunc(o.NEVER,1,255),o.stencilOp(o.REPLACE,o.REPLACE,o.REPLACE),t(),Wt(),o.stencilFunc(s,1,255),o.stencilOp(o.KEEP,o.KEEP,o.KEEP),e(),Wt(),o.disable(o.STENCIL_TEST)}function fp(e,t){let s=y.gfx.ggl.gl;Xl(e,t,s.EQUAL)}function ei(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new it(0,0,1,1),s=e.tex.width*t.w,o=e.tex.height*t.h,n=new Q(1);if(e.tiled){let r=Po(e.anchor||mi);(e.pos?.x||0)-(r.x+1)*.5*(e.width||s),(e.pos?.y||0)-(r.y+1)*.5*(e.height||o);let a=(e.width||s)/s,c=(e.height||o)/o,l=Math.floor(a),d=Math.floor(c),i=a-l,p=c-d,h=(l+i?1:0)*(d+p?1:0),f=new Array(h*6),g=new Array(h*4),u=0,w=(v,A,D,Y,P)=>{f[u*6+0]=u*4+0,f[u*6+1]=u*4+1,f[u*6+2]=u*4+3,f[u*6+3]=u*4+1,f[u*6+4]=u*4+2,f[u*6+5]=u*4+3,g[u*4+0]={pos:new Q(v-r.x,A-r.y),uv:new Q(P.x,P.y),color:e.color||He.WHITE,opacity:e.opacity||1},g[u*4+1]={pos:new Q(v+D-r.x,A-r.y),uv:new Q(P.x+P.w,P.y),color:e.color||He.WHITE,opacity:e.opacity||1},g[u*4+2]={pos:new Q(v+D-r.x,A+Y-r.y),uv:new Q(P.x+P.w,P.y+P.h),color:e.color||He.WHITE,opacity:e.opacity||1},g[u*4+3]={pos:new Q(v-r.x,A+Y-r.y),uv:new Q(P.x,P.y+P.h),color:e.color||He.WHITE,opacity:e.opacity||1},u++};for(let v=0;v<d;v++){for(let A=0;A<l;A++)w(A*s,v*o,s,o,t);i&&w(l*s,v*o,s*i,o,new it(t.x,t.y,t.w*i,t.h))}if(p){for(let v=0;v<l;v++)w(v*s,d*o,s,o*p,new it(t.x,t.y,t.w,t.h*p));i&&w(l*s,d*o,s*i,o*p,new it(t.x,t.y,t.w*i,t.h*p))}Ws(g,f,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(n.x=e.width/s,n.y=e.height/o):e.width?(n.x=e.width/s,n.y=n.x):e.height&&(n.y=e.height/o,n.x=n.y),mn(Object.assign({},e,{scale:n.scale(e.scale||new Q(1)),tex:e.tex,quad:t,width:s,height:o}))}function gp(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=qn(e.sprite);if(!t||!t.data)return;let s=t.data.frames[e.frame??0];if(!s)throw new Error(`Frame not found: ${e.frame??0}`);ei(Object.assign({},e,{tex:t.data.tex,quad:s.scale(e.quad??new it(0,0,1,1))}))}function mp(e,t){let s=y.gfx.ggl.gl;Xl(e,t,s.NOTEQUAL)}function Da(e){ro(io(e))}var xp=(e,t)=>{let s=Yr(t,ki,er),o=e.pixelDensity??1,n=e.scale??1,{gl:r}=t,a=qs.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),c=e.width&&e.height?new kn(t,e.width*o*n,e.height*o*n):new kn(t,r.drawingBufferWidth,r.drawingBufferHeight),l=null,d=1;e.background&&(typeof e.background=="string"?l=Fe(e.background):(l=Fe(...e.background),d=e.background[3]??1),r.clearColor(l.r/255,l.g/255,l.b/255,d??1)),r.enable(r.BLEND),r.blendFuncSeparate(r.ONE,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA);let i=new cp(t,Ur,Hh,zh),p=qs.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:s,defTex:a,frameBuffer:c,postShader:null,postShaderUniform:null,renderer:i,transform:new xs,transformStack:[],bgTex:p,bgColor:l,bgAlpha:d,width:e.width??r.drawingBufferWidth/o/n,height:e.height??r.drawingBufferHeight/o/n,viewport:{x:0,y:0,width:r.drawingBufferWidth,height:r.drawingBufferHeight,scale:1},fixed:!1}};function eo(e){return e.fixed?!0:e.parent?eo(e.parent):!1}function ao(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function yp(e,t={}){return{id:"circle",radius:e,draw(){Io(Object.assign(ao(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Qe(new Q(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Gl(...e){return{id:"color",color:Fe(...e),inspect(){return`color: ${this.color.toString()}`}}}function wp(e){return{add(){this.canvas=e}}}function bp(e=1){let t,s=0,o=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){o||(s+=At(),this.opacity=fs(s,0,e,0,t),s>=e&&(this.opacity=t,o=!0))}}}function vp(e="intersect"){return{id:"mask",mask:e}}function Kl(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,s=y.k.easings.linear){return y.game.root.tween(0,this.opacity,t,o=>this.opacity=o,s)},fadeOut(t=1,s=y.k.easings.linear){return y.game.root.tween(this.opacity,0,t,o=>this.opacity=o,s)},inspect(){return`opacity: ${tr(this.opacity,1)}`}}}function Ap(e=1,t=Fe(0,0,0),s=1,o="miter",n=10,r="butt"){return{id:"outline",outline:{width:e,color:t,opacity:s,join:o,miterLimit:n,cap:r},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var Sp=class{pos=X(0);vel=X(0);acc=X(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function Ep(e,t){let s=t.lifetime,o=[],n=e.colors||[He.WHITE],r=e.opacities||[1],a=e.quads||[new it(0,0,1,1)],c=e.scales||[1],l=e.lifeTime,d=t.direction,i=t.spread,p=e.speed||[0,0],h=e.angle||[0,0],f=e.angularVelocity||[0,0],g=e.acceleration||[X(0),X(0)],u=e.damping||[0,0],w=[],v=new Array(e.max),A=0,D=0;for(let m=0;m<e.max;m++){w[m*6+0]=m*4+0,w[m*6+1]=m*4+1,w[m*6+2]=m*4+3,w[m*6+3]=m*4+1,w[m*6+4]=m*4+2,w[m*6+5]=m*4+3;for(let x=0;x<4;x++)v[m*4+x]={pos:new Q(0,0),uv:new Q(0,0),color:Fe(255,255,255),opacity:1};o[m]=new Sp}let Y=new Lt;function P(m=0){for(;m<e.max;){if(o[m].gc)return m;m++}return null}return{id:"particles",emit(m){let x=0;for(let E=0;E<m;E++){if(x=P(x),x==null)return;let S=vt(d-i,d+i),I=Q.fromAngle(S).scale(vt(p[0],p[1])),T=vt(h[0],h[1]),z=vt(f[0],f[1]),_=X(vt(g[0].x,g[1].x),vt(g[0].y,g[1].y)),j=vt(u[0],u[1]),q=l?vt(l[0],l[1]):null,k=t.shape?t.shape.random():X(),U=o[x];U.lt=q,U.pos=k,U.vel=I,U.acc=_,U.angle=T,U.angularVelocity=z,U.damping=j,U.angularVelocity=z,U.gc=!1}A+=m},update(){if(s!==void 0&&s<=0)return;let m=At();for(let x of o)if(!x.gc){if(x.t+=m,x.lt&&x.t>=x.lt){x.gc=!0,A--;continue}x.vel=x.vel.add(x.acc.scale(m)).scale(1-x.damping*m),x.pos=x.pos.add(x.vel.scale(m)),x.angle+=x.angularVelocity*m}for(s!==void 0&&(s-=m,s<=0&&Y.trigger()),D+=m;A<e.max&&t.rate&&D>t.rate;)this.emit(1),A++,D-=t.rate},draw(){if(!(s!==void 0&&s<=0)){for(let m=0;m<o.length;m++){let x=o[m];if(x.gc)continue;let E=x.progress,S=Math.floor(x.progress*n.length),I=S<n.length-1?Ft(n[S],n[S+1],fs(E,S/n.length,(S+1)/n.length,0,1)):n[S],T=Math.floor(x.progress*r.length),z=T<r.length-1?Ft(r[T],r[T+1],fs(E,T/r.length,(T+1)/r.length,0,1)):r[T],_=Math.floor(x.progress*a.length),j=a[_],q=Math.floor(x.progress*c.length),k=c[q],U=Math.cos(x.angle*Math.PI/180),F=Math.sin(x.angle*Math.PI/180),O=(e.texture?e.texture.width:10)*j.w/2,J=(e.texture?e.texture.height:10)*j.h/2,ne=m*4,se=v[ne];se.pos.x=x.pos.x+-O*k*U- -J*k*F,se.pos.y=x.pos.y+-O*k*F+-J*k*U,se.uv.x=j.x,se.uv.y=j.y,se.color.r=I.r,se.color.g=I.g,se.color.b=I.b,se.opacity=z,se=v[ne+1],se.pos.x=x.pos.x+O*k*U- -J*k*F,se.pos.y=x.pos.y+O*k*F+-J*k*U,se.uv.x=j.x+j.w,se.uv.y=j.y,se.color.r=I.r,se.color.g=I.g,se.color.b=I.b,se.opacity=z,se=v[ne+2],se.pos.x=x.pos.x+O*k*U-J*k*F,se.pos.y=x.pos.y+O*k*F+J*k*U,se.uv.x=j.x+j.w,se.uv.y=j.y+j.h,se.color.r=I.r,se.color.g=I.g,se.color.b=I.b,se.opacity=z,se=v[ne+3],se.pos.x=x.pos.x+-O*k*U-J*k*F,se.pos.y=x.pos.y+-O*k*F+J*k*U,se.uv.x=j.x,se.uv.y=j.y+j.h,se.color.r=I.r,se.color.g=I.g,se.color.b=I.b,se.opacity=z}Ws(v,w,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(m){return Y.add(m)},inspect(){return`count: ${A}/${e.max}`}}}function Mp(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){Fs(Object.assign(ao(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new Ht(this.pts)},inspect(){return`polygon: ${this.pts.map(s=>`[${s.x},${s.y}]`).join(",")}`}}}function Vl(e,t,s){let o;return y.game.root.get("area").forEach(n=>{if(s&&s.some(a=>n.is(a)))return;let r=n.worldArea().raycast(e,t);r&&(o?r.fraction<o.fraction&&(o=r,o.object=n):(o=r,o.object=n))}),o}function Wl(e,t,s={}){return{id:"rect",width:e,height:t,radius:s.radius||0,draw(){jt(Object.assign(ao(this),{width:this.width,height:this.height,radius:this.radius,fill:s.fill}))},renderArea(){return new Qe(X(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Dp(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function Rp(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let s=y.game.root.add([ti(t.pos??X(0))]),o=e.length,n=0,r=null,a=null,c=null,l=null,d=m=>m.x+m.y*n,i=m=>X(Math.floor(m%n),Math.floor(m/n)),p=()=>{r=[];for(let m of s.children)h(m)},h=m=>{let x=d(m.tilePos);r[x]?r[x].push(m):r[x]=[m]},f=m=>{let x=d(m.tilePos);if(r[x]){let E=r[x].indexOf(m);E>=0&&r[x].splice(E,1)}},g=()=>{let m=!1;for(let x of s.children){let E=s.pos2Tile(x.pos);(x.tilePos.x!=E.x||x.tilePos.y!=E.y)&&(m=!0,f(x),x.tilePos.x=E.x,x.tilePos.y=E.y,h(x))}m&&s.trigger("spatialMapChanged")},u=()=>{let m=s.getSpatialMap(),x=s.numRows()*s.numColumns();a?a.length=x:a=new Array(x),a.fill(1,0,x);for(let E=0;E<m.length;E++){let S=m[E];if(S){let I=0;for(let T of S)if(T.isObstacle){I=1/0;break}else I+=T.cost;a[E]=I||1}}},w=()=>{let m=s.getSpatialMap(),x=s.numRows()*s.numColumns();c?c.length=x:c=new Array(x),c.fill(15,0,x);for(let E=0;E<m.length;E++){let S=m[E];if(S){let I=S.length,T=15;for(let z=0;z<I;z++)T|=S[z].edgeMask;c[E]=T}}},v=()=>{let m=s.numRows()*s.numColumns(),x=(S,I)=>{let T=[];for(T.push(S);T.length>0;){let z=T.pop();Y(z).forEach(_=>{l[_]<0&&(l[_]=I,T.push(_))})}};l?l.length=m:l=new Array(m),l.fill(-1,0,m);let E=0;for(let S=0;S<a.length;S++){if(l[S]>=0){E++;continue}x(S,E),E++}},A=(m,x)=>a[x],D=(m,x)=>{let E=i(m),S=i(x);return E.dist(S)},Y=(m,x)=>{let E=[],S=Math.floor(m%n),I=S>0&&c[m]&1&&a[m-1]!==1/0,T=m>=n&&c[m]&2&&a[m-n]!==1/0,z=S<n-1&&c[m]&4&&a[m+1]!==1/0,_=m<n*o-n-1&&c[m]&8&&a[m+n]!==1/0;return x?(I&&(T&&E.push(m-n-1),E.push(m-1),_&&E.push(m+n-1)),T&&E.push(m-n),z&&(T&&E.push(m-n+1),E.push(m+1),_&&E.push(m+n+1)),_&&E.push(m+n)):(I&&E.push(m-1),T&&E.push(m-n),z&&E.push(m+1),_&&E.push(m+n)),E},P={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(m,...x){let E=X(...x),S=(()=>{if(typeof m=="string"){if(t.tiles[m]){if(typeof t.tiles[m]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[m](E)}else if(t.wildcardTile)return t.wildcardTile(m,E)}else{if(Array.isArray(m))return m;throw new Error("Expected a symbol or a component list")}})();if(!S)return null;let I=!1,T=!1;for(let _ of S)_.id==="tile"&&(T=!0),_.id==="pos"&&(I=!0);I||S.push(ti(this.tile2Pos(E))),T||S.push(hc());let z=s.add(S);return I&&(z.tilePosOffset=z.pos.clone()),z.tilePos=E,z.transform=nn(z),r&&(h(z),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),z},numColumns(){return n},numRows(){return o},levelWidth(){return n*this.tileWidth()},levelHeight(){return o*this.tileHeight()},tile2Pos(...m){return X(...m).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...m){let x=X(...m);return X(Math.floor(x.x/this.tileWidth()),Math.floor(x.y/this.tileHeight()))},getSpatialMap(){return r||p(),r},removeFromSpatialMap:f,insertIntoSpatialMap:h,onSpatialMapChanged(m){return this.on("spatialMapChanged",m)},onNavigationMapInvalid(m){return this.on("navigationMapInvalid",m)},getAt(m){r||p();let x=d(m);return r[x]||[]},raycast(m,x){let E=this.toWorld(m),S=this.toWorld(m.add(x)).sub(E),I=1/this.tileWidth(),T=m.scale(I),z=lh(T,x,_=>{let j=this.getAt(_);if(j.some(k=>k.isObstacle))return!0;let q=null;for(let k of j)if(k.has("area")){let U=k.worldArea().raycast(E,S);U&&(q?U.fraction<q.fraction&&(q=U,q.object=k):(q=U,q.object=k))}return q&&(q.point=this.fromWorld(q.point).scale(I)),q||!1},64);return z&&(z.point=z.point.scale(this.tileWidth())),z},update(){r&&g()},invalidateNavigationMap(){a=null,c=null,l=null},onNavigationMapChanged(m){return this.on("navigationMapChanged",m)},getTilePath(m,x,E={}){if(a||u(),c||w(),l||v(),m.x<0||m.x>=n||m.y<0||m.y>=o||x.x<0||x.x>=n||x.y<0||x.y>=o)return null;let S=d(m),I=d(x);if(a[I]===1/0)return null;if(S===I)return[];if(l[S]!=-1&&l[S]!==l[I])return null;let T=new El((U,F)=>U.cost<F.cost);T.insert({cost:0,node:S});let z=new Map;z.set(S,S);let _=new Map;for(_.set(S,0);T.length!==0;){let U=T.remove()?.node;if(U===I)break;let F=Y(U,E.allowDiagonals);for(let O of F){let J=(_.get(U)||0)+A(U,O)+D(O,I);(!_.has(O)||J<_.get(O))&&(_.set(O,J),T.insert({cost:J,node:O}),z.set(O,U))}}let j=[],q=I,k=i(q);for(j.push(k);q!==S;){let U=z.get(q);if(U===void 0)throw new Error("Bug in pathfinding algorithm");q=U;let F=i(q);j.push(F)}return j.reverse()},getPath(m,x,E={}){let S=this.tileWidth(),I=this.tileHeight(),T=this.getTilePath(this.pos2Tile(m),this.pos2Tile(x),E);return T?[m,...T.slice(1,-1).map(z=>z.scale(S,I).add(S/2,I/2)),x]:null}};return s.use(P),s.onNavigationMapInvalid(()=>{s.invalidateNavigationMap(),s.trigger("navigationMapChanged")}),e.forEach((m,x)=>{let E=m.split("");n=Math.max(E.length,n),E.forEach((S,I)=>{s.spawn(S,X(I,x))})}),s}function Xt(e,t,s){return y.game.objEvents.registers[e]||(y.game.objEvents.registers[e]=new Al),y.game.objEvents.on(e,(o,...n)=>{o.is(t)&&s(o,...n)})}var Cp=(e,t,...s)=>{for(let o of y.game.root.children)o.is(t)&&o.trigger(e,s)},Tp=et(e=>{let t=y.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(s){t.paused=s},cancel:()=>t.destroy()}},(e,t)=>Xt("fixedUpdate",e,t)),jl=et(e=>{let t=y.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(s){t.paused=s},cancel:()=>t.destroy()}},(e,t)=>Xt("update",e,t)),Pp=et(e=>{let t=y.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(s){t.hidden=s},cancel:()=>t.destroy()}},(e,t)=>Xt("draw",e,t)),$l=et(e=>y.game.events.on("add",e),(e,t)=>Xt("add",e,t)),Ip=et(e=>y.game.events.on("destroy",e),(e,t)=>Xt("destroy",e,t)),Bp=et(e=>y.game.events.on("use",e),(e,t)=>Xt("use",e,t)),Op=et(e=>y.game.events.on("unuse",e),(e,t)=>Xt("unuse",e,t)),Jl=et(e=>y.game.events.on("tag",e),(e,t)=>Xt("tag",e,t)),Lp=et(e=>y.game.events.on("untag",e),(e,t)=>Xt("untag",e,t));function Hp(e,t,s){return Xt("collide",e,(o,n,r)=>n.is(t)&&s(o,n,r))}function zp(e,t,s){return Xt("collideUpdate",e,(o,n,r)=>n.is(t)&&s(o,n,r))}function Up(e,t,s){return Xt("collideEnd",e,(o,n,r)=>n.is(t)&&s(o,n,r))}function wi(e,t){y.game.root.get(e,{recursive:!0}).forEach(t),$l(e,t),Jl((s,o)=>{o===e&&t(s)})}var Np=et(e=>y.app.onMousePress(e),(e,t)=>{let s=[];return wi(e,o=>{if(!o.area)throw new Error("onClick() requires the object to have area() component");s.push(o.onClick(()=>t(o)))}),ho.join(s)});function _p(e,t){let s=[];return wi(e,o=>{if(!o.area)throw new Error("onHover() requires the object to have area() component");s.push(o.onHover(()=>t(o)))}),ho.join(s)}function Fp(e,t){let s=[];return wi(e,o=>{if(!o.area)throw new Error("onHoverUpdate() requires the object to have area() component");s.push(o.onHoverUpdate(()=>t(o)))}),ho.join(s)}function qp(e,t){let s=[];return wi(e,o=>{if(!o.area)throw new Error("onHoverEnd() requires the object to have area() component");s.push(o.onHoverEnd(()=>t(o)))}),ho.join(s)}function Yp(e){y.game.events.on("loading",e)}function Xp(e){y.app.onResize(e)}function Gp(e){y.game.events.on("error",e)}function Gr(e){y.assets.loaded?e():y.game.events.on("load",e)}function Kp(e){if(y.assets.loaded)Pl().forEach(t=>e(...t));else return y.game.events.on("loadError",e)}function Ql(...e){y.game.cam.pos=X(...e)}function Zl(){return y.game.cam.pos?y.game.cam.pos.clone():Zn()}function kl(...e){y.game.cam.scale=X(...e)}function ec(){return y.game.cam.scale.clone()}function tc(e){y.game.cam.angle=e}function sc(){return y.game.cam.angle}function Vp(){return y.game.cam.transform.clone()}function oc(e=Fe(255,255,255),t=1){let s=y.game.root.add([Wl(Mt(),Tt()),Gl(e),Kl(1),fc()]),o=s.fadeOut(t);return o.onEnd(()=>dc(s)),o}function Wp(){return y.game.cam.transform.clone()}function jp(e=12){y.game.cam.shake+=e}function ar(e){return y.game.cam.transform.multVec2(e)}function nc(e){return y.game.cam.transform.invert().multVec2(e)}function $p(...e){return To("camPos","setCamPos / getCamPos"),e.length>0&&Ql(...e),Zl()}function Jp(...e){return To("camScale","setCamScale / getCamScale"),e.length>0&&kl(...e),ec()}function Qp(e){return To("camRot","setCamRot / getCamRot"),e!==void 0&&tc(e),sc()}function Zp(e=Fe(255,255,255),t=1){return To("camFlash","flash"),oc(e,t)}function Kr(e=[]){let t=new Map,s=[],o={},n=new un,r=[],a=new Set("*"),c=y.globalOpt.tagsAsComponents,l=null,d=!1,i={id:cu(),hidden:!1,transform:new xs,children:[],parent:null,set paused(h){if(h!==d){d=h;for(let f of r)f.paused=h}},get paused(){return d},get tags(){return Array.from(a)},add(h){let f=Array.isArray(h)?Kr(h):h;if(f.parent)throw new Error("Cannot add a game obj that already has a parent.");return f.parent=this,f.transform=nn(f),this.children.push(f),f.trigger("add",f),y.game.events.trigger("add",f),f},readd(h){let f=this.children.indexOf(h);return f!==-1&&(this.children.splice(f,1),this.children.push(h)),h},remove(h){let f=this.children.indexOf(h);if(f!==-1){h.parent=null,this.children.splice(f,1);let g=u=>{u.trigger("destroy"),y.game.events.trigger("destroy",u),u.children.forEach(w=>g(w))};g(h)}},removeAll(h){if(h)this.get(h).forEach(f=>this.remove(f));else for(let f of[...this.children])this.remove(f)},fixedUpdate(){this.paused||(this.children.forEach(h=>h.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(h=>h.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Wt(),this.canvas.bind());let h=y.gfx.fixed;this.fixed&&(y.gfx.fixed=!0),Vt(),lt(this.pos),fn(this.scale),Do(this.angle);let f=this.children.sort((g,u)=>{let w=g.layerIndex??y.game.defaultLayerIndex,v=u.layerIndex??y.game.defaultLayerIndex;return w-v||(g.z??0)-(u.z??0)});if(this.mask){let g={intersect:y.k.drawMasked,subtract:y.k.drawSubtracted}[this.mask];if(!g)throw new Error(`Invalid mask func: "${this.mask}"`);g(()=>{f.forEach(u=>u.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),f.forEach(g=>g.draw());_t(),y.gfx.fixed=h,this.canvas&&(Wt(),this.canvas.unbind())},drawInspect(){this.hidden||(Vt(),lt(this.pos),fn(this.scale),Do(this.angle),this.children.forEach(h=>h.drawInspect()),this.trigger("drawInspect"),_t())},use(h){if(typeof h=="string")return a.add(h);if(!h||typeof h!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof h}"`);let f=[];h.id?(this.unuse(h.id),o[h.id]=[],f=o[h.id],t.set(h.id,h),c&&a.add(h.id)):s.push(h);for(let u in h){if(_h.has(u))continue;let w=Object.getOwnPropertyDescriptor(h,u);if(w)if(typeof w.value=="function"&&(h[u]=h[u].bind(this)),w.set&&Object.defineProperty(h,u,{set:w.set.bind(this)}),w.get&&Object.defineProperty(h,u,{get:w.get.bind(this)}),Fh.has(u)){let v=u==="add"?()=>{l=A=>f.push(A),h[u]?.(),l=null}:h[u];f.push(this.on(u,v).cancel)}else if(this[u]===void 0)Object.defineProperty(this,u,{get:()=>h[u],set:v=>h[u]=v,configurable:!0,enumerable:!0}),f.push(()=>delete this[u]);else{let v=t.values().find(A=>A[u]!==void 0)?.id;throw new Error(`Duplicate component property: "${u}" while adding component "${h.id}"`+(v?` (originally added by "${v}")`:""))}}let g=()=>{if(h.require){for(let u of h.require)if(!this.c(u))throw new Error(`Component "${h.id}" requires component "${u}"`)}};h.destroy&&f.push(h.destroy.bind(this)),this.exists()?(g(),h.add&&(l=u=>f.push(u),h.add.call(this),l=null),h.id&&(this.trigger("use",h.id),y.game.events.trigger("use",this,h.id))):h.require&&f.push(this.on("add",g).cancel)},unuse(h){if(t.has(h)){for(let f of t.values())if(f.require&&f.require.includes(h))throw new Error(`Can't unuse. Component "${f.id}" requires component "${h}"`);t.delete(h),this.trigger("unuse",h),y.game.events.trigger("unuse",this,h)}else c&&a.has(h)&&a.delete(h);o[h]&&(o[h].forEach(f=>f()),delete o[h])},c(h){return t.get(h)??null},get(h,f={}){let g=(w,v)=>f.only==="comps"?w.has(v):f.only==="tags"?w.is(v):w.is(v)||w.has(v),u=f.recursive?this.children.flatMap(function w(v){return[v,...v.children.flatMap(w)]}):this.children;if(u=u.filter(w=>h?g(w,h):!0),f.liveUpdate){let w=A=>f.recursive?this.isAncestorOf(A):A.parent===this,v=[];v.push(y.k.onAdd(A=>{w(A)&&g(A,h)&&u.push(A)})),v.push(y.k.onDestroy(A=>{if(w(A)&&g(A,h)){let D=u.findIndex(Y=>Y.id===A.id);D!==-1&&u.splice(D,1)}})),this.onDestroy(()=>{for(let A of v)A.cancel()})}return u},query(h){let f=h.hierarchy||"children",g=h.include,u=h.exclude,w=[];switch(f){case"children":w=this.children;break;case"siblings":w=this.parent?this.parent.children.filter(A=>A!==this):[];break;case"ancestors":let v=this.parent;for(;v;)w.push(v),v=v.parent;break;case"descendants":w=this.children.flatMap(function A(D){return[D,...D.children.flatMap(A)]});break}if(g&&((h.includeOp||"and")==="and"||!Array.isArray(h.include)?w=w.filter(v=>v.is(g)):w=w.filter(v=>h.include.some(A=>v.is(A)))),u&&((h.includeOp||"and")==="and"||!Array.isArray(h.include)?w=w.filter(v=>!v.is(u)):w=w.filter(v=>!h.exclude.some(A=>v.is(A)))),h.visible===!0&&(w=w.filter(v=>v.visible)),h.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let v=h.distanceOp||"near",A=h.distance*h.distance;v==="near"?w=w.filter(D=>D.pos&&this.pos.sdist(D.pos)<=A):w=w.filter(D=>D.pos&&this.pos.sdist(D.pos)>A)}return h.name&&(w=w.filter(v=>v.name===h.name)),w},isAncestorOf(h){return h.parent?h.parent===this||this.isAncestorOf(h.parent):!1},exists(){return y.game.root.isAncestorOf(this)},is(h,f="and"){return Array.isArray(h)?f==="and"?h.every(g=>a.has(g)):h.some(g=>a.has(g)):a.has(h)},tag(h){if(Array.isArray(h))for(let f of h)a.add(f),this.trigger("tag",f),y.game.events.trigger("tag",this,f);else a.add(h),this.trigger("tag",h),y.game.events.trigger("tag",this,h)},untag(h){if(Array.isArray(h))for(let f of h)a.delete(f),this.trigger("untag",f),y.game.events.trigger("untag",this,f);else a.delete(h),this.trigger("untag",h),y.game.events.trigger("untag",this,h)},has(h,f="and"){return Array.isArray(h)?f==="and"?h.every(g=>t.has(g)):h.some(g=>t.has(g)):t.has(h)},on(h,f){let g=n.on(h,f.bind(this));return l&&l(()=>g.cancel()),g},trigger(h,...f){n.trigger(h,...f),y.game.objEvents.trigger(h,this,...f)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let h={};for(let[f,g]of t)h[f]=g.inspect?.()??null;for(let[f,g]of s.entries()){if(g.inspect){h[f]=g.inspect();continue}for(let[u,w]of Object.entries(g))typeof w!="function"&&(h[u]=`${u}: ${w}`)}return h},onAdd(h){return this.on("add",h)},onFixedUpdate(h){return this.on("fixedUpdate",h)},onUpdate(h){return this.on("update",h)},onDraw(h){return this.on("draw",h)},onDestroy(h){return this.on("destroy",h)},onUse(h){return this.on("use",h)},onUnuse(h){return this.on("unuse",h)},clearEvents(){n.clear()}},p=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let h of p)i[h]=(...f)=>{let g=y.app[h]?.(...f);return r.push(g),i.onDestroy(()=>g.cancel()),i.on("sceneEnter",()=>{r.splice(r.indexOf(g),1);let u=y.app[h]?.(...f);ho.replace(g,u),r.push(g)}),g};for(let h of e)i.use(h);return i}var kp=()=>({events:new un,objEvents:new un,root:Kr([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new Q(1),angle:0,shake:0,transform:new xs}});function ef(e){y.game.gravity=e?(y.game.gravity||X(0,1)).unit().scale(e):null}function tf(){return y.game.gravity?y.game.gravity.len():0}function sf(e){y.game.gravity=e.unit().scale(y.game.gravity?y.game.gravity.len():1)}function an(){return y.game.gravity?y.game.gravity.unit():X(0,1)}var of=_d("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),nf=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let s=new gn(Cu(e));return e.decodeAudioData(of.buffer.slice(0)).then(o=>{s.buf=o}).catch(o=>{console.error("Failed to load burp: ",o)}),{ctx:e,masterNode:t,burpSnd:s}})();function rf(e,t={}){let s=new Lt,o=new Audio(e);o.crossOrigin="anonymous",o.loop=!!t.loop,y.audio.ctx.createMediaElementSource(o).connect(y.audio.masterNode);function n(){y.debug.paused||y.app.isHidden()&&!y.globalOpt.backgroundAudio||y.audio.ctx.resume()}function r(){n(),o.play()}return t.paused||r(),o.onended=()=>s.trigger(),{play(){r()},seek(a){o.currentTime=a},stop(){o.pause(),this.seek(0)},set loop(a){o.loop=a},get loop(){return o.loop},set paused(a){a?o.pause():r()},get paused(){return o.paused},time(){return o.currentTime},duration(){return o.duration},set volume(a){o.volume=ms(a,0,1)},get volume(){return o.volume},set speed(a){o.playbackRate=Math.max(a,0)},get speed(){return o.playbackRate},set detune(a){},get detune(){return 0},onEnd(a){return s.add(a)},then(a){return this.onEnd(a)}}}function af(e,t={}){if(typeof e=="string"&&y.assets.music[e])return rf(y.assets.music[e],t);let s=y.audio.ctx,o=t.paused??!1,n=s.createBufferSource(),r=new Lt,a=s.createGain(),c=s.createStereoPanner(),l=t.seek??0,d=0,i=0,p=!1;n.loop=!!t.loop,n.detune.value=t.detune??0,n.playbackRate.value=t.speed??1,n.connect(c),n.onended=()=>{g()>=(n.buffer?.duration??Number.POSITIVE_INFINITY)&&r.trigger()},c.pan.value=t.pan??0,c.connect(a),a.connect(y.audio.masterNode),a.gain.value=t.volume??1;let h=w=>{n.buffer=w.buf,o||(d=s.currentTime,n.start(0,l),p=!0)},f=sp(e);f instanceof Qt&&f.onLoad(h);let g=()=>{if(!n.buffer)return 0;let w=o?i-d:s.currentTime-d,v=n.buffer.duration;return n.loop?w%v:Math.min(w,v)},u=w=>{let v=s.createBufferSource();return v.buffer=w.buffer,v.loop=w.loop,v.playbackRate.value=w.playbackRate.value,v.detune.value=w.detune.value,v.onended=w.onended,v.connect(c),v};return{stop(){this.paused=!0,this.seek(0)},set paused(w){if(o!==w)if(o=w,w)p&&(n.stop(),p=!1),i=s.currentTime;else{n=u(n);let v=i-d;n.start(0,v),p=!0,d=s.currentTime-v,i=0}},get paused(){return o},play(w=0){this.seek(w),this.paused=!1},seek(w){n.buffer?.duration&&(w>n.buffer.duration||(o?(n=u(n),d=i-w):(n.stop(),n=u(n),d=s.currentTime-w,n.start(0,w),p=!0,i=0)))},set speed(w){n.playbackRate.value=w},get speed(){return n.playbackRate.value},set detune(w){n.detune.value=w},get detune(){return n.detune.value},set volume(w){a.gain.value=Math.max(w,0)},get volume(){return a.gain.value},set pan(w){c.pan.value=w},get pan(){return c.pan.value},set loop(w){n.loop=w},get loop(){return n.loop},duration(){return n.buffer?.duration??0},time(){return g()%this.duration()},onEnd(w){return r.add(w)},then(w){return this.onEnd(w)}}}function ic(e){return y.k.play(y.audio.burpSnd,e)}function rc(e){y.audio.masterNode.gain.value=e}function ac(){return y.audio.masterNode.gain.value}function lf(e){return To("volume","setVolume / getVolume"),e!==void 0&&rc(e),ac()}function lc(){y.app.onHide(()=>{y.globalOpt.backgroundAudio||y.audio.ctx.suspend()}),y.app.onShow(()=>{!y.globalOpt.backgroundAudio&&!y.debug.paused&&y.audio.ctx.resume()}),y.app.onResize(()=>{if(y.app.isFullscreen())return;let e=y.globalOpt.width&&y.globalOpt.height;e&&!y.globalOpt.stretch&&!y.globalOpt.letterbox||(y.canvas.width=y.canvas.offsetWidth*y.pixelDensity,y.canvas.height=y.canvas.offsetHeight*y.pixelDensity,Rl(),e||(y.gfx.frameBuffer.free(),y.gfx.frameBuffer=new kn(y.gfx.ggl,y.gfx.ggl.gl.drawingBufferWidth,y.gfx.ggl.gl.drawingBufferHeight),y.gfx.width=y.gfx.ggl.gl.drawingBufferWidth/y.pixelDensity/y.gscale,y.gfx.height=y.gfx.ggl.gl.drawingBufferHeight/y.pixelDensity/y.gscale))}),y.globalOpt.debug!==!1&&(y.app.onKeyPress(y.globalOpt.debugKey??"f1",()=>y.debug.inspect=!y.debug.inspect),y.app.onKeyPress("f2",()=>y.debug.clearLog()),y.app.onKeyPress("f8",()=>y.debug.paused=!y.debug.paused),y.app.onKeyPress("f7",()=>{y.debug.timeScale=tr(ms(y.debug.timeScale-.2,0,2),1)}),y.app.onKeyPress("f9",()=>{y.debug.timeScale=tr(ms(y.debug.timeScale+.2,0,2),1)}),y.app.onKeyPress("f10",()=>y.debug.stepFrame())),y.globalOpt.burp&&y.app.onKeyPress("b",()=>ic())}function cf(e,t={}){let s=y.game.root.add([ti(e),pc()]),o=(t.speed||1)*5,n=t.scale||1;s.add([lr(y.boomSprite),si(0),hr("center"),Ca(o,n),...t.comps??[]]);let r=s.add([lr(y.kaSprite),si(0),hr("center"),cr(),...t.comps??[]]);return r.wait(.4/o,()=>r.use(Ca(o,n))),r.onDestroy(()=>s.destroy()),s}function cc(e,t){if(y.game.layers)throw Error("Layers can only be assigned once.");let s=e.indexOf(t);if(s==-1)throw Error("The default layer name should be present in the layers list.");y.game.layers=e,y.game.defaultLayerIndex=s}function df(){return y.game.layers}function hf(){return y.game.layers?.[y.game.defaultLayerIndex]??null}function uf(e,t){To("layers","setLayers"),cc(e,t)}function dc(e){e.destroy()}function pf(){return y.game.root}function ff(e,t){y.game.scenes[e]=t}function gf(e,...t){if(!y.game.scenes[e])throw new Error(`Scene not found: ${e}`);y.game.events.onOnce("frameEnd",()=>{y.game.events.trigger("sceneLeave",e),y.app.events.clear(),y.game.events.clear(),y.game.objEvents.clear(),[...y.game.root.children].forEach(s=>{!s.stay||s.scenesToStay&&!s.scenesToStay.includes(e)?y.game.root.remove(s):s.trigger("sceneEnter",e)}),y.game.root.clearEvents(),lc(),y.game.cam={pos:null,scale:X(1),angle:0,shake:0,transform:new xs},y.game.scenes[e](...t)}),y.game.currentScene=e}function mf(e){return y.game.events.on("sceneLeave",e)}function xf(){return y.game.currentScene}function lr(e,t={}){let s=null,o=null,n=null,r=new Lt;if(!e)throw new Error("Please pass the resource name or data to sprite()");let a=(d,i,p,h)=>{let f=X(1,1);return p&&h?(f.x=p/(d.width*i.w),f.y=h/(d.height*i.h)):p?(f.x=p/(d.width*i.w),f.y=f.x):h&&(f.y=h/(d.height*i.h),f.x=f.y),f},c=(d,i)=>{if(!i)return;let p=i.frames[0].clone();t.quad&&(p=p.scale(t.quad));let h=a(i.tex,p,t.width,t.height);if(d.width=i.tex.width*p.w*h.x,d.height=i.tex.height*p.h*h.y,i.anims)for(let f in i.anims){let g=i.anims[f];typeof g!="number"&&(g.frames=l(g))}s=i,r.trigger(s),t.anim&&d.play(t.anim)},l=d=>{if(d.frames)return d.frames;let i=[];if(d.from===void 0||d.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let p=Math.abs(d.to-d.from)+1;for(let h=0;h<p;h++)i.push(d.from+h*Math.sign(d.to-d.from));if(d.pingpong)for(let h=p-2;h>0;h--)i.push(i[h]);return i};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new it(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(d){let i=qn(d);i&&i.onLoad(p=>c(this,p))},get animFrame(){if(!s||!o||n===null)return this.frame;let d=s.anims[o.name];return typeof d=="number"?d:d.from===void 0||d.to===void 0?o.frameIndex:this.frame-Math.min(d.from,d.to)},draw(){if(!s)return;let d=s.frames[this.frame??0];if(!d)throw new Error(`Frame not found: ${this.frame??0}`);if(s.slice9){let{left:i,right:p,top:h,bottom:f}=s.slice9,g=s.tex.width*d.w,u=s.tex.height*d.h,w=this.width-i-p,v=this.height-h-f,A=i/g,D=p/g,Y=1-A-D,P=h/u,m=f/u,x=1-P-m,E=[pt(0,0,A,P),pt(A,0,Y,P),pt(A+Y,0,D,P),pt(0,P,A,x),pt(A,P,Y,x),pt(A+Y,P,D,x),pt(0,P+x,A,m),pt(A,P+x,Y,m),pt(A+Y,P+x,D,m),pt(0,0,i,h),pt(i,0,w,h),pt(i+w,0,p,h),pt(0,h,i,v),pt(i,h,w,v),pt(i+w,h,p,v),pt(0,h+v,i,f),pt(i,h+v,w,f),pt(i+w,h+v,p,f)];for(let S=0;S<9;S++){let I=E[S],T=E[S+9];ei(Object.assign(ao(this),{pos:T.pos(),tex:s.tex,quad:d.scale(I),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:T.w,height:T.h}))}}else ei(Object.assign(ao(this),{tex:s.tex,quad:d.scale(this.quad??new it(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let d=qn(e);d?d.onLoad(i=>c(this,i)):Gr(()=>c(this,qn(e).data))},update(){if(!s||!o||n===null)return;let d=s.anims[o.name];if(typeof d=="number"){this.frame=d;return}if(d.speed===0)throw new Error("Sprite anim speed cannot be 0");if(o.timer+=At()*this.animSpeed,o.timer>=1/o.speed){o.timer=0,o.frameIndex+=n;let i=d.frames;if(o.frameIndex>=i.length)if(o.pingpong&&!d.pingpong)n=-1,o.frameIndex=i.length-2;else if(o.loop)o.frameIndex=0;else{this.frame=i.at(-1),o.onEnd(),this.stop();return}else if(o.frameIndex<0)if(o.pingpong&&o.loop)n=1,o.frameIndex=1;else if(o.loop)o.frameIndex=i.length-1;else{this.frame=i[0],o.onEnd(),this.stop();return}this.frame=i[o.frameIndex]}},play(d,i={}){if(!s){r.add(()=>this.play(d,i));return}let p=s.anims[d];if(p===void 0)throw new Error(`Anim not found: ${d}`);o&&this.stop(),o=typeof p=="number"?{name:d,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:d,timer:0,loop:i.loop??p.loop??!1,pingpong:i.pingpong??p.pingpong??!1,speed:i.speed??p.speed??10,frameIndex:0,onEnd:i.onEnd??(()=>{})},n=typeof p=="number"?null:1,this.frame=typeof p=="number"?p:p.frames[0],this.trigger("animStart",d)},stop(){if(!o)return;let d=o.name;o=null,this.trigger("animEnd",d)},numFrames(){return s?.frames.length??0},getCurAnim(){return o},curAnim(){return o?.name},getAnim(d){return s?.anims[d]??null},hasAnim(d){return!!this.getAnim(d)},onAnimEnd(d){return this.on("animEnd",d)},onAnimStart(d){return this.on("animStart",d)},renderArea(){return new Qe(X(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function yf(e,t={}){function s(n){let r=io(Object.assign(ao(n),{text:n.text+"",size:n.textSize,font:n.font,width:t.width&&n.width,align:n.align,letterSpacing:n.letterSpacing,lineSpacing:n.lineSpacing,transform:n.textTransform,styles:n.textStyles,indentAll:t.indentAll}));return t.width||(n.width=r.width/(n.scale?.x||1)),n.height=r.height/(n.scale?.y||1),r}let o={id:"text",set text(n){e=n,s(this),this.renderedText=ir(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?ir(e).text:"",add(){Gr(()=>s(this))},draw(){ro(s(this))},renderArea(){return new Qe(X(0),this.width,this.height)}};return s(o),o}function wf(e,t){return{id:"rect",width:e,height:t,draw(){mn(Object.assign(ao(this),{width:this.width,height:this.height}))},renderArea(){return new Qe(X(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function bf(e={}){let t=null,s=null,o=null,n=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return s&&o?s[o]:null},getPath(){return s?s.slice():null},getTarget(){return t},isNavigationFinished(){return s?o===null:!0},isTargetReachable(){return s!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(r){t=r,s=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o=s?0:null,s&&o!==null?(n||(n=this.getLevel().onNavigationMapChanged(()=>{t&&s&&o!==null&&(s=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s?(o=0,this.trigger("navigationNext",this,s[o])):(o=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>n?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,s[o])):this.trigger("navigationEnded",this)},update(){if(t&&s&&o!==null){if(this.pos.sdist(s[o])<2)if(o===s.length-1){this.pos=t.clone(),o=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else o++,this.trigger("navigationNext",this,s[o]);this.moveTo(s[o],this.agentSpeed)}},onNavigationStarted(r){return this.on("navigationStarted",r)},onNavigationNext(r){return this.on("navigationNext",r)},onNavigationEnded(r){return this.on("navigationEnded",r)},onTargetReached(r){return this.on("targetReached",r)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(s)})}}}function vf(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(s){return this.graph?.getWaypointPath(this.pos,s,e.navigationOpt)},get graph(){if(t)return t;let s=this.parent;for(;s;){if(s.has("pathfinderMap"))return s.graph;s=s.parent}},set graph(s){t=s}}}function Af(e={}){let t=e.waypoints,s=e.speed||100,o=e.endBehavior||"stop",n=0,r=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return s},set patrolSpeed(a){s=a},get waypoints(){return t},set waypoints(a){t=a,n=0,r=!1},get nextLocation(){return t?t[n]:void 0},update(){let a=this.nextLocation;if(!(!t||!a||r)&&(this.moveTo(a,s),this.pos.sdist(a)<9))switch(o){case"loop":n=(n+1)%t.length;break;case"ping-pong":n=n+1,n==t.length&&(t.reverse(),n=0);break;case"stop":n<t.length-1?n+=1:r||(r=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(a){return this.on("patrolFinished",a)}}}function Sf(e,t={}){let s=typeof e=="function"?e:()=>y.game.root.query(e),o=t.checkFrequency||1,n=typeof t.direction=="number"?Q.fromAngle(t.direction):t.direction,r=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?Q.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(a){this.direction=a!==void 0?Q.fromAngle(a):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(a,c,l){let d=(typeof c=="number"?Q.fromAngle(c):c)||n,i=l||t.fieldOfView;if(!d||!i||i>=360)return!0;let p=i/2;return a.pos&&d.angleBetween(a.pos.sub(this.pos))<=p},hasLineOfSight(a){let c=Vl(this.pos,a.pos.sub(this.pos),t.raycastExclude);return c!=null&&c.object===a},update(){if(r+=At(),r>o){r-=o;let a=s();if(a.length&&n&&this.fieldOfView&&this.fieldOfView<360){let c=this.fieldOfView/2;a=a.filter(l=>l.pos&&n.angleBetween(l.pos.sub(this.pos))<=c)}a.length&&t.lineOfSight&&(a=a.filter(c=>c.pos&&this.hasLineOfSight(c))),a.length>0&&(this.spotted=a,this.trigger("objectSpotted",a))}},onObjectsSpotted(a){return this.on("objectSpotted",a)}}}function hc(e={}){let t=X(0),s=e.isObstacle??!1,o=e.cost??0,n=e.edges??[],r=()=>{let c={left:1,top:2,right:4,bottom:8};return n.map(l=>c[l]||0).reduce((l,d)=>l|d,0)},a=r();return{id:"tile",tilePosOffset:e.offset??X(0),set tilePos(c){let l=this.getLevel();t=c.clone(),this.pos=X(this.tilePos.x*l.tileWidth(),this.tilePos.y*l.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(c){s!==c&&(s=c,this.getLevel().invalidateNavigationMap())},get isObstacle(){return s},set cost(c){o!==c&&(o=c,this.getLevel().invalidateNavigationMap())},get cost(){return o},set edges(c){n=c,a=r(),this.getLevel().invalidateNavigationMap()},get edges(){return n},get edgeMask(){return a},getLevel(){return this.parent},tileMove(c){let l=this.getLevel();l.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(c),l.insertIntoSpatialMap(this),l.trigger("spatialMapChanged")},moveLeft(){this.tileMove(X(-1,0))},moveRight(){this.tileMove(X(1,0))},moveUp(){this.tileMove(X(0,-1))},moveDown(){this.tileMove(X(0,1))}}}var Vr=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,s){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||pn.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=s}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,s){let o=t-1,n=e/this.duration;if(this.loops!==0&&n>=this.loops)return[o,0,!0];let r=Math.trunc(n);if(n-=r,(this.direction=="reverse"||this.direction=="ping-pong"&&r&1)&&(n=1-n),s){let a=0;for(;s[a+1]!==void 0&&s[a+1]<n;)a++;return a>=o?[o,0,!0]:[a,(n-s[a])/(s[a+1]-s[a]),!1]}else{let a=Math.floor((t-1)*n);return[a,(n-a/o)*o,!1]}}setValue(e,t,s){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(s);break;case"angle":e.angle=e.base.angle+s;break;case"scale":e.scale=e.base.scale.scale(s);break;case"opacity":e.opacity=e.base.opacity*s;break;default:e[t]=s}else e[t]=s}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=pn.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Ra(e,t){return t.add(t.sub(e))}var Ef=class extends Vr{keys;constructor(e,t,s,o){super(e,s,o),this.keys=t}update(e,t){let[s,o,n]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(o==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[s]);else{let r=this.easings?this.easings[s]:this.easing;this.setValue(e,this.name,Ft(this.keys[s],this.keys[s+1],r(o)))}return n}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},Mf=class extends Vr{keys;curves;dcurves;constructor(e,t,s,o,n){if(super(e,s,o),this.keys=t,this.interpolation==="spline"){this.curves=[],n&&(this.dcurves=[]);for(let r=0;r<this.keys.length-1;r++){let a=this.keys[r],c=r+1,l=this.keys[c],d=r>0?this.keys[r-1]:Ra(l,a),i=c<this.keys.length-1?this.keys[c+1]:Ra(a,l);this.curves.push(Jn(d,a,l,i)),n&&this.dcurves?.push(Jn(d,a,l,i,vh))}}}update(e,t){let[s,o,n]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(o==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[s]);else{let r=this.easings?this.easings[s]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[s].lerp(this.keys[s+1],r(o)));break;case"slerp":this.setValue(e,this.name,this.keys[s].slerp(this.keys[s+1],r(o)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[s](r(o))),this.dcurves&&this.setValue(e,"angle",this.dcurves[s](r(o)).angle());break}}}return n}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},Df=class extends Vr{keys;constructor(e,t,s,o){super(e,s,o),this.keys=t}update(e,t){let[s,o,n]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(o==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[s]);else{let r=this.easings?this.easings[s]:this.easing;this.setValue(e,this.name,this.keys[s].lerp(this.keys[s+1],r(o)))}return n}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function Rf(e={}){let t=[],s=0,o=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:X(0,0),angle:0,scale:X(1,1),opacity:1},animation:{paused:!1,seek(n){s=ms(n,0,this.duration),t.forEach(r=>{r.isFinished=!1}),o=!1},get duration(){return t.reduce((n,r)=>Math.max(r.duration,n),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let n=!0,r;s+=At();for(let a of t)r=a.update(this,s),r&&!a.isFinished&&(a.isFinished=!0,this.trigger("animateChannelFinished",a.name)),n&&=r;n&&!o&&(o=!0,this.trigger("animateFinished"))},animate(n,r,a){o=!1,this.unanimate(n),typeof r[0]=="number"?t.push(new Ef(n,r,a,e.relative||!1)):r[0]instanceof Q?t.push(new Mf(n,r,a,e.relative||!1,n==="pos"&&(e.followMotion||!1))):r[0]instanceof He&&t.push(new Df(n,r,a,e.relative||!1))},unanimate(n){let r=t.findIndex(a=>a.name===n);r>=0&&t.splice(r,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(n){return this.on("animateFinished",n)},onAnimateChannelFinished(n){return this.on("animateChannelFinished",n)},serializeAnimationChannels(){return t.reduce((n,r)=>(n[r.name]=r.serialize(),n),{})},serializeAnimationOptions(){let n={};return e.followMotion&&(n.followMotion=!0),e.relative&&(n.relative=!0),n}}}function uc(e,t){let s={name:e.name};return e.has("animate")&&(s.channels=e.serializeAnimationChannels(),Object.assign(s,e.serializeAnimationOptions())),e.children.length>0&&(s.children=e.children.filter(o=>o.has("named")).map(o=>uc(o,o.name))),s}function Ca(e=2,t=1){let s=0;return{require:["scale"],update(){let o=Math.sin(s*e)*t;o<0&&this.destroy(),this.scale=X(o),s+=At()}}}function Cf(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(s=1){this.setHP(e-s),this.trigger("hurt",s)},heal(s=1){let o=e;this.setHP(e+s),this.trigger("heal",e-o)},hp(){return e},maxHP(){return t??null},setMaxHP(s){t=s},setHP(s){e=t?Math.min(t,s):s,e<=0&&this.trigger("death")},onHurt(s){return this.on("hurt",s)},onHeal(s){return this.on("heal",s)},onDeath(s){return this.on("death",s)},inspect(){return`health: ${e}`}}}function Tf(e,t={}){if(e==null)throw new Error("lifespan() requires time");let s=t.fade??0;return{id:"lifespan",require:["opacity"],add(){y.game.root.wait(e,()=>{this.opacity=this.opacity??1,s>0?y.game.root.tween(this.opacity,0,s,o=>this.opacity=o,pn.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function Pf(e){return{id:"named",name:e}}function If(e,t,s){if(!e)throw new Error("state() requires an initial state");let o={};function n(l){o[l]||(o[l]={enter:new Lt,end:new Lt,update:new Lt,draw:new Lt})}function r(l,d,i){return n(d),o[d][l].add(i)}function a(l,d,...i){n(d),o[d][l].trigger(...i)}let c=!1;return{id:"state",state:e,enterState(l,...d){if(c=!0,t&&!t.includes(l))throw new Error(`State not found: ${l}`);let i=this.state;if(s){if(!s?.[i])return;let p=typeof s[i]=="string"?[s[i]]:s[i];if(!p.includes(l))throw new Error(`Cannot transition state from "${i}" to "${l}". Available transitions: ${p.map(h=>`"${h}"`).join(", ")}`)}a("end",i,...d),this.state=l,a("enter",l,...d),a("enter",`${i} -> ${l}`,...d)},onStateTransition(l,d,i){return r("enter",`${l} -> ${d}`,i)},onStateEnter(l,d){return r("enter",l,d)},onStateUpdate(l,d){return r("update",l,d)},onStateDraw(l,d){return r("draw",l,d)},onStateEnd(l,d){return r("end",l,d)},update(){c||(a("enter",e),c=!0),a("update",this.state)},draw(){a("draw",this.state)},inspect(){return`state: ${this.state}`}}}function pc(e){return{id:"stay",stay:!0,scenesToStay:e}}function Bf(e=!0,t){let s,o;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let n=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};s=y.k.onCharInput(r=>{this.hasFocus&&(!t||this.typedText.length<t)&&(y.k.isKeyDown("shift")?this.typedText+=r.toUpperCase():this.typedText+=r,n())}),o=y.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),n())})},destroy(){s.cancel(),o.cancel()}}}function cr(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,s,o=1/0,n=!1){let r=n?0:t,a=new Lt,c=this.onUpdate(()=>{r+=y.app.state.dt;for(let l=0;r>=t&&l<this.maxLoopsPerFrame;l++)if(o--,s(),r-=t,o<=0){c.cancel(),a.trigger();return}});return{get paused(){return c.paused},set paused(l){c.paused=l},cancel:c.cancel,onEnd(l){a.add(l)},then(l){return a.add(l),this}}},wait(t,s){return this.loop(t,s??(()=>{}),1,!0)},tween(t,s,o,n,r=pn.linear){let a=0,c=[],l=this.onUpdate(()=>{a+=y.app.state.dt;let d=Math.min(a/o,1);n(Ft(t,s,r(d))),d===1&&(l.cancel(),n(s),c.forEach(i=>i()))});return{get paused(){return l.paused},set paused(d){l.paused=d},onEnd(d){c.push(d)},then(d){return this.onEnd(d),this},cancel(){l.cancel()},finish(){l.cancel(),n(s),c.forEach(d=>d())}}}}}var dr=0;function Of(){return dr>0}function Lf(e={}){let t={},s=new Set,o=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){dr++,this.area.cursor&&o.push(this.onHover(()=>y.app.setCursor(this.area.cursor))),o.push(this.onCollideUpdate((n,r)=>{if(!n.id)throw new Error("area() requires the object to have an id");t[n.id]||this.trigger("collide",n,r),r&&(t[n.id]=r,s.add(n.id))}))},destroy(){dr--;for(let n of o)n.cancel()},fixedUpdate(){for(let n in t)s.has(Number(n))||(this.trigger("collideEnd",t[n].target),delete t[n]);s.clear()},drawInspect(){let n=this.localArea();Vt(),lt(this.area.offset);let r={outline:{width:4/Cl(),color:Fe(0,0,255)},anchor:this.anchor,fill:!1,fixed:eo(this)};n instanceof Qe?jt({...r,pos:n.pos,width:n.width*this.area.scale.x,height:n.height*this.area.scale.y}):n instanceof Ht?Fs({...r,pts:n.pts,scale:this.area.scale}):n instanceof qt&&Io({...r,pos:n.center,radius:n.radius}),_t()},area:{shape:e.shape??null,scale:e.scale?X(e.scale):X(1),offset:e.offset??X(0),cursor:e.cursor??null},isClicked(){return y.app.isMousePressed()&&this.isHovering()},isHovering(){let n=eo(this)?y.k.mousePos():y.k.toWorld(y.k.mousePos());return this.hasPoint(n)},checkCollision(n){if(!n.id)throw new Error("checkCollision() requires the object to have an id");return t[n.id]??null},getCollisions(){return Object.values(t)},isColliding(n){if(!n.id)throw new Error("isColliding() requires the object to have an id");return!!t[n.id]},isOverlapping(n){if(!n.id)throw new Error("isOverlapping() requires the object to have an id");let r=t[n.id];return r&&r.hasOverlap()},onClick(n,r="left"){let a=this.onMousePress(r,()=>{this.isHovering()&&n()});return o.push(a),a},onHover(n){let r=!1;return this.onUpdate(()=>{r?r=this.isHovering():this.isHovering()&&(r=!0,n())})},onHoverUpdate(n){return this.onUpdate(()=>{this.isHovering()&&n()})},onHoverEnd(n){let r=!1;return this.onUpdate(()=>{r?this.isHovering()||(r=!1,n()):r=this.isHovering()})},onCollide(n,r){if(typeof n=="function"&&r===void 0)return this.on("collide",n);if(typeof n=="string")return this.onCollide((a,c)=>{a.is(n)&&r?.(a,c)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(n,r){if(typeof n=="function"&&r===void 0)return this.on("collideUpdate",n);if(typeof n=="string")return this.on("collideUpdate",(a,c)=>a.is(n)&&r?.(a,c));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(n,r){if(typeof n=="function"&&r===void 0)return this.on("collideEnd",n);if(typeof n=="string")return this.on("collideEnd",a=>a.is(n)&&r?.(a));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(n){return Xs(this.worldArea(),n)},resolveCollision(n){let r=this.checkCollision(n);r&&!r.resolved&&(this.pos=this.pos.add(r.displacement),r.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let n=this.localArea();if(!(n instanceof Ht||n instanceof Qe))throw new Error("Only support polygon and rect shapes for now");let r=this.transform.clone().translate(this.area.offset).scale(X(this.area.scale??1));if(n instanceof Qe){let a=Po(this.anchor||mi).add(1,1).scale(-.5).scale(n.width,n.height);r.translate(a)}return n.transform(r)},screenArea(){let n=this.worldArea();return eo(this)?n:n.transform(y.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function Hf(e={}){let t=null,s=null,o=!1,n=X(0),r=null,a=null,c;return{id:"body",require:["pos"],vel:X(0),drag:e.drag??0,jumpForce:e.jumpForce??qh,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(r=this.pos.clone(),a=this.pos.clone(),c=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((l,d)=>{if(!d||!l.has("body")||d.resolved)return;this.trigger("beforePhysicsResolve",d);let i=d.reverse();if(l.trigger("beforePhysicsResolve",i),!(d.resolved||i.resolved)&&!(this.isStatic&&l.isStatic)){if(!this.isStatic&&!l.isStatic){let p=this.mass+l.mass;this.pos=this.pos.add(d.displacement.scale(l.mass/p)),l.pos=l.pos.add(d.displacement.scale(-this.mass/p)),this.transform=nn(this),l.transform=nn(l)}else{let p=!this.isStatic&&l.isStatic?d:d.reverse();p.source.pos=p.source.pos.add(p.displacement),p.source.transform=nn(p.source)}d.resolved=!0,this.trigger("physicsResolve",d),l.trigger("physicsResolve",d.reverse())}}),this.onPhysicsResolve(l=>{if(y.game.gravity)if(l.isBottom()&&this.isFalling()){this.vel=this.vel.reject(y.game.gravity.unit());let d=t;t=l.target,d!=t&&(s=l.target.pos),o?o=!1:d||(this.trigger("ground",t),l.target.trigger("land",this))}else l.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(y.game.gravity.unit()),this.trigger("headbutt",l.target),l.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(s&&!t.pos.eq(s)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(s)),s=t.pos);let l=or();l&&(this.pos.x==c.x&&(this.pos.x=Ft(r.x,a.x,l/sr()),c.x=this.pos.x),this.pos.y==c.y&&(this.pos.y=Ft(r.y,a.y,l/sr()),c.y=this.pos.y))},fixedUpdate(){if(r&&(this.pos.x==c.x&&(this.pos.x=r.x),this.pos.y==c.y&&(this.pos.y=r.y),r=null),y.game.gravity&&!this.isStatic){o&&(t=null,s=null,this.trigger("fallOff"),o=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(o=!0);let l=this.vel.clone();this.vel=this.vel.add(y.game.gravity.scale(this.gravityScale*At()));let d=e.maxVelocity??Yh;this.vel.slen()>d*d&&(this.vel=this.vel.unit().scale(d)),l.dot(y.game.gravity)<0&&this.vel.dot(y.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=n.x*At(),this.vel.y+=n.y*At(),this.vel.x*=1-this.drag*At(),this.vel.y*=1-this.drag*At(),this.move(this.vel),or()){r=this.pos.clone();let l=this.vel.add(n.scale(At()));a=this.pos.add(l.scale(At())),c=this.pos.clone()}n.x=0,n.y=0},onPhysicsResolve(l){return this.on("physicsResolve",l)},onBeforePhysicsResolve(l){return this.on("beforePhysicsResolve",l)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(an())>0},isJumping(){return this.vel.dot(an())<0},applyImpulse(l){this.isStatic||(this.vel=this.vel.add(l))},addForce(l){this.isStatic||(n.x+=l.x/this.mass,n.y+=l.y/this.mass)},jump(l){this.isStatic||(t=null,s=null,this.vel=an().scale(-l||-this.jumpForce))},onGround(l){return this.on("ground",l)},onFall(l){return this.on("fall",l)},onFallOff(l){return this.on("fallOff",l)},onHeadbutt(l){return this.on("headbutt",l)},onLand(l){return this.on("land",l)},onHeadbutted(l){return this.on("headbutted",l)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function zf(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(s){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(s))},onDoubleJump(s){return this.on("doubleJump",s)},inspect(){return`jumpsLeft: ${t}`}}}function Uf(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,s)=>{let o=s?.normal.normal(),n=t.vel.project(o),r=o?.scale(this.speed)?.sub(n);t.addForce(r?.scale(t.mass*this.forceScale))})}}}function Nf(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,s)=>{if(!t.has("body"))return;let o=Q.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(o),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function _f(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,s)=>{let o=this.pos.sub(t.pos),n=o.len(),r=n*this.distanceScale/10,a=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/r:1/r**2,c=o.scale(this.forceMagnitude*a/n);t.addForce(c),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function Ff(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function qf(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let s=t.target.vel,o=an().scale(-1).angleBetween(s);Math.abs(o)>this.surfaceArc/2&&t.preventResolution()})}}}function Yf(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,s)=>{let o=t,n=o.worldArea(),[r,a]=n.cut(X(-100,this.surfaceLevel),X(100,this.surfaceLevel));r&&(this.applyBuoyancy(o,r),this.applyDrag(o,r)),this.flowMagnitude&&o.addForce(Q.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,s){let o=this.density*s.area(),n=X(0,1).scale(-o);t.addForce(n)},applyDrag(t,s){let o=t.vel,n=this.density*this.linearDrag,r=o.scale(-n);t.addForce(r)}}}function hr(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function fc(){return{id:"fixed",fixed:!0}}function Xf(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??X(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Gf(e){let t=y.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?y.game.layers?.[t]??null:null},set layer(s){if(t=y.game.layers?.indexOf(s),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function Kf(e,t){let s=typeof e=="number"?Q.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(s.scale(t))}}}function Vf(e={}){let t=!1,s=new Qe(X(0),Mt(),Tt()),o=new Qe(X(0),0,0),n=r=>{r.isOffScreen()?(t||(r.trigger("exitView"),t=!0),e.hide&&(r.hidden=!0),e.pause&&(r.paused=!0),e.destroy&&r.destroy()):(t&&(r.trigger("enterView"),t=!1),e.hide&&(r.hidden=!1),e.pause&&(r.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??ga,isOffScreen(){let r=this.screenPos();if(!r)return!1;if(s.width=Mt(),s.height=Tt(),!this.offscreenDistance&&this.width&&this.height)return o.width=this.width,o.height=this.height,o.pos=this.pos,o.collides(s);let a=this.offscreenDistance?this.offscreenDistance:ga;return!pi(s,r)&&s.sdistToPoint(r)>a*a},onExitScreen(r){return this.on("exitView",r)},onEnterScreen(r){return this.on("enterView",r)},add(){e.pause&&e.unpause?jl(()=>n(this)):this.onUpdate(()=>n(this))}}}function ti(...e){return{id:"pos",pos:X(...e),moveBy(...t){this.pos=this.pos.add(X(...t))},move(...t){this.moveBy(X(...t).scale(At()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(X(t[0],t[1]),t[2]);let s=t[0],o=t[1];if(o===void 0){this.pos=X(s);return}let n=s.sub(this.pos);if(n.len()<=o*At()){this.pos=X(s);return}this.move(n.unit().scale(o))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let s=this.worldPos();return s?eo(this)?s:ar(s):null}},toScreen(t){let s=this.toWorld(t);return eo(this)?s:ar(s)},fromScreen(t){return eo(this)?this.fromWorld(t):this.fromWorld(nc(t))},toOther(t,s){return t.fromWorld(this.toWorld(s))},fromOther(t,s){return t.toOther(this,s)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){Io({color:Fe(255,0,0),radius:4/Cl()})}}}function Wf(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function si(...e){if(e.length===0)return si(1);let t=X(...e);return{id:"scale",set scale(s){if(!(s instanceof Q))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=X(s)},get scale(){return t},scaleTo(...s){t=X(...s)},scaleBy(...s){t=t.scale(X(...s))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function jf(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var $f="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",Jf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",Qf=Fd.version,y={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},Zf=(e={tagsAsComponents:!0})=>{y.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),y.k.quit()),y.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let s=e.canvas??t.appendChild(document.createElement("canvas"));y.canvas=s;let o=e.scale??1;y.gscale=o;let n=e.width&&e.height&&!e.stretch&&!e.letterbox;n?(s.width=e.width*o,s.height=e.height*o):(s.width=s.parentElement.offsetWidth,s.height=s.parentElement.offsetHeight);let r=["outline: none","cursor: default"];if(n){let V=s.width,ee=s.height;r.push(`width: ${V}px`),r.push(`height: ${ee}px`)}else r.push("width: 100%"),r.push("height: 100%");e.crisp&&(r.push("image-rendering: pixelated"),r.push("image-rendering: crisp-edges")),s.style.cssText=r.join(";");let a=e.pixelDensity||1;y.pixelDensity=a,s.width*=a,s.height*=a,s.tabIndex=0;let c=document.createElement("canvas");c.width=256,c.height=256,y.fontCacheCanvas=c;let l=c.getContext("2d",{willReadFrequently:!0});y.fontCacheC2d=l;let d=xu({canvas:s,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});y.app=d;let i=[],p=d.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!p)throw new Error("WebGL not supported");let h=p,f=dp(h,{texFilter:e.texFilter}),g=xp(e,f);y.gfx=g;let u=nf();y.audio=u;let w=Gu(f,e.spriteAtlasPadding??0);y.assets=w;let v=kp();y.game=v,v.root.use(cr());function A(V,ee){let te=new kn(f,V,ee);return{clear:()=>te.clear(),free:()=>te.free(),toDataURL:()=>te.toDataURL(),toImageData:()=>te.toImageData(),width:te.width,height:te.height,draw:ve=>{Wt(),te.bind(),ve(),Wt(),te.unbind()},get fb(){return te}}}function D(){h.clear(h.COLOR_BUFFER_BIT),g.frameBuffer.bind(),h.clear(h.COLOR_BUFFER_BIT),g.bgColor||Ns(()=>{mn({width:Mt(),height:Tt(),quad:new it(0,0,Mt()/64,Tt()/64),tex:g.bgTex,fixed:!0})}),g.renderer.numDraws=0,g.fixed=!1,g.transformStack.length=0,g.transform=new xs}function Y(V,ee){g.postShader=V,g.postShaderUniform=ee??null}function P(){Wt(),g.lastDrawCalls=g.renderer.numDraws,g.frameBuffer.unbind(),h.viewport(0,0,h.drawingBufferWidth,h.drawingBufferHeight);let V=g.width,ee=g.height;g.width=h.drawingBufferWidth/a,g.height=h.drawingBufferHeight/a,ei({flipY:!0,tex:g.frameBuffer.tex,pos:new Q(g.viewport.x,g.viewport.y),width:g.viewport.width,height:g.viewport.height,shader:g.postShader,uniform:typeof g.postShaderUniform=="function"?g.postShaderUniform():g.postShaderUniform,fixed:!0}),Wt(),g.width=V,g.height=ee}let m=!1,x={inspect:!1,set timeScale(V){y.app.state.timeScale=V},get timeScale(){return y.app.state.timeScale},showLog:!0,fps:()=>d.fps(),numFrames:()=>d.numFrames(),stepFrame:xe,drawCalls:()=>g.lastDrawCalls,clearLog:()=>v.logs=[],log:(...V)=>{let ee=e.logMax??8,te=V.length>1?V.concat(" ").join(" "):V[0];v.logs.unshift({msg:te,time:d.time()}),v.logs.length>ee&&(v.logs=v.logs.slice(0,ee))},error:V=>x.log(new Error(V.toString?V.toString():V)),curRecording:null,numObjects:()=>k("*",{recursive:!0}).length,get paused(){return m},set paused(V){m=V,V?u.ctx.suspend():u.ctx.resume()}};y.debug=x;function E(V,ee){try{return JSON.parse(window.localStorage[V])}catch{return ee?(S(V,ee),ee):null}}function S(V,ee){window.localStorage[V]=JSON.stringify(ee)}function I(V,...ee){let te=V(ae),ve;typeof te=="function"?ve=te(...ee)(ae):ve=te;for(let Ce in ve)ae[Ce]=ve[Ce],e.global!==!1&&(window[Ce]=ve[Ce]);return ae}function T(V){let ee=d.canvas.captureStream(V),te=u.ctx.createMediaStreamDestination();u.masterNode.connect(te);let ve=new MediaRecorder(ee),Ce=[];return ve.ondataavailable=ce=>{ce.data.size>0&&Ce.push(ce.data)},ve.onerror=()=>{u.masterNode.disconnect(te),ee.getTracks().forEach(ce=>ce.stop())},ve.start(),{resume(){ve.resume()},pause(){ve.pause()},stop(){return ve.stop(),u.masterNode.disconnect(te),ee.getTracks().forEach(ce=>ce.stop()),new Promise(ce=>{ve.onstop=()=>{ce(new Blob(Ce,{type:"video/mp4"}))}})},download(ce="kaboom.mp4"){this.stop().then(Te=>ma(ce,Te))}}}function z(){return document.activeElement===d.canvas}let _=v.root.add.bind(v.root),j=v.root.readd.bind(v.root),q=v.root.removeAll.bind(v.root),k=v.root.get.bind(v.root),U=v.root.wait.bind(v.root),F=v.root.loop.bind(v.root),O=v.root.query.bind(v.root),J=v.root.tween.bind(v.root),ne=rn(null,Jf),se=rn(null,$f);y.kaSprite=ne,y.boomSprite=se;function Ee(){v.root.fixedUpdate()}function xe(){v.root.update()}class Ae{source;target;normal;distance;resolved=!1;constructor(ee,te,ve,Ce,ce=!1){this.source=ee,this.target=te,this.normal=ve,this.distance=Ce,this.resolved=ce}get displacement(){return this.normal.scale(this.distance)}reverse(){return new Ae(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(v.gravity||X(0,1))>0}isRight(){return this.displacement.cross(v.gravity||X(0,1))<0}isTop(){return this.displacement.dot(v.gravity||X(0,1))>0}isBottom(){return this.displacement.dot(v.gravity||X(0,1))<0}preventResolution(){this.resolved=!0}}function Me(){if(!Of())return;let V={},ee=e.hashGridSize||64,te=new xs,ve=[];function Ce(ce){if(ve.push(te.clone()),ce.pos&&te.translate(ce.pos),ce.scale&&te.scale(ce.scale),ce.angle&&te.rotate(ce.angle),ce.transform=te.clone(),ce.c("area")&&!ce.paused){let Te=ce,qe=Te.worldArea().bbox(),tt=Math.floor(qe.pos.x/ee),is=Math.floor(qe.pos.y/ee),kt=Math.ceil((qe.pos.x+qe.width)/ee),st=Math.ceil((qe.pos.y+qe.height)/ee),xt=new Set;for(let rt=tt;rt<=kt;rt++)for(let Ge=is;Ge<=st;Ge++)if(!V[rt])V[rt]={},V[rt][Ge]=[Te];else if(!V[rt][Ge])V[rt][Ge]=[Te];else{let ot=V[rt][Ge];e:for(let Xe of ot){if(Xe.paused||!Xe.exists()||xt.has(Xe.id))continue;for(let dt of Te.collisionIgnore)if(Xe.is(dt))continue e;for(let dt of Xe.collisionIgnore)if(Te.is(dt))continue e;let yt=Rh(Te.worldArea(),Xe.worldArea());if(yt){let dt=new Ae(Te,Xe,yt.normal,yt.distance);Te.trigger("collideUpdate",Xe,dt);let Ne=dt.reverse();Ne.resolved=dt.resolved,Xe.trigger("collideUpdate",Te,Ne)}xt.add(Xe.id)}ot.push(Te)}}ce.children.forEach(Ce),te=ve.pop()}Ce(v.root)}function Oe(V){console.error(V),u.ctx.suspend();let ee=V.message??String(V)??"Unknown error, check console for more info";d.run(()=>{},()=>{D(),Ns(()=>{let te=Mt(),ve=Tt(),Ce={size:36,width:te-64,letterSpacing:4,lineSpacing:4,font:Qn,fixed:!0};jt({width:te,height:ve,color:Fe(0,0,255),fixed:!0});let ce=io({...Ce,text:"Error",pos:X(32),color:Fe(255,128,0),fixed:!0});ro(ce),Da({...Ce,text:ee,pos:X(32,32+ce.height+16),fixed:!0}),_t(),v.events.trigger("error",V)}),P()})}function Be(V){i.push(V)}function _e(){v.events.onOnce("frameEnd",()=>{d.quit(),h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT|h.STENCIL_BUFFER_BIT);let V=h.getParameter(h.MAX_TEXTURE_IMAGE_UNITS);for(let ee=0;ee<V;ee++)h.activeTexture(h.TEXTURE0+ee),h.bindTexture(h.TEXTURE_2D,null),h.bindTexture(h.TEXTURE_CUBE_MAP,null);h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),f.destroy(),i.forEach(ee=>ee())})}let ze=!0;d.run(()=>{try{w.loaded&&(x.paused||Ee(),Me())}catch(V){Oe(V)}},(V,ee)=>{try{V(),w.loaded||no()===1&&!ze&&(w.loaded=!0,Pl().forEach(te=>v.events.trigger("loadError",...te)),v.events.trigger("load")),!w.loaded&&e.loadingScreen!==!1||ze?(D(),pp(),P()):(x.paused||xe(),Me(),D(),up(),e.debug!==!1&&hp(),P()),ze&&(ze=!1),v.events.trigger("frameEnd"),ee()}catch(te){Oe(te)}}),Rl(),lc();let ae={_k:y,VERSION:Qf,loadRoot:qu,loadProgress:no,loadSprite:rn,loadSpriteAtlas:Nl,loadSound:op,loadMusic:np,loadBitmapFont:Ju,loadFont:ju,loadShader:ep,loadShaderURL:tp,loadAseprite:Wu,loadPedit:Qu,loadBean:Vu,loadJSON:Yu,load:nr,getSound:Ul,getFont:Ll,getBitmapFont:Hl,getSprite:Il,getShader:zl,getAsset:Xu,Asset:Qt,SpriteData:Gs,SoundData:gn,width:Mt,height:Tt,center:Zn,dt:At,fixedDt:sr,restDt:or,time:d.time,screenshot:d.screenshot,record:T,isFocused:z,setCursor:d.setCursor,getCursor:d.getCursor,setCursorLocked:d.setCursorLocked,isCursorLocked:d.isCursorLocked,setFullscreen:d.setFullscreen,isFullscreen:d.isFullscreen,isTouchscreen:d.isTouchscreen,onLoad:Gr,onLoadError:Kp,onLoading:Yp,onResize:Xp,onGamepadConnect:d.onGamepadConnect,onGamepadDisconnect:d.onGamepadDisconnect,onError:Gp,onCleanup:Be,flash:oc,setCamPos:Ql,getCamPos:Zl,setCamRot:tc,getCamRot:sc,setCamScale:kl,getCamScale:ec,getCamTransform:Vp,camPos:$p,camScale:Jp,camFlash:Zp,camRot:Qp,camTransform:Wp,shake:jp,toScreen:ar,toWorld:nc,setGravity:ef,getGravity:tf,setGravityDirection:sf,getGravityDirection:an,setBackground:Hu,getBackground:zu,getGamepads:d.getGamepads,getTreeRoot:pf,add:_,make:Kr,destroy:dc,destroyAll:q,get:k,query:O,readd:j,pos:ti,scale:si,rotate:Wf,color:Gl,opacity:Kl,anchor:hr,area:Lf,sprite:lr,text:yf,polygon:Mp,rect:Wl,circle:yp,uvquad:wf,outline:Ap,particles:Ep,body:Hf,platformEffector:qf,surfaceEffector:Uf,areaEffector:Nf,pointEffector:_f,buoyancyEffector:Yf,constantForce:Ff,doubleJump:zf,shader:Dp,textInput:Bf,timer:cr,fixed:fc,stay:pc,health:Cf,lifespan:Tf,named:Pf,state:If,z:jf,layer:Gf,move:Kf,offscreen:Vf,follow:Xf,fadeIn:bp,mask:vp,drawon:wp,raycast:Vl,tile:hc,animate:Rf,serializeAnimation:uc,agent:bf,sentry:Sf,patrol:Af,pathfinder:vf,trigger:Cp,on:Xt,onFixedUpdate:Tp,onUpdate:jl,onDraw:Pp,onAdd:$l,onDestroy:Ip,onTag:Jl,onUntag:Lp,onUse:Bp,onUnuse:Op,onClick:Np,onCollide:Hp,onCollideUpdate:zp,onCollideEnd:Up,onHover:_p,onHoverUpdate:Fp,onHoverEnd:qp,onKeyDown:d.onKeyDown,onKeyPress:d.onKeyPress,onKeyPressRepeat:d.onKeyPressRepeat,onKeyRelease:d.onKeyRelease,onMouseDown:d.onMouseDown,onMousePress:d.onMousePress,onMouseRelease:d.onMouseRelease,onMouseMove:d.onMouseMove,onCharInput:d.onCharInput,onTouchStart:d.onTouchStart,onTouchMove:d.onTouchMove,onTouchEnd:d.onTouchEnd,onScroll:d.onScroll,onHide:d.onHide,onShow:d.onShow,onGamepadButtonDown:d.onGamepadButtonDown,onGamepadButtonPress:d.onGamepadButtonPress,onGamepadButtonRelease:d.onGamepadButtonRelease,onGamepadStick:d.onGamepadStick,onButtonPress:d.onButtonPress,onButtonDown:d.onButtonDown,onButtonRelease:d.onButtonRelease,mousePos:d.mousePos,mouseDeltaPos:d.mouseDeltaPos,isKeyDown:d.isKeyDown,isKeyPressed:d.isKeyPressed,isKeyPressedRepeat:d.isKeyPressedRepeat,isKeyReleased:d.isKeyReleased,isMouseDown:d.isMouseDown,isMousePressed:d.isMousePressed,isMouseReleased:d.isMouseReleased,isMouseMoved:d.isMouseMoved,isGamepadButtonPressed:d.isGamepadButtonPressed,isGamepadButtonDown:d.isGamepadButtonDown,isGamepadButtonReleased:d.isGamepadButtonReleased,getGamepadStick:d.getGamepadStick,isButtonPressed:d.isButtonPressed,isButtonDown:d.isButtonDown,isButtonReleased:d.isButtonReleased,setButton:d.setButton,getButton:d.getButton,pressButton:d.pressButton,releaseButton:d.releaseButton,getLastInputDeviceType:d.getLastInputDeviceType,charInputted:d.charInputted,loop:F,wait:U,play:af,setVolume:rc,getVolume:ac,volume:lf,burp:ic,audioCtx:u.ctx,Line:Yt,Rect:Qe,Circle:qt,Ellipse:Ts,Point:ch,Polygon:Ht,Vec2:Q,Color:He,Mat4:xs,Quad:it,RNG:ol,rand:vt,randi:nl,randSeed:Kd,vec2:X,rgb:Fe,hsl2rgb:qd,quad:pt,choose:jd,chooseMultiple:Wd,shuffle:il,chance:Vd,lerp:Ft,tween:J,easings:pn,map:fs,mapc:Yd,wave:sl,deg2rad:mt,rad2deg:oo,clamp:ms,evaluateQuadratic:hh,evaluateQuadraticFirstDerivative:uh,evaluateQuadraticSecondDerivative:ph,evaluateBezier:zr,evaluateBezierFirstDerivative:fh,evaluateBezierSecondDerivative:gh,evaluateCatmullRom:mh,evaluateCatmullRomFirstDerivative:xh,curveLengthApproximation:gl,normalizedCurve:yh,hermite:vn,cardinal:ml,catmullRom:Jn,bezier:wh,kochanekBartels:bh,easingSteps:Dh,easingLinear:Eh,easingCubicBezier:Mh,testLineLine:Pr,testRectRect:rl,testRectLine:Ir,testRectPoint:pi,testCirclePolygon:gi,testLinePoint:Br,testLineCircle:bn,isConvex:Bh,triangulate:yl,NavMesh:Ou,drawSprite:gp,drawText:Da,formatText:io,drawRect:jt,drawLine:ko,drawLines:Xr,drawTriangle:Yl,drawCircle:Io,drawEllipse:_l,drawUVQuad:mn,drawPolygon:Fs,drawCurve:Fl,drawBezier:lp,drawFormattedText:ro,drawMasked:fp,drawSubtracted:mp,pushTransform:Vt,popTransform:_t,pushTranslate:lt,pushScale:fn,pushRotate:Do,pushMatrix:Uu,usePostEffect:Y,makeCanvas:A,debug:x,scene:ff,getSceneName:xf,go:gf,onSceneLeave:mf,layers:uf,getLayers:df,setLayers:cc,getDefaultLayer:hf,addLevel:Rp,getData:E,setData:S,download:Nr,downloadJSON:jh,downloadText:Ml,downloadBlob:ma,plug:I,ASCII_CHARS:wl,canvas:d.canvas,addKaboom:cf,LEFT:Q.LEFT,RIGHT:Q.RIGHT,UP:Q.UP,DOWN:Q.DOWN,RED:He.RED,GREEN:He.GREEN,BLUE:He.BLUE,YELLOW:He.YELLOW,MAGENTA:He.MAGENTA,CYAN:He.CYAN,WHITE:He.WHITE,BLACK:He.BLACK,quit:_e,KEvent:Lt,KEventHandler:un,KEventController:ho,cancel:()=>vl};y.k=ae;let oe=e.plugins;if(oe&&oe.forEach(I),e.global!==!1)for(let V in ae)window[V]=ae[V];return e.focus!==!1&&d.canvas.focus(),ae},kf=Zf;const e0="modulepreload",t0=function(e){return"/SuperSmashTexty/"+e},Ta={},lo=function(t,s,o){let n=Promise.resolve();if(s&&s.length>0){let d=function(i){return Promise.all(i.map(p=>Promise.resolve(p).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};var a=d;document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");n=d(s.map(i=>{if(i=t0(i),i in Ta)return;Ta[i]=!0;const p=i.endsWith(".css"),h=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${h}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":e0,p||(f.as="script"),f.crossOrigin="",f.href=i,l&&f.setAttribute("nonce",l),document.head.appendChild(f),p)return new Promise((g,u)=>{f.addEventListener("load",g),f.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${i}`)))})}))}function r(c){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=c,window.dispatchEvent(l),!l.defaultPrevented)throw c}return n.then(c=>{for(const l of c||[])l.status==="rejected"&&r(l.reason);return t().catch(r)})},Pa=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Legendary","Royal","Noble","Rogue","Savage"],Ia=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter"];function ur(){const e=Pa[Math.floor(Math.random()*Pa.length)],t=Ia[Math.floor(Math.random()*Ia.length)];return`${e}${t}`}function pr(){return Math.floor(1e5+Math.random()*9e5).toString()}function s0(e){return/^\d{6}$/.test(e)}const gc="superSmashTexty_save",o0="$",fr={version:1,currency:0,playerName:null,inviteCode:null,unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0},achievements:[]};function Ze(){try{const t=localStorage.getItem(gc);if(t){const s=JSON.parse(t),o={...fr,...s};return o.playerName||(o.playerName=ur(),Pt(o)),o.inviteCode||(o.inviteCode=pr(),Pt(o)),o}}catch(t){console.error("Error loading save:",t)}const e={...fr};return e.playerName=ur(),e.inviteCode=pr(),Pt(e),e}function Pt(e){try{return localStorage.setItem(gc,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function mc(){return Ze()}function So(e){const t=Ze();return t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+e),Pt(t),t.currency}function Ks(){return Ze().currency}function os(e,t){const s=Ze();return s.unlocks[e]&&s.unlocks[e].includes(t)}function xc(e,t){const s=Ze();return s.unlocks[e]||(s.unlocks[e]=[]),s.unlocks[e].includes(t)?!1:(s.unlocks[e].push(t),Pt(s),!0)}async function gr(e){const{CHARACTER_UNLOCKS:t}=await lo(async()=>{const{CHARACTER_UNLOCKS:o}=await Promise.resolve().then(()=>i0);return{CHARACTER_UNLOCKS:o}},void 0);Ze();let s=!1;for(const[o,n]of Object.entries(t))n.unlockRequirement&&n.unlockRequirement.type==="floor"&&e>=n.unlockRequirement.value&&(os("characters",o)||(xc("characters",o),s=!0));return s}function Ps(){return Ze().selectedCharacter||"survivor"}function yc(e){const t=Ze();t.selectedCharacter=e,Pt(t)}function Je(e){const t=Ze();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function wc(e,t,s){const o=Ze();return o.currency>=s?(o.currency-=s,o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)||o.unlocks[e].push(t),Pt(o),!0):!1}function bc(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function vc(e,t,s){const o=Ze(),n=Je(e);return s&&n>=s?{success:!1,reason:"maxLevel"}:o.currency<t?{success:!1,reason:"insufficientCurrency"}:(o.currency-=t,o.permanentUpgradeLevels||(o.permanentUpgradeLevels={}),o.permanentUpgradeLevels[e]=(n||0)+1,o.permanentUpgradePurchaseHistory||(o.permanentUpgradePurchaseHistory={}),o.permanentUpgradePurchaseHistory[e]||(o.permanentUpgradePurchaseHistory[e]=[]),o.permanentUpgradePurchaseHistory[e].push(t),o.unlocks.permanentUpgrades||(o.unlocks.permanentUpgrades=[]),o.unlocks.permanentUpgrades.includes(e)||o.unlocks.permanentUpgrades.push(e),Pt(o),{success:!0,newLevel:o.permanentUpgradeLevels[e]})}function Wr(){const e=Ze();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(s=>{const o=e.permanentUpgradePurchaseHistory[s];o&&Array.isArray(o)&&o.forEach(n=>{t+=n})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(s=>{const o=e.permanentUpgradeLevels[s]||0;for(let n=0;n<o;n++)t+=bc(n)}),t}return 0}function Ac(e){const t=Ze(),s=Je(e);if(s===0)return{success:!1,reason:"noLevels"};let o=0;if(t.permanentUpgradePurchaseHistory&&t.permanentUpgradePurchaseHistory[e]&&t.permanentUpgradePurchaseHistory[e].length>0){const n=t.permanentUpgradePurchaseHistory[e];o=n[n.length-1],n.pop(),n.length===0&&delete t.permanentUpgradePurchaseHistory[e]}else o=bc(s-1);if(t.currency+=o,t.permanentUpgradeLevels[e]=s-1,t.permanentUpgradeLevels[e]===0&&(delete t.permanentUpgradeLevels[e],t.unlocks.permanentUpgrades)){const n=t.unlocks.permanentUpgrades.indexOf(e);n>-1&&t.unlocks.permanentUpgrades.splice(n,1)}return Pt(t),{success:!0,refundAmount:o,newLevel:t.permanentUpgradeLevels[e]||0}}function Sc(){const e=Ze(),t=Wr();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),Pt(e),{success:!0,refundAmount:t})}function Gn(e){const t=Ze();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),Pt(t)}function ft(e){const t=Ze();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function gt(e){const t=Ze();return t.achievements||(t.achievements=[]),t.achievements.includes(e)?!1:(t.achievements.push(e),Pt(t),!0)}function Ec(){return Ze().achievements||[]}function jr(){return Ze().stats||fr.stats}function Kn(e){let t=0;return t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30),Math.floor(t)}function bi(){return o0}function po(){return Ze().playerName||"Player"}function mr(e){const t=Ze();return t.playerName=e,Pt(t),t.playerName}function Cs(){return Ze().inviteCode||"000000"}function Mc(e){const t=Ze();return t.inviteCode=e,Pt(t),t.inviteCode}const n0=Object.freeze(Object.defineProperty({__proto__:null,addCurrency:So,calculateCurrencyEarned:Kn,checkFloorUnlocks:gr,getCurrency:Ks,getCurrencyName:bi,getInviteCode:Cs,getPermanentUpgradeLevel:Je,getPlayerName:po,getSaveData:mc,getSaveStats:jr,getSelectedCharacter:Ps,getTotalRefundableCredits:Wr,getUnlockedAchievements:Ec,isAchievementUnlocked:ft,isUnlocked:os,loadSave:Ze,purchasePermanentUpgrade:vc,purchaseUnlock:wc,refundAllPermanentUpgrades:Sc,refundSinglePermanentUpgrade:Ac,saveGame:Pt,setInviteCode:Mc,setPlayerName:mr,setSelectedCharacter:yc,unlockAchievement:gt,unlockItem:xc,updateRunStats:Gn},Symbol.toStringTag,{value:"Module"})),ys={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"}},Dc={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0}},Rc={startingHealth:{name:"Starting Health +10",description:"Start the show with +10 max health",cost:50,maxLevel:5},startingDamage:{name:"Starting Damage +1",description:"Start the show with +1 damage",cost:75,maxLevel:5},startingSpeed:{name:"Starting Speed +10",description:"Start the show with +10 speed",cost:60,maxLevel:5},propDurability:{name:"Prop Durability",description:"Props last +2 seconds per level",cost:80,maxLevel:5},propDropChance:{name:"Prop Drop Chance",description:"+5% prop drop chance per level",cost:100,maxLevel:5}};function Cc(e){switch(e){case"characters":return ys;case"weapons":return Dc;case"permanentUpgrades":return Rc;default:return{}}}const i0=Object.freeze(Object.defineProperty({__proto__:null,CHARACTER_UNLOCKS:ys,PERMANENT_UPGRADE_UNLOCKS:Rc,WEAPON_UNLOCKS:Dc,getUnlocksForCategory:Cc},Symbol.toStringTag,{value:"Module"})),xr={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]}};function Tc(e){return xr[e]||xr.pistol}function r0(e,t){return Tc(e).upgradeCategories.includes(t)}const Xo={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},us={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},Rs={BASE_XP_TO_NEXT_LEVEL:15,XP_SCALING_FACTOR:1.25,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},Ls={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},Et={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},Ro={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},nt={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:800,MAGNETIZE_ACCELERATION:600,COLLECTION_RADIUS:20};function Ui(e,t=0,s=0){const o=e*(1-s);return Math.max(Et.MIN_DAMAGE,o-t)}function a0(e,t=null){return(t?t.next():Math.random())<e}function l0(e,t=2){return Math.floor(e*t)}function Ni(e,t,s,o=null){const n=o||Ps(),r=ys[n]||ys.survivor,a=e.add([e.text(r.char,{size:24}),e.pos(t,s),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.rotate(0),e.z(-1),"playerOutline"]),c=e.add([e.text(r.char,{size:24}),e.pos(t,s),e.anchor("center"),e.color(...r.color),e.rotate(0),e.area(),e.health(r.stats.health),"player"]);c.outline=a,c.characterKey=n,c.characterData=r,c.speed=r.stats.speed,c.originalSpeed=r.stats.speed,c.slowed=!1,c.maxHealth=r.stats.health,c.level=Rs.STARTING_LEVEL,c.xp=Rs.STARTING_XP,c.xpToNext=Rs.BASE_XP_TO_NEXT_LEVEL,c.pickupRadius=us.BASE_PICKUP_RADIUS,c.invulnerable=!1,c.invulnerableTime=0,c.invulnerableDuration=us.INVULNERABILITY_DURATION,c.setHP(c.maxHealth);const l=r.weapon||"pistol",d=Tc(l);c.weaponKey=l,c.weaponDef=d,c.baseFireRate=d.fireRate,c.baseProjectileSpeed=d.projectileSpeed,c.baseProjectileDamage=d.baseDamage;const i=r.stats.damage||10,p=d.baseDamage,h=i/10;c.fireRate=d.fireRate,c.projectileSpeed=d.projectileSpeed,c.projectileDamage=Math.floor(p*h),c.lastFireTime=0,c.projectileCount=d.projectileCount,c.piercing=d.piercing,c.obstaclePiercing=d.obstaclePiercing,c.critChance=d.critChance,c.critDamage=d.critDamage,c.spreadAngle=d.spreadAngle,c.defense=0,c.weaponRange=d.range,c.weaponCategory=d.category,d.orbitRadius&&(c.orbitRadius=d.orbitRadius,c.rotationSpeed=d.rotationSpeed,c.orbitalOrbs=[],c.orbitalAngles=[]),d.explosionRadius&&(c.explosionRadius=d.explosionRadius,c.explosionDamage=d.explosionDamage),d.chainRange&&(c.chainRange=d.chainRange,c.maxJumps=d.maxJumps,c.chainDamageReduction=d.chainDamageReduction),c.xpMultiplier=1,c.dodgeChance=0,c.damageReduction=0,c.weapons=[l],c.passiveUpgrades=[],c.upgradeStacks={},r.ability==="xpBoost"?c.xpMultiplier=Ls.SURVIVOR_XP_BOOST:r.ability==="speedBoost"?(c.speed=c.speed*Ls.SCOUT_SPEED_BOOST,c.originalSpeed=c.speed,c.dodgeChance=Ls.SCOUT_DODGE_CHANCE):r.ability==="tankStats"?(c.maxHealth=Math.floor(c.maxHealth*Ls.TANK_HEALTH_BOOST),c.setHP(c.maxHealth),c.damageReduction=Ls.TANK_DAMAGE_REDUCTION):r.ability==="critBoost"?(c.critChance=(c.critChance||0)*Ls.SNIPER_CRIT_CHANCE_MULTIPLIER,c.critDamage=(c.critDamage||2)*Ls.SNIPER_CRIT_DAMAGE_MULTIPLIER):r.ability==="fireDot"&&(c.fireDotMultiplier=Ls.PYRO_FIRE_DOT_MULTIPLIER),c.canMove=!0,c.canShoot=!0,c.isDead=!1;let f=e.vec2(0,0),g=document.hasFocus(),u={w:!1,s:!1,a:!1,d:!1,up:!1,down:!1,left:!1,right:!1};c.moveDir=f,e.onKeyDown(["w","up"],()=>{c.isRemote||!g||u.w||u.up||(f.y=-1,c.moveDir=f)}),e.onKeyDown(["s","down"],()=>{c.isRemote||!g||u.s||u.down||(f.y=1,c.moveDir=f)}),e.onKeyDown(["a","left"],()=>{c.isRemote||!g||u.a||u.left||(f.x=-1,c.moveDir=f)}),e.onKeyDown(["d","right"],()=>{c.isRemote||!g||u.d||u.right||(f.x=1,c.moveDir=f)}),e.onKeyRelease(["w","up"],()=>{c.isRemote||(u.w=!1,u.up=!1,!e.isKeyDown("s")&&!e.isKeyDown("down")&&(f.y=0,c.moveDir=f))}),e.onKeyRelease(["s","down"],()=>{c.isRemote||(u.s=!1,u.down=!1,!e.isKeyDown("w")&&!e.isKeyDown("up")&&(f.y=0,c.moveDir=f))}),e.onKeyRelease(["a","left"],()=>{c.isRemote||(u.a=!1,u.left=!1,!e.isKeyDown("d")&&!e.isKeyDown("right")&&(f.x=0,c.moveDir=f))}),e.onKeyRelease(["d","right"],()=>{c.isRemote||(u.d=!1,u.right=!1,!e.isKeyDown("a")&&!e.isKeyDown("left")&&(f.x=0,c.moveDir=f))});const w=()=>{c.isRemote||(g=!1,f.x=0,f.y=0,c.moveDir=f,c.isShooting=!1,u={w:e.isKeyDown("w"),s:e.isKeyDown("s"),a:e.isKeyDown("a"),d:e.isKeyDown("d"),up:e.isKeyDown("up"),down:e.isKeyDown("down"),left:e.isKeyDown("left"),right:e.isKeyDown("right")})},v=()=>{g=!0};return window.addEventListener("blur",w),window.addEventListener("focus",v),c.onDestroy(()=>{window.removeEventListener("blur",w),window.removeEventListener("focus",v)}),c.onUpdate(()=>{if(c.outline&&c.outline.exists()&&(c.outline.pos=c.pos.clone()),e.paused)return;if(c.invulnerable)if(c.invulnerableTime-=e.dt(),c.invulnerableTime<=0)c.invulnerable=!1,c.color=e.rgb(...us.NORMAL_COLOR),c.outline&&c.outline.exists()&&(c.outline.opacity=1);else{const m=us.IMMUNITY_FLASH_RATE;Math.floor(c.invulnerableTime*m)%2===0?(c.color=e.rgb(...us.NORMAL_COLOR),c.outline&&c.outline.exists()&&(c.outline.opacity=1)):(c.color=e.rgb(...us.NORMAL_COLOR,us.IMMUNITY_ALPHA),c.outline&&c.outline.exists()&&(c.outline.opacity=us.IMMUNITY_ALPHA))}if(c.canMove===!1)return;let A=f;if(c.isRemote&&c.move&&(A=e.vec2(c.move.x,c.move.y)),A.len()>0){const m=A.len(),E=A.scale(1/m).scale(c.speed*e.dt()),S=c.pos.x+E.x,I=c.pos.y+E.y;let T=!0,z=!0;const _=e.get("obstacle"),j=us.COLLISION_SIZE;for(const q of _){if(!q.exists())continue;const k=q.pos.x-q.width/2,U=q.pos.x+q.width/2,F=q.pos.y-q.height/2,O=q.pos.y+q.height/2,J=S-j,ne=S+j,se=c.pos.y-j,Ee=c.pos.y+j;ne>k&&J<U&&Ee>F&&se<O&&(T=!1);const xe=c.pos.x-j,Ae=c.pos.x+j,Me=I-j,Oe=I+j;Ae>k&&xe<U&&Oe>F&&Me<O&&(z=!1)}T&&(c.pos.x=S),z&&(c.pos.y=I)}const D=e.width(),Y=e.height(),P=us.ROOM_MARGIN;c.pos.x=e.clamp(c.pos.x,P,D-P),c.pos.y=e.clamp(c.pos.y,P,Y-P)}),c}const me={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function vi(e,t=!0){return new Promise((s,o)=>{if(me.isInitialized){console.warn("Network already initialized"),s(e);return}if(window.addEventListener("beforeunload",()=>{Bc()}),typeof Peer>"u"){console.error("PeerJS library not loaded"),o(new Error("PeerJS library not available"));return}me.isHost=t;const n=t?`smash-${e}`:void 0,r=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";let a;r?a={debug:3,host:"localhost",port:9e3,path:"/",secure:!1,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}}:a={debug:2,secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}};try{me.peer=new Peer(n,a),me.peer.on("open",c=>{me.peerId=c,me.isInitialized=!0;const l=t&&c.startsWith("smash-")?c.substring(6):c;s(l)}),me.peer.on("error",c=>{if(console.error("Peer error:",c),c.type==="unavailable-id"&&t){if(console.warn("Peer ID already taken - generating new code and retrying..."),me.peer){try{me.peer.destroy()}catch(l){console.warn("Error destroying peer:",l)}me.peer=null,me.peerId=null,me.isInitialized=!1}setTimeout(()=>{const l=pr();vi(l,t).then(s).catch(o)},2e3);return}c.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):c.type==="peer-unavailable"?console.warn("Host not found - check invite code"):c.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),me.isInitialized||o(new Error(`Multiplayer unavailable: ${c.type||"connection failed"}`))}),t&&me.peer.on("connection",c=>{c0(c)})}catch(c){console.error("Failed to create peer:",c),o(c)}})}function c0(e){me.isHost&&(e.on("open",()=>{me.connections.set(e.peer,e),me.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{Ic(t,e.peer)}),e.on("close",()=>{me.connections.delete(e.peer),me.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function Pc(e){return new Promise((t,s)=>{if(me.isHost){s(new Error("Host cannot connect to another host"));return}if(!me.isInitialized){s(new Error("Network not initialized"));return}const o=`smash-${e}`;let n,r=!1;const a=me.peer.connect(o,{reliable:!0});n=setTimeout(()=>{r||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),a.close(),s(new Error("Connection timeout - could not reach host")))},3e4),a.on("open",()=>{r=!0,clearTimeout(n),me.hostConnection=a,me.hostId=o,t()}),a.on("data",c=>{Ic(c,o)}),a.on("close",()=>{me.hostConnection=null,me.hostId=null,me.connectionCallbacks.forEach(c=>c("host_disconnect"))}),a.on("error",c=>{r=!0,clearTimeout(n),console.error("[NetworkSystem] Connection error:",c),console.error("[NetworkSystem] Error type:",c.type||"unknown"),s(c)})})}function Ic(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const s=me.messageHandlers.get(e.type);s?s(e.payload,t):console.warn("No handler for message type:",e.type)}function Pe(e,t){me.messageHandlers.set(e,t)}function to(e){me.messageHandlers.delete(e)}function $r(e){me.connectionCallbacks.includes(e)||me.connectionCallbacks.push(e)}function Zt(e,t){if(me.isHost){console.warn("Host cannot send to itself");return}if(!me.hostConnection){console.warn("Not connected to host");return}me.hostConnection.send({type:e,payload:t})}function xn(e,t,s){if(!me.isHost){console.warn("Only host can send to specific peers");return}const o=me.connections.get(e);o?o.send({type:t,payload:s}):console.warn("No connection to peer:",e)}function Ie(e,t,s=[]){if(!me.isHost){console.warn("Only host can broadcast");return}me.connections.forEach((o,n)=>{s.includes(n)||o.send({type:e,payload:t})})}function Bc(){me.isHost?(me.connections.forEach(e=>e.close()),me.connections.clear()):me.hostConnection&&(me.hostConnection.close(),me.hostConnection=null,me.hostId=null),me.peer&&(me.peer.destroy(),me.peer=null),me.messageHandlers.clear(),me.connectionCallbacks=[],me.isInitialized=!1,me.peerId=null}function Oc(){const e=me.peerId&&me.peerId.startsWith("smash-")?me.peerId.substring(6):me.peerId;return{isInitialized:me.isInitialized,isHost:me.isHost,peerId:e,hostId:me.hostId,connectedPeers:Array.from(me.connections.keys()),peerCount:me.connections.size}}const Lc=Object.freeze(Object.defineProperty({__proto__:null,broadcast:Ie,connectToHost:Pc,disconnect:Bc,getNetworkInfo:Oc,initNetwork:vi,offMessage:to,onConnectionChange:$r,onMessage:Pe,sendToHost:Zt,sendToPeer:xn},Symbol.toStringTag,{value:"Module"})),de={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!0,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null,hostInviteCode:null};async function Hc(e=null){if(e&&(de.kaplayInstance=e),de.isHost){const t=po(),s=Cs(),o=Ps();de.slots[0].playerId="local",de.slots[0].playerName=t,de.slots[0].inviteCode=s,de.slots[0].selectedCharacter=o,de.slots[0].isLocal=!0,de.slots[0].permanentUpgradeLevels={startingHealth:Je("startingHealth"),startingDamage:Je("startingDamage"),startingSpeed:Je("startingSpeed"),propDurability:Je("propDurability"),propDropChance:Je("propDropChance")},console.log("[PartySystem] Host player initialized in slot 0:",{name:de.slots[0].playerName,code:de.slots[0].inviteCode,character:de.slots[0].selectedCharacter})}else console.log("[PartySystem] Client mode - preserving existing slot assignments");if(!de.networkInitialized)try{console.log("[PartySystem] Initializing network as host...");const t=Cs(),s=await vi(t,!0);s!==t&&(console.log(`[PartySystem] Invite code changed: ${t} -> ${s}`),Mc(s),de.slots[0].inviteCode=s),de.networkInitialized=!0,de.isHost=!0,d0(),console.log("[PartySystem] Network initialized as host - ready to accept connections")}catch(t){console.error("[PartySystem] Failed to initialize network as host:",t),console.log("[PartySystem] Multiplayer disabled - running in single-player mode")}}function d0(){Pe("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const s=h0(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",t,e.permanentUpgradeLevels||null);if(s!==null){const o={slots:de.slots.map(n=>({playerId:n.playerId,playerName:n.playerName,inviteCode:n.inviteCode,selectedCharacter:n.selectedCharacter,permanentUpgradeLevels:n.permanentUpgradeLevels,isLocal:!1})),yourSlotIndex:s};console.log("[PartySystem] Sending party_sync to new player:",{hostName:o.slots[0].playerName,hostCharacter:o.slots[0].selectedCharacter,newPlayerSlot:s}),xn(t,"party_sync",o),setTimeout(()=>{Fc(t)},100),ln()}else xn(t,"join_rejected",{reason:"Party full"})}),Pe("player_info",(e,t)=>{const s=de.peerIdToSlot.get(t);s!==void 0&&(e.playerName&&(de.slots[s].playerName=e.playerName),ln())}),Pe("character_change",(e,t)=>{const s=de.peerIdToSlot.get(t);s!==void 0&&(console.log(`[PartySystem] Player in slot ${s} changed character to:`,e.selectedCharacter),de.slots[s].selectedCharacter=e.selectedCharacter,ln())}),$r((e,t)=>{e==="leave"&&g0(t)})}function oi(){return de}function yr(){return de.slots.filter(e=>e.playerId!==null).length}function Ba(){return!de.isHost&&de.hostInviteCode?de.hostInviteCode:Cs()}function h0(e,t,s,o,n=null){for(let r=1;r<de.slots.length;r++)if(de.slots[r].playerId===null)return de.slots[r].playerId=`player_${Date.now()}_${r}`,de.slots[r].playerName=e,de.slots[r].inviteCode=t,de.slots[r].selectedCharacter=s,de.slots[r].peerId=o,de.slots[r].permanentUpgradeLevels=n,de.peerIdToSlot.set(o,r),r;return null}async function u0(e){const t={playerName:po(),inviteCode:Cs(),selectedCharacter:Ps()};try{console.log("[PartySystem] Joining as client - clearing all party slots");for(let s=0;s<de.slots.length;s++)de.slots[s]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null};if(de.networkInitialized&&de.isHost){console.log("[PartySystem] Switching from host to client - disconnecting current peer...");const{disconnect:s}=await lo(async()=>{const{disconnect:o}=await Promise.resolve().then(()=>Lc);return{disconnect:o}},void 0);s(),de.networkInitialized=!1,de.isHost=!1}return de.networkInitialized||(await vi("client",!1),de.networkInitialized=!0,de.isHost=!1),de.hostInviteCode=e,p0(),await Pc(e),Zt("join_request",{playerName:t.playerName,inviteCode:t.inviteCode,selectedCharacter:t.selectedCharacter,permanentUpgradeLevels:{startingHealth:Je("startingHealth"),startingDamage:Je("startingDamage"),startingSpeed:Je("startingSpeed"),propDurability:Je("propDurability"),propDropChance:Je("propDropChance")}}),!0}catch(s){return console.error("Failed to join party:",s),console.log("[PartySystem] Restoring local player after join failure"),ni(t),!1}}function ni(e){de.networkInitialized&&!de.isHost&&lo(async()=>{const{disconnect:t}=await Promise.resolve().then(()=>Lc);return{disconnect:t}},void 0).then(({disconnect:t})=>{t()}),de.isHost=!0,de.hostInviteCode=null,de.networkInitialized=!1;for(let t=0;t<de.slots.length;t++)de.slots[t]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null};de.slots[0]={playerId:"local",playerName:e.playerName||po(),inviteCode:e.inviteCode||Cs(),selectedCharacter:e.selectedCharacter||Ps(),isLocal:!0,peerId:null},Hc(de.kaplayInstance).catch(t=>{console.warn("[PartySystem] Failed to re-initialize as host:",t)})}function p0(){Pe("party_sync",e=>{console.log("[PartySystem] Received party sync:",{hostName:e.slots[0].playerName,hostCharacter:e.slots[0].selectedCharacter,yourSlot:e.yourSlotIndex,totalSlots:e.slots.filter(s=>s.playerId!==null).length}),de.slots=e.slots,e.yourSlotIndex!==void 0&&(de.slots[e.yourSlotIndex].isLocal=!0,console.log(`[PartySystem] Marked slot ${e.yourSlotIndex} as local`)),de.slots[0].isLocal=!1;const t=de.slots.filter(s=>s.playerId!==null).length;console.log("[PartySystem] Party synced successfully:",{partySize:t,hostInSlot0:de.slots[0].playerName,localSlot:e.yourSlotIndex})}),Pe("party_update",e=>{console.log("[PartySystem] Received party update:",e);const t=de.slots.findIndex(s=>s.isLocal);de.slots=e.slots,t!==-1&&(de.slots[t].isLocal=!0,console.log(`[PartySystem] Preserved local flag for slot ${t}`))}),Pe("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),Pe("game_start",e=>{console.log("Host started game - joining..."),de.kaplayInstance?de.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),$r(e=>{if(e==="host_disconnect"){console.log("[PartySystem] Host disconnected - returning to solo party"),alert("Host disconnected - returning to main menu");const t={playerName:po(),inviteCode:Cs(),selectedCharacter:Ps()};ni(t),de.kaplayInstance&&de.kaplayInstance.go("menu")}})}function ln(){de.isHost&&Ie("party_update",{slots:de.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,permanentUpgradeLevels:e.permanentUpgradeLevels,isLocal:!1}))})}function f0(){de.isHost&&(console.log("Broadcasting game start to all clients"),Ie("game_start",{}))}function g0(e){const t=de.peerIdToSlot.get(e);t!==void 0&&(console.log("Player disconnected from slot",t),Uc(t),m0(t),de.peerIdToSlot.delete(e),ln())}function m0(e){if(e>0&&e<de.slots.length){const t=de.slots[e].peerId;return t&&de.peerIdToSlot.delete(t),de.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null},!0}return!1}function x0(){return de.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter||"survivor"}))}function y0(e){de.slots[0].selectedCharacter=e,de.networkInitialized&&(de.isHost?ln():Zt("character_change",{selectedCharacter:e}))}const _s={gatekeeper:{name:"Studio Head",coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{name:"Showrunner",coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{name:"Co-Host (Melee)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{name:"Co-Host (Ranged)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function w0(e){return _s[e]||_s.gatekeeper}function ii(e,t,s,o="gatekeeper",n=1,r=null){const a=w0(o),c=1+(n-1)*.2,l={coreChar:a.coreChar,armorChar:a.armorChar||"()",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*c),armorHealth:Math.floor((a.baseArmorHealth||0)*c),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*c),shieldHealth:Math.floor((a.baseShieldHealth||0)*c),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*c),speed:Math.floor(a.baseSpeed*(1+(n-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*c),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*c};function d(){const p=l.armorHealth>l.maxArmorHealth*.5?"(":"",h=l.armorHealth>0?")":"";return`${p}${l.coreChar}${h}`}const i=e.add([e.text(d(),{size:l.size}),e.pos(t,s),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"boss"]);return i.maxHealth=l.health,i.speed=l.speed,i.xpValue=l.xpValue,i.type=o,i.floor=n,i.textSize=l.size,i.rng=r,a.meleeDamage&&(i.meleeDamage=a.meleeDamage),a.projectileDamage&&(i.projectileDamage=a.projectileDamage),a.projectileSpeed&&(i.projectileSpeed=a.projectileSpeed),a.fireRate&&(i.fireRate=a.fireRate),(o==="twinGuardianMelee"||o==="twinGuardianRanged")&&(i.enraged=!1,i.enrage=function(){this.enraged||(this.enraged=!0,this.speed=Math.floor(this.speed*1.5),this.type==="twinGuardianMelee"?(this.chargeCooldownTimer=0,this.meleeDamage=Math.floor(this.meleeDamage*1.25)):(this.fireRate=this.fireRate*1.5,this.projectileDamage=Math.floor(this.projectileDamage*1.25)),this.color=e.rgb(255,200,0))}),i.armorHealth=l.armorHealth,i.maxArmorHealth=l.maxArmorHealth,i.damageReduction=l.damageReduction,i.coreChar=l.coreChar,i.armorChar=l.armorChar,i.armorColor=l.armorColor,i.shieldHealth=l.shieldHealth,i.maxShieldHealth=l.maxShieldHealth,i.shieldRegenRate=l.shieldRegenRate,i.shieldChar=l.shieldChar,i.shieldColor=l.shieldColor,i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.updateVisual=function(){let p="",h="",f="",g="";if(i.shieldHealth>0){const w=i.shieldHealth/i.maxShieldHealth;w>.66?(p="",h=""):w>.33?(p="",h=""):(p="",h="")}if(i.armorHealth>0){const w=i.armorHealth/i.maxArmorHealth;w>.66?(f="",g=""):w>.33?(f="",g=""):(f="",g="")}const u=`${p}${f}${i.coreChar}${g}${h}`;i.text=u,i.shieldHealth>0?i.color=e.rgb(...l.shieldColor):i.color=e.rgb(...l.color)},i.takeDamage=function(p){let h=!1,f=!1;const g=i.shieldHealth,u=i.armorHealth;i.lastDamageTime=e.time();const w=3;if(i.shieldRegenCooldown=w,i.shieldHealth>0){const v=Math.min(p,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-v),h=i.shieldHealth!==g;const A=p-v;A>0&&i.takeDamageInternal(A)}else i.takeDamageInternal(p);f=i.armorHealth!==u,(h||f)&&i.updateVisual()},i.takeDamageInternal=function(p){if(i.armorHealth>0){const h=Math.floor(p*(1-i.damageReduction)),f=Math.min(h,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-f);const g=p-h;if(g>0){const u=i.armorHealth>0?1-i.damageReduction:1,w=Math.floor(g*u);i.hurt(w)}}else i.hurt(p)},i.attackTimer=0,i.minionSpawnTimer=0,i.chargeCooldownTimer=0,i.chargeDurationTimer=0,i.radialBurstTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeSpeed=0,i.spawnedMinions=[],i.enraged=!1,i.twinPartner=null,i.getPhase=function(){const p=i.hp()/i.maxHealth;return p>.75?1:p>.5?2:3},i.spawnMinions=function(){if(!i.exists())return;const p=i.getPhase(),h=p===1?2:3;for(let f=0;f<h;f++){const g=i.rng?i.rng.next()*.5:Math.random()*.5,u=Math.PI*2/h*f+g,v=40+(i.rng?i.rng.next()*20:Math.random()*20),A=i.pos.x+Math.cos(u)*v,D=i.pos.y+Math.sin(u)*v,P=(i.rng?i.rng.next():Math.random())<.5?"rusher":"basic",m=Ys(e,A,D,P,n);m.isBossMinion=!0,i.spawnedMinions.push(m),re()&&he()&&Kt(m,{type:P,floor:n,isBossMinion:!0})}},i.radialBurst=function(){if(!i.exists())return;const p=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];i.getPhase();const h=200,f=12;p.forEach(g=>{const u=ns(e,i.pos.x,i.pos.y,g,h,f,0,0,!1);u.isBossProjectile=!0,u.color=e.rgb(255,100,100)})},i.startCharge=function(p){if(!i.exists())return;i.isCharging=!0;const h=e.vec2(p.x-i.pos.x,p.y-i.pos.y);if(h.len()>0&&(i.chargeDirection=h.unit(),!i.chargeSpeed||i.chargeSpeed===0)){const f=i.getPhase?i.getPhase():1;i.chargeSpeed=i.speed*(f===1?2.5:f===2?3:3.5)}},i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const v=1;if(i.shieldRegenTimer>=v){const A=i.shieldRegenRate*v;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+A),i.shieldRegenTimer=0,i.shieldHealth>0&&i.updateVisual()}}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!re()||he())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color,i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&i.updateVisual()}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const p=e.get("player")[0];if(!p||!p.exists())return;const h=i.getPhase();if(i.type==="gatekeeper"){i.attackTimer+=e.dt(),i.minionSpawnTimer+=e.dt(),i.radialBurstTimer+=e.dt();const v=h===1?8:h===2?6:5,A=10,D=h===1?8:h===2?6:5;if(i.isCharging){const Y=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=Y.x,i.pos.y+=Y.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{i.chargeCooldownTimer+=e.dt();const Y=e.vec2(p.pos.x-i.pos.x,p.pos.y-i.pos.y);if(Y.len()>0){const m=Y.unit(),x=i.speed*(h===1?1:h===2?1.2:1.5),E=m.scale(x*e.dt()),S=i.pos.x+E.x,I=i.pos.y+E.y;let T=!0,z=!0;const _=e.get("obstacle"),j=i.size||14;for(const q of _){if(!q.exists())continue;const k=q.pos.x-q.width/2,U=q.pos.x+q.width/2,F=q.pos.y-q.height/2,O=q.pos.y+q.height/2,J=S-j,ne=S+j,se=i.pos.y-j,Ee=i.pos.y+j;ne>k&&J<U&&Ee>F&&se<O&&(T=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0));const xe=i.pos.x-j,Ae=i.pos.x+j,Me=I-j,Oe=I+j;Ae>k&&xe<U&&Oe>F&&Me<O&&(z=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0))}T&&(i.pos.x=S),z&&(i.pos.y=I)}i.minionSpawnTimer>=v&&(i.spawnMinions(),i.minionSpawnTimer=0),i.chargeCooldownTimer>=A&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{i.exists()&&(i.color=e.rgb(...l.color),i.startCharge(p.pos))}),i.chargeCooldownTimer=0),i.radialBurstTimer>=D&&(i.radialBurst(),i.radialBurstTimer=0)}}else if(i.type==="twinGuardianMelee"){i.attackTimer+=e.dt(),i.chargeCooldownTimer+=e.dt();const v=8,A=150,D=e.vec2(p.pos.x-i.pos.x,p.pos.y-i.pos.y),Y=D.len();if(i.isCharging){const P=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=P.x,i.pos.y+=P.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1.2&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{if(Y>0){const P=D.unit(),m=i.speed*(i.enraged?1.5:1),x=P.scale(m*e.dt()),E=i.pos.x+x.x,S=i.pos.y+x.y;let I=!0,T=!0;const z=e.get("obstacle"),_=i.size||14;for(const j of z){if(!j.exists())continue;const q=j.pos.x-j.width/2,k=j.pos.x+j.width/2,U=j.pos.y-j.height/2,F=j.pos.y+j.height/2,O=E-_,J=E+_,ne=i.pos.y-_,se=i.pos.y+_;J>q&&O<k&&se>U&&ne<F&&(I=!1);const Ee=i.pos.x-_,xe=i.pos.x+_,Ae=S-_,Me=S+_;xe>q&&Ee<k&&Me>U&&Ae<F&&(T=!1)}I&&(i.pos.x=E),T&&(i.pos.y=S)}i.chargeCooldownTimer>=v&&Y<A&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{if(i.exists()){i.color=e.rgb(...l.color);const P=i.enraged?3.5:2.5;i.chargeSpeed=i.speed*P,i.startCharge(p.pos)}}),i.chargeCooldownTimer=0)}}else if(i.type==="twinGuardianRanged"){i.attackTimer+=e.dt();const v=200,A=e.vec2(p.pos.x-i.pos.x,p.pos.y-i.pos.y),D=A.len();if(D>0){const P=A.unit();let m=i.speed*(i.enraged?1.5:1);if(D<v){const x=P.scale(-m*e.dt()),E=i.pos.x+x.x,S=i.pos.y+x.y;let I=!0,T=!0;const z=e.get("obstacle"),_=i.size||14;for(const j of z){if(!j.exists())continue;const q=j.pos.x-j.width/2,k=j.pos.x+j.width/2,U=j.pos.y-j.height/2,F=j.pos.y+j.height/2,O=E-_,J=E+_,ne=i.pos.y-_,se=i.pos.y+_;J>q&&O<k&&se>U&&ne<F&&(I=!1);const Ee=i.pos.x-_,xe=i.pos.x+_,Ae=S-_,Me=S+_;xe>q&&Ee<k&&Me>U&&Ae<F&&(T=!1)}I&&(i.pos.x=E),T&&(i.pos.y=S)}else if(D>v*1.5){const x=P.scale(m*e.dt()),E=i.pos.x+x.x,S=i.pos.y+x.y;let I=!0,T=!0;const z=e.get("obstacle"),_=i.size||14;for(const j of z){if(!j.exists())continue;const q=j.pos.x-j.width/2,k=j.pos.x+j.width/2,U=j.pos.y-j.height/2,F=j.pos.y+j.height/2,O=E-_,J=E+_,ne=i.pos.y-_,se=i.pos.y+_;J>q&&O<k&&se>U&&ne<F&&(I=!1);const Ee=i.pos.x-_,xe=i.pos.x+_,Ae=S-_,Me=S+_;xe>q&&Ee<k&&Me>U&&Ae<F&&(T=!1)}I&&(i.pos.x=E),T&&(i.pos.y=S)}}const Y=1/(i.fireRate*(i.enraged?1.5:1));if(i.attackTimer>=Y){if(D>0){const P=A.unit(),m=ns(e,i.pos.x,i.pos.y,P,i.projectileSpeed,i.projectileDamage*(i.enraged?1.25:1),0,0,!1);m.isBossProjectile=!0,m.color=e.rgb(100,150,255)}i.attackTimer=0}}else if(i.type==="swarmQueen"){i.minionSpawnTimer+=e.dt();const v=i.hp()/i.maxHealth;let A;v>.66?A=5:v>.33?A=3:A=2;const D=i.spawnedMinions.filter(z=>z.exists()&&z.hp()>0);if(i.minionSpawnTimer>=A&&D.length<8){const z=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",_=(i.rng?i.rng.next():Math.random())*Math.PI*2,j=50+(i.rng?i.rng.next():Math.random())*30,q=i.pos.x+Math.cos(_)*j,k=i.pos.y+Math.sin(_)*j,U=Ys(e,q,k,z,n);U.isBossMinion=!0,i.spawnedMinions.push(U),i.spawnedMinions=i.spawnedMinions.filter(F=>F.exists()),i.minionSpawnTimer=0}const P=e.width()/2,m=e.height()/2,x=150,E=e.vec2(P-i.pos.x,m-i.pos.y),S=e.vec2(p.pos.x-i.pos.x,p.pos.y-i.pos.y),I=S.len();let T=e.vec2(0,0);if(E.len()>30&&(T=T.add(E.unit().scale(.5))),I<x&&(T=T.add(S.unit().scale(-1))),T.len()>0){const _=T.unit().scale(i.speed*e.dt()),j=i.pos.x+_.x,q=i.pos.y+_.y;let k=!0,U=!0;const F=e.get("obstacle"),O=i.size||14;for(const J of F){if(!J.exists())continue;const ne=J.pos.x-J.width/2,se=J.pos.x+J.width/2,Ee=J.pos.y-J.height/2,xe=J.pos.y+J.height/2,Ae=j-O,Me=j+O,Oe=i.pos.y-O,Be=i.pos.y+O;Me>ne&&Ae<se&&Be>Ee&&Oe<xe&&(k=!1);const _e=i.pos.x-O,ze=i.pos.x+O,ae=q-O,oe=q+O;ze>ne&&_e<se&&oe>Ee&&ae<xe&&(U=!1)}k&&(i.pos.x=j),U&&(i.pos.y=q)}}else{const v=e.vec2(p.pos.x-i.pos.x,p.pos.y-i.pos.y);if(v.len()>0){const Y=v.unit().scale(i.speed*e.dt()),P=i.pos.x+Y.x,m=i.pos.y+Y.y;let x=!0,E=!0;const S=e.get("obstacle"),I=i.size||14;for(const T of S){if(!T.exists())continue;const z=T.pos.x-T.width/2,_=T.pos.x+T.width/2,j=T.pos.y-T.height/2,q=T.pos.y+T.height/2,k=P-I,U=P+I,F=i.pos.y-I,O=i.pos.y+I;U>z&&k<_&&O>j&&F<q&&(x=!1);const J=i.pos.x-I,ne=i.pos.x+I,se=m-I,Ee=m+I;ne>z&&J<_&&Ee>j&&se<q&&(E=!1)}x&&(i.pos.x=P),E&&(i.pos.y=m)}}const f=e.width(),g=e.height(),u=20,w=i.size||14;i.pos.x=e.clamp(i.pos.x,u+w,f-u-w),i.pos.y=e.clamp(i.pos.y,u+w,g-u-w)}),i.isDead=!1,i.onDeath(()=>{re()&&he()&&i.mpEntityId&&Ei({entityId:i.mpEntityId,entityType:"boss",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue})}),o==="swarmQueen"&&i.onDeath(()=>{const p=8+Math.floor((i.rng?i.rng.next():Math.random())*5);for(let h=0;h<p;h++){const f=Math.PI*2/p*h+(i.rng?i.rng.next():Math.random())*.3,g=40+(i.rng?i.rng.next():Math.random())*20,u=i.pos.x+Math.cos(f)*g,w=i.pos.y+Math.sin(f)*g,v=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",A=Ys(e,u,w,v,n);A.isBossMinion=!0}}),i.updateVisual(),re()&&he()&&(Kt(i,{type:o,floor:n,isBoss:!0}),i.enemyType=o),i}function b0(e,t,s,o=1,n=null){const r=ii(e,t.pos.x,t.pos.y,"twinGuardianMelee",o,n),a=ii(e,s.pos.x,s.pos.y,"twinGuardianRanged",o,n);return r.twinPartner=a,a.twinPartner=r,r.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enrage(),re()&&he()&&Ar(a.networkId))}),a.onDeath(()=>{r&&r.exists()&&!r.enraged&&(r.enrage(),re()&&he()&&Ar(r.networkId))}),[r,a]}const Vs={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function v0(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const o=1+(t-1)*.1,r=Je("propDropChance")*.05;for(const[a,c]of Object.entries(Vs)){const l=c.dropChance*o+r,d=Math.min(l,1);if(Math.random()<d)return a}return null}function _i(e,t){const s=Vs[t];if(!s)return;const o=xr[s.weaponKey];if(o){if(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=s.weaponKey,e.weaponDef=o,e.fireRate=o.fireRate,e.projectileSpeed=o.projectileSpeed,e.projectileDamage=o.baseDamage,e.projectileCount=o.projectileCount,e.piercing=o.piercing,e.obstaclePiercing=o.obstaclePiercing,e.critChance=o.critChance,e.critDamage=o.critDamage,e.spreadAngle=o.spreadAngle,e.weaponRange=o.range,e.weaponCategory=o.category,o.orbitRadius&&(e.orbitRadius=o.orbitRadius,e.rotationSpeed=o.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),o.explosionRadius&&(e.explosionRadius=o.explosionRadius,e.explosionDamage=o.explosionDamage),o.chainRange&&(e.chainRange=o.chainRange,e.maxJumps=o.maxJumps,e.chainDamageReduction=o.chainDamageReduction),s.isAmmoBased)e.powerupAmmo=s.ammo,e.powerupDuration=null;else if(s.isTimeBased){const r=Je("propDurability")*2;e.powerupDuration=s.duration+r,e.powerupAmmo=null}}}function wr(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function A0(e,t=0){if(!e.powerupWeapon)return!1;const s=Vs[e.powerupWeapon];return s&&(s.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||s.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(re()&&he()&&e.slotIndex!==void 0&&Er(e.slotIndex,e.powerupWeapon),wr(e),!0):!1}function S0(e){if(!e.powerupWeapon)return;const t=Vs[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function E0(e){if(!e.powerupWeapon)return null;const t=Vs[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function en(e,t,s,o){const n=e.add([e.text("+",{size:16}),e.pos(t,s),e.anchor("center"),e.color(...nt.XP_COLOR),e.area(),"xpPickup"]);return n.value=o,n.lifetime=nt.XP_LIFETIME,n.age=0,n.collected=!1,n.magnetizing=!1,n.magnetizeSpeed=0,n.targetPlayer=null,n.isFlyingToUI=!1,n.velocityY=-150-Math.random()*100,n.gravity=600,n.groundY=s,n.bounceDamping=.5,n.bouncing=!0,n.onUpdate(()=>{if(n.isFlyingToUI){const c=e.vec2(e.width()/2,e.height()-18).sub(n.pos);c.len()<10?e.destroy(n):n.pos=n.pos.add(c.unit().scale(1e3*e.dt()));return}if(e.paused){const a=Math.sin(n.age*nt.XP_PULSE_SPEED)*nt.XP_PULSE_AMOUNT;n.scale=e.vec2(1+a);return}n.age+=e.dt();const r=Math.sin(n.age*nt.XP_PULSE_SPEED)*nt.XP_PULSE_AMOUNT;if(n.scale=e.vec2(1+r),!n.magnetizing&&n.bouncing&&(n.velocityY+=n.gravity*e.dt(),n.pos.y+=n.velocityY*e.dt(),n.pos.y>=n.groundY&&(n.pos.y=n.groundY,n.velocityY=-n.velocityY*n.bounceDamping,Math.abs(n.velocityY)<20&&(n.bouncing=!1,n.velocityY=0))),n.magnetizing&&n.targetPlayer&&n.targetPlayer.exists()){n.bouncing=!1;const a=e.vec2(n.targetPlayer.pos.x-n.pos.x,n.targetPlayer.pos.y-n.pos.y),c=a.len();if(c>0){const l=a.scale(1/c);n.magnetizeSpeed=Math.min(n.magnetizeSpeed+nt.MAGNETIZE_ACCELERATION*e.dt(),nt.MAGNETIZE_SPEED),n.pos=n.pos.add(l.scale(n.magnetizeSpeed*e.dt()))}}n.age>=n.lifetime&&e.destroy(n)}),n.pickupType="xp",re()&&he()&&Ai(n,{type:"xpPickup",value:o}),re()&&n.onDestroy(()=>{Si(n)}),n}const Oa=["$","","","","","","",""];function Vn(){return Oa[Math.floor(Math.random()*Oa.length)]}function tn(e,t,s,o,n=null){const r=n||Vn(),a=e.add([e.text(r,{size:9}),e.pos(t,s),e.anchor("center"),e.color(...nt.CURRENCY_COLOR),e.area(),"currencyPickup"]);return a.value=o,a.lifetime=nt.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.isFlyingToUI=!1,a.velocityY=-150-Math.random()*100,a.gravity=600,a.groundY=s,a.bounceDamping=.5,a.bouncing=!0,a.onUpdate(()=>{if(a.isFlyingToUI){const d=e.vec2(e.width()-20,20).sub(a.pos);d.len()<10?e.destroy(a):a.pos=a.pos.add(d.unit().scale(1e3*e.dt()));return}if(e.paused){const l=Math.sin(a.age*nt.CURRENCY_PULSE_SPEED)*nt.CURRENCY_PULSE_AMOUNT;a.scale=e.vec2(1+l);return}a.age+=e.dt();const c=Math.sin(a.age*nt.CURRENCY_PULSE_SPEED)*nt.CURRENCY_PULSE_AMOUNT;if(a.scale=e.vec2(1+c),!a.magnetizing&&a.bouncing&&(a.velocityY+=a.gravity*e.dt(),a.pos.y+=a.velocityY*e.dt(),a.pos.y>=a.groundY&&(a.pos.y=a.groundY,a.velocityY=-a.velocityY*a.bounceDamping,Math.abs(a.velocityY)<20&&(a.bouncing=!1,a.velocityY=0))),a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){a.bouncing=!1;const l=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),d=l.len();if(d>0){const i=l.scale(1/d);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+nt.MAGNETIZE_ACCELERATION*e.dt(),nt.MAGNETIZE_SPEED),a.pos=a.pos.add(i.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="currency",re()&&he()&&Ai(a,{type:"currencyPickup",value:o,icon:r}),re()&&a.onDestroy(()=>{Si(a)}),a}function La(e,t,s,o){const n=Vs[o];if(!n)return null;const r=e.add([e.text(n.icon,{size:24}),e.pos(t,s),e.anchor("center"),e.color(...n.color),e.area(),"powerupWeaponPickup"]);return r.powerupKey=o,r.lifetime=nt.CURRENCY_LIFETIME,r.age=0,r.collected=!1,r.magnetizing=!1,r.magnetizeSpeed=0,r.targetPlayer=null,r.velocityY=-150-Math.random()*100,r.gravity=600,r.groundY=s,r.bounceDamping=.5,r.bouncing=!0,r.onUpdate(()=>{if(e.paused){const c=Math.sin(r.age*4)*.15;r.scale=e.vec2(1+c),r.angle=Math.sin(r.age*2)*10;return}r.age+=e.dt();const a=Math.sin(r.age*4)*.15;if(r.scale=e.vec2(1+a),r.angle=Math.sin(r.age*2)*10,!r.magnetizing&&r.bouncing&&(r.velocityY+=r.gravity*e.dt(),r.pos.y+=r.velocityY*e.dt(),r.pos.y>=r.groundY&&(r.pos.y=r.groundY,r.velocityY=-r.velocityY*r.bounceDamping,Math.abs(r.velocityY)<20&&(r.bouncing=!1,r.velocityY=0))),r.magnetizing&&r.targetPlayer&&r.targetPlayer.exists()){r.bouncing=!1;const c=e.vec2(r.targetPlayer.pos.x-r.pos.x,r.targetPlayer.pos.y-r.pos.y),l=c.len();if(l>0){const d=c.scale(1/l);r.magnetizeSpeed=Math.min(r.magnetizeSpeed+nt.MAGNETIZE_ACCELERATION*e.dt(),nt.MAGNETIZE_SPEED),r.pos=r.pos.add(d.scale(r.magnetizeSpeed*e.dt()))}}r.age>=r.lifetime&&e.destroy(r)}),r.pickupType="powerup",re()&&he()&&Ai(r),re()&&r.onDestroy(()=>{Si(r)}),r}class Bo{constructor(t){this.seed=t>>>0,this.originalSeed=this.seed}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}range(t,s){return s<=t?(console.warn(`SeededRandom.range: Invalid range [${t}, ${s}). Returning min.`),t):Math.floor(t+this.next()*(s-t))}rangeFloat(t,s){return t+this.next()*(s-t)}choose(t){if(!(!t||t.length===0))return t[this.range(0,t.length)]}shuffle(t){const s=[...t];for(let o=s.length-1;o>0;o--){const n=this.range(0,o+1);[s[o],s[n]]=[s[n],s[o]]}return s}probability(t){return this.next()<t}reset(){this.seed=this.originalSeed}getState(){return this.seed}setState(t){this.seed=t>>>0}}function Jr(...e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e[s]|0;return t>>>0}const R={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/15,lastResyncTime:0,resyncInterval:5,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null,gameSeed:0,floorRng:null,roomRng:null,currentFloor:1,currentRoom:{x:0,y:0},pendingXP:0,onGameSeedCallback:null};function zc(e,t=0,s=null,o=null){R.isActive=!0,R.isHost=e,R.localPlayerSlot=t,R.players.clear(),R.inputBuffer=[],R.lastSyncTime=0,R.k=s,R.enemies.clear(),R.projectiles.clear(),R.pickups.clear(),R.nextEntityId=1,o!==null?R.gameSeed=o:e&&(R.gameSeed=Math.floor(Math.random()*4294967295)),R.floorRng=new Bo(R.gameSeed),R.currentFloor=1,R.currentRoom={x:0,y:0},e?M0():(ri=!1,D0())}function M0(){br||(br=!0,Pe("player_input",(e,t)=>{const s=oi(),o=s.slots.findIndex(n=>n.peerId===t);if(o!==-1&&R.players.has(o)){const n=R.players.get(o);e.move&&(n.move=e.move),e.shoot&&(n.isShooting=e.shoot),e.aimAngle!==void 0&&(n.aimAngle=e.aimAngle)}else console.warn("[Multiplayer] Could not find player for peer:",t,"slot:",o),console.warn("[Multiplayer] Party slots:",s.slots),console.warn("[Multiplayer] Registered players:",Array.from(R.players.keys()))}),Pe("pause_request",(e,t)=>{R.k&&(R.k.paused=e.paused,R.k.gameData&&R.k.gameData.updatePauseUI&&R.k.gameData.updatePauseUI(e.paused),Ie("pause_state",{paused:e.paused}))}),Pe("player_death",(e,t)=>{const s=R.players.get(e.slotIndex);s&&s.exists()&&(s.isDead=!0,s.canMove=!1,s.canShoot=!1,s.isShooting=!1,s.opacity=.5,s.outline&&s.outline.exists()&&(s.outline.opacity=.5),Ie("player_death",{slotIndex:e.slotIndex},[t]))}),Pe("enemy_death",(e,t)=>{Ie("entity_destroyed",{entityId:e.entityId,entityType:e.entityType,x:e.x,y:e.y})}),Pe("resync_request",(e,t)=>{xn(t,"game_state",Qr())}),Pe("level_up_queued",(e,t)=>{Ie("level_up_queued",{slotIndex:e.slotIndex,level:e.level,timestamp:Date.now()})}),Pe("player_emote",(e,t)=>{Ie("player_emote",e)}),Pe("upgrade_selected",(e,t)=>{const s=R.players.get(e.slotIndex);s&&s.exists()&&lo(async()=>{const{applyUpgrade:o,recalculateAllUpgrades:n}=await Promise.resolve().then(()=>pg);return{applyUpgrade:o,recalculateAllUpgrades:n}},void 0).then(({applyUpgrade:o,recalculateAllUpgrades:n})=>{o(s,e.upgradeKey),s.upgradeStacks||(s.upgradeStacks={}),s.upgradeStacks[e.upgradeKey]=(s.upgradeStacks[e.upgradeKey]||0)+1,s.selectedUpgrades||(s.selectedUpgrades=new Set),s.selectedUpgrades.add(e.upgradeKey),n(s)}),Ie("upgrade_selected",{slotIndex:e.slotIndex,upgradeKey:e.upgradeKey,timestamp:Date.now()})}),Pe("synergy_activated",(e,t)=>{Ie("synergy_activated",{slotIndex:e.slotIndex,synergies:e.synergies,timestamp:Date.now()})}))}let ri=!1,br=!1;function D0(){ri||(ri=!0,Pe("game_state",e=>{if(R.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==R.localPlayerSlot){const s=R.players.get(t.slotIndex);s&&s.exists()&&(s.netTarget?(s.netTarget.x=t.x,s.netTarget.y=t.y):s.netTarget={x:t.x,y:t.y},s.angle=t.angle||0,s.outline&&s.outline.exists()&&(s.outline.angle=s.angle),t.maxHealth!==void 0&&(s.maxHealth=t.maxHealth),t.hp!==void 0&&s.setHP&&s.setHP(t.hp),t.invulnerable!==void 0&&(s.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(s.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(s.isDead=t.isDead,s.isDead?(s.canShoot=!1,s.canMove=!1,s.isShooting=!1,s.opacity=.5,s.outline&&s.outline.exists()&&(s.outline.opacity=.5)):(s.canShoot=!0,s.canMove=!0,s.opacity=1,s.outline&&s.outline.exists()&&(s.outline.opacity=1))),t.weapons&&(s.weapons=t.weapons),t.passiveUpgrades&&(s.passiveUpgrades=t.passiveUpgrades),t.upgradeStacks&&(s.upgradeStacks=t.upgradeStacks),t.speed!==void 0&&(s.speed=t.speed),t.damage!==void 0&&(s.damage=t.damage),t.pickupRadius!==void 0&&(s.pickupRadius=t.pickupRadius))}else{const s=R.players.get(R.localPlayerSlot);s&&s.exists()&&(t.hp!==void 0&&s.setHP&&s.setHP(t.hp),t.maxHealth!==void 0&&(s.maxHealth=t.maxHealth),t.invulnerable!==void 0&&(s.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(s.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(s.isDead=t.isDead,s.isDead?(s.canShoot=!1,s.canMove=!1,s.isShooting=!1,s.opacity=.5,s.outline&&s.outline.exists()&&(s.outline.opacity=.5)):(s.canShoot=!0,s.canMove=!0,s.opacity=1,s.outline&&s.outline.exists()&&(s.outline.opacity=1))))}}),e.enemies){const t=new Set;e.enemies.forEach(s=>{t.add(s.id);const o=R.enemies.get(s.id);o&&o.exists()&&(o.netTarget?(o.netTarget.x=s.x,o.netTarget.y=s.y):o.netTarget={x:s.x,y:s.y},s.maxHealth!==void 0&&(o.maxHealth=s.maxHealth),o.setHP&&s.hp!==void 0&&o.setHP(s.hp),s.shieldHealth!==void 0&&(o.shieldHealth=s.shieldHealth),s.armorHealth!==void 0&&(o.armorHealth=s.armorHealth),o.updateVisual&&o.updateVisual())}),R.enemies.forEach((s,o)=>{!t.has(o)&&s.exists()&&(s.cleanupHealthBars&&typeof s.cleanupHealthBars=="function"&&s.cleanupHealthBars(),R.k.destroy(s),R.enemies.delete(o))})}if(e.pickups){const t=new Set;e.pickups.forEach(s=>{t.add(s.id);const o=R.pickups.get(s.id);if(o&&o.exists()){if(o.pos.x=s.x,o.pos.y=s.y,s.magnetizing!==void 0&&(o.magnetizing=s.magnetizing,s.magnetizing&&s.targetPlayerSlot!==void 0)){const n=R.players.get(s.targetPlayerSlot);n&&n.exists()&&(o.targetPlayer=n)}s.isFlyingToUI!==void 0&&(o.isFlyingToUI=s.isFlyingToUI)}}),R.pickups.forEach((s,o)=>{!t.has(o)&&s.exists()&&(R.k.destroy(s),R.pickups.delete(o))})}}}),Pe("spawn_entity",e=>{if(R.k){if(e.entityType==="enemy"){let t;e.isBoss?t=ii(R.k,e.x,e.y,e.type,e.floor):t=Ys(R.k,e.x,e.y,e.type,e.floor),t.mpEntityId=e.id,e.isBossMinion&&(t.isBossMinion=!0),R.enemies.set(e.id,t)}else if(e.entityType==="xpPickup"){const t=en(R.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",R.pickups.set(e.id,t)}else if(e.entityType==="currencyPickup"){const t=tn(R.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",R.pickups.set(e.id,t)}}}),Pe("spawn_projectile",e=>{R.k&&lo(async()=>{const{createProjectile:t}=await Promise.resolve().then(()=>I0);return{createProjectile:t}},void 0).then(({createProjectile:t})=>{const s=R.k.vec2(e.directionX,e.directionY),o=t(R.k,e.x,e.y,s,e.speed,e.damage,e.piercing,e.obstaclePiercing,e.isCrit,e.maxRange);(e.char||e.color)&&(o.text=e.char,e.color&&(o.color=R.k.rgb(...e.color))),o.mpEntityId=e.id,R.projectiles.set(e.id,o)})}),Pe("damage_dealt",e=>{if(!R.k)return;const t=R.k.add([R.k.text(e.damage.toString(),{size:e.isCrit?24:18}),R.k.pos(e.x,e.y),R.k.anchor("center"),R.k.color((e.isCrit,255),e.isCrit?200:255,e.isCrit?0:255),R.k.opacity(1),R.k.lifespan(.8),R.k.z(1e3)]);t.onUpdate(()=>{t.pos.y-=50*R.k.dt(),t.opacity-=1.25*R.k.dt()});const s=R.enemies.get(e.targetId);if(s&&s.exists()){const o=s.color;s.color=R.k.rgb(255,255,255),R.k.wait(.1,()=>{s.exists()&&(s.color=o)})}}),Pe("entity_destroyed",e=>{if(!R.k)return;const t=R.enemies.get(e.entityId)||R.pickups.get(e.entityId);t&&t.exists()&&(t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),R.k.destroy(t),(e.entityType==="pickup"||e.entityType==="xpPickup"||e.entityType==="currencyPickup")&&R.pickups.delete(e.entityId)),R.enemies.delete(e.entityId),R.projectiles.delete(e.entityId),R.pickups.delete(e.entityId)}),Pe("boss_enrage",e=>{if(!R.k)return;const t=R.enemies.get(e.networkId);t&&t.exists()&&t.enrage&&t.enrage()}),Pe("players_revived",e=>{R.k&&R.players.forEach((t,s)=>{if(t&&t.exists()&&(t.hp()<=0||t.isDead)){const o=Math.max(1,Math.floor(t.maxHealth*.05));t.setHP(o),t.isDead=!1,s===R.localPlayerSlot&&(t.canMove=!0,t.canShoot=!0);const n=R.k.add([R.k.text(" REVIVED ",{size:16}),R.k.pos(t.pos.x,t.pos.y-40),R.k.anchor("center"),R.k.color(100,255,100),R.k.opacity(1),R.k.lifespan(2),R.k.z(1e3)]);n.onUpdate(()=>{n.pos.y-=30*R.k.dt(),n.opacity-=.5*R.k.dt()}),t.opacity=1,t.characterData&&(t.color=R.k.rgb(...t.characterData.color)),t.outline&&t.outline.exists()&&(t.outline.opacity=1)}})}),Pe("game_seed",e=>{R.gameSeed=e.seed,R.floorRng=new Bo(R.gameSeed),e.roomTemplateKey&&(R.firstRoomTemplateKey=e.roomTemplateKey,console.log("[Multiplayer] Client received first room template:",e.roomTemplateKey)),R.onGameSeedCallback&&(R.onGameSeedCallback(),R.onGameSeedCallback=null)}),Pe("pause_state",e=>{R.k&&(R.k.paused=e.paused,R.k.gameData&&R.k.gameData.updatePauseUI&&R.k.gameData.updatePauseUI(e.paused))}),Pe("xp_gain",e=>{const t=R.players.get(R.localPlayerSlot);t&&t.exists()&&!t.isDead&&t.addXP?t.addXP(e.value):R.pendingXP+=e.value}),Pe("currency_gain",e=>{lo(async()=>{const{addCurrency:t}=await Promise.resolve().then(()=>n0);return{addCurrency:t}},void 0).then(({addCurrency:t})=>{t(e.value)})}),Pe("enemy_split",e=>{R.k&&R.k.gameData&&R.k.gameData.incrementSplitEnemies&&R.k.gameData.incrementSplitEnemies(e.count)}),Pe("player_death",e=>{const t=R.players.get(e.slotIndex);t&&t.exists()&&(t.isDead=!0,t.canMove=!1,t.canShoot=!1,t.isShooting=!1,t.opacity=.5,t.outline&&t.outline.exists()&&(t.outline.opacity=.5))}),Pe("player_disconnected",e=>{const t=R.players.get(e.slotIndex);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),R.k.destroy(t),R.players.delete(e.slotIndex))}),Pe("host_quit",e=>{ks(),R.k&&R.k.go("menu")}))}function vr(e,t){R.players.set(e,t),t.mpSlotIndex=e}function Uc(e){const t=R.players.get(e);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),R.k&&R.k.destroy(t),R.players.delete(e),R.isHost&&Nc(e))}function Nc(e){R.isHost&&Ie("player_disconnected",{slotIndex:e})}function _c(e){if(R.isActive)if(R.lastSyncTime+=e,R.lastResyncTime+=e,R.isHost)R.lastSyncTime>=R.syncInterval&&(R0(),R.lastSyncTime=0),R.lastResyncTime>=R.resyncInterval&&(R.players.forEach((t,s)=>{t&&t.exists()&&(t.isDead&&t.hp()>0&&(console.warn("[Multiplayer] Desync detected: Player",s,"is marked dead but has HP. Correcting..."),t.setHP(0)),!t.isDead&&t.hp()<=0&&(console.warn("[Multiplayer] Desync detected: Player",s,"has no HP but not marked dead. Correcting..."),t.isDead=!0,t.canMove=!1,t.canShoot=!1))}),R.lastResyncTime=0);else{if(R.lastSyncTime>=R.syncInterval&&(C0(),R.lastSyncTime=0),R.lastResyncTime>=R.resyncInterval){let s=!1;R.players.forEach((o,n)=>{o&&o.exists()&&(o.isDead&&o.hp()>0&&(console.warn("[Multiplayer] Client desync: Player",n,"is dead but has HP"),s=!0),!o.isDead&&o.hp()<=0&&(console.warn("[Multiplayer] Client desync: Player",n,"has no HP but not dead"),s=!0))}),s&&ud(),R.lastResyncTime=0}const t=Math.min(e*10,1);R.players.forEach(s=>{s.exists()&&s.isRemote&&s.netTarget&&(s.pos.x+=(s.netTarget.x-s.pos.x)*t,s.pos.y+=(s.netTarget.y-s.pos.y)*t)}),R.enemies.forEach(s=>{s.exists()&&s.netTarget&&(s.pos.x+=(s.netTarget.x-s.pos.x)*t,s.pos.y+=(s.netTarget.y-s.pos.y)*t)})}}function Qr(){const e=[],t=[],s=[],o=[];return R.players.forEach((n,r)=>{if(n.exists()){let a=[],c=[],l={};try{n.weapons&&(a=JSON.parse(JSON.stringify(n.weapons))),n.passiveUpgrades&&(c=JSON.parse(JSON.stringify(n.passiveUpgrades))),n.upgradeStacks&&(l=JSON.parse(JSON.stringify(n.upgradeStacks)))}catch(i){console.warn("Failed to serialize player upgrades:",i)}let d=n.maxHealth;n.hp&&typeof n.hp=="function"?d=n.hp():typeof n.hp=="number"&&(d=n.hp),e.push({slotIndex:Number(r),x:Number(n.pos.x),y:Number(n.pos.y),angle:Number(n.angle||0),hp:Number(d),maxHealth:Number(n.maxHealth||100),level:Number(n.level||1),xp:Number(n.xp||0),isDead:!!n.isDead,weapons:a,passiveUpgrades:c,upgradeStacks:l,speed:Number(n.speed||0),damage:Number(n.damage||0),pickupRadius:Number(n.pickupRadius||0),invulnerable:!!n.invulnerable,invulnerableTime:Number(n.invulnerableTime||0)})}}),R.enemies.forEach((n,r)=>{if(n.exists()){let a=0;n.hp&&typeof n.hp=="function"?a=n.hp():typeof n.hp=="number"&&(a=n.hp),t.push({id:Number(r),x:Number(n.pos.x),y:Number(n.pos.y),hp:Number(a),maxHealth:Number(n.maxHealth||0),type:String(n.enemyType||"basic"),shieldHealth:Number(n.shieldHealth||0),armorHealth:Number(n.armorHealth||0)})}else R.enemies.delete(r)}),R.projectiles.forEach((n,r)=>{n.exists()||R.projectiles.delete(r)}),R.pickups.forEach((n,r)=>{if(n.exists()){const a={id:Number(r),x:Number(n.pos.x),y:Number(n.pos.y),type:String(n.pickupType||"xp"),magnetizing:!!n.magnetizing,isFlyingToUI:!!n.isFlyingToUI};n.magnetizing&&n.targetPlayer&&n.targetPlayer.slotIndex!==void 0&&(a.targetPlayerSlot=Number(n.targetPlayer.slotIndex)),o.push(a)}else R.pickups.delete(r)}),{players:e,enemies:t,projectiles:s,pickups:o}}function R0(){R.isHost&&Ie("game_state",Qr())}function Fc(e){!R.isHost||!R.isActive||(console.log("Sending initial game state to new joiner:",e),xn(e,"game_state",Qr()))}function C0(){if(R.isHost)return;const e=R.players.get(R.localPlayerSlot);if(!e||!e.exists())return;const t=e.moveDir?{x:Number(e.moveDir.x||0),y:Number(e.moveDir.y||0)}:{x:0,y:0};Zt("player_input",{slotIndex:Number(R.localPlayerSlot),move:t,shoot:!!e.isShooting,aimAngle:Number(e.aimAngle||0)})}function re(){return R.isActive}function qc(){return R.players.size}function ks(){R.isActive=!1,R.players.clear(),R.inputBuffer=[],R.enemies.clear(),R.projectiles.clear(),R.pickups.clear(),R.nextEntityId=1,ri=!1,br=!1}function Kt(e,t={}){if(!R.isHost)return null;const s=R.nextEntityId++;return e.mpEntityId=s,R.enemies.set(s,e),Ie("spawn_entity",{id:s,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1,isBoss:t.isBoss||!1,isBossMinion:t.isBossMinion||!1}),s}function Eo(e,t={}){if(!R.isHost)return null;const s=R.nextEntityId++;e.mpEntityId=s,R.projectiles.set(s,e);let o=[255,255,100];return e.color&&e.color.r!==void 0&&(o=[Math.round(e.color.r),Math.round(e.color.g),Math.round(e.color.b)]),Ie("spawn_projectile",{id:Number(s),x:Number(e.pos.x),y:Number(e.pos.y),directionX:Number(e.direction.x),directionY:Number(e.direction.y),speed:Number(e.speed),damage:Number(e.damage),piercing:Number(e.piercing||0),obstaclePiercing:Number(e.obstaclePiercing||0),isCrit:!!e.isCrit,maxRange:Number(e.maxRange),angle:Number(e.angle||0),char:e.text||t.char||"*",color:o}),s}function Yc(e){R.isActive&&e.mpEntityId!==void 0&&R.projectiles.delete(e.mpEntityId)}function Ai(e,t={}){if(!R.isHost)return null;const s=R.nextEntityId++;e.mpEntityId=s,R.pickups.set(s,e);const o={id:s,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(o.icon=t.icon),Ie("spawn_entity",o),s}function Si(e){R.isActive&&e.mpEntityId!==void 0&&R.pickups.delete(e.mpEntityId)}function he(){return R.isHost}function Xc(e){!R.isHost||!R.isActive||Ie("damage_dealt",{targetId:Number(e.targetId),targetType:String(e.targetType),damage:Number(e.damage),isCrit:!!e.isCrit,attackerId:e.attackerId!==void 0?Number(e.attackerId):null,x:Number(e.x),y:Number(e.y)})}function Ei(e){!R.isHost||!R.isActive||Ie("entity_destroyed",{entityId:Number(e.entityId),entityType:String(e.entityType),x:Number(e.x),y:Number(e.y),xpDropped:e.xpDropped!==void 0?Number(e.xpDropped):0,currencyDropped:e.currencyDropped!==void 0?Number(e.currencyDropped):0})}function Ar(e){!R.isHost||!R.isActive||Ie("boss_enrage",{networkId:e})}function T0(){!R.isHost||!R.isActive||Ie("players_revived",{timestamp:Date.now()})}function Sr(e,t,s=[]){!R.isHost||!R.isActive||Ie("game_over",{runStats:e,currencyEarned:t,partyStats:s,timestamp:Date.now()})}function Gc(){!R.isHost||!R.isActive||Ie("host_quit",{timestamp:Date.now()})}function Kc(e){!R.isHost||!R.isActive||Ie("powerup_weapon_applied",{powerupKey:e,timestamp:Date.now()})}function Vc(e,t){R.isActive&&(R.isHost?Ie("upgrade_selected",{slotIndex:e,upgradeKey:t,timestamp:Date.now()}):Zt("upgrade_selected",{slotIndex:e,upgradeKey:t}))}function Wc(e,t){R.isActive&&(R.isHost?Ie("level_up_queued",{slotIndex:e,level:t,timestamp:Date.now()}):Zt("level_up_queued",{slotIndex:e,level:t}))}function jc(e,t){R.isActive&&(R.isHost?Ie("synergy_activated",{slotIndex:e,synergies:t,timestamp:Date.now()}):Zt("synergy_activated",{slotIndex:e,synergies:t}))}function Er(e,t){!R.isHost||!R.isActive||Ie("powerup_expired",{slotIndex:e,powerupKey:t,timestamp:Date.now()})}function Mr(){return R.gameSeed!==0}function $c(e){R.onGameSeedCallback=e}function Jc(e){R.currentFloor=e;const t=Jr(R.gameSeed,e);R.floorRng=new Bo(t)}function Nt(){const e=Jr(R.gameSeed,R.currentFloor,R.currentRoom.x,R.currentRoom.y);return new Bo(e)}function Qc(){const e=R.firstRoomTemplateKey;return R.firstRoomTemplateKey=null,e}function Zc(){return R.floorRng}function kc(e,t){const s=Jr(R.gameSeed,e,t);return new Bo(s)}function ed(e=null){R.isHost&&Ie("game_seed",{seed:R.gameSeed,roomTemplateKey:e})}function td(e){R.isHost&&Ie("pause_state",{paused:e})}function sd(e){R.isHost||Zt("pause_request",{paused:e})}function od(e){R.isHost||Zt("enemy_death",e)}function nd(e,t=null){R.isHost&&Ie("obstacle_data",{obstacles:e,doorStates:t})}function id(){R.isHost&&Ie("room_completed",{})}function rd(e){R.isHost&&Ie("xp_gain",{value:e})}function ad(e){R.isHost&&Ie("currency_gain",{value:e})}function ld(){const e=R.pendingXP;return R.pendingXP=0,e}function Dr(e,t){R.isHost?Ie("player_emote",{slotIndex:e,emoteType:t}):Zt("player_emote",{slotIndex:e,emoteType:t})}function cd(e,t=null,s=null,o=null,n=null){R.isHost&&Ie("room_transition",{entryDirection:e,allPlayerStats:t,gridDirection:s,currentFloor:o,roomTemplateKey:n})}function dd(e){R.isHost&&Ie("enemy_split",{count:e})}function hd(e){R.isActive&&(R.isHost?Ie("player_death",{slotIndex:e}):Zt("player_death",{slotIndex:e}))}function ud(){R.isHost||Zt("resync_request",{timestamp:Date.now()})}const P0=Object.freeze(Object.defineProperty({__proto__:null,broadcastBossEnrage:Ar,broadcastCurrencyGain:ad,broadcastDamageEvent:Xc,broadcastDeathEvent:Ei,broadcastEmote:Dr,broadcastEnemySplit:dd,broadcastGameOver:Sr,broadcastGameSeed:ed,broadcastHostQuit:Gc,broadcastLevelUpQueued:Wc,broadcastObstacles:nd,broadcastPauseState:td,broadcastPlayerDeath:hd,broadcastPlayerDisconnect:Nc,broadcastPowerupExpired:Er,broadcastPowerupWeaponApplied:Kc,broadcastRevivalEvent:T0,broadcastRoomCompletion:id,broadcastRoomTransition:cd,broadcastSynergyActivated:jc,broadcastUpgradeSelected:Vc,broadcastXPGain:rd,cleanupMultiplayer:ks,getAndClearPendingXP:ld,getFirstRoomTemplateKey:Qc,getFloorRNG:Zc,getPlayerCount:qc,getRoomRNG:Nt,getUpgradeRNG:kc,handlePlayerDisconnect:Uc,hasGameSeed:Mr,initMultiplayerGame:zc,isHost:he,isMultiplayerActive:re,onGameSeedReceived:$c,registerEnemy:Kt,registerPickup:Ai,registerPlayer:vr,registerProjectile:Eo,requestResync:ud,sendEnemyDeath:od,sendInitialGameState:Fc,sendPauseRequest:sd,setCurrentFloor:Jc,unregisterPickup:Si,unregisterProjectile:Yc,updateMultiplayer:_c},Symbol.toStringTag,{value:"Module"}));function ns(e,t,s,o,n,r,a=0,c=0,l=!1,d=null){const i=Math.atan2(o.y,o.x)*(180/Math.PI)+90,p=e.add([e.text("*",{size:16}),e.pos(t,s),e.anchor("center"),e.color(255,l?200:255,l?0:100),e.rotate(i),e.area(),"projectile"]);return p.damage=r,p.piercing=a,p.obstaclePiercing=c,p.piercedEnemies=new Set,p.piercedObstacles=new Set,p.isCrit=l,p.maxRange=d||Ro.DEFAULT_WEAPON_RANGE,p.distanceTraveled=0,p.direction=o,p.speed=n,p.useWeaponVisual=function(h){h&&h.char&&(p.text=h.char),h&&h.color&&(p.isCrit||(p.color=e.rgb(...h.color))),h&&h.range&&(p.maxRange=h.range)},p.onUpdate(()=>{if(e.paused)return;const h=p.direction.scale(p.speed*e.dt()),f=h.len();if(p.distanceTraveled+=f,p.pos.x+=h.x,p.pos.y+=h.y,p.distanceTraveled>=p.maxRange){e.destroy(p);return}(p.pos.x<0||p.pos.x>e.width()||p.pos.y<0||p.pos.y>e.height())&&e.destroy(p)}),re()&&he()&&Eo(p),re()&&p.onDestroy(()=>{Yc(p)}),p}const I0=Object.freeze(Object.defineProperty({__proto__:null,createProjectile:ns},Symbol.toStringTag,{value:"Module"})),Co={rusher:{name:"Security Guard",char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{name:"Camera Operator",char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.53,projectileSpeed:200,projectileDamage:7},zombie:{name:"Audience Member",char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{name:"Fan",char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{name:"Stagehand",char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{name:"Head of Security",char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{name:"Camera Director",char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{name:"Bouncer",char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{name:"Runner",char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{name:"Pyrotechnics Tech",char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{name:"Floor Manager",char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},mage:{name:"Lighting Director",char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{name:"Stage Manager",char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{name:"Set Designer",char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{name:"Editor",char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{name:"Casting Director",char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{name:"Assistant Director",char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},healer:{name:"Producer",char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{name:"Executive Producer",char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{name:"Network Executive",char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{name:"Talent Agent",char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},basic:{name:"Crew Member",char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{name:"Camera Operator",char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{name:"Runner",char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function B0(e){return Co[e]||Co.basic}const gs=32,O0=100;class L0{constructor(){this.elements=[]}enqueue(t,s){this.elements.push({element:t,priority:s}),this.elements.sort((o,n)=>o.priority-n.priority)}dequeue(){return this.elements.shift()?.element}isEmpty(){return this.elements.length===0}}function Ha(e,t){return{gx:Math.floor(e/gs),gy:Math.floor(t/gs)}}function pd(e,t){return{x:e*gs+gs/2,y:t*gs+gs/2}}function Fi(e,t,s,o,n){if(t<0||s<0||t>=o||s>=n)return!1;const r=pd(t,s),a=e.get("obstacle");for(const c of a){if(!c.exists())continue;const l=gs/2,d=r.x-l,i=r.x+l,p=r.y-l,h=r.y+l,f=c.pos.x-c.width/2,g=c.pos.x+c.width/2,u=c.pos.y-c.height/2,w=c.pos.y+c.height/2;if(i>f&&d<g&&h>u&&p<w)return!1}return!0}function H0(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function z0(e,t,s,o,n){const r=e.width(),a=e.height(),c=Math.ceil(r/gs),l=Math.ceil(a/gs),d=Ha(t,s),i=Ha(o,n);if(!Fi(e,d.gx,d.gy,c,l)||!Fi(e,i.gx,i.gy,c,l))return[];const p=new L0;p.enqueue(d,0);const h=new Map,f=new Map,g=D=>`${D.gx},${D.gy}`;h.set(g(d),null),f.set(g(d),0);let u=0;const w=c*l;for(;!p.isEmpty()&&u<w;){u++;const D=p.dequeue();if(D.gx===i.gx&&D.gy===i.gy)break;const Y=[{gx:D.gx+1,gy:D.gy},{gx:D.gx-1,gy:D.gy},{gx:D.gx,gy:D.gy+1},{gx:D.gx,gy:D.gy-1},{gx:D.gx+1,gy:D.gy+1},{gx:D.gx+1,gy:D.gy-1},{gx:D.gx-1,gy:D.gy+1},{gx:D.gx-1,gy:D.gy-1}];for(const P of Y){if(!Fi(e,P.gx,P.gy,c,l))continue;const x=P.gx!==D.gx&&P.gy!==D.gy?1.4:1,E=f.get(g(D))+x,S=g(P);if(!f.has(S)||E<f.get(S)){f.set(S,E);const I=E+H0(P,i);p.enqueue(P,I),h.set(S,D)}}}const v=[];let A=i;for(;A&&h.has(g(A));){const D=pd(A.gx,A.gy);if(v.unshift(D),A=h.get(g(A)),v.length>O0)break}return v}function U0(e,t,s,o){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=z0(e,t.pos.x,t.pos.y,s,o),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const a=t.pathfindingPath[t.pathfindingWaypointIndex];if(a){const c=e.vec2(a.x-t.pos.x,a.y-t.pos.y),l=c.len();if(l<gs/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),l>0)return c.unit()}}const n=e.vec2(s-t.pos.x,o-t.pos.y);return n.len()>0?n.unit():e.vec2(0,0)}function N0(e,t){const s=e.width(),o=e.height(),n=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:n});const r=t.perimeterMode;t.speed*e.dt();const a=20,c=e.vec2(r.targetX-t.pos.x,r.targetY-t.pos.y),l=c.len();if(l<a)switch(r.side){case"top":r.side="right",r.targetX=s-n,r.targetY=n;break;case"right":r.side="bottom",r.targetX=s-n,r.targetY=o-n;break;case"bottom":r.side="left",r.targetX=n,r.targetY=o-n;break;case"left":r.side="top",r.targetX=n,r.targetY=n;break}return l>0?c.unit():e.vec2(0,0)}function Ys(e,t,s,o="basic",n=1,r=null){const a=B0(o),c=1+(n-1)*.3,l={char:a.char,color:a.color,health:Math.floor(a.baseHealth*c),speed:Math.floor(a.baseSpeed*(1+(n-1)*.1)),size:a.size,xpValue:Math.floor(a.baseXPValue*c),behavior:a.behavior};function d(){return l.char}const i=e.add([e.text(d(),{size:l.size}),e.pos(t,s),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"enemy"]);i.originalColor=l.color,i.maxHealth=l.health,i.speed=l.speed,i.xpValue=l.xpValue,i.type=o,i.behavior=l.behavior,i.floor=n,i.pathfindingMode=a.pathfindingMode||"none",a.damage&&(i.damage=a.damage),a.fireRate&&(i.fireRate=a.fireRate),a.projectileSpeed&&(i.projectileSpeed=a.projectileSpeed),a.projectileDamage&&(i.projectileDamage=a.projectileDamage),a.chargeCooldown&&(i.chargeCooldown=a.chargeCooldown),a.splits&&(i.splits=!0),a.explodes&&(i.explodes=!0,i.explosionDamage=a.explosionDamage,i.explosionRadius=a.explosionRadius,a.shrapnel&&(i.shrapnel=!0,i.shrapnelCount=a.shrapnelCount||8));let p=0,h=0,f=0;if(n>=2){const x=r?r.next():Math.random();n>=2&&(o==="zombie"||o==="turret"||o==="heavyTank"||x<.3)&&(p=Math.floor(15+(n-2)*5))}if(n>=3){const x=r?r.next():Math.random();(o==="shooter"||o==="turret"||o==="wraith"||x<.2)&&(h=Math.floor(10+(n-3)*5),f=1+(n-3)*.5)}if(n>=4){const x=r?r.next():Math.random();(o==="heavyTank"||o==="spawner"||x<.1)&&(p===0&&(p=Math.floor(20+(n-4)*5)),h===0&&(h=Math.floor(15+(n-4)*5),f=1.5+(n-4)*.5))}const g=(a.baseArmorHealth||0)+p;i.armorHealth=Math.floor(g*c),i.maxArmorHealth=Math.floor(g*c),i.damageReduction=a.damageReduction||(g>0?.2:0),i.armorChar=a.armorChar||"[]",i.armorColor=a.armorColor||[200,200,200];const u=(a.baseShieldHealth||0)+h;i.shieldHealth=Math.floor(u*c),i.maxShieldHealth=Math.floor(u*c),i.shieldRegenRate=((a.shieldRegenRate||0)+f)*c,i.shieldChar=a.shieldChar||"{}",i.shieldColor=a.shieldColor||[100,200,255],i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.originalColor=l.color,i.coreChar=l.char,i.updateVisual=function(){let x="",E="",S="",I="";if(i.shieldHealth>0){const z=i.shieldHealth/i.maxShieldHealth;z>.66?(x="",E=""):z>.33?(x="",E=""):(x="",E="")}if(i.armorHealth>0){const z=i.armorHealth/i.maxArmorHealth;z>.66?(S="",I=""):z>.33?(S="",I=""):(S="",I="")}const T=`${x}${S}${i.coreChar}${I}${E}`;i.text=T,i.shieldHealth>0?i.color=e.rgb(...i.shieldColor):i.color=e.rgb(...i.originalColor)},i.takeDamage=function(x){let E=!1,S=!1;const I=i.shieldHealth,T=i.armorHealth;i.lastDamageTime=e.time();const z=3;if(i.shieldRegenCooldown=z,i.shieldHealth>0){const _=Math.min(x,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-_),E=i.shieldHealth!==I;const j=x-_;j>0&&i.takeDamageInternal(j)}else i.takeDamageInternal(x);S=i.armorHealth!==T,(E||S)&&i.updateVisual()},i.takeDamageInternal=function(x){if(i.armorHealth>0){const E=Math.floor(x*(1-i.damageReduction)),S=Math.min(E,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-S);const I=x-E;if(I>0){const T=i.armorHealth>0?1-i.damageReduction:1,z=Math.floor(I*T);i.hurt(z)}}else i.hurt(x)},a.blocksProjectiles&&(i.blocksProjectiles=!0),a.teleportCooldown&&(i.teleportCooldown=a.teleportCooldown),a.teleportRange&&(i.teleportRange=a.teleportRange),a.spawnInterval&&(i.spawnInterval=a.spawnInterval),a.spawnType&&(i.spawnType=a.spawnType),a.buffRadius&&(i.buffRadius=a.buffRadius),a.buffAmount&&(i.buffAmount=a.buffAmount),a.healRadius&&(i.healRadius=a.healRadius),a.healAmount&&(i.healAmount=a.healAmount),a.healInterval&&(i.healInterval=a.healInterval),a.slowRadius&&(i.slowRadius=a.slowRadius),a.slowAmount&&(i.slowAmount=a.slowAmount),a.lifesteal&&(i.lifesteal=a.lifesteal),i.updateVisual(),i.attackTimer=0,i.chargeTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeDuration=0,i.chargePauseTimer=0,i.teleportTimer=0,i.spawnTimer=0,i.healTimer=0,i.buffedEnemies=new Set,i.stuckTimer=0,i.stuckThreshold=1,i.lastPosition={x:t,y:s},i.lastPositionUpdateTime=0,i.avoidanceDirection=null,i.avoidanceTimer=0;const w=30,v=3,A=-20,D=e.add([e.rect(w,v),e.pos(t,s+A),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),Y=e.add([e.rect(w,v),e.pos(t,s+A),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);i.healthBarBg=D,i.healthBar=Y,i.showHealthThreshold=.5,D.hidden=!0,Y.hidden=!0,i.onUpdate(()=>{if(i.exists()&&i.healthBar&&i.healthBarBg){const x=i.hp()/i.maxHealth;if(x<i.showHealthThreshold&&x>0){i.healthBarBg.hidden=!1,i.healthBar.hidden=!1,i.healthBarBg.pos.x=i.pos.x,i.healthBarBg.pos.y=i.pos.y+A,i.healthBar.pos.x=i.pos.x,i.healthBar.pos.y=i.pos.y+A;const S=w*x;i.healthBar.width=Math.max(1,S),i.healthBar.pos.x=i.pos.x-(w-S)/2}else i.healthBarBg.hidden=!0,i.healthBar.hidden=!0}}),i.cleanupHealthBars=function(){i.healthBarBg&&i.healthBarBg.exists()&&e.destroy(i.healthBarBg),i.healthBar&&i.healthBar.exists()&&e.destroy(i.healthBar)};const P=(x,E)=>{const S=e.get("obstacle"),I=i.size||12;for(const T of S){if(!T.exists())continue;const z=T.pos.x-T.width/2,_=T.pos.x+T.width/2,j=T.pos.y-T.height/2,q=T.pos.y+T.height/2,k=x-I,U=x+I,F=E-I,O=E+I;if(U>z&&k<_&&O>j&&F<q)return!1}return!0},m=x=>{const E=x.len(),S=E>0?x.unit():e.vec2(0,0);i.lastPositionUpdateTime+=e.dt(),i.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(i.pos.x-i.lastPosition.x,2)+Math.pow(i.pos.y-i.lastPosition.y,2))<5?i.stuckTimer+=i.lastPositionUpdateTime:i.stuckTimer=0,i.lastPosition={x:i.pos.x,y:i.pos.y},i.lastPositionUpdateTime=0);const I=i.pos.x+x.x,T=i.pos.y+x.y;if(P(I,T))return i.avoidanceDirection=null,i.avoidanceTimer=0,x;if(i.avoidanceTimer-=e.dt(),i.stuckTimer>=i.stuckThreshold||i.avoidanceTimer<=0){const z=e.vec2(-S.y,S.x),_=e.vec2(S.y,-S.x),j=[z.scale(E),_.scale(E),e.vec2(z.x*.7+S.x*.3,z.y*.7+S.y*.3).unit().scale(E),e.vec2(_.x*.7+S.x*.3,_.y*.7+S.y*.3).unit().scale(E),e.vec2(z.x*.5+S.x*.5,z.y*.5+S.y*.5).unit().scale(E),e.vec2(_.x*.5+S.x*.5,_.y*.5+S.y*.5).unit().scale(E)];for(const q of j){const k=i.pos.x+q.x,U=i.pos.y+q.y;if(P(k,U))return i.avoidanceDirection=e.vec2(q.x,q.y).unit(),i.avoidanceTimer=.8,q}if(i.avoidanceDirection){const q=i.avoidanceDirection.scale(E),k=i.pos.x+q.x,U=i.pos.y+q.y;if(P(k,U))return q}return P(I,i.pos.y)?e.vec2(x.x,0):P(i.pos.x,T)?e.vec2(0,x.y):e.vec2(0,0)}else if(i.avoidanceDirection){const z=i.avoidanceDirection.scale(E),_=i.pos.x+z.x,j=i.pos.y+z.y;if(P(_,j))return z;i.avoidanceDirection=null,i.avoidanceTimer=0}return P(I,i.pos.y)?e.vec2(x.x,0):P(i.pos.x,T)?e.vec2(0,x.y):e.vec2(0,0)};return i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead){if((!re()||he())&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const U=1;if(i.shieldRegenTimer>=U){const F=i.shieldRegenRate*U;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+F),i.shieldRegenTimer=0}}i.shieldHealth>0&&i.updateVisual&&i.updateVisual()}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!re()||he())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const E=e.get("player").filter(U=>U.exists()&&!U.isDead&&U.hp()>0);if(E.length===0)return;let S=E[0],I=Math.sqrt(Math.pow(S.pos.x-i.pos.x,2)+Math.pow(S.pos.y-i.pos.y,2));for(let U=1;U<E.length;U++){const F=E[U],O=Math.sqrt(Math.pow(F.pos.x-i.pos.x,2)+Math.pow(F.pos.y-i.pos.y,2));O<I&&(I=O,S=F)}const T=e.vec2(S.pos.x-i.pos.x,S.pos.y-i.pos.y),z=T.len();if(i.behavior==="turret"){if(i.attackTimer+=e.dt(),z>0&&i.attackTimer>=1/i.fireRate){const U=T.unit(),F=ns(e,i.pos.x,i.pos.y,U,i.projectileSpeed,i.projectileDamage,0,0,!1);F.isEnemyProjectile=!0,F.color=e.rgb(...i.originalColor),i.attackTimer=0}return}if(i.behavior==="shoot"){i.attackTimer+=e.dt();const U=150;let F=e.vec2(0,0);if(z>U*1.2?F=T.unit().scale(i.speed*e.dt()):z<U*.8&&(F=T.unit().scale(-i.speed*e.dt())),z>0&&i.attackTimer>=1/i.fireRate){const O=T.unit(),J=ns(e,i.pos.x,i.pos.y,O,i.projectileSpeed,i.projectileDamage,0,0,!1);J.isEnemyProjectile=!0,J.color=e.rgb(...i.originalColor),i.attackTimer=0}if(F.len()>0){const O=m(F);i.pos.x+=O.x,i.pos.y+=O.y;const J=20,ne=i.size||12;i.pos.x=e.clamp(i.pos.x,J+ne,e.width()-J-ne),i.pos.y=e.clamp(i.pos.y,J+ne,e.height()-J-ne)}return}if(i.behavior==="charge"){if(i.chargeTimer+=e.dt(),i.isCharging)if(i.chargeDuration+=e.dt(),i.chargeDuration>=.8)i.isCharging=!1,i.chargeDuration=0,i.chargePauseTimer=0;else{const F=i.chargeDirection.scale(i.speed*e.dt()),O=m(F);O.len()<F.len()*.3?(i.isCharging=!1,i.chargePauseTimer=.1):(i.pos.x+=O.x,i.pos.y+=O.y)}else if(i.chargePauseTimer>0)i.chargePauseTimer+=e.dt(),i.chargePauseTimer>=1&&(i.chargePauseTimer=0,i.chargeTimer=0);else if(i.chargeTimer>=i.chargeCooldown)i.color=e.rgb(255,255,0),e.wait(.2,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor),z>0&&(i.isCharging=!0,i.chargeDirection=T.unit(),i.chargeDuration=0))}),i.chargeTimer=0;else{const F=T.unit().scale(i.speed*.5*e.dt()),O=m(F);O.len()<F.len()*.5&&i.isCharging&&(i.isCharging=!1,i.chargePauseTimer=.1),i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="erratic"){if(z>0){const U=T.unit(),F=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),J=e.vec2(U.x+F.x,U.y+F.y).unit().scale(i.speed*e.dt()),ne=m(J);i.pos.x+=ne.x,i.pos.y+=ne.y}return}if(i.behavior==="shield"){if(z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="teleport"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&z>0){const U=T.unit(),F=e.vec2(i.pos.x+U.x*i.teleportRange,i.pos.y+U.y*i.teleportRange);P(F.x,F.y)&&(i.pos.x=F.x,i.pos.y=F.y,i.teleportTimer=0,i.color=e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}))}else if(z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="spawner"){if(i.spawnTimer+=e.dt(),i.spawnTimer>=i.spawnInterval){const U=Math.random()*Math.PI*2,F=30,O=i.pos.x+Math.cos(U)*F,J=i.pos.y+Math.sin(U)*F;if(P(O,J)){const ne=Ys(e,O,J,i.spawnType||"rusher",i.floor);ne.isBossMinion=!0,i.spawnTimer=0}}if(z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="buffer"){if(i.attackTimer+=e.dt(),i.attackTimer>=1){const U=e.get("enemy");for(const F of U){if(!F.exists()||F===i)continue;e.vec2(F.pos.x-i.pos.x,F.pos.y-i.pos.y).len()<=i.buffRadius?(F.buffed||(F.buffed=!0,F.originalSpeed=F.speed,F.originalDamage=F.damage||10),F.speed=F.originalSpeed*(1+i.buffAmount),F.damage=F.originalDamage*(1+i.buffAmount),i.buffedEnemies.add(F)):i.buffedEnemies.has(F)&&(F.buffed&&(F.speed=F.originalSpeed,F.damage=F.originalDamage,F.buffed=!1),i.buffedEnemies.delete(F))}i.attackTimer=0}if(z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="healer"){if(i.healTimer+=e.dt(),i.healTimer>=i.healInterval){const U=e.get("enemy");for(const F of U){if(!F.exists()||F===i)continue;if(e.vec2(F.pos.x-i.pos.x,F.pos.y-i.pos.y).len()<=i.healRadius){const ne=F.hp(),se=F.maxHealth;if(ne<se){const Ee=Math.min(se,ne+i.healAmount);F.setHP(Ee);const xe=e.add([e.text("+",{size:16}),e.pos(F.pos.x,F.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{xe.exists()&&e.destroy(xe)})}}}i.healTimer=0}if(z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="teleportPlayer"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&z<=80){const U=Math.random()*Math.PI*2,F=S.pos.x+Math.cos(U)*i.teleportRange,O=S.pos.y+Math.sin(U)*i.teleportRange,J=Math.max(50,Math.min(e.width()-50,F)),ne=Math.max(50,Math.min(e.height()-50,O));S.pos.x=J,S.pos.y=ne,i.teleportTimer=0;const se=e.add([e.text("!",{size:24}),e.pos(S.pos.x,S.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{se.exists()&&e.destroy(se)})}if(z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="freeze"){if(z<=i.slowRadius?(S.slowed||(S.slowed=!0,S.originalSpeed=S.speed),S.speed=S.originalSpeed*(1-i.slowAmount)):S.slowed&&(S.speed=S.originalSpeed,S.slowed=!1),z>0){const F=T.unit().scale(i.speed*e.dt()),O=m(F);i.pos.x+=O.x,i.pos.y+=O.y}return}if(i.behavior==="rush"&&z>0){let U;if(i.pathfindingMode==="smart")U=U0(e,i,S.pos.x,S.pos.y);else{const O=T.unit().scale(i.speed*e.dt());U=m(O).unit()}i.pos.x+=U.x*i.speed*e.dt(),i.pos.y+=U.y*i.speed*e.dt()}if(i.behavior==="perimeter"){const U=N0(e,i);i.pos.x+=U.x*i.speed*e.dt(),i.pos.y+=U.y*i.speed*e.dt()}const _=e.width(),j=e.height(),q=20,k=i.size||12;i.pos.x=e.clamp(i.pos.x,q+k,_-q-k),i.pos.y=e.clamp(i.pos.y,q+k,j-q-k)}),i.isDead=!1,i.onDeath(()=>{if(i.behavior==="buffer"&&i.buffedEnemies)for(const x of i.buffedEnemies)x.exists()&&x.buffed&&(x.speed=x.originalSpeed,x.damage=x.originalDamage,x.buffed=!1)}),i.onDeath(()=>{if(re()&&he()&&i.mpEntityId&&Ei({entityId:i.mpEntityId,entityType:"enemy",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue}),i.splits&&i.hp()<=0){if(re()&&!he())return;const x=2;for(let E=0;E<x;E++){const S=Math.PI*2/x*E,I=20,T=i.pos.x+Math.cos(S)*I,z=i.pos.y+Math.sin(S)*I,_=Ys(e,T,z,"slime",i.floor);_.maxHealth=Math.floor(_.maxHealth/2),_.setHP(_.maxHealth),_.size=Math.floor(_.size*.8),_.splits=!1,_.isSplitEnemy=!0,re()&&he()&&Kt&&Kt(_,{maxHealth:_.maxHealth,floor:i.floor})}e.gameData&&e.gameData.incrementSplitEnemies&&e.gameData.incrementSplitEnemies(x),re()&&he()&&dd(x)}if(i.explodes&&i.hp()<=0){(!re()||he())&&e.get("player").forEach(S=>{if(S&&S.exists()&&!S.isDead&&e.vec2(S.pos.x-i.pos.x,S.pos.y-i.pos.y).len()<=i.explosionRadius&&!S.invulnerable){const z=Math.max(1,i.explosionDamage-(S.defense||0));S.hurt(z),S.invulnerable=!0,S.invulnerableTime=S.invulnerableDuration,S.color=e.rgb(255,100,100)}});const x=e.add([e.text("*",{size:24}),e.pos(i.pos.x,i.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{x.exists()&&e.destroy(x)})}}),re()&&he()&&(Kt(i,{type:o,floor:n}),i.enemyType=o),i}const yn={brute:{name:"Security Chief",coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{name:"Technical Director",coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{name:"Stunt Coordinator",coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{name:"Studio Manager",coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{name:"Creative Director",coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function _0(e){return yn[e]||yn.brute}function F0(e,t,s,o="brute",n=1){const r=_0(o),a=1+(n-1)*.2,c={coreChar:r.coreChar,armorChar:r.armorChar||"[]",shieldChar:r.shieldChar||"{}",color:r.color,armorColor:r.armorColor||[200,200,200],shieldColor:r.shieldColor||[100,200,255],health:Math.floor(r.baseHealth*a),armorHealth:Math.floor((r.baseArmorHealth||0)*a),maxArmorHealth:Math.floor((r.baseArmorHealth||0)*a),shieldHealth:Math.floor((r.baseShieldHealth||0)*a),maxShieldHealth:Math.floor((r.baseShieldHealth||0)*a),speed:Math.floor(r.baseSpeed*(1+(n-1)*.05)),size:r.size,xpValue:Math.floor(r.baseXPValue*a),damageReduction:r.damageReduction||0,shieldRegenRate:(r.shieldRegenRate||0)*a},l=e.add([e.text(c.coreChar,{size:c.size}),e.pos(t,s),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"miniboss"]);return l.maxHealth=c.health,l.speed=c.speed,l.xpValue=c.xpValue,l.type=o,l.floor=n,r.meleeDamage&&(l.meleeDamage=r.meleeDamage),r.projectileDamage&&(l.projectileDamage=r.projectileDamage),r.projectileSpeed&&(l.projectileSpeed=r.projectileSpeed),r.fireRate&&(l.fireRate=r.fireRate),l.armorHealth=c.armorHealth,l.maxArmorHealth=c.maxArmorHealth,l.damageReduction=c.damageReduction,l.coreChar=c.coreChar,l.armorChar=c.armorChar,l.armorColor=c.armorColor,l.shieldHealth=c.shieldHealth,l.maxShieldHealth=c.maxShieldHealth,l.shieldRegenRate=c.shieldRegenRate,l.shieldChar=c.shieldChar,l.shieldColor=c.shieldColor,l.shieldRegenTimer=0,l.shieldRegenCooldown=0,l.lastDamageTime=0,l.attackTimer=0,l.chargeCooldownTimer=0,l.chargeDurationTimer=0,l.isCharging=!1,l.chargeDirection=null,l.chargeSpeed=0,l.updateVisual=function(){let d="",i="",p="",h="";if(l.shieldHealth>0){const g=l.shieldHealth/l.maxShieldHealth;g>.66?(d="",i=""):g>.33?(d="",i=""):(d="",i="")}if(l.armorHealth>0){const g=l.armorHealth/l.maxArmorHealth;g>.66?(p="",h=""):g>.33?(p="",h=""):(p="",h="")}const f=`${d}${p}${l.coreChar}${h}${i}`;l.text=f,l.shieldHealth>0?l.color=e.rgb(...c.shieldColor):l.color=e.rgb(...c.color)},l.takeDamage=function(d){let i=!1,p=!1;const h=l.shieldHealth,f=l.armorHealth;l.lastDamageTime=e.time();const g=3;if(l.shieldRegenCooldown=g,l.shieldHealth>0){const u=Math.min(d,l.shieldHealth);l.shieldHealth=Math.max(0,l.shieldHealth-u),i=l.shieldHealth!==h;const w=d-u;w>0&&l.takeDamageInternal(w)}else l.takeDamageInternal(d);p=l.armorHealth!==f,(i||p)&&l.updateVisual()},l.takeDamageInternal=function(d){if(l.armorHealth>0){const i=Math.floor(d*(1-l.damageReduction)),p=Math.min(i,l.armorHealth);l.armorHealth=Math.max(0,l.armorHealth-p);const h=d-i;if(h>0){const f=l.armorHealth>0?1-l.damageReduction:1,g=Math.floor(h*f);l.hurt(g)}}else l.hurt(d)},l.startCharge=function(d){if(!l.exists())return;l.isCharging=!0;const i=e.vec2(d.x-l.pos.x,d.y-l.pos.y);i.len()>0&&(l.chargeDirection=i.unit(),l.chargeSpeed=l.speed*2.5)},l.onUpdate(()=>{if(e.paused)return;if(l.shieldRegenRate>0&&l.shieldHealth<l.maxShieldHealth&&l.hp()>0&&!l.isDead&&(l.shieldRegenCooldown>0&&(l.shieldRegenCooldown-=e.dt()),l.shieldRegenCooldown<=0)){l.shieldRegenTimer+=e.dt();const w=1;if(l.shieldRegenTimer>=w){const v=l.shieldRegenRate*w;l.shieldHealth=Math.min(l.maxShieldHealth,l.shieldHealth+v),l.shieldRegenTimer=0,l.shieldHealth>0&&l.updateVisual()}}l.burnDuration>0&&l.hp()>0&&!l.isDead&&(l.burnTimer=(l.burnTimer||0)+e.dt(),l.burnTimer>=.5&&((!re()||he())&&(l.takeDamage?l.takeDamage(l.burnDamage):l.hurt(l.burnDamage)),l.color,l.color=e.rgb(255,150,50),e.wait(.1,()=>{l.exists()&&l.updateVisual()}),l.burnTimer=0),l.burnDuration-=e.dt(),l.burnDuration<=0&&(l.burnDamage=0,l.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const i=e.vec2(d.pos.x-l.pos.x,d.pos.y-l.pos.y),p=i.len();if(r.behavior==="charge"){l.attackTimer+=e.dt(),l.chargeCooldownTimer+=e.dt();const w=6,v=200;if(l.isCharging){const A=l.chargeDirection.scale(l.chargeSpeed*e.dt());l.pos.x+=A.x,l.pos.y+=A.y,l.chargeDurationTimer+=e.dt(),l.chargeDurationTimer>=1&&(l.isCharging=!1,l.chargeDurationTimer=0,l.chargeCooldownTimer=0)}else{if(p>0){const D=i.unit().scale(l.speed*e.dt());l.pos.x+=D.x,l.pos.y+=D.y}l.chargeCooldownTimer>=w&&p<v&&(l.color=e.rgb(255,255,0),e.wait(.3,()=>{l.exists()&&(l.color=e.rgb(...c.color),l.startCharge(d.pos))}),l.chargeCooldownTimer=0)}}else if(r.behavior==="shoot"){l.attackTimer+=e.dt();const w=180;if(p>0){const A=i.unit();let D=l.speed;if(p<w){const Y=A.scale(-D*e.dt());l.pos.x+=Y.x,l.pos.y+=Y.y}else if(p>w*1.5){const Y=A.scale(D*e.dt());l.pos.x+=Y.x,l.pos.y+=Y.y}}const v=1/l.fireRate;if(l.attackTimer>=v){if(p>0){const A=i.unit(),D=ns(e,l.pos.x,l.pos.y,A,l.projectileSpeed,l.projectileDamage,0,0,!1);D.isBossProjectile=!0,D.color=e.rgb(...c.color)}l.attackTimer=0}}else if(r.behavior==="rush"&&p>0){const v=i.unit().scale(l.speed*e.dt());l.pos.x+=v.x,l.pos.y+=v.y}const h=e.width(),f=e.height(),g=20,u=l.size||24;l.pos.x=e.clamp(l.pos.x,g+u,h-g-u),l.pos.y=e.clamp(l.pos.y,g+u,f-g-u)}),l.isDead=!1,l.updateVisual(),l}function q0(e,t,s,o){const n=e.add([e.rect(40,40),e.pos(t,s),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return n.direction=o,n.open=!1,n.isSpawnDoor=!1,n.blocked=!1,n.gridDirection=null,n.parts=[],n.updateVisual=()=>{n.parts.forEach(a=>{a.exists()&&e.destroy(a)}),n.parts=[];let r;if(n.blocked?r=e.rgb(80,80,80):n.open?r=e.rgb(100,255,100):n.isSpawnDoor?r=e.rgb(200,50,50):r=e.rgb(200,200,100),o==="north"||o==="south"){const a=n.blocked?"":n.open?"":"",c=e.add([e.text(a,{size:24}),e.pos(t,s),e.anchor("center"),e.color(r),e.fixed(),e.z(100)]);n.parts.push(c);const l=e.add([e.text(n.open?"":"",{size:20}),e.pos(t-35,s),e.anchor("center"),e.color(r),e.fixed(),e.z(100)]);n.parts.push(l);const d=e.add([e.text(n.open?"":"",{size:20}),e.pos(t+35,s),e.anchor("center"),e.color(r),e.fixed(),e.z(100)]);n.parts.push(d)}else{const a=n.blocked?["","",""]:n.open?["","",""]:["","",""],c=16;for(let i=0;i<a.length;i++){const p=(i-1)*c,h=e.add([e.text(a[i],{size:24}),e.pos(t,s+p),e.anchor("center"),e.color(r),e.fixed(),e.z(100)]);n.parts.push(h)}const l=e.add([e.text(n.open?"":"",{size:20}),e.pos(t,s-c*1.5),e.anchor("center"),e.color(r),e.fixed(),e.z(100)]);n.parts.push(l);const d=e.add([e.text(n.open?"":"",{size:20}),e.pos(t,s+c*1.5),e.anchor("center"),e.color(r),e.fixed(),e.z(100)]);n.parts.push(d)}if(n.blocked){const a=e.add([e.text("X",{size:28}),e.pos(t,s),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);n.parts.push(a)}},Object.defineProperty(n,"color",{get:()=>n._color,set:r=>{n._color=r,n.parts.forEach(a=>{a.exists()&&(a.color=r)})}}),Object.defineProperty(n,"text",{get:()=>n._text||"=",set:r=>{n._text=r}}),n.onDestroy(()=>{n.parts.forEach(r=>{r.exists()&&e.destroy(r)}),n.parts=[]}),n.updateVisual(),n}function za(e,t,s,o,n,r="wall",a="#",c=null){const l=r==="wall",d=l?e.rgb(100,100,100):e.rgb(140,140,140),i=l?e.rgb(80,80,80):e.rgb(120,120,120),p=e.add([e.rect(o,n),e.pos(t,s),e.anchor("center"),e.color(c||d),e.outline(2,c||i),e.area({width:o,height:n}),e.fixed(),"obstacle",r==="wall"?"wall":"cover"]);return p.type=r,p.width=o,p.height=n,p}class Ua{constructor(t=128){this.cellSize=t,this.cells=new Map,this.entityToCell=new Map}getCellKey(t,s){const o=Math.floor(t/this.cellSize),n=Math.floor(s/this.cellSize);return`${o},${n}`}insert(t){if(!t||!t.pos)return;const s=this.getCellKey(t.pos.x,t.pos.y);this.cells.has(s)||this.cells.set(s,new Set),this.cells.get(s).add(t),this.entityToCell.set(t,s)}remove(t){if(!t)return;const s=this.entityToCell.get(t);if(!s)return;const o=this.cells.get(s);o&&(o.delete(t),o.size===0&&this.cells.delete(s)),this.entityToCell.delete(t)}update(t){if(!t||!t.pos)return;const s=this.entityToCell.get(t),o=this.getCellKey(t.pos.x,t.pos.y);s!==o&&(this.remove(t),this.insert(t))}getNearby(t,s,o){const n=[],r=Math.ceil(o/this.cellSize),a=this.getCellKey(t,s),[c,l]=a.split(",").map(Number);for(let d=-r;d<=r;d++)for(let i=-r;i<=r;i++){const p=`${c+d},${l+i}`,h=this.cells.get(p);h&&n.push(...h)}return n}getInBounds(t,s,o,n){const r=[],a=Math.floor(t/this.cellSize),c=Math.floor(s/this.cellSize),l=Math.floor(o/this.cellSize),d=Math.floor(n/this.cellSize);for(let i=a;i<=l;i++)for(let p=c;p<=d;p++){const h=`${i},${p}`,f=this.cells.get(h);f&&r.push(...f)}return r}getAt(t,s){const o=this.getCellKey(t,s),n=this.cells.get(o);return n?[...n]:[]}clear(){this.cells.clear(),this.entityToCell.clear()}getStats(){let t=0,s=0,o=1/0;return this.cells.forEach(n=>{const r=n.size;t+=r,s=Math.max(s,r),o=Math.min(o,r)}),{cellCount:this.cells.size,totalEntities:t,averageEntitiesPerCell:this.cells.size>0?(t/this.cells.size).toFixed(2):0,maxEntitiesInCell:s,minEntitiesInCell:o===1/0?0:o,cellSize:this.cellSize}}}let cn=null,fd=.3;function gd(){return cn||(cn=new(window.AudioContext||window.webkitAudioContext)),cn}function Zr(){return cn||gd(),cn}function De(e,t,s="square",o=.3,n={}){const r=Zr(),a=r.currentTime,c=r.createOscillator();c.type=s,c.frequency.setValueAtTime(e,a),n.pitchBend&&c.frequency.exponentialRampToValueAtTime(e*n.pitchBend,a+t);const l=r.createGain(),d=o*fd,i=n.attack||.01;l.gain.setValueAtTime(0,a),l.gain.linearRampToValueAtTime(d,a+i);const p=n.decay||.1;l.gain.setValueAtTime(d,a+t-p),l.gain.exponentialRampToValueAtTime(.01,a+t),c.connect(l),l.connect(r.destination),c.start(a),c.stop(a+t)}function Oo(e,t=.3,s={}){const o=Zr(),n=o.currentTime,r=o.sampleRate*e,a=o.createBuffer(1,r,o.sampleRate),c=a.getChannelData(0);for(let g=0;g<r;g++)c[g]=Math.random()*2-1;const l=o.createBufferSource();l.buffer=a;const d=o.createBiquadFilter();d.type=s.filterType||"lowpass",d.frequency.setValueAtTime(s.filterFreq||2e3,n);const i=o.createGain(),p=t*fd,h=s.attack||.01,f=s.decay||.1;i.gain.setValueAtTime(0,n),i.gain.linearRampToValueAtTime(p,n+h),i.gain.setValueAtTime(p,n+e-f),i.gain.exponentialRampToValueAtTime(.01,n+e),l.connect(d),d.connect(i),i.connect(o.destination),l.start(n),l.stop(n+e)}function ye(e,t=.1){return e*(1+(Math.random()-.5)*t)}function md(){const e=Math.random();e<.33?De(ye(280,.15),.08,"triangle",.14,{attack:.002,decay:.05,pitchBend:.65}):e<.66?De(ye(320,.15),.09,"sine",.13,{attack:.003,decay:.06,pitchBend:.7}):De(ye(300,.15),.07,"triangle",.14,{attack:.002,decay:.04,pitchBend:.6})}function Y0(){const e=Math.random();e<.33?De(ye(220,.3),.04,"triangle",.08,{attack:.001,decay:.025,pitchBend:.5}):e<.66?De(ye(240,.3),.035,"sine",.09,{attack:.001,decay:.02,pitchBend:.6}):De(ye(200,.3),.045,"triangle",.08,{attack:.001,decay:.03,pitchBend:.4})}function X0(){const e=ye(60,.15);De(e,.1,"sine",.12,{attack:.002,decay:.08,pitchBend:.4}),Oo(ye(.04,.2),ye(.12,.2),{attack:.002,decay:.06,filterType:"lowpass",filterFreq:ye(800,.3)})}function G0(){De(ye(350,.2),.05,"triangle",.12,{attack:.001,decay:.03,pitchBend:.3}),De(ye(50,.15),.1,"sine",.1,{attack:.001,decay:.07,pitchBend:.5})}function K0(){Oo(.08,ye(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:ye(800,.5)})}function V0(){De(ye(55,.2),.15,"sine",.1,{attack:.002,decay:.12,pitchBend:.4}),De(ye(100,.2),.12,"triangle",.08,{attack:.005,decay:.08,pitchBend:.5})}function W0(){De(ye(250,.3),.08,"triangle",.1,{attack:.001,decay:.06,pitchBend:1.6}),Oo(ye(.03,.3),.08,{attack:.001,decay:.04,filterType:"bandpass",filterFreq:ye(2e3,.4)})}function j0(){De(ye(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function $0(){md()}function Na(){const e=Math.random();e<.25?De(ye(280,.2),.06,"sine",.12,{attack:.002,decay:.04,pitchBend:.2}):e<.5?De(ye(320,.2),.05,"triangle",.12,{attack:.002,decay:.035,pitchBend:.15}):e<.75?De(ye(240,.2),.07,"sine",.14,{attack:.003,decay:.05,pitchBend:.25}):De(ye(360,.2),.05,"triangle",.1,{attack:.002,decay:.03,pitchBend:.1})}function Hs(){const e=Math.random();e<.33?(De(ye(180,.2),.1,"triangle",.18,{attack:.003,decay:.07,pitchBend:.2}),De(ye(400,.2),.06,"sine",.1,{attack:.005,decay:.04,pitchBend:.1})):e<.66?(De(ye(160,.2),.12,"triangle",.18,{attack:.003,decay:.08,pitchBend:.25}),De(ye(320,.2),.07,"sine",.12,{attack:.005,decay:.05,pitchBend:.15})):(De(ye(200,.2),.11,"triangle",.18,{attack:.003,decay:.08,pitchBend:.3}),De(ye(440,.2),.05,"sine",.08,{attack:.005,decay:.03,pitchBend:.1}))}function _a(){const e=Math.random();e<.33?De(ye(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(De(ye(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),Oo(.15,.12,{attack:.05,decay:.1,filterFreq:ye(1500,.4)})):De(ye(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function xd(){De(ye(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),De(ye(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),Oo(ye(.3,.2),ye(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:ye(1200,.5)})}function J0(){const e=Math.random();e<.33?De(ye(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?De(ye(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):De(ye(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function Fa(){const e=Math.random();e<.33?(De(ye(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{De(ye(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(De(ye(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),De(ye(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(De(ye(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{De(ye(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function Q0(){Zr().currentTime;const t=400;[1,1.25,1.5,2].forEach((o,n)=>{setTimeout(()=>{De(t*o,.15,"square",.2,{attack:.01,decay:.1})},n*80)})}function qi(){De(ye(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Ot(){De(ye(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function Dt(){De(ye(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function Z0(){De(ye(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{De(ye(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function qa(){De(ye(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{De(ye(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function k0(){for(let t=0;t<8;t++)setTimeout(()=>{De(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{xd()},480)}function eg(){[400,500,600,800].forEach((t,s)=>{setTimeout(()=>{De(t,.2,"square",.18,{attack:.01,decay:.15})},s*100)})}function Ln(){De(ye(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{De(ye(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function Yi(){De(ye(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),Oo(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:ye(500,.3)})}function tg(){De(ye(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function Ya(){De(ye(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function sg(e){const t=e?.toLowerCase()||"";t.includes("pistol")?md():t.includes("smg")||t.includes("submachine")?Y0():t.includes("shotgun")?X0():t.includes("sniper")||t.includes("rifle")?G0():t.includes("flame")||t.includes("thrower")?K0():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?V0():t.includes("chain")||t.includes("lightning")?W0():t.includes("orbital")?j0():$0()}function ai(e,t,s,o={}){const{char:n="*",size:r=12,color:a=[255,255,255],velocity:c={x:0,y:0},gravity:l=0,lifetime:d=1,fadeStart:i=.3,friction:p=.95,zIndex:h=100}=o,f=e.add([e.text(n,{size:r}),e.pos(t,s),e.anchor("center"),e.color(...a),e.z(h),"particle"]);return f.velocity={x:c.x,y:c.y},f.gravity=l,f.friction=p,f.lifetime=d,f.fadeStart=i,f.age=0,f.initialOpacity=1,f}function og(e){e.get("particle").forEach(s=>{if(!s.exists())return;if(s.age+=e.dt(),s.age>=s.lifetime){e.destroy(s);return}s.pos.x+=s.velocity.x*e.dt()*60,s.pos.y+=s.velocity.y*e.dt()*60,s.velocity.y+=s.gravity*e.dt()*60,s.velocity.x*=s.friction,s.velocity.y*=s.friction;const o=s.age/s.lifetime;if(o>=s.fadeStart){const n=(o-s.fadeStart)/(1-s.fadeStart);s.opacity=s.initialOpacity*(1-n)}})}function Bt(e,t,s,o={}){const{count:n=8,color:r=[255,50,50],speed:a=2,isCrit:c=!1}=o,l=[".",",","'","`","*"],d=c?n*1.5:n,i=c?a*1.5:a,p=c?[255,200,0]:r;for(let h=0;h<d;h++){const f=Math.PI*2*h/d+(Math.random()-.5)*.5,g=.5+Math.random()*.5,u={x:Math.cos(f)*i*g,y:Math.sin(f)*i*g};ai(e,t,s,{char:l[Math.floor(Math.random()*l.length)],size:8+Math.random()*6,color:p,velocity:u,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function Hn(e,t,s,o={}){const{count:n=12,color:r=[255,100,100],speed:a=3,isBoss:c=!1,isMiniboss:l=!1}=o,d=["*","+","x","X","#"],i=c?n*2:l?n*1.5:n,p=c?a*1.5:l?a*1.2:a;for(let f=0;f<i;f++){const g=Math.PI*2*f/i,u=.7+Math.random()*.6,w={x:Math.cos(g)*p*u,y:Math.sin(g)*p*u};ai(e,t,s,{char:d[Math.floor(Math.random()*d.length)],size:12+Math.random()*8,color:r,velocity:w,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const h=Math.floor(i/2);for(let f=0;f<h;f++){const g=Math.random()*Math.PI*2,u=.3+Math.random()*.4,w={x:Math.cos(g)*p*u*.5,y:Math.sin(g)*p*u*.5};ai(e,t,s,{char:d[Math.floor(Math.random()*d.length)],size:16+Math.random()*8,color:[255,200,100],velocity:w,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}function Go(e,t,s,o,n={}){const{count:r=5,color:a=[255,255,100],speed:c=2.5,isCrit:l=!1}=n,d=["","","",""],i=l?r*2:r,p=l?[255,200,0]:a,h=Math.sqrt(o.x*o.x+o.y*o.y),f=h>0?{x:o.x/h,y:o.y/h}:{x:1,y:0};for(let g=0;g<i;g++){const u=(Math.random()-.5)*Math.PI*.6,w=Math.atan2(f.y,f.x)+u,v=.6+Math.random()*.8,A={x:Math.cos(w)*c*v,y:Math.sin(w)*c*v};ai(e,t,s,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*4,color:p,velocity:A,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}const yd="superSmashTexty_settings",wn={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:1},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showHitFreeze:!0,showDamageNumbers:!0,compactHUD:!1},gameplay:{autoPause:!1}};function kr(){try{const e=localStorage.getItem(yd);if(e){const t=JSON.parse(e);return wd(wn,t)}}catch(e){console.error("Error loading settings:",e)}return{...wn}}function wd(e,t){const s={...e};return Xi(e)&&Xi(t)&&Object.keys(t).forEach(o=>{Xi(t[o])?o in e?s[o]=wd(e[o],t[o]):Object.assign(s,{[o]:t[o]}):Object.assign(s,{[o]:t[o]})}),s}function Xi(e){return e&&typeof e=="object"&&!Array.isArray(e)}function bd(e){try{return localStorage.setItem(yd,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function Xa(){return kr()}function Ss(e,t,s){const o=kr();return o[e]||(o[e]={}),o[e][t]=s,bd(o),o}function vd(e,t){return kr()[e]?.[t]??wn[e]?.[t]}function ng(){return bd({...wn}),{...wn}}let $t=null,ps=null,so=0,Mo=0,Rr=!1;function ig(e){$t=e}function zs(e=5,t=.1){$t&&vd("visual","showScreenShake")&&(so<=0&&(ps=$t.camPos()),Mo=Math.max(Mo,e),so=Math.max(so,t))}function rg(e){if(!(!$t||so<=0))if(so-=e,so>0){const t=(Math.random()-.5)*2*Mo,s=(Math.random()-.5)*2*Mo;ps&&$t.camPos(ps.x+t,ps.y+s)}else ps&&$t.camPos(ps),Mo=0,ps=null}function Ko(e=50){$t&&vd("visual","showHitFreeze")&&($t.paused||($t.paused=!0,Rr=!0,setTimeout(()=>{$t.paused=!1,Rr=!1},e)))}function ag(){return Rr}const Ms={playerHit:()=>{zs(6,.1),Ko(30)},criticalHit:()=>{zs(4,.08),Ko(40)},bossHit:()=>{zs(3,.05)},bossDeath:()=>{zs(15,.3),Ko(100)},explosion:()=>{zs(10,.2),Ko(60)},playerDeath:()=>{zs(12,.25),Ko(150)},levelUp:()=>{zs(5,.15)},smallImpact:()=>{zs(2,.05)}};function lg(){so=0,Mo=0,$t&&ps&&$t.camPos(ps),ps=null}function Vo(e,t,s,o){if(!t||!t.exists())return;const n=20,r=e.width()-n,a=e.height()-n,c=n,l=n,d=t.pos.x+s.x*o,i=t.pos.y+s.y*o,p=Math.max(c,Math.min(r,d)),h=Math.max(l,Math.min(a,i)),f=t.pos.x,g=t.pos.y;t.pos.x=p,t.pos.y=h;const u=e.get("wall"),w=e.get("obstacle"),v=[...u,...w];let A=!1;for(const D of v)if(D.exists()&&t.isColliding&&t.isColliding(D)){A=!0;break}A&&(t.pos.x=f,t.pos.y=g)}function Ga(e,t){let s=0;t.weaponKey==="orbital"&&Cr(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.isRemote)t.aimAngle!==void 0&&(t.angle=t.aimAngle,t.outline&&t.outline.exists()&&(t.outline.angle=t.aimAngle));else{const i=e.mousePos(),p=e.vec2(i.x-t.pos.x,i.y-t.pos.y);if(p.len()>0){const f=Math.atan2(p.y,p.x)*(180/Math.PI);t.angle=f,t.outline&&t.outline.exists()&&(t.outline.angle=f)}}if(t.canShoot===!1){t.isShooting=!1;return}const o=e.get("enemy"),n=e.get("boss"),r=e.get("miniboss");if(!(o.length>0||n.length>0||r.length>0)&&t.weaponKey!=="orbital"){t.isShooting=!1;return}if(t.weaponKey==="orbital"){cg(e,t),t.isShooting=!1;return}const c=e.time();let l,d=!1;if(t.isRemote){if(re()&&!he()){t.isShooting=!1;return}if(t.aimAngle!==void 0&&t.isShooting){const i=t.aimAngle*(Math.PI/180);l=e.vec2(Math.cos(i),Math.sin(i)),d=!0}else{t.isShooting=!1;return}}else{const i=e.mousePos(),p=e.vec2(i.x-t.pos.x,i.y-t.pos.y),h=p.len();if(h>0){if(t.aimAngle=Math.atan2(p.y,p.x)*(180/Math.PI),l=p.unit(),re()&&!he()){t.isShooting=h>0&&t.canShoot;return}d=!0}else{t.aimAngle=0,t.isShooting=!1;return}t.isShooting=h>0&&t.canShoot}if(d&&l&&c-s>=1/t.fireRate){const i=t.projectileCount||1,p=t.spreadAngle||0,h=[];if(i===1)h.push(l);else if(p>0){const f=i>1?p/(i-1):0,g=-p/2;for(let u=0;u<i;u++){const v=(g+f*u)*(Math.PI/180),A=Math.cos(v),D=Math.sin(v),Y=e.vec2(l.x*A-l.y*D,l.x*D+l.y*A);h.push(Y.unit())}}else for(let f=0;f<i;f++)h.push(l);h.forEach((f,g)=>{const u=p===0&&i>1?g*Et.MULTISHOT_STAGGER_DELAY:0;e.wait(u,()=>{const w=a0(t.critChance||0);let v=w?l0(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(v=Math.floor(v*t.piercingDamageBonus));const A=t.weaponRange||Ro.DEFAULT_WEAPON_RANGE;if(sg(t.weaponKey),t.weaponKey==="flamethrower"){const D=ns(e,t.pos.x,t.pos.y,f,t.projectileSpeed,v,t.piercing||0,t.obstaclePiercing||0,w,A);t.weaponDef&&D.useWeaponVisual(t.weaponDef),D.ownerSlotIndex=t.slotIndex;const Y=Math.floor(v*.3),P=2,m=t.fireDotMultiplier||1;D.burnDamage=Math.floor(Y*m),D.burnDuration=P,re()&&he()&&Eo(D,{weaponKey:t.weaponKey,burnDamage:D.burnDamage,burnDuration:D.burnDuration})}else if(t.weaponKey==="explosive"){const D=dg(e,t.pos.x,t.pos.y,f,t.projectileSpeed,v,t.explosionRadius,t.explosionDamage,A,w);t.weaponDef&&D.useWeaponVisual(t.weaponDef),D.ownerSlotIndex=t.slotIndex,re()&&he()&&Eo(D,{weaponKey:t.weaponKey,explosionRadius:D.explosionRadius,explosionDamage:D.explosionDamage})}else if(t.weaponKey==="chainLightning"){const D=hg(e,t.pos.x,t.pos.y,f,t.projectileSpeed,v,t.chainRange,t.maxJumps,t.chainDamageReduction,A,w);t.weaponDef&&D.useWeaponVisual(t.weaponDef),D.ownerSlotIndex=t.slotIndex,re()&&he()&&Eo(D,{weaponKey:t.weaponKey,chainRange:D.chainRange,maxJumps:D.maxJumps,chainDamageReduction:D.chainDamageReduction})}else{const D=ns(e,t.pos.x,t.pos.y,f,t.projectileSpeed,v,t.piercing||0,t.obstaclePiercing||0,w,A);t.weaponDef&&D.useWeaponVisual(t.weaponDef),D.ownerSlotIndex=t.slotIndex,re()&&he()&&Eo(D,{weaponKey:t.weaponKey||"pistol"})}})}),s=c,S0(t)}}),e.onCollide("projectile","wall",(o,n)=>{if(!e.paused){if(o.isExplosive){Gi(e,o,o.pos.x,o.pos.y);return}o.piercedObstacles&&o.piercedObstacles.has(n)||(o.obstaclePiercing>0?(o.piercedObstacles&&o.piercedObstacles.add(n),o.piercedObstacles.size>(o.obstaclePiercing||0)&&e.destroy(o)):e.destroy(o))}}),e.onCollide("projectile","cover",(o,n)=>{if(!e.paused&&o.obstaclePiercing>0&&o.piercedObstacles){if(o.piercedObstacles.has(n))return;o.piercedObstacles.add(n),o.piercedObstacles.size>(o.obstaclePiercing||0)&&e.destroy(o)}}),e.onCollide("projectile","obstacle",(o,n)=>{e.paused||o.isExplosive||o.piercedObstacles&&o.piercedObstacles.has(n)||(o.obstaclePiercing>0?(o.piercedObstacles&&o.piercedObstacles.add(n),o.piercedObstacles.size>(o.obstaclePiercing||0)&&e.destroy(o)):e.destroy(o))}),e.onCollide("projectile","enemy",(o,n)=>{if(e.paused||o.isEnemyProjectile||o.isBossProjectile)return;if(o.isExplosive){Gi(e,o,n.pos.x,n.pos.y);return}if(o.isChainLightning){if(o.chainedEnemies&&o.chainedEnemies.has(n))return;if(!re()||he()){const c=o.chainJumps||0,l=1-(o.chainDamageReduction||.15)*c,d=Math.floor(o.damage*Math.max(.1,l));n.takeDamage?n.takeDamage(d):n.hurt(d)}o.chainedEnemies&&o.chainedEnemies.add(n),o.chainJumps<o.maxJumps?Ka(e,o,n):e.destroy(o);return}if(o.piercedEnemies&&o.piercedEnemies.has(n))return;if(re()&&!he()){Na(),Bt(e,n.pos.x,n.pos.y,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(n),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);return}Na(),n.takeDamage?n.takeDamage(o.damage):n.hurt(o.damage),o.ownerSlotIndex!==void 0&&(n.lastHitBySlot=o.ownerSlotIndex),re()&&he()&&Xc({targetId:n.mpEntityId,targetType:"enemy",damage:o.damage,isCrit:o.isCrit||!1,x:n.pos.x,y:n.pos.y}),o.burnDamage&&o.burnDuration&&(n.burnDamage=o.burnDamage,n.burnDuration=o.burnDuration,n.burnTimer=0),Bt(e,n.pos.x,n.pos.y,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(n),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);const r=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y);if(r.len()>0){const c=r.unit(),l=Et.KNOCKBACK_ENEMY_FROM_PROJECTILE;Vo(e,n,c,l)}Go(e,n.pos.x,n.pos.y,r,{isCrit:o.isCrit}),o.isCrit&&Ms.criticalHit(),n.color=o.isCrit?e.rgb(...Et.CRIT_COLOR):e.rgb(...Et.HIT_COLOR),e.wait(Et.HIT_FLASH_DURATION,()=>{n.exists()&&(n.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(o,n)=>{if(e.paused)return;if(o.isExplosive){Gi(e,o,n.pos.x,n.pos.y);return}if(o.isChainLightning){if(o.chainedEnemies&&o.chainedEnemies.has(n))return;if(!re()||he()){const a=o.chainJumps||0,c=1-(o.chainDamageReduction||.15)*a,l=Math.floor(o.damage*Math.max(.1,c));n.takeDamage?n.takeDamage(l):n.hurt(l)}o.chainedEnemies&&o.chainedEnemies.add(n),e.wait(.01,()=>{o.exists()&&(o.chainJumps<o.maxJumps?Ka(e,o,n):e.destroy(o))});return}if(o.piercedEnemies&&o.piercedEnemies.has(n))return;if(re()&&!he()){Bt(e,n.pos.x,n.pos.y,{isCrit:o.isCrit});const a=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y);Go(e,n.pos.x,n.pos.y,a,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(n),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);return}n.takeDamage?n.takeDamage(o.damage):n.hurt(o.damage),o.ownerSlotIndex!==void 0&&(n.lastHitBySlot=o.ownerSlotIndex),o.burnDamage&&o.burnDuration&&(n.burnDamage=o.burnDamage,n.burnDuration=o.burnDuration,n.burnTimer=0),Bt(e,n.pos.x,n.pos.y,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(n),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);const r=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y);r.len()>0&&Vo(e,n,r.unit(),Et.KNOCKBACK_BOSS_FROM_PROJECTILE),Go(e,n.pos.x,n.pos.y,r,{isCrit:o.isCrit}),o.isCrit?Ms.criticalHit():Ms.bossHit(),n.color=o.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{n.exists()&&n.updateVisual()})}),e.onCollide("projectile","miniboss",(o,n)=>{if(e.paused||o.isEnemyProjectile||o.isBossProjectile||o.piercedEnemies&&o.piercedEnemies.has(n))return;if(re()&&!he()){Bt(e,n.pos.x,n.pos.y,{isCrit:o.isCrit});const c=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y);Go(e,n.pos.x,n.pos.y,c,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(n),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);return}let r=o.damage;o.isCrit&&(r=Math.floor(r*1.5)),n.takeDamage(r),o.ownerSlotIndex!==void 0&&(n.lastHitBySlot=o.ownerSlotIndex),o.burnDamage&&o.burnDuration&&(n.burnDamage=o.burnDamage,n.burnDuration=o.burnDuration,n.burnTimer=0),Bt(e,n.pos.x,n.pos.y,{isCrit:o.isCrit});const a=e.vec2(n.pos.x-o.pos.x,n.pos.y-o.pos.y);Go(e,n.pos.x,n.pos.y,a,{isCrit:o.isCrit}),o.isCrit&&Ms.criticalHit(),o.piercedEnemies&&o.piercedEnemies.add(n),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o),n.color=o.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{n.exists()&&n.updateVisual()})}),e.onCollide("enemy","player",(o,n)=>{if(e.paused||n.isDead||n.hp()<=0||n.invulnerable)return;if(re()&&!he()){Hs(),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]}),n.color=e.rgb(...Et.HIT_COLOR);return}if(n.dodgeChance&&Math.random()<n.dodgeChance)return;Hs(),Ms.playerHit();const r=o.damage||Et.BASE_ENEMY_DAMAGE,a=Ui(r,n.defense||0,n.damageReduction||0);if(n.hurt(a),n.invulnerable||(n.invulnerable=!0,n.invulnerableTime=n.invulnerableDuration),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]}),o.lifesteal&&o.exists()){const d=o.hp(),i=o.maxHealth;if(d<i){const p=Math.min(i,d+o.lifesteal);o.setHP(p)}}const c=e.vec2(o.pos.x-n.pos.x,o.pos.y-n.pos.y);if(c.len()>0){const d=c.unit(),i=Et.KNOCKBACK_ENEMY;Vo(e,o,d,i)}n.color=e.rgb(...Et.HIT_COLOR)}),e.onCollide("miniboss","player",(o,n)=>{if(e.paused||n.isDead||n.hp()<=0||n.invulnerable)return;if(re()&&!he()){Hs(),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]}),n.color=e.rgb(255,100,100);return}if(n.dodgeChance&&Math.random()<n.dodgeChance)return;Hs(),Ms.playerHit();let r=Et.BASE_MINIBOSS_DAMAGE;(o.type==="brute"||o.type==="berserker"||o.type==="guardian")&&o.meleeDamage&&(r=o.meleeDamage);const a=Ui(r,n.defense||0,n.damageReduction||0);n.hurt(a),n.invulnerable||(n.invulnerable=!0,n.invulnerableTime=n.invulnerableDuration),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]});const c=e.vec2(o.pos.x-n.pos.x,o.pos.y-n.pos.y);if(c.len()>0){const d=c.unit(),i=Et.KNOCKBACK_MINIBOSS;Vo(e,o,d,i)}n.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(o,n)=>{if(e.paused||n.isDead||n.hp()<=0||n.invulnerable)return;if(re()&&!he()){Hs(),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]}),n.color=e.rgb(255,100,100);return}if(n.dodgeChance&&Math.random()<n.dodgeChance)return;Hs(),Ms.playerHit();let r=Et.BASE_BOSS_DAMAGE;if(o.type==="twinGuardianMelee"&&o.meleeDamage){const d=o.enraged?Et.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;r=o.meleeDamage*d}const a=Ui(r,n.defense||0,n.damageReduction||0);n.hurt(a),n.invulnerable||(n.invulnerable=!0,n.invulnerableTime=n.invulnerableDuration),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]});const c=e.vec2(o.pos.x-n.pos.x,o.pos.y-n.pos.y);if(c.len()>0){const d=c.unit(),i=Et.KNOCKBACK_BOSS;Vo(e,o,d,i)}n.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(o,n)=>{if(e.paused||!o.isBossProjectile&&!o.isEnemyProjectile||n.isDead||n.hp()<=0||n.invulnerable)return;if(re()&&!he()){Hs(),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]}),n.color=e.rgb(255,100,100),e.destroy(o);return}if(n.dodgeChance&&Math.random()<n.dodgeChance){e.destroy(o);return}Hs(),Ms.playerHit();const r=o.damage*(1-(n.damageReduction||0)),a=Math.max(1,r-(n.defense||0));n.hurt(a),n.invulnerable||(n.invulnerable=!0,n.invulnerableTime=n.invulnerableDuration),Bt(e,n.pos.x,n.pos.y,{color:[255,100,100]}),e.destroy(o),n.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(o,n)=>{if(!e.paused&&n.exists()&&!(o.contactCooldown>0)){if(re()&&!he()){o.contactCooldown=o.contactCooldownDuration||.2;return}n.hurt(o.damage),o.contactCooldown=o.contactCooldownDuration||.2}}),e.onCollide("orbital","boss",(o,n)=>{if(!e.paused&&n.exists()&&!(o.contactCooldown>0)){if(re()&&!he()){o.contactCooldown=o.contactCooldownDuration||.2;return}n.takeDamage?n.takeDamage(o.damage):n.hurt(o.damage),o.contactCooldown=o.contactCooldownDuration||.2}})}function Cr(e,t){t.orbitalOrbs&&t.orbitalOrbs.length>0&&t.orbitalOrbs.forEach(n=>{n&&n.exists()&&e.destroy(n)}),t.orbitalOrbs=[],t.orbitalAngles=[];const s=t.projectileCount||1,o=t.orbitRadius||Ro.BASE_ORBIT_RADIUS;for(let n=0;n<s;n++){const r=360/s*n,a=r*Math.PI/180,c=t.pos.x+Math.cos(a)*o,l=t.pos.y+Math.sin(a)*o,d=e.add([e.text(t.weaponDef?.char||"",{size:16}),e.pos(c,l),e.anchor("center"),e.color(...t.weaponDef?.color||[100,200,255]),e.area(),"orbital","playerProjectile"]);d.damage=t.projectileDamage||12,d.contactCooldown=0,d.contactCooldownDuration=Ro.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(d),t.orbitalAngles.push(r)}}function cg(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(r=>{r.exists()&&r.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],Cr(e,t),t.orbitalNeedsReinit=!1);const s=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==s)&&Cr(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const o=t.rotationSpeed||Ro.BASE_ROTATION_SPEED,n=t.orbitRadius||Ro.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((r,a)=>{if(!r.exists())return;t.orbitalAngles[a]=(t.orbitalAngles[a]+o*e.dt())%360;const c=t.orbitalAngles[a]*Math.PI/180;r.pos.x=t.pos.x+Math.cos(c)*n,r.pos.y=t.pos.y+Math.sin(c)*n,r.contactCooldown>0&&(r.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(r=>r.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function dg(e,t,s,o,n,r,a,c,l,d=!1){const i=ns(e,t,s,o,n,r,0,0,d,l);return i.isExplosive=!0,i.explosionRadius=a||50,i.explosionDamage=c||15,i}function hg(e,t,s,o,n,r,a,c,l,d,i=!1){const p=ns(e,t,s,o,n,r,0,0,i,d);return p.isChainLightning=!0,p.chainRange=a||70,p.maxJumps=c||3,p.chainDamageReduction=l||.15,p.chainJumps=0,p.chainedEnemies=new Set,p}function Gi(e,t,s,o){if(!t.exists())return;xd(),Ms.explosion();const n=t.explosionRadius||50,r=t.explosionDamage||15;if(!re()||he()){const c=e.get("enemy"),l=e.get("boss"),d=[...c,...l];for(const i of d){if(!i.exists())continue;e.vec2(i.pos.x-s,i.pos.y-o).len()<=n&&(i.takeDamage?i.takeDamage(r):i.hurt(r))}}const a=e.add([e.text("*",{size:24}),e.pos(s,o),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{a.exists()&&e.destroy(a)}),e.destroy(t)}function Ka(e,t,s){if(!t.exists())return;const o=t.chainRange||70,n=e.get("enemy"),r=e.get("boss"),a=[...n,...r];let c=null,l=o;for(const d of a){if(!d.exists()||d===s||t.chainedEnemies&&t.chainedEnemies.has(d))continue;const i=e.vec2(d.pos.x-s.pos.x,d.pos.y-s.pos.y).len();i<=o&&i<l&&(c=d,l=i)}if(c){t.chainJumps=(t.chainJumps||0)+1;const d=s.pos,i=c.pos,p=e.vec2(i.x-d.x,i.y-d.y).len(),h=Math.atan2(i.y-d.y,i.x-d.x),f=(d.x+i.x)/2,g=(d.y+i.y)/2,u=e.add([e.rect(p,2),e.pos(f,g),e.anchor("center"),e.rotate(h),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{u.exists()&&e.destroy(u)}),t.pos.x=c.pos.x,t.pos.y=c.pos.y}else e.destroy(t)}const Ye={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10},co={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${Ye.damage})`:""}`,apply:e=>{const t=e.upgradeStacks?.damage||0,s=e.baseProjectileDamage||e.weaponDef?.baseDamage||10,o=Math.pow(1.25,t);e.projectileDamage=Math.floor(s*o)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${Ye.fireRate})`:""}`,apply:e=>{const t=e.upgradeStacks?.fireRate||0,s=e.baseFireRate||e.weaponDef?.fireRate||1.5,o=Math.pow(1.2,t);e.fireRate=s*o}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${Ye.speed})`:""}`,apply:e=>{const t=e.upgradeStacks?.speed||0,s=e.characterData?.stats?.speed||150,o=Math.pow(1.15,t);e.speed=Math.floor(s*o),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${Ye.health})`:""}`,apply:e=>{const t=e.upgradeStacks?.health||0,s=e.characterData?.stats?.health||100,o=t*20,n=e.maxHealth;e.maxHealth=s+o;const r=e.maxHealth-n;r>0&&e.setHP(e.hp()+r)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${Ye.projectileSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.projectileSpeed||0,s=e.baseProjectileSpeed||e.weaponDef?.projectileSpeed||300,o=Math.pow(1.25,t);e.projectileSpeed=Math.floor(s*o)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${Ye.xpGain})`:""}`,apply:e=>{const t=e.upgradeStacks?.xpGain||0,s=e.characterData?.ability==="xpBoost"?1.1:1;e.xpMultiplier=s+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${Ye.pickupRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.pickupRadius||0,s=30,o=Math.pow(1.5,t);e.pickupRadius=Math.floor(s*o)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${Ye.multiShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.multiShot||0,s=e.weaponDef?.projectileCount||1;e.projectileCount=s+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${Ye.piercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.piercing||0,s=e.weaponDef?.piercing||0;e.piercing=s+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${Ye.obstaclePiercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.obstaclePiercing||0,s=e.weaponDef?.obstaclePiercing||0;e.obstaclePiercing=s+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${Ye.critChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.critChance||0;let o=(e.weaponDef?.critChance||.05)+t*.1;e.characterData?.ability==="critBoost"&&(o*=1.5),e.critChance=o}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${Ye.critDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.critDamage||0;let o=(e.weaponDef?.critDamage||2)+t*.5;e.characterData?.ability==="critBoost"&&(o*=1.25),e.critDamage=o}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${Ye.spreadShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.spreadShot||0,s=e.weaponDef?.spreadAngle||0;e.spreadAngle=s+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${Ye.pelletCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.pelletCount||0,s=e.weaponDef?.projectileCount||3;e.projectileCount=s+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${Ye.range})`:""}`,apply:e=>{const t=e.upgradeStacks?.range||0,s=e.weaponDef?.range||600,o=Math.pow(1.25,t);e.weaponRange=Math.floor(s*o)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${Ye.dot})`:""}`,apply:e=>{const t=e.upgradeStacks?.dot||0,s=e.characterData?.ability==="fireDot"?1.25:1;e.fireDotMultiplier=s+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${Ye.orbitalCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalCount||0,s=e.weaponDef?.projectileCount||1;e.projectileCount=s+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${Ye.orbitalSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalSpeed||0,s=e.weaponDef?.rotationSpeed||180,o=Math.pow(1.5,t);e.rotationSpeed=s*o}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${Ye.orbitalRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalRadius||0,s=e.weaponDef?.orbitRadius||45,o=Math.pow(1.2,t);e.orbitRadius=Math.floor(s*o)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${Ye.explosionRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionRadius||0,s=e.weaponDef?.explosionRadius||50,o=Math.pow(1.25,t);e.explosionRadius=Math.floor(s*o)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${Ye.explosionDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionDamage||0,s=e.weaponDef?.explosionDamage||15,o=Math.pow(1.25,t);e.explosionDamage=Math.floor(s*o)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${Ye.chainJumps})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainJumps||0,s=e.weaponDef?.maxJumps||3;e.maxJumps=s+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${Ye.chainRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainRange||0,s=e.weaponDef?.chainRange||70,o=Math.pow(1.25,t);e.chainRange=Math.floor(s*o)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${Ye.chainDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainDamage||0,s=e.weaponDef?.chainDamageReduction||.15;e.chainDamageReduction=Math.max(.05,s-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${Ye.defense})`:""}`,apply:e=>{const t=e.upgradeStacks?.defense||0,s=e.characterData?.ability==="tankStats"?.15:0;e.defense=s+t*2}}};function ug(e,t){if(e.category==="passive"){const s=t.upgradeStacks?.[e.key]||0,o=e.maxStacks||Ye[e.key]||10;return!(s>=o)}if(e.category==="weapon"){const s=t.upgradeStacks?.[e.key]||0,o=e.maxStacks||Ye[e.key]||10;if(s>=o)return!1;const n=t.characterData?.weapon||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(n):e.upgradeCategory?r0(n,e.upgradeCategory):!0}return!0}function Ad(e=3,t=null,s=null){let n=Object.keys(co).map(l=>({key:l,...co[l],type:"upgrade"})),r=n;t&&(r=n.filter(l=>ug(l,t))),r.length<e&&(r=n);const a=[],c=new Set;for(;a.length<e&&a.length<r.length;){const l=s?s.range(0,r.length):Math.floor(Math.random()*r.length),d=r[l];c.has(d.key)||(c.add(d.key),a.push(d))}return a}function ea(e,t){const s=co[t];s&&(s.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,li(e))}function li(e){Object.keys(co).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&co[t].apply(e)})}function Sd(e,t){if(!e)return"";if(e.getDescription){const s=t?.upgradeStacks?.[e.key]||0;return e.getDescription(s)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const pg=Object.freeze(Object.defineProperty({__proto__:null,UPGRADES:co,UPGRADE_STACK_LIMITS:Ye,applyUpgrade:ea,getRandomUpgrades:Ad,getUpgradeDescription:Sd,recalculateAllUpgrades:li},Symbol.toStringTag,{value:"Module"})),fg={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}}};function Ed(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function Wn(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const s=[];for(const[o,n]of Object.entries(fg))n.required.every(a=>t.selectedUpgrades.has(a))&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(o)||(n.apply(t),t.activeSynergies.add(o),s.push(n),gg(e,n)));return s}function gg(e,t){const s=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),o=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{s.exists()&&(e.destroy(s),e.destroy(o))})}const pe={TITLE:36,HEADER:24,LABEL:18,BODY:16,SMALL:14,BUTTON:20,HUD:16},L={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},mg={BUTTON_VERTICAL:65},wo={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},zn={HEALTH:"HP",FLOOR:"Floor",DAMAGE:"Damage",SPEED:"Speed"};function Lo(e){return e.toUpperCase()}function Va(e,t){return`${e}/${t}`}const H={BACKGROUND:0,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1e3},Wo=["$","","","","","","",""];function Mi(e,t={}){const{patternCount:s=12,particleCount:o=20,includeCursorFollowers:n=!1}=t,r=["","","","","","","",""];for(let a=0;a<s;a++){const c=e.add([e.text(r[Math.floor(Math.random()*r.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...L.BG_LIGHT),e.opacity(.15),e.z(H.PARTICLES)]);c.pulseTime=Math.random()*Math.PI*2,c.pulseSpeed=1+Math.random()*2,c.onUpdate(()=>{c.pulseTime+=e.dt()*c.pulseSpeed;const l=.8+Math.sin(c.pulseTime)*.3;c.scale=e.vec2(l,l),c.opacity=.1+Math.abs(Math.sin(c.pulseTime))*.15})}for(let a=0;a<o;a++){const c=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...L.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(H.PARTICLES)]);c.speed=10+Math.random()*20,c.onUpdate(()=>{c.pos.y+=c.speed*e.dt(),c.pos.y>e.height()&&(c.pos.y=0,c.pos.x=Math.random()*e.width())})}if(n){const a=[];e.loop(5,()=>{if(a.length<3&&Math.random()<.3){const c=["","","","","","",""],l=e.add([e.text(c[Math.floor(Math.random()*c.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(H.PARTICLES)]);l.followSpeed=20+Math.random()*30,l.rotationSpeed=50+Math.random()*100,l.lifetime=15+Math.random()*10,l.onUpdate(()=>{const i=e.mousePos().sub(l.pos),p=i.len();if(p>5){const h=i.scale(1/p);l.pos=l.pos.add(h.scale(l.followSpeed*e.dt()))}if(l.angle+=l.rotationSpeed*e.dt(),l.lifetime-=e.dt(),l.lifetime<=0){e.destroy(l);const h=a.indexOf(l);h>-1&&a.splice(h,1)}}),a.push(l)}})}}const xg={CONTESTANTS:["           ","    ","                              ","                            ","                      ","                           "],MERCH:["       ","   ","       ","       ","      ","          "],OPTIONS:["        ","  ","             ","             ","            ","                 "],"RATINGS AND RECORDS":["                           ","            ","                               ","                              ","                         ","                                  "]};function Di(e,t,s,o,n=8){function r(h,f,g){f/=100,g/=100;const u=(1-Math.abs(2*g-1))*f,w=u*(1-Math.abs(h/60%2-1)),v=g-u/2;let A=0,D=0,Y=0;return h>=0&&h<60?(A=u,D=w,Y=0):h>=60&&h<120?(A=w,D=u,Y=0):h>=120&&h<180?(A=0,D=u,Y=w):h>=180&&h<240?(A=0,D=w,Y=u):h>=240&&h<300?(A=w,D=0,Y=u):h>=300&&h<360&&(A=u,D=0,Y=w),[Math.round((A+v)*255),Math.round((D+v)*255),Math.round((Y+v)*255)]}const a=Lo(t),c=xg[a];if(!c){console.warn(`ASCII art not found for "${a}", using plain text`);const h=e.add([e.text(a,{size:n*2,font:"monospace"}),e.pos(s,o),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT),"animatedTitle"]);let f=0;return h.onUpdate(()=>{f+=e.dt();const g=f*50%360,u=r(g,80,60);h.color=e.rgb(...u);const w=Math.sin(f*2)*2;h.pos.y=o+w}),[h]}const l=[],d=10,i=o-c.length*d/2;c.forEach((h,f)=>{const g=e.add([e.text(h,{size:n,font:"monospace"}),e.pos(s,i+f*d),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT),"animatedTitle"]);l.push(g)});let p=0;return e.onUpdate(()=>{p+=e.dt(),l.forEach((h,f)=>{const g=(p*50+f*20)%360,u=r(g,80,60);h.color=e.rgb(...u);const w=Math.sin(p*2+f*.3)*2;h.pos.y=i+f*d+w,Math.random()<.001&&(h.pos.x=s+(Math.random()-.5)*10,e.wait(.1,()=>{h.exists()&&(h.pos.x=s)}))})}),l}function ta(e,t,s){const o=()=>2+Math.random()*3,n=e.add([e.text(`${Wo[0]}: ${t}`,{size:pe.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),r=n.width+30,a=40;e.destroy(n);const c=e.add([e.rect(r,a),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.GOLD)),e.fixed(),e.z(H.UI_BACKGROUND)]),l=e.add([e.text(`${Wo[0]}: ${t}`,{size:pe.LABEL}),e.pos(e.width()-20-r/2,40),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.UI_TEXT)]);l.symbolIndex=0,l.timeSinceLastChange=0,l.currentCurrency=t,l.symbolChangeInterval=o();const d=i=>{l.currentCurrency=i,l.text=`${Wo[l.symbolIndex]}: ${i}`;const p=l.width+30;Math.abs(p-r)>10&&(c.width=p,l.pos.x=e.width()-20-p/2)};return l.onUpdate(()=>{l.timeSinceLastChange+=e.dt(),l.timeSinceLastChange>=l.symbolChangeInterval&&(l.timeSinceLastChange=0,l.symbolIndex=(l.symbolIndex+1)%Wo.length,l.text=`${Wo[l.symbolIndex]}: ${l.currentCurrency}`,l.symbolChangeInterval=o())}),{panel:c,text:l,updateCurrency:d}}let Ds=!1;function yg(e,t,s,o=null,n=null){if(Ds)return;Ds=!0;const r=re();r||(e.paused=!0),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()));let a=null;if(re()){const A=t.playerIndex!==void 0?t.playerIndex:0,D=n||t.level||1;a=kc(A,D)}const c=Ad(3,t,a);e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...L.BG_DARK),e.opacity(.9),e.fixed(),e.z(H.MODAL),"upgradeOverlay"]);const l=r&&o?`${o} - Level Up! Choose an Upgrade`:"Level Up! Choose an Upgrade";e.add([e.text(l,{size:pe.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...L.WARNING),e.fixed(),e.z(H.MODAL+1),"upgradeUI"]);const d=200,i=150,p=250,h=e.width()/2-p*(c.length-1)/2,f=e.height()/2;c.forEach((A,D)=>{const Y=h+D*p,P=e.add([e.rect(d,i),e.pos(Y,f),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.BORDER)),e.fixed(),e.z(H.MODAL+1),e.area(),"upgradeUI","upgradeCard"]);if(A.icon){const x=A.category==="passive"?L.SUCCESS:A.weaponKey?L.WARNING:L.INFO;e.add([e.text(A.icon,{size:48}),e.pos(Y,f-50),e.anchor("center"),e.color(...x),e.fixed(),e.z(H.MODAL+2),"upgradeUI"])}e.add([e.text(A.name,{size:pe.BUTTON,width:d-20}),e.pos(Y,f-5),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.MODAL+2),"upgradeUI"]);const m=Sd(A,t);e.add([e.text(m,{size:pe.BODY,width:d-20}),e.pos(Y,f+30),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.MODAL+2),"upgradeUI"]),e.add([e.text(`${D+1}`,{size:pe.HEADER}),e.pos(Y+d/2-20,f-i/2+15),e.anchor("center"),e.color(...L.WARNING),e.fixed(),e.z(H.MODAL+2),"upgradeUI"]),P.onClick(()=>{Ds&&g(D)})});function g(A){if(!Ds)return;const D=c[A];Z0(),Ds=!1,ea(t,D.key),Ed(t,D.key);const Y=Wn(e,t);if(re()&&t.slotIndex!==void 0&&(Vc(t.slotIndex,D.key),Y&&Y.length>0)){const P=Y.map(m=>m.name);jc(t.slotIndex,P)}e.get("upgradeUI").forEach(P=>e.destroy(P)),e.get("upgradeOverlay").forEach(P=>e.destroy(P)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),r||(e.paused=!1),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{s&&s(D)})}const u=()=>{Ds&&c.length>=1&&g(0)},w=()=>{Ds&&c.length>=2&&g(1)},v=()=>{Ds&&c.length>=3&&g(2)};e.onKeyPress("1",u),e.onKeyPress("2",w),e.onKeyPress("3",v)}function Ki(){return Ds}function Wa(e,t,s=null,o=!1){let n=!1;t.pendingLevelUps=t.pendingLevelUps||[],t.addXP=function(a){if(e.paused||n)return;const c=t.xpMultiplier||1,l=Math.floor(a*c);for(t.xp+=l;t.xp>=t.xpToNext&&!n&&t.xpToNext>0;){n=!0,t.xp-=t.xpToNext,t.level++;const d=t.level;t.xpToNext=Math.max(1,Math.floor(t.xpToNext*Rs.XP_SCALING_FACTOR)),r(e,t,d)}};function r(a,c,l){if(a.paused&&!o){n=!1;return}Q0();const d=a.add([a.text(`Level ${l}!`,{size:24}),a.pos(a.width()/2,Rs.LEVEL_UP_NOTIFICATION_Y),a.anchor("center"),a.color(255,255,100),a.fixed(),a.z(1e3)]);o&&c.slotIndex!==void 0&&Wc(c.slotIndex,l),c.pendingLevelUps.push(l),a.wait(Rs.LEVEL_UP_NOTIFICATION_DURATION,()=>{d.exists()&&a.destroy(d),n=!1})}return{processPendingLevelUp:()=>{if(t.pendingLevelUps.length>0&&!n){n=!0;const a=t.pendingLevelUps.shift(),c=t.playerName||(t.isRemote?`Player ${t.slotIndex+1}`:"You");yg(e,t,()=>{n=!1},o?c:null,a)}}}}const wg={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:20,turret:15,heavyTank:20,zippy:20,exploder:25},3:{mage:20,shieldBearer:15,golem:15,wraith:15,spawner:15,buffer:20,orbiter:10},4:{healer:25,teleporter:20,freezer:25,leech:30}};function bg(){return{basic:15,rusher:25,tank:30,fast:30}}function vg(e,t=null){const s=Object.values(e).reduce((n,r)=>n+r,0);let o=(t?t.next():Math.random())*s;for(const[n,r]of Object.entries(e))if(o-=r,o<=0)return n;return Object.keys(e)[0]}function Tr(e=1,t=null){const s=wg[e]||bg();return vg(s,t)}const Ag=800,Sg=600,Un=20;let dn=null;const hn={empty:{name:"Empty Room",obstacles:[],spawnDoors:null},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],spawnDoors:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],spawnDoors:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],spawnDoors:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],spawnDoors:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],spawnDoors:null}};function Eg(e,t,s,o){const n=s/2,r=o/2,a=Un+n,c=Ag-Un-n,l=Un+r,d=Sg-Un-r,i=Math.max(a,Math.min(c,e)),p=Math.max(l,Math.min(d,t));return{x:i,y:p}}function Mg(e,t){const s=Math.max(150-t*5,100);return{wallColor:e.rgb(Math.floor(s*.6),Math.floor(s*.4),Math.floor(s*.5)),obstacleColor:e.rgb(Math.floor(s*.7),Math.floor(s*.5),Math.floor(s*.6)),coverColor:e.rgb(Math.floor(s*.8),Math.floor(s*.6),Math.floor(s*.7))}}function sn(e,t=null){const s=Object.keys(hn),o=dn?s.filter(c=>c!==dn):s,n=o.length>0?o:s,r=t?t.range(0,n.length):Math.floor(Math.random()*n.length),a=n[r];return dn=a,{key:a,...hn[a]}}function Dg(){dn=null}function ja(e){return hn[e]?(dn=e,{key:e,...hn[e]}):(console.warn(`Unknown room template key: ${e}, falling back to empty`),{key:"empty",...hn.empty})}const Ri={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1},floor10:{id:"floor10",name:"Floor 10 Reached",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies",category:"combat",icon:"",unlocked:!1},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies",category:"combat",icon:"",unlocked:!1},kill1000:{id:"kill1000",name:"Genocide",description:"Kill 1000 enemies",category:"combat",icon:"",unlocked:!1},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses",category:"boss",icon:"",unlocked:!1},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1},earn100:{id:"earn100",name:"Rich",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1},earn500:{id:"earn500",name:"Wealthy",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1},earn1000:{id:"earn1000",name:"Millionaire",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1}};function Rg(e){return Object.values(Ri).filter(t=>t.category===e)}function Cg(){const e=new Set;return Object.values(Ri).forEach(t=>e.add(t.category)),Array.from(e)}function Vi(e){const t=jr(),s=[];return t.bestFloor>=2&&!ft("floor2")&&gt("floor2")&&s.push("floor2"),t.bestFloor>=3&&!ft("floor3")&&gt("floor3")&&s.push("floor3"),t.bestFloor>=5&&!ft("floor5")&&gt("floor5")&&s.push("floor5"),t.bestFloor>=10&&!ft("floor10")&&gt("floor10")&&s.push("floor10"),t.totalEnemiesKilled>=1&&!ft("firstKill")&&gt("firstKill")&&s.push("firstKill"),t.totalEnemiesKilled>=100&&!ft("kill100")&&gt("kill100")&&s.push("kill100"),t.totalEnemiesKilled>=500&&!ft("kill500")&&gt("kill500")&&s.push("kill500"),t.totalEnemiesKilled>=1e3&&!ft("kill1000")&&gt("kill1000")&&s.push("kill1000"),t.totalBossesKilled>=1&&!ft("firstBoss")&&gt("firstBoss")&&s.push("firstBoss"),t.totalBossesKilled>=5&&!ft("boss5")&&gt("boss5")&&s.push("boss5"),t.totalRuns>=1&&!ft("firstRun")&&gt("firstRun")&&s.push("firstRun"),t.totalRuns>=10&&!ft("run10")&&gt("run10")&&s.push("run10"),t.totalRuns>=50&&!ft("run50")&&gt("run50")&&s.push("run50"),t.bestLevel>=10&&!ft("level10")&&gt("level10")&&s.push("level10"),t.bestLevel>=20&&!ft("level20")&&gt("level20")&&s.push("level20"),t.totalCurrencyEarned>=100&&!ft("earn100")&&gt("earn100")&&s.push("earn100"),t.totalCurrencyEarned>=500&&!ft("earn500")&&gt("earn500")&&s.push("earn500"),t.totalCurrencyEarned>=1e3&&!ft("earn1000")&&gt("earn1000")&&s.push("earn1000"),s.length>0&&e&&s.forEach((o,n)=>{const r=Ri[o];r&&e.wait(n*.5,()=>{Tg(e,r)})}),s}function Tg(e,t){eg();const s=e.add([e.text("Achievement Unlocked!",{size:20}),e.pos(e.width()/2,e.height()/2-40),e.anchor("center"),e.color(255,255,100),e.fixed(),e.z(3e3)]),o=e.add([e.text(`${t.icon} ${t.name}`,{size:24}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(3e3)]),n=e.add([e.text(t.description,{size:16}),e.pos(e.width()/2,e.height()/2+30),e.anchor("center"),e.color(200,200,200),e.fixed(),e.z(3e3)]);e.wait(3,()=>{s.exists()&&e.destroy(s),o.exists()&&e.destroy(o),n.exists()&&e.destroy(n)})}class Nn{constructor(t,s,o="combat"){this.position={x:t,y:s},this.type=o,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=o==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:s,y:o}=this.position;switch(t){case"up":return{x:s,y:o-1};case"down":return{x:s,y:o+1};case"right":return{x:s+1,y:o};default:return null}}}class Pg{constructor(t,s=6,o=3,n=null){this.floor=t,this.width=s,this.height=o,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.rng=n,this.generate()}random(){return this.rng?this.rng.next():Math.random()}randomRange(t,s){return this.rng?this.rng.range(t,s):Math.floor(Math.random()*(s-t))+t}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const s=this.height===1?0:this.randomRange(0,this.height);this.bossPosition={x:this.width-1,y:s};const o=new Nn(0,t,"start");this.setRoom(0,t,o);const n=new Nn(this.width-1,s,"boss");this.setRoom(this.width-1,s,n),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const s of t)if(!this.getRoom(s.x,s.y)){const o=new Nn(s.x,s.y,"combat");this.setRoom(s.x,s.y,o)}}findPath(t,s){const o=[];let n={...t};for(;n.x<s.x||n.y!==s.y;)o.push({...n}),n.x<s.x?n.y!==s.y&&this.random()<.3?n.y+=n.y<s.y?1:-1:n.x+=1:n.y+=n.y<s.y?1:-1;return o.push({...s}),o}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let s=0;for(let o=1;o<this.width-1;o++)for(let n=0;n<this.height&&!(s>=t);n++){if(this.getRoom(o,n))continue;if(o>0&&this.getRoom(o-1,n)&&this.random()<.5){const a=new Nn(o,n,"combat");this.setRoom(o,n,a),s++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let s=0;s<this.height;s++){const o=this.getRoom(t,s);o&&(t<this.width-1&&this.getRoom(t+1,s)&&(o.connections.right=!0),s>0&&this.getRoom(t,s-1)&&(o.connections.up=!0),s<this.height-1&&this.getRoom(t,s+1)&&(o.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let s=0;s<this.height;s++){const o=this.getRoom(t,s);if(o&&(o.type!=="boss"&&(o.template=sn(this.floor,this.rng)),o.type==="combat")){const n=this.randomRange(3,6);o.enemyTypes=[];for(let r=0;r<n;r++)o.enemyTypes.push(Tr(this.floor,this.rng))}}}validate(){const t=new Set,s=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);s.length>0;){const o=s.shift(),n=this.getRoom(o.x,o.y);if(!n)continue;if(n.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const r=["up","down","right"];for(const a of r)if(n.connections[a]){const c=n.getAdjacentPosition(a),l=`${c.x},${c.y}`;t.has(l)||(t.add(l),s.push(c))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,s){return t<0||t>=this.width||s<0||s>=this.height?null:this.grid[s][t]}setRoom(t,s,o){t<0||t>=this.width||s<0||s>=this.height||(this.grid[s][t]=o,this.rooms.set(o.getKey(),o))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const s=[],o=["up","down","right"];for(const n of o)if(t.connections[n]){const r=t.getAdjacentPosition(n),a=this.getRoom(r.x,r.y);a&&!a.visited&&s.push({direction:n,position:r,room:a})}return s}markRoomVisited(t,s){const o=this.getRoom(t,s);o&&(o.visited=!0,this.visitedRooms.add(o.getKey()))}markRoomCleared(t,s){const o=this.getRoom(t,s);o&&(o.cleared=!0)}moveToRoom(t){const s=this.getCurrentRoom();if(!s||!s.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const o=s.getAdjacentPosition(t);return this.getRoom(o.x,o.y)?(this.currentPosition=o,this.markRoomVisited(o.x,o.y),console.log(`[FloorMap] Moved to room (${o.x}, ${o.y})`),!0):(console.warn(`[FloorMap] No room found at ${o.x}, ${o.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let s=0;s<this.height;s++){const o=[];for(let n=0;n<this.width;n++){const r=this.getRoom(n,s);r?n===this.currentPosition.x&&s===this.currentPosition.y?o.push({type:"current",room:r}):r.visited?o.push({type:"visited",room:r}):this.isRoomRevealed(n,s)?o.push({type:"revealed",room:r}):o.push({type:"hidden"}):o.push({type:"empty"})}t.push(o)}return t}isRoomRevealed(t,s){if(!this.getRoom(t,s))return!1;const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:r,dy:a}of n){const c=this.getRoom(t+r,s+a);if(c&&c.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let s="";for(let o=0;o<this.width;o++){const n=this.getRoom(o,t);n?n.type==="start"?s+="[S]":n.type==="boss"?s+="[B]":o===this.currentPosition.x&&t===this.currentPosition.y?s+="[]":n.visited?s+="[]":s+="[R]":s+="[ ]",s+=" "}console.log(s)}console.log(`
Connections:`);for(const[t,s]of this.rooms){const o=[];s.connections.up&&o.push(""),s.connections.down&&o.push(""),s.connections.right&&o.push(""),console.log(`  (${s.position.x}, ${s.position.y}): ${o.join(", ")||"none"}`)}}}function Ig(e,t=null){const s=Math.min(3+e,10),o=Math.min(2+Math.floor(e/2),6),n=new Pg(e,s,o,t);return n.debugPrint(),n}const Us={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"};class Bg{constructor(t,s){this.k=t,this.floorMap=s,this.mode=Us.MINIMIZED,this.elements=[],this.buttonPos={x:t.width()-50,y:70},this.openPos={x:t.width()-120,y:70},this.maximizedPos={x:t.width()-250,y:70},this.render()}toggle(){try{Dt()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===Us.MINIMIZED?this.mode=Us.OPEN:this.mode===Us.OPEN?this.mode=Us.MAXIMIZED:this.mode=Us.MINIMIZED,this.k.wait(0,()=>{this.update()})}update(){this.clear(),this.render()}clear(){this.elements.forEach(t=>{t.exists()&&this.k.destroy(t)}),this.elements=[]}render(){this.mode===Us.MINIMIZED?this.renderMinimized():this.mode===Us.OPEN?this.renderOpen():this.renderMaximized()}renderMinimized(){const{x:t,y:s}=this.buttonPos,o=40,n=this.k.add([this.k.rect(o,o),this.k.pos(t,s),this.k.anchor("center"),this.k.color(30,30,50),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);n.onClick(()=>this.toggle()),this.elements.push(n);const r=this.k.add([this.k.text("",{size:24}),this.k.pos(t,s),this.k.anchor("center"),this.k.color(150,180,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(r);const a=this.k.add([this.k.text(`${this.floorMap.floor}`,{size:10}),this.k.pos(t+12,s-12),this.k.anchor("center"),this.k.color(255,255,100),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(a)}renderOpen(){const{x:t,y:s}=this.openPos,o=12,n=this.floorMap.getGridForMinimap(),r=this.k.add([this.k.rect(140,80),this.k.pos(t-10,s-10),this.k.anchor("topleft"),this.k.color(20,20,30),this.k.outline(2,this.k.rgb(100,150,200)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);r.onClick(()=>this.toggle()),this.elements.push(r);const a=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t+60,s),this.k.anchor("center"),this.k.color(200,200,255),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(a);const c=s+15;for(let d=0;d<n.length;d++)for(let i=0;i<n[d].length;i++){const p=n[d][i],h=t+i*o,f=c+d*o;let g="",u=[100,100,100];switch(p.type){case"current":g="",u=[255,255,100];break;case"visited":g=p.room.isBossRoom?"B":"",u=p.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":g=p.room.isBossRoom?"B":"",u=p.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":g="",u=[60,60,80];break;case"empty":g=" ";break}if(g!==" "){const w=this.k.add([this.k.text(g,{size:10}),this.k.pos(h,f),this.k.anchor("topleft"),this.k.color(...u),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(w)}}const l=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:9}),this.k.pos(t+60,s+65),this.k.anchor("center"),this.k.color(180,180,180),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(l)}renderMaximized(){const{x:t,y:s}=this.maximizedPos,o=18,n=this.floorMap.getGridForMinimap(),r=Math.max(220,n[0].length*o+40),a=Math.max(180,n.length*o+100),c=this.k.add([this.k.rect(r,a),this.k.pos(t,s),this.k.anchor("topleft"),this.k.color(15,15,25),this.k.outline(3,this.k.rgb(100,150,255)),this.k.fixed(),this.k.z(900),this.k.area(),"minimap"]);c.onClick(()=>this.toggle()),this.elements.push(c);const l=this.k.add([this.k.rect(r,30),this.k.pos(t,s),this.k.anchor("topleft"),this.k.color(30,30,50),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(l);const d=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor} - ROOM ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:12}),this.k.pos(t+r/2,s+15),this.k.anchor("center"),this.k.color(200,220,255),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(d);const i=t+20,p=s+50;for(let g=0;g<n.length;g++)for(let u=0;u<n[g].length;u++){const w=n[g][u],v=i+u*o,A=p+g*o;let D=[30,30,40],Y=[50,50,60];if(w.type!=="empty"){const x=this.k.add([this.k.rect(o-2,o-2),this.k.pos(v,A),this.k.anchor("topleft"),this.k.color(...D),this.k.outline(1,this.k.rgb(...Y)),this.k.fixed(),this.k.z(901),"minimap"]);this.elements.push(x)}let P="",m=[100,100,100];switch(w.type){case"current":P="",m=[255,255,100];break;case"visited":P=w.room.isBossRoom?"B":"",m=w.room.isBossRoom?[255,100,100]:[100,255,100];break;case"revealed":P=w.room.isBossRoom?"B":"",m=w.room.isBossRoom?[255,150,150]:[150,150,150];break;case"hidden":P="",m=[80,80,100];break}if(P){const x=this.k.add([this.k.text(P,{size:14}),this.k.pos(v+o/2,A+o/2),this.k.anchor("center"),this.k.color(...m),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(x)}}const h=p+n.length*o+20;[{char:"",label:"Current Room",color:[255,255,100]},{char:"",label:"Cleared Room",color:[100,255,100]},{char:"",label:"Available Room",color:[150,150,150]},{char:"B",label:"Boss Room",color:[255,100,100]}].forEach((g,u)=>{const w=t+20,v=h+u*15,A=this.k.add([this.k.text(g.char,{size:10}),this.k.pos(w,v),this.k.anchor("topleft"),this.k.color(...g.color),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(A);const D=this.k.add([this.k.text(g.label,{size:9}),this.k.pos(w+20,v),this.k.anchor("topleft"),this.k.color(180,180,200),this.k.fixed(),this.k.z(902),"minimap"]);this.elements.push(D)})}destroy(){this.clear()}}function Og(e,t){return new Bg(e,t)}const $a={city:{name:"Urban Streets",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.15},{char:"",pattern:"vertical_lines",density:"low",opacity:.12},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"random",count:8,opacity:.1},{char:"",pattern:"random",count:8,opacity:.1}],baseColor:[60,60,70]},mechanical:{name:"Industrial Complex",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.12},{char:"",pattern:"grid",spacing:80,opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.18},{char:"",pattern:"scattered",count:3,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"edges",count:12,opacity:.14}],baseColor:[70,65,60]},futuristic:{name:"Cyber Station",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.13},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.13},{char:"",pattern:"grid",spacing:100,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.15},{char:"",pattern:"corners",opacity:.18},{char:"",pattern:"scattered",count:6,opacity:.14}],baseColor:[55,65,80]},alien:{name:"Alien Vessel",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.12},{char:"~",pattern:"random",count:15,opacity:.1},{char:"",pattern:"scattered",count:4,opacity:.16},{char:"",pattern:"grid",spacing:120,opacity:.13},{char:"",pattern:"corners",opacity:.17},{char:"",pattern:"scattered",count:5,opacity:.14}],baseColor:[65,55,75]}};function Lg(e){for(const[t,s]of Object.entries($a))if(s.floors.includes(e))return{key:t,...s};return{key:"city",...$a.city}}function Hg(e,t,s=800,o=600){const n=Lg(t),r=[],a=30;return n.decorations.forEach(c=>{const l=n.baseColor,d=e.rgb(l[0]+(Math.random()-.5)*20,l[1]+(Math.random()-.5)*20,l[2]+(Math.random()-.5)*20);switch(c.pattern){case"horizontal_lines":{const i=c.density==="high"?40:c.density==="medium"?80:120;for(let p=a;p<o-a;p+=i)r.push({char:c.char,x:s/2,y:p+(Math.random()-.5)*20,color:d,opacity:c.opacity,size:12});break}case"vertical_lines":{const i=c.density==="high"?40:c.density==="medium"?80:120;for(let p=a;p<s-a;p+=i)r.push({char:c.char,x:p+(Math.random()-.5)*20,y:o/2,color:d,opacity:c.opacity,size:12});break}case"wavy_lines":{for(let p=a;p<o-a;p+=60)for(let h=a;h<s-a;h+=40)r.push({char:c.char,x:h+Math.sin(p*.05)*15,y:p,color:d,opacity:c.opacity,size:10});break}case"grid":{const i=c.spacing||80;for(let p=a;p<o-a;p+=i)for(let h=a;h<s-a;h+=i)r.push({char:c.char,x:h+(Math.random()-.5)*10,y:p+(Math.random()-.5)*10,color:d,opacity:c.opacity,size:14});break}case"scattered":{const i=c.count||5;for(let p=0;p<i;p++)r.push({char:c.char,x:a+Math.random()*(s-a*2),y:a+Math.random()*(o-a*2),color:d,opacity:c.opacity,size:16});break}case"random":{const i=c.count||10;for(let p=0;p<i;p++)r.push({char:c.char,x:a+Math.random()*(s-a*2),y:a+Math.random()*(o-a*2),color:d,opacity:c.opacity,size:10+Math.random()*6});break}case"corners":{[{x:a+40,y:a+40},{x:s-a-40,y:a+40},{x:a+40,y:o-a-40},{x:s-a-40,y:o-a-40}].forEach(p=>{r.push({char:c.char,x:p.x,y:p.y,color:d,opacity:c.opacity,size:18})});break}case"edges":{const i=c.count||8,p=Math.floor(i/4);for(let h=0;h<p;h++)r.push({char:c.char,x:s/p*h+s/(p*2),y:a+20,color:d,opacity:c.opacity,size:12});for(let h=0;h<p;h++)r.push({char:c.char,x:s/p*h+s/(p*2),y:o-a-20,color:d,opacity:c.opacity,size:12});for(let h=0;h<p;h++)r.push({char:c.char,x:a+20,y:o/p*h+o/(p*2),color:d,opacity:c.opacity,size:12});for(let h=0;h<p;h++)r.push({char:c.char,x:s-a-20,y:o/p*h+o/(p*2),color:d,opacity:c.opacity,size:12});break}}}),r}function zg(e,t,s=800,o=600){Hg(e,t,s,o).forEach(r=>{e.add([e.text(r.char,{size:r.size}),e.pos(r.x,r.y),e.color(r.color),e.opacity(r.opacity),e.z(0),"floorDecoration"])})}class ci{constructor(t,s){this.playerId=t,this.characterKey=s,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=Rs.STARTING_LEVEL,this.xp=Rs.STARTING_XP,this.xpToNext=Rs.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,velocityX:this.velocityX,velocityY:this.velocityY,health:this.health,maxHealth:this.maxHealth,speed:this.speed,level:this.level,xp:this.xp,xpToNext:this.xpToNext,xpMultiplier:this.xpMultiplier,weaponKey:this.weaponKey,fireRate:this.fireRate,projectileSpeed:this.projectileSpeed,projectileDamage:this.projectileDamage,projectileCount:this.projectileCount,piercing:this.piercing,obstaclePiercing:this.obstaclePiercing,critChance:this.critChance,critDamage:this.critDamage,spreadAngle:this.spreadAngle,weaponRange:this.weaponRange,pickupRadius:this.pickupRadius,defense:this.defense,damageReduction:this.damageReduction,dodgeChance:this.dodgeChance,invulnerable:this.invulnerable,invulnerableTime:this.invulnerableTime,slowed:this.slowed,isDead:this.isDead,weapons:this.weapons,passiveUpgrades:this.passiveUpgrades,upgradeStacks:this.upgradeStacks}}static fromJSON(t){const s=new ci(t.playerId,t.characterKey);return Object.assign(s,t),s}}class di{constructor(t,s,o,n,r={}){this.id=t,this.type=s,this.x=o,this.y=n,this.data=r,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new di(t.id,t.type,t.x,t.y,t.data)}}class hi{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,s){const o=new ci(t,s);return this.players.set(t,o),this.localPlayerId===null&&(this.localPlayerId=t),o}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,s,o,n={}){const r=this.generateEntityId(),a=new di(r,t,s,o,n);return this.entities.set(r,a),a}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(s=>s.type===t&&!s.removed)}removeEntity(t){const s=this.entities.get(t);s&&(s.removed=!0)}cleanupRemovedEntities(){for(const[t,s]of this.entities.entries())s.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,s])=>[t,s.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,s])=>[t,s.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const s=new hi;return s.sessionId=t.sessionId,s.gameMode=t.gameMode,s.isPaused=t.isPaused,s.currentFloor=t.currentFloor,s.currentRoom=t.currentRoom,s.roomCleared=t.roomCleared,s.gameTime=t.gameTime,s.localPlayerId=t.localPlayerId,s.nextEntityId=t.nextEntityId,s.players=new Map(t.players.map(([o,n])=>[o,ci.fromJSON(n)])),s.entities=new Map(t.entities.map(([o,n])=>[o,di.fromJSON(n)])),s.doors=t.doors,s.obstacles=t.obstacles,s}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class Ug{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new hi,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=hi.fromJSON(t),this.gameState}clear(){this.gameState=null}}const Ja=new Ug;class sa{constructor(t,s,o){this.playerId=t,this.frameNumber=s,this.timestamp=o,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const s=new sa(t.playerId,t.frameNumber,t.timestamp);return Object.assign(s,t),s}}class Ng{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1,this.eventHandlers=[]}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(o=>{this.eventHandlers.push(t.onKeyPress(o,()=>{this.keysPressed.add(o)})),this.eventHandlers.push(t.onKeyRelease(o,()=>{this.keysPressed.delete(o)}))}),this.eventHandlers.push(t.onKeyPress("escape",()=>{this.onPausePressed()})),this.eventHandlers.push(t.onKeyPress("space",()=>{this.onInteractPressed()})),this.eventHandlers.push(t.onKeyPress("e",()=>{this.onInteractPressed()}))}setupMouseListeners(){const t=this.k;this.eventHandlers.push(t.onMouseMove(s=>{this.mouseX=s.x,this.mouseY=s.y})),this.eventHandlers.push(t.onMousePress(()=>{this.mousePressed=!0})),this.eventHandlers.push(t.onMouseRelease(()=>{this.mousePressed=!1}))}collectLocalInput(t){const s=new sa(t,this.frameNumber,Date.now());return s.moveX=this.getMoveX(),s.moveY=this.getMoveY(),s.aimX=this.mouseX,s.aimY=this.mouseY,s.firing=!0,s}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const s=new Map;for(const o of t){const n=this.inputQueues.get(o);let r;n&&n.length>0?r=n.shift():r=this.collectLocalInput(o),s.set(o,r)}return this.currentInputs=s,this.inputHistory.push(new Map(s)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,s}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.eventHandlers.forEach(t=>{t&&t.cancel&&t.cancel()}),this.eventHandlers=[],this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class _g{constructor(){this.inputManager=null}init(t){return this.inputManager=new Ng,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const Qa=new _g,Za={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class ui{constructor(t,s,o=null){this.type=t,this.data=s,this.senderId=o,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const s=new ui(t.type,t.data,t.senderId);return s.timestamp=t.timestamp,s}}class Fg{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,s){const o=new ui(t,s,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",o),this.messageQueue.push(o))}broadcast(t,s){this.send(t,s)}sendTo(t,s,o){const n=new ui(s,o,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,n)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const s of t)this.handleMessage(s);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Za.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Za.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,s){this.players.set(t,{id:t,...s,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:s})}removePlayer(t){const s=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:s})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,s){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(s)}off(t,s){if(this.eventHandlers.has(t)){const o=this.eventHandlers.get(t),n=o.indexOf(s);n>-1&&o.splice(n,1)}}emit(t,s,o=null){if(this.eventHandlers.has(t)){const n=this.eventHandlers.get(t);for(const r of n)r(s,o)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class qg{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new Fg,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const Yg=new qg;let ie={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null},Ke={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},_n=!1;function ka(e,t,s=null){const o=s===null,n=o?Je("startingHealth"):s?.startingHealth||0;n>0&&(t.maxHealth+=n*10,t.setHP(t.maxHealth));const r=o?Je("startingDamage"):s?.startingDamage||0;r>0&&(t.projectileDamage+=r);const a=o?Je("startingSpeed"):s?.startingSpeed||0;a>0&&(t.speed+=a*10)}function Xg(e){e.scene("game",t=>{if(t?.resetState){const b=Yg.init("local");Qa.init(e),Ja.init("singleplayer").addPlayer(b,"survivor")}const s=Ja.getState();t?.resetState&&(ie.currentFloor=1,ie.currentRoom=1,ie.playerStats=null,ie.allPlayerStats=null,ie.entryDirection=null,ie.floorMap=null,Dg(),Ke={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{}},_n=!1,e.gameData&&(e.gameData.weaponDetailSavedState=void 0));let o=ie.currentFloor,n=ie.currentRoom;const r={updates:[],keyPresses:[]};let a=!1;const c={enemies:new Ua(128),pickups:new Ua(128)};ig(e),lg();const l=yr(),d=()=>{l>1&&(Jc(o),console.log("[Multiplayer] Generating floor map with seed:",Mr()?"valid":"invalid (0)"));const b=l>1?Zc():null;ie.floorMap=Ig(o,b),ie.minimap&&ie.minimap.destroy(),ie.minimap=Og(e,ie.floorMap),e.gameData&&(e.gameData.minimap=ie.minimap)};!ie.floorMap||ie.floorMap.floor!==o?d():ie.minimap&&ie.minimap.update(),o>Ke.floorsReached&&(Ke.floorsReached=o);const i={1:"Public Access",2:"Local Affiliate",3:"Cable Network",4:"Premium Channel",5:"Streaming Giant",6:"Global Broadcast",7:"Galactic Signal"},p=b=>i[b]||`Network ${b}`;if(n===1){const b=e.add([e.text(`Floor ${o}`,{size:32}),e.pos(e.width()/2,e.height()/3),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.fixed(),e.z(3e3)]),$=e.add([e.text(p(o),{size:20}),e.pos(e.width()/2,e.height()/3+40),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.fixed(),e.z(3e3)]);e.wait(2,()=>{b.exists()&&b.onUpdate(()=>{b.opacity-=.02,b.opacity<=0&&e.destroy(b)}),$.exists()&&$.onUpdate(()=>{$.opacity-=.02,$.opacity<=0&&e.destroy($)})})}const h=30;let f=e.width()/2,g=e.height()/2;if(ie.entryDirection)switch(ie.entryDirection){case"north":f=e.width()/2,g=h;break;case"south":f=e.width()/2,g=e.height()-h;break;case"west":f=h,g=e.height()/2;break;case"east":f=e.width()-h,g=e.height()/2;break}let u;if(ie.playerStats){u=Ni(e,f,g),Object.assign(u,ie.playerStats);const b=u.isRemote;u.isRemote=!1,b&&console.log("[Room Transition] Fixed isRemote flag - local player was incorrectly marked as remote"),u.setHP(ie.playerStats.currentHP||u.maxHealth),ie.playerStats.selectedUpgrades&&(u.selectedUpgrades=new Set(ie.playerStats.selectedUpgrades)),ie.playerStats.activeSynergies&&(u.activeSynergies=new Set(ie.playerStats.activeSynergies)),ie.playerStats.pendingLevelUps&&(u.pendingLevelUps=[...ie.playerStats.pendingLevelUps]),u.upgradeStacks&&Object.keys(u.upgradeStacks).length>0&&li(u),u.isDead?(u.canMove=!1,u.canShoot=!1,u.opacity=.5,u.outline&&u.outline.exists()&&(u.outline.opacity=.5)):(u.canMove=!0,u.canShoot=!0,u.opacity=1,u.outline&&u.outline.exists()&&(u.outline.opacity=1))}else u=Ni(e,f,g),ka(e,u),u.runStats={kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0};const w=oi(),v=Oc();let A=new Array(w.maxSlots).fill(null);if(l>1&&v.isInitialized){const b=w.slots.findIndex(N=>N.isLocal);if(zc(w.isHost,b,e),w.isHost){const N=Nt(),B=sn(o,N);ie.roomTemplateKey=B.key,console.log("[Multiplayer] Host selected first room template:",B.key),ed(B.key)}w.isHost?d():$c(()=>{console.log("[Multiplayer] Client received seed, regenerating floor map"),d()}),u.slotIndex=b,u.playerName=w.slots[b].playerName;const $=b*30;u.pos.x=f+$,vr(b,u),A[b]=u,w.slots.forEach((N,B)=>{if(B!==b&&N.playerId!==null){const K=B*30,M=Ni(e,f+K,g,N.selectedCharacter);if(M.isRemote=!0,M.slotIndex=B,M.playerName=N.playerName,ie.allPlayerStats&&ie.allPlayerStats.length>0){const Se=ie.allPlayerStats.find(we=>we.slotIndex===B);Se&&(Object.assign(M,Se),M.isRemote=!0,M.setHP(Se.currentHP||M.maxHealth),Se.selectedUpgrades&&(M.selectedUpgrades=new Set(Se.selectedUpgrades)),Se.activeSynergies&&(M.activeSynergies=new Set(Se.activeSynergies)),Se.pendingLevelUps&&(M.pendingLevelUps=[...Se.pendingLevelUps]),M.upgradeStacks&&Object.keys(M.upgradeStacks).length>0&&li(M),M.isDead?(M.canMove=!1,M.canShoot=!1,M.opacity=.5,M.outline&&M.outline.exists()&&(M.outline.opacity=.5)):(M.canMove=!0,M.canShoot=!0,M.opacity=1,M.outline&&M.outline.exists()&&(M.outline.opacity=1)))}else ka(e,M,N.permanentUpgradeLevels);Ga(e,M),Wa(e,M,null,!0),vr(B,M),A[B]=M,w.isHost&&M.onDeath(()=>{if(M.isDead=!0,M.canMove=!1,M.canShoot=!1,M.opacity=.5,M.outline&&M.outline.exists()&&(M.outline.opacity=.5),!A.some(we=>we&&we.exists()&&we.hp()>0&&!we.isDead)){const we=Kn(Ke),Le={...Ke,level:u.level,currencyEarned:we};Gn(Le),So(we),Vi(e);const $e=A.filter(ke=>ke&&ke.exists()).map(ke=>({name:ke.playerName||"Player",level:ke.level||1,characterData:ke.characterData,kills:ke.runStats?.kills||0,deaths:ke.runStats?.deaths||0,revives:ke.runStats?.revives||0,damageTaken:ke.runStats?.damageTaken||0,damageDealt:ke.runStats?.damageDealt||0,xpCollected:ke.runStats?.xpPickedUp||0,creditsPickedUp:ke.runStats?.creditsPickedUp||0,bossesKilled:ke.runStats?.bossesKilled||0}));re()&&(Sr(Ke,we,$e),ks()),e.go("gameOver",{runStats:{...Ke},currencyEarned:we,partyStats:$e})}});const W=e.add([e.text(N.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]),le=40,Re=4,ge=-40,be=e.add([e.rect(le,Re),e.pos(M.pos.x,M.pos.y+ge),e.anchor("center"),e.color(50,50,50),e.z(100),"playerHealthBar"]),fe=e.add([e.rect(le,Re),e.pos(M.pos.x,M.pos.y+ge),e.anchor("center"),e.color(100,255,100),e.z(101),"playerHealthBar"]);M.healthBarBg=be,M.healthBar=fe,be.hidden=!0,fe.hidden=!0,W.onUpdate(()=>{if(M.exists()){W.pos=e.vec2(M.pos.x,M.pos.y-30);const Se=M.hp()/M.maxHealth;if(Se<1&&Se>0){be.hidden=!1,fe.hidden=!1,be.pos.x=M.pos.x,be.pos.y=M.pos.y+ge,fe.pos.x=M.pos.x,fe.pos.y=M.pos.y+ge;const Le=Math.max(1,le*Se);fe.use(e.rect(Le,Re)),fe.pos.x=M.pos.x-(le-Le)/2}else be.hidden=!0,fe.hidden=!0}else W.destroy(),be.exists()&&be.destroy(),fe.exists()&&fe.destroy()})}}),he()||_n||(_n=!0,Pe("room_transition",N=>{if(ie.entryDirection=N.entryDirection,N.allPlayerStats){ie.allPlayerStats=N.allPlayerStats;const K=oi().slots.findIndex(W=>W.isLocal),M=N.allPlayerStats.find(W=>W&&W.slotIndex===K);M?(ie.playerStats=M,console.log("[Multiplayer] Client restored stats for slot",K,"level:",M.level)):console.warn("[Multiplayer] Client could not find stats for local slot",K,"in",N.allPlayerStats)}N.roomTemplateKey&&(ie.roomTemplateKey=N.roomTemplateKey,console.log("[Multiplayer] Client received room template:",N.roomTemplateKey)),N.currentFloor&&N.currentFloor!==ie.currentFloor?(console.log(`[Multiplayer] Floor advancement: ${ie.currentFloor} -> ${N.currentFloor}`),ie.currentFloor=N.currentFloor,ie.floorMap=null,ie.entryDirection=null):N.gridDirection&&ie.floorMap&&ie.floorMap.moveToRoom(N.gridDirection),!a&&(a=!0,qi(),e.go("game"))}),Pe("room_completed",()=>{if(Js=!0,E(),We.forEach(K=>{K.exists()&&!K.blocked&&(K.open=!0,K.isSpawnDoor=!1,K.updateVisual())}),ss){const K=We.find(M=>M.direction==="north");K&&K.exists()&&(K.blocked=!1,K.open=!0,K.isSpawnDoor=!1,K.isFloorExit=!0,K.updateVisual())}ie.minimap&&ie.minimap.update();const N=ss?`BOSS DEFEATED! Floor ${o} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",B=e.add([e.text(N,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{B.exists()&&e.destroy(B)})}),Pe("obstacle_data",N=>{console.log("[Multiplayer] Client received obstacle data:",N.obstacles.length,"obstacles"),e.get("obstacle").forEach(B=>e.destroy(B)),N.obstacles.forEach(B=>{const K=Array.isArray(B.color)?e.rgb(B.color[0],B.color[1],B.color[2]):B.color;za(e,B.x,B.y,B.width,B.height,B.type,B.char,K)})}),Pe("door_states",N=>{console.log("[Multiplayer] Client received door states:",N),typeof We<"u"&&We.length>0&&We.forEach(B=>{N.hasOwnProperty(B.direction)&&(B.blocked=N[B.direction],B.updateVisual())})}),Pe("game_over",N=>{const B=N.currencyEarned||Kn(N.runStats||Ke),K={...N.runStats||Ke,level:u.level,currencyEarned:B};Gn(K),So(B),Vi(e),ks(),e.go("gameOver",{runStats:{...N.runStats||Ke},currencyEarned:B,partyStats:N.partyStats||[]})}),Pe("powerup_weapon_applied",N=>{A.forEach(B=>{!B||!B.exists()||_i(B,N.powerupKey)})}),Pe("upgrade_selected",N=>{if(N.slotIndex===b)return;const B=A.find(K=>K.slotIndex===N.slotIndex);B&&B.exists()&&(ea(B,N.upgradeKey),Ed(B,N.upgradeKey),Wn(e,B))}),Pe("level_up_queued",N=>{if(N.slotIndex===b)return;const B=A.find(K=>K.slotIndex===N.slotIndex);B&&B.exists()&&(B.level=N.level,B.pendingLevelUps||(B.pendingLevelUps=[]),B.pendingLevelUps.includes(N.level)||B.pendingLevelUps.push(N.level))}),Pe("synergy_activated",N=>{if(N.slotIndex===b)return;const B=A.find(K=>K.slotIndex===N.slotIndex);B&&B.exists()&&Wn(e,B)}),Pe("powerup_expired",N=>{const B=A.find(K=>K.slotIndex===N.slotIndex);B&&B.exists()&&wr(B)}))}else u.slotIndex=0,A[0]=u;A.filter(b=>b!==null);function D(b,$){if(!b||!b.exists())return;const N=$==="exclamation"?"!":"",B=$==="exclamation"?[255,255,0]:[255,100,150],K=e.add([e.text(N,{size:24}),e.pos(b.pos.x,b.pos.y-50),e.anchor("center"),e.color(...B),e.opacity(1),e.z(1e3),"emote"]);let M=0;const W=1.5;K.onUpdate(()=>{M+=e.dt(),K.pos.x=b.pos.x,K.pos.y=b.pos.y-50-M*30,M<.2?K.scale=e.vec2(1+M*2):K.scale=e.vec2(1.4-(M-.2)*.3),M>W*.6&&(K.opacity=1-(M-W*.6)/(W*.4)),M>=W&&e.destroy(K)})}let Y=0;const P=.1;e.onKeyPress("q",()=>{if(u.isDead)return;const b=e.time();b-Y<P||(Y=b,D(u,"exclamation"),re()&&Dr(u.slotIndex,"exclamation"))}),e.onKeyPress("e",()=>{if(u.isDead)return;const b=e.time();b-Y<P||(Y=b,D(u,"heart"),re()&&Dr(u.slotIndex,"heart"))}),l>1&&Pe("player_emote",b=>{const $=A[b.slotIndex];$&&$.exists()&&D($,b.emoteType)});const m=s.localPlayerId,x=s.getPlayer(m);x&&(x.x=u.pos.x,x.y=u.pos.y,x.health=u.hp(),x.maxHealth=u.maxHealth,x.speed=u.speed,x.level=u.level,x.xp=u.xp,x.xpToNext=u.xpToNext,x.xpMultiplier=u.xpMultiplier||1,x.weaponKey="pistol",x.fireRate=u.fireRate,x.projectileSpeed=u.projectileSpeed,x.projectileDamage=u.projectileDamage,x.projectileCount=u.projectileCount||1,x.piercing=u.piercing||0,x.obstaclePiercing=u.obstaclePiercing||0,x.critChance=u.critChance||.05,x.critDamage=u.critDamage||2,x.spreadAngle=u.spreadAngle||0,x.weaponRange=u.weaponRange||600,x.pickupRadius=u.pickupRadius,x.defense=u.defense||0,x.damageReduction=u.damageReduction||0,x.dodgeChance=u.dodgeChance||0);const E=()=>{if(l<=1)return;let b=0;A.forEach(($,N)=>{if($&&($.exists()&&$.hp()<=0||$.exists()&&$.isDead)){const B=Math.max(1,Math.floor($.maxHealth*.05));$.setHP(B),$.isDead=!1,$.canMove=!0,$.canShoot=!0;const K=e.add([e.text(" REVIVED ",{size:16}),e.pos($.pos.x,$.pos.y-40),e.anchor("center"),e.color(100,255,100),e.opacity(1),e.lifespan(2),e.z(1e3)]);K.onUpdate(()=>{K.pos.y-=30*e.dt(),K.opacity-=.5*e.dt()}),$.opacity=1,$.characterData&&$.characterData.color&&($.color=e.rgb(...$.characterData.color)),$.outline&&$.outline.exists()&&($.outline.opacity=1),b++}}),b>0&&e.get("projectile").forEach($=>{($.isEnemyProjectile||$.isBossProjectile)&&e.destroy($)}),b>0&&re()&&he()&&lo(async()=>{const{broadcastRevivalEvent:$}=await Promise.resolve().then(()=>P0);return{broadcastRevivalEvent:$}},void 0).then(({broadcastRevivalEvent:$})=>{$&&$()})};Ga(e,u);const S=Wa(e,u,E,l>1);if(u.isDead||(u.canMove=!0,u.canShoot=!0),l>1){const b=ld();b>0&&u.addXP&&(console.log("[Multiplayer] Applying pending XP:",b),u.addXP(b))}ie.playerStats&&ie.playerStats.selectedUpgrades&&e.wait(.1,()=>{Wn(e,u)});const I=ie.floorMap.getCurrentRoom();let T;if(l>1&&ie.roomTemplateKey)T=ja(ie.roomTemplateKey),console.log("[Multiplayer] Using synced template:",ie.roomTemplateKey),ie.roomTemplateKey=null;else if(l>1&&!Mr()){const b=Qc();if(b)T=ja(b),console.log("[Multiplayer] Client using first room template:",b);else{console.warn("[Multiplayer] No seed or template key available, using fallback");const $=Nt();T=sn(o,$)}}else I&&I.template?T=I.template:T=sn(o,l>1?Nt():null);const z=Mg(e,o),_=20;zg(e,o,e.width(),e.height()),e.add([e.rect(e.width()-_*2,2),e.pos(e.width()/2,_),e.anchor("center"),e.color(z.wallColor),e.fixed()]),e.add([e.rect(e.width()-_*2,2),e.pos(e.width()/2,e.height()-_),e.anchor("center"),e.color(z.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-_*2),e.pos(_,e.height()/2),e.anchor("center"),e.color(z.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-_*2),e.pos(e.width()-_,e.height()/2),e.anchor("center"),e.color(z.wallColor),e.fixed()]);const j=n===1&&o===1,q=80;let k=e.width()/2,U=e.height()/2;if(ie.entryDirection)switch(ie.entryDirection){case"north":k=e.width()/2,U=h;break;case"south":k=e.width()/2,U=e.height()-h;break;case"west":k=h,U=e.height()/2;break;case"east":k=e.width()-h,U=e.height()/2;break}const F=[],O=l<=1||he();!j&&O&&(T.obstacles.forEach(b=>{const $=Math.sqrt(Math.pow(b.x-f,2)+Math.pow(b.y-g,2)),N=Math.sqrt(Math.pow(b.x-k,2)+Math.pow(b.y-U,2)),B=Math.max(b.width,b.height)/2;if($<q+B||N<q+B)return;const K=Eg(b.x,b.y,b.width,b.height),M=b.type==="wall"?z.obstacleColor:z.coverColor;if(za(e,K.x,K.y,b.width,b.height,b.type,b.char||"#",M),l>1&&he()){let W=null;M&&(Array.isArray(M)?W=M:M.r!==void 0&&(W=[M.r,M.g,M.b])),F.push({x:K.x,y:K.y,width:b.width,height:b.height,type:b.type,char:b.char||"#",color:W})}}),l>1&&he()&&e.wait(.1,()=>{nd(F)})),e.add([e.rect(82,22),e.pos(8,2),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(H.UI_BG)]);const J=e.add([e.text("",{size:pe.HUD}),e.pos(20,6),e.color(...L.WARNING),e.fixed(),e.z(H.UI_TEXT)]),ne=e.add([e.text("0/0",{size:pe.HUD}),e.pos(40,6),e.color(...L.WARNING),e.fixed(),e.z(H.UI_TEXT)]);e.add([e.rect(85,22),e.pos(e.width()-10,2),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(H.UI_BG-1)]),e.add([e.text("$",{size:pe.LABEL}),e.pos(e.width()-20,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);const se=e.add([e.text("0",{size:pe.HUD}),e.pos(e.width()-40,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);if(re()){const b=qc(),$=v.isHost?[100,255,100]:[100,200,255],N=v.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...$),e.fixed(),e.z(H.UI_TEXT)]),e.add([e.text(`${N} (${b}P)`,{size:pe.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...$),e.fixed(),e.z(H.UI_TEXT)])}const Ee=e.width()-40,xe=15,Ae=e.height()-18;e.add([e.rect(Ee,xe),e.pos(20,Ae),e.color(...L.BG_DARK),e.outline(2,e.rgb(...L.TEXT_DISABLED)),e.fixed(),e.z(H.UI_BG)]);const Me=u.xpToNext>0?u.xp/u.xpToNext:0,Oe=Math.max(0,(Ee-34)*Me),Be=e.add([e.rect(Oe,xe-4),e.pos(58,Ae+2),e.color(100,200,255),e.fixed(),e.z(H.UI_BG+1)]),_e=e.add([e.text(Va(u.xp||0,u.xpToNext||10),{size:pe.SMALL-2}),e.pos(e.width()/2,Ae+xe/2),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT)]),ze=36,ae=20+ze/2,oe=Ae+xe/2;e.add([e.circle(ze/2),e.pos(ae,oe),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(H.UI_BG+2)]);const V=e.add([e.text(`${u.level||1}`,{size:pe.BODY}),e.pos(ae,oe),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.UI_BG+3)]),ee=40,te=8,ve=25,Ce=e.add([e.rect(ee,te),e.pos(0,0),e.anchor("center"),e.color(...L.BG_DARK),e.outline(1,e.rgb(...L.TEXT_DISABLED)),e.z(H.OVERLAY)]),ce=e.add([e.rect(ee-2,te-2),e.pos(0,0),e.anchor("center"),e.color(100,255,100),e.z(H.OVERLAY+1)]);Ce.hidden=!0,ce.hidden=!0;const Te=48,qe=25,tt=e.height()-85,is=e.add([e.rect(Te,Te),e.pos(qe,tt),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(H.UI_BG)]),kt=e.add([e.text("",{size:32}),e.pos(qe+Te/2,tt+Te/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.UI_TEXT)]),st=220,xt=90,rt=e.add([e.rect(st,xt),e.pos(qe,tt-xt-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(H.OVERLAY+5)]),Ge=e.add([e.text("",{size:24}),e.pos(qe+15,tt-xt-10+15),e.color(255,255,255),e.fixed(),e.z(H.OVERLAY+6)]),ot=e.add([e.text("Basic Pistol",{size:pe.SMALL,width:160}),e.pos(qe+50,tt-xt-10+10),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+6)]),Xe=e.add([e.text("DMG: 10",{size:pe.SMALL-2}),e.pos(qe+50,tt-xt-10+30),e.color(255,150,150),e.fixed(),e.z(H.OVERLAY+6)]),yt=e.add([e.text("RATE: 3.75/s",{size:pe.SMALL-2}),e.pos(qe+50,tt-xt-10+47),e.color(150,200,255),e.fixed(),e.z(H.OVERLAY+6)]),dt=e.add([e.text("DPS: 37.5",{size:pe.SMALL-2}),e.pos(qe+50,tt-xt-10+64),e.color(255,255,150),e.fixed(),e.z(H.OVERLAY+6)]);rt.hidden=!0,Ge.hidden=!0,ot.hidden=!0,Xe.hidden=!0,yt.hidden=!0,dt.hidden=!0;let Ne=!1;t?.resetState&&(Ne=!1),is.onClick(()=>{Ne=!Ne,rt.hidden=!rt.hidden,Ge.hidden=!Ge.hidden,ot.hidden=!ot.hidden,Xe.hidden=!Xe.hidden,yt.hidden=!yt.hidden,dt.hidden=!dt.hidden});const rs=40,js=qe,as=tt-rs-10,fo=e.add([e.rect(rs,rs),e.pos(js,as),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(H.UI_BG)]),$s=e.add([e.text("",{size:28}),e.pos(js+rs/2,as+rs/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.UI_TEXT)]),ht=e.add([e.text("20",{size:14}),e.pos(js+rs+5,as+rs/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(H.UI_TEXT)]);fo.hidden=!0,$s.hidden=!0,ht.hidden=!0;const Ho=qe+Te+10,Bs=tt,ws=32,An=40,zo=[];function Sn(){if(zo.forEach($=>{$.exists()&&e.destroy($)}),zo.length=0,!u.exists())return;const b=[];u.upgradeStacks&&Object.entries(u.upgradeStacks).forEach(([$,N])=>{N>0&&b.push({key:$,stacks:N})}),b.forEach(($,N)=>{const B=Ho+N*An,K=co[$.key];if(!K)return;const M=e.add([e.rect(ws,ws),e.pos(B,Bs),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(H.UI_BG)]),W=e.add([e.text(K.icon,{size:20}),e.pos(B+ws/2,Bs+ws/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.UI_TEXT)]),le=e.add([e.text($.stacks.toString(),{size:10}),e.pos(B+ws-4,Bs+ws-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(H.UI_TEXT+1)]);zo.push(M,W,le)})}const ls=50,C=e.width()-ls-25,G=e.height()-ls-25,Z=e.add([e.rect(ls,ls),e.pos(C,G),e.color(100,200,255),e.opacity(.9),e.outline(3,e.rgb(255,255,255)),e.area(),e.fixed(),e.z(H.OVERLAY+5)]),ue=e.add([e.text("+",{size:36}),e.pos(C+ls/2,G+ls/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.OVERLAY+6)]),Ue=20,Ve=C+ls-Ue/2,Rt=G-Ue/2,es=e.add([e.circle(Ue/2),e.pos(Ve,Rt),e.anchor("center"),e.color(255,50,50),e.outline(2,e.rgb(255,255,255)),e.fixed(),e.z(H.OVERLAY+7)]),Ct=e.add([e.text("2",{size:12}),e.pos(Ve,Rt),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.OVERLAY+8)]);Z.hidden=!0,ue.hidden=!0,es.hidden=!0,Ct.hidden=!0,Z.onClick(()=>{S&&u.pendingLevelUps&&u.pendingLevelUps.length>0&&S.processPendingLevelUp()});let cs=0;Z.onUpdate(()=>{if(Z.hidden)return;cs+=e.dt()*4;const b=(Math.sin(cs)+1)/2,$=3+b*3,N=200+b*55;Z.outline.width=$,Z.outline.color=e.rgb(N,N,100+b*155);const B=1+b*.05;Z.scale=e.vec2(B,B),ue.scale=e.vec2(B,B)});const wt=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(H.OVERLAY+10)]),zt=e.add([e.text("",{size:pe.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(H.OVERLAY+11)]);wt.hidden=!0,zt.hidden=!0;const Md={level:()=>`Level ${u.level}
XP: ${u.xp}/${u.xpToNext}
Progress: ${Math.floor(u.xp/u.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${Ke.enemiesKilled}`),currency:()=>`Total Credits: ${Ks()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const b=u.weaponDef;return b?`${b.name}
Damage: ${u.projectileDamage}
Fire Rate: ${u.fireRate.toFixed(2)}/s
DPS: ${(u.projectileDamage*u.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(u.hp())}/${u.maxHealth}
Damage Reduction: ${Math.floor(u.damageReduction*100)}%`};function En(b,$,N){const B=Md[b];if(!B)return;const K=B();zt.text=K,wt.pos.x=Math.min($+10,e.width()-210),wt.pos.y=Math.min(N+10,e.height()-70),zt.pos.x=wt.pos.x+5,zt.pos.y=wt.pos.y+5,wt.hidden=!1,zt.hidden=!1}function oa(){wt.hidden=!0,zt.hidden=!0}function Dd(){return{hidden:wt.hidden,text:zt.text,tooltipX:wt.pos.x,tooltipY:wt.pos.y,textX:zt.pos.x,textY:zt.pos.y}}function Rd(b){b&&(wt.hidden=b.hidden,zt.hidden=b.hidden,zt.text=b.text,wt.pos.x=b.tooltipX,wt.pos.y=b.tooltipY,zt.pos.x=b.textX,zt.pos.y=b.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=oa,e.gameData.saveTooltipState=Dd,e.gameData.restoreTooltipState=Rd,e.gameData.minimap=ie.minimap,e.gameData.additionalEnemiesFromSplits=0,e.gameData.incrementSplitEnemies=b=>{Mn+=b,e.gameData.additionalEnemiesFromSplits=Mn},e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,r.updates.push(e.onUpdate(()=>{c.enemies.clear(),e.get("enemy").forEach(b=>c.enemies.insert(b)),e.get("boss").forEach(b=>c.enemies.insert(b)),e.get("miniboss").forEach(b=>c.enemies.insert(b)),c.pickups.clear(),e.get("xpPickup").forEach(b=>c.pickups.insert(b)),e.get("currencyPickup").forEach(b=>c.pickups.insert(b)),e.get("powerupWeaponPickup").forEach(b=>c.pickups.insert(b))})),r.updates.push(e.onUpdate(()=>{rg(e.dt())})),r.updates.push(e.onUpdate(()=>{if(e.paused||Ki())return;const b=e.mousePos();let $=!1;b.x>=20&&b.x<=180&&b.y>=20&&b.y<=35?(En("level",b.x,b.y),$=!0):b.x>=20&&b.x<=180&&b.y>=40&&b.y<=55&&!ne.hidden?(En("enemies",b.x,b.y),$=!0):b.x>=e.width()-130&&b.x<=e.width()-10&&b.y>=10&&b.y<=50?(En("currency",b.x,b.y),$=!0):b.x>=qe&&b.x<=qe+Te&&b.y>=tt&&b.y<=tt+Te&&(En("weapon",b.x,b.y),$=!0),$||oa()}));const bs=e.add([e.text("",{size:pe.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...L.BOSS_NAME),e.fixed(),e.z(H.OVERLAY)]),go=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...L.BG_DARK),e.outline(2,e.rgb(...L.TEXT_DISABLED)),e.fixed(),e.z(H.OVERLAY)]),at=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...L.HEALTH_LOW),e.fixed(),e.z(H.OVERLAY+1)]),ds=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...L.BG_DARK),e.outline(2,e.rgb(...L.TEXT_DISABLED)),e.fixed(),e.z(H.OVERLAY)]),St=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.OVERLAY+1)]),vs=e.add([e.text("",{size:pe.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+2)]),Ut=e.add([e.text("",{size:pe.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+2)]),Os=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...L.BG_DARK),e.outline(2,e.rgb(...L.TEXT_DISABLED)),e.fixed(),e.z(H.OVERLAY)]),It=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...L.XP_BAR),e.fixed(),e.z(H.OVERLAY+1)]),ts=e.add([e.text("",{size:pe.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+2)]);bs.hidden=!0,go.hidden=!0,at.hidden=!0,ds.hidden=!0,St.hidden=!0,vs.hidden=!0,Ut.hidden=!0,Os.hidden=!0,It.hidden=!0,ts.hidden=!0,r.updates.push(e.onUpdate(()=>{e.paused||og(e)})),r.updates.push(e.onUpdate(()=>{e.paused||re()&&_c(e.dt())})),r.updates.push(e.onUpdate(()=>{const b=u.exists()?u.hp():0,$=u.maxHealth>0?b/u.maxHealth:1;V.text=`${u.level||1}`;const N=u.xpToNext>0?u.xp/u.xpToNext:0;if(Be.width=Math.max(0,(Ee-34)*N),_e.text=Va(u.xp,u.xpToNext),se.text=Ks().toString(),$<1&&u.exists()){Ce.hidden=!1,ce.hidden=!1;const M=u.pos.x,W=u.pos.y+ve;Ce.pos=e.vec2(M,W);const le=Math.max(1,(ee-2)*$);ce.use(e.rect(le,te-2));const Re=M-ee/2+1+le/2;ce.pos=e.vec2(Re,W),$>.6?ce.color=e.rgb(100,255,100):$>.3?ce.color=e.rgb(255,200,0):ce.color=e.rgb(255,50,50)}else Ce.hidden=!0,ce.hidden=!0;if(!ss&&!Js){const M=e.get("enemy").length,W=Uo+Mn+(No?1:0),le=e.get("miniboss").length,Re=M+le+Math.max(0,W-mo-Mn-(No&&Ci?1:0));ne.text=`${Re}/${W}`,ne.hidden=!1,J.hidden=!1}else ne.hidden=!0,J.hidden=!0;if(u.exists()&&u.weaponDef){const M=u.weaponDef,W=(u.projectileDamage*u.fireRate).toFixed(1);kt.text=M.icon||"",kt.color=e.rgb(...M.color),Ge.text=M.icon||"",Ge.color=e.rgb(...M.color),ot.text=M.name,ot.color=e.rgb(...L.TEXT_PRIMARY),Xe.text=`DMG: ${u.projectileDamage}`,yt.text=`RATE: ${u.fireRate.toFixed(2)}/s`,dt.text=`DPS: ${W}`,e.paused&&!ag()?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Ne),rt.hidden=!1,Ge.hidden=!1,ot.hidden=!1,Xe.hidden=!1,yt.hidden=!1,dt.hidden=!1):(rt.hidden=!Ne,Ge.hidden=!Ne,ot.hidden=!Ne,Xe.hidden=!Ne,yt.hidden=!Ne,dt.hidden=!Ne)}if(u.exists()){A0(u,e.dt());const M=E0(u);M?(fo.hidden=!1,$s.hidden=!1,ht.hidden=!1,$s.text=M.icon,$s.color=e.rgb(...M.color),fo.outline.color=e.rgb(...M.color),M.isAmmoBased?ht.text=`${M.ammo}`:M.isTimeBased&&(ht.text=`${Math.ceil(M.duration)}s`)):(fo.hidden=!0,$s.hidden=!0,ht.hidden=!0)}if(e.time()%.5<e.dt()&&Sn(),u.exists()&&u.pendingLevelUps&&u.pendingLevelUps.length>0){Z.hidden=!1,ue.hidden=!1;const M=u.pendingLevelUps.length;M>1?(es.hidden=!1,Ct.hidden=!1,Ct.text=M.toString()):(es.hidden=!0,Ct.hidden=!0)}else Z.hidden=!0,ue.hidden=!0,es.hidden=!0,Ct.hidden=!0;const B=e.get("boss"),K=B.filter(M=>M.type==="twinGuardianMelee"||M.type==="twinGuardianRanged");if(K.length>0){const M=K.find(le=>le.type==="twinGuardianMelee"),W=K.find(le=>le.type==="twinGuardianRanged");if(M&&W&&(M.exists()||W.exists())){bs.hidden=!1,bs.text="THE CO-HOSTS";const le=M.exists()?M.hp():0,Re=W.exists()?W.hp():0,ge=le+Re,be=(M.maxHealth||0)+(W.maxHealth||0),fe=be>0?Math.max(0,Math.min(1,ge/be)):0;at.width=296*fe,at.pos.x=e.width()/2-296*(1-fe)/2,vs.text=`${Math.max(0,Math.floor(ge))}/${be}`,go.hidden=!1,at.hidden=!1,vs.hidden=!1;const Se=M.exists()&&M.shieldHealth||0,we=W.exists()&&W.shieldHealth||0,Le=Se+we,$e=(M.maxShieldHealth||0)+(W.maxShieldHealth||0);if($e>0){const Fo=Math.max(0,Math.min(1,Le/$e));It.width=296*Fo,It.pos.x=e.width()/2-296*(1-Fo)/2,ts.text=`Shield: ${Math.max(0,Math.floor(Le))}/${$e}`,Os.hidden=!1,It.hidden=!1,ts.hidden=!1}else Os.hidden=!0,It.hidden=!0,ts.hidden=!0;const ke=M.exists()&&M.armorHealth||0,_o=W.exists()&&W.armorHealth||0,In=ke+_o,Oi=(M.maxArmorHealth||0)+(W.maxArmorHealth||0);if(Oi>0){const Fo=Math.max(0,Math.min(1,In/Oi));St.width=296*Fo,St.pos.x=e.width()/2-296*(1-Fo)/2,Ut.text=`Armor: ${Math.max(0,Math.floor(In))}/${Oi}`,ds.hidden=!1,St.hidden=!1,Ut.hidden=!1}else ds.hidden=!0,St.hidden=!0,Ut.hidden=!0;fe>.6?at.color=e.rgb(255,50,50):fe>.3?at.color=e.rgb(255,150,50):at.color=e.rgb(255,200,0)}else{const le=M?.exists()?M:W;if(le){const Re=le.hp(),ge=le.maxHealth,be=le.shieldHealth||0,fe=le.maxShieldHealth||0,Se=le.armorHealth||0,we=le.maxArmorHealth||0;bs.hidden=!1,bs.text=le.enraged?"THE CO-HOSTS (ENRAGED)":"THE CO-HOSTS";const Le=Math.max(0,Math.min(1,Re/ge));if(at.width=296*Le,at.pos.x=e.width()/2-296*(1-Le)/2,vs.text=`${Math.max(0,Math.floor(Re))}/${ge}`,go.hidden=!1,at.hidden=!1,vs.hidden=!1,fe>0){const $e=Math.max(0,Math.min(1,be/fe));It.width=296*$e,It.pos.x=e.width()/2-296*(1-$e)/2,ts.text=`Shield: ${Math.max(0,Math.floor(be))}/${fe}`,Os.hidden=!1,It.hidden=!1,ts.hidden=!1}else Os.hidden=!0,It.hidden=!0,ts.hidden=!0;if(we>0){const $e=Math.max(0,Math.min(1,Se/we));St.width=296*$e,St.pos.x=e.width()/2-296*(1-$e)/2,Ut.text=`Armor: ${Math.max(0,Math.floor(Se))}/${we}`,ds.hidden=!1,St.hidden=!1,Ut.hidden=!1}else ds.hidden=!0,St.hidden=!0,Ut.hidden=!0;Le>.6?at.color=e.rgb(255,50,50):Le>.3?at.color=e.rgb(255,150,50):at.color=e.rgb(255,200,0)}else bs.hidden=!0,go.hidden=!0,at.hidden=!0,ds.hidden=!0,St.hidden=!0,vs.hidden=!0,Ut.hidden=!0}}else if(B.length>0&&B[0].exists()){const M=B[0],W=M.hp(),le=M.maxHealth,Re=M.shieldHealth||0,ge=M.maxShieldHealth||0,be=M.armorHealth||0,fe=M.maxArmorHealth||0;let Se="BOSS";M.type==="twinGuardianMelee"||M.type==="twinGuardianRanged"?Se="THE CO-HOSTS":_s[M.type]?.name&&(Se=`THE ${_s[M.type].name.toUpperCase()}`),bs.hidden=!1,go.hidden=!1,at.hidden=!1,ds.hidden=!1,St.hidden=!1,vs.hidden=!1,Ut.hidden=!1,bs.text=Se;const we=Math.max(0,Math.min(1,W/le));if(at.width=296*we,at.pos.x=e.width()/2-296*(1-we)/2,vs.text=`${Math.max(0,Math.floor(W))}/${le}`,ge>0){const Le=Math.max(0,Math.min(1,Re/ge));It.width=296*Le,It.pos.x=e.width()/2-296*(1-Le)/2,ts.text=`Shield: ${Math.max(0,Math.floor(Re))}/${ge}`,Os.hidden=!1,It.hidden=!1,ts.hidden=!1}else Os.hidden=!0,It.hidden=!0,ts.hidden=!0;if(fe>0){const Le=Math.max(0,Math.min(1,be/fe));St.width=296*Le,St.pos.x=e.width()/2-296*(1-Le)/2,Ut.text=`Armor: ${Math.max(0,Math.floor(be))}/${fe}`,ds.hidden=!1,St.hidden=!1,Ut.hidden=!1}else ds.hidden=!0,St.hidden=!0,Ut.hidden=!0;we>.6?at.color=e.rgb(255,50,50):we>.3?at.color=e.rgb(255,150,50):at.color=e.rgb(255,200,0)}else bs.hidden=!0,go.hidden=!0,at.hidden=!0,ds.hidden=!0,St.hidden=!0,vs.hidden=!0,Ut.hidden=!0,Os.hidden=!0,It.hidden=!0,ts.hidden=!0})),r.updates.push(e.onUpdate(()=>{if(!u.exists()||e.paused)return;const b=s.getPlayer(m);b&&(b.x=u.pos.x,b.y=u.pos.y,b.velocityX=0,b.velocityY=0,b.health=u.hp(),b.maxHealth=u.maxHealth,b.level=u.level,b.xp=u.xp,b.xpToNext=u.xpToNext,b.projectileDamage=u.projectileDamage,b.fireRate=u.fireRate,b.projectileSpeed=u.projectileSpeed,b.projectileCount=u.projectileCount||1,b.piercing=u.piercing||0,b.critChance=u.critChance||.05,b.critDamage=u.critDamage||2,b.pickupRadius=u.pickupRadius,b.defense=u.defense||0,b.isDead=u.isDead||!u.exists()||u.hp()<=0,b.invulnerable=u.invulnerable||!1,s.updateTime(e.dt()))})),s.currentFloor=o,s.currentRoom=n,s.roomCleared=!1,r.updates.push(e.onUpdate(()=>{if(e.paused)return;Qa.getManager().getInputsForFrame([m]).get(m)}));let Js=!1;const ss=I?I.isBossRoom:n===3;let Uo=ss?0:24+(o-1)*6,mo=0,Cd=2,na=!1,Ci=!1,No=!1,Td=4,Ti=0,Mn=0;const ia=l>1?Nt():new Bo(Date.now());if(!ss&&n!==1){const b=.15+(o-1)*.05;No=ia.next()<b}No&&(Uo=Math.floor(Uo*.5));function Pd(b,$){const N=["brute","sentinel","berserker","guardian","warlock"];if(b>=3)return N[$.range(0,N.length)];{const B=["brute","berserker","guardian"];return B[$.range(0,B.length)]}}function Id(b){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[b]||"gatekeeper"}const We=[],Bd=[{x:e.width()/2,y:h,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-h,direction:"south",gridDir:"down"},{x:h,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-h,y:e.height()/2,direction:"east",gridDir:"right"}],Od=ie.floorMap?ie.floorMap.getAvailableExits():[],Ld=new Set(Od.map(b=>b.direction));Bd.forEach(b=>{const $=q0(e,b.x,b.y,b.direction);$.open=!1,$.isSpawnDoor=!0,$.gridDirection=b.gridDir,(b.gridDir===null||!Ld.has(b.gridDir))&&($.blocked=!0),$.updateVisual(),We.push($)}),l>1&&he()&&e.wait(.1,()=>{const b={};We.forEach($=>{b[$.direction]=$.blocked}),Ie("door_states",b)});let Dn=0;const Hd=.33;let ra=!1;r.updates.push(e.onUpdate(()=>{if(e.paused||Js)return;if(ra||(Ti=e.time(),ra=!0),ss){if(!na&&(!re()||he())){na=!0;const K=Id(o),M=l>1?Nt():null;if(K==="twinGuardian"){const W=We.filter(fe=>fe.direction!==ie.entryDirection);let le,Re;if(W.length>=2){const fe=[...W];for(let we=fe.length-1;we>0;we--){const Le=M?M.range(0,we+1):Math.floor(Math.random()*(we+1));[fe[we],fe[Le]]=[fe[Le],fe[we]]}le=fe[0];const Se={north:"south",south:"north",east:"west",west:"east"};Re=W.find(we=>we.direction===Se[le.direction])||fe[1]}else le=We[0],Re=We[We.length>1?1:0];const ge=b0(e,le,Re,o,M);re()&&he()&&(Array.isArray(ge)?ge.forEach(fe=>{Kt(fe,{type:"twinGuardian",floor:o})}):ge&&Kt(ge,{type:"twinGuardian",floor:o})),qa();const be=e.add([e.text("THE CO-HOSTS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{be.exists()&&e.destroy(be)})}else{let W=We.find(Se=>Se.direction==="north");if(!W||ie.entryDirection==="north"&&We.length>1){const Se=We.filter(we=>we.direction!==ie.entryDirection);if(Se.length>0){const we=M?M.range(0,Se.length):Math.floor(Math.random()*Se.length);W=Se[we]}else{const we=M?M.range(0,We.length):Math.floor(Math.random()*We.length);W=We[we]}}const le=W?W.pos.x:e.width()/2,Re=W?W.pos.y:e.height()/2,ge=ii(e,le,Re,K,o,M);re()&&he()&&Kt(ge,{type:K,floor:o,isBoss:!0}),qa();let be="BOSS";K==="twinGuardian"?be="THE CO-HOSTS":_s[K]?.name&&(be=`THE ${_s[K].name.toUpperCase()}`);const fe=e.add([e.text(be,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{fe.exists()&&e.destroy(fe)})}}if(!re()||he()){const K=e.get("boss"),M=e.get("enemy").filter(W=>W.isBossMinion);K.length===0&&M.length===0&&!Js&&(Js=!0,aa())}return}if(No&&!Ci&&(!re()||he())&&e.time()-Ti>=1){Ci=!0;const K=Pd(o,ia),M=l>1?Nt():null,W=We.filter($e=>$e.direction!==ie.entryDirection),le=W.length>0?W:We,Re=M?M.range(0,le.length):Math.floor(Math.random()*le.length),ge=le[Re],be=ge.pos.x,fe=ge.pos.y,Se=F0(e,be,fe,K,o);re()&&he()&&Kt(Se,{type:K,floor:o});const we=yn[K]?.name||"MINIBOSS",Le=e.add([e.text(`MINIBOSS: ${we.toUpperCase()}`,{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{Le.exists()&&e.destroy(Le)})}const b=e.get("enemy").length,$=e.get("miniboss").length;if(mo>=Uo&&b===0&&$===0&&!Js&&(!re()||he())&&(Js=!0,aa()),mo<Uo&&(!re()||he())){if(Dn+=e.dt(),mo===0&&Dn<Cd)return;if(Dn>=Hd){Dn=0,mo++;const K=l>1?Nt():null;if(K)for(let M=0;M<mo-1;M++)K.next();if(We.length>0){const M=e.time()-Ti,le=ie.entryDirection&&M<Td?We.filter(In=>In.direction!==ie.entryDirection):We,Re=le.length>0?le:We,ge=K?K.range(0,Re.length):Math.floor(Math.random()*Re.length),be=Re[ge],fe=be.pos.x,Se=be.pos.y,we=15,Le=fe+(K?K.next()-.5:Math.random()-.5)*we,$e=Se+(K?K.next()-.5:Math.random()-.5)*we,ke=Tr(o,K),_o=Ys(e,Le,$e,ke,o,K);re()&&he()&&Kt(_o,{type:ke,floor:o})}else{const M=K?K.range(0,4):Math.floor(e.rand(0,4));let W,le;switch(M){case 0:W=K?K.rangeFloat(_,e.width()-_):e.rand(_,e.width()-_),le=_;break;case 1:W=e.width()-_,le=K?K.rangeFloat(_,e.height()-_):e.rand(_,e.height()-_);break;case 2:W=K?K.rangeFloat(_,e.width()-_):e.rand(_,e.width()-_),le=e.height()-_;break;case 3:W=_,le=K?K.rangeFloat(_,e.height()-_):e.rand(_,e.height()-_);break}const Re=Tr(o,K),ge=Ys(e,W,le,Re,o,K);re()&&he()&&Kt(ge,{type:Re,floor:o})}}}})),r.updates.push(e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(b=>{if(b.hp()<=0&&!b.isDead){b.isDead=!0;const $=b.xpValue,N=b.pos.x,B=b.pos.y;if(b.cleanupHealthBars&&b.cleanupHealthBars(),b.explodes&&b.explosionRadius){const W=b.explosionRadius,le=b.explosionDamage||15;u.exists()&&Math.sqrt(Math.pow(u.pos.x-N,2)+Math.pow(u.pos.y-B,2))<=W&&u.takeDamage(le),c.enemies.getNearby(N,B,W).forEach(ge=>{if(ge===b||!ge.exists())return;const be=ge.pos.x-N,fe=ge.pos.y-B;be*be+fe*fe<=W*W&&ge.hurt(le)}),Hn(e,N,B,{color:[255,150,50]})}else Hn(e,N,B,{color:[255,100,100]});if(b.shrapnel&&b.shrapnelCount){const W=b.shrapnelCount,le=Math.PI*2/W,Re=250,ge=Math.floor((b.explosionDamage||15)*.6);for(let be=0;be<W;be++){const fe=le*be,Se=e.vec2(Math.cos(fe),Math.sin(fe)),we=ns(e,N,B,Se,Re,ge,0,0,!1);we.isEnemyProjectile=!0,we.color=e.rgb(...b.originalColor)}}b.cleanupHealthBars&&typeof b.cleanupHealthBars=="function"&&b.cleanupHealthBars(),re()&&b.mpEntityId&&(he()?Ei({entityId:b.mpEntityId,entityType:"enemy",x:N,y:B}):od({entityId:b.mpEntityId,entityType:"enemy",x:N,y:B})),e.destroy(b),_a(),Ke.enemiesKilled++;const K=b.type||b.enemyType||"basic";Ke.killsByType[K]=(Ke.killsByType[K]||0)+1;const M=b.lastHitBySlot;if(M!==void 0&&A[M]&&A[M].runStats?A[M].runStats.kills++:u.runStats&&u.runStats.kills++,!re()||he()){const W=l>1?Nt():null;en(e,N,B,$);const le=W?W.range(1,4):Math.floor(Math.random()*3)+1,Re=1;for(let be=0;be<le;be++){const fe=W?(W.next()-.5)*20:(Math.random()-.5)*20,Se=W?(W.next()-.5)*20:(Math.random()-.5)*20,we=Vn();tn(e,N+fe,B+Se,Re,we)}const ge=v0(b.type,o);if(ge){const be=W?(W.next()-.5)*30:(Math.random()-.5)*30,fe=W?(W.next()-.5)*30:(Math.random()-.5)*30;La(e,N+be,B+fe,ge)}}}}),e.get("miniboss").forEach(b=>{if(b.hp()<=0&&!b.isDead){b.isDead=!0;const $=b.xpValue,N=b.pos.x,B=b.pos.y;Hn(e,N,B,{color:[255,150,100],isMiniboss:!0}),e.destroy(b),_a(),Ke.enemiesKilled++;const K=b.type||"miniboss";Ke.killsByType[K]=(Ke.killsByType[K]||0)+1;const M=b.lastHitBySlot;if(M!==void 0&&A[M]&&A[M].runStats?A[M].runStats.kills++:u.runStats&&u.runStats.kills++,!re()||he()){const le=l>1?Nt():null;en(e,N,B,$);const Re=le?le.range(10,16):Math.floor(Math.random()*6)+10,ge=1;for(let be=0;be<Re;be++){const fe=Math.PI*2/Re*be,Se=le?30+le.next()*20:30+Math.random()*20,we=Math.cos(fe)*Se,Le=Math.sin(fe)*Se;tn(e,N+we,B+Le,ge)}}const W=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(N,B-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{W.exists()&&e.destroy(W)})}}),e.get("boss").forEach(b=>{if(b.hp()<=0&&!b.isDead){b.isDead=!0;const $=b.xpValue,N=b.pos.x,B=b.pos.y;Hn(e,N,B,{color:[255,200,100],isBoss:!0}),e.destroy(b),k0(),Ke.enemiesKilled++,Ke.bossesKilled++;const K=b.type||"boss";Ke.killsByType[K]=(Ke.killsByType[K]||0)+1;const M=b.lastHitBySlot;if(M!==void 0&&A[M]&&A[M].runStats?(A[M].runStats.kills++,A[M].runStats.bossesKilled++):u.runStats&&(u.runStats.kills++,u.runStats.bossesKilled++),!re()||he()){const le=l>1?Nt():null;en(e,N,B,$);const Re=le?le.range(20,31):Math.floor(Math.random()*11)+20,ge=1,be=Vn();for(let fe=0;fe<Re;fe++){const Se=Math.PI*2/Re*fe,we=le?40+le.next()*30:40+Math.random()*30,Le=Math.cos(Se)*we,$e=Math.sin(Se)*we;tn(e,N+Le,B+$e,ge,be)}}const W=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(N,B-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{W.exists()&&e.destroy(W)})}}))})),r.updates.push(e.onUpdate(()=>{if(!u.exists()||e.paused)return;const b=u.pickupRadius*1.5,$=new Set;l===1?c.pickups.getNearby(u.pos.x,u.pos.y,b).forEach(N=>{N.is&&N.is("xpPickup")&&$.add(N)}):A.forEach(N=>{!N||!N.exists()||N.isDead||c.pickups.getNearby(N.pos.x,N.pos.y,b).forEach(B=>{B.is&&B.is("xpPickup")&&$.add(B)})}),$.forEach(N=>{if(N.collected)return;let B=u,K=e.vec2(u.pos.x-N.pos.x,u.pos.y-N.pos.y).len();if(l>1&&A.forEach(M=>{if(!M||!M.exists()||M.isDead)return;const W=e.vec2(M.pos.x-N.pos.x,M.pos.y-N.pos.y).len();W<K&&(K=W,B=M)}),!N.magnetizing&&K<=B.pickupRadius&&(N.magnetizing=!0,N.targetPlayer=B),K<=nt.COLLECTION_RADIUS&&!N.collected){if(re()&&!he())return;N.collected=!0,J0(),l>1?he()&&(u.exists()&&!u.isDead&&u.addXP&&u.addXP(N.value),rd(N.value)):u.addXP(N.value),N.isFlyingToUI=!0}})})),r.updates.push(e.onUpdate(()=>{if(!u.exists()||e.paused)return;const b=u.pickupRadius*1.5,$=new Set;l===1?c.pickups.getNearby(u.pos.x,u.pos.y,b).forEach(B=>{B.is&&B.is("currencyPickup")&&$.add(B)}):A.forEach(B=>{!B||!B.exists()||B.isDead||c.pickups.getNearby(B.pos.x,B.pos.y,b).forEach(K=>{K.is&&K.is("currencyPickup")&&$.add(K)})}),$.forEach(B=>{if(B.collected)return;let K=u,M=e.vec2(u.pos.x-B.pos.x,u.pos.y-B.pos.y).len();if(l>1&&A.forEach(W=>{if(!W||!W.exists()||W.isDead)return;const le=e.vec2(W.pos.x-B.pos.x,W.pos.y-B.pos.y).len();le<M&&(M=le,K=W)}),!B.magnetizing&&M<=K.pickupRadius&&(B.magnetizing=!0,B.targetPlayer=K),M<=nt.COLLECTION_RADIUS&&!B.collected){if(re()&&!he())return;B.collected=!0,Fa(),So(B.value),K&&K.runStats&&(K.runStats.creditsPickedUp+=B.value),re()&&ad(B.value),B.isFlyingToUI=!0}}),c.pickups.getNearby(u.pos.x,u.pos.y,u.pickupRadius*1.5).forEach(B=>{if(!B.is||!B.is("powerupWeaponPickup")||B.collected)return;const K=e.vec2(u.pos.x-B.pos.x,u.pos.y-B.pos.y).len();if(!B.magnetizing&&K<=u.pickupRadius&&(B.magnetizing=!0,B.targetPlayer=u),K<=nt.COLLECTION_RADIUS&&!B.collected){if(re()&&!he())return;B.collected=!0,Fa(),re()&&he()?(e.get("player").forEach(ge=>{_i(ge,B.powerupKey)}),Kc(B.powerupKey)):_i(u,B.powerupKey);const M=Vs[B.powerupKey],W=e.add([e.text(M.icon,{size:32}),e.pos(u.pos.x,u.pos.y-30),e.color(...M.color),e.anchor("center"),e.z(H.UI_TEXT+1),e.opacity(1)]);let le=0;W.onUpdate(()=>{le+=e.dt(),W.pos.y-=50*e.dt(),W.opacity=Math.max(0,1-le/.8),le>=.8&&e.destroy(W)}),e.destroy(B)}})}));let je=null,ct=null,Rn=0,xo=null,Pi=!1;const zd=.5,Ud=10;re()&&!he()&&Pe("door_progress",b=>{if(b.clear){ct&&ct.exists()&&e.destroy(ct),je&&je.exists()&&e.destroy(je),ct=null,je=null;return}(!ct||!ct.exists())&&(ct=e.add([e.circle(20),e.pos(b.doorX,b.doorY),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),je=e.add([e.circle(18),e.pos(b.doorX,b.doorY),e.anchor("center"),e.color(b.isForced?255:100,b.isForced?200:255,b.isForced?0:100),e.opacity(0),e.z(201),"doorProgress"])),je&&je.exists()&&(je.opacity=b.progress,je.scale=e.vec2(b.progress,b.progress),je.color=e.rgb(b.isForced?255:100,b.isForced?200:255,b.isForced?0:100))}),r.updates.push(e.onUpdate(()=>{!u.exists()||e.paused||a||re()&&!he()||(e.get("door").forEach(b=>{if(!(!b.open||a||b.isSpawnDoor||b.blocked))if(l>1){let $=!1,N=!0;A.forEach((W,le)=>{if(!W||!W.exists()||W.isDead||W.hp()<=0)return;const ge=e.vec2(W.pos.x-b.pos.x,W.pos.y-b.pos.y).len()<=40;le===0&&($=ge),ge||(N=!1)});const B=N||$,K=$&&!N,M=K?Ud:zd;if(B){(xo!==b||Pi!==K)&&(Rn=0,xo=b,Pi=K,ct&&ct.exists()&&e.destroy(ct),je&&je.exists()&&e.destroy(je),ct=e.add([e.circle(20),e.pos(b.pos.x,b.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),je=e.add([e.circle(18),e.pos(b.pos.x,b.pos.y),e.anchor("center"),e.color(K?255:100,K?200:255,K?0:100),e.opacity(0),e.z(201),"doorProgress"])),Rn+=e.dt();const W=Math.min(Rn/M,1);je&&je.exists()&&(je.opacity=W,je.scale=e.vec2(W,W)),re()&&Ie("door_progress",{doorX:b.pos.x,doorY:b.pos.y,progress:W,isForced:K}),W>=1&&(a=!0,qi(),ct&&ct.exists()&&e.destroy(ct),je&&je.exists()&&e.destroy(je),xo=null,re()&&Ie("door_progress",{progress:0,clear:!0}),la(b.direction))}else xo===b&&(Rn=0,xo=null,Pi=!1,ct&&ct.exists()&&e.destroy(ct),je&&je.exists()&&e.destroy(je),re()&&Ie("door_progress",{progress:0,clear:!0}))}else e.vec2(u.pos.x-b.pos.x,u.pos.y-b.pos.y).len()<=40&&(a=!0,qi(),la(b.direction))}),!xo&&ct&&ct.exists()&&(e.destroy(ct),e.destroy(je)))}));function Nd(){if(!u.exists())return;const b=e.width()/2,$=e.height()/2,N=5,B=3,K=ss?3:1,M=ss?4:1,W=o*.5,le=Math.floor((N+W)*K),Re=Math.floor((B+W)*M),ge=l>1?Nt():null;for(let be=0;be<le;be++){const fe=Math.PI*2*be/le+(ge?ge.next():Math.random())*.3,Se=40+(ge?ge.next():Math.random())*60,we=b+Math.cos(fe)*Se,Le=$+Math.sin(fe)*Se,$e=Math.floor(1+o*.5);en(e,we,Le,$e)}for(let be=0;be<Re;be++){const fe=Math.PI*2*be/Re+(ge?ge.next():Math.random())*.3+.5,Se=50+(ge?ge.next():Math.random())*70,we=b+Math.cos(fe)*Se,Le=$+Math.sin(fe)*Se,$e=Math.floor(1+o*.3),ke=Vn();tn(e,we,Le,$e,ke)}if(ss){const be=Object.keys(Vs),fe=1+Math.floor((ge?ge.next():Math.random())*2);for(let Se=0;Se<fe;Se++){const we=(ge?ge.next():Math.random())*Math.PI*2,Le=80+(ge?ge.next():Math.random())*40,$e=b+Math.cos(we)*Le,ke=$+Math.sin(we)*Le,_o=be[Math.floor((ge?ge.next():Math.random())*be.length)];La(e,$e,ke,_o)}}}function aa(){if(s.roomCleared=!0,s.clearRoom(),re()&&he()&&id(),l>1&&E(),Ke.roomsCleared++,ie.floorMap&&I&&ie.floorMap.markRoomCleared(I.position.x,I.position.y),We.forEach(N=>{N.exists()&&!N.blocked&&(N.open=!0,N.isSpawnDoor=!1,N.updateVisual())}),ss){const N=We.find(B=>B.direction==="north");N&&N.exists()&&(N.blocked=!1,N.open=!0,N.isSpawnDoor=!1,N.isFloorExit=!0,N.updateVisual())}ie.minimap&&ie.minimap.update(),(!re()||he())&&Nd();const b=ss?`BOSS DEFEATED! Floor ${o} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",$=e.add([e.text(b,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{$.exists()&&e.destroy($)})}function la(b){ie.allPlayerStats=A.map((M,W)=>!M||!M.exists()?null:{slotIndex:M.slotIndex!==void 0?M.slotIndex:W,playerName:M.playerName,isRemote:M.isRemote||!1,isDead:M.isDead||!1,level:M.level,xp:M.xp,xpToNext:M.xpToNext,maxHealth:M.maxHealth,currentHP:M.hp(),speed:M.speed,fireRate:M.fireRate,projectileSpeed:M.projectileSpeed,projectileDamage:M.projectileDamage,pickupRadius:M.pickupRadius,xpMultiplier:M.xpMultiplier||1,dodgeChance:M.dodgeChance||0,damageReduction:M.damageReduction||0,fireDotMultiplier:M.fireDotMultiplier||1,projectileCount:M.projectileCount||1,piercing:M.piercing||0,obstaclePiercing:M.obstaclePiercing||0,critChance:M.critChance||0,critDamage:M.critDamage||2,spreadAngle:M.spreadAngle||0,defense:M.defense||0,weaponRange:M.weaponRange||600,weapons:M.weapons||[],passiveUpgrades:M.passiveUpgrades||[],upgradeStacks:M.upgradeStacks||{},selectedUpgrades:M.selectedUpgrades?Array.from(M.selectedUpgrades):[],activeSynergies:M.activeSynergies?Array.from(M.activeSynergies):[],piercingDamageBonus:M.piercingDamageBonus||1,characterData:M.characterData,weaponDef:M.weaponDef,baseProjectileDamage:M.baseProjectileDamage,baseFireRate:M.baseFireRate,baseProjectileSpeed:M.baseProjectileSpeed,pendingLevelUps:M.pendingLevelUps||[],powerupWeapon:M.powerupWeapon||null,powerupAmmo:M.powerupAmmo!==void 0?M.powerupAmmo:null,powerupDuration:M.powerupDuration!==void 0?M.powerupDuration:null,originalWeapon:M.originalWeapon||null,weaponKey:M.weaponKey,runStats:M.runStats||{kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}).filter(M=>M!==null);const $=ie.allPlayerStats.find(M=>!M.isRemote);$&&(ie.playerStats=$);const N={north:"south",south:"north",west:"east",east:"west"};ie.entryDirection=N[b]||null;const K={north:"up",south:"down",east:"right"}[b];if(ie.floorMap?(K?ie.floorMap.moveToRoom(K)?(ie.floorMap.getCurrentRoom(),n=ie.floorMap.getVisitedCount()):(console.error("[Game] Failed to move in floor map - should not happen!"),n++):(console.warn("[Game] Invalid door direction:",b),n++),I&&I.isBossRoom&&I.cleared?(o++,gr(o-1).then(W=>{if(W){const le=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{le.exists()&&e.destroy(le)})}}),ie.floorMap=null,ie.entryDirection=null,n=1,s.nextFloor()):s.nextRoom()):(n++,n>3?(o++,gr(o-1).then(M=>{if(M){const W=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{W.exists()&&e.destroy(W)})}}),n=1,ie.entryDirection=null,s.nextFloor()):s.nextRoom()),ie.currentFloor=o,ie.currentRoom=n,re()&&he()){const M=Nt(),W=sn(o,M);ie.roomTemplateKey=W.key,console.log("[Multiplayer] Host selected next room template:",W.key),cd(ie.entryDirection,ie.allPlayerStats,K,o,ie.roomTemplateKey)}e.go("game")}u.onDeath(()=>{if(u.orbitalOrbs&&(u.orbitalOrbs.forEach(B=>{B.exists()&&e.destroy(B)}),u.orbitalOrbs=[]),l>1&&(re()&&u.slotIndex!==void 0&&hd(u.slotIndex),u.isDead=!0,u.canMove=!1,u.canShoot=!1,u.opacity=.5,u.outline&&u.outline.exists()&&(u.outline.opacity=.5),!he()||A.some(K=>K&&K.exists()&&K.hp()>0&&!K.isDead)))return;const b=Kn(Ke),$={...Ke,level:u.level,currencyEarned:b};Gn($),So(b),Vi(e);const N=A.filter(B=>B&&B.exists()).map(B=>({name:B.playerName||"Player",level:B.level||1,characterData:B.characterData,kills:B.runStats?.kills||0,deaths:B.runStats?.deaths||0,revives:B.runStats?.revives||0,damageTaken:B.runStats?.damageTaken||0,damageDealt:B.runStats?.damageDealt||0,xpCollected:B.runStats?.xpPickedUp||0,creditsPickedUp:B.runStats?.creditsPickedUp||0,bossesKilled:B.runStats?.bossesKilled||0}));re()&&he()&&Sr(Ke,b,N),re()&&ks(),e.go("gameOver",{runStats:{...Ke},currencyEarned:b,partyStats:N})});const Ii=e.add([e.rect(270,250),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(0,0,0),e.opacity(.9),e.outline(3,e.rgb(200,200,200)),e.fixed(),e.z(2e3),"pauseOverlay"]),Bi=e.add([e.text("PAUSED",{size:48}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2001),"pauseText"]),Cn=e.height()/2,Tn=60,ca=200,da=40,ha=e.add([e.rect(ca,da),e.pos(e.width()/2,Cn-Tn/2),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Resume",{size:18}),e.pos(e.width()/2,Cn-Tn/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]);const ua=e.add([e.rect(ca,da),e.pos(e.width()/2,Cn+Tn/2),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("Quit to Menu",{size:18}),e.pos(e.width()/2,Cn+Tn/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(2002),"pauseButton"]),Ii.hidden=!0,Bi.hidden=!0,e.get("pauseButton").forEach(b=>b.hidden=!0);const Pn=b=>{b?(tg(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Ne)):(Ya(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Ne=e.gameData.weaponDetailSavedState,rt.hidden=!Ne,Ge.hidden=!Ne,ot.hidden=!Ne,Xe.hidden=!Ne,yt.hidden=!Ne,dt.hidden=!Ne,e.gameData.weaponDetailSavedState=void 0)),Ii.hidden=!b,Bi.hidden=!b,e.get("pauseButton").forEach($=>$.hidden=!b)};e.gameData.updatePauseUI=Pn,ha.onClick(()=>{!e.paused||ha.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Ne=e.gameData.weaponDetailSavedState,rt.hidden=!Ne,Ge.hidden=!Ne,ot.hidden=!Ne,Xe.hidden=!Ne,yt.hidden=!Ne,dt.hidden=!Ne,e.gameData.weaponDetailSavedState=void 0),Ya(),Ii.hidden=!0,Bi.hidden=!0,e.get("pauseButton").forEach(b=>b.hidden=!0))}),ua.onClick(()=>{if(!(!e.paused||ua.hidden))if(re())if(he())Gc(),ks(),ie.currentFloor=1,ie.currentRoom=1,ie.playerStats=null,e.go("menu");else{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Leave party and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const b=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const $=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]),b.onClick(()=>{e.get("confirmDialog").forEach(N=>e.destroy(N)),ks(),ie.currentFloor=1,ie.currentRoom=1,ie.playerStats=null,e.go("menu")}),$.onClick(()=>{e.get("confirmDialog").forEach(N=>e.destroy(N))})}else ie.currentFloor=1,ie.currentRoom=1,ie.playerStats=null,e.go("menu")}),r.keyPresses.push(e.onKeyPress("m",()=>{ie.minimap&&!e.paused&&ie.minimap.toggle()})),r.keyPresses.push(e.onKeyPress("escape",()=>{Ki()||(re()?he()?(e.paused=!e.paused,td(e.paused),Pn(e.paused)):sd(!e.paused):(e.paused=!e.paused,Pn(e.paused)))}));const pa=()=>{re()||e.paused||Ki()||(e.paused=!0,Pn(!0))};window.addEventListener("blur",pa),e.onSceneLeave(()=>{window.removeEventListener("blur",pa)}),e.onSceneLeave(()=>{if(r.updates.forEach(b=>{try{b&&b.cancel&&b.cancel()}catch($){console.warn("[Game] Error canceling update handler:",$)}}),r.keyPresses.forEach(b=>{try{b&&b.cancel&&b.cancel()}catch($){console.warn("[Game] Error canceling keypress handler:",$)}}),!he()&&re()){try{to("room_transition"),to("room_completed"),to("game_over")}catch(b){console.warn("[Game] Error unregistering message handlers:",b)}_n=!1}})})}function bo(e,t,s,o,n=wo.WIDTH,r=wo.HEIGHT,a=pe.BUTTON){const c=L.SECONDARY,l=L.SECONDARY_HOVER,d=L.TEXT_PRIMARY,i=L.BORDER,p=!1,h=e.add([e.rect(n,r),e.pos(s,o),e.anchor("center"),e.color(...c),e.outline(2,e.rgb(...i)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS),"menuButton"]),f=Lo(t),g=[];{const w=e.add([e.text(f,{size:a}),e.pos(s,o),e.anchor("center"),e.color(...d),e.fixed(),e.z(H.UI_TEXT),"menuButtonText"]);g.push(w)}const u=g[0];return h.originalColor=[...c],h.hoverColor=[...l],h.borderColor=[...i],h.isHovered=!1,h.disabled=p,h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,Dt()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...L.BORDER_HOVER),h.scale=e.vec2(wo.HOVER_SCALE,wo.HOVER_SCALE),g.forEach(w=>w.scale=e.vec2(wo.HOVER_SCALE,wo.HOVER_SCALE)))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),g.forEach(w=>w.scale=e.vec2(1,1)))}),h.label=u,h.labels=g,h.setDisabled=w=>{h.disabled=w,w?(h.color=e.rgb(...L.BG_DISABLED),g.forEach(v=>v.color=e.rgb(...L.TEXT_DISABLED))):(h.color=e.rgb(...h.originalColor),g.forEach((v,A)=>{v.color=e.rgb(...d)}))},h}function Gg(e){e.scene("menu",()=>{gd();const t=Ks();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...L.BG_DARK),e.z(H.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...L.BORDER),e.fixed(),e.z(H.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...L.BORDER),e.fixed(),e.z(H.UI_BACKGROUND)]),Hc(e);const s=20,o=20,n=228,r=26,a=3,c=11,l=c+r*4+a*3+60;e.add([e.rect(n,l),e.pos(s,o),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.BORDER)),e.fixed(),e.z(H.UI_BACKGROUND)]);const d=o+c,i=[];function p(){i.forEach(oe=>{oe.forEach(V=>{V.exists()&&e.destroy(V)})}),i.length=0,x0().forEach((oe,V)=>{const ee=d+V*(r+a),te=[],ve=e.add([e.rect(n-20,r),e.pos(s+10,ee),e.color(oe.isEmpty?L.BG_DARK:L.BG_LIGHT),e.outline(1,e.rgb(...L.TEXT_DISABLED)),e.fixed(),e.z(H.UI_BACKGROUND+1),"partySlotUI"]);te.push(ve);const Ce=e.add([e.text(`${oe.slotNumber}`,{size:pe.BODY+2}),e.pos(s+20,ee+r/2),e.anchor("left"),e.color(...L.TEXT_SECONDARY),e.outline(1.5,e.rgb(255,255,255)),e.fixed(),e.z(H.UI_TEXT),"partySlotUI"]);if(te.push(Ce),!oe.isEmpty){const Te=ys[oe.selectedCharacter]||ys.survivor,qe=e.add([e.text(Te.char,{size:pe.BODY+2}),e.pos(s+40,ee+r/2),e.anchor("left"),e.color(...Te.color),e.outline(1.5,e.rgb(255,255,255)),e.fixed(),e.z(H.UI_TEXT),"partySlotUI"]);te.push(qe)}const ce=e.add([e.text(oe.playerName,{size:pe.SMALL+2}),e.pos(s+(oe.isEmpty?48:60),ee+r/2),e.anchor("left"),e.color(oe.isEmpty?L.TEXT_DISABLED:oe.isLocal?L.GOLD:L.TEXT_PRIMARY),e.outline(1.5,e.rgb(255,255,255)),e.fixed(),e.z(H.UI_TEXT),"partySlotUI"]);if(te.push(ce),oe.isLocal){const Te=e.add([e.text("",{size:pe.LABEL}),e.pos(s+n-20,ee+r/2),e.anchor("right"),e.color(...L.GOLD),e.outline(1.5,e.rgb(255,255,255)),e.fixed(),e.z(H.UI_TEXT),"partySlotUI"]);te.push(Te)}i.push(te)})}p();let h=0;e.onUpdate(()=>{h+=e.dt(),h>=1&&(h=0,p(),typeof j=="function"&&j())});const f=d+4*(r+a)+10;e.add([e.text("Invite Code:",{size:pe.SMALL+2}),e.pos(s+10,f),e.anchor("left"),e.color(...L.TEXT_SECONDARY),e.outline(1.5),e.fixed(),e.z(H.UI_TEXT)]);const g=Ba(),u=e.add([e.text(g,{size:pe.SMALL+2}),e.pos(s+n-10,f),e.anchor("right"),e.color(g==="OFFLINE"?[...L.TEXT_DISABLED]:[...L.GOLD]),e.outline(1.5),e.fixed(),e.z(H.UI_TEXT)]);let w=g!=="OFFLINE";u.onUpdate(()=>{if(!w){const ae=Ba();ae&&ae!=="OFFLINE"&&(u.text=ae,u.color=e.rgb(...L.GOLD),w=!0)}});const v=f+28;bo(e,"JOIN PARTY",s+n/2,v,132,33,pe.SMALL+2).onClick(()=>{Ot(),e.go("joinParty")}),ta(e,t);const D=130,Y=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],P=[],m=12,x=D-Y.length*m/2;Y.forEach((ae,oe)=>{const V=e.add([e.text(ae,{size:10,font:"monospace"}),e.pos(e.width()/2,x+oe*m),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.z(H.UI_TEXT),"titleLine"]);P.push(V)});let E=0;e.onUpdate(()=>{E+=e.dt(),P.forEach((ae,oe)=>{const V=(E*50+oe*20)%360,ee=S(V,80,60);ae.color=e.rgb(...ee);const te=Math.sin(E*2+oe*.3)*2;ae.pos.y=x+oe*m+te,Math.random()<.001&&(ae.pos.x=e.width()/2+(Math.random()-.5)*10,e.wait(.1,()=>{ae.exists()&&(ae.pos.x=e.width()/2)}))})});function S(ae,oe,V){oe/=100,V/=100;const ee=(1-Math.abs(2*V-1))*oe,te=ee*(1-Math.abs(ae/60%2-1)),ve=V-ee/2;let Ce=0,ce=0,Te=0;return ae>=0&&ae<60?(Ce=ee,ce=te,Te=0):ae>=60&&ae<120?(Ce=te,ce=ee,Te=0):ae>=120&&ae<180?(Ce=0,ce=ee,Te=te):ae>=180&&ae<240?(Ce=0,ce=te,Te=ee):ae>=240&&ae<300?(Ce=te,ce=0,Te=ee):ae>=300&&ae<360&&(Ce=ee,ce=0,Te=te),[Math.round((Ce+ve)*255),Math.round((ce+ve)*255),Math.round((Te+ve)*255)]}const I=280,T=mg.BUTTON_VERTICAL,z=e.width()/2,_=bo(e,"ACTION!",z,I,350,55,pe.TITLE);_.onClick(()=>{if(_.disabled)return;Ot(),yr()>1&&f0(),e.go("game",{resetState:!0})});function j(){const ae=oi(),V=yr()>1&&!ae.isHost;_.setDisabled(V)}j();const q=bo(e,"CONTESTANTS",z,I+T,350,50,pe.HEADER);q.onClick(()=>{Ot(),e.go("characterSelect")});const k=Ps(),U=ys[k];if(U){const ae=os("characters",k)||U.unlockedByDefault,oe=z+175+60,V=I+T,ee=50,te=e.add([e.rect(ee,ee),e.pos(oe,V),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_BACKGROUND)]),ve=e.add([e.text(U.char,{size:36}),e.pos(oe,V),e.anchor("center"),e.color(...ae?U.color:L.BG_DISABLED),e.fixed(),e.z(H.UI_TEXT)]);te.onClick(()=>{Ot(),e.go("characterSelect")}),te.onHoverUpdate(()=>{te.color=e.rgb(...L.BG_LIGHT),te.outline.color=e.rgb(...L.SECONDARY),ve.scale=e.vec2(1.1)}),te.onHoverEnd(()=>{te.color=e.rgb(...L.BG_MEDIUM),te.outline.color=e.rgb(...L.BORDER),ve.scale=e.vec2(1)})}const F=bo(e,"MERCH",z,I+T*2,350,50,pe.BUTTON);F.onClick(()=>{Ot(),e.go("shop")});const O=bo(e,"RATINGS",z,I+T*3,350,50,pe.BUTTON);O.onClick(()=>{Ot(),e.go("statistics")});const J=bo(e,"Options",z,I+T*4,350,50,pe.BUTTON);J.onClick(()=>{Ot(),e.go("settings")});const ne=[_,q,F,O,J];let se=0;e.onUpdate(()=>{se+=e.dt(),ne.forEach((ae,oe)=>{if(!ae.exists()||ae.isHovered)return;const V=(se*60+oe*50)%360,ee=S(V,70,50);try{const te=e.rgb(ee[0],ee[1],ee[2]);ae.color=te,ae.originalColor=ee}catch(te){console.error("Color update error:",te)}})});const Ee=e.onKeyPress("space",()=>{Ot(),e.go("game",{resetState:!0})}),xe=e.onKeyPress("c",()=>{Dt(),e.go("characterSelect")}),Ae=e.onKeyPress("s",()=>{Dt(),e.go("shop")}),Me=e.onKeyPress("o",()=>{Dt(),e.go("settings")}),Oe=e.onKeyPress("t",()=>{Dt(),e.go("statistics")});e.onSceneLeave(()=>{Ee.cancel(),xe.cancel(),Ae.cancel(),Me.cancel(),Oe.cancel()});const Be=[["<o>","(o)","<O>","(O)"],["~@~","^@^","~o~","^o^"],["[#]","{#}","<#>","(#)"],["===","---","___","~~~"],["<>","><","^v","vA"]];for(let ae=0;ae<8;ae++){const oe=Be[Math.floor(Math.random()*Be.length)],V=e.add([e.text(oe[0],{size:16,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...L.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(H.PARTICLES)]);V.speed=30+Math.random()*50,V.direction=Math.random()<.5?1:-1,V.animFrame=0,V.creatureSet=oe,V.onUpdate(()=>{V.pos.x+=V.speed*V.direction*e.dt(),V.animFrame+=e.dt()*4;const ee=Math.floor(V.animFrame)%V.creatureSet.length;V.text=V.creatureSet[ee],V.direction>0&&V.pos.x>e.width()+50?(V.pos.x=-50,V.pos.y=Math.random()*e.height()):V.direction<0&&V.pos.x<-50&&(V.pos.x=e.width()+50,V.pos.y=Math.random()*e.height())})}for(let ae=0;ae<15;ae++){const oe="01".split(""),V=e.add([e.text(oe[Math.floor(Math.random()*oe.length)],{size:14,font:"monospace"}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(50+Math.random()*50,100+Math.random()*100,50+Math.random()*50),e.opacity(.2+Math.random()*.3),e.z(H.PARTICLES)]);V.speed=40+Math.random()*80,V.charChangeTimer=0,V.chars=oe,V.onUpdate(()=>{V.pos.y+=V.speed*e.dt(),V.charChangeTimer+=e.dt(),V.charChangeTimer>.1&&(V.text=V.chars[Math.floor(Math.random()*V.chars.length)],V.charChangeTimer=0),V.pos.y>e.height()&&(V.pos.y=-20,V.pos.x=Math.random()*e.width())})}const _e=["","","","","","","",""];for(let ae=0;ae<12;ae++){const oe=e.add([e.text(_e[Math.floor(Math.random()*_e.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...L.BG_LIGHT),e.opacity(.15),e.z(H.PARTICLES)]);oe.pulseTime=Math.random()*Math.PI*2,oe.pulseSpeed=1+Math.random()*2,oe.onUpdate(()=>{oe.pulseTime+=e.dt()*oe.pulseSpeed;const V=.8+Math.sin(oe.pulseTime)*.3;oe.scale=e.vec2(V,V),oe.opacity=.1+Math.abs(Math.sin(oe.pulseTime))*.15})}for(let ae=0;ae<20;ae++){const oe=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...L.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(H.PARTICLES)]);oe.speed=10+Math.random()*20,oe.onUpdate(()=>{oe.pos.y+=oe.speed*e.dt(),oe.pos.y>e.height()&&(oe.pos.y=0,oe.pos.x=Math.random()*e.width())})}const ze=[];e.loop(5,()=>{if(ze.length<3&&Math.random()<.3){const ae=["","","","","","",""],oe=e.add([e.text(ae[Math.floor(Math.random()*ae.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(H.PARTICLES)]);oe.followSpeed=20+Math.random()*30,oe.rotationSpeed=50+Math.random()*100,oe.lifetime=15+Math.random()*10,oe.onUpdate(()=>{const ee=e.mousePos().sub(oe.pos),te=ee.len();if(te>5){const ve=ee.scale(1/te);oe.pos=oe.pos.add(ve.scale(oe.followSpeed*e.dt()))}if(oe.angle+=oe.rotationSpeed*e.dt(),oe.lifetime-=e.dt(),oe.lifetime<=0){e.destroy(oe);const ve=ze.indexOf(oe);ve>-1&&ze.splice(ve,1)}}),ze.push(oe)}}),e.loop(10,()=>{if(Math.random()<.15){const ae=100+Math.random()*(e.height()-200),oe=Math.random()<.5?1:-1,V=oe>0?-50:e.width()+50,ee=e.add([e.text("$",{size:24}),e.pos(V,ae),e.color(...L.GOLD),e.area({scale:2.5}),e.anchor("center"),e.z(H.PARTICLES+1),"goldenEnemy"]);ee.speed=150+Math.random()*100,ee.direction=oe,ee.pulseTime=0,ee.onClick(()=>{if(!ee.exists())return;So(1);for(let ve=0;ve<12;ve++){const Ce=Math.PI*2*ve/12,ce=e.add([e.text(["$","","",""][Math.floor(Math.random()*4)],{size:14}),e.pos(ee.pos.x,ee.pos.y),e.color(...L.GOLD),e.z(H.PARTICLES+2)]),Te=100+Math.random()*100;ce.velocity=e.vec2(Math.cos(Ce)*Te,Math.sin(Ce)*Te),ce.life=1,ce.onUpdate(()=>{ce.pos=ce.pos.add(ce.velocity.scale(e.dt())),ce.life-=e.dt(),ce.opacity=ce.life,ce.life<=0&&e.destroy(ce)})}const te=e.add([e.text("+$1",{size:20}),e.pos(ee.pos.x,ee.pos.y),e.anchor("center"),e.color(...L.SUCCESS),e.z(H.UI_TEXT)]);te.life=1.5,te.onUpdate(()=>{te.pos.y-=50*e.dt(),te.life-=e.dt(),te.opacity=te.life/1.5,te.life<=0&&e.destroy(te)}),e.destroy(ee),e.wait(.1,()=>e.go("menu"))}),ee.onUpdate(()=>{ee.pos.x+=ee.speed*ee.direction*e.dt(),ee.pulseTime+=e.dt();const te=Math.sin(ee.pulseTime*8)*.2;ee.scale=e.vec2(1+te,1+te),(ee.direction>0&&ee.pos.x>e.width()+100||ee.direction<0&&ee.pos.x<-100)&&e.destroy(ee)})}})})}function Kg(e){return Co[e]?.name?Co[e].name:yn[e]?.name?yn[e].name:_s[e]?.name?_s[e].name:e}function Vg(e){return Co[e]?.char||"E"}function Wg(e){return Co[e]?.color||[255,100,100]}const el=["$","","","",""],jg=[{id:"slayer",title:"Slayer",check:e=>e.kills||0,color:[255,100,100]},{id:"collector",title:"Hoarder",check:e=>e.creditsPickedUp||0,color:[255,255,100]},{id:"bossBuster",title:"Boss Buster",check:e=>e.bossesKilled||0,color:[255,150,50]}];function $g(e){e.scene("gameOver",t=>{const s=t?.runStats||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{}},o=t?.currencyEarned||0,n=Ks();mc();const r=bi(),a=t?.partyStats||[],c=a.length>0?a.reduce((O,J)=>O+(J.creditsPickedUp||0),0):o;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(30,20,20),e.opacity(.98),e.fixed(),e.z(H.OVERLAY)]),e.add([e.text("BROADCAST TERMINATED",{size:36}),e.pos(e.width()/2,30),e.anchor("center"),e.color(...L.DANGER),e.fixed(),e.z(H.MODAL)]),e.add([e.text(`Floor ${s.floorsReached} | ${s.roomsCleared} Rooms | ${s.enemiesKilled} Kills`,{size:16}),e.pos(e.width()/2,58),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.MODAL)]);const l={};a.length>0&&jg.forEach(O=>{let J=null,ne=0;a.forEach(se=>{const Ee=O.check(se);Ee>ne&&(ne=Ee,J=se)}),J&&ne>0&&(l[J.name]||(l[J.name]=[]),l[J.name].push(O))});const d=Math.max(a.length,1),i=d===1?200:d===2?180:140,p=100,h=8,f=20+i/2,g=250,u=[];(a.length>0?a:[{name:"You",characterData:{char:"@",color:[255,255,255]},kills:s.enemiesKilled,creditsPickedUp:o,bossesKilled:s.bossesKilled}]).forEach((O,J)=>{const ne=f+J*(i+h),se=l[O.name]||[],Ee=O.creditsPickedUp||0,xe=O.characterData?.char||"@",Ae=O.characterData?.color||[255,255,255];e.add([e.text(xe,{size:32}),e.pos(ne,90),e.anchor("center"),e.color(...Ae),e.fixed(),e.z(H.MODAL)]);const Me=d<=2?12:8,Oe=(O.name||`Player ${J+1}`).substring(0,Me);e.add([e.text(Oe,{size:16}),e.pos(ne,118),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.MODAL)]),e.add([e.text(`${O.kills||0} kills`,{size:14}),e.pos(ne,138),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.MODAL)]);let Be=156;const _e=d<=2?2:1;se.slice(0,_e).forEach(ae=>{e.add([e.text(`"${ae.title}"`,{size:12}),e.pos(ne,Be),e.anchor("center"),e.color(...ae.color),e.fixed(),e.z(H.MODAL)]),Be+=16}),e.add([e.rect(i-16,p),e.pos(ne,g+p/2),e.anchor("center"),e.outline(3,e.rgb(...L.TEXT_DISABLED)),e.color(0,0,0),e.opacity(.4),e.fixed(),e.z(H.MODAL)]);const ze=e.add([e.text(`0 ${r}`,{size:20}),e.pos(ne,g+p+18),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.MODAL+10)]);u.push({x:ne,y:g,width:i-16,height:p,credits:Ee,label:ze,particles:[],spawnedCount:0,displayedCount:0})});const v=e.width()-140;let A=85;e.add([e.text("STAFF TERMINATED",{size:22}),e.pos(v,A),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.MODAL)]),A+=32;const D=s.killsByType||{},Y=Object.entries(D).filter(([O,J])=>J>0).sort((O,J)=>J[1]-O[1]);if(Y.length===0)e.add([e.text("No staff harmed",{size:17}),e.pos(v,A+10),e.anchor("center"),e.color(...L.TEXT_DISABLED),e.fixed(),e.z(H.MODAL)]);else{const O=Math.min(Y.length,10),J=26;for(let ne=0;ne<O;ne++){const[se,Ee]=Y[ne],xe=Kg(se),Ae=Vg(se),Me=Wg(se);e.add([e.text(Ae,{size:17}),e.pos(v-90,A),e.anchor("center"),e.color(...Me),e.fixed(),e.z(H.MODAL)]);const Oe=xe.length>12?xe.substring(0,10)+"..":xe;e.add([e.text(Oe,{size:14}),e.pos(v-70,A),e.anchor("left"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.MODAL)]),e.add([e.text(`x${Ee}`,{size:14}),e.pos(v+80,A),e.anchor("right"),e.color(...L.DANGER),e.fixed(),e.z(H.MODAL)]),A+=J}if(Y.length>O){const ne=Y.slice(O).reduce((se,[Ee,xe])=>se+xe,0);e.add([e.text(`+${ne} more`,{size:13}),e.pos(v,A),e.anchor("center"),e.color(...L.TEXT_DISABLED),e.fixed(),e.z(H.MODAL)])}}const P=40,m=.05,x=300;let E=0;const S=.8;e.onUpdate(()=>{E+=e.dt(),!(E<S)&&u.forEach((O,J)=>{if(O.credits<=0)return;const ne=Math.min(O.credits,P),se=O.credits/ne,Ee=E-S-J*.15,xe=Math.floor(Ee/m);for(;O.spawnedCount<ne&&O.spawnedCount<xe;){const Ae=O.x+(Math.random()-.5)*(O.width-20),Me=O.y-40-Math.random()*30,Oe=el[Math.floor(Math.random()*el.length)],Be=e.add([e.text(Oe,{size:16}),e.pos(Ae,Me),e.anchor("center"),e.color(255,215,0),e.opacity(1),e.fixed(),e.z(H.MODAL+5),"currencyParticle",{velocity:x+Math.random()*80,landed:!1,value:se}]);O.particles.push(Be),O.spawnedCount++}O.particles.forEach(Ae=>{if(!Ae.exists()||Ae.landed)return;Ae.pos.y+=Ae.velocity*e.dt();const Me=O.y+O.height-8,Oe=O.particles.filter(_e=>_e.landed).length*2,Be=Me-Oe;Ae.pos.y>=Be&&(Ae.pos.y=Be,Ae.landed=!0,O.displayedCount+=Ae.value,O.label.text=`${Math.floor(O.displayedCount)} ${r}`,Ae.opacity=.85)})})}),e.add([e.text(`Team Earnings: +${c} ${r}`,{size:18}),e.pos(e.width()/2,e.height()-95),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.MODAL)]),e.add([e.text(`Career Total: ${n} ${r}`,{size:14}),e.pos(e.width()/2,e.height()-72),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.MODAL)]);const I=re(),T=he(),z=e.height()-45,_=140,j=36,q=!I||T,k=I&&!T?"Waiting...":"Play Again",U=e.add([e.rect(_,j),e.pos(e.width()/2-80,z),e.anchor("center"),e.color(q?60:40,q?80:40,q?60:40),e.outline(2,e.rgb(q?100:60,q?200:80,q?100:60)),e.area(),e.fixed(),e.z(H.MODAL)]);e.add([e.text(k,{size:16}),e.pos(e.width()/2-80,z),e.anchor("center"),e.color(q?150:80,q?255:120,q?150:80),e.fixed(),e.z(H.MODAL+1)]);const F=e.add([e.rect(_,j),e.pos(e.width()/2+80,z),e.anchor("center"),e.color(60,60,80),e.outline(2,e.rgb(100,100,200)),e.area(),e.fixed(),e.z(H.MODAL)]);e.add([e.text("Menu",{size:16}),e.pos(e.width()/2+80,z),e.anchor("center"),e.color(150,150,255),e.fixed(),e.z(H.MODAL+1)]),q&&U.onClick(()=>{Ot(),I&&T&&Ie("game_restart",{}),e.go("game",{resetState:!0})}),F.onClick(()=>{Dt(),I&&!T&&to("game_restart"),e.go("menu")}),I&&!T&&Pe("game_restart",()=>{Ot(),to("game_restart"),e.go("game",{resetState:!0})}),e.onKeyPress("space",()=>{I&&!T||(Ot(),I&&T&&Ie("game_restart",{}),e.go("game",{resetState:!0}))}),e.onKeyPress("escape",()=>{Dt(),I&&!T&&to("game_restart"),e.go("menu")})})}function Jg(e){e.scene("shop",()=>{const t=x=>(x.preventDefault(),!1);document.addEventListener("contextmenu",t),e.onSceneLeave(()=>{document.removeEventListener("contextmenu",t)});const s=Ks(),o=bi();let n="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...L.BG_DARK),e.fixed(),e.z(H.BACKGROUND)]),Mi(e,{patternCount:10,particleCount:15}),Di(e,"MERCH",e.width()/2,60,8);const r=ta(e,s),a=90,c=120,l=100,d=30,i=[{key:"permanentUpgrades",label:"Upgrades"},{key:"characters",label:"Characters"},{key:"weapons",label:"Weapons"}],p=(i.length-1)*c,h=e.width()/2-p/2,f=[];i.forEach((x,E)=>{const S=h+E*c,I=n===x.key,T=e.add([e.rect(l,d),e.pos(S,a),e.anchor("center"),e.color(...I?L.SECONDARY:L.BG_MEDIUM),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),z=e.add([e.text(x.label,{size:pe.BODY}),e.pos(S,a),e.anchor("center"),e.color(...I?L.TEXT_PRIMARY:L.TEXT_TERTIARY),e.fixed(),e.z(H.UI_TEXT)]);T.onClick(()=>{Dt(),n=x.key,A()}),f.push({bg:T,label:z,category:x.key})});const g=140,u=e.height()-g-60;let w=[],v=!1;function A(){const x=Ks();r.updateCurrency(x),f.forEach(q=>{const k=n===q.category;q.bg.color=e.rgb(k?100:50,k?100:50,k?150:80),q.label.color=e.rgb(k?255:150,k?255:150,k?255:150)}),P(),w.forEach(q=>{q.exists()&&e.destroy(q)}),w=[];const E=Cc(n),I=Object.keys(E).filter(q=>{const k=E[q];return n==="permanentUpgrades"?!0:!k.unlockedByDefault});if(I.length===0){const q=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,g+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);w.push(q);return}const T=100,z=g+20,_=Math.floor(u/T),j=Math.min(3,_,I.length);I.forEach((q,k)=>{const U=E[q],F=Math.floor(k/j),O=k%j,J=50+F*350,ne=z+O*T,se=n==="characters"&&os("characters",q),Ee=se?e.rgb(100,255,100):e.rgb(80,80,100),xe=e.add([e.rect(320,90),e.pos(J,ne),e.anchor("topleft"),e.color(40,40,50),e.outline(2,Ee),e.area(),e.fixed(),e.z(1e3)]);if(n==="characters"&&U.char){const te=e.add([e.text(U.char,{size:32}),e.pos(J+25,ne+45),e.anchor("center"),e.color(...se&&U.color?U.color:[100,100,100]),e.fixed(),e.z(1001)]);w.push(te)}const Ae=n==="characters"&&U.char?J+70:J+10,Me=e.add([e.text(U.name,{size:18}),e.pos(Ae,ne+10),e.anchor("topleft"),e.color(255,255,255),e.fixed(),e.z(1001)]),Oe=n==="characters"&&U.char?J+70:J+10,Be=n==="characters"&&U.char?230:300,_e=e.add([e.text(U.description,{size:14,width:Be}),e.pos(Oe,ne+35),e.anchor("topleft"),e.color(200,200,200),e.fixed(),e.z(1001)]);function ze(te){const ve=[50,65,90,115,160];return te<ve.length?ve[te]:160+(te-4)*50}let ae="",oe=!1,V=U.cost;if(n==="permanentUpgrades"){const te=Je(q),ve=U.maxLevel||1;te>=ve?ae=`MAX (${te}/${ve})`:(ae=`Level ${te}/${ve}`,V=ze(te),oe=s>=V)}else n==="characters"?os("characters",q)||(oe=s>=V):os(n,q)?ae="UNLOCKED":oe=s>=V;let ee=null;if(ae&&n!=="characters"){const te=n==="characters"&&U.char?J+70:J+10;ee=e.add([e.text(ae,{size:14}),e.pos(te,ne+60),e.anchor("topleft"),e.color(os(n,q)||n==="permanentUpgrades"&&Je(q)>0?100:200,os(n,q)||n==="permanentUpgrades"&&Je(q)>0?255:200,os(n,q)||n==="permanentUpgrades"&&Je(q)>0?100:200),e.fixed(),e.z(1001)])}if(oe||n==="permanentUpgrades"&&Je(q)<(U.maxLevel||1)){const te=e.add([e.rect(80,30),e.pos(J+230,ne+55),e.anchor("topleft"),e.color(oe?50:30,oe?150:30,oe?50:30),e.outline(2,e.rgb(oe?100:50,oe?200:50,oe?100:50)),e.area(),e.fixed(),e.z(1001)]),ve=e.add([e.text(`$${V}`,{size:14}),e.pos(J+270,ne+70),e.anchor("center"),e.color(oe?255:150,oe?255:150,oe?255:150),e.fixed(),e.z(1002)]);if(n==="permanentUpgrades"&&Je(q)>0){let ce=null;ce=e.onMouseRelease("right",()=>{const Te=e.mousePos(),qe=J+230,tt=ne+55;if(Te.x>=qe&&Te.x<=qe+80&&Te.y>=tt&&Te.y<=tt+30){if(v)return;v=!0;const st=Ac(q);if(st&&st.success){Ln();const xt=e.add([e.text(`Refunded $${st.refundAmount}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{xt.exists()&&e.destroy(xt)}),A(),e.wait(.2,()=>{v=!1})}else v=!1}}),te.onDestroy(()=>{ce&&ce.cancel()})}oe&&te.onClick(()=>{if(v)return;v=!0;let Ce;if(n==="permanentUpgrades"?Ce=vc(q,V,U.maxLevel):Ce=wc(n,q,V),n==="permanentUpgrades")if(Ce&&Ce.success){Ln();const ce=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ce.exists()&&e.destroy(ce)}),A(),e.wait(.2,()=>{v=!1})}else if(Ce&&Ce.reason==="insufficientCurrency"){Yi();const ce=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ce.exists()&&e.destroy(ce)}),v=!1}else v=!1;else if(Ce){Ln();const ce=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ce.exists()&&e.destroy(ce)}),A(),e.wait(.2,()=>{v=!1})}else{Yi();const ce=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ce.exists()&&e.destroy(ce)}),v=!1}}),w.push(te,ve)}w.push(xe,Me,_e),ee&&w.push(ee)})}let D=null,Y=null;function P(){const x=Wr();n==="permanentUpgrades"&&x>0?D?(Y.text=`REFUND: $${x}`,D.hidden=!1,Y.hidden=!1):(D=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),Y=e.add([e.text(`REFUND: $${x}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(H.UI_TEXT)]),D.onClick(()=>{Sc().success?(Ln(),A()):Yi()})):D&&(D.hidden=!0,Y&&(Y.hidden=!0))}A();const m=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.NEUTRAL),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]);e.add([e.text(Lo("Back"),{size:pe.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.UI_TEXT)]),m.onClick(()=>{Dt(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}function Qg(e,t){const s=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(H.OVERLAY)]),r=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(3,e.rgb(...L.BORDER)),e.fixed(),e.z(H.OVERLAY+1)]),a=[];function c(){a.forEach(u=>{u&&u.exists&&u.exists()&&e.destroy(u)})}const l=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(H.OVERLAY+2)]),d=e.add([e.text("Cancel",{size:pe.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+3)]);l.onClick(()=>{c()}),a.push(s,r,l,d);const i=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(H.OVERLAY+2)]),p=e.add([e.text("Reset",{size:pe.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(H.OVERLAY+3)]);i.onClick(()=>{c(),t()}),a.push(i,p);const h=e.add([e.text("Reset to Defaults?",{size:pe.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+2)]);a.push(h);const f=e.add([e.text("This will reset all settings to their default values.",{size:pe.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.OVERLAY+2)]);a.push(f);const g=e.onKeyPress("escape",()=>{c(),g.cancel()})}function Zg(e,t,s){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(H.OVERLAY)]),a=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(3,e.rgb(...L.BORDER)),e.fixed(),e.z(H.OVERLAY+1)]);e.add([e.text("Edit Player Name",{size:pe.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+2)]);const c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...L.BG_LIGHT),e.outline(2,e.rgb(...L.GOLD)),e.fixed(),e.z(H.OVERLAY+2)]);let l=t;const d=e.add([e.text(l,{size:pe.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.OVERLAY+3)]),i=e.add([e.text("(Max 20 characters)",{size:pe.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.OVERLAY+2)]);function p(){e.destroy(o),e.destroy(a),c.destroy(),d.destroy(),i.destroy()}const h=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(H.OVERLAY+2)]);e.add([e.text("Cancel",{size:pe.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.OVERLAY+3)]),h.onClick(()=>{p()});const f=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.GOLD)),e.area(),e.fixed(),e.z(H.OVERLAY+2)]);e.add([e.text("Save",{size:pe.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.OVERLAY+3)]),f.onClick(()=>{l.trim().length>0?(s(l.trim()),p()):(i.text="Name cannot be empty!",i.color=e.rgb(255,100,100))}),e.onCharInput(g=>{l.length<20&&/[a-zA-Z0-9 ]/.test(g)&&(l+=g,d.text=l,i.text="(Max 20 characters)",i.color=e.rgb(...L.TEXT_SECONDARY))}),e.onKeyPress("backspace",()=>{l.length>0&&(l=l.slice(0,-1),d.text=l||" ")}),e.onKeyPress("escape",()=>{p()}),e.onKeyPress("enter",()=>{l.trim().length>0&&(s(l.trim()),p())})}function kg(e){e.scene("settings",t=>{const s=t?.fromGame||!1;let o=Xa(),n="player";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...L.BG_DARK),e.fixed(),e.z(H.BACKGROUND)]),Mi(e,{patternCount:10,particleCount:15}),Di(e,"Options",e.width()/2,60,8);const r=90,a=120,c=100,l=30,d=[{key:"player",label:"Player"},{key:"audio",label:"Audio"},{key:"controls",label:"Controls"},{key:"visual",label:"Visual"},{key:"gameplay",label:"Gameplay"}],i=(d.length-1)*a,p=e.width()/2-i/2,h=[];d.forEach((m,x)=>{const E=p+x*a,S=n===m.key,I=e.add([e.rect(c,l),e.pos(E,r),e.anchor("center"),e.color(S?100:50,S?100:50,S?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),T=e.add([e.text(m.label,{size:16}),e.pos(E,r),e.anchor("center"),e.color(S?255:150,S?255:150,S?255:150),e.fixed(),e.z(H.UI_TEXT)]);I.onClick(()=>{n=m.key,v()}),h.push({bg:I,label:T,key:m.key})});const f=140,g=50,u=150;let w=[];function v(){h.forEach(E=>{const S=n===E.key;E.bg.color=e.rgb(S?100:50,S?100:50,S?150:80),E.label.color=e.rgb(S?255:150,S?255:150,S?255:150)}),w.forEach(E=>{E.exists()&&e.destroy(E)}),w=[],o=Xa();const m=f+20;let x=m;if(n==="player"){const E=e.add([e.text("Player Name:",{size:pe.LABEL}),e.pos(e.width()/2,x),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_ELEMENTS)]);w.push(E),x+=40;let S=po();const I=e.add([e.rect(300,40),e.pos(e.width()/2,x),e.anchor("center"),e.color(...L.BG_LIGHT),e.outline(2,e.rgb(...L.BORDER)),e.fixed(),e.z(H.UI_ELEMENTS)]),T=e.add([e.text(S,{size:pe.LABEL}),e.pos(e.width()/2,x),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.UI_TEXT)]);w.push(I,T),x+=60;const z=e.add([e.rect(140,35),e.pos(e.width()/2-80,x),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),_=e.add([e.text("Edit Name",{size:pe.SMALL}),e.pos(e.width()/2-80,x),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT)]);z.onClick(()=>{Zg(e,S,J=>{mr(J),T.text=J,S=J})});const j=e.add([e.rect(140,35),e.pos(e.width()/2+80,x),e.anchor("center"),e.color(...L.BG_MEDIUM),e.outline(2,e.rgb(...L.GOLD)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),q=e.add([e.text("Randomize",{size:pe.SMALL}),e.pos(e.width()/2+80,x),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.UI_TEXT)]);j.onClick(()=>{const J=ur();mr(J),T.text=J,S=J}),w.push(z,_,j,q),x+=60;const k=e.add([e.text("Your Invite Code:",{size:pe.LABEL}),e.pos(e.width()/2,x),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_ELEMENTS)]);w.push(k),x+=40;const U=Cs(),F=e.add([e.text(U,{size:pe.TITLE}),e.pos(e.width()/2,x),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.UI_ELEMENTS)]);w.push(F),x+=50;const O=e.add([e.text("Share this code with friends to join your party!",{size:pe.SMALL-2}),e.pos(e.width()/2,x),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.UI_ELEMENTS)]);w.push(O)}else if(n==="audio")x=A(e,"Master Volume",o.audio.masterVolume,x,E=>{Ss("audio","masterVolume",E)}),x=A(e,"SFX Volume",o.audio.sfxVolume,x,E=>{Ss("audio","sfxVolume",E)}),x=A(e,"Music Volume",o.audio.musicVolume,x,E=>{Ss("audio","musicVolume",E)});else if(n==="controls"){const E=o.controls,S=[{label:"Move Up",key:"moveUp",value:E.moveUp},{label:"Move Down",key:"moveDown",value:E.moveDown},{label:"Move Left",key:"moveLeft",value:E.moveLeft},{label:"Move Right",key:"moveRight",value:E.moveRight},{label:"Pause",key:"pause",value:E.pause},{label:"Interact",key:"interact",value:E.interact}];S.forEach((T,z)=>{const _=m+z*g,j=e.add([e.text(T.label+":",{size:16}),e.pos(150,_),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(H.UI_ELEMENTS)]),q=e.add([e.rect(100,30),e.pos(500,_),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(H.UI_ELEMENTS)]),k=e.add([e.text(T.value.toUpperCase(),{size:16}),e.pos(500,_),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(H.UI_TEXT)]);w.push(j,q,k)});const I=m+S.length*g;if(I<e.height()-u){const T=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,I+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(H.UI_ELEMENTS)]);w.push(T)}}else if(n==="visual")x=D(e,"Show Particles",o.visual.showParticles,x,E=>{Ss("visual","showParticles",E)}),x=D(e,"Screen Shake",o.visual.showScreenShake,x,E=>{Ss("visual","showScreenShake",E)}),x=D(e,"Hit Freeze",o.visual.showHitFreeze,x,E=>{Ss("visual","showHitFreeze",E)}),x=D(e,"Damage Numbers",o.visual.showDamageNumbers,x,E=>{Ss("visual","showDamageNumbers",E)}),x=D(e,"Compact HUD",o.visual.compactHUD,x,E=>{Ss("visual","compactHUD",E)});else if(n==="gameplay"&&(x=D(e,"Auto-pause on Level Up",o.gameplay.autoPause,x,E=>{Ss("gameplay","autoPause",E)}),x<e.height()-u)){const E=e.add([e.text("(More gameplay options coming soon)",{size:12}),e.pos(e.width()/2,x+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(H.UI_ELEMENTS)]);w.push(E)}}function A(m,x,E,S,I){const T=m.add([m.text(x+":",{size:16}),m.pos(150,S),m.anchor("left"),m.color(200,200,200),m.fixed(),m.z(H.UI_ELEMENTS)]),z=300,_=20,j=m.add([m.rect(z,_),m.pos(500,S),m.anchor("center"),m.color(50,50,70),m.outline(2,m.rgb(100,100,120)),m.area(),m.fixed(),m.z(H.UI_ELEMENTS)]);function q(xe){if(xe<.5){const Ae=xe*2;return{r:255,g:Math.round(255*Ae),b:0}}else{const Ae=(xe-.5)*2;return{r:Math.round(255*(1-Ae)),g:255,b:0}}}const k=z*E,U=q(E),F=m.add([m.rect(k,_-4),m.pos(500-(z-k)/2,S),m.anchor("center"),m.color(U.r,U.g,U.b),m.fixed(),m.z(H.UI_TEXT)]),O=500-z/2+k,J=m.add([m.rect(20,_+4),m.pos(O,S),m.anchor("center"),m.color(200,200,255),m.outline(2,m.rgb(150,150,200)),m.area(),m.fixed(),m.z(1002)]),ne=m.add([m.text(Math.round(E*100)+"%",{size:14}),m.pos(680,S),m.anchor("left"),m.color(255,255,255),m.fixed(),m.z(H.UI_ELEMENTS)]);let se=!1;j.onClick(()=>{const xe=m.mousePos().x,Ae=500-z/2,Me=xe-Ae,Oe=Math.max(0,Math.min(1,Me/z));Ee(Oe)}),J.onClick(()=>{se=!0}),m.onMouseMove(()=>{if(se&&m.isMouseDown()){const xe=m.mousePos().x,Ae=500-z/2,Me=xe-Ae,Oe=Math.max(0,Math.min(1,Me/z));Ee(Oe)}else se=!1}),m.onMouseRelease(()=>{se=!1});function Ee(xe){const Ae=z*xe;F.width=Ae,F.pos.x=500-(z-Ae)/2,J.pos.x=500-z/2+Ae,ne.text=Math.round(xe*100)+"%";const Me=q(xe);F.color=m.rgb(Me.r,Me.g,Me.b),I(xe)}return w.push(T,j,F,J,ne),S+g}function D(m,x,E,S,I){const T=m.add([m.text(x+":",{size:16,width:250}),m.pos(150,S),m.anchor("left"),m.color(200,200,200),m.fixed(),m.z(H.UI_ELEMENTS)]),z=60,j=m.add([m.rect(z,30),m.pos(500,S),m.anchor("center"),m.color(E?50:70,E?150:50,E?50:70),m.outline(2,m.rgb(100,100,120)),m.area(),m.fixed(),m.z(H.UI_ELEMENTS)]),q=24,k=E?500+z/2-q/2-4:500-z/2+q/2+4,U=m.add([m.rect(q,q),m.pos(k,S),m.anchor("center"),m.color(255,255,255),m.outline(1,m.rgb(200,200,200)),m.fixed(),m.z(H.UI_TEXT)]),F=m.add([m.text(E?"ON":"OFF",{size:14}),m.pos(500,S),m.anchor("center"),m.color(E?100:150,E?255:150,E?100:150),m.fixed(),m.z(1002)]);return j.onClick(()=>{const O=!E;j.color=m.rgb(O?50:70,O?150:50,O?50:70),U.pos.x=O?500+z/2-q/2-4:500-z/2+q/2+4,F.text=O?"ON":"OFF",F.color=m.rgb(O?100:150,O?255:150,O?100:150),I(O)}),w.push(T,j,U,F),S+g}const Y=e.add([e.rect(150,35),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]);e.add([e.text("Reset to Defaults",{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(H.UI_TEXT)]),Y.onClick(()=>{Qg(e,()=>{ng(),v()})}),v();const P=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.NEUTRAL),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]);e.add([e.text(Lo("Back"),{size:pe.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.UI_TEXT)]),P.onClick(()=>{s?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{s?e.go("game"):e.go("menu")})})}function tl(e,t,s){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),s=Math.max(0,Math.min(1,s));let o,n,r;if(t===0)o=n=r=s;else{const a=(d,i,p)=>(p<0&&(p+=1),p>1&&(p-=1),p<.16666666666666666?d+(i-d)*6*p:p<.5?i:p<.6666666666666666?d+(i-d)*(.6666666666666666-p)*6:d),c=s<.5?s*(1+t):s+t-s*t,l=2*s-c;o=a(l,c,e+1/3),n=a(l,c,e),r=a(l,c,e-1/3)}return[Math.max(0,Math.min(255,Math.round(o*255))),Math.max(0,Math.min(255,Math.round(n*255))),Math.max(0,Math.min(255,Math.round(r*255)))]}function em(e){e.scene("statistics",()=>{const t=jr(),s=Ec(),o=bi();let n="stats";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...L.BG_DARK),e.fixed(),e.z(H.BACKGROUND)]),Mi(e,{patternCount:10,particleCount:15}),Di(e,"RATINGS AND RECORDS",e.width()/2,60,8);const r=90,a=160,c=150,l=30,d=[{key:"stats",label:"Statistics"},{key:"achievements",label:"Achievements"}],i=(d.length-1)*a,p=e.width()/2-i/2,h=[];d.forEach((m,x)=>{const E=p+x*a,S=n===m.key,I=e.add([e.rect(c,l),e.pos(E,r),e.anchor("center"),e.color(...S?L.SECONDARY:L.BG_MEDIUM),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),T=e.add([e.text(m.label,{size:pe.BODY}),e.pos(E,r),e.anchor("center"),e.color(...S?L.TEXT_PRIMARY:L.TEXT_TERTIARY),e.fixed(),e.z(H.UI_TEXT)]);I.onClick(()=>{n=m.key,Y()}),h.push({bg:I,label:T,key:m.key})});const f=140,g=40,u=60,w=g+u,v=f,A=e.height()-w;let D=[];function Y(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(h.forEach(m=>{const x=n===m.key;m.bg.color=e.rgb(x?100:50,x?100:50,x?150:80),m.label.color=e.rgb(x?255:150,x?255:150,x?255:150)}),D.forEach(m=>{if(m&&typeof m.exists=="function"&&m.exists())try{e.destroy(m)}catch(x){console.warn("Error destroying content item:",x)}}),D=[],n==="stats"){const m=f+20,x=30;[{label:"Total Runs",value:t.totalRuns||0},{label:"Best Floor",value:t.bestFloor||1},{label:"Best Room",value:t.bestRoom||1},{label:"Best Level",value:t.bestLevel||1},{label:"Total Enemies Killed",value:t.totalEnemiesKilled||0},{label:"Total Bosses Killed",value:t.totalBossesKilled||0},{label:"Total Rooms Cleared",value:t.totalRoomsCleared||0},{label:"Total Floors Reached",value:t.totalFloorsReached||0},{label:`Total ${o} Earned`,value:t.totalCurrencyEarned||0}].forEach((S,I)=>{const T=m+I*x,z=e.add([e.text(S.label+":",{size:18}),e.pos(200,T),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]),_=e.add([e.text(S.value.toString(),{size:18}),e.pos(500,T),e.anchor("left"),e.color(255,255,255),e.fixed(),e.z(1e3)]);D.push(z,_)})}else if(n==="achievements")try{const m=Cg(),x=50,E=10,S=25,I=25,T=40,z=(e.width()-100-T)/2,_=A-v-20,j=50,q=e.width()/2+T/2;let k=f+10,U=f+10;m.forEach((Be,_e)=>{const ze=Rg(Be);if(ze.length===0)return;const ae=_e%2===0,oe=ae?j:q;let V=ae?k:U;const ee=Be.charAt(0).toUpperCase()+Be.slice(1),te=e.add([e.text(ee,{size:18}),e.pos(oe+z/2,V),e.anchor("center"),e.color(255,200,100),e.fixed(),e.z(1e3)]);D.push(te),V+=I+5;const ve=Math.max(1,Math.floor(z/(x+E))),ce=Math.min(ve,ze.length)*(x+E)-E,Te=oe+(z-ce)/2;ze.forEach((is,kt)=>{const st=s.includes(is.id),xt=Math.floor(kt/ve),rt=kt%ve,Ge=Te+rt*(x+E),ot=V+xt*(x+E);if(!isFinite(Ge)||!isFinite(ot)||Ge<0||ot<0){console.warn("Invalid box position:",{boxX:Ge,boxY:ot,index:kt,col:rt,row:xt});return}let Xe,yt,dt,Ne,rs;try{Xe=e.add([e.rect(x,x),e.pos(Ge,ot),e.anchor("topleft"),e.color(st?40:25,st?40:25,st?50:25),e.outline(2,e.rgb(st?150:60,st?150:60,st?200:60)),e.area({width:x,height:x}),e.fixed(),e.z(1e3)])}catch(as){console.error("Error creating boxBg:",as,{boxX:Ge,boxY:ot,boxSize:x});return}try{yt=e.add([e.text(is.icon,{size:28}),e.pos(Ge+x/2,ot+x/2),e.anchor("center"),e.color(st?255:80,st?255:80,st?255:80),e.fixed(),e.z(1001)])}catch(as){console.error("Error creating iconText:",as),Xe&&e.destroy(Xe);return}const js=e.add([e.text(is.name,{size:12,width:x+20}),e.pos(Ge+x/2,ot+x+12),e.anchor("center"),e.color(st?200:100,st?200:100,st?200:100),e.fixed(),e.z(1001)]);D.push(Xe,yt,js)});const qe=Math.ceil(ze.length/ve),tt=I+5+qe*(x+E)+S;ae?k+=tt:U+=tt});const F=Object.keys(Ri).length,O=s.length,J=O/F,ne=e.height()-u-g/2,se=600,Ee=25,xe=e.width()/2,Ae=e.add([e.rect(se,Ee),e.pos(xe,ne),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(100,100,150)),e.fixed(),e.z(1e3)]);D.push(Ae);const Me=se*J;if(Me>2&&J>0&&isFinite(Me)){const Be=Math.min(15,Math.max(3,Math.floor(Me/15)));if(Be>0&&isFinite(Be)){const _e=Me/Be;if(_e>0&&isFinite(_e))for(let ze=0;ze<Be;ze++){const ae=xe-se/2+ze*_e,oe=ze/Be*360,V=tl(oe/360,1,.5);if(isFinite(ae)&&_e>0){const ee=e.add([e.rect(_e,Ee-4),e.pos(ae+_e/2,ne),e.anchor("center"),e.color(V[0],V[1],V[2]),e.fixed(),e.z(1001)]);ee&&D.push(ee)}}}}else if(Me>0&&isFinite(Me)){const Be=tl(0,1,.5),_e=xe-se/2+Me/2;if(isFinite(_e)){const ze=e.add([e.rect(Me,Ee-4),e.pos(_e,ne),e.anchor("center"),e.color(Be[0],Be[1],Be[2]),e.fixed(),e.z(1001)]);ze&&D.push(ze)}}const Oe=e.add([e.text(`${O}/${F} (${Math.round(J*100)}%)`,{size:16}),e.pos(xe,ne+Ee/2+20),e.anchor("center"),e.color(200,200,255),e.fixed(),e.z(1e3)]);D.push(Oe)}catch(m){console.error("Error rendering achievements:",m);const x=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,f+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);D.push(x)}}Y();const P=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.NEUTRAL),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]);e.add([e.text(Lo("Back"),{size:pe.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.UI_TEXT)]),P.onClick(()=>{e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}function tm(e){e.scene("characterSelect",()=>{const t=Ks(),s=Ps();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...L.BG_DARK),e.fixed(),e.z(H.BACKGROUND)]),Mi(e,{patternCount:10,particleCount:15}),ta(e,t),Di(e,"CONTESTANTS",e.width()/2,60,8);const o=Object.keys(ys),r=350+20,a=e.width()-r-20,c=120,l=150,d=100,i=15,p=2,f=3*(d+i),g=Math.ceil(o.length/p);let u=0;const w=[];let v=s,A=[],D=!1;function Y(){if(D)return;D=!0;const E=Math.max(0,g*(d+i)-f);w.forEach(O=>{O&&O.exists&&O.exists()&&e.destroy(O)}),w.length=0,A.forEach(O=>{O&&O.exists&&O.exists()&&e.destroy(O)}),A=[],u=Math.max(0,Math.min(u,E)),o.forEach((O,J)=>{const ne=ys[O],se=os("characters",O)||ne.unlockedByDefault,Ee=v===O,xe=Math.floor(J/p),Me=20+J%p*(l+i),Oe=c+xe*(d+i)-u;if(Oe>=c-d&&Oe<=c+f){const Be=e.add([e.rect(l,d),e.pos(Me,Oe),e.anchor("topleft"),e.color(...Ee?L.BG_MEDIUM:L.BG_DARK),e.outline(2,Ee?e.rgb(...L.BORDER_ACTIVE):se?e.rgb(...L.TEXT_DISABLED):e.rgb(...L.BG_DARK)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]),_e=e.add([e.text(ne.char,{size:pe.TITLE}),e.pos(Me+l/2,Oe+30),e.anchor("center"),e.color(...se?ne.color:L.BG_DISABLED),e.fixed(),e.z(H.UI_TEXT)]),ze=e.add([e.text(ne.name,{size:pe.SMALL}),e.pos(Me+l/2,Oe+70),e.anchor("center"),e.color(...se?L.TEXT_PRIMARY:L.TEXT_DISABLED),e.fixed(),e.z(H.UI_TEXT)]);if(!se){const ae=e.add([e.text("",{size:pe.BUTTON}),e.pos(Me+l/2,Oe+d/2),e.anchor("center"),e.color(...L.DANGER),e.fixed(),e.z(H.OVERLAY)]);w.push(ae)}se&&(Be.onClick(()=>{v!==O&&(Ot(),v=O,yc(O),y0(O),Y())}),Be.cursor="pointer"),w.push(Be,_e,ze)}});const S=ys[v],I=os("characters",v)||S.unlockedByDefault;let T=c;const z=e.add([e.text(S.char,{size:72}),e.pos(r+a/2,T+40),e.anchor("center"),e.color(...I?S.color:L.BG_DISABLED),e.fixed(),e.z(H.UI_ELEMENTS)]);A.push(z),T+=100;const _=e.add([e.text(S.name,{size:pe.HEADER}),e.pos(r+a/2,T),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT)]);A.push(_),T+=40;const j=e.add([e.text(S.description,{size:pe.SMALL,width:a-40}),e.pos(r+a/2,T),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.UI_TEXT)]);A.push(j),T+=60;const q=e.add([e.text("Stats:",{size:pe.LABEL}),e.pos(r+20,T),e.anchor("left"),e.color(...L.WARNING),e.fixed(),e.z(H.UI_TEXT)]);A.push(q),T+=30;const k=e.add([e.text(`${zn.HEALTH}: ${S.stats.health}`,{size:pe.BODY}),e.pos(r+40,T),e.anchor("left"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT)]);A.push(k),T+=25;const U=e.add([e.text(`${zn.SPEED}: ${S.stats.speed}`,{size:pe.BODY}),e.pos(r+40,T),e.anchor("left"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT)]);A.push(U),T+=25;const F=e.add([e.text(`${zn.DAMAGE}: ${S.stats.damage}`,{size:pe.BODY}),e.pos(r+40,T),e.anchor("left"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(H.UI_TEXT)]);if(A.push(F),T+=40,v===S){const O=e.add([e.text(" SELECTED",{size:pe.LABEL}),e.pos(r+a/2,T),e.anchor("center"),e.color(...L.SUCCESS),e.fixed(),e.z(H.UI_TEXT)]);A.push(O)}if(!I&&S.unlockRequirement){const O=e.add([e.text(`Unlock: Complete ${zn.FLOOR} ${S.unlockRequirement.value}`,{size:pe.SMALL}),e.pos(r+a/2,T+30),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(H.UI_TEXT)]);A.push(O)}D=!1}Y();const P=E=>{E.preventDefault(),E.stopPropagation();const S=u,I=Math.max(0,g*(d+i)-f);u+=E.deltaY*.3,u=Math.max(0,Math.min(u,I)),u!==S&&Y()},m=document.querySelector("#game-container");m&&m.addEventListener("wheel",P,{passive:!1}),e.onDestroy(()=>{m&&m.removeEventListener("wheel",P)}),e.onKeyPress("arrowdown",()=>{const E=u,S=Math.max(0,g*(d+i)-f);u+=50,u=Math.max(0,Math.min(u,S)),u!==E&&Y()}),e.onKeyPress("arrowup",()=>{const E=u,S=Math.max(0,g*(d+i)-f);u-=50,u=Math.max(0,Math.min(u,S)),u!==E&&Y()});const x=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.NEUTRAL),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(H.UI_ELEMENTS)]);e.add([e.text(Lo("Back"),{size:pe.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(H.UI_TEXT)]),x.onClick(()=>{Dt(),e.go("menu")}),e.add([e.text("Click a character to select | Press SPACE to start",{size:pe.BODY}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(...L.TEXT_TERTIARY),e.fixed(),e.z(H.UI_TEXT)]),e.onKeyPress("escape",()=>{Dt(),e.go("menu")}),e.onKeyPress("space",()=>{Ot(),e.go("game",{resetState:!0})})})}function sm(e){e.scene("joinParty",()=>{const t={name:po(),inviteCode:Cs(),character:Ps()};let s=!1;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...L.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:pe.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:pe.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...L.TEXT_SECONDARY),e.fixed(),e.z(10)]);let o="";const n=e.add([e.text("______",{size:pe.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...L.GOLD),e.fixed(),e.z(10)]),r=e.add([e.text("",{size:pe.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:pe.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...L.TEXT_DISABLED),e.fixed(),e.z(10)]);let a=!1;function c(){let i="";for(let p=0;p<6;p++)p<o.length?i+=o[p]:i+="_";n.text=i}e.onCharInput(i=>{a||/[a-zA-Z0-9]/.test(i)&&o.length<6&&(Dt(),o+=i.toUpperCase(),c(),r.text="",o.length===6&&e.wait(.2,l))}),e.onKeyPress("backspace",()=>{a||o.length>0&&(Dt(),o=o.slice(0,-1),c(),r.text="")}),e.onKeyPress("escape",()=>{Dt(),s=!0,a=!1,ni(t),e.go("menu")}),e.onKeyPress("enter",()=>{a||o.length===6&&l()});async function l(){if(a)return;const i=o.trim();if(!s0(i)){r.text="Invalid invite code format",r.color=e.rgb(255,100,100);return}a=!0,r.text="Joining party...",r.color=e.rgb(...L.GOLD);try{if(await u0(i)){if(s)return;Ot(),r.text="Successfully joined party!",r.color=e.rgb(...L.SUCCESS),e.wait(1,()=>{s||e.go("menu")})}else a=!1,r.text="Failed to join party. Check the code and try again.",r.color=e.rgb(255,100,100),o="",c()}catch(p){a=!1,console.error("[JoinParty] Error joining party:",p),r.text="Connection error. Please try again.",r.color=e.rgb(255,100,100),o="",c()}}const d=e.add([e.rect(200,50),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...L.SECONDARY),e.outline(2,e.rgb(...L.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("Cancel",{size:pe.BUTTON}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...L.TEXT_PRIMARY),e.fixed(),e.z(11)]),d.onClick(()=>{Dt(),s=!0,a=!1,ni(t),e.go("menu")}),d.onHoverUpdate(()=>{a||(d.color=e.rgb(...L.SECONDARY_HOVER))}),d.onHoverEnd(()=>{d.color=e.rgb(...L.SECONDARY)})})}const Is=kf({width:Xo.CANVAS_WIDTH,height:Xo.CANVAS_HEIGHT,background:Xo.BACKGROUND_COLOR,scale:Xo.CANVAS_SCALE,debug:Xo.DEBUG_MODE,root:document.querySelector("#game-container")});Gg(Is);Xg(Is);$g(Is);Jg(Is);kg(Is);em(Is);tm(Is);sm(Is);Is.go("menu");
