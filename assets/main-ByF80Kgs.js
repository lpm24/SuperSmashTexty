(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();var Ay=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return n=>{for(var o=n.length,i=new Uint8Array((o-(n[o-1]=="=")-(n[o-2]=="="))*3/4|0),s=0,r=0;s<o;){var l=e[n.charCodeAt(s++)],c=e[n.charCodeAt(s++)],d=e[n.charCodeAt(s++)],a=e[n.charCodeAt(s++)];i[r++]=l<<2|c>>4,i[r++]=c<<4|d>>2,i[r++]=d<<6|a}return i}})(),Ty={version:"3001.0.19"};function Lo(e,t,n){return t>n?Lo(e,n,t):Math.min(Math.max(e,t),n)}var Mt=class mn{r=255;g=255;b=255;constructor(t,n,o){this.r=Lo(t,0,255),this.g=Lo(n,0,255),this.b=Lo(o,0,255)}static fromArray(t){return new mn(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new mn(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw new Error("Invalid hex color format");return new mn(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,n,o){if(n==0)return new mn(255*o,255*o,255*o);let i=(a,h,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<1/6?a+(h-a)*6*u:u<1/2?h:u<2/3?a+(h-a)*(2/3-u)*6:a),s=o<.5?o*(1+n):o+n-o*n,r=2*o-s,l=i(r,s,t+1/3),c=i(r,s,t),d=i(r,s,t-1/3);return new mn(Math.round(l*255),Math.round(c*255),Math.round(d*255))}static RED=new mn(255,0,0);static GREEN=new mn(0,255,0);static BLUE=new mn(0,0,255);static YELLOW=new mn(255,255,0);static MAGENTA=new mn(255,0,255);static CYAN=new mn(0,255,255);static WHITE=new mn(255,255,255);static BLACK=new mn(0,0,0);clone(){return new mn(this.r,this.g,this.b)}lighten(t){return new mn(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new mn(255-this.r,255-this.g,255-this.b)}mult(t){return new mn(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,n){return new mn(Jn(this.r,t.r,n),Jn(this.g,t.g,n),Jn(this.b,t.b,n))}toHSL(){let t=this.r/255,n=this.g/255,o=this.b/255,i=Math.max(t,n,o),s=Math.min(t,n,o),r=(i+s)/2,l=r,c=r;if(i==s)r=l=0;else{let d=i-s;switch(l=c>.5?d/(2-i-s):d/(i+s),i){case t:r=(n-o)/d+(n<o?6:0);break;case n:r=(o-t)/d+2;break;case o:r=(t-n)/d+4;break}r/=6}return[r,l,c]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function Kt(...e){if(e.length===0)return new Mt(255,255,255);if(e.length===1){if(e[0]instanceof Mt)return e[0].clone();if(typeof e[0]=="string")return Mt.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Mt.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof Mt)return e[0].clone()}else if(e.length===3||e.length===4)return new Mt(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var My=(e,t,n)=>Mt.fromHSL(e,t,n);function xn(e){return e*Math.PI/180}function qi(e){return e*180/Math.PI}function Jn(e,t,n){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*n;if(e instanceof ne&&t instanceof ne||e instanceof Mt&&t instanceof Mt)return e.lerp(t,n);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function Ro(e,t,n,o,i){return o+(e-t)/(n-t)*(i-o)}function Ry(e,t,n,o,i){return Lo(Ro(e,t,n,o,i),o,i)}var ne=class _n{x=0;y=0;constructor(t=0,n=t){this.x=t,this.y=n}static fromAngle(t){let n=xn(t);return new _n(Math.cos(n),Math.sin(n))}static fromArray(t){return new _n(t[0],t[1])}static ZERO=new _n(0,0);static ONE=new _n(1,1);static LEFT=new _n(-1,0);static RIGHT=new _n(1,0);static UP=new _n(0,-1);static DOWN=new _n(0,1);clone(){return new _n(this.x,this.y)}add(...t){let n=j(...t);return new _n(this.x+n.x,this.y+n.y)}sub(...t){let n=j(...t);return new _n(this.x-n.x,this.y-n.y)}scale(...t){let n=j(...t);return new _n(this.x*n.x,this.y*n.y)}dist(...t){let n=j(...t);return this.sub(n).len()}sdist(...t){let n=j(...t);return this.sub(n).slen()}static sdist(t,n){let o=t.x-n.x,i=t.y-n.y;return o*o+i*i}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new _n(0):this.scale(1/t)}normal(){return new _n(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,n){return t.x*n.x+t.y*n.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,n){return t.x*n.y-t.y*n.x}angle(...t){let n=j(...t);return qi(Math.atan2(this.y-n.y,this.x-n.x))}angleBetween(...t){let n=j(...t);return qi(Math.atan2(this.cross(n),this.dot(n)))}lerp(t,n){return new _n(Jn(this.x,t.x,n),Jn(this.y,t.y,n))}slerp(t,n){let o=this.dot(t),i=this.cross(t),s=Math.atan2(i,o);return this.scale(Math.sin((1-n)*s)).add(t.scale(Math.sin(n*s))).scale(1/i)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new _n(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new nn(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function j(...e){if(e.length===1){if(e[0]instanceof ne)return new ne(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new ne(...e[0])}return new ne(...e)}var cn=class Rc{x=0;y=0;w=1;h=1;constructor(t,n,o,i){this.x=t,this.y=n,this.w=o,this.h=i}scale(t){return new Rc(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new ne(this.x,this.y)}clone(){return new Rc(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function yn(e,t,n,o){return new cn(e,t,n,o)}var La=class fs{a;b;c;d;constructor(t,n,o,i){this.a=t,this.b=n,this.c=o,this.d=i}mul(t){return new fs(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return j(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new fs(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new fs(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,n=this.det,o=t+Math.sqrt(t*t-n),i=t-Math.sqrt(t*t-n);return[o,i]}eigenvectors(t,n){return this.c!=0?[[t-this.d,this.c],[n-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,n-this.a]]:Math.abs(this.transform(j(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let n=Math.cos(t),o=Math.sin(t);return new fs(n,o,-o,n)}static scale(t,n){return new fs(t,0,0,n)}},ar=class lr{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,n,o,i,s,r,l,c,d){this.m11=t,this.m12=n,this.m13=o,this.m21=i,this.m22=s,this.m23=r,this.m31=l,this.m32=c,this.m33=d}static fromMat2(t){return new lr(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new La(this.m11,this.m12,this.m21,this.m22)}mul(t){return new lr(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let n=Math.cos(t),o=Math.sin(t),i=this.m11,s=this.m12;return this.m11=n*this.m11+o*this.m21,this.m12=n*this.m12+o*this.m22,this.m21=n*this.m21-o*i,this.m22=n*this.m22-o*s,this}scale(t,n){return this.m11*=t,this.m12*=t,this.m21*=n,this.m22*=n,this}get inverse(){let t=this.det;return new lr((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new lr(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},Oo=class Fo{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new Fo([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new Fo([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=xn(-t);let n=Math.cos(t),o=Math.sin(t);return new Fo([1,0,0,0,0,n,-o,0,0,o,n,0,0,0,0,1])}static rotateY(t){t=xn(-t);let n=Math.cos(t),o=Math.sin(t);return new Fo([n,0,o,0,0,1,0,0,-o,0,n,0,0,0,0,1])}static rotateZ(t){t=xn(-t);let n=Math.cos(t),o=Math.sin(t);return new Fo([n,-o,0,0,o,n,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=xn(-t);let n=Math.cos(t),o=Math.sin(t),i=this.m[0],s=this.m[1],r=this.m[4],l=this.m[5];return this.m[0]=i*n+s*o,this.m[1]=-i*o+s*n,this.m[4]=r*n+l*o,this.m[5]=-r*o+l*n,this}mult(t){let n=[];for(let o=0;o<4;o++)for(let i=0;i<4;i++)n[o*4+i]=this.m[0+i]*t.m[o*4+0]+this.m[4+i]*t.m[o*4+1]+this.m[8+i]*t.m[o*4+2]+this.m[12+i]*t.m[o*4+3];return new Fo(n)}multVec2(t){return new ne(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new ne(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],n=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new ne(n,t/n)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],n=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new ne(t/n,n)}else return new ne(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return qi(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return qi(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new ne(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new ne(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new ne(0,0)}invert(){let t=[],n=this.m[10]*this.m[15]-this.m[14]*this.m[11],o=this.m[9]*this.m[15]-this.m[13]*this.m[11],i=this.m[9]*this.m[14]-this.m[13]*this.m[10],s=this.m[8]*this.m[15]-this.m[12]*this.m[11],r=this.m[8]*this.m[14]-this.m[12]*this.m[10],l=this.m[8]*this.m[13]-this.m[12]*this.m[9],c=this.m[6]*this.m[15]-this.m[14]*this.m[7],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],a=this.m[5]*this.m[14]-this.m[13]*this.m[6],h=this.m[4]*this.m[15]-this.m[12]*this.m[7],u=this.m[4]*this.m[14]-this.m[12]*this.m[6],p=this.m[5]*this.m[15]-this.m[13]*this.m[7],g=this.m[4]*this.m[13]-this.m[12]*this.m[5],A=this.m[6]*this.m[11]-this.m[10]*this.m[7],m=this.m[5]*this.m[11]-this.m[9]*this.m[7],C=this.m[5]*this.m[10]-this.m[9]*this.m[6],I=this.m[4]*this.m[11]-this.m[8]*this.m[7],R=this.m[4]*this.m[10]-this.m[8]*this.m[6],f=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*n-this.m[6]*o+this.m[7]*i,t[4]=-(this.m[4]*n-this.m[6]*s+this.m[7]*r),t[8]=this.m[4]*o-this.m[5]*s+this.m[7]*l,t[12]=-(this.m[4]*i-this.m[5]*r+this.m[6]*l),t[1]=-(this.m[1]*n-this.m[2]*o+this.m[3]*i),t[5]=this.m[0]*n-this.m[2]*s+this.m[3]*r,t[9]=-(this.m[0]*o-this.m[1]*s+this.m[3]*l),t[13]=this.m[0]*i-this.m[1]*r+this.m[2]*l,t[2]=this.m[1]*c-this.m[2]*d+this.m[3]*a,t[6]=-(this.m[0]*c-this.m[2]*h+this.m[3]*u),t[10]=this.m[0]*p-this.m[1]*h+this.m[3]*g,t[14]=-(this.m[0]*a-this.m[1]*u+this.m[2]*g),t[3]=-(this.m[1]*A-this.m[2]*m+this.m[3]*C),t[7]=this.m[0]*A-this.m[2]*I+this.m[3]*R,t[11]=-(this.m[0]*m-this.m[1]*I+this.m[3]*f),t[15]=this.m[0]*C-this.m[1]*R+this.m[2]*f;let N=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let b=0;b<4;b++)for(let T=0;T<4;T++)t[b*4+T]*=1/N;return new Fo(t)}clone(){return new Fo([...this.m])}toString(){return this.m.toString()}};function Ip(e,t,n,o=i=>-Math.cos(i)){return e+(o(n)+1)/2*(t-e)}var Dy=1103515245,Iy=12345,pu=2147483648,Pp=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(Dy*this.seed+Iy)%pu,this.seed/pu}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new ne(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new Mt(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof ne)return this.genVec2(j(0,0),e[0]);if(e[0]instanceof Mt)return this.genColor(Kt(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof ne&&e[1]instanceof ne)return this.genVec2(e[0],e[1]);if(e[0]instanceof Mt&&e[1]instanceof Mt)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},Dc=new Pp(Date.now());function Py(e){return e!=null&&(Dc.seed=e),Dc.seed}function An(...e){return Dc.genAny(...e)}function Lp(...e){return Math.floor(An(...e.length>0?e:[2]))}function Ly(e){return An()<=e}function Op(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function Oy(e,t){return e.length<=t?e.slice():Op(e.slice()).slice(0,t)}function Ny(e){return e[Lp(e.length)]}function Np(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function By(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let n=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(n===0)return null;let o=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/n,i=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/n;return o<0||o>1||i<0||i>1?null:o}function Ld(e,t){let n=By(e,t);return n?j(e.p1.x+n*(e.p2.x-e.p1.x),e.p1.y+n*(e.p2.y-e.p1.y)):null}function Od(e,t){let n=t.p2.sub(t.p1),o=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;if(n.x!=0){let s=(e.pos.x-t.p1.x)/n.x,r=(e.pos.x+e.width-t.p1.x)/n.x;o=Math.max(o,Math.min(s,r)),i=Math.min(i,Math.max(s,r))}if(n.y!=0){let s=(e.pos.y-t.p1.y)/n.y,r=(e.pos.y+e.height-t.p1.y)/n.y;o=Math.max(o,Math.min(s,r)),i=Math.min(i,Math.max(s,r))}return i>=o&&i>=0&&o<=1}function wl(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Bp(e,t){let n=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),o=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return j(n,o).sdist(t.center)<=t.radius*t.radius}function Hp(e,t){return zp(t,new Kn(e.points()))}function Nd(e,t){let n=t.sub(e.p1),o=e.p2.sub(e.p1);if(Math.abs(n.cross(o))>Number.EPSILON)return!1;let i=n.dot(o)/o.dot(o);return i>=0&&i<=1}function jr(e,t){let n=e.p2.sub(e.p1),o=n.dot(n),i=e.p1.sub(t.center),s=2*n.dot(i),r=i.dot(i)-t.radius*t.radius,l=s*s-4*o*r;if(o<=Number.EPSILON||l<0)return!1;if(l==0){let c=-s/(2*o);if(c>=0&&c<=1)return!0}else{let c=(-s+Math.sqrt(l))/(2*o),d=(-s-Math.sqrt(l))/(2*o);if(c>=0&&c<=1||d>=0&&d<=1)return!0}return bl(t,e.p1)}function Bd(e,t){if(yi(t,e.p1)||yi(t,e.p2))return!0;for(let n=0;n<t.pts.length;n++){let o=t.pts[n],i=t.pts[(n+1)%t.pts.length];if(Ld(e,new kn(o,i)))return!0}return!1}function bl(e,t){return e.center.sdist(t)<e.radius*e.radius}function Hy(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function El(e,t){let n=t.pts[t.pts.length-1];for(let o of t.pts){if(jr(new kn(n,o),e))return!0;n=o}return bl(e,t.pts[0])?!0:yi(t,e.center)}function zp(e,t){for(let n=0;n<e.pts.length;n++)if(Bd(new kn(e.pts[n],e.pts[(n+1)%e.pts.length]),t))return!0;return!!(e.pts.some(n=>yi(t,n))||t.pts.some(n=>yi(e,n)))}function yi(e,t){let n=!1,o=e.pts;for(let i=0,s=o.length-1;i<o.length;s=i++)o[i].y>t.y!=o[s].y>t.y&&t.x<(o[s].x-o[i].x)*(t.y-o[i].y)/(o[s].y-o[i].y)+o[i].x&&(n=!n);return n}function Hd(e,t){t=t.sub(e.center);let n=xn(e.angle),o=Math.cos(n),i=Math.sin(n),s=t.x*o+t.y*i,r=-t.x*i+t.y*o;return s*s/(e.radiusX*e.radiusX)+r*r/(e.radiusY*e.radiusY)<1}function Oa(e,t){let n=t.center.sub(e.center),o=xn(e.angle),i=Math.cos(o),s=Math.sin(o),r=n.x*i+n.y*s,l=-n.x*s+n.y*i;return Hd(new Jo(j(),e.radiusX+t.radius,e.radiusY+t.radius,0),j(r,l))}function Up(e,t){let n=e.toMat2().inverse;return t=new kn(n.transform(t.p1.sub(e.center)),n.transform(t.p2.sub(e.center))),jr(t,new Zn(j(),1))}function zy(e,t){if(e.radiusX===e.radiusY)return Oa(t,new Zn(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Oa(e,new Zn(t.center,t.radiusX));let n=new ar(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),o=new ar(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),i=e.center.x,s=e.center.y,r=t.center.x,l=t.center.y,c=xn(e.angle),d=xn(t.angle),a=new ar(Math.cos(c),-Math.sin(c),i,Math.sin(c),Math.cos(c),s,0,0,1),h=new ar(Math.cos(d),-Math.sin(d),r,Math.sin(d),Math.cos(d),l,0,0,1),u=a.inverse,p=h.inverse,g=u.transpose.mul(n).mul(u),A=p.transpose.mul(o).mul(p),m=g.m11,C=g.m12,I=g.m13,R=g.m21,f=g.m22,N=g.m23,b=g.m31,T=g.m32,x=g.m33,M=A.m11,_=A.m12,O=A.m13,P=A.m21,z=A.m22,U=A.m23,F=A.m31,B=A.m32,D=A.m33,q=m*f*x-m*N*T-C*R*x+C*N*b+I*R*T-I*f*b,G=(m*f*D-m*N*B-m*T*U+m*x*z-C*R*D+C*N*F+C*b*U-C*x*P+I*R*B-I*f*F-I*b*z+I*T*P+R*T*O-R*x*_-f*b*O+f*x*M+N*b*_-N*T*M)/q,Z=(m*z*D-m*U*B-C*P*D+C*U*F+I*P*B-I*z*F-R*_*D+R*O*B+f*M*D-f*O*F-N*M*B+N*_*F+b*_*U-b*O*z-T*M*U+T*O*P+x*M*z-x*_*P)/q,le=(M*z*D-M*U*B-_*P*D+_*U*F+O*P*B-O*z*F)/q;if(G>=0){let ie=-3*Z+G**2,oe=3*G*le+Z*G**2-4*Z**2,se=-27*le**2+18*le*G*Z+G**2*Z**2-4*G**3*le-4*Z**3;return!(ie>0&&oe<0&&se>0)}else{let ie=-3*Z+G**2,oe=-27*le**2+18*le*G*Z+G**2*Z**2-4*G**3*le-4*Z**3;return!(ie>0&&oe>0)}}function Fp(e,t){return zd(e,new Kn(t.points()))}function zd(e,t){let n=e.toMat2().inverse;return t=new Kn(t.pts.map(o=>n.transform(o.sub(e.center)))),El(new Zn(j(),1),t)}function Uy(e,t){return e.x===t.x&&e.y===t.y}function Fy(e,t){return t instanceof ne?Uy(t,e.pt):t instanceof Zn?bl(t,e.pt):t instanceof kn?Nd(t,e.pt):t instanceof nn?wl(t,e.pt):t instanceof Kn?yi(t,e.pt):t instanceof Jo?Hd(t,e.pt):!1}function Xy(e,t){return t instanceof ne?Nd(e,t):t instanceof Zn?jr(e,t):t instanceof kn?Ld(e,t)!=null:t instanceof nn?Od(t,e):t instanceof Kn?Bd(e,t):t instanceof Jo?Up(t,e):!1}function qy(e,t){return t instanceof ne?bl(e,t):t instanceof Zn?Hy(e,t):t instanceof kn?jr(t,e):t instanceof nn?Bp(t,e):t instanceof Kn?El(e,t):t instanceof Jo?Oa(t,e):!1}function Yy(e,t){return t instanceof ne?wl(e,t):t instanceof Zn?Bp(e,t):t instanceof kn?Od(e,t):t instanceof nn?Np(e,t):t instanceof Kn?Hp(e,t):t instanceof Jo?Fp(t,e):!1}function Gy(e,t){return t instanceof ne?yi(e,t):t instanceof Zn?El(t,e):t instanceof kn?Bd(t,e):t instanceof nn?Hp(t,e):t instanceof Kn?zp(t,e):t instanceof Jo?zd(t,e):!1}function Ky(e,t){return t instanceof ne?Hd(e,t):t instanceof Zn?Oa(e,t):t instanceof kn?Up(e,t):t instanceof nn?Fp(e,t):t instanceof Kn?zd(e,t):t instanceof Jo?zy(t,e):!1}function Xp(e,t,n){let o=e,i=n.p1,s=n.p2,r=t,l=s.sub(i),c=r.cross(l);if(Math.abs(c)<Number.EPSILON)return null;let d=i.sub(o),a=d.cross(l)/c;if(a<=0||a>=1)return null;let h=d.cross(r)/c;if(h<=0||h>=1)return null;let u=l.normal().unit();return t.dot(u)>0&&(u.x*=-1,u.y*=-1),{point:o.add(r.scale(a)),normal:u,fraction:a}}function Vy(e,t,n){let o=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY,s;if(e.x!=0){let r=(n.pos.x-e.x)/t.x,l=(n.pos.x+n.width-e.x)/t.x;s=j(-Math.sign(t.x),0),o=Math.max(o,Math.min(r,l)),i=Math.min(i,Math.max(r,l))}if(e.y!=0){let r=(n.pos.y-e.y)/t.y,l=(n.pos.y+n.height-e.y)/t.y;Math.min(r,l)>o&&(s=j(0,-Math.sign(t.y))),o=Math.max(o,Math.min(r,l)),i=Math.min(i,Math.max(r,l))}return i>=o&&o>=0&&o<=1?{point:e.add(t.scale(o)),normal:s,fraction:o}:null}function qp(e,t,n){let o=e,i=n.center,s=t,r=s.dot(s),l=o.sub(i),c=2*s.dot(l),d=l.dot(l)-n.radius*n.radius,a=c*c-4*r*d;if(r<=Number.EPSILON||a<0)return null;if(a==0){let h=-c/(2*r);if(h>=0&&h<=1){let u=o.add(s.scale(h));return{point:u,normal:u.sub(i),fraction:h}}}else{let h=(-c+Math.sqrt(a))/(2*r),u=(-c-Math.sqrt(a))/(2*r),p=null;if(h>=0&&h<=1&&(p=h),u>=0&&u<=1&&(p=Math.min(u,p??u)),p!=null){let g=o.add(s.scale(p));return{point:g,normal:g.sub(i).unit(),fraction:p}}}return null}function Wy(e,t,n){let o=n.pts,i=null,s=o[o.length-1];for(let r=0;r<o.length;r++){let l=o[r],c=Xp(e,t,new kn(s,l));c&&(!i||i.fraction>c.fraction)&&(i=c),s=l}return i}function $y(e,t,n){let o=n.toMat2(),i=o.inverse,s=i.transform(e.sub(n.center)),r=i.transform(t),l=qp(s,r,new Zn(j(),1));if(l){let c=La.rotation(xn(-n.angle)),d=La.scale(n.radiusX,n.radiusY).transform(l.point),a=o.transform(l.point).add(n.center),h=a.dist(e)/t.len();return{point:a,normal:c.transform(j(n.radiusY**2*d.x,n.radiusX**2*d.y)).unit(),fraction:h}}return l}function jy(e,t,n,o=64){let i=e,s=t.len(),r=t.scale(1/s),l=0,c=j(Math.floor(e.x),Math.floor(e.y)),d=j(r.x>0?1:-1,r.y>0?1:-1),a=j(Math.abs(1/r.x),Math.abs(1/r.y)),h=j(d.x>0?c.x+1-e.x:e.x-c.x,d.y>0?c.y+1-e.y:e.y-c.y),u=j(a.x<1/0?a.x*h.x:1/0,a.y<1/0?a.y*h.y:1/0),p=-1;for(;l<=o;){let g=n(c);if(g===!0)return{point:i.add(r.scale(l)),normal:j(p===0?-d.x:0,p===1?-d.y:0),fraction:l/s,gridPos:c};if(g)return g;u.x<u.y?(c.x+=d.x,l=u.x,u.x+=a.x,p=0):(c.y+=d.y,l=u.y,u.y+=a.y,p=1)}return null}var Jy=class Ic{pt;constructor(t){this.pt=t.clone()}transform(t){return new Ic(t.multVec2(this.pt))}bbox(){return new nn(this.pt,0,0)}area(){return 0}clone(){return new Ic(this.pt)}collides(t){return Fy(this,t)}contains(t){return this.pt.eq(t)}raycast(t,n){return null}random(){return this.pt.clone()}},kn=class Pc{p1;p2;constructor(t,n){this.p1=t.clone(),this.p2=n.clone()}transform(t){return new Pc(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return nn.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Pc(this.p1,this.p2)}collides(t){return Xy(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Xp(t,n,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(An(1)))}},nn=class Lc{pos;width;height;constructor(t,n,o){this.pos=t.clone(),this.width=n,this.height=o}static fromPoints(t,n){return new Lc(t.clone(),n.x-t.x,n.y-t.y)}center(){return new ne(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new Kn(this.points().map(n=>t.multVec2(n)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Lc(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let n=this.pos,o=this.pos.add(this.width,this.height),i=Math.max(n.x-t.x,0,t.x-o.x),s=Math.max(n.y-t.y,0,t.y-o.y);return i*i+s*s}collides(t){return Yy(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Vy(t,n,this)}random(){return this.pos.add(An(this.width),An(this.height))}},Zn=class Yp{center;radius;constructor(t,n){this.center=t.clone(),this.radius=n}transform(t){return new Jo(this.center,this.radius,this.radius).transform(t)}bbox(){return nn.fromPoints(this.center.sub(j(this.radius)),this.center.add(j(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new Yp(this.center,this.radius)}collides(t){return qy(this,t)}contains(t){return this.collides(t)}raycast(t,n){return qp(t,n,this)}random(){return this.center.add(ne.fromAngle(An(360)).scale(An(this.radius)))}},Jo=class ps{center;radiusX;radiusY;angle;constructor(t,n,o,i=0){this.center=t.clone(),this.radiusX=n,this.radiusY=o,this.angle=i}static fromMat2(t){let n=t.inverse,o=n.transpose.mul(n),[i,s]=o.eigenvalues,[r,l]=o.eigenvectors(i,s),[c,d]=[1/Math.sqrt(i),1/Math.sqrt(s)];return c>d?new ps(j(),c,d,qi(Math.atan2(-r[1],r[0]))):new ps(j(),d,c,qi(Math.atan2(-l[1],l[0])))}toMat2(){let t=xn(this.angle),n=Math.cos(t),o=Math.sin(t);return new La(n*this.radiusX,-o*this.radiusY,o*this.radiusX,n*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new ps(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let n=this.toMat2(),o=t.getRotation(),i=t.getScale();n=ar.fromMat2(n).scale(i.x,i.y).rotate(o).toMat2();let s=ps.fromMat2(n);return s.center=t.multVec2(this.center),s}}bbox(){if(this.angle==0)return nn.fromPoints(this.center.sub(j(this.radiusX,this.radiusY)),this.center.add(j(this.radiusX,this.radiusY)));{let t=xn(this.angle),n=Math.cos(t),o=Math.sin(t),i=this.radiusX*n,s=this.radiusX*o,r=this.radiusY*o,l=this.radiusY*n,c=Math.sqrt(i*i+r*r),d=Math.sqrt(s*s+l*l);return nn.fromPoints(this.center.sub(j(c,d)),this.center.add(j(c,d)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new ps(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return Ky(this,t)}contains(t){t=t.sub(this.center);let n=xn(this.angle),o=Math.cos(n),i=Math.sin(n),s=t.x*o+t.y*i,r=-t.x*i+t.y*o;return s*s/(this.radiusX*this.radiusX)+r*r/(this.radiusY*this.radiusY)<1}raycast(t,n){return $y(t,n,this)}random(){return this.center}};function Qy(e,t,n,o){let i=t.sub(e),s=o.sub(n),r=i.cross(s);return r<1e-5&&r>-1e-5||(r=n.sub(e).cross(s)/r,r<0||r>1)?null:e.add(i.scale(r))}var Kn=class cr{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new cr(this.pts.map(n=>t.multVec2(n)))}bbox(){let t=j(Number.MAX_VALUE),n=j(-Number.MAX_VALUE);for(let o of this.pts)t.x=Math.min(t.x,o.x),n.x=Math.max(n.x,o.x),t.y=Math.min(t.y,o.y),n.y=Math.max(n.y,o.y);return nn.fromPoints(t,n)}area(){let t=0,n=this.pts.length;for(let o=0;o<n;o++){let i=this.pts[o],s=this.pts[(o+1)%n];t+=i.x*s.y*.5,t-=s.x*i.y*.5}return Math.abs(t)}clone(){return new cr(this.pts.map(t=>t.clone()))}collides(t){return Gy(this,t)}contains(t){return this.collides(t)}raycast(t,n){return Wy(t,n,this)}random(){return j()}cut(t,n){new kn(t,n);let o=[],i=[],s=n.sub(t),r=this.pts[this.pts.length-1],l=r.sub(t),c=s.cross(l)>0;return this.pts.forEach(d=>{l=d.sub(t);let a=s.cross(l)>0;if(c!=a){let h=Qy(r,d,t,n);o.push(h),i.push(h),c=a}(a?o:i).push(d),r=d}),[o.length?new cr(o):null,i.length?new cr(i):null]}};function Zy(e,t,n,o){let i=o*o,s=1-o,r=s*s;return e.scale(r).add(t.scale(2*s*o)).add(n.scale(i))}function ky(e,t,n,o){let i=1-o;return t.sub(e).scale(2*i).add(n.sub(t).scale(2*o))}function ex(e,t,n,o){return n.sub(t.scale(2)).add(e).scale(2)}function Ud(e,t,n,o,i){let s=i*i,r=s*i,l=1-i,c=l*l,d=c*l;return e.scale(d).add(t.scale(3*c*i)).add(n.scale(3*l*s)).add(o.scale(r))}function tx(e,t,n,o,i){let s=i*i,r=1-i,l=r*r;return t.sub(e).scale(3*l).add(n.sub(t).scale(6*r*i)).add(o.sub(n).scale(3*s))}function nx(e,t,n,o,i){let s=1-i;return n.sub(t.scale(2)).add(e).scale(6*s).add(o.sub(n.scale(2)).add(t).scale(6*i))}function ox(e,t,n,o,i){let s=.5*(((-i+2)*i-1)*i),r=.5*((3*i-5)*i*i+2),l=.5*(((-3*i+4)*i+1)*i),c=.5*((i-1)*i*i);return e.scale(s).add(t.scale(r)).add(n.scale(l)).add(o.scale(c))}function ix(e,t,n,o,i){let s=.5*((-3*i+4)*i-1),r=.5*((9*i-10)*i),l=.5*((-9*i+8)*i+1),c=.5*((3*i-2)*i);return e.scale(s).add(t.scale(r)).add(n.scale(l)).add(o.scale(c))}function sx(e){let t=Gp(e),n=t(1);return o=>{let i=o*n,s=t(i,!0);return e(s)}}function Gp(e,t=10,n=10){let o=[0],i=[0],s=1/(t-1)/n,r=0,l=e(0),c=0;for(let d=1;d<t;d++){for(let a=0;a<n;a++){c+=s;let h=e(c),u=h.dist(l);r+=u,l=h}o[d]=r,i[d]=c}return i[t-1]=1,(d,a=!1)=>{if(a){let h=d;if(h<=0)return 0;if(h>=r)return 1;let u=0;for(;o[u+1]<h;)u++;let p=i[u],g=i[u+1],A=o[u],m=o[u+1],C=(h-A)/(m-A);return p+(g-p)*C}else{if(d<=0)return 0;if(d>=1)return o[t-1];let h=0;for(;i[h+1]<d;)h++;let u=i[h],p=i[h+1],g=o[h],A=o[h+1],m=(d-u)/(p-u);return g+(A-g)*m}}}function Jr(e,t,n,o){let i=2*e+t-2*o+n,s=-3*e+3*o-2*t-n,r=t,l=e;return c=>{let d=c*c,a=d*c;return i*a+s*d+r*c+l}}function Kp(e,t,n,o,i,s=Jr){let r=s(t.x,(1-i)*(n.x-e.x),(1-i)*(o.x-t.x),n.x),l=s(t.y,(1-i)*(n.y-e.y),(1-i)*(o.y-t.y),n.y);return c=>new ne(r(c),l(c))}function Na(e,t,n,o,i=Jr){return Kp(e,t,n,o,.5,i)}function rx(e,t,n,o,i=Jr){return Na(o.add(e.sub(t).scale(6)),e,o,e.add(o.sub(n).scale(6)),i)}function ax(e,t,n,o,i,s,r,l=Jr){let c=l(t.x,.5*(1-i)*(1+r)*(1+s)*(t.x-e.x)+.5*(1-i)*(1-r)*(1-s)*(n.x-t.x),.5*(1-i)*(1+r)*(1-s)*(n.x-t.x)+.5*(1-i)*(1-r)*(1+s)*(o.x-n.x),n.x),d=l(t.y,.5*(1-i)*(1+r)*(1+s)*(t.y-e.y)+.5*(1-i)*(1-r)*(1-s)*(n.y-t.y),.5*(1-i)*(1+r)*(1-s)*(n.y-t.y)+.5*(1-i)*(1-r)*(1+s)*(o.y-n.y),n.y);return a=>new ne(c(a),d(a))}function lx(e,t,n,o){let i=2*e+t-2*o+n,s=-3*e+3*o-2*t+n,r=t;return l=>{let c=l*l;return 3*i*c+2*s*l+r}}function Js(e){return 0<=e&&e<=1}function Jl(e,t){return Math.abs(e-t)<=Number.EPSILON}function Qs(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function cx(e,t,n,o){let i=3*e-6*t+3*n,s=-3*e+3*t,r=e,l=-e+3*t-3*n+o;if(Jl(l,0)){if(Jl(i,0))return Jl(s,0)?[]:[-r/s].filter(Js);let m=Math.sqrt(s*s-4*i*r),C=2*i;return[(m-s)/C,(-s-m)/C].filter(Js)}i/=l,s/=l,r/=l;let c=(3*s-i*i)/3,d=c/3,a=(2*i*i*i-9*i*s+27*r)/27,h=a/2,u=h*h+d*d*d;if(u<0){let m=-c/3,C=m*m*m,I=Math.sqrt(C),R=-a/(2*I),f=R<-1?-1:R>1?1:R,N=Math.acos(f),b=2*Qs(I),T=b*Math.cos(N/3)-i/3,x=b*Math.cos((N+2*Math.PI)/3)-i/3,M=b*Math.cos((N+4*Math.PI)/3)-i/3;return[T,x,M].filter(Js)}if(u===0){let m=h<0?Qs(-h):-Qs(h),C=2*m-i/3,I=-m-i/3;return[C,I].filter(Js)}let p=Math.sqrt(u),g=Qs(p-h),A=Qs(p+h);return[g-A-i/3].filter(Js)}function dx(e,t,n,o,i){let s=cx(e.x-i,t.x-i,n.x-i,o.x-i);return s.length>0?Ud(e,t,n,o,s[0]).y:NaN}function hx(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return n=>{if(n<=0||e.length==1||n<=e[0].x)return e[0].y;for(let o=0;o<t;o++)if(e[o].x>=n)return Ro(n,e[o-1].x,e[o].x,e[o-1].y,e[o].y);return e[e.length-1].y}}function ux(e,t){return n=>dx(j(0,0),e,t,j(1,1),n)}function fx(e,t="jump-end"){let n=1/e,o=t=="jump-start"||t=="jump-both",i=t=="jump-end"||t=="jump-both",s=1/(e+(i?1:0)),r=o?s:0;return l=>{let c=Math.floor(l/n);return r+c*s}}function px(e,t){let n=Number.MAX_VALUE,o={normal:j(0),distance:0};for(let i of[e,t])for(let s=0;s<i.pts.length;s++){let r=i.pts[s],l=i.pts[(s+1)%i.pts.length].sub(r).normal().unit(),c=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let p=0;p<e.pts.length;p++){let g=e.pts[p].dot(l);c=Math.min(c,g),d=Math.max(d,g)}let a=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let p=0;p<t.pts.length;p++){let g=t.pts[p].dot(l);a=Math.min(a,g),h=Math.max(h,g)}let u=Math.min(d,h)-Math.max(c,a);if(u<0)return null;if(u<Math.abs(n)){let p=h-c,g=a-d;n=Math.abs(p)<Math.abs(g)?p:g,o.normal=l,o.distance=n}}return o}function Vp(e,t,n){return(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)>=0}function gx(e){let t=0,n=e[e.length-1];for(let o=0;o<e.length;o++)t+=(e[o].x-n.x)*(e[o].y+n.y),n=e[o];return t<0}function Ql(e,t,n,o){let i=o.x-n.x,s=o.y-n.y,r=i*(e.y-n.y)-s*(e.x-n.x),l=i*(t.y-n.y)-s*(t.x-n.x);return r*l>=0}function mx(e,t,n,o){return Ql(e,t,n,o)&&Ql(e,n,t,o)&&Ql(e,o,t,n)}function yx(e,t,n,o){for(let i of e)if(i!==t&&i!==n&&i!==o&&mx(i,t,n,o))return!0;return!1}function xx(e,t,n,o){return Vp(e,t,n)&&!yx(o,e,t,n)}function Wp(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],n=[],o=0;for(let h=0;h<e.length;h++){let u=e[o],p=e[h];(p.x<u.x||p.x==u.x&&p.y<u.y)&&(o=o),t[h]=h+1,n[h]=h-1}t[t.length-1]=0,n[0]=n.length-1,gx(e)||([t,n]=[n,t]);let i=[];for(let h=0;h<e.length;++h)Vp(e[n[h]],e[h],e[t[h]])||i.push(e[h]);let s=[],r=e.length,l=1,c=0,d,a;for(;r>3;){d=t[l],a=n[l];let h=e[a],u=e[l],p=e[d];if(xx(h,u,p,i))s.push([h,u,p]),t[a]=d,n[d]=a,i.splice(i.indexOf(u),1),--r,c=0;else if(++c>r)return[];l=d}return d=t[l],a=n[l],s.push([e[a],e[l],e[d]]),s}function vx(e){if(e.length<3)return!1;let t=e.length-2,n=e.length-1,o=0,i=e[n].sub(e[t]),s=e[o].sub(e[n]),r=i.cross(s);for(;o+1<e.length;)if(t=n,n=o,o++,i=e[n].sub(e[t]),s=e[o].sub(e[n]),i.cross(s)*r<0)return!1;return!0}var $p=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Sl="topleft",wx="monospace",Ba="monospace",Oc="linear",Fd=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],bx=Fd.reduce((e,t)=>e+t.size,0),jp=2048,Ex=jp*4*bx,Sx=jp*6,Cx=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,_x=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Nc=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Bc=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,Ax=new Set(["id","require"]),Tx=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),gu=200,Mx=640,Rx=65536,Jp=Symbol.for("kaplay.cancel"),Qp=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},ts=class Zp{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let n=new Zp(()=>t.forEach(o=>o.cancel()));return Object.defineProperty(n,"paused",{get:()=>t[0].paused,set:o=>t.forEach(i=>i.paused=o)}),n.paused=!1,n}static replace(t,n){return t.cancel=()=>n.cancel(),n.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>n.paused,set:o=>n.paused=o}),t}},Fn=class{cancellers=new WeakMap;handlers=new Qp;add(e){function t(...i){if(!o.paused)return e(...i)}let n=this.handlers.pushd(t),o=new ts(n);return this.cancellers.set(t,n),o}addOnce(e){let t=this.add((...n)=>{t.cancel(),e(...n)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let n=t(...e),o;n===Jp&&(o=this.cancellers.get(t))&&o()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},Mr=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new Fn),this.handlers[e].add(t)}onOnce(e,t){let n=this.on(e,(...o)=>{n.cancel(),t(...o)});return n}next(e){return new Promise(t=>{this.onOnce(e,(...n)=>t(n[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},Dx=e=>e[0]instanceof Mt,Ix=e=>e[0]instanceof ne,Px=e=>typeof e[0]=="number",kp=class{_items;_compareFn;constructor(e=(t,n)=>t<n){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function Lx(e){let t=window.atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o.buffer}function Ox(e){return Lx(e.split(",")[1])}function Xd(e,t){let n=document.createElement("a");n.href=t,n.download=e,n.click()}function e0(e,t){Xd(e,"data:text/plain;charset=utf-8,"+t)}function Nx(e,t){e0(e,JSON.stringify(t))}function mu(e,t){let n=URL.createObjectURL(t);Xd(e,n),URL.revokeObjectURL(n)}var t0=e=>e.match(/^data:\w+\/\w+;base64,.+/),Bx=e=>e.split(".").slice(0,-1).join(".");function qd(e,t){if(e===t)return!0;let n=typeof e,o=typeof t;if(n!==o)return!1;if(n==="object"&&o==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(let r of i){let l=e[r],c=t[r];if(!qd(l,c))return!1}return!0}return!1}var yu=new Set,Hx=e=>e instanceof Error?e.message:String(e);function zx(e){yu.has(e)||(yu.add(e),console.warn(e))}function Bs(e,t){zx(`${e} is deprecated. Use ${t} instead.`)}function Hc(e,t){return Number(e.toFixed(t))}function sn(e,t){return(...n)=>{let o=n.length;if(o===e.length)return e(...n);if(o===t.length)return t(...n)}}var Ux=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function Fx(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],n=0,o=0;for(;n<e.length;){if(o+=Xx(n+o,e),$x(e[n+o])&&o++,Kx(e[n+o])&&o++,Vx(e[n+o])&&o++,jx(e[n+o])){o++;continue}t.push(e.substring(n,n+o)),n+=o,o=0}return t}function Xx(e,t){let n=t[e];if(!qx(n)||e===t.length-1)return 1;let o=n+t[e+1],i=t.substring(e+2,e+5);return xu(o)&&xu(i)?4:Yx(o)&&Wx(i)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:Gx(i)?4:2}function qx(e){return e&&ns(e[0].charCodeAt(0),55296,56319)}function xu(e){return ns(Yd(e),127462,127487)}function Yx(e){return ns(Yd(e),127988,127988)}function Gx(e){return ns(Yd(e),127995,127999)}function Kx(e){return typeof e=="string"&&ns(e.charCodeAt(0),65024,65039)}function Vx(e){return typeof e=="string"&&ns(e.charCodeAt(0),8400,8447)}function Wx(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&ns(t,917504,917631)}function $x(e){return typeof e=="string"&&Ux.includes(e.charCodeAt(0))}function jx(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Yd(e){let t=e.charCodeAt(0)-55296,n=e.charCodeAt(1)-56320;return(t<<10)+n+65536}function ns(e,t,n){return e>=t&&e<=n}var to=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,Co=(e,t)=>Array.isArray(t)?t.some(n=>e.has(n)):e.has(t),ha=(e,t,n)=>{e.has(t)?e.get(t)?.push(n):e.set(t,[n])},Jx=(()=>{let e=0;return()=>e++})(),Qx={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function n0(){let e=v.globalOpt.pixelDensity??1,t=v.globalOpt.width,n=v.globalOpt.height,o=v.gfx.ggl.gl.drawingBufferWidth,i=v.gfx.ggl.gl.drawingBufferHeight,s=o/e,r=i/e,l=0,c=0,d=s,a=r;if(v.globalOpt.letterbox){if(!t||!n)throw new Error("Letterboxing requires width and height defined.");let h=s/r,u=t/n;if(h>u){let p=r*u;l=(s-p)/2,d=p}else{let p=s/u;a=p,c=(r-p)/2}}if(v.globalOpt.stretch&&(!v.globalOpt.width||!v.globalOpt.height))throw new Error("Stretching requires width and height defined.");v.gfx.viewport={x:l,y:c,width:d,height:a,scale:(v.gfx.viewport.width+v.gfx.viewport.height)/(v.gfx.width+v.gfx.height)}}function Zx(e){return new ne(e.x*v.gfx.viewport.width/v.gfx.width,e.y*v.gfx.viewport.height/v.gfx.height)}function zo(e){return new ne((e.x-v.gfx.viewport.x)*v.gfx.width/v.gfx.viewport.width,(e.y-v.gfx.viewport.y)*v.gfx.height/v.gfx.viewport.height)}var kx=()=>Pi.lastInputDevice,e1=()=>{let e=Pi.buttons;for(let t in e){let n=e[t].keyboard&&[e[t].keyboard].flat(),o=e[t].keyboardCode&&[e[t].keyboardCode].flat(),i=e[t].gamepad&&[e[t].gamepad].flat(),s=e[t].mouse&&[e[t].mouse].flat();n&&n.forEach(r=>{ha(Pi.buttonsByKey,r,t)}),o&&o.forEach(r=>{ha(Pi.buttonsByKeyCode,r,t)}),i&&i.forEach(r=>{ha(Pi.buttonsByGamepad,r,t)}),s&&s.forEach(r=>{ha(Pi.buttonsByMouse,r,t)})}},yr=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},t1=class{buttonState=new yr;stickState=new Map},n1=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,n)=>t+n)/this.dts.length)),this.dts=[])}},Pi,vu=Qx,o1=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new n1,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new ne(0),mouseDeltaPos:new ne(0),keyState:new yr,mouseState:new yr,mergedGamepadState:new t1,gamepadStates:new Map,lastInputDevice:null,buttonState:new yr,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new Mr}},i1=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=o1(e);Pi=t,e1();function n(){return t.dt*t.timeScale}function o(){return t.fixedDt*t.timeScale}function i(){return t.restDt*t.timeScale}function s(){return t.isHidden}function r(){return t.time}function l(){return t.fpsCounter.fps}function c(){return t.numFrames}function d(){return t.canvas.toDataURL()}function a(L){t.canvas.style.cursor=L}function h(){return t.canvas.style.cursor}function u(L){if(L)try{let V=t.canvas.requestPointerLock();V?.catch&&V.catch(ee=>console.error(ee))}catch(V){console.error(V)}else document.exitPointerLock()}function p(){return!!document.pointerLockElement}function g(L){L.requestFullscreen?L.requestFullscreen():L.webkitRequestFullscreen&&L.webkitRequestFullscreen()}function A(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function m(L=!0){L?g(t.canvas):A()}function C(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function I(){t.stopped=!0;let L=Object.entries(dt),V=Object.entries(Tt),ee=Object.entries(xe);for(let[fe,nt]of L)t.canvas.removeEventListener(fe,nt);for(let[fe,nt]of V)document.removeEventListener(fe,nt);for(let[fe,nt]of ee)window.removeEventListener(fe,nt);_e.disconnect()}function R(L,V){t.loopID!==null&&cancelAnimationFrame(t.loopID);let ee=0,fe=0,nt=rt=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(nt);return}let Vt=rt/1e3,lt=Math.min(Vt-t.realTime,.25),It=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Vt,fe+=lt,fe>It){if(!t.skipTime){for(ee+=fe,t.dt=t.fixedDt,t.restDt=0;ee>t.fixedDt;)ee-=t.fixedDt,ee<t.fixedDt&&(t.restDt=ee),L();t.restDt=ee,t.dt=fe,t.time+=n(),t.fpsCounter.tick(t.dt)}fe=0,t.skipTime=!1,t.numFrames++,V(Rt,Dt)}t.loopID=requestAnimationFrame(nt)};nt(0)}function f(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function N(){return t.mousePos.clone()}function b(){return t.mouseDeltaPos.clone()}function T(L="left"){return t.mouseState.pressed.has(L)}function x(L="left"){return t.mouseState.down.has(L)}function M(L="left"){return t.mouseState.released.has(L)}function _(){return t.isMouseMoved}function O(L){return L===void 0?t.keyState.pressed.size>0:Co(t.keyState.pressed,L)}function P(L){return L===void 0?t.keyState.pressedRepeat.size>0:Co(t.keyState.pressedRepeat,L)}function z(L){return L===void 0?t.keyState.down.size>0:Co(t.keyState.down,L)}function U(L){return L===void 0?t.keyState.released.size>0:Co(t.keyState.released,L)}function F(L){return L===void 0?t.mergedGamepadState.buttonState.pressed.size>0:Co(t.mergedGamepadState.buttonState.pressed,L)}function B(L){return L===void 0?t.mergedGamepadState.buttonState.down.size>0:Co(t.mergedGamepadState.buttonState.down,L)}function D(L){return L===void 0?t.mergedGamepadState.buttonState.released.size>0:Co(t.mergedGamepadState.buttonState.released,L)}function q(L){return L===void 0?t.buttonState.pressed.size>0:Co(t.buttonState.pressed,L)}function G(L){return L===void 0?t.buttonState.down.size>0:Co(t.buttonState.down,L)}function Z(L){return L===void 0?t.buttonState.released.size>0:Co(t.buttonState.released,L)}function le(L){return t.buttons?.[L]}function ie(L,V){t.buttons[L]={...t.buttons[L],...V}}function oe(L){t.buttonState.press(L),t.events.trigger("buttonPress",L)}function se(L){t.buttonState.release(L),t.events.trigger("buttonRelease",L)}function he(L){return t.events.on("resize",L)}let Me=sn(L=>t.events.on("keyDown",L),(L,V)=>t.events.on("keyDown",ee=>to(L,ee)&&V(ee))),He=sn(L=>t.events.on("keyPress",V=>L(V)),(L,V)=>t.events.on("keyPress",ee=>to(L,ee)&&V(ee))),we=sn(L=>t.events.on("keyPressRepeat",L),(L,V)=>t.events.on("keyPressRepeat",ee=>to(L,ee)&&V(ee))),De=sn(L=>t.events.on("keyRelease",L),(L,V)=>t.events.on("keyRelease",ee=>to(L,ee)&&V(ee))),Qe=sn(L=>t.events.on("mouseDown",V=>L(V)),(L,V)=>t.events.on("mouseDown",ee=>to(L,ee)&&V(ee))),Ae=sn(L=>t.events.on("mousePress",V=>L(V)),(L,V)=>t.events.on("mousePress",ee=>to(L,ee)&&V(ee))),pt=sn(L=>t.events.on("mouseRelease",V=>L(V)),(L,V)=>t.events.on("mouseRelease",ee=>ee===L&&V(ee)));function pe(L){return t.events.on("mouseMove",()=>L(N(),b()))}function Se(L){return t.events.on("charInput",L)}function ae(L){return t.events.on("touchStart",L)}function Xe(L){return t.events.on("touchMove",L)}function qe(L){return t.events.on("touchEnd",L)}function Ce(L){return t.events.on("scroll",L)}function Ve(L){return t.events.on("hide",L)}function We(L){return t.events.on("show",L)}let At=sn(L=>t.events.on("gamepadButtonPress",(V,ee)=>L(V,ee)),(L,V)=>t.events.on("gamepadButtonPress",(ee,fe)=>to(L,ee)&&V(ee,fe))),Nt=sn(L=>t.events.on("gamepadButtonDown",(V,ee)=>L(V,ee)),(L,V)=>t.events.on("gamepadButtonDown",(ee,fe)=>to(L,ee)&&V(ee,fe))),wt=sn(L=>t.events.on("gamepadButtonRelease",(V,ee)=>L(V,ee)),(L,V)=>t.events.on("gamepadButtonRelease",(ee,fe)=>to(L,ee)&&V(ee,fe)));function Ie(L,V){return t.events.on("gamepadStick",(ee,fe,nt)=>ee===L&&V(fe,nt))}function Pe(L){t.events.on("gamepadConnect",L)}function Ge(L){t.events.on("gamepadDisconnect",L)}function $e(L){return t.mergedGamepadState.stickState.get(L)||new ne(0)}function je(){return[...t.charInputted]}function ct(){return[...t.gamepads]}let at=sn(L=>t.events.on("buttonPress",V=>L(V)),(L,V)=>t.events.on("buttonPress",ee=>to(L,ee)&&V(ee))),st=sn(L=>t.events.on("buttonDown",V=>L(V)),(L,V)=>t.events.on("buttonDown",ee=>to(L,ee)&&V(ee))),ut=sn(L=>t.events.on("buttonRelease",V=>L(V)),(L,V)=>t.events.on("buttonRelease",ee=>to(L,ee)&&V(ee)));function Rt(){t.events.trigger("input"),t.keyState.down.forEach(L=>t.events.trigger("keyDown",L)),t.mouseState.down.forEach(L=>t.events.trigger("mouseDown",L)),t.buttonState.down.forEach(L=>{t.events.trigger("buttonDown",L)}),Zt()}function Dt(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((L,V)=>{t.mergedGamepadState.stickState.set(V,new ne(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new ne(0),t.gamepadStates.forEach(L=>{L.buttonState.update(),L.stickState.forEach((V,ee)=>{L.stickState.set(ee,new ne(0))})})}function Yt(L){let V={index:L.index,isPressed:ee=>t.gamepadStates.get(L.index)?.buttonState.pressed.has(ee)||!1,isDown:ee=>t.gamepadStates.get(L.index)?.buttonState.down.has(ee)||!1,isReleased:ee=>t.gamepadStates.get(L.index)?.buttonState.released.has(ee)||!1,getStick:ee=>t.gamepadStates.get(L.index)?.stickState.get(ee)||j()};return t.gamepads.push(V),t.gamepadStates.set(L.index,{buttonState:new yr,stickState:new Map([["left",new ne(0)],["right",new ne(0)]])}),V}function Pt(L){t.gamepads=t.gamepads.filter(V=>V.index!==L.index),t.gamepadStates.delete(L.index)}function Zt(){for(let L of navigator.getGamepads())L&&!t.gamepadStates.has(L.index)&&Yt(L);for(let L of t.gamepads){let V=navigator.getGamepads()[L.index];if(!V)continue;let ee=(e.gamepads??{})[V.id]||vu[V.id]||vu.default,fe=t.gamepadStates.get(L.index);if(fe){for(let nt=0;nt<V.buttons.length;nt++){let rt=ee.buttons[nt],Vt=V.buttons[nt],lt=t.buttonsByGamepad.has(rt);if(Vt.pressed){if(fe.buttonState.down.has(rt)){t.events.trigger("gamepadButtonDown",rt,L);continue}t.lastInputDevice="gamepad",lt&&t.buttonsByGamepad.get(rt)?.forEach(It=>{t.buttonState.press(It),t.events.trigger("buttonPress",It)}),t.mergedGamepadState.buttonState.press(rt),fe.buttonState.press(rt),t.events.trigger("gamepadButtonPress",rt,L)}else fe.buttonState.down.has(rt)&&(lt&&t.buttonsByGamepad.get(rt)?.forEach(It=>{t.buttonState.release(It),t.events.trigger("buttonRelease",It)}),t.mergedGamepadState.buttonState.release(rt),fe.buttonState.release(rt),t.events.trigger("gamepadButtonRelease",rt,L))}for(let nt in ee.sticks){let rt=ee.sticks[nt];if(!rt)continue;let Vt=new ne(V.axes[rt.x],V.axes[rt.y]);fe.stickState.set(nt,Vt),t.mergedGamepadState.stickState.set(nt,Vt),t.events.trigger("gamepadStick",nt,Vt,L)}}}}let dt={},Tt={},xe={},Ze=e.pixelDensity||1;dt.mousemove=L=>{let V=zo(new ne(L.offsetX,L.offsetY)),ee=new ne(L.movementX,L.movementY);if(C()){let fe=t.canvas.width/Ze,nt=t.canvas.height/Ze,rt=window.innerWidth,Vt=window.innerHeight,lt=rt/Vt,It=fe/nt;if(lt>It){let Wt=Vt/nt,fn=(rt-fe*Wt)/2;V.x=Ro(L.offsetX-fn,0,fe*Wt,0,fe),V.y=Ro(L.offsetY,0,nt*Wt,0,nt)}else{let Wt=rt/fe,fn=(Vt-nt*Wt)/2;V.x=Ro(L.offsetX,0,fe*Wt,0,fe),V.y=Ro(L.offsetY-fn,0,nt*Wt,0,nt)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=V,t.mouseDeltaPos=ee,t.events.trigger("mouseMove")})};let re=["left","middle","right","back","forward"];dt.mousedown=L=>{t.events.onOnce("input",()=>{let V=re[L.button];V&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(V)&&t.buttonsByMouse.get(V)?.forEach(ee=>{t.buttonState.press(ee),t.events.trigger("buttonPress",ee)}),t.mouseState.press(V),t.events.trigger("mousePress",V))})},dt.mouseup=L=>{t.events.onOnce("input",()=>{let V=re[L.button];V&&(t.buttonsByMouse.has(V)&&t.buttonsByMouse.get(V)?.forEach(ee=>{t.buttonState.release(ee),t.events.trigger("buttonRelease",ee)}),t.mouseState.release(V),t.events.trigger("mouseRelease",V))})};let Re=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),ke={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};dt.keydown=L=>{Re.has(L.key)&&L.preventDefault(),t.events.onOnce("input",()=>{let V=ke[L.key]||L.key.toLowerCase(),ee=L.code;if(V===void 0)throw new Error(`Unknown key: ${L.key}`);V.length===1?(t.events.trigger("charInput",V),t.charInputted.push(V)):V==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),L.repeat?(t.keyState.pressRepeat(V),t.events.trigger("keyPressRepeat",V)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(V)&&t.buttonsByKey.get(V)?.forEach(fe=>{t.buttonState.press(fe),t.events.trigger("buttonPress",fe)}),t.buttonsByKeyCode.has(ee)&&t.buttonsByKeyCode.get(ee)?.forEach(fe=>{t.buttonState.press(fe),t.events.trigger("buttonPress",fe)}),t.keyState.press(V),t.events.trigger("keyPressRepeat",V),t.events.trigger("keyPress",V))})},dt.keyup=L=>{t.events.onOnce("input",()=>{let V=ke[L.key]||L.key.toLowerCase(),ee=L.code;t.buttonsByKey.has(V)&&t.buttonsByKey.get(V)?.forEach(fe=>{t.buttonState.release(fe),t.events.trigger("buttonRelease",fe)}),t.buttonsByKeyCode.has(ee)&&t.buttonsByKeyCode.get(ee)?.forEach(fe=>{t.buttonState.release(fe),t.events.trigger("buttonRelease",fe)}),t.keyState.release(V),t.events.trigger("keyRelease",V)})},dt.touchstart=L=>{L.preventDefault(),t.events.onOnce("input",()=>{let V=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=zo(new ne(V[0].clientX-ee.x,V[0].clientY-ee.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(fe=>{t.buttonState.press(fe),t.events.trigger("buttonPress",fe)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),V.forEach(fe=>{t.events.trigger("touchStart",zo(new ne(fe.clientX-ee.x,fe.clientY-ee.y)),fe)})})},dt.touchmove=L=>{L.preventDefault(),t.events.onOnce("input",()=>{let V=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let fe=t.mousePos;t.mousePos=zo(new ne(V[0].clientX-ee.x,V[0].clientY-ee.y)),t.mouseDeltaPos=t.mousePos.sub(fe),t.events.trigger("mouseMove")}V.forEach(fe=>{t.events.trigger("touchMove",zo(new ne(fe.clientX-ee.x,fe.clientY-ee.y)),fe)})})},dt.touchend=L=>{t.events.onOnce("input",()=>{let V=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=zo(new ne(V[0].clientX-ee.x,V[0].clientY-ee.y)),t.mouseDeltaPos=new ne(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(fe=>{t.buttonState.release(fe),t.events.trigger("buttonRelease",fe)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),V.forEach(fe=>{t.events.trigger("touchEnd",zo(new ne(fe.clientX-ee.x,fe.clientY-ee.y)),fe)})})},dt.touchcancel=L=>{t.events.onOnce("input",()=>{let V=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=zo(new ne(V[0].clientX-ee.x,V[0].clientY-ee.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),V.forEach(fe=>{t.events.trigger("touchEnd",zo(new ne(fe.clientX-ee.x,fe.clientY-ee.y)),fe)})})},dt.wheel=L=>{L.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new ne(L.deltaX,L.deltaY))})},dt.contextmenu=L=>L.preventDefault(),Tt.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},xe.gamepadconnected=L=>{let V=Yt(L.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",V)})},xe.gamepaddisconnected=L=>{let V=ct().filter(ee=>ee.index===L.gamepad.index)[0];Pt(L.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",V)})};for(let[L,V]of Object.entries(dt))t.canvas.addEventListener(L,V);for(let[L,V]of Object.entries(Tt))document.addEventListener(L,V);for(let[L,V]of Object.entries(xe))window.addEventListener(L,V);let _e=new ResizeObserver(L=>{for(let V of L)if(V.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return _e.observe(t.canvas),{state:t,dt:n,fixedDt:o,restDt:i,time:r,run:R,canvas:t.canvas,fps:l,numFrames:c,quit:I,isHidden:s,setFullscreen:m,isFullscreen:C,setCursor:a,screenshot:d,getGamepads:ct,getCursor:h,setCursorLocked:u,isCursorLocked:p,isTouchscreen:f,mousePos:N,mouseDeltaPos:b,isKeyDown:z,isKeyPressed:O,isKeyPressedRepeat:P,isKeyReleased:U,isMouseDown:x,isMousePressed:T,isMouseReleased:M,isMouseMoved:_,isGamepadButtonPressed:F,isGamepadButtonDown:B,isGamepadButtonReleased:D,getGamepadStick:$e,isButtonPressed:q,isButtonDown:G,isButtonReleased:Z,setButton:ie,getButton:le,pressButton:oe,releaseButton:se,charInputted:je,onResize:he,onKeyDown:Me,onKeyPress:He,onKeyPressRepeat:we,onKeyRelease:De,onMouseDown:Qe,onMousePress:Ae,onMouseRelease:pt,onMouseMove:pe,onCharInput:Se,onTouchStart:ae,onTouchMove:Xe,onTouchEnd:qe,onScroll:Ce,onHide:Ve,onShow:We,onGamepadButtonDown:Nt,onGamepadButtonPress:At,onGamepadButtonRelease:wt,onGamepadStick:Ie,onGamepadConnect:Pe,onGamepadDisconnect:Ge,onButtonPress:at,onButtonDown:st,onButtonRelease:ut,getLastInputDeviceType:kx,events:t.events}};function Tn(){return v.app.dt()}function zc(){return v.app.fixedDt()}function Uc(){return v.app.restDt()}var s1=new ne(-1,-1),r1=new ne(0,-1),a1=new ne(1,-1),l1=new ne(-1,0),c1=new ne(0,0),d1=new ne(1,0),h1=new ne(-1,1),u1=new ne(0,1),f1=new ne(1,1);function Hs(e){switch(e){case"topleft":return s1;case"top":return r1;case"topright":return a1;case"left":return l1;case"center":return c1;case"right":return d1;case"botleft":return h1;case"bot":return u1;case"botright":return f1;default:return e}}function p1(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function g1(e){return e.createBuffer(1,1,44100)}var ua=2.5949095,wu=1.70158+1,bu=2*Math.PI/3,Eu=2*Math.PI/4.5,_a={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>wu*e*e*e-1.70158*e*e,easeOutBack:e=>1+wu*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((ua+1)*2*e-ua)/2:(Math.pow(2*e-2,2)*((ua+1)*(e*2-2)+ua)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*bu),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*bu)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Eu))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Eu)/2+1,easeInBounce:e=>1-_a.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-_a.easeOutBounce(1-2*e))/2:(1+_a.easeOutBounce(2*e-1))/2},Rr=_a;function m1(e,t,n){let o=[],i=t;for(o.push(i);i!==e;){if(i=n.get(i),i==null)return null;o.push(i)}return o.reverse()}function y1(e,t,n){let o=new kp((r,l)=>r.cost<l.cost);o.insert({cost:0,node:t});let i=new Map;i.set(t,t);let s=new Map;for(s.set(t,0);o.length!==0;){let r=o.remove()?.node;if(r===n)break;let l=e.getNeighbours(r);for(let c of l){let d=(s.get(r)||0)+e.getCost(r,c)+e.getHeuristic(c,n);(!s.has(c)||d<s.get(c))&&(s.set(c,d),o.insert({cost:d,node:c}),i.set(c,r))}}return m1(t,n,i)}var x1=class{a;b;polygon;constructor(e,t,n){this.a=e,this.b=t,this.polygon=new WeakRef(n)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},v1=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,n=0,o=0;for(let i of this._edges){i.polygon=new WeakRef(this);let s=i.a.x*i.b.y-i.a.y*i.b.x;t+=(i.a.x+i.b.x)*s,n+=(i.a.y+i.b.y)*s,o+=s}o/=2,this._centroid=j(t/(6*o),n/(6*o))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let n of this.edges)n.b.y>e.y!=n.a.y>e.y&&e.x<(n.a.x-n.b.x)*(e.y-n.b.y)/(n.a.y-n.b.y)+n.b.x&&(t=!t);return t}},w1=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let n=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[n]}_findCommonEdge(e,t){for(let n of e.edges){let o=this._findEdge(n.b,n.a);if(o&&o.polygon.deref().id===t.id)return o}return null}addPolygon(e){let t=new v1(this._polygons.length),n=e.map((o,i)=>new x1(o,e[(i+1)%e.length],t));t.edges=n,this._polygons.push(t);for(let o of t.edges)this._addEdge(o);return t}addRect(e,t){let n=this._addPoint(e),o=this._addPoint(e.add(t.x,0)),i=this._addPoint(e.add(t)),s=this._addPoint(e.add(0,t.y));return this.addPolygon([n,o,i,s])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let n of this._polygons[e].edges){let o=this._findEdge(n.b,n.a);if(o){let i=o.polygon.deref();i&&t.push(i.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let n=this._polygons[e],o=this._polygons[t],i=n.centroid.x-o.centroid.x,s=n.centroid.y-o.centroid.y;return Math.sqrt(i*i+s*s)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:y1(this,e,t)}getWaypointPath(e,t,n){let o=n?.type||"centroids",i=this._getLocation(e),s=this._getLocation(t);if(i===void 0||s===void 0)return[];let r=this.getPath(i.id,s.id);if(!r)return[];if(o==="edges"){let l=[];for(let c=1;c<r.length;c++){let d=this._polygons[r[c-1]],a=this._polygons[r[c]],h=this._findCommonEdge(d,a);l.push(h.middle.add(a.centroid.sub(h.middle).unit().scale(4)))}return[e,...l,t]}else return[e,...r.slice(1,-1).map(l=>this._polygons[l].centroid),t]}};function xr(e){let t=new Oo;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function b1(e){return new ne(e.x/In()*2-1,-e.y/On()*2+1)}function dr(e,t,n,o,i,s=1){o=xn(o%360),i=xn(i%360),i<=o&&(i+=Math.PI*2);let r=[],l=Math.ceil((i-o)/xn(8)*s),c=(i-o)/l,d=j(Math.cos(o),Math.sin(o)),a=j(Math.cos(c),Math.sin(c));for(let h=0;h<=l;h++)r.push(e.add(t*d.x,n*d.y)),d=j(d.x*a.x-d.y*a.y,d.x*a.y+d.y*a.x);return r}function E1(...e){let t=Kt(...e),n=e[3]??1;v.gfx.bgColor=t,v.gfx.bgAlpha=n,v.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,n)}function S1(){return v.gfx.bgColor?.clone?.()??null}function hn(...e){if(e[0]===void 0)return;let t=j(...e);t.x===0&&t.y===0||v.gfx.transform.translate(t)}function no(){v.gfx.transformStack.push(v.gfx.transform.clone())}function C1(e){v.gfx.transform=e.clone()}function Dr(...e){if(e[0]===void 0)return;let t=j(...e);t.x===1&&t.y===1||v.gfx.transform.scale(t)}function _s(e){e&&v.gfx.transform.rotate(e)}function $n(){v.gfx.transformStack.length>0&&(v.gfx.transform=v.gfx.transformStack.pop())}function oo(){v.gfx.renderer.flush()}function In(){return v.gfx.width}function On(){return v.gfx.height}function o0(){return(v.gfx.viewport.width+v.gfx.viewport.height)/(v.gfx.width+v.gfx.height)}function Ha(){return j(In()/2,On()/2)}var _1=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,n,o){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=n,this.textures=[ui.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=o;let i=this.canvas.getContext("2d");if(!i)throw new Error("Failed to get 2d context");this.c2d=i}addSingle(e){let t=ui.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new cn(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,n=e.height+this.padding*2;if(t>this.canvas.width||n>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+n>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(ui.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let o=this.textures[this.textures.length-1],i=new ne(this.x+this.padding,this.y+this.padding);return this.x+=t,n>this.curHeight&&(this.curHeight=n),e instanceof ImageData?this.c2d.putImageData(e,i.x,i.y):this.c2d.drawImage(e,i.x,i.y),o.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:i,size:new ne(e.width,e.height),texture:o}),this.lastTextureId++,[o,new cn(i.x/this.canvas.width,i.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function ao(e){return typeof e!="string"||t0(e)?e:v.assets.urlPrefix+e}var lo=class i0{loaded=!1;data=null;error=null;onLoadEvents=new Fn;onErrorEvents=new Fn;onFinishEvents=new Fn;constructor(t){t.then(n=>{this.loaded=!0,this.data=n,this.onLoadEvents.trigger(n)}).catch(n=>{if(this.error=n,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(n);else throw n}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let n=new i0(Promise.resolve(t));return n.data=t,n.loaded=!0,n}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},cs=class{assets=new Map;lastUID=0;add(e,t){let n=e??this.lastUID+++"",o=new lo(t);return this.assets.set(n,o),o}addLoaded(e,t){let n=e??this.lastUID+++"",o=lo.loaded(t);return this.assets.set(n,o),o}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function Gd(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function Cl(e){return Gd(e).then(t=>t.json())}function A1(e){return Gd(e).then(t=>t.text())}function T1(e){return Gd(e).then(t=>t.arrayBuffer())}function M1(e){return e!==void 0&&(v.assets.urlPrefix=e),v.assets.urlPrefix}function R1(e,t){return v.assets.custom.add(e,Cl(ao(t)))}function _l(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((n,o)=>{t.onload=()=>n(t),t.onerror=()=>o(new Error(`Failed to load image from "${e}"`))})}function Yi(){let e=[v.assets.sprites,v.assets.sounds,v.assets.shaders,v.assets.fonts,v.assets.bitmapFonts,v.assets.custom];return e.reduce((t,n)=>t+n.progress(),0)/e.length}function s0(){return[v.assets.sprites,v.assets.sounds,v.assets.shaders,v.assets.fonts,v.assets.bitmapFonts,v.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function D1(e){return v.assets.custom.get(e)??null}function Fc(e){return v.assets.custom.add(null,e)}var I1=(e,t)=>({urlPrefix:"",sprites:new cs,fonts:new cs,bitmapFonts:new cs,sounds:new cs,shaders:new cs,custom:new cs,music:{},packer:new _1(e,2048,2048,t),loaded:!1}),P1="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",xi=class hr{tex;frames=[new cn(0,0,1,1)];anims={};slice9=null;constructor(t,n,o={},i=null){this.tex=t,n&&(this.frames=n),this.anims=o,this.slice9=i}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,n={}){return typeof t=="string"?hr.fromURL(t,n):Promise.resolve(hr.fromImage(t,n))}static fromImage(t,n={}){let[o,i]=n.singular?v.assets.packer.addSingle(t):v.assets.packer.add(t),s=n.frames?n.frames.map(r=>new cn(i.x+r.x*i.w,i.y+r.y*i.h,r.w*i.w,r.h*i.h)):a0(n.sliceX||1,n.sliceY||1,i.x,i.y,i.w,i.h);return new hr(o,s,n.anims,n.slice9)}static fromURL(t,n={}){return _l(t).then(o=>hr.fromImage(o,n))}};function Aa(e){if(typeof e=="string"){let t=r0(e);if(t)return t;if(Yi()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof xi)return lo.loaded(e);if(e instanceof lo)return e;throw new Error(`Invalid sprite: ${e}`)}}function r0(e){return v.assets.sprites.get(e)??null}function vr(e,t,n={sliceX:1,sliceY:1,anims:{}}){return t=ao(t),Array.isArray(t)?t.some(o=>typeof o=="string")?v.assets.sprites.add(e,Promise.all(t.map(o=>typeof o=="string"?_l(o):Promise.resolve(o))).then(o=>Su(o,n))):v.assets.sprites.addLoaded(e,Su(t,n)):typeof t=="string"?v.assets.sprites.add(e,xi.from(t,n)):v.assets.sprites.addLoaded(e,xi.fromImage(t,n))}function a0(e=1,t=1,n=0,o=0,i=1,s=1){let r=[],l=i/e,c=s/t;for(let d=0;d<t;d++)for(let a=0;a<e;a++)r.push(new cn(n+a*l,o+d*c,l,c));return r}function Su(e,t={}){let n=document.createElement("canvas"),o=e[0].width,i=e[0].height;n.width=o*e.length,n.height=i;let s=n.getContext("2d");if(!s)throw new Error("Failed to create canvas context");e.forEach((l,c)=>{l instanceof ImageData?s.putImageData(l,c*o,0):s.drawImage(l,c*o,0)});let r=s.getImageData(0,0,e.length*o,i);return xi.fromImage(r,{...t,sliceX:e.length,sliceY:1})}function L1(e="bean"){return vr(e,P1)}function O1(e,t,n){t=ao(t),n=ao(n),typeof t=="string"&&!n&&(n=Bx(t)+".json");let o=typeof n=="string"?Cl(n):Promise.resolve(n);return v.assets.sprites.add(e,o.then(i=>{let s=i.meta.size,r=i.frames.map(c=>new cn(c.frame.x/s.w,c.frame.y/s.h,c.frame.w/s.w,c.frame.h/s.h)),l={};for(let c of i.meta.frameTags)c.from===c.to?l[c.name]=c.from:l[c.name]={from:c.from,to:c.to,speed:10,loop:!0,pingpong:c.direction==="pingpong"};return xi.from(t,{frames:r,anims:l})}))}var Ta=class{fontface;filter=Oc;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??Oc,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Kt(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function l0(e){if(!e)return l0(v.globalOpt.font??wx);if(typeof e=="string"){let t=d0(e),n=c0(e);if(t)return t.data??t;if(n)return n.data??n;if(document.fonts.check(`64px ${e}`))return e;if(Yi()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof lo)return e.data?e.data:e;return e}function c0(e){return v.assets.fonts.get(e)??null}function N1(e,t,n={}){let o=ao(t),i=new FontFace(e,typeof t=="string"?`url(${o})`:o);return document.fonts.add(i),v.assets.fonts.add(e,i.load().catch(s=>{throw new Error(`Failed to load font from "${o}": ${s}`)}).then(s=>new Ta(s,n)))}function B1(e,t,n,o){let i=e.width/t,s={},r=o.split("").entries();for(let[l,c]of r)s[c]=new cn(l%i*t,Math.floor(l/i)*n,t,n);return{tex:e,map:s,size:n}}function d0(e){return v.assets.bitmapFonts.get(e)??null}function H1(e,t,n,o,i={}){let s=ao(t);return v.assets.bitmapFonts.add(e,_l(s).then(r=>B1(ui.fromImage(v.gfx.ggl,r,i),n,o,i.chars??$p)))}function z1(e,t){return t=ao(t),v.assets.sprites.add(e,new Promise(async n=>{let o=typeof t=="string"?await Cl(t):t,i=await Promise.all(o.frames.map(_l)),s=document.createElement("canvas");s.width=o.width,s.height=o.height*o.frames.length;let r=s.getContext("2d");if(!r)throw new Error("Failed to create canvas context");i.forEach((c,d)=>{r.drawImage(c,0,d*o.height)});let l=await vr(null,s,{sliceY:o.frames.length,anims:o.anims});n(l)}))}var U1=class{ctx;glProgram;constructor(e,t,n,o){this.ctx=e,e.onDestroy(()=>this.free());let i=e.gl,s=i.createShader(i.VERTEX_SHADER),r=i.createShader(i.FRAGMENT_SHADER);if(!s||!r)throw new Error("Failed to create shader");i.shaderSource(s,t),i.shaderSource(r,n),i.compileShader(s),i.compileShader(r);let l=i.createProgram();if(this.glProgram=l,i.attachShader(l,s),i.attachShader(l,r),o.forEach((c,d)=>i.bindAttribLocation(l,d,c)),i.linkProgram(l),!i.getProgramParameter(l,i.LINK_STATUS)){let c=i.getShaderInfoLog(s);if(c)throw new Error("VERTEX SHADER "+c);let d=i.getShaderInfoLog(r);if(d)throw new Error("FRAGMENT SHADER "+d)}i.deleteShader(s),i.deleteShader(r)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let n in e){let o=e[n],i=t.getUniformLocation(this.glProgram,n);if(typeof o=="number")t.uniform1f(i,o);else if(o instanceof Oo)t.uniformMatrix4fv(i,!1,new Float32Array(o.m));else if(o instanceof Mt)t.uniform3f(i,o.r,o.g,o.b);else if(o instanceof ne)t.uniform2f(i,o.x,o.y);else if(Array.isArray(o))o[0],Px(o)?t.uniform1fv(i,o):Ix(o)?t.uniform2fv(i,o.map(s=>[s.x,s.y]).flat()):Dx(o)&&t.uniform3fv(i,o.map(s=>[s.r,s.g,s.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function Kd(e,t=Nc,n=Bc){let o=Cx.replace("{{user}}",t??Nc),i=_x.replace("{{user}}",n??Bc);try{return new U1(e,o,i,Fd.map(s=>s.name))}catch(s){let r=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,l=Hx(s).match(r);if(!l?.groups)throw s;let c=Number(l.groups.line)-14,d=l.groups.msg.trim(),a=l.groups.type.toLowerCase();throw new Error(`${a} shader line ${c}: ${d}`)}}function F1(e){if(!e)return v.gfx.defShader;if(typeof e=="string"){let t=h0(e);if(t)return t.data??t;if(Yi()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof lo)return e.data?e.data:e;return e}function h0(e){return v.assets.shaders.get(e)??null}function X1(e,t,n){return v.assets.shaders.addLoaded(e,Kd(v.gfx.ggl,t,n))}function q1(e,t,n){t=ao(t),n=ao(n);let o=s=>s?A1(s):Promise.resolve(null),i=Promise.all([o(t),o(n)]).then(([s,r])=>Kd(v.gfx.ggl,s,r));return v.assets.shaders.add(e,i)}var Ir=class Ma{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((n,o)=>v.audio.ctx.decodeAudioData(t,n,o)).then(n=>new Ma(n))}static fromURL(t){return t0(t)?Ma.fromArrayBuffer(Ox(t)):T1(t).then(n=>Ma.fromArrayBuffer(n))}};function Y1(e){if(typeof e=="string"){let t=u0(e);if(t)return t;if(Yi()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof Ir)return lo.loaded(e);if(e instanceof lo)return e;throw new Error(`Invalid sound: ${e}`)}}function u0(e){return v.assets.sounds.get(e)??null}function G1(e,t){return t=ao(t),v.assets.sounds.add(e,typeof t=="string"?Ir.fromURL(t):Ir.fromArrayBuffer(t))}function K1(e,t){let n=ao(t),o=new Audio(n);return o.preload="auto",v.assets.music[e]=n}function f0(e,t){return e=ao(e),Fc(typeof t=="string"?new Promise((n,o)=>{Cl(t).then(i=>{f0(e,i).then(n).catch(o)})}):xi.from(e).then(n=>{let o={};for(let i in t){let s=t[i],r=n.frames[0],l=2048*r.w,c=2048*r.h,d=s.frames?s.frames.map(h=>new cn(r.x+(s.x+h.x)/l*r.w,r.y+(s.y+h.y)/c*r.h,h.w/l*r.w,h.h/c*r.h)):a0(s.sliceX||1,s.sliceY||1,r.x+s.x/l*r.w,r.y+s.y/c*r.h,s.width/l*r.w,s.height/c*r.h),a=new xi(n.tex,d,s.anims);v.assets.sprites.addLoaded(i,a),o[i]=a}return o}))}function Ci(e,t,n=!1,o,i,s={}){let r=o??v.gfx.defTex,l=i??v.gfx.defShader,c=F1(l);if(!c||c instanceof lo)return;let d=v.gfx.fixed||n?v.gfx.transform:v.game.cam.transform.mult(v.gfx.transform),a=[];for(let h of e){let u=b1(d.multVec2(h.pos));a.push(u.x,u.y,h.uv.x,h.uv.y,h.color.r/255,h.color.g/255,h.color.b/255,h.opacity)}v.gfx.renderer.push(v.gfx.ggl.gl.TRIANGLES,a,t,c,r,s)}function hi(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(no(),hn(e.pos),Dr(e.scale),_s(e.angle),hn(e.offset),e.fill!==!1){let n=e.color??Mt.WHITE,o=e.pts.map((s,r)=>({pos:new ne(s.x,s.y),uv:e.uv?e.uv[r]:new ne(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(n):n,opacity:e.opacity??1})),i;e.triangulate?i=Wp(e.pts).map(s=>s.map(r=>e.pts.indexOf(r))).flat():i=[...Array(t-2).keys()].map(s=>[0,s+1,s+2]).flat(),Ci(o,e.indices??i,e.fixed,e.uv?e.tex:v.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&Vd({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),$n()}}function p0(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,n=e.end??360,o=Hs(e.anchor??"center").scale(new ne(-e.radiusX,-e.radiusY)),i=dr(o,e.radiusX,e.radiusY,t,n,e.resolution);i.unshift(o);let s=Object.assign({},e,{pts:i,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(i.length-1).fill(e.gradient[1])]}:{}});if(n-t>=360&&e.outline){e.fill!==!1&&hi(Object.assign({},s,{outline:null})),hi(Object.assign({},s,{pts:i.slice(1),fill:!1}));return}hi(s)}function zs(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&p0(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function ur(e){let{p1:t,p2:n}=e;if(!t||!n)throw new Error('drawLine() requires properties "p1" and "p2".');let o=e.width||1,i=n.sub(t).unit().normal().scale(o*.5),s=[t.sub(i),t.add(i),n.add(i),n.sub(i)].map(r=>({pos:new ne(r.x,r.y),uv:new ne(0),color:e.color??Mt.WHITE,opacity:e.opacity??1}));Ci(s,[0,1,3,1,2,3],e.fixed,v.gfx.defTex,e.shader,e.uniform??void 0)}function V1(e){let t=e.pts,n=[],o=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),s=e.pos||j(0,0),r;i?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-o/l),d,a=t[0];if(!i)switch(e.cap){case"square":{let g=r.scale(-o/l);n.push(a.add(g).add(c)),n.push(a.add(g).sub(c));break}case"round":{let g=Math.max(o,10),A=Math.PI/g,m=c.scale(-1),C=Math.cos(A),I=Math.sin(A);for(let R=0;R<g;R++)n.push(a),n.push(a.sub(m)),m=j(m.x*C-m.y*I,m.x*I+m.y*C)}}for(let g=1;g<t.length;g++){if(a===t[g]||a.eq(t[g]))continue;d=a,a=t[g];let A=a.sub(d),m=A.len(),C=A.normal().scale(-o/m),I=r.cross(A);if(Math.abs(I)/(l*m)<.05){n.push(d.add(c)),n.push(d.sub(c)),r.dot(A)<0&&(n.push(d.sub(c)),n.push(d.add(c))),r=A,l=m,c=C;continue}let R=C.sub(c).cross(A)/I,f=c.add(r.scale(R));I>0?(n.push(d.add(f)),n.push(d.sub(c)),n.push(d.add(f)),n.push(d.sub(C))):(n.push(d.add(c)),n.push(d.sub(f)),n.push(d.add(C)),n.push(d.sub(f))),r=A,l=m,c=C}if(!i)switch(n.push(a.add(c)),n.push(a.sub(c)),e.cap){case"square":{let g=r.scale(o/l);n.push(a.add(g).add(c)),n.push(a.add(g).sub(c));break}case"round":{let g=Math.max(o,10),A=Math.PI/g,m=c.scale(1),C=Math.cos(A),I=Math.sin(A);for(let R=0;R<g;R++)m=j(m.x*C-m.y*I,m.x*I+m.y*C),n.push(a),n.push(a.sub(m))}}if(n.length<4)return;let h=n.map(g=>({pos:s.add(g),uv:j(),color:e.color||Mt.WHITE,opacity:e.opacity??1})),u=[],p=0;for(let g=0;g<n.length-2;g+=2)u[p++]=g+1,u[p++]=g,u[p++]=g+2,u[p++]=g+2,u[p++]=g+3,u[p++]=g+1;i&&(u[p++]=n.length-1,u[p++]=n.length-2,u[p++]=0,u[p++]=0,u[p++]=1,u[p++]=n.length-1),Ci(h,u,e.fixed,v.gfx.defTex,e.shader,e.uniform??void 0)}function W1(e){let t=e.pts,n=[],o=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),s=e.pos||j(0,0),r;i?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-o/l),d,a=t[0];if(!i)switch(e.cap){case"square":{let g=r.scale(-o/l);n.push(a.add(g).add(c)),n.push(a.add(g).sub(c));break}case"round":{let g=Math.max(o,10),A=Math.PI/g,m=c.scale(-1),C=Math.cos(A),I=Math.sin(A);for(let R=0;R<g;R++)n.push(a),n.push(a.sub(m)),m=j(m.x*C-m.y*I,m.x*I+m.y*C)}}for(let g=1;g<t.length;g++){if(a===t[g]||a.eq(t[g]))continue;d=a,a=t[g];let A=a.sub(d),m=A.len(),C=A.normal().scale(-o/m),I=r.cross(A);if(Math.abs(I)/(l*m)<.05){n.push(d.add(c)),n.push(d.sub(c)),r.dot(A)<0&&(n.push(d.sub(c)),n.push(d.add(c))),r=A,l=m,c=C;continue}let R=C.sub(c).cross(A)/I,f=c.add(r.scale(R));if(I>0){let N=d.add(f),b=Math.max(o,10),T=xn(c.angleBetween(C)/b),x=c,M=Math.cos(T),_=Math.sin(T);for(let O=0;O<b;O++)n.push(N),n.push(d.sub(x)),x=j(x.x*M-x.y*_,x.x*_+x.y*M)}else{let N=d.sub(f),b=Math.max(o,10),T=xn(c.angleBetween(C)/b),x=c,M=Math.cos(T),_=Math.sin(T);for(let O=0;O<b;O++)n.push(d.add(x)),n.push(N),x=j(x.x*M-x.y*_,x.x*_+x.y*M)}r=A,l=m,c=C}if(!i)switch(n.push(a.add(c)),n.push(a.sub(c)),e.cap){case"square":{let g=r.scale(o/l);n.push(a.add(g).add(c)),n.push(a.add(g).sub(c));break}case"round":{let g=Math.max(o,10),A=Math.PI/g,m=c.scale(1),C=Math.cos(A),I=Math.sin(A);for(let R=0;R<g;R++)m=j(m.x*C-m.y*I,m.x*I+m.y*C),n.push(a),n.push(a.sub(m))}}if(n.length<4)return;let h=n.map(g=>({pos:s.add(g),uv:j(),color:e.color||Mt.WHITE,opacity:e.opacity??1})),u=[],p=0;for(let g=0;g<n.length-2;g+=2)u[p++]=g+1,u[p++]=g,u[p++]=g+2,u[p++]=g+2,u[p++]=g+3,u[p++]=g+1;i&&(u[p++]=n.length-1,u[p++]=n.length-2,u[p++]=0,u[p++]=0,u[p++]=1,u[p++]=n.length-1),Ci(h,u,e.fixed,v.gfx.defTex,e.shader,e.uniform??void 0)}function $1(e){let t=e.pts,n=[],o=(e.width||1)*.5,i=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),s=e.pos||j(0,0),r;i?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-o/l),d,a=t[0];if(!i)switch(e.cap){case"square":{let g=r.scale(-o/l);n.push(a.add(g).add(c)),n.push(a.add(g).sub(c));break}case"round":{let g=Math.max(o,10),A=Math.PI/g,m=c.scale(-1),C=Math.cos(A),I=Math.sin(A);for(let R=0;R<g;R++)n.push(a),n.push(a.sub(m)),m=j(m.x*C-m.y*I,m.x*I+m.y*C)}}for(let g=1;g<t.length;g++){if(a===t[g]||a.eq(t[g]))continue;d=a,a=t[g];let A=a.sub(d),m=A.len(),C=A.normal().scale(-o/m),I=r.cross(A);if(Math.abs(I)/(l*m)<.05){n.push(d.add(c)),n.push(d.sub(c)),r.dot(A)<0&&(n.push(d.sub(c)),n.push(d.add(c))),r=A,l=m,c=C;continue}let R=C.sub(c).cross(A)/I,f=c.add(r.scale(R));n.push(d.add(f)),n.push(d.sub(f)),r=A,l=m,c=C}if(!i)switch(n.push(a.add(c)),n.push(a.sub(c)),e.cap){case"square":{let g=r.scale(o/l);n.push(a.add(g).add(c)),n.push(a.add(g).sub(c));break}case"round":{let g=Math.max(o,10),A=Math.PI/g,m=c.scale(1),C=Math.cos(A),I=Math.sin(A);for(let R=0;R<g;R++)m=j(m.x*C-m.y*I,m.x*I+m.y*C),n.push(a),n.push(a.sub(m))}}if(n.length<4)return;let h=n.map(g=>({pos:s.add(g),uv:j(),color:e.color||Mt.WHITE,opacity:e.opacity??1})),u=[],p=0;for(let g=0;g<n.length-2;g+=2)u[p++]=g+1,u[p++]=g,u[p++]=g+2,u[p++]=g+2,u[p++]=g+3,u[p++]=g+1;i&&(u[p++]=n.length-1,u[p++]=n.length-2,u[p++]=0,u[p++]=0,u[p++]=1,u[p++]=n.length-1),Ci(h,u,e.fixed,v.gfx.defTex,e.shader,e.uniform??void 0)}function Vd(e){let t=e.pts,n=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return V1(e);case"round":return W1(e);case"miter":return $1(e)}if(e.radius&&t.length>=3){ur(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let o=1;o<t.length-2;o++){let i=t[o],s=t[o+1];ur(Object.assign({},e,{p1:i,p2:s}))}ur(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let o=0;o<t.length-1;o++)ur(Object.assign({},e,{p1:t[o],p2:t[o+1]})),e.join!=="none"&&zs(Object.assign({},e,{pos:t[o],radius:n/2}))}}function g0(e,t){let n=t.segments??16,o=[];for(let i=0;i<=n;i++)o.push(e(i/n));Vd({pts:o,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function j1(e){g0(t=>Ud(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var ui=class m0{ctx;src=null;glTex;width;height;constructor(t,n,o,i={}){this.ctx=t;let s=t.gl,r=t.gl.createTexture();if(!r)throw new Error("Failed to create texture");this.glTex=r,t.onDestroy(()=>this.free()),this.width=n,this.height=o;let l={linear:s.LINEAR,nearest:s.NEAREST}[i.filter??t.opts.texFilter??"nearest"],c={repeat:s.REPEAT,clampToEdge:s.CLAMP_TO_EDGE}[i.wrap??"clampToEdge"];this.bind(),n&&o&&s.texImage2D(s.TEXTURE_2D,0,s.RGBA,n,o,0,s.RGBA,s.UNSIGNED_BYTE,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,l),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,l),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,c),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,c),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,n,o={}){let i=new m0(t,n.width,n.height,o);return i.update(n),i.src=n,i}update(t,n=0,o=0){let i=this.ctx.gl;this.bind(),i.texSubImage2D(i.TEXTURE_2D,0,n,o,i.RGBA,i.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},za=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,n,o={}){this.ctx=e;let i=e.gl;e.onDestroy(()=>this.free()),this.tex=new ui(e,t,n,o);let s=i.createFramebuffer(),r=i.createRenderbuffer();if(!s||!r)throw new Error("Failed to create framebuffer");this.glFramebuffer=s,this.glRenderbuffer=r,this.bind(),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t,n),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.tex.glTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let n=this.width*4,o=new Uint8Array(n);for(let i=0;i<(this.height/2|0);i++){let s=i*n,r=(this.height-i-1)*n;o.set(t.subarray(s,s+n)),t.copyWithin(s,r,r+n),t.set(o,r)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},J1=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,n,o){let i=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((r,l)=>r+l.size,0),this.maxVertices=n,this.maxIndices=o;let s=i.createBuffer();if(!s)throw new Error("Failed to create vertex buffer");this.glVBuf=s,e.pushArrayBuffer(this.glVBuf),i.bufferData(i.ARRAY_BUFFER,n*4,i.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=i.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),i.bufferData(i.ELEMENT_ARRAY_BUFFER,o*4,i.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,n,o,i=null,s={}){(e!==this.curPrimitive||i!==this.curTex||o!==this.curShader||!qd(this.curUniform,s)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+n.length>this.maxIndices)&&this.flush();let r=this.vqueue.length/this.stride;for(let l of t)this.vqueue.push(l);for(let l of n)this.iqueue.push(l+r);this.curPrimitive=e,this.curShader=o,this.curTex=i,this.curUniform=s}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Ri(e){let t=[],n=s=>{t.push(s),e(s)},o=()=>{t.pop(),e(i()??null)},i=()=>t[t.length-1];return[n,o,i]}function Q1(e,t={}){let n=[];function o(N){n.push(N)}function i(){n.forEach(b=>b());let N=e.getExtension("WEBGL_lose_context");N&&N.loseContext()}let s=null;function r(N){if(qd(N,s))return;s=N;let b=N.reduce((T,x)=>T+x.size,0);N.reduce((T,x,M)=>(e.vertexAttribPointer(M,x.size,e.FLOAT,!1,b*4,T),e.enableVertexAttribArray(M),T+x.size*4),0)}let[l,c]=Ri(N=>e.bindTexture(e.TEXTURE_2D,N)),[d,a]=Ri(N=>e.bindBuffer(e.ARRAY_BUFFER,N)),[h,u]=Ri(N=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,N)),[p,g]=Ri(N=>e.bindFramebuffer(e.FRAMEBUFFER,N)),[A,m]=Ri(N=>e.bindRenderbuffer(e.RENDERBUFFER,N)),[C,I]=Ri(N=>{if(!N)return;let{x:b,y:T,w:x,h:M}=N;e.viewport(b,T,x,M)}),[R,f]=Ri(N=>e.useProgram(N));return C({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:o,destroy:i,pushTexture2D:l,popTexture2D:c,pushArrayBuffer:d,popArrayBuffer:a,pushElementArrayBuffer:h,popElementArrayBuffer:u,pushFramebuffer:p,popFramebuffer:g,pushRenderbuffer:A,popRenderbuffer:m,pushViewport:C,popViewport:I,pushProgram:R,popProgram:f,setVertexFormat:r}}var Zl={};function Cu(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(j(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function Xc(e){let t={},n="",o=[],i=String(e),s=r=>{o.length>0&&(t[n.length]=o.slice()),n+=r};for(;i!=="";){if(i[0]==="\\"){if(i.length===1)throw new Error("Styled text error: \\ at end of string");s(i[1]),i=i.slice(2);continue}if(i[0]==="["){let r=/^\[(\/)?(\w+?)\]/.exec(i);if(!r){s(i[0]),i=i.slice(1);continue}let[l,c,d]=r;if(c!==void 0){let a=o.pop();if(a!==d)throw a!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${a}], got [/${d}]`):new Error(`Styled text error: stray end tag [/${d}]`)}else o.push(d);i=i.slice(l.length);continue}s(i[0]),i=i.slice(1)}if(o.length>0)throw new Error(`Styled text error: unclosed tags ${o}`);return{charStyleMap:t,text:n}}function Gi(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=l0(e.font);if(!e.text||e.text===""||t instanceof lo||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:n,text:o}=Xc(e.text+""),i=Fx(o);if(t instanceof Ta||typeof t=="string"){let R=t instanceof Ta?t.fontface.family:t,f=t instanceof Ta?{outline:t.outline,filter:t.filter}:{outline:null,filter:Oc},N=Zl[R]??{font:{tex:new ui(v.gfx.ggl,2048,2048,{filter:f.filter}),map:{},size:64},cursor:new ne(0),maxHeight:0,outline:f.outline};Zl[R]||(Zl[R]=N),t=N.font;for(let b of i)if(!N.font.map[b]){let T=v.fontCacheC2d;if(!T)throw new Error("fontCacheC2d is not defined.");if(!v.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");T.clearRect(0,0,v.fontCacheCanvas.width,v.fontCacheCanvas.height),T.font=`${t.size}px ${R}`,T.textBaseline="top",T.textAlign="left",T.fillStyle="#ffffff";let x=T.measureText(b),M=Math.ceil(x.width);if(!M)continue;let _=Math.ceil(Math.abs(x.actualBoundingBoxAscent))+Math.ceil(Math.abs(x.actualBoundingBoxDescent));N.outline&&N.outline.width&&N.outline.color&&(T.lineJoin="round",T.lineWidth=N.outline.width*2,T.strokeStyle=N.outline.color.toHex(),T.strokeText(b,N.outline.width,N.outline.width),M+=N.outline.width*2,_+=N.outline.width*3),T.fillText(b,N.outline?.width??0,N.outline?.width??0);let O=T.getImageData(0,0,M,_);if(N.cursor.x+M>2048&&(N.cursor.x=0,N.cursor.y+=N.maxHeight,N.maxHeight=0,N.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(O,N.cursor.x,N.cursor.y),t.map[b]=new cn(N.cursor.x,N.cursor.y,M,_),N.cursor.x+=M+1,N.maxHeight=Math.max(N.maxHeight,_)}}let s=e.size||t.size,r=j(e.scale??1).scale(s/t.size),l=e.lineSpacing??0,c=e.letterSpacing??0,d=0,a=0,h=0,u=[],p=[],g=0,A=null,m=0,C;for(;g<i.length;){let R=i[g];if(R===`
`)h+=s+l,u.push({width:d-c,chars:p}),A=null,m=0,d=0,p=[],C=void 0;else{let f=t.map[R];if(f){let N=f.w*r.x;e.width&&d+N>e.width&&(h+=s+l,A!=null&&(g-=p.length-A,R=i[g],f=t.map[R],N=f.w*r.x,p=p.slice(0,A-1),d=m),A=null,m=0,u.push({width:d-c,chars:p}),d=C??0,p=[]),p.push({tex:t.tex,width:f.w,height:f.h,quad:new cn(f.x/t.tex.width,f.y/t.tex.height,f.w/t.tex.width,f.h/t.tex.height),ch:R,pos:new ne(d,h),opacity:e.opacity??1,color:e.color??Mt.WHITE,scale:j(r),angle:0}),R===" "&&(A=p.length,m=d),e.indentAll&&C===void 0&&/\S/.test(R)&&(C=d),d+=N,a=Math.max(a,d),d+=c}}g++}u.push({width:d-c,chars:p}),h+=s,e.width&&(a=e.width);let I=[];for(let R=0;R<u.length;R++){let f=(a-u[R].width)*p1(e.align??"left");for(let N of u[R].chars){let b=t.map[N.ch],T=I.length+R;if(N.pos=N.pos.add(f,0).add(b.w*r.x*.5,b.h*r.y*.5),e.transform){let x=typeof e.transform=="function"?e.transform(T,N.ch):e.transform;x&&Cu(N,x)}if(n[T]){let x=n[T];for(let M of x){let _=e.styles?.[M],O=typeof _=="function"?_(T,N.ch):_;O&&Cu(N,O)}}I.push(N)}}return{width:a,height:h,chars:I,opt:e,renderedText:o}}function Pr(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,o=Hs(e.anchor||Sl).scale(new ne(t,n).scale(-.5)),i=e.quad||new cn(0,0,1,1),s=e.color||Kt(255,255,255),r=e.opacity??1,l=e.tex?.1/e.tex.width:0,c=e.tex?.1/e.tex.height:0,d=i.x+l,a=i.y+c,h=i.w-l*2,u=i.h-c*2;no(),hn(e.pos),_s(e.angle),Dr(e.scale),hn(o),Ci([{pos:new ne(-t/2,n/2),uv:new ne(e.flipX?d+h:d,e.flipY?a:a+u),color:s,opacity:r},{pos:new ne(-t/2,-n/2),uv:new ne(e.flipX?d+h:d,e.flipY?a+u:a),color:s,opacity:r},{pos:new ne(t/2,-n/2),uv:new ne(e.flipX?d:d+h,e.flipY?a+u:a),color:s,opacity:r},{pos:new ne(t/2,n/2),uv:new ne(e.flipX?d:d+h,e.flipY?a:a+u),color:s,opacity:r}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),$n()}function Ki(e){no(),hn(e.opt.pos),_s(e.opt.angle),hn(Hs(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{Pr({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),$n()}function io(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,o=Hs(e.anchor||Sl).add(1,1).scale(new ne(t,n).scale(-.5)),i=[new ne(0,0),new ne(t,0),new ne(t,n),new ne(0,n)];if(e.radius){let s=Math.min(t,n)/2,r=Array.isArray(e.radius)?e.radius.map(l=>Math.min(s,l)):new Array(4).fill(Math.min(s,e.radius));i=[new ne(r[0],0),...r[1]?dr(new ne(t-r[1],r[1]),r[1],r[1],270,360):[j(t,0)],...r[2]?dr(new ne(t-r[2],n-r[2]),r[2],r[2],0,90):[j(t,n)],...r[3]?dr(new ne(r[3],n-r[3]),r[3],r[3],90,180):[j(0,n)],...r[0]?dr(new ne(r[0],r[0]),r[0],r[0],180,270):[]]}hi(Object.assign({},e,{offset:o,pts:i,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function ai(e){oo();let t=v.gfx.width,n=v.gfx.height;v.gfx.width=v.gfx.viewport.width,v.gfx.height=v.gfx.viewport.height,e(),oo(),v.gfx.width=t,v.gfx.height=n}function _u(e,t){ai(()=>{let n=j(8);no(),hn(e);let o=Gi({text:t,font:Ba,size:16,pos:n,color:Kt(255,255,255),fixed:!0}),i=o.width+n.x*2,s=o.height+n.x*2;e.x+i>=In()&&hn(j(-i,0)),e.y+s>=On()&&hn(j(0,-s)),io({width:i,height:s,color:Kt(0,0,0),radius:4,opacity:.8,fixed:!0}),Ki(o),$n()})}function y0(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return hi(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Z1(){if(v.debug.inspect){let e=null;for(let t of v.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(v.game.root.drawInspect(),e){let t=[],n=e.inspect();for(let o in n)n[o]?t.push(`${n[o]}`):t.push(`${o}`);_u(Zx(v.k.mousePos()),t.join(`
`))}_u(j(8),`FPS: ${v.debug.fps()}`)}v.debug.paused&&ai(()=>{no(),hn(In(),0),hn(-8,8);let e=32;io({width:e,height:e,anchor:"topright",color:Kt(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)io({width:4,height:e*.6,anchor:"center",pos:j(-e/3*t,e*.5),color:Kt(255,255,255),radius:2,fixed:!0});$n()}),v.debug.timeScale!==1&&ai(()=>{no(),hn(In(),On()),hn(-8,-8);let e=8,t=Gi({text:v.debug.timeScale.toFixed(1),font:Ba,size:16,color:Kt(255,255,255),pos:j(-e),anchor:"botright",fixed:!0});io({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Kt(0,0,0),opacity:.8,radius:4,fixed:!0});for(let n=0;n<2;n++){let o=v.debug.timeScale<1;y0({p1:j(-t.width-e*(o?2:3.5),-e),p2:j(-t.width-e*(o?2:3.5),-e-t.height),p3:j(-t.width-e*(o?3.5:2),-e-t.height/2),pos:j(-n*e*1+(o?-e*.5:0),0),color:Kt(255,255,255),fixed:!0})}Ki(t),$n()}),v.debug.curRecording&&ai(()=>{no(),hn(0,On()),hn(24,-24),zs({radius:12,color:Kt(255,0,0),opacity:Ip(0,1,v.app.time()*4),fixed:!0}),$n()}),v.debug.showLog&&v.game.logs.length>0&&ai(()=>{no(),hn(0,On()),hn(8,-8);let e=8,t=[];for(let o of v.game.logs){let i="",s=o.msg instanceof Error?"error":"info";i+=`[time]${o.time.toFixed(2)}[/time]`,i+=" ",i+=`[${s}]${qc(o.msg)}[/${s}]`,t.push(i)}v.game.logs=v.game.logs.filter(o=>v.app.time()-o.time<(v.globalOpt.logTime||4));let n=Gi({text:t.join(`
`),font:Ba,pos:j(e,-e),anchor:"botleft",size:16,width:In()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Kt(127,127,127)},info:{color:Kt(255,255,255)},error:{color:Kt(255,0,127)}}});io({width:n.width+e*2,height:n.height+e*2,anchor:"botleft",color:Kt(0,0,0),radius:4,opacity:.8,fixed:!0}),Ki(n),$n()})}function qc(e,t=!1,n=new Set){if(n.has(e))return"<recursive>";var o="",i;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(o=["[",e.map(s=>qc(s,!0,n.union(new Set([e])))).join(", "),"]"].join(""),e=o),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(o+=e.constructor.name+" "),o+=["{",(i=Object.getOwnPropertyNames(e).map(s=>`${/^\w+$/.test(s)?s:JSON.stringify(s)}: ${qc(e[s],!0,n.union(new Set([e])))}`).join(", "))?` ${i} `:"","}"].join(""),e=o),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function k1(){let e=v.game.cam,t=ne.fromAngle(An(0,360)).scale(e.shake);e.shake=Jn(e.shake,0,5*Tn()),e.transform=new Oo().translate(Ha()).scale(e.scale).rotate(e.angle).translate((e.pos??Ha()).scale(-1).add(t)),v.game.root.draw(),oo()}function ev(){let e=Yi();v.game.events.numListeners("loading")>0?v.game.events.trigger("loading",e):ai(()=>{let t=In()/2,n=24,o=j(In()/2,On()/2).sub(j(t/2,n/2));io({pos:j(0),width:In(),height:On(),color:Kt(0,0,0)}),io({pos:o,width:t,height:n,fill:!1,outline:{width:4}}),io({pos:o,width:t*e,height:n})})}function x0(e,t,n){let o=v.gfx.ggl.gl;oo(),o.clear(o.STENCIL_BUFFER_BIT),o.enable(o.STENCIL_TEST),o.stencilFunc(o.NEVER,1,255),o.stencilOp(o.REPLACE,o.REPLACE,o.REPLACE),t(),oo(),o.stencilFunc(n,1,255),o.stencilOp(o.KEEP,o.KEEP,o.KEEP),e(),oo(),o.disable(o.STENCIL_TEST)}function tv(e,t){let n=v.gfx.ggl.gl;x0(e,t,n.EQUAL)}function Ua(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new cn(0,0,1,1),n=e.tex.width*t.w,o=e.tex.height*t.h,i=new ne(1);if(e.tiled){let s=Hs(e.anchor||Sl);(e.pos?.x||0)-(s.x+1)*.5*(e.width||n),(e.pos?.y||0)-(s.y+1)*.5*(e.height||o);let r=(e.width||n)/n,l=(e.height||o)/o,c=Math.floor(r),d=Math.floor(l),a=r-c,h=l-d,u=(c+a?1:0)*(d+h?1:0),p=new Array(u*6),g=new Array(u*4),A=0,m=(C,I,R,f,N)=>{p[A*6+0]=A*4+0,p[A*6+1]=A*4+1,p[A*6+2]=A*4+3,p[A*6+3]=A*4+1,p[A*6+4]=A*4+2,p[A*6+5]=A*4+3,g[A*4+0]={pos:new ne(C-s.x,I-s.y),uv:new ne(N.x,N.y),color:e.color||Mt.WHITE,opacity:e.opacity||1},g[A*4+1]={pos:new ne(C+R-s.x,I-s.y),uv:new ne(N.x+N.w,N.y),color:e.color||Mt.WHITE,opacity:e.opacity||1},g[A*4+2]={pos:new ne(C+R-s.x,I+f-s.y),uv:new ne(N.x+N.w,N.y+N.h),color:e.color||Mt.WHITE,opacity:e.opacity||1},g[A*4+3]={pos:new ne(C-s.x,I+f-s.y),uv:new ne(N.x,N.y+N.h),color:e.color||Mt.WHITE,opacity:e.opacity||1},A++};for(let C=0;C<d;C++){for(let I=0;I<c;I++)m(I*n,C*o,n,o,t);a&&m(c*n,C*o,n*a,o,new cn(t.x,t.y,t.w*a,t.h))}if(h){for(let C=0;C<c;C++)m(C*n,d*o,n,o*h,new cn(t.x,t.y,t.w,t.h*h));a&&m(c*n,d*o,n*a,o*h,new cn(t.x,t.y,t.w*a,t.h*h))}Ci(g,p,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(i.x=e.width/n,i.y=e.height/o):e.width?(i.x=e.width/n,i.y=i.x):e.height&&(i.y=e.height/o,i.x=i.y),Pr(Object.assign({},e,{scale:i.scale(e.scale||new ne(1)),tex:e.tex,quad:t,width:n,height:o}))}function nv(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Aa(e.sprite);if(!t||!t.data)return;let n=t.data.frames[e.frame??0];if(!n)throw new Error(`Frame not found: ${e.frame??0}`);Ua(Object.assign({},e,{tex:t.data.tex,quad:n.scale(e.quad??new cn(0,0,1,1))}))}function ov(e,t){let n=v.gfx.ggl.gl;x0(e,t,n.NOTEQUAL)}function Au(e){Ki(Gi(e))}var iv=(e,t)=>{let n=Kd(t,Nc,Bc),o=e.pixelDensity??1,i=e.scale??1,{gl:s}=t,r=ui.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new za(t,e.width*o*i,e.height*o*i):new za(t,s.drawingBufferWidth,s.drawingBufferHeight),c=null,d=1;e.background&&(typeof e.background=="string"?c=Kt(e.background):(c=Kt(...e.background),d=e.background[3]??1),s.clearColor(c.r/255,c.g/255,c.b/255,d??1)),s.enable(s.BLEND),s.blendFuncSeparate(s.ONE,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA);let a=new J1(t,Fd,Ex,Sx),h=ui.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:n,defTex:r,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:a,transform:new Oo,transformStack:[],bgTex:h,bgColor:c,bgAlpha:d,width:e.width??s.drawingBufferWidth/o/i,height:e.height??s.drawingBufferHeight/o/i,viewport:{x:0,y:0,width:s.drawingBufferWidth,height:s.drawingBufferHeight,scale:1},fixed:!1}};function Hi(e){return e.fixed?!0:e.parent?Hi(e.parent):!1}function Vi(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function sv(e,t={}){return{id:"circle",radius:e,draw(){zs(Object.assign(Vi(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new nn(new ne(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function v0(...e){return{id:"color",color:Kt(...e),inspect(){return`color: ${this.color.toString()}`}}}function rv(e){return{add(){this.canvas=e}}}function av(e=1){let t,n=0,o=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){o||(n+=Tn(),this.opacity=Ro(n,0,e,0,t),n>=e&&(this.opacity=t,o=!0))}}}function lv(e="intersect"){return{id:"mask",mask:e}}function w0(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,n=v.k.easings.linear){return v.game.root.tween(0,this.opacity,t,o=>this.opacity=o,n)},fadeOut(t=1,n=v.k.easings.linear){return v.game.root.tween(this.opacity,0,t,o=>this.opacity=o,n)},inspect(){return`opacity: ${Hc(this.opacity,1)}`}}}function cv(e=1,t=Kt(0,0,0),n=1,o="miter",i=10,s="butt"){return{id:"outline",outline:{width:e,color:t,opacity:n,join:o,miterLimit:i,cap:s},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var dv=class{pos=j(0);vel=j(0);acc=j(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function hv(e,t){let n=t.lifetime,o=[],i=e.colors||[Mt.WHITE],s=e.opacities||[1],r=e.quads||[new cn(0,0,1,1)],l=e.scales||[1],c=e.lifeTime,d=t.direction,a=t.spread,h=e.speed||[0,0],u=e.angle||[0,0],p=e.angularVelocity||[0,0],g=e.acceleration||[j(0),j(0)],A=e.damping||[0,0],m=[],C=new Array(e.max),I=0,R=0;for(let b=0;b<e.max;b++){m[b*6+0]=b*4+0,m[b*6+1]=b*4+1,m[b*6+2]=b*4+3,m[b*6+3]=b*4+1,m[b*6+4]=b*4+2,m[b*6+5]=b*4+3;for(let T=0;T<4;T++)C[b*4+T]={pos:new ne(0,0),uv:new ne(0,0),color:Kt(255,255,255),opacity:1};o[b]=new dv}let f=new Fn;function N(b=0){for(;b<e.max;){if(o[b].gc)return b;b++}return null}return{id:"particles",emit(b){let T=0;for(let x=0;x<b;x++){if(T=N(T),T==null)return;let M=An(d-a,d+a),_=ne.fromAngle(M).scale(An(h[0],h[1])),O=An(u[0],u[1]),P=An(p[0],p[1]),z=j(An(g[0].x,g[1].x),An(g[0].y,g[1].y)),U=An(A[0],A[1]),F=c?An(c[0],c[1]):null,B=t.shape?t.shape.random():j(),D=o[T];D.lt=F,D.pos=B,D.vel=_,D.acc=z,D.angle=O,D.angularVelocity=P,D.damping=U,D.angularVelocity=P,D.gc=!1}I+=b},update(){if(n!==void 0&&n<=0)return;let b=Tn();for(let T of o)if(!T.gc){if(T.t+=b,T.lt&&T.t>=T.lt){T.gc=!0,I--;continue}T.vel=T.vel.add(T.acc.scale(b)).scale(1-T.damping*b),T.pos=T.pos.add(T.vel.scale(b)),T.angle+=T.angularVelocity*b}for(n!==void 0&&(n-=b,n<=0&&f.trigger()),R+=b;I<e.max&&t.rate&&R>t.rate;)this.emit(1),I++,R-=t.rate},draw(){if(!(n!==void 0&&n<=0)){for(let b=0;b<o.length;b++){let T=o[b];if(T.gc)continue;let x=T.progress,M=Math.floor(T.progress*i.length),_=M<i.length-1?Jn(i[M],i[M+1],Ro(x,M/i.length,(M+1)/i.length,0,1)):i[M],O=Math.floor(T.progress*s.length),P=O<s.length-1?Jn(s[O],s[O+1],Ro(x,O/s.length,(O+1)/s.length,0,1)):s[O],z=Math.floor(T.progress*r.length),U=r[z],F=Math.floor(T.progress*l.length),B=l[F],D=Math.cos(T.angle*Math.PI/180),q=Math.sin(T.angle*Math.PI/180),G=(e.texture?e.texture.width:10)*U.w/2,Z=(e.texture?e.texture.height:10)*U.h/2,le=b*4,ie=C[le];ie.pos.x=T.pos.x+-G*B*D- -Z*B*q,ie.pos.y=T.pos.y+-G*B*q+-Z*B*D,ie.uv.x=U.x,ie.uv.y=U.y,ie.color.r=_.r,ie.color.g=_.g,ie.color.b=_.b,ie.opacity=P,ie=C[le+1],ie.pos.x=T.pos.x+G*B*D- -Z*B*q,ie.pos.y=T.pos.y+G*B*q+-Z*B*D,ie.uv.x=U.x+U.w,ie.uv.y=U.y,ie.color.r=_.r,ie.color.g=_.g,ie.color.b=_.b,ie.opacity=P,ie=C[le+2],ie.pos.x=T.pos.x+G*B*D-Z*B*q,ie.pos.y=T.pos.y+G*B*q+Z*B*D,ie.uv.x=U.x+U.w,ie.uv.y=U.y+U.h,ie.color.r=_.r,ie.color.g=_.g,ie.color.b=_.b,ie.opacity=P,ie=C[le+3],ie.pos.x=T.pos.x+-G*B*D-Z*B*q,ie.pos.y=T.pos.y+-G*B*q+Z*B*D,ie.uv.x=U.x,ie.uv.y=U.y+U.h,ie.color.r=_.r,ie.color.g=_.g,ie.color.b=_.b,ie.opacity=P}Ci(C,m,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(b){return f.add(b)},inspect(){return`count: ${I}/${e.max}`}}}function uv(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){hi(Object.assign(Vi(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new Kn(this.pts)},inspect(){return`polygon: ${this.pts.map(n=>`[${n.x},${n.y}]`).join(",")}`}}}function b0(e,t,n){let o;return v.game.root.get("area").forEach(i=>{if(n&&n.some(r=>i.is(r)))return;let s=i.worldArea().raycast(e,t);s&&(o?s.fraction<o.fraction&&(o=s,o.object=i):(o=s,o.object=i))}),o}function E0(e,t,n={}){return{id:"rect",width:e,height:t,radius:n.radius||0,draw(){io(Object.assign(Vi(this),{width:this.width,height:this.height,radius:this.radius,fill:n.fill}))},renderArea(){return new nn(j(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function fv(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function pv(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let n=v.game.root.add([Fa(t.pos??j(0))]),o=e.length,i=0,s=null,r=null,l=null,c=null,d=b=>b.x+b.y*i,a=b=>j(Math.floor(b%i),Math.floor(b/i)),h=()=>{s=[];for(let b of n.children)u(b)},u=b=>{let T=d(b.tilePos);s[T]?s[T].push(b):s[T]=[b]},p=b=>{let T=d(b.tilePos);if(s[T]){let x=s[T].indexOf(b);x>=0&&s[T].splice(x,1)}},g=()=>{let b=!1;for(let T of n.children){let x=n.pos2Tile(T.pos);(T.tilePos.x!=x.x||T.tilePos.y!=x.y)&&(b=!0,p(T),T.tilePos.x=x.x,T.tilePos.y=x.y,u(T))}b&&n.trigger("spatialMapChanged")},A=()=>{let b=n.getSpatialMap(),T=n.numRows()*n.numColumns();r?r.length=T:r=new Array(T),r.fill(1,0,T);for(let x=0;x<b.length;x++){let M=b[x];if(M){let _=0;for(let O of M)if(O.isObstacle){_=1/0;break}else _+=O.cost;r[x]=_||1}}},m=()=>{let b=n.getSpatialMap(),T=n.numRows()*n.numColumns();l?l.length=T:l=new Array(T),l.fill(15,0,T);for(let x=0;x<b.length;x++){let M=b[x];if(M){let _=M.length,O=15;for(let P=0;P<_;P++)O|=M[P].edgeMask;l[x]=O}}},C=()=>{let b=n.numRows()*n.numColumns(),T=(M,_)=>{let O=[];for(O.push(M);O.length>0;){let P=O.pop();f(P).forEach(z=>{c[z]<0&&(c[z]=_,O.push(z))})}};c?c.length=b:c=new Array(b),c.fill(-1,0,b);let x=0;for(let M=0;M<r.length;M++){if(c[M]>=0){x++;continue}T(M,x),x++}},I=(b,T)=>r[T],R=(b,T)=>{let x=a(b),M=a(T);return x.dist(M)},f=(b,T)=>{let x=[],M=Math.floor(b%i),_=M>0&&l[b]&1&&r[b-1]!==1/0,O=b>=i&&l[b]&2&&r[b-i]!==1/0,P=M<i-1&&l[b]&4&&r[b+1]!==1/0,z=b<i*o-i-1&&l[b]&8&&r[b+i]!==1/0;return T?(_&&(O&&x.push(b-i-1),x.push(b-1),z&&x.push(b+i-1)),O&&x.push(b-i),P&&(O&&x.push(b-i+1),x.push(b+1),z&&x.push(b+i+1)),z&&x.push(b+i)):(_&&x.push(b-1),O&&x.push(b-i),P&&x.push(b+1),z&&x.push(b+i)),x},N={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(b,...T){let x=j(...T),M=(()=>{if(typeof b=="string"){if(t.tiles[b]){if(typeof t.tiles[b]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[b](x)}else if(t.wildcardTile)return t.wildcardTile(b,x)}else{if(Array.isArray(b))return b;throw new Error("Expected a symbol or a component list")}})();if(!M)return null;let _=!1,O=!1;for(let z of M)z.id==="tile"&&(O=!0),z.id==="pos"&&(_=!0);_||M.push(Fa(this.tile2Pos(x))),O||M.push(F0());let P=n.add(M);return _&&(P.tilePosOffset=P.pos.clone()),P.tilePos=x,P.transform=xr(P),s&&(u(P),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),P},numColumns(){return i},numRows(){return o},levelWidth(){return i*this.tileWidth()},levelHeight(){return o*this.tileHeight()},tile2Pos(...b){return j(...b).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...b){let T=j(...b);return j(Math.floor(T.x/this.tileWidth()),Math.floor(T.y/this.tileHeight()))},getSpatialMap(){return s||h(),s},removeFromSpatialMap:p,insertIntoSpatialMap:u,onSpatialMapChanged(b){return this.on("spatialMapChanged",b)},onNavigationMapInvalid(b){return this.on("navigationMapInvalid",b)},getAt(b){s||h();let T=d(b);return s[T]||[]},raycast(b,T){let x=this.toWorld(b),M=this.toWorld(b.add(T)).sub(x),_=1/this.tileWidth(),O=b.scale(_),P=jy(O,T,z=>{let U=this.getAt(z);if(U.some(B=>B.isObstacle))return!0;let F=null;for(let B of U)if(B.has("area")){let D=B.worldArea().raycast(x,M);D&&(F?D.fraction<F.fraction&&(F=D,F.object=B):(F=D,F.object=B))}return F&&(F.point=this.fromWorld(F.point).scale(_)),F||!1},64);return P&&(P.point=P.point.scale(this.tileWidth())),P},update(){s&&g()},invalidateNavigationMap(){r=null,l=null,c=null},onNavigationMapChanged(b){return this.on("navigationMapChanged",b)},getTilePath(b,T,x={}){if(r||A(),l||m(),c||C(),b.x<0||b.x>=i||b.y<0||b.y>=o||T.x<0||T.x>=i||T.y<0||T.y>=o)return null;let M=d(b),_=d(T);if(r[_]===1/0)return null;if(M===_)return[];if(c[M]!=-1&&c[M]!==c[_])return null;let O=new kp((D,q)=>D.cost<q.cost);O.insert({cost:0,node:M});let P=new Map;P.set(M,M);let z=new Map;for(z.set(M,0);O.length!==0;){let D=O.remove()?.node;if(D===_)break;let q=f(D,x.allowDiagonals);for(let G of q){let Z=(z.get(D)||0)+I(D,G)+R(G,_);(!z.has(G)||Z<z.get(G))&&(z.set(G,Z),O.insert({cost:Z,node:G}),P.set(G,D))}}let U=[],F=_,B=a(F);for(U.push(B);F!==M;){let D=P.get(F);if(D===void 0)throw new Error("Bug in pathfinding algorithm");F=D;let q=a(F);U.push(q)}return U.reverse()},getPath(b,T,x={}){let M=this.tileWidth(),_=this.tileHeight(),O=this.getTilePath(this.pos2Tile(b),this.pos2Tile(T),x);return O?[b,...O.slice(1,-1).map(P=>P.scale(M,_).add(M/2,_/2)),T]:null}};return n.use(N),n.onNavigationMapInvalid(()=>{n.invalidateNavigationMap(),n.trigger("navigationMapChanged")}),e.forEach((b,T)=>{let x=b.split("");i=Math.max(x.length,i),x.forEach((M,_)=>{n.spawn(M,j(_,T))})}),n}function eo(e,t,n){return v.game.objEvents.registers[e]||(v.game.objEvents.registers[e]=new Qp),v.game.objEvents.on(e,(o,...i)=>{o.is(t)&&n(o,...i)})}var gv=(e,t,...n)=>{for(let o of v.game.root.children)o.is(t)&&o.trigger(e,n)},mv=sn(e=>{let t=v.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(n){t.paused=n},cancel:()=>t.destroy()}},(e,t)=>eo("fixedUpdate",e,t)),S0=sn(e=>{let t=v.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(n){t.paused=n},cancel:()=>t.destroy()}},(e,t)=>eo("update",e,t)),yv=sn(e=>{let t=v.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(n){t.hidden=n},cancel:()=>t.destroy()}},(e,t)=>eo("draw",e,t)),C0=sn(e=>v.game.events.on("add",e),(e,t)=>eo("add",e,t)),xv=sn(e=>v.game.events.on("destroy",e),(e,t)=>eo("destroy",e,t)),vv=sn(e=>v.game.events.on("use",e),(e,t)=>eo("use",e,t)),wv=sn(e=>v.game.events.on("unuse",e),(e,t)=>eo("unuse",e,t)),_0=sn(e=>v.game.events.on("tag",e),(e,t)=>eo("tag",e,t)),bv=sn(e=>v.game.events.on("untag",e),(e,t)=>eo("untag",e,t));function Ev(e,t,n){return eo("collide",e,(o,i,s)=>i.is(t)&&n(o,i,s))}function Sv(e,t,n){return eo("collideUpdate",e,(o,i,s)=>i.is(t)&&n(o,i,s))}function Cv(e,t,n){return eo("collideEnd",e,(o,i,s)=>i.is(t)&&n(o,i,s))}function Al(e,t){v.game.root.get(e,{recursive:!0}).forEach(t),C0(e,t),_0((n,o)=>{o===e&&t(n)})}var _v=sn(e=>v.app.onMousePress(e),(e,t)=>{let n=[];return Al(e,o=>{if(!o.area)throw new Error("onClick() requires the object to have area() component");n.push(o.onClick(()=>t(o)))}),ts.join(n)});function Av(e,t){let n=[];return Al(e,o=>{if(!o.area)throw new Error("onHover() requires the object to have area() component");n.push(o.onHover(()=>t(o)))}),ts.join(n)}function Tv(e,t){let n=[];return Al(e,o=>{if(!o.area)throw new Error("onHoverUpdate() requires the object to have area() component");n.push(o.onHoverUpdate(()=>t(o)))}),ts.join(n)}function Mv(e,t){let n=[];return Al(e,o=>{if(!o.area)throw new Error("onHoverEnd() requires the object to have area() component");n.push(o.onHoverEnd(()=>t(o)))}),ts.join(n)}function Rv(e){v.game.events.on("loading",e)}function Dv(e){v.app.onResize(e)}function Iv(e){v.game.events.on("error",e)}function Wd(e){v.assets.loaded?e():v.game.events.on("load",e)}function Pv(e){if(v.assets.loaded)s0().forEach(t=>e(...t));else return v.game.events.on("loadError",e)}function A0(...e){v.game.cam.pos=j(...e)}function T0(){return v.game.cam.pos?v.game.cam.pos.clone():Ha()}function M0(...e){v.game.cam.scale=j(...e)}function R0(){return v.game.cam.scale.clone()}function D0(e){v.game.cam.angle=e}function I0(){return v.game.cam.angle}function Lv(){return v.game.cam.transform.clone()}function P0(e=Kt(255,255,255),t=1){let n=v.game.root.add([E0(In(),On()),v0(e),w0(1),Y0()]),o=n.fadeOut(t);return o.onEnd(()=>U0(n)),o}function Ov(){return v.game.cam.transform.clone()}function Nv(e=12){v.game.cam.shake+=e}function Yc(e){return v.game.cam.transform.multVec2(e)}function L0(e){return v.game.cam.transform.invert().multVec2(e)}function Bv(...e){return Bs("camPos","setCamPos / getCamPos"),e.length>0&&A0(...e),T0()}function Hv(...e){return Bs("camScale","setCamScale / getCamScale"),e.length>0&&M0(...e),R0()}function zv(e){return Bs("camRot","setCamRot / getCamRot"),e!==void 0&&D0(e),I0()}function Uv(e=Kt(255,255,255),t=1){return Bs("camFlash","flash"),P0(e,t)}function $d(e=[]){let t=new Map,n=[],o={},i=new Mr,s=[],r=new Set("*"),l=v.globalOpt.tagsAsComponents,c=null,d=!1,a={id:Jx(),hidden:!1,transform:new Oo,children:[],parent:null,set paused(u){if(u!==d){d=u;for(let p of s)p.paused=u}},get paused(){return d},get tags(){return Array.from(r)},add(u){let p=Array.isArray(u)?$d(u):u;if(p.parent)throw new Error("Cannot add a game obj that already has a parent.");return p.parent=this,p.transform=xr(p),this.children.push(p),p.trigger("add",p),v.game.events.trigger("add",p),p},readd(u){let p=this.children.indexOf(u);return p!==-1&&(this.children.splice(p,1),this.children.push(u)),u},remove(u){let p=this.children.indexOf(u);if(p!==-1){u.parent=null,this.children.splice(p,1);let g=A=>{A.trigger("destroy"),v.game.events.trigger("destroy",A),A.children.forEach(m=>g(m))};g(u)}},removeAll(u){if(u)this.get(u).forEach(p=>this.remove(p));else for(let p of[...this.children])this.remove(p)},fixedUpdate(){this.paused||(this.children.forEach(u=>u.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(u=>u.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(oo(),this.canvas.bind());let u=v.gfx.fixed;this.fixed&&(v.gfx.fixed=!0),no(),hn(this.pos),Dr(this.scale),_s(this.angle);let p=this.children.sort((g,A)=>{let m=g.layerIndex??v.game.defaultLayerIndex,C=A.layerIndex??v.game.defaultLayerIndex;return m-C||(g.z??0)-(A.z??0)});if(this.mask){let g={intersect:v.k.drawMasked,subtract:v.k.drawSubtracted}[this.mask];if(!g)throw new Error(`Invalid mask func: "${this.mask}"`);g(()=>{p.forEach(A=>A.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),p.forEach(g=>g.draw());$n(),v.gfx.fixed=u,this.canvas&&(oo(),this.canvas.unbind())},drawInspect(){this.hidden||(no(),hn(this.pos),Dr(this.scale),_s(this.angle),this.children.forEach(u=>u.drawInspect()),this.trigger("drawInspect"),$n())},use(u){if(typeof u=="string")return r.add(u);if(!u||typeof u!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof u}"`);let p=[];u.id?(this.unuse(u.id),o[u.id]=[],p=o[u.id],t.set(u.id,u),l&&r.add(u.id)):n.push(u);for(let A in u){if(Ax.has(A))continue;let m=Object.getOwnPropertyDescriptor(u,A);if(m)if(typeof m.value=="function"&&(u[A]=u[A].bind(this)),m.set&&Object.defineProperty(u,A,{set:m.set.bind(this)}),m.get&&Object.defineProperty(u,A,{get:m.get.bind(this)}),Tx.has(A)){let C=A==="add"?()=>{c=I=>p.push(I),u[A]?.(),c=null}:u[A];p.push(this.on(A,C).cancel)}else if(this[A]===void 0)Object.defineProperty(this,A,{get:()=>u[A],set:C=>u[A]=C,configurable:!0,enumerable:!0}),p.push(()=>delete this[A]);else{let C=t.values().find(I=>I[A]!==void 0)?.id;throw new Error(`Duplicate component property: "${A}" while adding component "${u.id}"`+(C?` (originally added by "${C}")`:""))}}let g=()=>{if(u.require){for(let A of u.require)if(!this.c(A))throw new Error(`Component "${u.id}" requires component "${A}"`)}};u.destroy&&p.push(u.destroy.bind(this)),this.exists()?(g(),u.add&&(c=A=>p.push(A),u.add.call(this),c=null),u.id&&(this.trigger("use",u.id),v.game.events.trigger("use",this,u.id))):u.require&&p.push(this.on("add",g).cancel)},unuse(u){if(t.has(u)){for(let p of t.values())if(p.require&&p.require.includes(u))throw new Error(`Can't unuse. Component "${p.id}" requires component "${u}"`);t.delete(u),this.trigger("unuse",u),v.game.events.trigger("unuse",this,u)}else l&&r.has(u)&&r.delete(u);o[u]&&(o[u].forEach(p=>p()),delete o[u])},c(u){return t.get(u)??null},get(u,p={}){let g=(m,C)=>p.only==="comps"?m.has(C):p.only==="tags"?m.is(C):m.is(C)||m.has(C),A=p.recursive?this.children.flatMap(function m(C){return[C,...C.children.flatMap(m)]}):this.children;if(A=A.filter(m=>u?g(m,u):!0),p.liveUpdate){let m=I=>p.recursive?this.isAncestorOf(I):I.parent===this,C=[];C.push(v.k.onAdd(I=>{m(I)&&g(I,u)&&A.push(I)})),C.push(v.k.onDestroy(I=>{if(m(I)&&g(I,u)){let R=A.findIndex(f=>f.id===I.id);R!==-1&&A.splice(R,1)}})),this.onDestroy(()=>{for(let I of C)I.cancel()})}return A},query(u){let p=u.hierarchy||"children",g=u.include,A=u.exclude,m=[];switch(p){case"children":m=this.children;break;case"siblings":m=this.parent?this.parent.children.filter(I=>I!==this):[];break;case"ancestors":let C=this.parent;for(;C;)m.push(C),C=C.parent;break;case"descendants":m=this.children.flatMap(function I(R){return[R,...R.children.flatMap(I)]});break}if(g&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(C=>C.is(g)):m=m.filter(C=>u.include.some(I=>C.is(I)))),A&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(C=>!C.is(A)):m=m.filter(C=>!u.exclude.some(I=>C.is(I)))),u.visible===!0&&(m=m.filter(C=>C.visible)),u.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let C=u.distanceOp||"near",I=u.distance*u.distance;C==="near"?m=m.filter(R=>R.pos&&this.pos.sdist(R.pos)<=I):m=m.filter(R=>R.pos&&this.pos.sdist(R.pos)>I)}return u.name&&(m=m.filter(C=>C.name===u.name)),m},isAncestorOf(u){return u.parent?u.parent===this||this.isAncestorOf(u.parent):!1},exists(){return v.game.root.isAncestorOf(this)},is(u,p="and"){return Array.isArray(u)?p==="and"?u.every(g=>r.has(g)):u.some(g=>r.has(g)):r.has(u)},tag(u){if(Array.isArray(u))for(let p of u)r.add(p),this.trigger("tag",p),v.game.events.trigger("tag",this,p);else r.add(u),this.trigger("tag",u),v.game.events.trigger("tag",this,u)},untag(u){if(Array.isArray(u))for(let p of u)r.delete(p),this.trigger("untag",p),v.game.events.trigger("untag",this,p);else r.delete(u),this.trigger("untag",u),v.game.events.trigger("untag",this,u)},has(u,p="and"){return Array.isArray(u)?p==="and"?u.every(g=>t.has(g)):u.some(g=>t.has(g)):t.has(u)},on(u,p){let g=i.on(u,p.bind(this));return c&&c(()=>g.cancel()),g},trigger(u,...p){i.trigger(u,...p),v.game.objEvents.trigger(u,this,...p)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let u={};for(let[p,g]of t)u[p]=g.inspect?.()??null;for(let[p,g]of n.entries()){if(g.inspect){u[p]=g.inspect();continue}for(let[A,m]of Object.entries(g))typeof m!="function"&&(u[A]=`${A}: ${m}`)}return u},onAdd(u){return this.on("add",u)},onFixedUpdate(u){return this.on("fixedUpdate",u)},onUpdate(u){return this.on("update",u)},onDraw(u){return this.on("draw",u)},onDestroy(u){return this.on("destroy",u)},onUse(u){return this.on("use",u)},onUnuse(u){return this.on("unuse",u)},clearEvents(){i.clear()}},h=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let u of h)a[u]=(...p)=>{let g=v.app[u]?.(...p);return s.push(g),a.onDestroy(()=>g.cancel()),a.on("sceneEnter",()=>{s.splice(s.indexOf(g),1);let A=v.app[u]?.(...p);ts.replace(g,A),s.push(g)}),g};for(let u of e)a.use(u);return a}var Fv=()=>({events:new Mr,objEvents:new Mr,root:$d([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new ne(1),angle:0,shake:0,transform:new Oo}});function Xv(e){v.game.gravity=e?(v.game.gravity||j(0,1)).unit().scale(e):null}function qv(){return v.game.gravity?v.game.gravity.len():0}function Yv(e){v.game.gravity=e.unit().scale(v.game.gravity?v.game.gravity.len():1)}function wr(){return v.game.gravity?v.game.gravity.unit():j(0,1)}var Gv=Ay("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Kv=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let n=new Ir(g1(e));return e.decodeAudioData(Gv.buffer.slice(0)).then(o=>{n.buf=o}).catch(o=>{console.error("Failed to load burp: ",o)}),{ctx:e,masterNode:t,burpSnd:n}})();function Vv(e,t={}){let n=new Fn,o=new Audio(e);o.crossOrigin="anonymous",o.loop=!!t.loop,v.audio.ctx.createMediaElementSource(o).connect(v.audio.masterNode);function i(){v.debug.paused||v.app.isHidden()&&!v.globalOpt.backgroundAudio||v.audio.ctx.resume()}function s(){i(),o.play()}return t.paused||s(),o.onended=()=>n.trigger(),{play(){s()},seek(r){o.currentTime=r},stop(){o.pause(),this.seek(0)},set loop(r){o.loop=r},get loop(){return o.loop},set paused(r){r?o.pause():s()},get paused(){return o.paused},time(){return o.currentTime},duration(){return o.duration},set volume(r){o.volume=Lo(r,0,1)},get volume(){return o.volume},set speed(r){o.playbackRate=Math.max(r,0)},get speed(){return o.playbackRate},set detune(r){},get detune(){return 0},onEnd(r){return n.add(r)},then(r){return this.onEnd(r)}}}function Wv(e,t={}){if(typeof e=="string"&&v.assets.music[e])return Vv(v.assets.music[e],t);let n=v.audio.ctx,o=t.paused??!1,i=n.createBufferSource(),s=new Fn,r=n.createGain(),l=n.createStereoPanner(),c=t.seek??0,d=0,a=0,h=!1;i.loop=!!t.loop,i.detune.value=t.detune??0,i.playbackRate.value=t.speed??1,i.connect(l),i.onended=()=>{g()>=(i.buffer?.duration??Number.POSITIVE_INFINITY)&&s.trigger()},l.pan.value=t.pan??0,l.connect(r),r.connect(v.audio.masterNode),r.gain.value=t.volume??1;let u=m=>{i.buffer=m.buf,o||(d=n.currentTime,i.start(0,c),h=!0)},p=Y1(e);p instanceof lo&&p.onLoad(u);let g=()=>{if(!i.buffer)return 0;let m=o?a-d:n.currentTime-d,C=i.buffer.duration;return i.loop?m%C:Math.min(m,C)},A=m=>{let C=n.createBufferSource();return C.buffer=m.buffer,C.loop=m.loop,C.playbackRate.value=m.playbackRate.value,C.detune.value=m.detune.value,C.onended=m.onended,C.connect(l),C};return{stop(){this.paused=!0,this.seek(0)},set paused(m){if(o!==m)if(o=m,m)h&&(i.stop(),h=!1),a=n.currentTime;else{i=A(i);let C=a-d;i.start(0,C),h=!0,d=n.currentTime-C,a=0}},get paused(){return o},play(m=0){this.seek(m),this.paused=!1},seek(m){i.buffer?.duration&&(m>i.buffer.duration||(o?(i=A(i),d=a-m):(i.stop(),i=A(i),d=n.currentTime-m,i.start(0,m),h=!0,a=0)))},set speed(m){i.playbackRate.value=m},get speed(){return i.playbackRate.value},set detune(m){i.detune.value=m},get detune(){return i.detune.value},set volume(m){r.gain.value=Math.max(m,0)},get volume(){return r.gain.value},set pan(m){l.pan.value=m},get pan(){return l.pan.value},set loop(m){i.loop=m},get loop(){return i.loop},duration(){return i.buffer?.duration??0},time(){return g()%this.duration()},onEnd(m){return s.add(m)},then(m){return this.onEnd(m)}}}function O0(e){return v.k.play(v.audio.burpSnd,e)}function N0(e){v.audio.masterNode.gain.value=e}function B0(){return v.audio.masterNode.gain.value}function $v(e){return Bs("volume","setVolume / getVolume"),e!==void 0&&N0(e),B0()}function H0(){v.app.onHide(()=>{v.globalOpt.backgroundAudio||v.audio.ctx.suspend()}),v.app.onShow(()=>{!v.globalOpt.backgroundAudio&&!v.debug.paused&&v.audio.ctx.resume()}),v.app.onResize(()=>{if(v.app.isFullscreen())return;let e=v.globalOpt.width&&v.globalOpt.height;e&&!v.globalOpt.stretch&&!v.globalOpt.letterbox||(v.canvas.width=v.canvas.offsetWidth*v.pixelDensity,v.canvas.height=v.canvas.offsetHeight*v.pixelDensity,n0(),e||(v.gfx.frameBuffer.free(),v.gfx.frameBuffer=new za(v.gfx.ggl,v.gfx.ggl.gl.drawingBufferWidth,v.gfx.ggl.gl.drawingBufferHeight),v.gfx.width=v.gfx.ggl.gl.drawingBufferWidth/v.pixelDensity/v.gscale,v.gfx.height=v.gfx.ggl.gl.drawingBufferHeight/v.pixelDensity/v.gscale))}),v.globalOpt.debug!==!1&&(v.app.onKeyPress(v.globalOpt.debugKey??"f1",()=>v.debug.inspect=!v.debug.inspect),v.app.onKeyPress("f2",()=>v.debug.clearLog()),v.app.onKeyPress("f8",()=>v.debug.paused=!v.debug.paused),v.app.onKeyPress("f7",()=>{v.debug.timeScale=Hc(Lo(v.debug.timeScale-.2,0,2),1)}),v.app.onKeyPress("f9",()=>{v.debug.timeScale=Hc(Lo(v.debug.timeScale+.2,0,2),1)}),v.app.onKeyPress("f10",()=>v.debug.stepFrame())),v.globalOpt.burp&&v.app.onKeyPress("b",()=>O0())}function jv(e,t={}){let n=v.game.root.add([Fa(e),q0()]),o=(t.speed||1)*5,i=t.scale||1;n.add([Gc(v.boomSprite),Xa(0),Wc("center"),Mu(o,i),...t.comps??[]]);let s=n.add([Gc(v.kaSprite),Xa(0),Wc("center"),Kc(),...t.comps??[]]);return s.wait(.4/o,()=>s.use(Mu(o,i))),s.onDestroy(()=>n.destroy()),n}function z0(e,t){if(v.game.layers)throw Error("Layers can only be assigned once.");let n=e.indexOf(t);if(n==-1)throw Error("The default layer name should be present in the layers list.");v.game.layers=e,v.game.defaultLayerIndex=n}function Jv(){return v.game.layers}function Qv(){return v.game.layers?.[v.game.defaultLayerIndex]??null}function Zv(e,t){Bs("layers","setLayers"),z0(e,t)}function U0(e){e.destroy()}function kv(){return v.game.root}function ew(e,t){v.game.scenes[e]=t}function tw(e,...t){if(!v.game.scenes[e])throw new Error(`Scene not found: ${e}`);v.game.events.onOnce("frameEnd",()=>{v.game.events.trigger("sceneLeave",e),v.app.events.clear(),v.game.events.clear(),v.game.objEvents.clear(),[...v.game.root.children].forEach(n=>{!n.stay||n.scenesToStay&&!n.scenesToStay.includes(e)?v.game.root.remove(n):n.trigger("sceneEnter",e)}),v.game.root.clearEvents(),H0(),v.game.cam={pos:null,scale:j(1),angle:0,shake:0,transform:new Oo},v.game.scenes[e](...t)}),v.game.currentScene=e}function nw(e){return v.game.events.on("sceneLeave",e)}function ow(){return v.game.currentScene}function Gc(e,t={}){let n=null,o=null,i=null,s=new Fn;if(!e)throw new Error("Please pass the resource name or data to sprite()");let r=(d,a,h,u)=>{let p=j(1,1);return h&&u?(p.x=h/(d.width*a.w),p.y=u/(d.height*a.h)):h?(p.x=h/(d.width*a.w),p.y=p.x):u&&(p.y=u/(d.height*a.h),p.x=p.y),p},l=(d,a)=>{if(!a)return;let h=a.frames[0].clone();t.quad&&(h=h.scale(t.quad));let u=r(a.tex,h,t.width,t.height);if(d.width=a.tex.width*h.w*u.x,d.height=a.tex.height*h.h*u.y,a.anims)for(let p in a.anims){let g=a.anims[p];typeof g!="number"&&(g.frames=c(g))}n=a,s.trigger(n),t.anim&&d.play(t.anim)},c=d=>{if(d.frames)return d.frames;let a=[];if(d.from===void 0||d.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let h=Math.abs(d.to-d.from)+1;for(let u=0;u<h;u++)a.push(d.from+u*Math.sign(d.to-d.from));if(d.pingpong)for(let u=h-2;u>0;u--)a.push(a[u]);return a};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new cn(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(d){let a=Aa(d);a&&a.onLoad(h=>l(this,h))},get animFrame(){if(!n||!o||i===null)return this.frame;let d=n.anims[o.name];return typeof d=="number"?d:d.from===void 0||d.to===void 0?o.frameIndex:this.frame-Math.min(d.from,d.to)},draw(){if(!n)return;let d=n.frames[this.frame??0];if(!d)throw new Error(`Frame not found: ${this.frame??0}`);if(n.slice9){let{left:a,right:h,top:u,bottom:p}=n.slice9,g=n.tex.width*d.w,A=n.tex.height*d.h,m=this.width-a-h,C=this.height-u-p,I=a/g,R=h/g,f=1-I-R,N=u/A,b=p/A,T=1-N-b,x=[yn(0,0,I,N),yn(I,0,f,N),yn(I+f,0,R,N),yn(0,N,I,T),yn(I,N,f,T),yn(I+f,N,R,T),yn(0,N+T,I,b),yn(I,N+T,f,b),yn(I+f,N+T,R,b),yn(0,0,a,u),yn(a,0,m,u),yn(a+m,0,h,u),yn(0,u,a,C),yn(a,u,m,C),yn(a+m,u,h,C),yn(0,u+C,a,p),yn(a,u+C,m,p),yn(a+m,u+C,h,p)];for(let M=0;M<9;M++){let _=x[M],O=x[M+9];Ua(Object.assign(Vi(this),{pos:O.pos(),tex:n.tex,quad:d.scale(_),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:O.w,height:O.h}))}}else Ua(Object.assign(Vi(this),{tex:n.tex,quad:d.scale(this.quad??new cn(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let d=Aa(e);d?d.onLoad(a=>l(this,a)):Wd(()=>l(this,Aa(e).data))},update(){if(!n||!o||i===null)return;let d=n.anims[o.name];if(typeof d=="number"){this.frame=d;return}if(d.speed===0)throw new Error("Sprite anim speed cannot be 0");if(o.timer+=Tn()*this.animSpeed,o.timer>=1/o.speed){o.timer=0,o.frameIndex+=i;let a=d.frames;if(o.frameIndex>=a.length)if(o.pingpong&&!d.pingpong)i=-1,o.frameIndex=a.length-2;else if(o.loop)o.frameIndex=0;else{this.frame=a.at(-1),o.onEnd(),this.stop();return}else if(o.frameIndex<0)if(o.pingpong&&o.loop)i=1,o.frameIndex=1;else if(o.loop)o.frameIndex=a.length-1;else{this.frame=a[0],o.onEnd(),this.stop();return}this.frame=a[o.frameIndex]}},play(d,a={}){if(!n){s.add(()=>this.play(d,a));return}let h=n.anims[d];if(h===void 0)throw new Error(`Anim not found: ${d}`);o&&this.stop(),o=typeof h=="number"?{name:d,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:d,timer:0,loop:a.loop??h.loop??!1,pingpong:a.pingpong??h.pingpong??!1,speed:a.speed??h.speed??10,frameIndex:0,onEnd:a.onEnd??(()=>{})},i=typeof h=="number"?null:1,this.frame=typeof h=="number"?h:h.frames[0],this.trigger("animStart",d)},stop(){if(!o)return;let d=o.name;o=null,this.trigger("animEnd",d)},numFrames(){return n?.frames.length??0},getCurAnim(){return o},curAnim(){return o?.name},getAnim(d){return n?.anims[d]??null},hasAnim(d){return!!this.getAnim(d)},onAnimEnd(d){return this.on("animEnd",d)},onAnimStart(d){return this.on("animStart",d)},renderArea(){return new nn(j(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function iw(e,t={}){function n(i){let s=Gi(Object.assign(Vi(i),{text:i.text+"",size:i.textSize,font:i.font,width:t.width&&i.width,align:i.align,letterSpacing:i.letterSpacing,lineSpacing:i.lineSpacing,transform:i.textTransform,styles:i.textStyles,indentAll:t.indentAll}));return t.width||(i.width=s.width/(i.scale?.x||1)),i.height=s.height/(i.scale?.y||1),s}let o={id:"text",set text(i){e=i,n(this),this.renderedText=Xc(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?Xc(e).text:"",add(){Wd(()=>n(this))},draw(){Ki(n(this))},renderArea(){return new nn(j(0),this.width,this.height)}};return n(o),o}function sw(e,t){return{id:"rect",width:e,height:t,draw(){Pr(Object.assign(Vi(this),{width:this.width,height:this.height}))},renderArea(){return new nn(j(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function rw(e={}){let t=null,n=null,o=null,i=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return n&&o?n[o]:null},getPath(){return n?n.slice():null},getTarget(){return t},isNavigationFinished(){return n?o===null:!0},isTargetReachable(){return n!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(s){t=s,n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o=n?0:null,n&&o!==null?(i||(i=this.getLevel().onNavigationMapChanged(()=>{t&&n&&o!==null&&(n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n?(o=0,this.trigger("navigationNext",this,n[o])):(o=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>i?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,n[o])):this.trigger("navigationEnded",this)},update(){if(t&&n&&o!==null){if(this.pos.sdist(n[o])<2)if(o===n.length-1){this.pos=t.clone(),o=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else o++,this.trigger("navigationNext",this,n[o]);this.moveTo(n[o],this.agentSpeed)}},onNavigationStarted(s){return this.on("navigationStarted",s)},onNavigationNext(s){return this.on("navigationNext",s)},onNavigationEnded(s){return this.on("navigationEnded",s)},onTargetReached(s){return this.on("targetReached",s)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(n)})}}}function aw(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(n){return this.graph?.getWaypointPath(this.pos,n,e.navigationOpt)},get graph(){if(t)return t;let n=this.parent;for(;n;){if(n.has("pathfinderMap"))return n.graph;n=n.parent}},set graph(n){t=n}}}function lw(e={}){let t=e.waypoints,n=e.speed||100,o=e.endBehavior||"stop",i=0,s=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return n},set patrolSpeed(r){n=r},get waypoints(){return t},set waypoints(r){t=r,i=0,s=!1},get nextLocation(){return t?t[i]:void 0},update(){let r=this.nextLocation;if(!(!t||!r||s)&&(this.moveTo(r,n),this.pos.sdist(r)<9))switch(o){case"loop":i=(i+1)%t.length;break;case"ping-pong":i=i+1,i==t.length&&(t.reverse(),i=0);break;case"stop":i<t.length-1?i+=1:s||(s=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(r){return this.on("patrolFinished",r)}}}function cw(e,t={}){let n=typeof e=="function"?e:()=>v.game.root.query(e),o=t.checkFrequency||1,i=typeof t.direction=="number"?ne.fromAngle(t.direction):t.direction,s=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?ne.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(r){this.direction=r!==void 0?ne.fromAngle(r):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(r,l,c){let d=(typeof l=="number"?ne.fromAngle(l):l)||i,a=c||t.fieldOfView;if(!d||!a||a>=360)return!0;let h=a/2;return r.pos&&d.angleBetween(r.pos.sub(this.pos))<=h},hasLineOfSight(r){let l=b0(this.pos,r.pos.sub(this.pos),t.raycastExclude);return l!=null&&l.object===r},update(){if(s+=Tn(),s>o){s-=o;let r=n();if(r.length&&i&&this.fieldOfView&&this.fieldOfView<360){let l=this.fieldOfView/2;r=r.filter(c=>c.pos&&i.angleBetween(c.pos.sub(this.pos))<=l)}r.length&&t.lineOfSight&&(r=r.filter(l=>l.pos&&this.hasLineOfSight(l))),r.length>0&&(this.spotted=r,this.trigger("objectSpotted",r))}},onObjectsSpotted(r){return this.on("objectSpotted",r)}}}function F0(e={}){let t=j(0),n=e.isObstacle??!1,o=e.cost??0,i=e.edges??[],s=()=>{let l={left:1,top:2,right:4,bottom:8};return i.map(c=>l[c]||0).reduce((c,d)=>c|d,0)},r=s();return{id:"tile",tilePosOffset:e.offset??j(0),set tilePos(l){let c=this.getLevel();t=l.clone(),this.pos=j(this.tilePos.x*c.tileWidth(),this.tilePos.y*c.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(l){n!==l&&(n=l,this.getLevel().invalidateNavigationMap())},get isObstacle(){return n},set cost(l){o!==l&&(o=l,this.getLevel().invalidateNavigationMap())},get cost(){return o},set edges(l){i=l,r=s(),this.getLevel().invalidateNavigationMap()},get edges(){return i},get edgeMask(){return r},getLevel(){return this.parent},tileMove(l){let c=this.getLevel();c.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(l),c.insertIntoSpatialMap(this),c.trigger("spatialMapChanged")},moveLeft(){this.tileMove(j(-1,0))},moveRight(){this.tileMove(j(1,0))},moveUp(){this.tileMove(j(0,-1))},moveDown(){this.tileMove(j(0,1))}}}var jd=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,n){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||Rr.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=n}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,n){let o=t-1,i=e/this.duration;if(this.loops!==0&&i>=this.loops)return[o,0,!0];let s=Math.trunc(i);if(i-=s,(this.direction=="reverse"||this.direction=="ping-pong"&&s&1)&&(i=1-i),n){let r=0;for(;n[r+1]!==void 0&&n[r+1]<i;)r++;return r>=o?[o,0,!0]:[r,(i-n[r])/(n[r+1]-n[r]),!1]}else{let r=Math.floor((t-1)*i);return[r,(i-r/o)*o,!1]}}setValue(e,t,n){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(n);break;case"angle":e.angle=e.base.angle+n;break;case"scale":e.scale=e.base.scale.scale(n);break;case"opacity":e.opacity=e.base.opacity*n;break;default:e[t]=n}else e[t]=n}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=Rr.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Tu(e,t){return t.add(t.sub(e))}var dw=class extends jd{keys;constructor(e,t,n,o){super(e,n,o),this.keys=t}update(e,t){let[n,o,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(o==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[n]);else{let s=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,Jn(this.keys[n],this.keys[n+1],s(o)))}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},hw=class extends jd{keys;curves;dcurves;constructor(e,t,n,o,i){if(super(e,n,o),this.keys=t,this.interpolation==="spline"){this.curves=[],i&&(this.dcurves=[]);for(let s=0;s<this.keys.length-1;s++){let r=this.keys[s],l=s+1,c=this.keys[l],d=s>0?this.keys[s-1]:Tu(c,r),a=l<this.keys.length-1?this.keys[l+1]:Tu(r,c);this.curves.push(Na(d,r,c,a)),i&&this.dcurves?.push(Na(d,r,c,a,lx))}}}update(e,t){let[n,o,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(o==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[n]);else{let s=this.easings?this.easings[n]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],s(o)));break;case"slerp":this.setValue(e,this.name,this.keys[n].slerp(this.keys[n+1],s(o)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[n](s(o))),this.dcurves&&this.setValue(e,"angle",this.dcurves[n](s(o)).angle());break}}}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},uw=class extends jd{keys;constructor(e,t,n,o){super(e,n,o),this.keys=t}update(e,t){let[n,o,i]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(o==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[n]);else{let s=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],s(o)))}return i}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function fw(e={}){let t=[],n=0,o=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:j(0,0),angle:0,scale:j(1,1),opacity:1},animation:{paused:!1,seek(i){n=Lo(i,0,this.duration),t.forEach(s=>{s.isFinished=!1}),o=!1},get duration(){return t.reduce((i,s)=>Math.max(s.duration,i),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let i=!0,s;n+=Tn();for(let r of t)s=r.update(this,n),s&&!r.isFinished&&(r.isFinished=!0,this.trigger("animateChannelFinished",r.name)),i&&=s;i&&!o&&(o=!0,this.trigger("animateFinished"))},animate(i,s,r){o=!1,this.unanimate(i),typeof s[0]=="number"?t.push(new dw(i,s,r,e.relative||!1)):s[0]instanceof ne?t.push(new hw(i,s,r,e.relative||!1,i==="pos"&&(e.followMotion||!1))):s[0]instanceof Mt&&t.push(new uw(i,s,r,e.relative||!1))},unanimate(i){let s=t.findIndex(r=>r.name===i);s>=0&&t.splice(s,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(i){return this.on("animateFinished",i)},onAnimateChannelFinished(i){return this.on("animateChannelFinished",i)},serializeAnimationChannels(){return t.reduce((i,s)=>(i[s.name]=s.serialize(),i),{})},serializeAnimationOptions(){let i={};return e.followMotion&&(i.followMotion=!0),e.relative&&(i.relative=!0),i}}}function X0(e,t){let n={name:e.name};return e.has("animate")&&(n.channels=e.serializeAnimationChannels(),Object.assign(n,e.serializeAnimationOptions())),e.children.length>0&&(n.children=e.children.filter(o=>o.has("named")).map(o=>X0(o,o.name))),n}function Mu(e=2,t=1){let n=0;return{require:["scale"],update(){let o=Math.sin(n*e)*t;o<0&&this.destroy(),this.scale=j(o),n+=Tn()}}}function pw(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(n=1){this.setHP(e-n),this.trigger("hurt",n)},heal(n=1){let o=e;this.setHP(e+n),this.trigger("heal",e-o)},hp(){return e},maxHP(){return t??null},setMaxHP(n){t=n},setHP(n){e=t?Math.min(t,n):n,e<=0&&this.trigger("death")},onHurt(n){return this.on("hurt",n)},onHeal(n){return this.on("heal",n)},onDeath(n){return this.on("death",n)},inspect(){return`health: ${e}`}}}function gw(e,t={}){if(e==null)throw new Error("lifespan() requires time");let n=t.fade??0;return{id:"lifespan",require:["opacity"],add(){v.game.root.wait(e,()=>{this.opacity=this.opacity??1,n>0?v.game.root.tween(this.opacity,0,n,o=>this.opacity=o,Rr.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function mw(e){return{id:"named",name:e}}function yw(e,t,n){if(!e)throw new Error("state() requires an initial state");let o={};function i(c){o[c]||(o[c]={enter:new Fn,end:new Fn,update:new Fn,draw:new Fn})}function s(c,d,a){return i(d),o[d][c].add(a)}function r(c,d,...a){i(d),o[d][c].trigger(...a)}let l=!1;return{id:"state",state:e,enterState(c,...d){if(l=!0,t&&!t.includes(c))throw new Error(`State not found: ${c}`);let a=this.state;if(n){if(!n?.[a])return;let h=typeof n[a]=="string"?[n[a]]:n[a];if(!h.includes(c))throw new Error(`Cannot transition state from "${a}" to "${c}". Available transitions: ${h.map(u=>`"${u}"`).join(", ")}`)}r("end",a,...d),this.state=c,r("enter",c,...d),r("enter",`${a} -> ${c}`,...d)},onStateTransition(c,d,a){return s("enter",`${c} -> ${d}`,a)},onStateEnter(c,d){return s("enter",c,d)},onStateUpdate(c,d){return s("update",c,d)},onStateDraw(c,d){return s("draw",c,d)},onStateEnd(c,d){return s("end",c,d)},update(){l||(r("enter",e),l=!0),r("update",this.state)},draw(){r("draw",this.state)},inspect(){return`state: ${this.state}`}}}function q0(e){return{id:"stay",stay:!0,scenesToStay:e}}function xw(e=!0,t){let n,o;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let i=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};n=v.k.onCharInput(s=>{this.hasFocus&&(!t||this.typedText.length<t)&&(v.k.isKeyDown("shift")?this.typedText+=s.toUpperCase():this.typedText+=s,i())}),o=v.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),i())})},destroy(){n.cancel(),o.cancel()}}}function Kc(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,n,o=1/0,i=!1){let s=i?0:t,r=new Fn,l=this.onUpdate(()=>{s+=v.app.state.dt;for(let c=0;s>=t&&c<this.maxLoopsPerFrame;c++)if(o--,n(),s-=t,o<=0){l.cancel(),r.trigger();return}});return{get paused(){return l.paused},set paused(c){l.paused=c},cancel:l.cancel,onEnd(c){r.add(c)},then(c){return r.add(c),this}}},wait(t,n){return this.loop(t,n??(()=>{}),1,!0)},tween(t,n,o,i,s=Rr.linear){let r=0,l=[],c=this.onUpdate(()=>{r+=v.app.state.dt;let d=Math.min(r/o,1);i(Jn(t,n,s(d))),d===1&&(c.cancel(),i(n),l.forEach(a=>a()))});return{get paused(){return c.paused},set paused(d){c.paused=d},onEnd(d){l.push(d)},then(d){return this.onEnd(d),this},cancel(){c.cancel()},finish(){c.cancel(),i(n),l.forEach(d=>d())}}}}}var Vc=0;function vw(){return Vc>0}function ww(e={}){let t={},n=new Set,o=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){Vc++,this.area.cursor&&o.push(this.onHover(()=>v.app.setCursor(this.area.cursor))),o.push(this.onCollideUpdate((i,s)=>{if(!i.id)throw new Error("area() requires the object to have an id");t[i.id]||this.trigger("collide",i,s),s&&(t[i.id]=s,n.add(i.id))}))},destroy(){Vc--;for(let i of o)i.cancel()},fixedUpdate(){for(let i in t)n.has(Number(i))||(this.trigger("collideEnd",t[i].target),delete t[i]);n.clear()},drawInspect(){let i=this.localArea();no(),hn(this.area.offset);let s={outline:{width:4/o0(),color:Kt(0,0,255)},anchor:this.anchor,fill:!1,fixed:Hi(this)};i instanceof nn?io({...s,pos:i.pos,width:i.width*this.area.scale.x,height:i.height*this.area.scale.y}):i instanceof Kn?hi({...s,pts:i.pts,scale:this.area.scale}):i instanceof Zn&&zs({...s,pos:i.center,radius:i.radius}),$n()},area:{shape:e.shape??null,scale:e.scale?j(e.scale):j(1),offset:e.offset??j(0),cursor:e.cursor??null},isClicked(){return v.app.isMousePressed()&&this.isHovering()},isHovering(){let i=Hi(this)?v.k.mousePos():v.k.toWorld(v.k.mousePos());return this.hasPoint(i)},checkCollision(i){if(!i.id)throw new Error("checkCollision() requires the object to have an id");return t[i.id]??null},getCollisions(){return Object.values(t)},isColliding(i){if(!i.id)throw new Error("isColliding() requires the object to have an id");return!!t[i.id]},isOverlapping(i){if(!i.id)throw new Error("isOverlapping() requires the object to have an id");let s=t[i.id];return s&&s.hasOverlap()},onClick(i,s="left"){let r=this.onMousePress(s,()=>{this.isHovering()&&i()});return o.push(r),r},onHover(i){let s=!1;return this.onUpdate(()=>{s?s=this.isHovering():this.isHovering()&&(s=!0,i())})},onHoverUpdate(i){return this.onUpdate(()=>{this.isHovering()&&i()})},onHoverEnd(i){let s=!1;return this.onUpdate(()=>{s?this.isHovering()||(s=!1,i()):s=this.isHovering()})},onCollide(i,s){if(typeof i=="function"&&s===void 0)return this.on("collide",i);if(typeof i=="string")return this.onCollide((r,l)=>{r.is(i)&&s?.(r,l)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(i,s){if(typeof i=="function"&&s===void 0)return this.on("collideUpdate",i);if(typeof i=="string")return this.on("collideUpdate",(r,l)=>r.is(i)&&s?.(r,l));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(i,s){if(typeof i=="function"&&s===void 0)return this.on("collideEnd",i);if(typeof i=="string")return this.on("collideEnd",r=>r.is(i)&&s?.(r));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(i){return yi(this.worldArea(),i)},resolveCollision(i){let s=this.checkCollision(i);s&&!s.resolved&&(this.pos=this.pos.add(s.displacement),s.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let i=this.localArea();if(!(i instanceof Kn||i instanceof nn))throw new Error("Only support polygon and rect shapes for now");let s=this.transform.clone().translate(this.area.offset).scale(j(this.area.scale??1));if(i instanceof nn){let r=Hs(this.anchor||Sl).add(1,1).scale(-.5).scale(i.width,i.height);s.translate(r)}return i.transform(s)},screenArea(){let i=this.worldArea();return Hi(this)?i:i.transform(v.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function bw(e={}){let t=null,n=null,o=!1,i=j(0),s=null,r=null,l;return{id:"body",require:["pos"],vel:j(0),drag:e.drag??0,jumpForce:e.jumpForce??Mx,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(s=this.pos.clone(),r=this.pos.clone(),l=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((c,d)=>{if(!d||!c.has("body")||d.resolved)return;this.trigger("beforePhysicsResolve",d);let a=d.reverse();if(c.trigger("beforePhysicsResolve",a),!(d.resolved||a.resolved)&&!(this.isStatic&&c.isStatic)){if(!this.isStatic&&!c.isStatic){let h=this.mass+c.mass;this.pos=this.pos.add(d.displacement.scale(c.mass/h)),c.pos=c.pos.add(d.displacement.scale(-this.mass/h)),this.transform=xr(this),c.transform=xr(c)}else{let h=!this.isStatic&&c.isStatic?d:d.reverse();h.source.pos=h.source.pos.add(h.displacement),h.source.transform=xr(h.source)}d.resolved=!0,this.trigger("physicsResolve",d),c.trigger("physicsResolve",d.reverse())}}),this.onPhysicsResolve(c=>{if(v.game.gravity)if(c.isBottom()&&this.isFalling()){this.vel=this.vel.reject(v.game.gravity.unit());let d=t;t=c.target,d!=t&&(n=c.target.pos),o?o=!1:d||(this.trigger("ground",t),c.target.trigger("land",this))}else c.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(v.game.gravity.unit()),this.trigger("headbutt",c.target),c.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(n&&!t.pos.eq(n)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(n)),n=t.pos);let c=Uc();c&&(this.pos.x==l.x&&(this.pos.x=Jn(s.x,r.x,c/zc()),l.x=this.pos.x),this.pos.y==l.y&&(this.pos.y=Jn(s.y,r.y,c/zc()),l.y=this.pos.y))},fixedUpdate(){if(s&&(this.pos.x==l.x&&(this.pos.x=s.x),this.pos.y==l.y&&(this.pos.y=s.y),s=null),v.game.gravity&&!this.isStatic){o&&(t=null,n=null,this.trigger("fallOff"),o=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(o=!0);let c=this.vel.clone();this.vel=this.vel.add(v.game.gravity.scale(this.gravityScale*Tn()));let d=e.maxVelocity??Rx;this.vel.slen()>d*d&&(this.vel=this.vel.unit().scale(d)),c.dot(v.game.gravity)<0&&this.vel.dot(v.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=i.x*Tn(),this.vel.y+=i.y*Tn(),this.vel.x*=1-this.drag*Tn(),this.vel.y*=1-this.drag*Tn(),this.move(this.vel),Uc()){s=this.pos.clone();let c=this.vel.add(i.scale(Tn()));r=this.pos.add(c.scale(Tn())),l=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(c){return this.on("physicsResolve",c)},onBeforePhysicsResolve(c){return this.on("beforePhysicsResolve",c)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(wr())>0},isJumping(){return this.vel.dot(wr())<0},applyImpulse(c){this.isStatic||(this.vel=this.vel.add(c))},addForce(c){this.isStatic||(i.x+=c.x/this.mass,i.y+=c.y/this.mass)},jump(c){this.isStatic||(t=null,n=null,this.vel=wr().scale(-c||-this.jumpForce))},onGround(c){return this.on("ground",c)},onFall(c){return this.on("fall",c)},onFallOff(c){return this.on("fallOff",c)},onHeadbutt(c){return this.on("headbutt",c)},onLand(c){return this.on("land",c)},onHeadbutted(c){return this.on("headbutted",c)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function Ew(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(n){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(n))},onDoubleJump(n){return this.on("doubleJump",n)},inspect(){return`jumpsLeft: ${t}`}}}function Sw(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,n)=>{let o=n?.normal.normal(),i=t.vel.project(o),s=o?.scale(this.speed)?.sub(i);t.addForce(s?.scale(t.mass*this.forceScale))})}}}function Cw(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,n)=>{if(!t.has("body"))return;let o=ne.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(o),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function _w(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,n)=>{let o=this.pos.sub(t.pos),i=o.len(),s=i*this.distanceScale/10,r=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/s:1/s**2,l=o.scale(this.forceMagnitude*r/i);t.addForce(l),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function Aw(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function Tw(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let n=t.target.vel,o=wr().scale(-1).angleBetween(n);Math.abs(o)>this.surfaceArc/2&&t.preventResolution()})}}}function Mw(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,n)=>{let o=t,i=o.worldArea(),[s,r]=i.cut(j(-100,this.surfaceLevel),j(100,this.surfaceLevel));s&&(this.applyBuoyancy(o,s),this.applyDrag(o,s)),this.flowMagnitude&&o.addForce(ne.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,n){let o=this.density*n.area(),i=j(0,1).scale(-o);t.addForce(i)},applyDrag(t,n){let o=t.vel,i=this.density*this.linearDrag,s=o.scale(-i);t.addForce(s)}}}function Wc(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function Y0(){return{id:"fixed",fixed:!0}}function Rw(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??j(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Dw(e){let t=v.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?v.game.layers?.[t]??null:null},set layer(n){if(t=v.game.layers?.indexOf(n),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function Iw(e,t){let n=typeof e=="number"?ne.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(n.scale(t))}}}function Pw(e={}){let t=!1,n=new nn(j(0),In(),On()),o=new nn(j(0),0,0),i=s=>{s.isOffScreen()?(t||(s.trigger("exitView"),t=!0),e.hide&&(s.hidden=!0),e.pause&&(s.paused=!0),e.destroy&&s.destroy()):(t&&(s.trigger("enterView"),t=!1),e.hide&&(s.hidden=!1),e.pause&&(s.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??gu,isOffScreen(){let s=this.screenPos();if(!s)return!1;if(n.width=In(),n.height=On(),!this.offscreenDistance&&this.width&&this.height)return o.width=this.width,o.height=this.height,o.pos=this.pos,o.collides(n);let r=this.offscreenDistance?this.offscreenDistance:gu;return!wl(n,s)&&n.sdistToPoint(s)>r*r},onExitScreen(s){return this.on("exitView",s)},onEnterScreen(s){return this.on("enterView",s)},add(){e.pause&&e.unpause?S0(()=>i(this)):this.onUpdate(()=>i(this))}}}function Fa(...e){return{id:"pos",pos:j(...e),moveBy(...t){this.pos=this.pos.add(j(...t))},move(...t){this.moveBy(j(...t).scale(Tn()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(j(t[0],t[1]),t[2]);let n=t[0],o=t[1];if(o===void 0){this.pos=j(n);return}let i=n.sub(this.pos);if(i.len()<=o*Tn()){this.pos=j(n);return}this.move(i.unit().scale(o))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let n=this.worldPos();return n?Hi(this)?n:Yc(n):null}},toScreen(t){let n=this.toWorld(t);return Hi(this)?n:Yc(n)},fromScreen(t){return Hi(this)?this.fromWorld(t):this.fromWorld(L0(t))},toOther(t,n){return t.fromWorld(this.toWorld(n))},fromOther(t,n){return t.toOther(this,n)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){zs({color:Kt(255,0,0),radius:4/o0()})}}}function Lw(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function Xa(...e){if(e.length===0)return Xa(1);let t=j(...e);return{id:"scale",set scale(n){if(!(n instanceof ne))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=j(n)},get scale(){return t},scaleTo(...n){t=j(...n)},scaleBy(...n){t=t.scale(j(...n))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function Ow(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Nw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",Bw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",Hw=Ty.version,v={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},zw=(e={tagsAsComponents:!0})=>{v.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),v.k.quit()),v.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let n=e.canvas??t.appendChild(document.createElement("canvas"));v.canvas=n;let o=e.scale??1;v.gscale=o;let i=e.width&&e.height&&!e.stretch&&!e.letterbox;i?(n.width=e.width*o,n.height=e.height*o):(n.width=n.parentElement.offsetWidth,n.height=n.parentElement.offsetHeight);let s=["outline: none","cursor: default"];if(i){let pe=n.width,Se=n.height;s.push(`width: ${pe}px`),s.push(`height: ${Se}px`)}else s.push("width: 100%"),s.push("height: 100%");e.crisp&&(s.push("image-rendering: pixelated"),s.push("image-rendering: crisp-edges")),n.style.cssText=s.join(";");let r=e.pixelDensity||1;v.pixelDensity=r,n.width*=r,n.height*=r,n.tabIndex=0;let l=document.createElement("canvas");l.width=256,l.height=256,v.fontCacheCanvas=l;let c=l.getContext("2d",{willReadFrequently:!0});v.fontCacheC2d=c;let d=i1({canvas:n,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});v.app=d;let a=[],h=d.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!h)throw new Error("WebGL not supported");let u=h,p=Q1(u,{texFilter:e.texFilter}),g=iv(e,p);v.gfx=g;let A=Kv();v.audio=A;let m=I1(p,e.spriteAtlasPadding??0);v.assets=m;let C=Fv();v.game=C,C.root.use(Kc());function I(pe,Se){let ae=new za(p,pe,Se);return{clear:()=>ae.clear(),free:()=>ae.free(),toDataURL:()=>ae.toDataURL(),toImageData:()=>ae.toImageData(),width:ae.width,height:ae.height,draw:Xe=>{oo(),ae.bind(),Xe(),oo(),ae.unbind()},get fb(){return ae}}}function R(){u.clear(u.COLOR_BUFFER_BIT),g.frameBuffer.bind(),u.clear(u.COLOR_BUFFER_BIT),g.bgColor||ai(()=>{Pr({width:In(),height:On(),quad:new cn(0,0,In()/64,On()/64),tex:g.bgTex,fixed:!0})}),g.renderer.numDraws=0,g.fixed=!1,g.transformStack.length=0,g.transform=new Oo}function f(pe,Se){g.postShader=pe,g.postShaderUniform=Se??null}function N(){oo(),g.lastDrawCalls=g.renderer.numDraws,g.frameBuffer.unbind(),u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight);let pe=g.width,Se=g.height;g.width=u.drawingBufferWidth/r,g.height=u.drawingBufferHeight/r,Ua({flipY:!0,tex:g.frameBuffer.tex,pos:new ne(g.viewport.x,g.viewport.y),width:g.viewport.width,height:g.viewport.height,shader:g.postShader,uniform:typeof g.postShaderUniform=="function"?g.postShaderUniform():g.postShaderUniform,fixed:!0}),oo(),g.width=pe,g.height=Se}let b=!1,T={inspect:!1,set timeScale(pe){v.app.state.timeScale=pe},get timeScale(){return v.app.state.timeScale},showLog:!0,fps:()=>d.fps(),numFrames:()=>d.numFrames(),stepFrame:se,drawCalls:()=>g.lastDrawCalls,clearLog:()=>C.logs=[],log:(...pe)=>{let Se=e.logMax??8,ae=pe.length>1?pe.concat(" ").join(" "):pe[0];C.logs.unshift({msg:ae,time:d.time()}),C.logs.length>Se&&(C.logs=C.logs.slice(0,Se))},error:pe=>T.log(new Error(pe.toString?pe.toString():pe)),curRecording:null,numObjects:()=>B("*",{recursive:!0}).length,get paused(){return b},set paused(pe){b=pe,pe?A.ctx.suspend():A.ctx.resume()}};v.debug=T;function x(pe,Se){try{return JSON.parse(window.localStorage[pe])}catch{return Se?(M(pe,Se),Se):null}}function M(pe,Se){window.localStorage[pe]=JSON.stringify(Se)}function _(pe,...Se){let ae=pe(Ae),Xe;typeof ae=="function"?Xe=ae(...Se)(Ae):Xe=ae;for(let qe in Xe)Ae[qe]=Xe[qe],e.global!==!1&&(window[qe]=Xe[qe]);return Ae}function O(pe){let Se=d.canvas.captureStream(pe),ae=A.ctx.createMediaStreamDestination();A.masterNode.connect(ae);let Xe=new MediaRecorder(Se),qe=[];return Xe.ondataavailable=Ce=>{Ce.data.size>0&&qe.push(Ce.data)},Xe.onerror=()=>{A.masterNode.disconnect(ae),Se.getTracks().forEach(Ce=>Ce.stop())},Xe.start(),{resume(){Xe.resume()},pause(){Xe.pause()},stop(){return Xe.stop(),A.masterNode.disconnect(ae),Se.getTracks().forEach(Ce=>Ce.stop()),new Promise(Ce=>{Xe.onstop=()=>{Ce(new Blob(qe,{type:"video/mp4"}))}})},download(Ce="kaboom.mp4"){this.stop().then(Ve=>mu(Ce,Ve))}}}function P(){return document.activeElement===d.canvas}let z=C.root.add.bind(C.root),U=C.root.readd.bind(C.root),F=C.root.removeAll.bind(C.root),B=C.root.get.bind(C.root),D=C.root.wait.bind(C.root),q=C.root.loop.bind(C.root),G=C.root.query.bind(C.root),Z=C.root.tween.bind(C.root),le=vr(null,Bw),ie=vr(null,Nw);v.kaSprite=le,v.boomSprite=ie;function oe(){C.root.fixedUpdate()}function se(){C.root.update()}class he{source;target;normal;distance;resolved=!1;constructor(Se,ae,Xe,qe,Ce=!1){this.source=Se,this.target=ae,this.normal=Xe,this.distance=qe,this.resolved=Ce}get displacement(){return this.normal.scale(this.distance)}reverse(){return new he(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(C.gravity||j(0,1))>0}isRight(){return this.displacement.cross(C.gravity||j(0,1))<0}isTop(){return this.displacement.dot(C.gravity||j(0,1))>0}isBottom(){return this.displacement.dot(C.gravity||j(0,1))<0}preventResolution(){this.resolved=!0}}function Me(){if(!vw())return;let pe={},Se=e.hashGridSize||64,ae=new Oo,Xe=[];function qe(Ce){if(Xe.push(ae.clone()),Ce.pos&&ae.translate(Ce.pos),Ce.scale&&ae.scale(Ce.scale),Ce.angle&&ae.rotate(Ce.angle),Ce.transform=ae.clone(),Ce.c("area")&&!Ce.paused){let Ve=Ce,We=Ve.worldArea().bbox(),At=Math.floor(We.pos.x/Se),Nt=Math.floor(We.pos.y/Se),wt=Math.ceil((We.pos.x+We.width)/Se),Ie=Math.ceil((We.pos.y+We.height)/Se),Pe=new Set;for(let Ge=At;Ge<=wt;Ge++)for(let $e=Nt;$e<=Ie;$e++)if(!pe[Ge])pe[Ge]={},pe[Ge][$e]=[Ve];else if(!pe[Ge][$e])pe[Ge][$e]=[Ve];else{let je=pe[Ge][$e];e:for(let ct of je){if(ct.paused||!ct.exists()||Pe.has(ct.id))continue;for(let st of Ve.collisionIgnore)if(ct.is(st))continue e;for(let st of ct.collisionIgnore)if(Ve.is(st))continue e;let at=px(Ve.worldArea(),ct.worldArea());if(at){let st=new he(Ve,ct,at.normal,at.distance);Ve.trigger("collideUpdate",ct,st);let ut=st.reverse();ut.resolved=st.resolved,ct.trigger("collideUpdate",Ve,ut)}Pe.add(ct.id)}je.push(Ve)}}Ce.children.forEach(qe),ae=Xe.pop()}qe(C.root)}function He(pe){console.error(pe),A.ctx.suspend();let Se=pe.message??String(pe)??"Unknown error, check console for more info";d.run(()=>{},()=>{R(),ai(()=>{let ae=In(),Xe=On(),qe={size:36,width:ae-64,letterSpacing:4,lineSpacing:4,font:Ba,fixed:!0};io({width:ae,height:Xe,color:Kt(0,0,255),fixed:!0});let Ce=Gi({...qe,text:"Error",pos:j(32),color:Kt(255,128,0),fixed:!0});Ki(Ce),Au({...qe,text:Se,pos:j(32,32+Ce.height+16),fixed:!0}),$n(),C.events.trigger("error",pe)}),N()})}function we(pe){a.push(pe)}function De(){C.events.onOnce("frameEnd",()=>{d.quit(),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);let pe=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(let Se=0;Se<pe;Se++)u.activeTexture(u.TEXTURE0+Se),u.bindTexture(u.TEXTURE_2D,null),u.bindTexture(u.TEXTURE_CUBE_MAP,null);u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),p.destroy(),a.forEach(Se=>Se())})}let Qe=!0;d.run(()=>{try{m.loaded&&(T.paused||oe(),Me())}catch(pe){He(pe)}},(pe,Se)=>{try{pe(),m.loaded||Yi()===1&&!Qe&&(m.loaded=!0,s0().forEach(ae=>C.events.trigger("loadError",...ae)),C.events.trigger("load")),!m.loaded&&e.loadingScreen!==!1||Qe?(R(),ev(),N()):(T.paused||se(),Me(),R(),k1(),e.debug!==!1&&Z1(),N()),Qe&&(Qe=!1),C.events.trigger("frameEnd"),Se()}catch(ae){He(ae)}}),n0(),H0();let Ae={_k:v,VERSION:Hw,loadRoot:M1,loadProgress:Yi,loadSprite:vr,loadSpriteAtlas:f0,loadSound:G1,loadMusic:K1,loadBitmapFont:H1,loadFont:N1,loadShader:X1,loadShaderURL:q1,loadAseprite:O1,loadPedit:z1,loadBean:L1,loadJSON:R1,load:Fc,getSound:u0,getFont:c0,getBitmapFont:d0,getSprite:r0,getShader:h0,getAsset:D1,Asset:lo,SpriteData:xi,SoundData:Ir,width:In,height:On,center:Ha,dt:Tn,fixedDt:zc,restDt:Uc,time:d.time,screenshot:d.screenshot,record:O,isFocused:P,setCursor:d.setCursor,getCursor:d.getCursor,setCursorLocked:d.setCursorLocked,isCursorLocked:d.isCursorLocked,setFullscreen:d.setFullscreen,isFullscreen:d.isFullscreen,isTouchscreen:d.isTouchscreen,onLoad:Wd,onLoadError:Pv,onLoading:Rv,onResize:Dv,onGamepadConnect:d.onGamepadConnect,onGamepadDisconnect:d.onGamepadDisconnect,onError:Iv,onCleanup:we,flash:P0,setCamPos:A0,getCamPos:T0,setCamRot:D0,getCamRot:I0,setCamScale:M0,getCamScale:R0,getCamTransform:Lv,camPos:Bv,camScale:Hv,camFlash:Uv,camRot:zv,camTransform:Ov,shake:Nv,toScreen:Yc,toWorld:L0,setGravity:Xv,getGravity:qv,setGravityDirection:Yv,getGravityDirection:wr,setBackground:E1,getBackground:S1,getGamepads:d.getGamepads,getTreeRoot:kv,add:z,make:$d,destroy:U0,destroyAll:F,get:B,query:G,readd:U,pos:Fa,scale:Xa,rotate:Lw,color:v0,opacity:w0,anchor:Wc,area:ww,sprite:Gc,text:iw,polygon:uv,rect:E0,circle:sv,uvquad:sw,outline:cv,particles:hv,body:bw,platformEffector:Tw,surfaceEffector:Sw,areaEffector:Cw,pointEffector:_w,buoyancyEffector:Mw,constantForce:Aw,doubleJump:Ew,shader:fv,textInput:xw,timer:Kc,fixed:Y0,stay:q0,health:pw,lifespan:gw,named:mw,state:yw,z:Ow,layer:Dw,move:Iw,offscreen:Pw,follow:Rw,fadeIn:av,mask:lv,drawon:rv,raycast:b0,tile:F0,animate:fw,serializeAnimation:X0,agent:rw,sentry:cw,patrol:lw,pathfinder:aw,trigger:gv,on:eo,onFixedUpdate:mv,onUpdate:S0,onDraw:yv,onAdd:C0,onDestroy:xv,onTag:_0,onUntag:bv,onUse:vv,onUnuse:wv,onClick:_v,onCollide:Ev,onCollideUpdate:Sv,onCollideEnd:Cv,onHover:Av,onHoverUpdate:Tv,onHoverEnd:Mv,onKeyDown:d.onKeyDown,onKeyPress:d.onKeyPress,onKeyPressRepeat:d.onKeyPressRepeat,onKeyRelease:d.onKeyRelease,onMouseDown:d.onMouseDown,onMousePress:d.onMousePress,onMouseRelease:d.onMouseRelease,onMouseMove:d.onMouseMove,onCharInput:d.onCharInput,onTouchStart:d.onTouchStart,onTouchMove:d.onTouchMove,onTouchEnd:d.onTouchEnd,onScroll:d.onScroll,onHide:d.onHide,onShow:d.onShow,onGamepadButtonDown:d.onGamepadButtonDown,onGamepadButtonPress:d.onGamepadButtonPress,onGamepadButtonRelease:d.onGamepadButtonRelease,onGamepadStick:d.onGamepadStick,onButtonPress:d.onButtonPress,onButtonDown:d.onButtonDown,onButtonRelease:d.onButtonRelease,mousePos:d.mousePos,mouseDeltaPos:d.mouseDeltaPos,isKeyDown:d.isKeyDown,isKeyPressed:d.isKeyPressed,isKeyPressedRepeat:d.isKeyPressedRepeat,isKeyReleased:d.isKeyReleased,isMouseDown:d.isMouseDown,isMousePressed:d.isMousePressed,isMouseReleased:d.isMouseReleased,isMouseMoved:d.isMouseMoved,isGamepadButtonPressed:d.isGamepadButtonPressed,isGamepadButtonDown:d.isGamepadButtonDown,isGamepadButtonReleased:d.isGamepadButtonReleased,getGamepadStick:d.getGamepadStick,isButtonPressed:d.isButtonPressed,isButtonDown:d.isButtonDown,isButtonReleased:d.isButtonReleased,setButton:d.setButton,getButton:d.getButton,pressButton:d.pressButton,releaseButton:d.releaseButton,getLastInputDeviceType:d.getLastInputDeviceType,charInputted:d.charInputted,loop:q,wait:D,play:Wv,setVolume:N0,getVolume:B0,volume:$v,burp:O0,audioCtx:A.ctx,Line:kn,Rect:nn,Circle:Zn,Ellipse:Jo,Point:Jy,Polygon:Kn,Vec2:ne,Color:Mt,Mat4:Oo,Quad:cn,RNG:Pp,rand:An,randi:Lp,randSeed:Py,vec2:j,rgb:Kt,hsl2rgb:My,quad:yn,choose:Ny,chooseMultiple:Oy,shuffle:Op,chance:Ly,lerp:Jn,tween:Z,easings:Rr,map:Ro,mapc:Ry,wave:Ip,deg2rad:xn,rad2deg:qi,clamp:Lo,evaluateQuadratic:Zy,evaluateQuadraticFirstDerivative:ky,evaluateQuadraticSecondDerivative:ex,evaluateBezier:Ud,evaluateBezierFirstDerivative:tx,evaluateBezierSecondDerivative:nx,evaluateCatmullRom:ox,evaluateCatmullRomFirstDerivative:ix,curveLengthApproximation:Gp,normalizedCurve:sx,hermite:Jr,cardinal:Kp,catmullRom:Na,bezier:rx,kochanekBartels:ax,easingSteps:fx,easingLinear:hx,easingCubicBezier:ux,testLineLine:Ld,testRectRect:Np,testRectLine:Od,testRectPoint:wl,testCirclePolygon:El,testLinePoint:Nd,testLineCircle:jr,isConvex:vx,triangulate:Wp,NavMesh:w1,drawSprite:nv,drawText:Au,formatText:Gi,drawRect:io,drawLine:ur,drawLines:Vd,drawTriangle:y0,drawCircle:zs,drawEllipse:p0,drawUVQuad:Pr,drawPolygon:hi,drawCurve:g0,drawBezier:j1,drawFormattedText:Ki,drawMasked:tv,drawSubtracted:ov,pushTransform:no,popTransform:$n,pushTranslate:hn,pushScale:Dr,pushRotate:_s,pushMatrix:C1,usePostEffect:f,makeCanvas:I,debug:T,scene:ew,getSceneName:ow,go:tw,onSceneLeave:nw,layers:Zv,getLayers:Jv,setLayers:z0,getDefaultLayer:Qv,addLevel:pv,getData:x,setData:M,download:Xd,downloadJSON:Nx,downloadText:e0,downloadBlob:mu,plug:_,ASCII_CHARS:$p,canvas:d.canvas,addKaboom:jv,LEFT:ne.LEFT,RIGHT:ne.RIGHT,UP:ne.UP,DOWN:ne.DOWN,RED:Mt.RED,GREEN:Mt.GREEN,BLUE:Mt.BLUE,YELLOW:Mt.YELLOW,MAGENTA:Mt.MAGENTA,CYAN:Mt.CYAN,WHITE:Mt.WHITE,BLACK:Mt.BLACK,quit:De,KEvent:Fn,KEventHandler:Mr,KEventController:ts,cancel:()=>Jp};v.k=Ae;let pt=e.plugins;if(pt&&pt.forEach(_),e.global!==!1)for(let pe in Ae)window[pe]=Ae[pe];return e.focus!==!1&&d.canvas.focus(),Ae},Uw=zw;const Ru=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Royal","Noble","Rogue","Savage","Reigning","Rising","Rookie","Veteran","Seasoned","Underdog","Favored","Viral","Trending","Famous","Infamous","Ultimate","Supreme","Grand","Major","Premier","Star","Main","Top","Peak","Apex","Brutal","Ruthless","Vicious","Crushing","Raging","Furious","Frenzied","Berserk","Mad","Crazy","Lethal","Deadly","Fatal","Killer","Murder","Immortal","Eternal","Heavy","Hard","Tough","Gritty","Scrappy","Mean","Nasty","Dirty","Raw","Primal","Amazing","Awesome","Dazzling","Stunning","Shocking","Dynamic","Radical","Extreme","Intense","Hyper","Ultra","Mega","Super","Power","Atomic","Nuclear","Chaos","Havoc","Mayhem","Rampage","Carnage","Cocky","Sneaky","Tricky","Sly","Cunning","Wicked","Evil","Sinister","Twisted","Crooked","Lucky","Unlucky","Cursed","Blessed","Chosen","Lone","Solo","Outlaw","Rebel","Bandit"],Du=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter","Finalist","Victor","Winner","Champ","Hopeful","Prospect","Wildcard","Underdog","Favorite","Prodigy","Rookie","Veteran","Pro","Amateur","Phenom","Showman","Icon","Brawler","Bruiser","Slugger","Puncher","Boxer","Fighter","Scrapper","Battler","Duelist","Crusher","Smasher","Basher","Masher","Thrasher","Pummeler","Pounder","Hammer","Mauler","Mangler","Knockout","Haymaker","Uppercut","Jab","Hook","Spartan","Viking","Wrecking","Rampage","Havoc","Mayhem","Chaos","Carnage","Fury","Menace","Terror","Horror","Dread","Fist","Knuckle","Claw","Talon","Spike","Axe","Hammer","Mace","Flail","Club","Cannon","Mortar","Missile","Bomb","Grenade","Shiv","Machete","Cleaver","Hatchet","Gorilla","Rhino","Bull","Boar","Pitbull","Doberman","Mastiff","Bulldog","Scorpion","Mantis","Hornet","Wasp","Spider","Croc","Gator","Piranha","Orca","Hyena","Jackal","Badger","Warthog","Mongoose","Outlaw","Bandit","Thug","Goon","Hooligan","Punk","Rebel","Maverick","Renegade","Assassin","Bounty","Hitman","Enforcer","Boss","Kingpin","Warlord","Overlord","Tyrant"];function $c(){const e=Ru[Math.floor(Math.random()*Ru.length)],t=Du[Math.floor(Math.random()*Du.length)];return`${e}${t}`}function jc(){return Math.floor(1e5+Math.random()*9e5).toString()}function Fw(e){return/^\d{6}$/.test(e)}const No={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:2},hint:"Progress further into the facility"},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:3},hint:"Keep pushing deeper"},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:5},hint:"The halfway point awaits",unlocks:["trailIce"]},floor10:{id:"floor10",name:"Double Digits",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:10},unlocks:["plasmaRifle"]},firstSynergy:{id:"firstSynergy",name:"Combo Starter",description:"Activate your first synergy",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect upgrades that work together",unlocks:["trailShadow"]},allCharacters:{id:"allCharacters",name:"Full Roster",description:"Unlock all characters",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Progress through floors to unlock characters"},maxUpgrade:{id:"maxUpgrade",name:"Maxed Out",description:"Max out a permanent upgrade",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Purchase the same upgrade multiple times"},firstDoor:{id:"firstDoor",name:"Door Explorer",description:"Enter a special door",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Find and enter a special door in a room"},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1},hint:"Defeat any enemy"},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:100},hint:"Keep fighting!",unlocks:["trailFire"]},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:500},hint:"The carnage continues",unlocks:["trailPoison"]},kill1000:{id:"kill1000",name:"Rampage",description:"Kill 1000 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1e3},hint:"A true warrior emerges"},killStreak10:{id:"killStreak10",name:"On Fire",description:"Kill 10 enemies in 5 seconds",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Defeat enemies rapidly",unlocks:["deathVaporize"]},multikill:{id:"multikill",name:"Multi-Kill",description:"Kill 5 enemies with one attack",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Use piercing or explosive attacks",unlocks:["deathPixelate"]},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:1},hint:"Clear Floor 1 to face a boss",unlocks:["deathExplosion"]},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:5},hint:"Keep defeating floor bosses",unlocks:["deathDisintegrate"]},boss10:{id:"boss10",name:"Boss Veteran",description:"Defeat 10 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:10},hint:"Experience makes perfect"},boss25:{id:"boss25",name:"Boss Crusher",description:"Defeat 25 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:25},unlocks:["railgun"],hint:"Become a boss-hunting expert"},boss50:{id:"boss50",name:"Boss Destroyer",description:"Defeat 50 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:50},hint:"The ultimate boss hunter"},minibossSlayer:{id:"minibossSlayer",name:"Miniboss Hunter",description:"Defeat 10 minibosses",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalMinibossesKilled",value:10},hint:"Minibosses appear in later rooms"},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:1},hint:"Play until you die (or win!)"},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:10},hint:"Practice makes progress"},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:50},hint:"A true fan of the show"},run100:{id:"run100",name:"Century",description:"Complete 100 runs",category:"run",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRuns",value:100},hint:"The ultimate dedication"},quickDeath:{id:"quickDeath",name:"Speedrun Fail",description:"Die within 30 seconds",category:"run",icon:"",unlocked:!1,difficulty:"normal",hint:"Sometimes things go wrong fast"},longRun:{id:"longRun",name:"Marathon",description:"Survive for 30 minutes",category:"run",icon:"",unlocked:!1,difficulty:"challenge",hint:"Keep surviving as long as possible"},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:10},hint:"Collect XP and level up"},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:20},hint:"Keep grinding for XP"},level30:{id:"level30",name:"Powerhouse",description:"Reach level 30 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:30},hint:"Build becomes unstoppable"},level50:{id:"level50",name:"Unstoppable",description:"Reach level 50 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:50},hint:"Ultimate power achieved"},upgradeCollector:{id:"upgradeCollector",name:"Collector",description:"Have 15 upgrades at once",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect many different upgrades"},synergyMaster:{id:"synergyMaster",name:"Synergy Master",description:"Activate 3 synergies in one run",category:"upgrade",icon:"",unlocked:!1,difficulty:"challenge",hint:"Build for multiple synergy combos",unlocks:["trailRainbow"]},earn100:{id:"earn100",name:"Pocket Change",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:100},hint:"Play runs to earn credits"},earn500:{id:"earn500",name:"Savings Account",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:500},hint:"Keep earning and saving",unlocks:["glowGold"]},earn1000:{id:"earn1000",name:"Money Bags",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:1e3},hint:"A fortune awaits"},earn5000:{id:"earn5000",name:"Fortune",description:"Earn 5000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:5e3},hint:"Building an empire"},earn10000:{id:"earn10000",name:"Tycoon",description:"Earn 10000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:1e4},hint:"The ultimate collector"},bigSpender:{id:"bigSpender",name:"Big Spender",description:"Spend 1000 credits in the shop",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencySpent",value:1e3},hint:"Buy upgrades from the shop"},perfectFloor:{id:"perfectFloor",name:"Untouchable",description:"Clear a floor without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Dodge everything on an entire floor",unlocks:["glowVoid"]},speedRunner:{id:"speedRunner",name:"Speed Demon",description:"Clear Floor 3 in under 5 minutes",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Rush through the first 3 floors",unlocks:["glowElectric"]},bossRush:{id:"bossRush",name:"Boss Rush",description:"Defeat 3 bosses in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Reach and defeat multiple floor bosses"},noHitBoss:{id:"noHitBoss",name:"Flawless Victory",description:"Defeat a boss without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Perfect boss fight execution"},glassCannonWin:{id:"glassCannonWin",name:"Living Dangerously",description:"Defeat a boss while below 25% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Living dangerously pays off"},closeCall:{id:"closeCall",name:"Close Call",description:"Survive with 1 HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Get very close to death but survive",unlocks:["glowCrimson"]},pacifist:{id:"pacifist",name:"Pacifist Start",description:"Clear Room 1 without attacking",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Just dodge everything"},noDamageRoom:{id:"noDamageRoom",name:"Perfect Room",description:"Clear 5 rooms without damage in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Master your dodging skills"},kill5000:{id:"kill5000",name:"Exterminator",description:"Kill 5,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:5e3},hint:"A lifetime of combat"},kill10000:{id:"kill10000",name:"Annihilator",description:"Kill 10,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:1e4},hint:"The ultimate destroyer"},floor15:{id:"floor15",name:"Deep Delver",description:"Reach Floor 15",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:15},hint:"Go deeper than ever before"},floor20:{id:"floor20",name:"Abyssal",description:"Reach Floor 20",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:20},hint:"The final frontier"},rooms100:{id:"rooms100",name:"Room Master",description:"Clear 100 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRoomsCleared",value:100},hint:"Clear many rooms across all runs"},rooms500:{id:"rooms500",name:"Hall Walker",description:"Clear 500 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRoomsCleared",value:500},hint:"Keep exploring"},firstPickup:{id:"firstPickup",name:"Loot Goblin",description:"Collect your first pickup",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Pick up health, XP, or other items"},healingAddict:{id:"healingAddict",name:"Healing Addict",description:"Collect 50 health pickups",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalHealthPickups",value:50},hint:"Stay alive by healing"},xpHoarder:{id:"xpHoarder",name:"XP Hoarder",description:"Collect 1000 XP orbs",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalXpOrbs",value:1e3},hint:"Collect all those green orbs"},comeback:{id:"comeback",name:"Comeback King",description:"Win a room after being below 10% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Never give up!"}},so={normal:[200,200,200],challenge:[255,200,100],benchmark:[200,150,255]},Iu={normal:25,challenge:50,benchmark:100};function G0(e){return!e||e.unlocks&&e.unlocks.length>0?0:e.reward!==void 0?e.reward:Iu[e.difficulty]||Iu.normal}function Xw(e){return Object.values(No).filter(t=>t.category===e)}function qw(){const e=new Set;return Object.values(No).forEach(t=>e.add(t.category)),Array.from(e)}function K0(e){return No[e]||null}function qa(e,t){const n=No[e];if(!n||!n.threshold)return null;const o=t[n.threshold.stat]||0,i=n.threshold.value,s=Math.min(o/i,1);return{current:o,target:i,progress:s,percentage:Math.round(s*100)}}const ln={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"},bomber:{name:"The Bomber",description:"Explosive specialist, +50% blast radius, projectiles explode on hit",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"boss10"},char:"",color:[255,100,100],stats:{health:85,speed:130,damage:15},weapon:"launcher",ability:"explosiveShots"},engineer:{name:"The Engineer",description:"Support class, +2 orbital drones that auto-attack nearby enemies",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"level20"},char:"",color:[100,200,255],stats:{health:80,speed:140,damage:8},weapon:"pistol",ability:"orbitalDrones"},vampire:{name:"The Vampire",description:"Lifesteal specialist, +15% lifesteal, -20% max health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"kill1000"},char:"",color:[180,50,180],stats:{health:70,speed:160,damage:14},weapon:"smg",ability:"vampiric"},berserker:{name:"The Berserker",description:"Rage mode, +100% damage below 30% HP, takes +25% more damage",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"glassCannonWin"},char:"",color:[255,50,50],stats:{health:120,speed:140,damage:18},weapon:"shotgun",ability:"rage"},ghost:{name:"The Ghost",description:"Evasion master, +25% dodge chance, +15% crit, lower health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"perfectFloor"},char:"",color:[200,200,255],stats:{health:60,speed:180,damage:11},weapon:"smg",ability:"ethereal"}},V0={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0},spreadShot:{name:"Spread Shot",description:"Fires 3 projectiles in a cone, lower damage each",cost:250,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2}},boomerang:{name:"Boomerang Blaster",description:"Projectiles return, hitting enemies twice",cost:400,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},chainLightning:{name:"Chain Lightning",description:"Bounces to 3 nearby enemies, -20% per bounce",cost:500,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},railgun:{name:"Railgun",description:"Pierces ALL enemies in a line, 3s cooldown",cost:600,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4},requiredAchievement:"boss25"},homingMissiles:{name:"Homing Missiles",description:"Slower projectiles that track enemies",cost:700,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4}},plasmaRifle:{name:"Plasma Rifle",description:"High damage, penetrates 2 enemies",cost:800,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:5},requiredAchievement:"floor10"}},ys={trailNone:{name:"No Trail",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"trail"},trailFire:{name:"Fire Trail",description:"Leave a blazing trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[255,100,50],requiredAchievement:"kill100"},trailIce:{name:"Ice Trail",description:"Leave a frosty trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,200,255],requiredAchievement:"floor5"},trailPoison:{name:"Toxic Trail",description:"Leave a poisonous trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,255,100],requiredAchievement:"kill500"},trailShadow:{name:"Shadow Trail",description:"Leave a dark trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[80,50,120],requiredAchievement:"firstSynergy"},trailRainbow:{name:"Rainbow Trail",description:"Leave a colorful trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:"rainbow",requiredAchievement:"synergyMaster"},deathNone:{name:"Standard Death",description:"Default enemy death effect",cost:0,unlockedByDefault:!0,category:"death"},deathExplosion:{name:"Explosive Death",description:"Enemies explode dramatically",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"firstBoss"},deathDisintegrate:{name:"Disintegration",description:"Enemies crumble into particles",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"boss5"},deathVaporize:{name:"Vaporize",description:"Enemies vanish in a puff of smoke",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"killStreak10"},deathPixelate:{name:"Pixelate",description:"Enemies break into pixels",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"multikill"},deathFireworks:{name:"Fireworks",description:"Enemies burst like fireworks",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"floor10"},glowNone:{name:"No Glow",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"glow"},glowGold:{name:"Golden Aura",description:"Radiate a golden glow",cost:0,unlockedByDefault:!1,category:"glow",color:[255,200,50],requiredAchievement:"earn500"},glowCrimson:{name:"Crimson Aura",description:"Radiate a blood-red glow",cost:0,unlockedByDefault:!1,category:"glow",color:[200,50,50],requiredAchievement:"closeCall"},glowElectric:{name:"Electric Aura",description:"Crackle with electricity",cost:0,unlockedByDefault:!1,category:"glow",color:[100,150,255],requiredAchievement:"speedRunner"},glowVoid:{name:"Void Aura",description:"Emanate dark energy",cost:0,unlockedByDefault:!1,category:"glow",color:[50,0,80],requiredAchievement:"perfectFloor"}},W0={healthPack:{name:"Health Pack",description:"Start next run with +30 bonus HP",cost:30,consumable:!0,effect:{type:"startingHealth",value:30}},damageAmp:{name:"Damage Amp",description:"+25% damage for first floor",cost:35,consumable:!0,effect:{type:"tempDamage",value:.25,duration:"floor"}},speedSerum:{name:"Speed Serum",description:"+30% speed for first floor",cost:25,consumable:!0,effect:{type:"tempSpeed",value:.3,duration:"floor"}},wealthCharm:{name:"Wealth Charm",description:"+30% credits earned this run",cost:50,consumable:!0,effect:{type:"creditMultiplier",value:.3,duration:"run"}},luckyCoin:{name:"Lucky Coin",description:"+15% crit chance for first floor",cost:40,consumable:!0,effect:{type:"tempCrit",value:.15,duration:"floor"}},armorPlating:{name:"Armor Plating",description:"+20% damage reduction for first floor",cost:45,consumable:!0,effect:{type:"tempDefense",value:.2,duration:"floor"}},xpBooster:{name:"XP Booster",description:"+50% XP gained for first floor",cost:40,consumable:!0,effect:{type:"tempXP",value:.5,duration:"floor"}},emergencyRevive:{name:"Emergency Revive",description:"Auto-revive once at 25% HP",cost:75,consumable:!0,effect:{type:"autoRevive",value:.25,uses:1}}},Yw={startingHealth:{name:"Starting Health +10",description:"Start the show with +10 max health",cost:50,maxLevel:5,tier:1},startingDamage:{name:"Starting Damage +1",description:"Start the show with +1 damage",cost:75,maxLevel:5,tier:1},startingSpeed:{name:"Starting Speed +10",description:"Start the show with +10 speed",cost:60,maxLevel:5,tier:1},xpMagnet:{name:"XP Magnet",description:"+15% XP pickup radius per level",cost:60,maxLevel:5,tier:2},propDurability:{name:"Prop Durability",description:"Props last +2 seconds per level",cost:80,maxLevel:5,tier:2},propDropChance:{name:"Prop Drop Chance",description:"+5% prop drop chance per level",cost:100,maxLevel:5,tier:2},creditBonus:{name:"Credit Bonus",description:"+8% credits earned per level",cost:120,maxLevel:5,tier:2},luckyStart:{name:"Lucky Start",description:"+5% starting crit chance per level",cost:100,maxLevel:4,tier:3},thickSkin:{name:"Thick Skin",description:"+3% damage reduction per level",cost:100,maxLevel:5,tier:3},secondWind:{name:"Second Wind",description:"+5% revive health per level (up to 25%)",cost:150,maxLevel:4,tier:3},bossBounty:{name:"Boss Bounty",description:"+15 bonus credits per boss kill",cost:150,maxLevel:3,tier:3},mulligan:{name:"Mulligan",description:"+1 reroll per run for upgrade drafts",cost:300,maxLevel:3,tier:4},comfortZone:{name:"Comfort Zone",description:"+0.1s invulnerability after hit",cost:200,maxLevel:3,tier:4},toughChoices:{name:"Tough Choices",description:"+1 upgrade option in drafts (4 total)",cost:500,maxLevel:1,tier:4},headStart:{name:"Head Start",description:"Begin each run at level 2",cost:750,maxLevel:1,tier:4}};function Gw(e){switch(e){case"characters":return ln;case"weapons":return V0;case"permanentUpgrades":return Yw;case"cosmetics":return ys;case"boosters":return W0;default:return{}}}const $0="superSmashTexty_save",Kw="$",Jc={version:1,currency:0,playerName:null,inviteCode:null,totalXP:0,playerLevel:1,selectedPortrait:"default",unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[],portraits:["default"]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0,totalPlayTime:0,fastestRunTime:0},achievements:[],runHistory:[]},Pu=20;function vt(){try{const t=localStorage.getItem($0);if(t){const n=JSON.parse(t),o={...Jc,...n};return o.playerName||(o.playerName=$c(),gn(o)),o.inviteCode||(o.inviteCode=jc(),gn(o)),o}}catch(t){console.error("Error loading save:",t)}const e={...Jc};return e.playerName=$c(),e.inviteCode=jc(),gn(e),e}function gn(e){try{return localStorage.setItem($0,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function Vw(){return vt()}function xs(e){const t=vt();return t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+e),gn(t),t.currency}function Wi(){return vt().currency}function mo(e,t){const n=vt();return n.unlocks[e]&&n.unlocks[e].includes(t)}function j0(e,t){const n=vt();return n.unlocks[e]||(n.unlocks[e]=[]),n.unlocks[e].includes(t)?!1:(n.unlocks[e].push(t),gn(n),!0)}function Lu(e){vt();let t=!1;for(const[n,o]of Object.entries(ln))o.unlockRequirement&&o.unlockRequirement.type==="floor"&&e>=o.unlockRequirement.value&&(mo("characters",n)||(j0("characters",n),t=!0));return t}function Ww(e){let t=[];for(const[n,o]of Object.entries(ln))o.unlockRequirement&&o.unlockRequirement.type==="achievement"&&o.unlockRequirement.value===e&&(mo("characters",n)||(j0("characters",n),t.push({type:"character",key:n,name:o.name})));return t}function Qo(){return vt().selectedCharacter||"survivor"}function Ou(e){const t=vt();t.selectedCharacter=e,gn(t)}function zt(e){const t=vt();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function $w(e,t,n){const o=vt();return o.currency>=n?(o.currency-=n,o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)||o.unlocks[e].push(t),gn(o),!0):!1}function J0(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function jw(e,t,n){const o=vt(),i=zt(e);return n&&i>=n?{success:!1,reason:"maxLevel"}:o.currency<t?{success:!1,reason:"insufficientCurrency"}:(o.currency-=t,o.permanentUpgradeLevels||(o.permanentUpgradeLevels={}),o.permanentUpgradeLevels[e]=(i||0)+1,o.permanentUpgradePurchaseHistory||(o.permanentUpgradePurchaseHistory={}),o.permanentUpgradePurchaseHistory[e]||(o.permanentUpgradePurchaseHistory[e]=[]),o.permanentUpgradePurchaseHistory[e].push(t),o.unlocks.permanentUpgrades||(o.unlocks.permanentUpgrades=[]),o.unlocks.permanentUpgrades.includes(e)||o.unlocks.permanentUpgrades.push(e),gn(o),{success:!0,newLevel:o.permanentUpgradeLevels[e]})}function Jw(e,t){const n=vt();return n.currency<t?{success:!1,reason:"insufficientCurrency"}:(n.activeBoosters||(n.activeBoosters=[]),n.currency-=t,n.stats&&(n.stats.totalCurrencySpent=(n.stats.totalCurrencySpent||0)+t),n.activeBoosters.push({key:e,purchasedAt:Date.now()}),gn(n),{success:!0,boosterKey:e})}function Qw(){return(vt().activeBoosters||[]).length}function Zw(){const e=vt(),t=e.activeBoosters||[];return e.activeBoosters=[],gn(e),t}function Q0(){const e=vt();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(n=>{const o=e.permanentUpgradePurchaseHistory[n];o&&Array.isArray(o)&&o.forEach(i=>{t+=i})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(n=>{const o=e.permanentUpgradeLevels[n]||0;for(let i=0;i<o;i++)t+=J0(i)}),t}return 0}function kw(e){const t=vt(),n=zt(e);if(n===0)return{success:!1,reason:"noLevels"};let o=0;if(t.permanentUpgradePurchaseHistory&&t.permanentUpgradePurchaseHistory[e]&&t.permanentUpgradePurchaseHistory[e].length>0){const i=t.permanentUpgradePurchaseHistory[e];o=i[i.length-1],i.pop(),i.length===0&&delete t.permanentUpgradePurchaseHistory[e]}else o=J0(n-1);if(t.currency+=o,t.permanentUpgradeLevels[e]=n-1,t.permanentUpgradeLevels[e]===0&&(delete t.permanentUpgradeLevels[e],t.unlocks.permanentUpgrades)){const i=t.unlocks.permanentUpgrades.indexOf(e);i>-1&&t.unlocks.permanentUpgrades.splice(i,1)}return gn(t),{success:!0,refundAmount:o,newLevel:t.permanentUpgradeLevels[e]||0}}function eb(){const e=vt(),t=Q0();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),gn(e),{success:!0,refundAmount:t})}function kl(e){const t=vt();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),gn(t)}function Jd(e){const t=vt();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function tb(e){const t=vt();if(t.achievements||(t.achievements=[]),!t.achievements.includes(e)){t.achievements.push(e);const n=K0(e),o=G0(n);return o>0&&(t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+o),console.log(`[MetaProgression] Achievement "${e}" awarded ${o} credits`)),gn(t),Ww(e).then(i=>{i.length>0&&console.log("[MetaProgression] Achievement unlocked characters:",i)}),!0}return!1}function Z0(){return vt().achievements||[]}function Us(){return vt().stats||Jc.stats}function ec(e){let t=0;t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30);const n=zt("bossBounty");n>0&&e.bossesKilled>0&&(t+=e.bossesKilled*n*15);const o=zt("creditBonus");return o>0&&(t=Math.floor(t*(1+o*.08))),Math.floor(t)}function Tl(){return Kw}function Yn(){return vt().playerName||"Player"}function Nu(e){const t=vt();return t.playerName=e,gn(t),t.playerName}function vi(){return vt().inviteCode||"000000"}function nb(e){const t=vt();return t.inviteCode=e,gn(t),t.inviteCode}function ob(e){const t=vt();t.runHistory||(t.runHistory=[]);const n={timestamp:Date.now(),character:e.character||"survivor",weapon:e.weapon||"pistol",floorsReached:e.floorsReached||1,roomsCleared:e.roomsCleared||0,enemiesKilled:e.enemiesKilled||0,bossesKilled:e.bossesKilled||0,level:e.level||1,currencyEarned:e.currencyEarned||0,duration:e.duration||0,deathCause:e.deathCause||"Unknown",upgrades:e.upgrades||[],synergies:e.synergies||[]};return t.runHistory.unshift(n),t.runHistory.length>Pu&&(t.runHistory=t.runHistory.slice(0,Pu)),gn(t),n}function ib(){return vt().runHistory||[]}function sb(e){const t=vt();return t.equippedCosmetics&&t.equippedCosmetics[e]||(e==="trail"?"trailNone":e==="death"?"deathNone":"glowNone")}function Bu(e,t){const n=vt();return n.equippedCosmetics||(n.equippedCosmetics={trail:"trailNone",death:"deathNone",glow:"glowNone"}),!t.includes("None")&&!mo("cosmetics",t)?!1:(n.equippedCosmetics[e]=t,gn(n),!0)}function rb(){return vt().equippedCosmetics||{trail:"trailNone",death:"deathNone",glow:"glowNone"}}function Ya(e){return Math.floor(Math.sqrt(e/100))+1}function Qc(e){return e<=1?0:Math.pow(e-1,2)*100}function _i(){const e=vt();return Ya(e.totalXP||0)}function Ml(){return vt().totalXP||0}function k0(){const e=_i();return Qc(e+1)}function Qd(){const e=Ml(),t=Ya(e),n=Qc(t),o=Qc(t+1);return o===n?1:(e-n)/(o-n)}function ab(e){const t=vt(),n=Ya(t.totalXP||0);t.totalXP=(t.totalXP||0)+e;const o=Ya(t.totalXP);return t.playerLevel=o,gn(t),{newXP:t.totalXP,newLevel:o,levelsGained:o-n,oldLevel:n}}function lb(e){let t=0;return t+=e.floorsReached*50,t+=(e.enemiesKilled||0)*2,t+=(e.bossesKilled||0)*100,e.floorsReached>=5&&(t+=200),e.isDailyRun&&(t+=500),t}function Fs(){return vt().selectedPortrait||"default"}function cb(e){const t=vt();return t.selectedPortrait=e,gn(t),!0}function eg(){return vt().unlocks?.portraits||["default"]}const db=.15,Ga=120,Hu=50,li=.5,fa=.7,te={systemInitialized:!1,touchInitialized:!1,gamepadConnected:!1,gamepadIndex:null,moveX:0,moveY:0,aimX:0,aimY:0,aimActive:!1,touchEnabled:!1,leftTouch:null,rightTouch:null,leftJoystickCenter:null,rightJoystickCenter:null,leftJoystickBase:null,leftJoystickKnob:null,rightJoystickBase:null,rightJoystickKnob:null,k:null};function pa(e,t=db){return Math.abs(e)<t?0:(e>0?1:-1)*(Math.abs(e)-t)/(1-t)}function hb(e){if(te.k=e,te.systemInitialized)return;te.systemInitialized=!0,window.addEventListener("gamepadconnected",n=>{console.log("[InputSystem] Gamepad connected:",n.gamepad.id),te.gamepadConnected=!0,te.gamepadIndex=n.gamepad.index}),window.addEventListener("gamepaddisconnected",n=>{console.log("[InputSystem] Gamepad disconnected:",n.gamepad.id),n.gamepad.index===te.gamepadIndex&&(te.gamepadConnected=!1,te.gamepadIndex=null)});const t=navigator.getGamepads();for(let n=0;n<t.length;n++)if(t[n]){console.log("[InputSystem] Found existing gamepad:",t[n].id),te.gamepadConnected=!0,te.gamepadIndex=t[n].index;break}te.touchEnabled="ontouchstart"in window||navigator.maxTouchPoints>0,console.log("[InputSystem] Initialized. Gamepad:",te.gamepadConnected,"Touch:",te.touchEnabled)}function ub(){if(!te.gamepadConnected||te.gamepadIndex===null)return;const t=navigator.getGamepads()[te.gamepadIndex];if(!t){te.gamepadConnected=!1,te.gamepadIndex=null;return}te.moveX=pa(t.axes[0]||0),te.moveY=pa(t.axes[1]||0);const n=pa(t.axes[2]||0),o=pa(t.axes[3]||0);te.aimX=n,te.aimY=o,te.aimActive=Math.abs(n)>0||Math.abs(o)>0}function fb(e){if(!te.touchEnabled)return;if(yb(),te.touchInitialized){zu(e);return}te.touchInitialized=!0,zu(e);const t=e.canvas;t.addEventListener("touchstart",pb,{passive:!1}),t.addEventListener("touchmove",gb,{passive:!1}),t.addEventListener("touchend",Uu,{passive:!1}),t.addEventListener("touchcancel",Uu,{passive:!1}),console.log("[InputSystem] Touch controls initialized")}function zu(e){const t=e.width(),n=e.height(),o=t*.15,i=n*.75,s=t*.85,r=n*.75;te.leftJoystickBase=e.add([e.circle(Ga/2),e.pos(o,i),e.anchor("center"),e.color(100,100,100),e.opacity(li),e.fixed(),e.z(1e3),"touchJoystick"]),te.leftJoystickKnob=e.add([e.circle(Hu/2),e.pos(o,i),e.anchor("center"),e.color(200,200,200),e.opacity(li),e.fixed(),e.z(1001),"touchJoystick"]),te.rightJoystickBase=e.add([e.circle(Ga/2),e.pos(s,r),e.anchor("center"),e.color(100,100,100),e.opacity(li),e.fixed(),e.z(1e3),"touchJoystick"]),te.rightJoystickKnob=e.add([e.circle(Hu/2),e.pos(s,r),e.anchor("center"),e.color(255,100,100),e.opacity(li),e.fixed(),e.z(1001),"touchJoystick"]),te.leftJoystickCenter={x:o,y:i},te.rightJoystickCenter={x:s,y:r}}function pb(e){e.preventDefault();const t=te.k,n=t.canvas.getBoundingClientRect(),o=t.width()/n.width,i=t.height()/n.height;for(const s of e.changedTouches){const r=(s.clientX-n.left)*o,l=(s.clientY-n.top)*i;r<t.width()/2&&te.leftTouch===null?(te.leftTouch=s.identifier,te.leftJoystickCenter={x:r,y:l},te.leftJoystickBase&&(te.leftJoystickBase.pos.x=r,te.leftJoystickBase.pos.y=l,te.leftJoystickBase.opacity=fa),te.leftJoystickKnob&&(te.leftJoystickKnob.pos.x=r,te.leftJoystickKnob.pos.y=l,te.leftJoystickKnob.opacity=fa)):r>=t.width()/2&&te.rightTouch===null&&(te.rightTouch=s.identifier,te.rightJoystickCenter={x:r,y:l},te.rightJoystickBase&&(te.rightJoystickBase.pos.x=r,te.rightJoystickBase.pos.y=l,te.rightJoystickBase.opacity=fa),te.rightJoystickKnob&&(te.rightJoystickKnob.pos.x=r,te.rightJoystickKnob.pos.y=l,te.rightJoystickKnob.opacity=fa),te.aimActive=!0)}}function gb(e){e.preventDefault();const t=te.k,n=t.canvas.getBoundingClientRect(),o=t.width()/n.width,i=t.height()/n.height;for(const s of e.changedTouches){const r=(s.clientX-n.left)*o,l=(s.clientY-n.top)*i;if(s.identifier===te.leftTouch&&te.leftJoystickCenter){const c=r-te.leftJoystickCenter.x,d=l-te.leftJoystickCenter.y,a=Math.sqrt(c*c+d*d),h=Ga/2,u=Math.min(a,h),p=Math.atan2(d,c);te.leftJoystickKnob&&(te.leftJoystickKnob.pos.x=te.leftJoystickCenter.x+Math.cos(p)*u,te.leftJoystickKnob.pos.y=te.leftJoystickCenter.y+Math.sin(p)*u);const g=u/h;te.moveX=Math.cos(p)*g,te.moveY=Math.sin(p)*g}if(s.identifier===te.rightTouch&&te.rightJoystickCenter){const c=r-te.rightJoystickCenter.x,d=l-te.rightJoystickCenter.y,a=Math.sqrt(c*c+d*d),h=Ga/2,u=Math.min(a,h),p=Math.atan2(d,c);te.rightJoystickKnob&&(te.rightJoystickKnob.pos.x=te.rightJoystickCenter.x+Math.cos(p)*u,te.rightJoystickKnob.pos.y=te.rightJoystickCenter.y+Math.sin(p)*u);const g=u/h;te.aimX=Math.cos(p)*g,te.aimY=Math.sin(p)*g,te.aimActive=g>.1}}}function Uu(e){e.preventDefault();for(const t of e.changedTouches)t.identifier===te.leftTouch&&(te.leftTouch=null,te.moveX=0,te.moveY=0,te.leftJoystickKnob&&te.leftJoystickCenter&&(te.leftJoystickKnob.pos.x=te.leftJoystickCenter.x,te.leftJoystickKnob.pos.y=te.leftJoystickCenter.y),te.leftJoystickBase&&(te.leftJoystickBase.opacity=li),te.leftJoystickKnob&&(te.leftJoystickKnob.opacity=li)),t.identifier===te.rightTouch&&(te.rightTouch=null,te.aimX=0,te.aimY=0,te.aimActive=!1,te.rightJoystickKnob&&te.rightJoystickCenter&&(te.rightJoystickKnob.pos.x=te.rightJoystickCenter.x,te.rightJoystickKnob.pos.y=te.rightJoystickCenter.y),te.rightJoystickBase&&(te.rightJoystickBase.opacity=li),te.rightJoystickKnob&&(te.rightJoystickKnob.opacity=li))}function mb(){return{x:te.moveX,y:te.moveY}}function Fu(){return{x:te.aimX,y:te.aimY,active:te.aimActive}}function yb(){const e=te.k;if(e){try{e.get("touchJoystick").forEach(t=>{t&&t.exists()&&e.destroy(t)})}catch{}te.leftJoystickBase=null,te.leftJoystickKnob=null,te.rightJoystickBase=null,te.rightJoystickKnob=null,te.leftTouch=null,te.rightTouch=null,te.moveX=0,te.moveY=0,te.aimX=0,te.aimY=0,te.aimActive=!1}}const Zc={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]},boomerang:{name:"Boomerang Blaster",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:250,baseDamage:14,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,returnsToPlayer:!0,returnSpeedMultiplier:1.2,category:"multiTarget",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},railgun:{name:"Railgun",icon:"",char:"",color:[150,200,255],fireRate:.33,projectileSpeed:800,baseDamage:50,projectileCount:1,spreadAngle:0,piercing:999,obstaclePiercing:1,critChance:.1,critDamage:3,range:1e3,infinitePierce:!0,category:"precision",upgradeCategories:["damage","crit","critDamage","fireRate","obstaclePiercing"]},spreadShot:{name:"Spread Shot",icon:"",char:"",color:[255,180,100],fireRate:2.5,projectileSpeed:280,baseDamage:6,projectileCount:3,spreadAngle:25,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:450,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},homingMissiles:{name:"Homing Missiles",icon:"",char:"",color:[255,100,150],fireRate:1.5,projectileSpeed:180,baseDamage:18,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,homing:!0,homingStrength:3,category:"precision",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},plasmaRifle:{name:"Plasma Rifle",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:350,baseDamage:16,projectileCount:1,spreadAngle:0,piercing:2,obstaclePiercing:0,critChance:.08,critDamage:2.2,range:650,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]}};function tg(e){return Zc[e]||Zc.pistol}function xb(e,t){return tg(e).upgradeCategories.includes(t)}const Zs={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},_o={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},Do={BASE_XP_TO_NEXT_LEVEL:15,XP_SCALING_FACTOR:1.25,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},ni={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},Dn={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},As={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},rn={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:800,MAGNETIZE_ACCELERATION:600,COLLECTION_RADIUS:20};function tc(e,t=0,n=0){const o=e*(1-n);return Math.max(Dn.MIN_DAMAGE,o-t)}function vb(e,t=null){return(t?t.next():Math.random())<e}function wb(e,t=2){return Math.floor(e*t)}function nc(e,t,n,o=null){const i=o||Qo(),s=ln[i]||ln.survivor,r=e.add([e.text(s.char,{size:24}),e.pos(t,n),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.rotate(0),e.z(-1),"playerOutline"]),l=e.add([e.text(s.char,{size:24}),e.pos(t,n),e.anchor("center"),e.color(...s.color),e.rotate(0),e.area(),e.health(s.stats.health),"player"]);l.outline=r,l.characterKey=i,l.characterData=s,l.speed=s.stats.speed,l.originalSpeed=s.stats.speed,l.slowed=!1,l.maxHealth=s.stats.health;const c=zt("headStart");l.level=c>0?2:Do.STARTING_LEVEL,l.xp=Do.STARTING_XP,l.xpToNext=Do.BASE_XP_TO_NEXT_LEVEL,l.pickupRadius=_o.BASE_PICKUP_RADIUS,l.invulnerable=!1,l.invulnerableTime=0,l.invulnerableDuration=_o.INVULNERABILITY_DURATION,l.setHP(l.maxHealth);const d=s.weapon||"pistol",a=tg(d);l.weaponKey=d,l.weaponDef=a,l.baseFireRate=a.fireRate,l.baseProjectileSpeed=a.projectileSpeed,l.baseProjectileDamage=a.baseDamage;const h=s.stats.damage||10,u=a.baseDamage,p=h/10;if(l.fireRate=a.fireRate,l.projectileSpeed=a.projectileSpeed,l.projectileDamage=Math.floor(u*p),l.lastFireTime=0,l.projectileCount=a.projectileCount,l.piercing=a.piercing,l.obstaclePiercing=a.obstaclePiercing,l.critChance=a.critChance,l.critDamage=a.critDamage,l.spreadAngle=a.spreadAngle,l.defense=0,l.weaponRange=a.range,l.weaponCategory=a.category,a.orbitRadius&&(l.orbitRadius=a.orbitRadius,l.rotationSpeed=a.rotationSpeed,l.orbitalOrbs=[],l.orbitalAngles=[]),a.explosionRadius&&(l.explosionRadius=a.explosionRadius,l.explosionDamage=a.explosionDamage),a.chainRange&&(l.chainRange=a.chainRange,l.maxJumps=a.maxJumps,l.chainDamageReduction=a.chainDamageReduction),l.xpMultiplier=1,l.dodgeChance=0,l.damageReduction=0,l.weapons=[d],l.passiveUpgrades=[],l.upgradeStacks={},s.ability==="xpBoost"?l.xpMultiplier=ni.SURVIVOR_XP_BOOST:s.ability==="speedBoost"?(l.speed=l.speed*ni.SCOUT_SPEED_BOOST,l.originalSpeed=l.speed,l.dodgeChance=ni.SCOUT_DODGE_CHANCE):s.ability==="tankStats"?(l.maxHealth=Math.floor(l.maxHealth*ni.TANK_HEALTH_BOOST),l.setHP(l.maxHealth),l.damageReduction=ni.TANK_DAMAGE_REDUCTION):s.ability==="critBoost"?(l.critChance=(l.critChance||0)*ni.SNIPER_CRIT_CHANCE_MULTIPLIER,l.critDamage=(l.critDamage||2)*ni.SNIPER_CRIT_DAMAGE_MULTIPLIER):s.ability==="fireDot"&&(l.fireDotMultiplier=ni.PYRO_FIRE_DOT_MULTIPLIER),!s.skipPermanentUpgrades){const R=zt("luckyStart");R>0&&(l.critChance=(l.critChance||0)+R*.05);const f=zt("thickSkin");f>0&&(l.damageReduction=(l.damageReduction||0)+f*.03);const N=zt("xpMagnet");N>0&&(l.pickupRadius=Math.floor(l.pickupRadius*(1+N*.15)));const b=zt("comfortZone");b>0&&(l.invulnerableDuration=l.invulnerableDuration+b*.1)}l.canMove=!0,l.canShoot=!0,l.isDead=!1;let g=e.vec2(0,0),A=document.hasFocus(),m={w:!1,s:!1,a:!1,d:!1,up:!1,down:!1,left:!1,right:!1};l.moveDir=g,e.onKeyDown(["w","up"],()=>{l.isRemote||!A||m.w||m.up||(g.y=-1,l.moveDir=g)}),e.onKeyDown(["s","down"],()=>{l.isRemote||!A||m.s||m.down||(g.y=1,l.moveDir=g)}),e.onKeyDown(["a","left"],()=>{l.isRemote||!A||m.a||m.left||(g.x=-1,l.moveDir=g)}),e.onKeyDown(["d","right"],()=>{l.isRemote||!A||m.d||m.right||(g.x=1,l.moveDir=g)}),e.onKeyRelease(["w","up"],()=>{l.isRemote||(m.w=!1,m.up=!1,!e.isKeyDown("s")&&!e.isKeyDown("down")&&(g.y=0,l.moveDir=g))}),e.onKeyRelease(["s","down"],()=>{l.isRemote||(m.s=!1,m.down=!1,!e.isKeyDown("w")&&!e.isKeyDown("up")&&(g.y=0,l.moveDir=g))}),e.onKeyRelease(["a","left"],()=>{l.isRemote||(m.a=!1,m.left=!1,!e.isKeyDown("d")&&!e.isKeyDown("right")&&(g.x=0,l.moveDir=g))}),e.onKeyRelease(["d","right"],()=>{l.isRemote||(m.d=!1,m.right=!1,!e.isKeyDown("a")&&!e.isKeyDown("left")&&(g.x=0,l.moveDir=g))});const C=()=>{l.isRemote||(A=!1,g.x=0,g.y=0,l.moveDir=g,l.isShooting=!1,m={w:e.isKeyDown("w"),s:e.isKeyDown("s"),a:e.isKeyDown("a"),d:e.isKeyDown("d"),up:e.isKeyDown("up"),down:e.isKeyDown("down"),left:e.isKeyDown("left"),right:e.isKeyDown("right")})},I=()=>{A=!0};return window.addEventListener("blur",C),window.addEventListener("focus",I),l.onDestroy(()=>{window.removeEventListener("blur",C),window.removeEventListener("focus",I)}),l.onUpdate(()=>{if(l.outline&&l.outline.exists()&&(l.outline.pos=l.pos.clone()),e.paused)return;if(l.invulnerable)if(l.invulnerableTime-=e.dt(),l.invulnerableTime<=0)l.invulnerable=!1,l.color=e.rgb(..._o.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1);else{const T=_o.IMMUNITY_FLASH_RATE;Math.floor(l.invulnerableTime*T)%2===0?(l.color=e.rgb(..._o.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1)):(l.color=e.rgb(..._o.NORMAL_COLOR,_o.IMMUNITY_ALPHA),l.outline&&l.outline.exists()&&(l.outline.opacity=_o.IMMUNITY_ALPHA))}if(l.canMove===!1)return;ub();let R=g;if(l.isRemote&&l.move)R=e.vec2(l.move.x,l.move.y);else if(!l.isRemote){const T=mb();(T.x!==0||T.y!==0)&&(R=e.vec2(T.x,T.y))}if(R.len()>0){const T=R.len(),M=R.scale(1/T).scale(l.speed*e.dt()),_=l.pos.x+M.x,O=l.pos.y+M.y;let P=!0,z=!0;const U=e.get("obstacle"),F=_o.COLLISION_SIZE;for(const B of U){if(!B.exists())continue;const D=B.pos.x-B.width/2,q=B.pos.x+B.width/2,G=B.pos.y-B.height/2,Z=B.pos.y+B.height/2,le=_-F,ie=_+F,oe=l.pos.y-F,se=l.pos.y+F;ie>D&&le<q&&se>G&&oe<Z&&(P=!1);const he=l.pos.x-F,Me=l.pos.x+F,He=O-F,we=O+F;Me>D&&he<q&&we>G&&He<Z&&(z=!1)}P&&(l.pos.x=_),z&&(l.pos.y=O)}const f=e.width(),N=e.height(),b=_o.ROOM_MARGIN;l.pos.x=e.clamp(l.pos.x,b,f-b),l.pos.y=e.clamp(l.pos.y,b,N-b)}),l}const Be={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function Zd(e,t=!0){return new Promise((n,o)=>{if(Be.isInitialized){console.warn("Network already initialized"),n(e);return}if(window.addEventListener("beforeunload",()=>{kd()}),typeof Peer>"u"){console.error("PeerJS library not loaded"),o(new Error("PeerJS library not available"));return}Be.isHost=t;const i=t?`smash-${e}`:void 0,s={debug:2,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.relay.metered.ca:80"},{urls:"turn:global.relay.metered.ca:80",username:"e7312c28f330eeb65ba0d000",credential:"CWfp+/uh3V/hKus3"},{urls:"turn:global.relay.metered.ca:80?transport=tcp",username:"e7312c28f330eeb65ba0d000",credential:"CWfp+/uh3V/hKus3"},{urls:"turn:global.relay.metered.ca:443",username:"e7312c28f330eeb65ba0d000",credential:"CWfp+/uh3V/hKus3"},{urls:"turns:global.relay.metered.ca:443?transport=tcp",username:"e7312c28f330eeb65ba0d000",credential:"CWfp+/uh3V/hKus3"}],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}};try{Be.peer=new Peer(i,s),Be.peer.on("open",r=>{Be.peerId=r,Be.isInitialized=!0;const l=t&&r.startsWith("smash-")?r.substring(6):r;n(l)}),Be.peer.on("error",r=>{if(console.error("Peer error:",r),r.type==="unavailable-id"&&t){if(console.warn("Peer ID already taken - generating new code and retrying..."),Be.peer){try{Be.peer.destroy()}catch(l){console.warn("Error destroying peer:",l)}Be.peer=null,Be.peerId=null,Be.isInitialized=!1}setTimeout(()=>{const l=jc();Zd(l,t).then(n).catch(o)},2e3);return}r.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):r.type==="peer-unavailable"?console.warn("Host not found - check invite code"):r.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),Be.isInitialized||o(new Error(`Multiplayer unavailable: ${r.type||"connection failed"}`))}),t&&Be.peer.on("connection",r=>{bb(r)})}catch(r){console.error("Failed to create peer:",r),o(r)}})}function bb(e){Be.isHost&&(e.on("open",()=>{Be.connections.set(e.peer,e),Be.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{ng(t,e.peer)}),e.on("close",()=>{Be.connections.delete(e.peer),Be.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function Eb(e){return new Promise((t,n)=>{if(Be.isHost){n(new Error("Host cannot connect to another host"));return}if(!Be.isInitialized){n(new Error("Network not initialized"));return}const o=`smash-${e}`;let i,s=!1;const r=Be.peer.connect(o,{reliable:!0,serialization:"json"});i=setTimeout(()=>{s||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),r.close(),n(new Error("Connection timeout - could not reach host")))},3e4),r.on("open",()=>{s=!0,clearTimeout(i),i=null,Be.hostConnection=r,Be.hostId=o,t()}),r.on("data",l=>{ng(l,o)}),r.on("close",()=>{i&&(clearTimeout(i),i=null),Be.hostConnection=null,Be.hostId=null,Be.connectionCallbacks.forEach(l=>l("host_disconnect"))}),r.on("error",l=>{s=!0,clearTimeout(i),i=null,console.error("[NetworkSystem] Connection error:",l),console.error("[NetworkSystem] Error type:",l.type||"unknown"),n(l)})})}function ng(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const n=Be.messageHandlers.get(e.type);n?n(e.payload,t):console.warn("No handler for message type:",e.type)}function Ue(e,t){Be.messageHandlers.set(e,t)}function Xt(e){Be.messageHandlers.delete(e)}function og(e){Be.connectionCallbacks.includes(e)||Be.connectionCallbacks.push(e)}function Ln(e,t){if(Be.isHost){console.warn("Host cannot send to itself");return}if(!Be.hostConnection){console.warn("Not connected to host");return}Be.hostConnection.send({type:e,payload:t})}function yo(e,t,n){if(!Be.isHost){console.warn("Only host can send to specific peers");return}const o=Be.connections.get(e);o?o.send({type:t,payload:n}):console.warn("No connection to peer:",e)}function Je(e,t,n=[]){if(!Be.isHost){console.warn("Only host can broadcast");return}Be.connections.forEach((o,i)=>{n.includes(i)||o.send({type:e,payload:t})})}function kd(){Be.isHost?(Be.connections.forEach(e=>e.close()),Be.connections.clear()):Be.hostConnection&&(Be.hostConnection.close(),Be.hostConnection=null,Be.hostId=null),Be.peer&&(Be.peer.destroy(),Be.peer=null),Be.messageHandlers.clear(),Be.connectionCallbacks=[],Be.isInitialized=!1,Be.peerId=null}function Sb(){const e=Be.peerId&&Be.peerId.startsWith("smash-")?Be.peerId.substring(6):Be.peerId;return{isInitialized:Be.isInitialized,isHost:Be.isHost,peerId:e,hostId:Be.hostId,connectedPeers:Array.from(Be.connections.keys()),peerCount:Be.connections.size}}var Xu={};const ig={NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"};const ye=function(e,t){if(!e)throw Xs(t)},Xs=function(e){return new Error("Firebase Database ("+ig.SDK_VERSION+") INTERNAL ASSERT FAILED: "+e)};const sg=function(e){const t=[];let n=0;for(let o=0;o<e.length;o++){let i=e.charCodeAt(o);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):(i&64512)===55296&&o+1<e.length&&(e.charCodeAt(o+1)&64512)===56320?(i=65536+((i&1023)<<10)+(e.charCodeAt(++o)&1023),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128)}return t},Cb=function(e){const t=[];let n=0,o=0;for(;n<e.length;){const i=e[n++];if(i<128)t[o++]=String.fromCharCode(i);else if(i>191&&i<224){const s=e[n++];t[o++]=String.fromCharCode((i&31)<<6|s&63)}else if(i>239&&i<365){const s=e[n++],r=e[n++],l=e[n++],c=((i&7)<<18|(s&63)<<12|(r&63)<<6|l&63)-65536;t[o++]=String.fromCharCode(55296+(c>>10)),t[o++]=String.fromCharCode(56320+(c&1023))}else{const s=e[n++],r=e[n++];t[o++]=String.fromCharCode((i&15)<<12|(s&63)<<6|r&63)}}return t.join("")},eh={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,o=[];for(let i=0;i<e.length;i+=3){const s=e[i],r=i+1<e.length,l=r?e[i+1]:0,c=i+2<e.length,d=c?e[i+2]:0,a=s>>2,h=(s&3)<<4|l>>4;let u=(l&15)<<2|d>>6,p=d&63;c||(p=64,r||(u=64)),o.push(n[a],n[h],n[u],n[p])}return o.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(sg(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):Cb(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,o=[];for(let i=0;i<e.length;){const s=n[e.charAt(i++)],l=i<e.length?n[e.charAt(i)]:0;++i;const d=i<e.length?n[e.charAt(i)]:64;++i;const h=i<e.length?n[e.charAt(i)]:64;if(++i,s==null||l==null||d==null||h==null)throw new _b;const u=s<<2|l>>4;if(o.push(u),d!==64){const p=l<<4&240|d>>2;if(o.push(p),h!==64){const g=d<<6&192|h;o.push(g)}}}return o},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class _b extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const rg=function(e){const t=sg(e);return eh.encodeByteArray(t,!0)},Ka=function(e){return rg(e).replace(/\./g,"")},kc=function(e){try{return eh.decodeString(e,!0)}catch(t){console.error("base64Decode failed: ",t)}return null};function Ab(e){return ag(void 0,e)}function ag(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:const n=t;return new Date(n.getTime());case Object:e===void 0&&(e={});break;case Array:e=[];break;default:return t}for(const n in t)!t.hasOwnProperty(n)||!Tb(n)||(e[n]=ag(e[n],t[n]));return e}function Tb(e){return e!=="__proto__"}function Mb(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}const Rb=()=>Mb().__FIREBASE_DEFAULTS__,Db=()=>{if(typeof process>"u"||typeof Xu>"u")return;const e=Xu.__FIREBASE_DEFAULTS__;if(e)return JSON.parse(e)},Ib=()=>{if(typeof document>"u")return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const t=e&&kc(e[1]);return t&&JSON.parse(t)},lg=()=>{try{return Rb()||Db()||Ib()}catch(e){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`);return}},Pb=e=>{var t,n;return(n=(t=lg())===null||t===void 0?void 0:t.emulatorHosts)===null||n===void 0?void 0:n[e]},Lb=e=>{const t=Pb(e);if(!t)return;const n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const o=parseInt(t.substring(n+1),10);return t[0]==="["?[t.substring(1,n-1),o]:[t.substring(0,n),o]},cg=()=>{var e;return(e=lg())===null||e===void 0?void 0:e.config};class Yo{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((t,n)=>{this.resolve=t,this.reject=n})}wrapCallback(t){return(n,o)=>{n?this.reject(n):this.resolve(o),typeof t=="function"&&(this.promise.catch(()=>{}),t.length===1?t(n):t(n,o))}}}function Ob(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n={alg:"none",type:"JWT"},o=t||"demo-project",i=e.iat||0,s=e.sub||e.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const r=Object.assign({iss:`https://securetoken.google.com/${o}`,aud:o,iat:i,exp:i+3600,auth_time:i,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},e);return[Ka(JSON.stringify(n)),Ka(JSON.stringify(r)),""].join(".")}function Nb(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function dg(){return typeof window<"u"&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Nb())}function Bb(){return typeof navigator=="object"&&navigator.product==="ReactNative"}function Hb(){return ig.NODE_ADMIN===!0}function zb(){try{return typeof indexedDB=="object"}catch{return!1}}function Ub(){return new Promise((e,t)=>{try{let n=!0;const o="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(o);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(o),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{var s;t(((s=i.error)===null||s===void 0?void 0:s.message)||"")}}catch(n){t(n)}})}const Fb="FirebaseError";class Qr extends Error{constructor(t,n,o){super(n),this.code=t,this.customData=o,this.name=Fb,Object.setPrototypeOf(this,Qr.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,hg.prototype.create)}}class hg{constructor(t,n,o){this.service=t,this.serviceName=n,this.errors=o}create(t,...n){const o=n[0]||{},i=`${this.service}/${t}`,s=this.errors[t],r=s?Xb(s,o):"Error",l=`${this.serviceName}: ${r} (${i}).`;return new Qr(i,l,o)}}function Xb(e,t){return e.replace(qb,(n,o)=>{const i=t[o];return i!=null?String(i):`<${o}?>`})}const qb=/\{\$([^}]+)}/g;function Lr(e){return JSON.parse(e)}function En(e){return JSON.stringify(e)}const ug=function(e){let t={},n={},o={},i="";try{const s=e.split(".");t=Lr(kc(s[0])||""),n=Lr(kc(s[1])||""),i=s[2],o=n.d||{},delete n.d}catch{}return{header:t,claims:n,data:o,signature:i}},Yb=function(e){const t=ug(e),n=t.claims;return!!n&&typeof n=="object"&&n.hasOwnProperty("iat")},Gb=function(e){const t=ug(e).claims;return typeof t=="object"&&t.admin===!0};function Bo(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Ts(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]}function ed(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function Va(e,t,n){const o={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(o[i]=t.call(n,e[i],i,e));return o}function td(e,t){if(e===t)return!0;const n=Object.keys(e),o=Object.keys(t);for(const i of n){if(!o.includes(i))return!1;const s=e[i],r=t[i];if(qu(s)&&qu(r)){if(!td(s,r))return!1}else if(s!==r)return!1}for(const i of o)if(!n.includes(i))return!1;return!0}function qu(e){return e!==null&&typeof e=="object"}function Kb(e){const t=[];for(const[n,o]of Object.entries(e))Array.isArray(o)?o.forEach(i=>{t.push(encodeURIComponent(n)+"="+encodeURIComponent(i))}):t.push(encodeURIComponent(n)+"="+encodeURIComponent(o));return t.length?"&"+t.join("&"):""}class Vb{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let t=1;t<this.blockSize;++t)this.pad_[t]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(t,n){n||(n=0);const o=this.W_;if(typeof t=="string")for(let h=0;h<16;h++)o[h]=t.charCodeAt(n)<<24|t.charCodeAt(n+1)<<16|t.charCodeAt(n+2)<<8|t.charCodeAt(n+3),n+=4;else for(let h=0;h<16;h++)o[h]=t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3],n+=4;for(let h=16;h<80;h++){const u=o[h-3]^o[h-8]^o[h-14]^o[h-16];o[h]=(u<<1|u>>>31)&4294967295}let i=this.chain_[0],s=this.chain_[1],r=this.chain_[2],l=this.chain_[3],c=this.chain_[4],d,a;for(let h=0;h<80;h++){h<40?h<20?(d=l^s&(r^l),a=1518500249):(d=s^r^l,a=1859775393):h<60?(d=s&r|l&(s|r),a=2400959708):(d=s^r^l,a=3395469782);const u=(i<<5|i>>>27)+d+c+a+o[h]&4294967295;c=l,l=r,r=(s<<30|s>>>2)&4294967295,s=i,i=u}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+s&4294967295,this.chain_[2]=this.chain_[2]+r&4294967295,this.chain_[3]=this.chain_[3]+l&4294967295,this.chain_[4]=this.chain_[4]+c&4294967295}update(t,n){if(t==null)return;n===void 0&&(n=t.length);const o=n-this.blockSize;let i=0;const s=this.buf_;let r=this.inbuf_;for(;i<n;){if(r===0)for(;i<=o;)this.compress_(t,i),i+=this.blockSize;if(typeof t=="string"){for(;i<n;)if(s[r]=t.charCodeAt(i),++r,++i,r===this.blockSize){this.compress_(s),r=0;break}}else for(;i<n;)if(s[r]=t[i],++r,++i,r===this.blockSize){this.compress_(s),r=0;break}}this.inbuf_=r,this.total_+=n}digest(){const t=[];let n=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let i=this.blockSize-1;i>=56;i--)this.buf_[i]=n&255,n/=256;this.compress_(this.buf_);let o=0;for(let i=0;i<5;i++)for(let s=24;s>=0;s-=8)t[o]=this.chain_[i]>>s&255,++o;return t}}function Ms(e,t){return`${e} failed: ${t} argument `}const Wb=function(e){const t=[];let n=0;for(let o=0;o<e.length;o++){let i=e.charCodeAt(o);if(i>=55296&&i<=56319){const s=i-55296;o++,ye(o<e.length,"Surrogate pair missing trail surrogate.");const r=e.charCodeAt(o)-56320;i=65536+(s<<10)+r}i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):i<65536?(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128)}return t},Rl=function(e){let t=0;for(let n=0;n<e.length;n++){const o=e.charCodeAt(n);o<128?t++:o<2048?t+=2:o>=55296&&o<=56319?(t+=4,n++):t+=3}return t};function Ai(e){return e&&e._delegate?e._delegate:e}class Or{constructor(t,n,o){this.name=t,this.instanceFactory=n,this.type=o,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}const Di="[DEFAULT]";class $b{constructor(t,n){this.name=t,this.container=n,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(t){const n=this.normalizeInstanceIdentifier(t);if(!this.instancesDeferred.has(n)){const o=new Yo;if(this.instancesDeferred.set(n,o),this.isInitialized(n)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:n});i&&o.resolve(i)}catch{}}return this.instancesDeferred.get(n).promise}getImmediate(t){var n;const o=this.normalizeInstanceIdentifier(t?.identifier),i=(n=t?.optional)!==null&&n!==void 0?n:!1;if(this.isInitialized(o)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:o})}catch(s){if(i)return null;throw s}else{if(i)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(t){if(t.name!==this.name)throw Error(`Mismatching Component ${t.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=t,!!this.shouldAutoInitialize()){if(Jb(t))try{this.getOrInitializeService({instanceIdentifier:Di})}catch{}for(const[n,o]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(n);try{const s=this.getOrInitializeService({instanceIdentifier:i});o.resolve(s)}catch{}}}}clearInstance(t=Di){this.instancesDeferred.delete(t),this.instancesOptions.delete(t),this.instances.delete(t)}async delete(){const t=Array.from(this.instances.values());await Promise.all([...t.filter(n=>"INTERNAL"in n).map(n=>n.INTERNAL.delete()),...t.filter(n=>"_delete"in n).map(n=>n._delete())])}isComponentSet(){return this.component!=null}isInitialized(t=Di){return this.instances.has(t)}getOptions(t=Di){return this.instancesOptions.get(t)||{}}initialize(t={}){const{options:n={}}=t,o=this.normalizeInstanceIdentifier(t.instanceIdentifier);if(this.isInitialized(o))throw Error(`${this.name}(${o}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:o,options:n});for(const[s,r]of this.instancesDeferred.entries()){const l=this.normalizeInstanceIdentifier(s);o===l&&r.resolve(i)}return i}onInit(t,n){var o;const i=this.normalizeInstanceIdentifier(n),s=(o=this.onInitCallbacks.get(i))!==null&&o!==void 0?o:new Set;s.add(t),this.onInitCallbacks.set(i,s);const r=this.instances.get(i);return r&&t(r,i),()=>{s.delete(t)}}invokeOnInitCallbacks(t,n){const o=this.onInitCallbacks.get(n);if(o)for(const i of o)try{i(t,n)}catch{}}getOrInitializeService({instanceIdentifier:t,options:n={}}){let o=this.instances.get(t);if(!o&&this.component&&(o=this.component.instanceFactory(this.container,{instanceIdentifier:jb(t),options:n}),this.instances.set(t,o),this.instancesOptions.set(t,n),this.invokeOnInitCallbacks(o,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,o)}catch{}return o||null}normalizeInstanceIdentifier(t=Di){return this.component?this.component.multipleInstances?t:Di:t}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function jb(e){return e===Di?void 0:e}function Jb(e){return e.instantiationMode==="EAGER"}class Qb{constructor(t){this.name=t,this.providers=new Map}addComponent(t){const n=this.getProvider(t.name);if(n.isComponentSet())throw new Error(`Component ${t.name} has already been registered with ${this.name}`);n.setComponent(t)}addOrOverwriteComponent(t){this.getProvider(t.name).isComponentSet()&&this.providers.delete(t.name),this.addComponent(t)}getProvider(t){if(this.providers.has(t))return this.providers.get(t);const n=new $b(t,this);return this.providers.set(t,n),n}getProviders(){return Array.from(this.providers.values())}}var Jt;(function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"})(Jt||(Jt={}));const Zb={debug:Jt.DEBUG,verbose:Jt.VERBOSE,info:Jt.INFO,warn:Jt.WARN,error:Jt.ERROR,silent:Jt.SILENT},kb=Jt.INFO,e2={[Jt.DEBUG]:"log",[Jt.VERBOSE]:"log",[Jt.INFO]:"info",[Jt.WARN]:"warn",[Jt.ERROR]:"error"},t2=(e,t,...n)=>{if(t<e.logLevel)return;const o=new Date().toISOString(),i=e2[t];if(i)console[i](`[${o}]  ${e.name}:`,...n);else throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`)};class fg{constructor(t){this.name=t,this._logLevel=kb,this._logHandler=t2,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in Jt))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel=typeof t=="string"?Zb[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if(typeof t!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,Jt.DEBUG,...t),this._logHandler(this,Jt.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,Jt.VERBOSE,...t),this._logHandler(this,Jt.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,Jt.INFO,...t),this._logHandler(this,Jt.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,Jt.WARN,...t),this._logHandler(this,Jt.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,Jt.ERROR,...t),this._logHandler(this,Jt.ERROR,...t)}}const n2=(e,t)=>t.some(n=>e instanceof n);let Yu,Gu;function o2(){return Yu||(Yu=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function i2(){return Gu||(Gu=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const pg=new WeakMap,nd=new WeakMap,gg=new WeakMap,oc=new WeakMap,th=new WeakMap;function s2(e){const t=new Promise((n,o)=>{const i=()=>{e.removeEventListener("success",s),e.removeEventListener("error",r)},s=()=>{n(fi(e.result)),i()},r=()=>{o(e.error),i()};e.addEventListener("success",s),e.addEventListener("error",r)});return t.then(n=>{n instanceof IDBCursor&&pg.set(n,e)}).catch(()=>{}),th.set(t,e),t}function r2(e){if(nd.has(e))return;const t=new Promise((n,o)=>{const i=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",r),e.removeEventListener("abort",r)},s=()=>{n(),i()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",s),e.addEventListener("error",r),e.addEventListener("abort",r)});nd.set(e,t)}let od={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return nd.get(e);if(t==="objectStoreNames")return e.objectStoreNames||gg.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return fi(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function a2(e){od=e(od)}function l2(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const o=e.call(ic(this),t,...n);return gg.set(o,t.sort?t.sort():[t]),fi(o)}:i2().includes(e)?function(...t){return e.apply(ic(this),t),fi(pg.get(this))}:function(...t){return fi(e.apply(ic(this),t))}}function c2(e){return typeof e=="function"?l2(e):(e instanceof IDBTransaction&&r2(e),n2(e,o2())?new Proxy(e,od):e)}function fi(e){if(e instanceof IDBRequest)return s2(e);if(oc.has(e))return oc.get(e);const t=c2(e);return t!==e&&(oc.set(e,t),th.set(t,e)),t}const ic=e=>th.get(e);function d2(e,t,{blocked:n,upgrade:o,blocking:i,terminated:s}={}){const r=indexedDB.open(e,t),l=fi(r);return o&&r.addEventListener("upgradeneeded",c=>{o(fi(r.result),c.oldVersion,c.newVersion,fi(r.transaction),c)}),n&&r.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),l.then(c=>{s&&c.addEventListener("close",()=>s()),i&&c.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}const h2=["get","getKey","getAll","getAllKeys","count"],u2=["put","add","delete","clear"],sc=new Map;function Ku(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(sc.get(t))return sc.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,i=u2.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(i||h2.includes(n)))return;const s=async function(r,...l){const c=this.transaction(r,i?"readwrite":"readonly");let d=c.store;return o&&(d=d.index(l.shift())),(await Promise.all([d[n](...l),i&&c.done]))[0]};return sc.set(t,s),s}a2(e=>({...e,get:(t,n,o)=>Ku(t,n)||e.get(t,n,o),has:(t,n)=>!!Ku(t,n)||e.has(t,n)}));class f2{constructor(t){this.container=t}getPlatformInfoString(){return this.container.getProviders().map(n=>{if(p2(n)){const o=n.getImmediate();return`${o.library}/${o.version}`}else return null}).filter(n=>n).join(" ")}}function p2(e){const t=e.getComponent();return t?.type==="VERSION"}const id="@firebase/app",Vu="0.10.13";const Wo=new fg("@firebase/app"),g2="@firebase/app-compat",m2="@firebase/analytics-compat",y2="@firebase/analytics",x2="@firebase/app-check-compat",v2="@firebase/app-check",w2="@firebase/auth",b2="@firebase/auth-compat",E2="@firebase/database",S2="@firebase/data-connect",C2="@firebase/database-compat",_2="@firebase/functions",A2="@firebase/functions-compat",T2="@firebase/installations",M2="@firebase/installations-compat",R2="@firebase/messaging",D2="@firebase/messaging-compat",I2="@firebase/performance",P2="@firebase/performance-compat",L2="@firebase/remote-config",O2="@firebase/remote-config-compat",N2="@firebase/storage",B2="@firebase/storage-compat",H2="@firebase/firestore",z2="@firebase/vertexai-preview",U2="@firebase/firestore-compat",F2="firebase",X2="10.14.1";const sd="[DEFAULT]",q2={[id]:"fire-core",[g2]:"fire-core-compat",[y2]:"fire-analytics",[m2]:"fire-analytics-compat",[v2]:"fire-app-check",[x2]:"fire-app-check-compat",[w2]:"fire-auth",[b2]:"fire-auth-compat",[E2]:"fire-rtdb",[S2]:"fire-data-connect",[C2]:"fire-rtdb-compat",[_2]:"fire-fn",[A2]:"fire-fn-compat",[T2]:"fire-iid",[M2]:"fire-iid-compat",[R2]:"fire-fcm",[D2]:"fire-fcm-compat",[I2]:"fire-perf",[P2]:"fire-perf-compat",[L2]:"fire-rc",[O2]:"fire-rc-compat",[N2]:"fire-gcs",[B2]:"fire-gcs-compat",[H2]:"fire-fst",[U2]:"fire-fst-compat",[z2]:"fire-vertex","fire-js":"fire-js",[F2]:"fire-js-all"};const Wa=new Map,Y2=new Map,rd=new Map;function Wu(e,t){try{e.container.addComponent(t)}catch(n){Wo.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function $a(e){const t=e.name;if(rd.has(t))return Wo.debug(`There were multiple attempts to register component ${t}.`),!1;rd.set(t,e);for(const n of Wa.values())Wu(n,e);for(const n of Y2.values())Wu(n,e);return!0}function G2(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}const K2={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},pi=new hg("app","Firebase",K2);class V2{constructor(t,n,o){this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},n),this._name=n.name,this._automaticDataCollectionEnabled=n.automaticDataCollectionEnabled,this._container=o,this.container.addComponent(new Or("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(t){this.checkDestroyed(),this._automaticDataCollectionEnabled=t}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(t){this._isDeleted=t}checkDestroyed(){if(this.isDeleted)throw pi.create("app-deleted",{appName:this._name})}}const W2=X2;function mg(e,t={}){let n=e;typeof t!="object"&&(t={name:t});const o=Object.assign({name:sd,automaticDataCollectionEnabled:!1},t),i=o.name;if(typeof i!="string"||!i)throw pi.create("bad-app-name",{appName:String(i)});if(n||(n=cg()),!n)throw pi.create("no-options");const s=Wa.get(i);if(s){if(td(n,s.options)&&td(o,s.config))return s;throw pi.create("duplicate-app",{appName:i})}const r=new Qb(i);for(const c of rd.values())r.addComponent(c);const l=new V2(n,o,r);return Wa.set(i,l),l}function $2(e=sd){const t=Wa.get(e);if(!t&&e===sd&&cg())return mg();if(!t)throw pi.create("no-app",{appName:e});return t}function Es(e,t,n){var o;let i=(o=q2[e])!==null&&o!==void 0?o:e;n&&(i+=`-${n}`);const s=i.match(/\s|\//),r=t.match(/\s|\//);if(s||r){const l=[`Unable to register library "${i}" with version "${t}":`];s&&l.push(`library name "${i}" contains illegal characters (whitespace or "/")`),s&&r&&l.push("and"),r&&l.push(`version name "${t}" contains illegal characters (whitespace or "/")`),Wo.warn(l.join(" "));return}$a(new Or(`${i}-version`,()=>({library:i,version:t}),"VERSION"))}const j2="firebase-heartbeat-database",J2=1,Nr="firebase-heartbeat-store";let rc=null;function yg(){return rc||(rc=d2(j2,J2,{upgrade:(e,t)=>{switch(t){case 0:try{e.createObjectStore(Nr)}catch(n){console.warn(n)}}}}).catch(e=>{throw pi.create("idb-open",{originalErrorMessage:e.message})})),rc}async function Q2(e){try{const n=(await yg()).transaction(Nr),o=await n.objectStore(Nr).get(xg(e));return await n.done,o}catch(t){if(t instanceof Qr)Wo.warn(t.message);else{const n=pi.create("idb-get",{originalErrorMessage:t?.message});Wo.warn(n.message)}}}async function $u(e,t){try{const o=(await yg()).transaction(Nr,"readwrite");await o.objectStore(Nr).put(t,xg(e)),await o.done}catch(n){if(n instanceof Qr)Wo.warn(n.message);else{const o=pi.create("idb-set",{originalErrorMessage:n?.message});Wo.warn(o.message)}}}function xg(e){return`${e.name}!${e.options.appId}`}const Z2=1024,k2=720*60*60*1e3;class eE{constructor(t){this.container=t,this._heartbeatsCache=null;const n=this.container.getProvider("app").getImmediate();this._storage=new nE(n),this._heartbeatsCachePromise=this._storage.read().then(o=>(this._heartbeatsCache=o,o))}async triggerHeartbeat(){var t,n;try{const i=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),s=ju();return((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((n=this._heartbeatsCache)===null||n===void 0?void 0:n.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===s||this._heartbeatsCache.heartbeats.some(r=>r.date===s)?void 0:(this._heartbeatsCache.heartbeats.push({date:s,agent:i}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(r=>{const l=new Date(r.date).valueOf();return Date.now()-l<=k2}),this._storage.overwrite(this._heartbeatsCache))}catch(o){Wo.warn(o)}}async getHeartbeatsHeader(){var t;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const n=ju(),{heartbeatsToSend:o,unsentEntries:i}=tE(this._heartbeatsCache.heartbeats),s=Ka(JSON.stringify({version:2,heartbeats:o}));return this._heartbeatsCache.lastSentHeartbeatDate=n,i.length>0?(this._heartbeatsCache.heartbeats=i,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),s}catch(n){return Wo.warn(n),""}}}function ju(){return new Date().toISOString().substring(0,10)}function tE(e,t=Z2){const n=[];let o=e.slice();for(const i of e){const s=n.find(r=>r.agent===i.agent);if(s){if(s.dates.push(i.date),Ju(n)>t){s.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),Ju(n)>t){n.pop();break}o=o.slice(1)}return{heartbeatsToSend:n,unsentEntries:o}}class nE{constructor(t){this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return zb()?Ub().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const n=await Q2(this.app);return n?.heartbeats?n:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(t){var n;if(await this._canUseIndexedDBPromise){const i=await this.read();return $u(this.app,{lastSentHeartbeatDate:(n=t.lastSentHeartbeatDate)!==null&&n!==void 0?n:i.lastSentHeartbeatDate,heartbeats:t.heartbeats})}else return}async add(t){var n;if(await this._canUseIndexedDBPromise){const i=await this.read();return $u(this.app,{lastSentHeartbeatDate:(n=t.lastSentHeartbeatDate)!==null&&n!==void 0?n:i.lastSentHeartbeatDate,heartbeats:[...i.heartbeats,...t.heartbeats]})}else return}}function Ju(e){return Ka(JSON.stringify({version:2,heartbeats:e})).length}function oE(e){$a(new Or("platform-logger",t=>new f2(t),"PRIVATE")),$a(new Or("heartbeat",t=>new eE(t),"PRIVATE")),Es(id,Vu,e),Es(id,Vu,"esm2017"),Es("fire-js","")}oE("");var iE="firebase",sE="10.14.1";Es(iE,sE,"app");var Qu={};const Zu="@firebase/database",ku="1.0.8";let vg="";function rE(e){vg=e}class aE{constructor(t){this.domStorage_=t,this.prefix_="firebase:"}set(t,n){n==null?this.domStorage_.removeItem(this.prefixedName_(t)):this.domStorage_.setItem(this.prefixedName_(t),En(n))}get(t){const n=this.domStorage_.getItem(this.prefixedName_(t));return n==null?null:Lr(n)}remove(t){this.domStorage_.removeItem(this.prefixedName_(t))}prefixedName_(t){return this.prefix_+t}toString(){return this.domStorage_.toString()}}class lE{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(t,n){n==null?delete this.cache_[t]:this.cache_[t]=n}get(t){return Bo(this.cache_,t)?this.cache_[t]:null}remove(t){delete this.cache_[t]}}const wg=function(e){try{if(typeof window<"u"&&typeof window[e]<"u"){const t=window[e];return t.setItem("firebase:sentinel","cache"),t.removeItem("firebase:sentinel"),new aE(t)}}catch{}return new lE},Oi=wg("localStorage"),cE=wg("sessionStorage");const Ss=new fg("@firebase/database"),dE=(function(){let e=1;return function(){return e++}})(),bg=function(e){const t=Wb(e),n=new Vb;n.update(t);const o=n.digest();return eh.encodeByteArray(o)},Zr=function(...e){let t="";for(let n=0;n<e.length;n++){const o=e[n];Array.isArray(o)||o&&typeof o=="object"&&typeof o.length=="number"?t+=Zr.apply(null,o):typeof o=="object"?t+=En(o):t+=o,t+=" "}return t};let br=null,ef=!0;const hE=function(e,t){ye(!0,"Can't turn on custom loggers persistently."),Ss.logLevel=Jt.VERBOSE,br=Ss.log.bind(Ss)},Mn=function(...e){if(ef===!0&&(ef=!1,br===null&&cE.get("logging_enabled")===!0&&hE()),br){const t=Zr.apply(null,e);br(t)}},kr=function(e){return function(...t){Mn(e,...t)}},ad=function(...e){const t="FIREBASE INTERNAL ERROR: "+Zr(...e);Ss.error(t)},$o=function(...e){const t=`FIREBASE FATAL ERROR: ${Zr(...e)}`;throw Ss.error(t),new Error(t)},Gn=function(...e){const t="FIREBASE WARNING: "+Zr(...e);Ss.warn(t)},uE=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&Gn("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},Dl=function(e){return typeof e=="number"&&(e!==e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)},fE=function(e){if(document.readyState==="complete")e();else{let t=!1;const n=function(){if(!document.body){setTimeout(n,Math.floor(10));return}t||(t=!0,e())};document.addEventListener?(document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&n()}),window.attachEvent("onload",n))}},$i="[MIN_NAME]",wi="[MAX_NAME]",os=function(e,t){if(e===t)return 0;if(e===$i||t===wi)return-1;if(t===$i||e===wi)return 1;{const n=tf(e),o=tf(t);return n!==null?o!==null?n-o===0?e.length-t.length:n-o:-1:o!==null?1:e<t?-1:1}},pE=function(e,t){return e===t?0:e<t?-1:1},ks=function(e,t){if(t&&e in t)return t[e];throw new Error("Missing required key ("+e+") in object: "+En(t))},nh=function(e){if(typeof e!="object"||e===null)return En(e);const t=[];for(const o in e)t.push(o);t.sort();let n="{";for(let o=0;o<t.length;o++)o!==0&&(n+=","),n+=En(t[o]),n+=":",n+=nh(e[t[o]]);return n+="}",n},Eg=function(e,t){const n=e.length;if(n<=t)return[e];const o=[];for(let i=0;i<n;i+=t)i+t>n?o.push(e.substring(i,n)):o.push(e.substring(i,i+t));return o};function Pn(e,t){for(const n in e)e.hasOwnProperty(n)&&t(n,e[n])}const Sg=function(e){ye(!Dl(e),"Invalid JSON number");const t=11,n=52,o=(1<<t-1)-1;let i,s,r,l,c;e===0?(s=0,r=0,i=1/e===-1/0?1:0):(i=e<0,e=Math.abs(e),e>=Math.pow(2,1-o)?(l=Math.min(Math.floor(Math.log(e)/Math.LN2),o),s=l+o,r=Math.round(e*Math.pow(2,n-l)-Math.pow(2,n))):(s=0,r=Math.round(e/Math.pow(2,1-o-n))));const d=[];for(c=n;c;c-=1)d.push(r%2?1:0),r=Math.floor(r/2);for(c=t;c;c-=1)d.push(s%2?1:0),s=Math.floor(s/2);d.push(i?1:0),d.reverse();const a=d.join("");let h="";for(c=0;c<64;c+=8){let u=parseInt(a.substr(c,8),2).toString(16);u.length===1&&(u="0"+u),h=h+u}return h.toLowerCase()},gE=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},mE=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function yE(e,t){let n="Unknown Error";e==="too_big"?n="The data requested exceeds the maximum size that can be accessed with a single request.":e==="permission_denied"?n="Client doesn't have permission to access the desired data.":e==="unavailable"&&(n="The service is unavailable");const o=new Error(e+" at "+t._path.toString()+": "+n);return o.code=e.toUpperCase(),o}const xE=new RegExp("^-?(0*)\\d{1,10}$"),vE=-2147483648,wE=2147483647,tf=function(e){if(xE.test(e)){const t=Number(e);if(t>=vE&&t<=wE)return t}return null},qs=function(e){try{e()}catch(t){setTimeout(()=>{const n=t.stack||"";throw Gn("Exception was thrown by user callback.",n),t},Math.floor(0))}},bE=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},Er=function(e,t){const n=setTimeout(e,t);return typeof n=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(n):typeof n=="object"&&n.unref&&n.unref(),n};class EE{constructor(t,n){this.appName_=t,this.appCheckProvider=n,this.appCheck=n?.getImmediate({optional:!0}),this.appCheck||n?.get().then(o=>this.appCheck=o)}getToken(t){return this.appCheck?this.appCheck.getToken(t):new Promise((n,o)=>{setTimeout(()=>{this.appCheck?this.getToken(t).then(n,o):n(null)},0)})}addTokenChangeListener(t){var n;(n=this.appCheckProvider)===null||n===void 0||n.get().then(o=>o.addTokenListener(t))}notifyForInvalidToken(){Gn(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}class SE{constructor(t,n,o){this.appName_=t,this.firebaseOptions_=n,this.authProvider_=o,this.auth_=null,this.auth_=o.getImmediate({optional:!0}),this.auth_||o.onInit(i=>this.auth_=i)}getToken(t){return this.auth_?this.auth_.getToken(t).catch(n=>n&&n.code==="auth/token-not-initialized"?(Mn("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(n)):new Promise((n,o)=>{setTimeout(()=>{this.auth_?this.getToken(t).then(n,o):n(null)},0)})}addTokenChangeListener(t){this.auth_?this.auth_.addAuthTokenListener(t):this.authProvider_.get().then(n=>n.addAuthTokenListener(t))}removeTokenChangeListener(t){this.authProvider_.get().then(n=>n.removeAuthTokenListener(t))}notifyForInvalidToken(){let t='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?t+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?t+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':t+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',Gn(t)}}class Ra{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}Ra.OWNER="owner";const oh="5",Cg="v",_g="s",Ag="r",Tg="f",Mg=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Rg="ls",Dg="p",ld="ac",Ig="websocket",Pg="long_polling";class Lg{constructor(t,n,o,i,s=!1,r="",l=!1,c=!1){this.secure=n,this.namespace=o,this.webSocketOnly=i,this.nodeAdmin=s,this.persistenceKey=r,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=c,this._host=t.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Oi.get("host:"+t)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(t){t!==this.internalHost&&(this.internalHost=t,this.isCacheableHost()&&Oi.set("host:"+this._host,this.internalHost))}toString(){let t=this.toURLString();return this.persistenceKey&&(t+="<"+this.persistenceKey+">"),t}toURLString(){const t=this.secure?"https://":"http://",n=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${t}${this.host}/${n}`}}function CE(e){return e.host!==e.internalHost||e.isCustomHost()||e.includeNamespaceInQueryParams}function Og(e,t,n){ye(typeof t=="string","typeof type must == string"),ye(typeof n=="object","typeof params must == object");let o;if(t===Ig)o=(e.secure?"wss://":"ws://")+e.internalHost+"/.ws?";else if(t===Pg)o=(e.secure?"https://":"http://")+e.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+t);CE(e)&&(n.ns=e.namespace);const i=[];return Pn(n,(s,r)=>{i.push(s+"="+r)}),o+i.join("&")}class _E{constructor(){this.counters_={}}incrementCounter(t,n=1){Bo(this.counters_,t)||(this.counters_[t]=0),this.counters_[t]+=n}get(){return Ab(this.counters_)}}const ac={},lc={};function ih(e){const t=e.toString();return ac[t]||(ac[t]=new _E),ac[t]}function AE(e,t){const n=e.toString();return lc[n]||(lc[n]=t()),lc[n]}class TE{constructor(t){this.onMessage_=t,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(t,n){this.closeAfterResponse=t,this.onClose=n,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(t,n){for(this.pendingResponses[t]=n;this.pendingResponses[this.currentResponseNum];){const o=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<o.length;++i)o[i]&&qs(()=>{this.onMessage_(o[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const nf="start",ME="close",RE="pLPCommand",DE="pRTLPCB",Ng="id",Bg="pw",Hg="ser",IE="cb",PE="seg",LE="ts",OE="d",NE="dframe",zg=1870,Ug=30,BE=zg-Ug,HE=25e3,zE=3e4;class vs{constructor(t,n,o,i,s,r,l){this.connId=t,this.repoInfo=n,this.applicationId=o,this.appCheckToken=i,this.authToken=s,this.transportSessionId=r,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=kr(t),this.stats_=ih(n),this.urlFn=c=>(this.appCheckToken&&(c[ld]=this.appCheckToken),Og(n,Pg,c))}open(t,n){this.curSegmentNum=0,this.onDisconnect_=n,this.myPacketOrderer=new TE(t),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(zE)),fE(()=>{if(this.isClosed_)return;this.scriptTagHolder=new sh((...s)=>{const[r,l,c,d,a]=s;if(this.incrementIncomingBytes_(s),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,r===nf)this.id=l,this.password=c;else if(r===ME)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+r)},(...s)=>{const[r,l]=s;this.incrementIncomingBytes_(s),this.myPacketOrderer.handleResponse(r,l)},()=>{this.onClosed_()},this.urlFn);const o={};o[nf]="t",o[Hg]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(o[IE]=this.scriptTagHolder.uniqueCallbackIdentifier),o[Cg]=oh,this.transportSessionId&&(o[_g]=this.transportSessionId),this.lastSessionId&&(o[Rg]=this.lastSessionId),this.applicationId&&(o[Dg]=this.applicationId),this.appCheckToken&&(o[ld]=this.appCheckToken),typeof location<"u"&&location.hostname&&Mg.test(location.hostname)&&(o[Ag]=Tg);const i=this.urlFn(o);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){vs.forceAllow_=!0}static forceDisallow(){vs.forceDisallow_=!0}static isAvailable(){return vs.forceAllow_?!0:!vs.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!gE()&&!mE()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(t){const n=En(t);this.bytesSent+=n.length,this.stats_.incrementCounter("bytes_sent",n.length);const o=rg(n),i=Eg(o,BE);for(let s=0;s<i.length;s++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[s]),this.curSegmentNum++}addDisconnectPingFrame(t,n){this.myDisconnFrame=document.createElement("iframe");const o={};o[NE]="t",o[Ng]=t,o[Bg]=n,this.myDisconnFrame.src=this.urlFn(o),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(t){const n=En(t).length;this.bytesReceived+=n,this.stats_.incrementCounter("bytes_received",n)}}class sh{constructor(t,n,o,i){this.onDisconnect=o,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=dE(),window[RE+this.uniqueCallbackIdentifier]=t,window[DE+this.uniqueCallbackIdentifier]=n,this.myIFrame=sh.createIFrame_();let s="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(s='<script>document.domain="'+document.domain+'";<\/script>');const r="<html><body>"+s+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(r),this.myIFrame.doc.close()}catch(l){Mn("frame writing exception"),l.stack&&Mn(l.stack),Mn(l)}}}static createIFrame_(){const t=document.createElement("iframe");if(t.style.display="none",document.body){document.body.appendChild(t);try{t.contentWindow.document||Mn("No IE domain setting required")}catch{const o=document.domain;t.src="javascript:void((function(){document.open();document.domain='"+o+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return t.contentDocument?t.doc=t.contentDocument:t.contentWindow?t.doc=t.contentWindow.document:t.document&&(t.doc=t.document),t}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const t=this.onDisconnect;t&&(this.onDisconnect=null,t())}startLongPoll(t,n){for(this.myID=t,this.myPW=n,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const t={};t[Ng]=this.myID,t[Bg]=this.myPW,t[Hg]=this.currentSerial;let n=this.urlFn(t),o="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+Ug+o.length<=zg;){const r=this.pendingSegs.shift();o=o+"&"+PE+i+"="+r.seg+"&"+LE+i+"="+r.ts+"&"+OE+i+"="+r.d,i++}return n=n+o,this.addLongPollTag_(n,this.currentSerial),!0}else return!1}enqueueSegment(t,n,o){this.pendingSegs.push({seg:t,ts:n,d:o}),this.alive&&this.newRequest_()}addLongPollTag_(t,n){this.outstandingRequests.add(n);const o=()=>{this.outstandingRequests.delete(n),this.newRequest_()},i=setTimeout(o,Math.floor(HE)),s=()=>{clearTimeout(i),o()};this.addTag(t,s)}addTag(t,n){setTimeout(()=>{try{if(!this.sendNewPolls)return;const o=this.myIFrame.doc.createElement("script");o.type="text/javascript",o.async=!0,o.src=t,o.onload=o.onreadystatechange=function(){const i=o.readyState;(!i||i==="loaded"||i==="complete")&&(o.onload=o.onreadystatechange=null,o.parentNode&&o.parentNode.removeChild(o),n())},o.onerror=()=>{Mn("Long-poll script failed to load: "+t),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(o)}catch{}},Math.floor(1))}}const UE=16384,FE=45e3;let ja=null;typeof MozWebSocket<"u"?ja=MozWebSocket:typeof WebSocket<"u"&&(ja=WebSocket);class po{constructor(t,n,o,i,s,r,l){this.connId=t,this.applicationId=o,this.appCheckToken=i,this.authToken=s,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=kr(this.connId),this.stats_=ih(n),this.connURL=po.connectionURL_(n,r,l,i,o),this.nodeAdmin=n.nodeAdmin}static connectionURL_(t,n,o,i,s){const r={};return r[Cg]=oh,typeof location<"u"&&location.hostname&&Mg.test(location.hostname)&&(r[Ag]=Tg),n&&(r[_g]=n),o&&(r[Rg]=o),i&&(r[ld]=i),s&&(r[Dg]=s),Og(t,Ig,r)}open(t,n){this.onDisconnect=n,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Oi.set("previous_websocket_failure",!0);try{let o;Hb(),this.mySock=new ja(this.connURL,[],o)}catch(o){this.log_("Error instantiating WebSocket.");const i=o.message||o.data;i&&this.log_(i),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=o=>{this.handleIncomingFrame(o)},this.mySock.onerror=o=>{this.log_("WebSocket error.  Closing connection.");const i=o.message||o.data;i&&this.log_(i),this.onClosed_()}}start(){}static forceDisallow(){po.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){const n=/Android ([0-9]{0,}\.[0-9]{0,})/,o=navigator.userAgent.match(n);o&&o.length>1&&parseFloat(o[1])<4.4&&(t=!0)}return!t&&ja!==null&&!po.forceDisallow_}static previouslyFailed(){return Oi.isInMemoryStorage||Oi.get("previous_websocket_failure")===!0}markConnectionHealthy(){Oi.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){const n=this.frames.join("");this.frames=null;const o=Lr(n);this.onMessage(o)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(ye(this.frames===null,"We already have a frame buffer"),t.length<=6){const n=Number(t);if(!isNaN(n))return this.handleNewFrameCount_(n),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;const n=t.data;if(this.bytesReceived+=n.length,this.stats_.incrementCounter("bytes_received",n.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(n);else{const o=this.extractFrameCount_(n);o!==null&&this.appendFrame_(o)}}send(t){this.resetKeepAlive();const n=En(t);this.bytesSent+=n.length,this.stats_.incrementCounter("bytes_sent",n.length);const o=Eg(n,UE);o.length>1&&this.sendString_(String(o.length));for(let i=0;i<o.length;i++)this.sendString_(o[i])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(FE))}sendString_(t){try{this.mySock.send(t)}catch(n){this.log_("Exception thrown from WebSocket.send():",n.message||n.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}po.responsesRequiredToBeHealthy=2;po.healthyTimeout=3e4;class Br{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[vs,po]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){const n=po&&po.isAvailable();let o=n&&!po.previouslyFailed();if(t.webSocketOnly&&(n||Gn("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),o=!0),o)this.transports_=[po];else{const i=this.transports_=[];for(const s of Br.ALL_TRANSPORTS)s&&s.isAvailable()&&i.push(s);Br.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}Br.globalTransportInitialized_=!1;const XE=6e4,qE=5e3,YE=10*1024,GE=100*1024,cc="t",of="d",KE="s",sf="r",VE="e",rf="o",af="a",lf="n",cf="p",WE="h";class $E{constructor(t,n,o,i,s,r,l,c,d,a){this.id=t,this.repoInfo_=n,this.applicationId_=o,this.appCheckToken_=i,this.authToken_=s,this.onMessage_=r,this.onReady_=l,this.onDisconnect_=c,this.onKill_=d,this.lastSessionId=a,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=kr("c:"+this.id+":"),this.transportManager_=new Br(n),this.log_("Connection created"),this.start_()}start_(){const t=this.transportManager_.initialTransport();this.conn_=new t(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=t.responsesRequiredToBeHealthy||0;const n=this.connReceiver_(this.conn_),o=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(n,o)},Math.floor(0));const i=t.healthyTimeout||0;i>0&&(this.healthyTimeout_=Er(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>GE?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>YE?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(t){return n=>{t===this.conn_?this.onConnectionLost_(n):t===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(t){return n=>{this.state_!==2&&(t===this.rx_?this.onPrimaryMessageReceived_(n):t===this.secondaryConn_?this.onSecondaryMessageReceived_(n):this.log_("message on old connection"))}}sendRequest(t){const n={t:"d",d:t};this.sendData_(n)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(t){if(cc in t){const n=t[cc];n===af?this.upgradeIfSecondaryHealthy_():n===sf?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):n===rf&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(t){const n=ks("t",t),o=ks("d",t);if(n==="c")this.onSecondaryControl_(o);else if(n==="d")this.pendingDataMessages.push(o);else throw new Error("Unknown protocol layer: "+n)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:cf,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:af,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:lf,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(t){const n=ks("t",t),o=ks("d",t);n==="c"?this.onControl_(o):n==="d"&&this.onDataMessage_(o)}onDataMessage_(t){this.onPrimaryResponse_(),this.onMessage_(t)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(t){const n=ks(cc,t);if(of in t){const o=t[of];if(n===WE){const i=Object.assign({},o);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(n===lf){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else n===KE?this.onConnectionShutdown_(o):n===sf?this.onReset_(o):n===VE?ad("Server Error: "+o):n===rf?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):ad("Unknown control packet command: "+n)}}onHandshake_(t){const n=t.ts,o=t.v,i=t.h;this.sessionId=t.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,n),oh!==o&&Gn("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const t=this.transportManager_.upgradeTransport();t&&this.startUpgrade_(t)}startUpgrade_(t){this.secondaryConn_=new t(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=t.responsesRequiredToBeHealthy||0;const n=this.connReceiver_(this.secondaryConn_),o=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(n,o),Er(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(XE))}onReset_(t){this.log_("Reset packet received.  New host: "+t),this.repoInfo_.host=t,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(t,n){this.log_("Realtime connection established."),this.conn_=t,this.state_=1,this.onReady_&&(this.onReady_(n,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Er(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(qE))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:cf,d:{}}}))}onSecondaryConnectionLost_(){const t=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===t||this.rx_===t)&&this.close()}onConnectionLost_(t){this.conn_=null,!t&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Oi.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(t){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(t),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(t){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(t)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class Fg{put(t,n,o,i){}merge(t,n,o,i){}refreshAuthToken(t){}refreshAppCheckToken(t){}onDisconnectPut(t,n,o){}onDisconnectMerge(t,n,o){}onDisconnectCancel(t,n){}reportStats(t){}}class Xg{constructor(t){this.allowedEvents_=t,this.listeners_={},ye(Array.isArray(t)&&t.length>0,"Requires a non-empty array")}trigger(t,...n){if(Array.isArray(this.listeners_[t])){const o=[...this.listeners_[t]];for(let i=0;i<o.length;i++)o[i].callback.apply(o[i].context,n)}}on(t,n,o){this.validateEventType_(t),this.listeners_[t]=this.listeners_[t]||[],this.listeners_[t].push({callback:n,context:o});const i=this.getInitialEvent(t);i&&n.apply(o,i)}off(t,n,o){this.validateEventType_(t);const i=this.listeners_[t]||[];for(let s=0;s<i.length;s++)if(i[s].callback===n&&(!o||o===i[s].context)){i.splice(s,1);return}}validateEventType_(t){ye(this.allowedEvents_.find(n=>n===t),"Unknown event: "+t)}}class Ja extends Xg{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!dg()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new Ja}getInitialEvent(t){return ye(t==="online","Unknown event type: "+t),[this.online_]}currentlyOnline(){return this.online_}}const df=32,hf=768;class qt{constructor(t,n){if(n===void 0){this.pieces_=t.split("/");let o=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[o]=this.pieces_[i],o++);this.pieces_.length=o,this.pieceNum_=0}else this.pieces_=t,this.pieceNum_=n}toString(){let t="";for(let n=this.pieceNum_;n<this.pieces_.length;n++)this.pieces_[n]!==""&&(t+="/"+this.pieces_[n]);return t||"/"}}function Ut(){return new qt("")}function mt(e){return e.pieceNum_>=e.pieces_.length?null:e.pieces_[e.pieceNum_]}function bi(e){return e.pieces_.length-e.pieceNum_}function $t(e){let t=e.pieceNum_;return t<e.pieces_.length&&t++,new qt(e.pieces_,t)}function rh(e){return e.pieceNum_<e.pieces_.length?e.pieces_[e.pieces_.length-1]:null}function jE(e){let t="";for(let n=e.pieceNum_;n<e.pieces_.length;n++)e.pieces_[n]!==""&&(t+="/"+encodeURIComponent(String(e.pieces_[n])));return t||"/"}function Hr(e,t=0){return e.pieces_.slice(e.pieceNum_+t)}function qg(e){if(e.pieceNum_>=e.pieces_.length)return null;const t=[];for(let n=e.pieceNum_;n<e.pieces_.length-1;n++)t.push(e.pieces_[n]);return new qt(t,0)}function un(e,t){const n=[];for(let o=e.pieceNum_;o<e.pieces_.length;o++)n.push(e.pieces_[o]);if(t instanceof qt)for(let o=t.pieceNum_;o<t.pieces_.length;o++)n.push(t.pieces_[o]);else{const o=t.split("/");for(let i=0;i<o.length;i++)o[i].length>0&&n.push(o[i])}return new qt(n,0)}function yt(e){return e.pieceNum_>=e.pieces_.length}function Xn(e,t){const n=mt(e),o=mt(t);if(n===null)return t;if(n===o)return Xn($t(e),$t(t));throw new Error("INTERNAL ERROR: innerPath ("+t+") is not within outerPath ("+e+")")}function JE(e,t){const n=Hr(e,0),o=Hr(t,0);for(let i=0;i<n.length&&i<o.length;i++){const s=os(n[i],o[i]);if(s!==0)return s}return n.length===o.length?0:n.length<o.length?-1:1}function ah(e,t){if(bi(e)!==bi(t))return!1;for(let n=e.pieceNum_,o=t.pieceNum_;n<=e.pieces_.length;n++,o++)if(e.pieces_[n]!==t.pieces_[o])return!1;return!0}function ro(e,t){let n=e.pieceNum_,o=t.pieceNum_;if(bi(e)>bi(t))return!1;for(;n<e.pieces_.length;){if(e.pieces_[n]!==t.pieces_[o])return!1;++n,++o}return!0}class QE{constructor(t,n){this.errorPrefix_=n,this.parts_=Hr(t,0),this.byteLength_=Math.max(1,this.parts_.length);for(let o=0;o<this.parts_.length;o++)this.byteLength_+=Rl(this.parts_[o]);Yg(this)}}function ZE(e,t){e.parts_.length>0&&(e.byteLength_+=1),e.parts_.push(t),e.byteLength_+=Rl(t),Yg(e)}function kE(e){const t=e.parts_.pop();e.byteLength_-=Rl(t),e.parts_.length>0&&(e.byteLength_-=1)}function Yg(e){if(e.byteLength_>hf)throw new Error(e.errorPrefix_+"has a key path longer than "+hf+" bytes ("+e.byteLength_+").");if(e.parts_.length>df)throw new Error(e.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+df+") or object contains a cycle "+Ii(e))}function Ii(e){return e.parts_.length===0?"":"in property '"+e.parts_.join(".")+"'"}class lh extends Xg{constructor(){super(["visible"]);let t,n;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(n="visibilitychange",t="hidden"):typeof document.mozHidden<"u"?(n="mozvisibilitychange",t="mozHidden"):typeof document.msHidden<"u"?(n="msvisibilitychange",t="msHidden"):typeof document.webkitHidden<"u"&&(n="webkitvisibilitychange",t="webkitHidden")),this.visible_=!0,n&&document.addEventListener(n,()=>{const o=!document[t];o!==this.visible_&&(this.visible_=o,this.trigger("visible",o))},!1)}static getInstance(){return new lh}getInitialEvent(t){return ye(t==="visible","Unknown event type: "+t),[this.visible_]}}const er=1e3,eS=300*1e3,uf=30*1e3,tS=1.3,nS=3e4,oS="server_kill",ff=3;class Ko extends Fg{constructor(t,n,o,i,s,r,l,c){if(super(),this.repoInfo_=t,this.applicationId_=n,this.onDataUpdate_=o,this.onConnectStatus_=i,this.onServerInfoUpdate_=s,this.authTokenProvider_=r,this.appCheckTokenProvider_=l,this.authOverride_=c,this.id=Ko.nextPersistentConnectionId_++,this.log_=kr("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=er,this.maxReconnectDelay_=eS,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c)throw new Error("Auth override specified in options, but not supported on non Node.js platforms");lh.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&Ja.getInstance().on("online",this.onOnline_,this)}sendRequest(t,n,o){const i=++this.requestNumber_,s={r:i,a:t,b:n};this.log_(En(s)),ye(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(s),o&&(this.requestCBHash_[i]=o)}get(t){this.initConnection_();const n=new Yo,i={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:r=>{const l=r.d;r.s==="ok"?n.resolve(l):n.reject(l)}};this.outstandingGets_.push(i),this.outstandingGetCount_++;const s=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(s),n.promise}listen(t,n,o,i){this.initConnection_();const s=t._queryIdentifier,r=t._path.toString();this.log_("Listen called for "+r+" "+s),this.listens.has(r)||this.listens.set(r,new Map),ye(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),ye(!this.listens.get(r).has(s),"listen() called twice for same path/queryId.");const l={onComplete:i,hashFn:n,query:t,tag:o};this.listens.get(r).set(s,l),this.connected_&&this.sendListen_(l)}sendGet_(t){const n=this.outstandingGets_[t];this.sendRequest("g",n.request,o=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),n.onComplete&&n.onComplete(o)})}sendListen_(t){const n=t.query,o=n._path.toString(),i=n._queryIdentifier;this.log_("Listen on "+o+" for "+i);const s={p:o},r="q";t.tag&&(s.q=n._queryObject,s.t=t.tag),s.h=t.hashFn(),this.sendRequest(r,s,l=>{const c=l.d,d=l.s;Ko.warnOnListenWarnings_(c,n),(this.listens.get(o)&&this.listens.get(o).get(i))===t&&(this.log_("listen response",l),d!=="ok"&&this.removeListen_(o,i),t.onComplete&&t.onComplete(d,c))})}static warnOnListenWarnings_(t,n){if(t&&typeof t=="object"&&Bo(t,"w")){const o=Ts(t,"w");if(Array.isArray(o)&&~o.indexOf("no_index")){const i='".indexOn": "'+n._queryParams.getIndex().toString()+'"',s=n._path.toString();Gn(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${i} at ${s} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||Gb(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=uf)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const t=this.authToken_,n=Yb(t)?"auth":"gauth",o={cred:t};this.authOverride_===null?o.noauth=!0:typeof this.authOverride_=="object"&&(o.authvar=this.authOverride_),this.sendRequest(n,o,i=>{const s=i.s,r=i.d||"error";this.authToken_===t&&(s==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(s,r))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{const n=t.s,o=t.d||"error";n==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(n,o)})}unlisten(t,n){const o=t._path.toString(),i=t._queryIdentifier;this.log_("Unlisten called for "+o+" "+i),ye(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(o,i)&&this.connected_&&this.sendUnlisten_(o,i,t._queryObject,n)}sendUnlisten_(t,n,o,i){this.log_("Unlisten on "+t+" for "+n);const s={p:t},r="n";i&&(s.q=o,s.t=i),this.sendRequest(r,s)}onDisconnectPut(t,n,o){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,n,o):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:n,onComplete:o})}onDisconnectMerge(t,n,o){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,n,o):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:n,onComplete:o})}onDisconnectCancel(t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,n):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:n})}sendOnDisconnect_(t,n,o,i){const s={p:n,d:o};this.log_("onDisconnect "+t,s),this.sendRequest(t,s,r=>{i&&setTimeout(()=>{i(r.s,r.d)},Math.floor(0))})}put(t,n,o,i){this.putInternal("p",t,n,o,i)}merge(t,n,o,i){this.putInternal("m",t,n,o,i)}putInternal(t,n,o,i,s){this.initConnection_();const r={p:n,d:o};s!==void 0&&(r.h=s),this.outstandingPuts_.push({action:t,request:r,onComplete:i}),this.outstandingPutCount_++;const l=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(l):this.log_("Buffering put: "+n)}sendPut_(t){const n=this.outstandingPuts_[t].action,o=this.outstandingPuts_[t].request,i=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(n,o,s=>{this.log_(n+" response",s),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),i&&i(s.s,s.d)})}reportStats(t){if(this.connected_){const n={c:t};this.log_("reportStats",n),this.sendRequest("s",n,o=>{if(o.s!=="ok"){const s=o.d;this.log_("reportStats","Error sending stats: "+s)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+En(t));const n=t.r,o=this.requestCBHash_[n];o&&(delete this.requestCBHash_[n],o(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,n){this.log_("handleServerMessage",t,n),t==="d"?this.onDataUpdate_(n.p,n.d,!1,n.t):t==="m"?this.onDataUpdate_(n.p,n.d,!0,n.t):t==="c"?this.onListenRevoked_(n.p,n.q):t==="ac"?this.onAuthRevoked_(n.s,n.d):t==="apc"?this.onAppCheckRevoked_(n.s,n.d):t==="sd"?this.onSecurityDebugPacket_(n):ad("Unrecognized action received from server: "+En(t)+`
Are you using the latest client?`)}onReady_(t,n){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=n,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){ye(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=er,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=er,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>nS&&(this.reconnectDelay_=er),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());const t=new Date().getTime()-this.lastConnectionAttemptTime_;let n=Math.max(0,this.reconnectDelay_-t);n=Math.random()*n,this.log_("Trying to reconnect in "+n+"ms"),this.scheduleConnect_(n),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*tS)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const t=this.onDataMessage_.bind(this),n=this.onReady_.bind(this),o=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+Ko.nextConnectionId_++,s=this.lastSessionId;let r=!1,l=null;const c=function(){l?l.close():(r=!0,o())},d=function(h){ye(l,"sendRequest call when we're not connected not allowed."),l.sendRequest(h)};this.realtime_={close:c,sendRequest:d};const a=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[h,u]=await Promise.all([this.authTokenProvider_.getToken(a),this.appCheckTokenProvider_.getToken(a)]);r?Mn("getToken() completed but was canceled"):(Mn("getToken() completed. Creating connection."),this.authToken_=h&&h.accessToken,this.appCheckToken_=u&&u.token,l=new $E(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,n,o,p=>{Gn(p+" ("+this.repoInfo_.toString()+")"),this.interrupt(oS)},s))}catch(h){this.log_("Failed to get token: "+h),r||(this.repoInfo_.nodeAdmin&&Gn(h),c())}}}interrupt(t){Mn("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){Mn("Resuming connection for reason: "+t),delete this.interruptReasons_[t],ed(this.interruptReasons_)&&(this.reconnectDelay_=er,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){const n=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:n})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){const n=this.outstandingPuts_[t];n&&"h"in n.request&&n.queued&&(n.onComplete&&n.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,n){let o;n?o=n.map(s=>nh(s)).join("$"):o="default";const i=this.removeListen_(t,o);i&&i.onComplete&&i.onComplete("permission_denied")}removeListen_(t,n){const o=new qt(t).toString();let i;if(this.listens.has(o)){const s=this.listens.get(o);i=s.get(n),s.delete(n),s.size===0&&this.listens.delete(o)}else i=void 0;return i}onAuthRevoked_(t,n){Mn("Auth token revoked: "+t+"/"+n),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=ff&&(this.reconnectDelay_=uf,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,n){Mn("App check token revoked: "+t+"/"+n),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=ff&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const t of this.listens.values())for(const n of t.values())this.sendListen_(n);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){const t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){const t={};let n="js";t["sdk."+n+"."+vg.replace(/\./g,"-")]=1,dg()?t["framework.cordova"]=1:Bb()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){const t=Ja.getInstance().currentlyOnline();return ed(this.interruptReasons_)&&t}}Ko.nextPersistentConnectionId_=0;Ko.nextConnectionId_=0;class xt{constructor(t,n){this.name=t,this.node=n}static Wrap(t,n){return new xt(t,n)}}class Il{getCompare(){return this.compare.bind(this)}indexedValueChanged(t,n){const o=new xt($i,t),i=new xt($i,n);return this.compare(o,i)!==0}minPost(){return xt.MIN}}let ga;class Gg extends Il{static get __EMPTY_NODE(){return ga}static set __EMPTY_NODE(t){ga=t}compare(t,n){return os(t.name,n.name)}isDefinedOn(t){throw Xs("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(t,n){return!1}minPost(){return xt.MIN}maxPost(){return new xt(wi,ga)}makePost(t,n){return ye(typeof t=="string","KeyIndex indexValue must always be a string."),new xt(t,ga)}toString(){return".key"}}const zi=new Gg;class ma{constructor(t,n,o,i,s=null){this.isReverse_=i,this.resultGenerator_=s,this.nodeStack_=[];let r=1;for(;!t.isEmpty();)if(t=t,r=n?o(t.key,n):1,i&&(r*=-1),r<0)this.isReverse_?t=t.left:t=t.right;else if(r===0){this.nodeStack_.push(t);break}else this.nodeStack_.push(t),this.isReverse_?t=t.right:t=t.left}getNext(){if(this.nodeStack_.length===0)return null;let t=this.nodeStack_.pop(),n;if(this.resultGenerator_?n=this.resultGenerator_(t.key,t.value):n={key:t.key,value:t.value},this.isReverse_)for(t=t.left;!t.isEmpty();)this.nodeStack_.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack_.push(t),t=t.left;return n}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;const t=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value}}}class bn{constructor(t,n,o,i,s){this.key=t,this.value=n,this.color=o??bn.RED,this.left=i??qn.EMPTY_NODE,this.right=s??qn.EMPTY_NODE}copy(t,n,o,i,s){return new bn(t??this.key,n??this.value,o??this.color,i??this.left,s??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,n,o){let i=this;const s=o(t,i.key);return s<0?i=i.copy(null,null,null,i.left.insert(t,n,o),null):s===0?i=i.copy(null,n,null,null,null):i=i.copy(null,null,null,null,i.right.insert(t,n,o)),i.fixUp_()}removeMin_(){if(this.left.isEmpty())return qn.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,n){let o,i;if(o=this,n(t,o.key)<0)!o.left.isEmpty()&&!o.left.isRed_()&&!o.left.left.isRed_()&&(o=o.moveRedLeft_()),o=o.copy(null,null,null,o.left.remove(t,n),null);else{if(o.left.isRed_()&&(o=o.rotateRight_()),!o.right.isEmpty()&&!o.right.isRed_()&&!o.right.left.isRed_()&&(o=o.moveRedRight_()),n(t,o.key)===0){if(o.right.isEmpty())return qn.EMPTY_NODE;i=o.right.min_(),o=o.copy(i.key,i.value,null,null,o.right.removeMin_())}o=o.copy(null,null,null,null,o.right.remove(t,n))}return o.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){const t=this.copy(null,null,bn.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){const t=this.copy(null,null,bn.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){const t=this.left.copy(null,null,!this.left.color,null,null),n=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,n)}checkMaxDepth_(){const t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}bn.RED=!0;bn.BLACK=!1;class iS{copy(t,n,o,i,s){return this}insert(t,n,o){return new bn(t,n,null)}remove(t,n){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class qn{constructor(t,n=qn.EMPTY_NODE){this.comparator_=t,this.root_=n}insert(t,n){return new qn(this.comparator_,this.root_.insert(t,n,this.comparator_).copy(null,null,bn.BLACK,null,null))}remove(t){return new qn(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,bn.BLACK,null,null))}get(t){let n,o=this.root_;for(;!o.isEmpty();){if(n=this.comparator_(t,o.key),n===0)return o.value;n<0?o=o.left:n>0&&(o=o.right)}return null}getPredecessorKey(t){let n,o=this.root_,i=null;for(;!o.isEmpty();)if(n=this.comparator_(t,o.key),n===0){if(o.left.isEmpty())return i?i.key:null;for(o=o.left;!o.right.isEmpty();)o=o.right;return o.key}else n<0?o=o.left:n>0&&(i=o,o=o.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(t){return this.root_.inorderTraversal(t)}reverseTraversal(t){return this.root_.reverseTraversal(t)}getIterator(t){return new ma(this.root_,null,this.comparator_,!1,t)}getIteratorFrom(t,n){return new ma(this.root_,t,this.comparator_,!1,n)}getReverseIteratorFrom(t,n){return new ma(this.root_,t,this.comparator_,!0,n)}getReverseIterator(t){return new ma(this.root_,null,this.comparator_,!0,t)}}qn.EMPTY_NODE=new iS;function sS(e,t){return os(e.name,t.name)}function ch(e,t){return os(e,t)}let cd;function rS(e){cd=e}const Kg=function(e){return typeof e=="number"?"number:"+Sg(e):"string:"+e},Vg=function(e){if(e.isLeafNode()){const t=e.val();ye(typeof t=="string"||typeof t=="number"||typeof t=="object"&&Bo(t,".sv"),"Priority must be a string or number.")}else ye(e===cd||e.isEmpty(),"priority of unexpected type.");ye(e===cd||e.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let pf;class wn{constructor(t,n=wn.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=n,this.lazyHash_=null,ye(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Vg(this.priorityNode_)}static set __childrenNodeConstructor(t){pf=t}static get __childrenNodeConstructor(){return pf}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new wn(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:wn.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return yt(t)?this:mt(t)===".priority"?this.priorityNode_:wn.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,n){return null}updateImmediateChild(t,n){return t===".priority"?this.updatePriority(n):n.isEmpty()&&t!==".priority"?this:wn.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,n).updatePriority(this.priorityNode_)}updateChild(t,n){const o=mt(t);return o===null?n:n.isEmpty()&&o!==".priority"?this:(ye(o!==".priority"||bi(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(o,wn.__childrenNodeConstructor.EMPTY_NODE.updateChild($t(t),n)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,n){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+Kg(this.priorityNode_.val())+":");const n=typeof this.value_;t+=n+":",n==="number"?t+=Sg(this.value_):t+=this.value_,this.lazyHash_=bg(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===wn.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof wn.__childrenNodeConstructor?-1:(ye(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){const n=typeof t.value_,o=typeof this.value_,i=wn.VALUE_TYPE_ORDER.indexOf(n),s=wn.VALUE_TYPE_ORDER.indexOf(o);return ye(i>=0,"Unknown leaf type: "+n),ye(s>=0,"Unknown leaf type: "+o),i===s?o==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:s-i}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){const n=t;return this.value_===n.value_&&this.priorityNode_.equals(n.priorityNode_)}else return!1}}wn.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Wg,$g;function aS(e){Wg=e}function lS(e){$g=e}class cS extends Il{compare(t,n){const o=t.node.getPriority(),i=n.node.getPriority(),s=o.compareTo(i);return s===0?os(t.name,n.name):s}isDefinedOn(t){return!t.getPriority().isEmpty()}indexedValueChanged(t,n){return!t.getPriority().equals(n.getPriority())}minPost(){return xt.MIN}maxPost(){return new xt(wi,new wn("[PRIORITY-POST]",$g))}makePost(t,n){const o=Wg(t);return new xt(n,new wn("[PRIORITY-POST]",o))}toString(){return".priority"}}const tn=new cS;const dS=Math.log(2);class hS{constructor(t){const n=s=>parseInt(Math.log(s)/dS,10),o=s=>parseInt(Array(s+1).join("1"),2);this.count=n(t+1),this.current_=this.count-1;const i=o(this.count);this.bits_=t+1&i}nextBitIsOne(){const t=!(this.bits_&1<<this.current_);return this.current_--,t}}const Qa=function(e,t,n,o){e.sort(t);const i=function(c,d){const a=d-c;let h,u;if(a===0)return null;if(a===1)return h=e[c],u=n?n(h):h,new bn(u,h.node,bn.BLACK,null,null);{const p=parseInt(a/2,10)+c,g=i(c,p),A=i(p+1,d);return h=e[p],u=n?n(h):h,new bn(u,h.node,bn.BLACK,g,A)}},s=function(c){let d=null,a=null,h=e.length;const u=function(g,A){const m=h-g,C=h;h-=g;const I=i(m+1,C),R=e[m],f=n?n(R):R;p(new bn(f,R.node,A,null,I))},p=function(g){d?(d.left=g,d=g):(a=g,d=g)};for(let g=0;g<c.count;++g){const A=c.nextBitIsOne(),m=Math.pow(2,c.count-(g+1));A?u(m,bn.BLACK):(u(m,bn.BLACK),u(m,bn.RED))}return a},r=new hS(e.length),l=s(r);return new qn(o||t,l)};let dc;const ds={};class Go{constructor(t,n){this.indexes_=t,this.indexSet_=n}static get Default(){return ye(ds&&tn,"ChildrenNode.ts has not been loaded"),dc=dc||new Go({".priority":ds},{".priority":tn}),dc}get(t){const n=Ts(this.indexes_,t);if(!n)throw new Error("No index defined for "+t);return n instanceof qn?n:null}hasIndex(t){return Bo(this.indexSet_,t.toString())}addIndex(t,n){ye(t!==zi,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const o=[];let i=!1;const s=n.getIterator(xt.Wrap);let r=s.getNext();for(;r;)i=i||t.isDefinedOn(r.node),o.push(r),r=s.getNext();let l;i?l=Qa(o,t.getCompare()):l=ds;const c=t.toString(),d=Object.assign({},this.indexSet_);d[c]=t;const a=Object.assign({},this.indexes_);return a[c]=l,new Go(a,d)}addToIndexes(t,n){const o=Va(this.indexes_,(i,s)=>{const r=Ts(this.indexSet_,s);if(ye(r,"Missing index implementation for "+s),i===ds)if(r.isDefinedOn(t.node)){const l=[],c=n.getIterator(xt.Wrap);let d=c.getNext();for(;d;)d.name!==t.name&&l.push(d),d=c.getNext();return l.push(t),Qa(l,r.getCompare())}else return ds;else{const l=n.get(t.name);let c=i;return l&&(c=c.remove(new xt(t.name,l))),c.insert(t,t.node)}});return new Go(o,this.indexSet_)}removeFromIndexes(t,n){const o=Va(this.indexes_,i=>{if(i===ds)return i;{const s=n.get(t.name);return s?i.remove(new xt(t.name,s)):i}});return new Go(o,this.indexSet_)}}let tr;class it{constructor(t,n,o){this.children_=t,this.priorityNode_=n,this.indexMap_=o,this.lazyHash_=null,this.priorityNode_&&Vg(this.priorityNode_),this.children_.isEmpty()&&ye(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return tr||(tr=new it(new qn(ch),null,Go.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||tr}updatePriority(t){return this.children_.isEmpty()?this:new it(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{const n=this.children_.get(t);return n===null?tr:n}}getChild(t){const n=mt(t);return n===null?this:this.getImmediateChild(n).getChild($t(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,n){if(ye(n,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(n);{const o=new xt(t,n);let i,s;n.isEmpty()?(i=this.children_.remove(t),s=this.indexMap_.removeFromIndexes(o,this.children_)):(i=this.children_.insert(t,n),s=this.indexMap_.addToIndexes(o,this.children_));const r=i.isEmpty()?tr:this.priorityNode_;return new it(i,r,s)}}updateChild(t,n){const o=mt(t);if(o===null)return n;{ye(mt(t)!==".priority"||bi(t)===1,".priority must be the last token in a path");const i=this.getImmediateChild(o).updateChild($t(t),n);return this.updateImmediateChild(o,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;const n={};let o=0,i=0,s=!0;if(this.forEachChild(tn,(r,l)=>{n[r]=l.val(t),o++,s&&it.INTEGER_REGEXP_.test(r)?i=Math.max(i,Number(r)):s=!1}),!t&&s&&i<2*o){const r=[];for(const l in n)r[l]=n[l];return r}else return t&&!this.getPriority().isEmpty()&&(n[".priority"]=this.getPriority().val()),n}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+Kg(this.getPriority().val())+":"),this.forEachChild(tn,(n,o)=>{const i=o.hash();i!==""&&(t+=":"+n+":"+i)}),this.lazyHash_=t===""?"":bg(t)}return this.lazyHash_}getPredecessorChildName(t,n,o){const i=this.resolveIndex_(o);if(i){const s=i.getPredecessorKey(new xt(t,n));return s?s.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){const n=this.resolveIndex_(t);if(n){const o=n.minKey();return o&&o.name}else return this.children_.minKey()}getFirstChild(t){const n=this.getFirstChildName(t);return n?new xt(n,this.children_.get(n)):null}getLastChildName(t){const n=this.resolveIndex_(t);if(n){const o=n.maxKey();return o&&o.name}else return this.children_.maxKey()}getLastChild(t){const n=this.getLastChildName(t);return n?new xt(n,this.children_.get(n)):null}forEachChild(t,n){const o=this.resolveIndex_(t);return o?o.inorderTraversal(i=>n(i.name,i.node)):this.children_.inorderTraversal(n)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,n){const o=this.resolveIndex_(n);if(o)return o.getIteratorFrom(t,i=>i);{const i=this.children_.getIteratorFrom(t.name,xt.Wrap);let s=i.peek();for(;s!=null&&n.compare(s,t)<0;)i.getNext(),s=i.peek();return i}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,n){const o=this.resolveIndex_(n);if(o)return o.getReverseIteratorFrom(t,i=>i);{const i=this.children_.getReverseIteratorFrom(t.name,xt.Wrap);let s=i.peek();for(;s!=null&&n.compare(s,t)>0;)i.getNext(),s=i.peek();return i}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===ea?-1:0}withIndex(t){if(t===zi||this.indexMap_.hasIndex(t))return this;{const n=this.indexMap_.addIndex(t,this.children_);return new it(this.children_,this.priorityNode_,n)}}isIndexed(t){return t===zi||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{const n=t;if(this.getPriority().equals(n.getPriority()))if(this.children_.count()===n.children_.count()){const o=this.getIterator(tn),i=n.getIterator(tn);let s=o.getNext(),r=i.getNext();for(;s&&r;){if(s.name!==r.name||!s.node.equals(r.node))return!1;s=o.getNext(),r=i.getNext()}return s===null&&r===null}else return!1;else return!1}}resolveIndex_(t){return t===zi?null:this.indexMap_.get(t.toString())}}it.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class uS extends it{constructor(){super(new qn(ch),it.EMPTY_NODE,Go.Default)}compareTo(t){return t===this?0:1}equals(t){return t===this}getPriority(){return this}getImmediateChild(t){return it.EMPTY_NODE}isEmpty(){return!1}}const ea=new uS;Object.defineProperties(xt,{MIN:{value:new xt($i,it.EMPTY_NODE)},MAX:{value:new xt(wi,ea)}});Gg.__EMPTY_NODE=it.EMPTY_NODE;wn.__childrenNodeConstructor=it;rS(ea);lS(ea);const fS=!0;function pn(e,t=null){if(e===null)return it.EMPTY_NODE;if(typeof e=="object"&&".priority"in e&&(t=e[".priority"]),ye(t===null||typeof t=="string"||typeof t=="number"||typeof t=="object"&&".sv"in t,"Invalid priority type found: "+typeof t),typeof e=="object"&&".value"in e&&e[".value"]!==null&&(e=e[".value"]),typeof e!="object"||".sv"in e){const n=e;return new wn(n,pn(t))}if(!(e instanceof Array)&&fS){const n=[];let o=!1;if(Pn(e,(r,l)=>{if(r.substring(0,1)!=="."){const c=pn(l);c.isEmpty()||(o=o||!c.getPriority().isEmpty(),n.push(new xt(r,c)))}}),n.length===0)return it.EMPTY_NODE;const s=Qa(n,sS,r=>r.name,ch);if(o){const r=Qa(n,tn.getCompare());return new it(s,pn(t),new Go({".priority":r},{".priority":tn}))}else return new it(s,pn(t),Go.Default)}else{let n=it.EMPTY_NODE;return Pn(e,(o,i)=>{if(Bo(e,o)&&o.substring(0,1)!=="."){const s=pn(i);(s.isLeafNode()||!s.isEmpty())&&(n=n.updateImmediateChild(o,s))}}),n.updatePriority(pn(t))}}aS(pn);class dh extends Il{constructor(t){super(),this.indexPath_=t,ye(!yt(t)&&mt(t)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(t){return t.getChild(this.indexPath_)}isDefinedOn(t){return!t.getChild(this.indexPath_).isEmpty()}compare(t,n){const o=this.extractChild(t.node),i=this.extractChild(n.node),s=o.compareTo(i);return s===0?os(t.name,n.name):s}makePost(t,n){const o=pn(t),i=it.EMPTY_NODE.updateChild(this.indexPath_,o);return new xt(n,i)}maxPost(){const t=it.EMPTY_NODE.updateChild(this.indexPath_,ea);return new xt(wi,t)}toString(){return Hr(this.indexPath_,0).join("/")}}class pS extends Il{compare(t,n){const o=t.node.compareTo(n.node);return o===0?os(t.name,n.name):o}isDefinedOn(t){return!0}indexedValueChanged(t,n){return!t.equals(n)}minPost(){return xt.MIN}maxPost(){return xt.MAX}makePost(t,n){const o=pn(t);return new xt(n,o)}toString(){return".value"}}const jg=new pS;function Jg(e){return{type:"value",snapshotNode:e}}function Rs(e,t){return{type:"child_added",snapshotNode:t,childName:e}}function zr(e,t){return{type:"child_removed",snapshotNode:t,childName:e}}function Ur(e,t,n){return{type:"child_changed",snapshotNode:t,childName:e,oldSnap:n}}function gS(e,t){return{type:"child_moved",snapshotNode:t,childName:e}}class hh{constructor(t){this.index_=t}updateChild(t,n,o,i,s,r){ye(t.isIndexed(this.index_),"A node must be indexed if only a child is updated");const l=t.getImmediateChild(n);return l.getChild(i).equals(o.getChild(i))&&l.isEmpty()===o.isEmpty()||(r!=null&&(o.isEmpty()?t.hasChild(n)?r.trackChildChange(zr(n,l)):ye(t.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?r.trackChildChange(Rs(n,o)):r.trackChildChange(Ur(n,o,l))),t.isLeafNode()&&o.isEmpty())?t:t.updateImmediateChild(n,o).withIndex(this.index_)}updateFullNode(t,n,o){return o!=null&&(t.isLeafNode()||t.forEachChild(tn,(i,s)=>{n.hasChild(i)||o.trackChildChange(zr(i,s))}),n.isLeafNode()||n.forEachChild(tn,(i,s)=>{if(t.hasChild(i)){const r=t.getImmediateChild(i);r.equals(s)||o.trackChildChange(Ur(i,s,r))}else o.trackChildChange(Rs(i,s))})),n.withIndex(this.index_)}updatePriority(t,n){return t.isEmpty()?it.EMPTY_NODE:t.updatePriority(n)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class Fr{constructor(t){this.indexedFilter_=new hh(t.getIndex()),this.index_=t.getIndex(),this.startPost_=Fr.getStartPost_(t),this.endPost_=Fr.getEndPost_(t),this.startIsInclusive_=!t.startAfterSet_,this.endIsInclusive_=!t.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(t){const n=this.startIsInclusive_?this.index_.compare(this.getStartPost(),t)<=0:this.index_.compare(this.getStartPost(),t)<0,o=this.endIsInclusive_?this.index_.compare(t,this.getEndPost())<=0:this.index_.compare(t,this.getEndPost())<0;return n&&o}updateChild(t,n,o,i,s,r){return this.matches(new xt(n,o))||(o=it.EMPTY_NODE),this.indexedFilter_.updateChild(t,n,o,i,s,r)}updateFullNode(t,n,o){n.isLeafNode()&&(n=it.EMPTY_NODE);let i=n.withIndex(this.index_);i=i.updatePriority(it.EMPTY_NODE);const s=this;return n.forEachChild(tn,(r,l)=>{s.matches(new xt(r,l))||(i=i.updateImmediateChild(r,it.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(t,i,o)}updatePriority(t,n){return t}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(t){if(t.hasStart()){const n=t.getIndexStartName();return t.getIndex().makePost(t.getIndexStartValue(),n)}else return t.getIndex().minPost()}static getEndPost_(t){if(t.hasEnd()){const n=t.getIndexEndName();return t.getIndex().makePost(t.getIndexEndValue(),n)}else return t.getIndex().maxPost()}}class mS{constructor(t){this.withinDirectionalStart=n=>this.reverse_?this.withinEndPost(n):this.withinStartPost(n),this.withinDirectionalEnd=n=>this.reverse_?this.withinStartPost(n):this.withinEndPost(n),this.withinStartPost=n=>{const o=this.index_.compare(this.rangedFilter_.getStartPost(),n);return this.startIsInclusive_?o<=0:o<0},this.withinEndPost=n=>{const o=this.index_.compare(n,this.rangedFilter_.getEndPost());return this.endIsInclusive_?o<=0:o<0},this.rangedFilter_=new Fr(t),this.index_=t.getIndex(),this.limit_=t.getLimit(),this.reverse_=!t.isViewFromLeft(),this.startIsInclusive_=!t.startAfterSet_,this.endIsInclusive_=!t.endBeforeSet_}updateChild(t,n,o,i,s,r){return this.rangedFilter_.matches(new xt(n,o))||(o=it.EMPTY_NODE),t.getImmediateChild(n).equals(o)?t:t.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(t,n,o,i,s,r):this.fullLimitUpdateChild_(t,n,o,s,r)}updateFullNode(t,n,o){let i;if(n.isLeafNode()||n.isEmpty())i=it.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<n.numChildren()&&n.isIndexed(this.index_)){i=it.EMPTY_NODE.withIndex(this.index_);let s;this.reverse_?s=n.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):s=n.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let r=0;for(;s.hasNext()&&r<this.limit_;){const l=s.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))i=i.updateImmediateChild(l.name,l.node),r++;else break;else continue}}else{i=n.withIndex(this.index_),i=i.updatePriority(it.EMPTY_NODE);let s;this.reverse_?s=i.getReverseIterator(this.index_):s=i.getIterator(this.index_);let r=0;for(;s.hasNext();){const l=s.getNext();r<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?r++:i=i.updateImmediateChild(l.name,it.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(t,i,o)}updatePriority(t,n){return t}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(t,n,o,i,s){let r;if(this.reverse_){const h=this.index_.getCompare();r=(u,p)=>h(p,u)}else r=this.index_.getCompare();const l=t;ye(l.numChildren()===this.limit_,"");const c=new xt(n,o),d=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),a=this.rangedFilter_.matches(c);if(l.hasChild(n)){const h=l.getImmediateChild(n);let u=i.getChildAfterChild(this.index_,d,this.reverse_);for(;u!=null&&(u.name===n||l.hasChild(u.name));)u=i.getChildAfterChild(this.index_,u,this.reverse_);const p=u==null?1:r(u,c);if(a&&!o.isEmpty()&&p>=0)return s?.trackChildChange(Ur(n,o,h)),l.updateImmediateChild(n,o);{s?.trackChildChange(zr(n,h));const A=l.updateImmediateChild(n,it.EMPTY_NODE);return u!=null&&this.rangedFilter_.matches(u)?(s?.trackChildChange(Rs(u.name,u.node)),A.updateImmediateChild(u.name,u.node)):A}}else return o.isEmpty()?t:a&&r(d,c)>=0?(s!=null&&(s.trackChildChange(zr(d.name,d.node)),s.trackChildChange(Rs(n,o))),l.updateImmediateChild(n,o).updateImmediateChild(d.name,it.EMPTY_NODE)):t}}class uh{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=tn}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return ye(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return ye(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:$i}hasEnd(){return this.endSet_}getIndexEndValue(){return ye(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return ye(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:wi}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return ye(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===tn}copy(){const t=new uh;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.startAfterSet_=this.startAfterSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.endBeforeSet_=this.endBeforeSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t}}function yS(e){return e.loadsAllData()?new hh(e.getIndex()):e.hasLimit()?new mS(e):new Fr(e)}function xS(e,t){const n=e.copy();return n.index_=t,n}function gf(e){const t={};if(e.isDefault())return t;let n;if(e.index_===tn?n="$priority":e.index_===jg?n="$value":e.index_===zi?n="$key":(ye(e.index_ instanceof dh,"Unrecognized index type!"),n=e.index_.toString()),t.orderBy=En(n),e.startSet_){const o=e.startAfterSet_?"startAfter":"startAt";t[o]=En(e.indexStartValue_),e.startNameSet_&&(t[o]+=","+En(e.indexStartName_))}if(e.endSet_){const o=e.endBeforeSet_?"endBefore":"endAt";t[o]=En(e.indexEndValue_),e.endNameSet_&&(t[o]+=","+En(e.indexEndName_))}return e.limitSet_&&(e.isViewFromLeft()?t.limitToFirst=e.limit_:t.limitToLast=e.limit_),t}function mf(e){const t={};if(e.startSet_&&(t.sp=e.indexStartValue_,e.startNameSet_&&(t.sn=e.indexStartName_),t.sin=!e.startAfterSet_),e.endSet_&&(t.ep=e.indexEndValue_,e.endNameSet_&&(t.en=e.indexEndName_),t.ein=!e.endBeforeSet_),e.limitSet_){t.l=e.limit_;let n=e.viewFrom_;n===""&&(e.isViewFromLeft()?n="l":n="r"),t.vf=n}return e.index_!==tn&&(t.i=e.index_.toString()),t}class Za extends Fg{constructor(t,n,o,i){super(),this.repoInfo_=t,this.onDataUpdate_=n,this.authTokenProvider_=o,this.appCheckTokenProvider_=i,this.log_=kr("p:rest:"),this.listens_={}}reportStats(t){throw new Error("Method not implemented.")}static getListenId_(t,n){return n!==void 0?"tag$"+n:(ye(t._queryParams.isDefault(),"should have a tag if it's not a default query."),t._path.toString())}listen(t,n,o,i){const s=t._path.toString();this.log_("Listen called for "+s+" "+t._queryIdentifier);const r=Za.getListenId_(t,o),l={};this.listens_[r]=l;const c=gf(t._queryParams);this.restRequest_(s+".json",c,(d,a)=>{let h=a;if(d===404&&(h=null,d=null),d===null&&this.onDataUpdate_(s,h,!1,o),Ts(this.listens_,r)===l){let u;d?d===401?u="permission_denied":u="rest_error:"+d:u="ok",i(u,null)}})}unlisten(t,n){const o=Za.getListenId_(t,n);delete this.listens_[o]}get(t){const n=gf(t._queryParams),o=t._path.toString(),i=new Yo;return this.restRequest_(o+".json",n,(s,r)=>{let l=r;s===404&&(l=null,s=null),s===null?(this.onDataUpdate_(o,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(t){}restRequest_(t,n={},o){return n.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,s])=>{i&&i.accessToken&&(n.auth=i.accessToken),s&&s.token&&(n.ac=s.token);const r=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+t+"?ns="+this.repoInfo_.namespace+Kb(n);this.log_("Sending REST request for "+r);const l=new XMLHttpRequest;l.onreadystatechange=()=>{if(o&&l.readyState===4){this.log_("REST Response for "+r+" received. status:",l.status,"response:",l.responseText);let c=null;if(l.status>=200&&l.status<300){try{c=Lr(l.responseText)}catch{Gn("Failed to parse JSON response for "+r+": "+l.responseText)}o(null,c)}else l.status!==401&&l.status!==404&&Gn("Got unsuccessful REST response for "+r+" Status: "+l.status),o(l.status);o=null}},l.open("GET",r,!0),l.send()})}}class vS{constructor(){this.rootNode_=it.EMPTY_NODE}getNode(t){return this.rootNode_.getChild(t)}updateSnapshot(t,n){this.rootNode_=this.rootNode_.updateChild(t,n)}}function ka(){return{value:null,children:new Map}}function Ys(e,t,n){if(yt(t))e.value=n,e.children.clear();else if(e.value!==null)e.value=e.value.updateChild(t,n);else{const o=mt(t);e.children.has(o)||e.children.set(o,ka());const i=e.children.get(o);t=$t(t),Ys(i,t,n)}}function dd(e,t){if(yt(t))return e.value=null,e.children.clear(),!0;if(e.value!==null){if(e.value.isLeafNode())return!1;{const n=e.value;return e.value=null,n.forEachChild(tn,(o,i)=>{Ys(e,new qt(o),i)}),dd(e,t)}}else if(e.children.size>0){const n=mt(t);return t=$t(t),e.children.has(n)&&dd(e.children.get(n),t)&&e.children.delete(n),e.children.size===0}else return!0}function hd(e,t,n){e.value!==null?n(t,e.value):wS(e,(o,i)=>{const s=new qt(t.toString()+"/"+o);hd(i,s,n)})}function wS(e,t){e.children.forEach((n,o)=>{t(o,n)})}class bS{constructor(t){this.collection_=t,this.last_=null}get(){const t=this.collection_.get(),n=Object.assign({},t);return this.last_&&Pn(this.last_,(o,i)=>{n[o]=n[o]-i}),this.last_=t,n}}const yf=10*1e3,ES=30*1e3,SS=300*1e3;class CS{constructor(t,n){this.server_=n,this.statsToReport_={},this.statsListener_=new bS(t);const o=yf+(ES-yf)*Math.random();Er(this.reportStats_.bind(this),Math.floor(o))}reportStats_(){const t=this.statsListener_.get(),n={};let o=!1;Pn(t,(i,s)=>{s>0&&Bo(this.statsToReport_,i)&&(n[i]=s,o=!0)}),o&&this.server_.reportStats(n),Er(this.reportStats_.bind(this),Math.floor(Math.random()*2*SS))}}var xo;(function(e){e[e.OVERWRITE=0]="OVERWRITE",e[e.MERGE=1]="MERGE",e[e.ACK_USER_WRITE=2]="ACK_USER_WRITE",e[e.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"})(xo||(xo={}));function Qg(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function fh(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function ph(e){return{fromUser:!1,fromServer:!0,queryId:e,tagged:!0}}class el{constructor(t,n,o){this.path=t,this.affectedTree=n,this.revert=o,this.type=xo.ACK_USER_WRITE,this.source=Qg()}operationForChild(t){if(yt(this.path)){if(this.affectedTree.value!=null)return ye(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const n=this.affectedTree.subtree(new qt(t));return new el(Ut(),n,this.revert)}}else return ye(mt(this.path)===t,"operationForChild called for unrelated child."),new el($t(this.path),this.affectedTree,this.revert)}}class Xr{constructor(t,n){this.source=t,this.path=n,this.type=xo.LISTEN_COMPLETE}operationForChild(t){return yt(this.path)?new Xr(this.source,Ut()):new Xr(this.source,$t(this.path))}}class ji{constructor(t,n,o){this.source=t,this.path=n,this.snap=o,this.type=xo.OVERWRITE}operationForChild(t){return yt(this.path)?new ji(this.source,Ut(),this.snap.getImmediateChild(t)):new ji(this.source,$t(this.path),this.snap)}}class qr{constructor(t,n,o){this.source=t,this.path=n,this.children=o,this.type=xo.MERGE}operationForChild(t){if(yt(this.path)){const n=this.children.subtree(new qt(t));return n.isEmpty()?null:n.value?new ji(this.source,Ut(),n.value):new qr(this.source,Ut(),n)}else return ye(mt(this.path)===t,"Can't get a merge for a child not on the path of the operation"),new qr(this.source,$t(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Ji{constructor(t,n,o){this.node_=t,this.fullyInitialized_=n,this.filtered_=o}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(t){if(yt(t))return this.isFullyInitialized()&&!this.filtered_;const n=mt(t);return this.isCompleteForChild(n)}isCompleteForChild(t){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(t)}getNode(){return this.node_}}class _S{constructor(t){this.query_=t,this.index_=this.query_._queryParams.getIndex()}}function AS(e,t,n,o){const i=[],s=[];return t.forEach(r=>{r.type==="child_changed"&&e.index_.indexedValueChanged(r.oldSnap,r.snapshotNode)&&s.push(gS(r.childName,r.snapshotNode))}),nr(e,i,"child_removed",t,o,n),nr(e,i,"child_added",t,o,n),nr(e,i,"child_moved",s,o,n),nr(e,i,"child_changed",t,o,n),nr(e,i,"value",t,o,n),i}function nr(e,t,n,o,i,s){const r=o.filter(l=>l.type===n);r.sort((l,c)=>MS(e,l,c)),r.forEach(l=>{const c=TS(e,l,s);i.forEach(d=>{d.respondsTo(l.type)&&t.push(d.createEvent(c,e.query_))})})}function TS(e,t,n){return t.type==="value"||t.type==="child_removed"||(t.prevName=n.getPredecessorChildName(t.childName,t.snapshotNode,e.index_)),t}function MS(e,t,n){if(t.childName==null||n.childName==null)throw Xs("Should only compare child_ events.");const o=new xt(t.childName,t.snapshotNode),i=new xt(n.childName,n.snapshotNode);return e.index_.compare(o,i)}function Pl(e,t){return{eventCache:e,serverCache:t}}function Sr(e,t,n,o){return Pl(new Ji(t,n,o),e.serverCache)}function Zg(e,t,n,o){return Pl(e.eventCache,new Ji(t,n,o))}function ud(e){return e.eventCache.isFullyInitialized()?e.eventCache.getNode():null}function Qi(e){return e.serverCache.isFullyInitialized()?e.serverCache.getNode():null}let hc;const RS=()=>(hc||(hc=new qn(pE)),hc);class Qt{constructor(t,n=RS()){this.value=t,this.children=n}static fromObject(t){let n=new Qt(null);return Pn(t,(o,i)=>{n=n.set(new qt(o),i)}),n}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(t,n){if(this.value!=null&&n(this.value))return{path:Ut(),value:this.value};if(yt(t))return null;{const o=mt(t),i=this.children.get(o);if(i!==null){const s=i.findRootMostMatchingPathAndValue($t(t),n);return s!=null?{path:un(new qt(o),s.path),value:s.value}:null}else return null}}findRootMostValueAndPath(t){return this.findRootMostMatchingPathAndValue(t,()=>!0)}subtree(t){if(yt(t))return this;{const n=mt(t),o=this.children.get(n);return o!==null?o.subtree($t(t)):new Qt(null)}}set(t,n){if(yt(t))return new Qt(n,this.children);{const o=mt(t),s=(this.children.get(o)||new Qt(null)).set($t(t),n),r=this.children.insert(o,s);return new Qt(this.value,r)}}remove(t){if(yt(t))return this.children.isEmpty()?new Qt(null):new Qt(null,this.children);{const n=mt(t),o=this.children.get(n);if(o){const i=o.remove($t(t));let s;return i.isEmpty()?s=this.children.remove(n):s=this.children.insert(n,i),this.value===null&&s.isEmpty()?new Qt(null):new Qt(this.value,s)}else return this}}get(t){if(yt(t))return this.value;{const n=mt(t),o=this.children.get(n);return o?o.get($t(t)):null}}setTree(t,n){if(yt(t))return n;{const o=mt(t),s=(this.children.get(o)||new Qt(null)).setTree($t(t),n);let r;return s.isEmpty()?r=this.children.remove(o):r=this.children.insert(o,s),new Qt(this.value,r)}}fold(t){return this.fold_(Ut(),t)}fold_(t,n){const o={};return this.children.inorderTraversal((i,s)=>{o[i]=s.fold_(un(t,i),n)}),n(t,this.value,o)}findOnPath(t,n){return this.findOnPath_(t,Ut(),n)}findOnPath_(t,n,o){const i=this.value?o(n,this.value):!1;if(i)return i;if(yt(t))return null;{const s=mt(t),r=this.children.get(s);return r?r.findOnPath_($t(t),un(n,s),o):null}}foreachOnPath(t,n){return this.foreachOnPath_(t,Ut(),n)}foreachOnPath_(t,n,o){if(yt(t))return this;{this.value&&o(n,this.value);const i=mt(t),s=this.children.get(i);return s?s.foreachOnPath_($t(t),un(n,i),o):new Qt(null)}}foreach(t){this.foreach_(Ut(),t)}foreach_(t,n){this.children.inorderTraversal((o,i)=>{i.foreach_(un(t,o),n)}),this.value&&n(t,this.value)}foreachChild(t){this.children.inorderTraversal((n,o)=>{o.value&&t(n,o.value)})}}class vo{constructor(t){this.writeTree_=t}static empty(){return new vo(new Qt(null))}}function Cr(e,t,n){if(yt(t))return new vo(new Qt(n));{const o=e.writeTree_.findRootMostValueAndPath(t);if(o!=null){const i=o.path;let s=o.value;const r=Xn(i,t);return s=s.updateChild(r,n),new vo(e.writeTree_.set(i,s))}else{const i=new Qt(n),s=e.writeTree_.setTree(t,i);return new vo(s)}}}function xf(e,t,n){let o=e;return Pn(n,(i,s)=>{o=Cr(o,un(t,i),s)}),o}function vf(e,t){if(yt(t))return vo.empty();{const n=e.writeTree_.setTree(t,new Qt(null));return new vo(n)}}function fd(e,t){return is(e,t)!=null}function is(e,t){const n=e.writeTree_.findRootMostValueAndPath(t);return n!=null?e.writeTree_.get(n.path).getChild(Xn(n.path,t)):null}function wf(e){const t=[],n=e.writeTree_.value;return n!=null?n.isLeafNode()||n.forEachChild(tn,(o,i)=>{t.push(new xt(o,i))}):e.writeTree_.children.inorderTraversal((o,i)=>{i.value!=null&&t.push(new xt(o,i.value))}),t}function gi(e,t){if(yt(t))return e;{const n=is(e,t);return n!=null?new vo(new Qt(n)):new vo(e.writeTree_.subtree(t))}}function pd(e){return e.writeTree_.isEmpty()}function Ds(e,t){return kg(Ut(),e.writeTree_,t)}function kg(e,t,n){if(t.value!=null)return n.updateChild(e,t.value);{let o=null;return t.children.inorderTraversal((i,s)=>{i===".priority"?(ye(s.value!==null,"Priority writes must always be leaf nodes"),o=s.value):n=kg(un(e,i),s,n)}),!n.getChild(e).isEmpty()&&o!==null&&(n=n.updateChild(un(e,".priority"),o)),n}}function gh(e,t){return om(t,e)}function DS(e,t,n,o,i){ye(o>e.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),e.allWrites.push({path:t,snap:n,writeId:o,visible:i}),i&&(e.visibleWrites=Cr(e.visibleWrites,t,n)),e.lastWriteId=o}function IS(e,t){for(let n=0;n<e.allWrites.length;n++){const o=e.allWrites[n];if(o.writeId===t)return o}return null}function PS(e,t){const n=e.allWrites.findIndex(l=>l.writeId===t);ye(n>=0,"removeWrite called with nonexistent writeId.");const o=e.allWrites[n];e.allWrites.splice(n,1);let i=o.visible,s=!1,r=e.allWrites.length-1;for(;i&&r>=0;){const l=e.allWrites[r];l.visible&&(r>=n&&LS(l,o.path)?i=!1:ro(o.path,l.path)&&(s=!0)),r--}if(i){if(s)return OS(e),!0;if(o.snap)e.visibleWrites=vf(e.visibleWrites,o.path);else{const l=o.children;Pn(l,c=>{e.visibleWrites=vf(e.visibleWrites,un(o.path,c))})}return!0}else return!1}function LS(e,t){if(e.snap)return ro(e.path,t);for(const n in e.children)if(e.children.hasOwnProperty(n)&&ro(un(e.path,n),t))return!0;return!1}function OS(e){e.visibleWrites=em(e.allWrites,NS,Ut()),e.allWrites.length>0?e.lastWriteId=e.allWrites[e.allWrites.length-1].writeId:e.lastWriteId=-1}function NS(e){return e.visible}function em(e,t,n){let o=vo.empty();for(let i=0;i<e.length;++i){const s=e[i];if(t(s)){const r=s.path;let l;if(s.snap)ro(n,r)?(l=Xn(n,r),o=Cr(o,l,s.snap)):ro(r,n)&&(l=Xn(r,n),o=Cr(o,Ut(),s.snap.getChild(l)));else if(s.children){if(ro(n,r))l=Xn(n,r),o=xf(o,l,s.children);else if(ro(r,n))if(l=Xn(r,n),yt(l))o=xf(o,Ut(),s.children);else{const c=Ts(s.children,mt(l));if(c){const d=c.getChild($t(l));o=Cr(o,Ut(),d)}}}else throw Xs("WriteRecord should have .snap or .children")}}return o}function tm(e,t,n,o,i){if(!o&&!i){const s=is(e.visibleWrites,t);if(s!=null)return s;{const r=gi(e.visibleWrites,t);if(pd(r))return n;if(n==null&&!fd(r,Ut()))return null;{const l=n||it.EMPTY_NODE;return Ds(r,l)}}}else{const s=gi(e.visibleWrites,t);if(!i&&pd(s))return n;if(!i&&n==null&&!fd(s,Ut()))return null;{const r=function(d){return(d.visible||i)&&(!o||!~o.indexOf(d.writeId))&&(ro(d.path,t)||ro(t,d.path))},l=em(e.allWrites,r,t),c=n||it.EMPTY_NODE;return Ds(l,c)}}}function BS(e,t,n){let o=it.EMPTY_NODE;const i=is(e.visibleWrites,t);if(i)return i.isLeafNode()||i.forEachChild(tn,(s,r)=>{o=o.updateImmediateChild(s,r)}),o;if(n){const s=gi(e.visibleWrites,t);return n.forEachChild(tn,(r,l)=>{const c=Ds(gi(s,new qt(r)),l);o=o.updateImmediateChild(r,c)}),wf(s).forEach(r=>{o=o.updateImmediateChild(r.name,r.node)}),o}else{const s=gi(e.visibleWrites,t);return wf(s).forEach(r=>{o=o.updateImmediateChild(r.name,r.node)}),o}}function HS(e,t,n,o,i){ye(o||i,"Either existingEventSnap or existingServerSnap must exist");const s=un(t,n);if(fd(e.visibleWrites,s))return null;{const r=gi(e.visibleWrites,s);return pd(r)?i.getChild(n):Ds(r,i.getChild(n))}}function zS(e,t,n,o){const i=un(t,n),s=is(e.visibleWrites,i);if(s!=null)return s;if(o.isCompleteForChild(n)){const r=gi(e.visibleWrites,i);return Ds(r,o.getNode().getImmediateChild(n))}else return null}function US(e,t){return is(e.visibleWrites,t)}function FS(e,t,n,o,i,s,r){let l;const c=gi(e.visibleWrites,t),d=is(c,Ut());if(d!=null)l=d;else if(n!=null)l=Ds(c,n);else return[];if(l=l.withIndex(r),!l.isEmpty()&&!l.isLeafNode()){const a=[],h=r.getCompare(),u=s?l.getReverseIteratorFrom(o,r):l.getIteratorFrom(o,r);let p=u.getNext();for(;p&&a.length<i;)h(p,o)!==0&&a.push(p),p=u.getNext();return a}else return[]}function XS(){return{visibleWrites:vo.empty(),allWrites:[],lastWriteId:-1}}function tl(e,t,n,o){return tm(e.writeTree,e.treePath,t,n,o)}function mh(e,t){return BS(e.writeTree,e.treePath,t)}function bf(e,t,n,o){return HS(e.writeTree,e.treePath,t,n,o)}function nl(e,t){return US(e.writeTree,un(e.treePath,t))}function qS(e,t,n,o,i,s){return FS(e.writeTree,e.treePath,t,n,o,i,s)}function yh(e,t,n){return zS(e.writeTree,e.treePath,t,n)}function nm(e,t){return om(un(e.treePath,t),e.writeTree)}function om(e,t){return{treePath:e,writeTree:t}}class YS{constructor(){this.changeMap=new Map}trackChildChange(t){const n=t.type,o=t.childName;ye(n==="child_added"||n==="child_changed"||n==="child_removed","Only child changes supported for tracking"),ye(o!==".priority","Only non-priority child changes can be tracked.");const i=this.changeMap.get(o);if(i){const s=i.type;if(n==="child_added"&&s==="child_removed")this.changeMap.set(o,Ur(o,t.snapshotNode,i.snapshotNode));else if(n==="child_removed"&&s==="child_added")this.changeMap.delete(o);else if(n==="child_removed"&&s==="child_changed")this.changeMap.set(o,zr(o,i.oldSnap));else if(n==="child_changed"&&s==="child_added")this.changeMap.set(o,Rs(o,t.snapshotNode));else if(n==="child_changed"&&s==="child_changed")this.changeMap.set(o,Ur(o,t.snapshotNode,i.oldSnap));else throw Xs("Illegal combination of changes: "+t+" occurred after "+i)}else this.changeMap.set(o,t)}getChanges(){return Array.from(this.changeMap.values())}}class GS{getCompleteChild(t){return null}getChildAfterChild(t,n,o){return null}}const im=new GS;class xh{constructor(t,n,o=null){this.writes_=t,this.viewCache_=n,this.optCompleteServerCache_=o}getCompleteChild(t){const n=this.viewCache_.eventCache;if(n.isCompleteForChild(t))return n.getNode().getImmediateChild(t);{const o=this.optCompleteServerCache_!=null?new Ji(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return yh(this.writes_,t,o)}}getChildAfterChild(t,n,o){const i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:Qi(this.viewCache_),s=qS(this.writes_,i,n,1,o,t);return s.length===0?null:s[0]}}function KS(e){return{filter:e}}function VS(e,t){ye(t.eventCache.getNode().isIndexed(e.filter.getIndex()),"Event snap not indexed"),ye(t.serverCache.getNode().isIndexed(e.filter.getIndex()),"Server snap not indexed")}function WS(e,t,n,o,i){const s=new YS;let r,l;if(n.type===xo.OVERWRITE){const d=n;d.source.fromUser?r=gd(e,t,d.path,d.snap,o,i,s):(ye(d.source.fromServer,"Unknown source."),l=d.source.tagged||t.serverCache.isFiltered()&&!yt(d.path),r=ol(e,t,d.path,d.snap,o,i,l,s))}else if(n.type===xo.MERGE){const d=n;d.source.fromUser?r=jS(e,t,d.path,d.children,o,i,s):(ye(d.source.fromServer,"Unknown source."),l=d.source.tagged||t.serverCache.isFiltered(),r=md(e,t,d.path,d.children,o,i,l,s))}else if(n.type===xo.ACK_USER_WRITE){const d=n;d.revert?r=ZS(e,t,d.path,o,i,s):r=JS(e,t,d.path,d.affectedTree,o,i,s)}else if(n.type===xo.LISTEN_COMPLETE)r=QS(e,t,n.path,o,s);else throw Xs("Unknown operation type: "+n.type);const c=s.getChanges();return $S(t,r,c),{viewCache:r,changes:c}}function $S(e,t,n){const o=t.eventCache;if(o.isFullyInitialized()){const i=o.getNode().isLeafNode()||o.getNode().isEmpty(),s=ud(e);(n.length>0||!e.eventCache.isFullyInitialized()||i&&!o.getNode().equals(s)||!o.getNode().getPriority().equals(s.getPriority()))&&n.push(Jg(ud(t)))}}function sm(e,t,n,o,i,s){const r=t.eventCache;if(nl(o,n)!=null)return t;{let l,c;if(yt(n))if(ye(t.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),t.serverCache.isFiltered()){const d=Qi(t),a=d instanceof it?d:it.EMPTY_NODE,h=mh(o,a);l=e.filter.updateFullNode(t.eventCache.getNode(),h,s)}else{const d=tl(o,Qi(t));l=e.filter.updateFullNode(t.eventCache.getNode(),d,s)}else{const d=mt(n);if(d===".priority"){ye(bi(n)===1,"Can't have a priority with additional path components");const a=r.getNode();c=t.serverCache.getNode();const h=bf(o,n,a,c);h!=null?l=e.filter.updatePriority(a,h):l=r.getNode()}else{const a=$t(n);let h;if(r.isCompleteForChild(d)){c=t.serverCache.getNode();const u=bf(o,n,r.getNode(),c);u!=null?h=r.getNode().getImmediateChild(d).updateChild(a,u):h=r.getNode().getImmediateChild(d)}else h=yh(o,d,t.serverCache);h!=null?l=e.filter.updateChild(r.getNode(),d,h,a,i,s):l=r.getNode()}}return Sr(t,l,r.isFullyInitialized()||yt(n),e.filter.filtersNodes())}}function ol(e,t,n,o,i,s,r,l){const c=t.serverCache;let d;const a=r?e.filter:e.filter.getIndexedFilter();if(yt(n))d=a.updateFullNode(c.getNode(),o,null);else if(a.filtersNodes()&&!c.isFiltered()){const p=c.getNode().updateChild(n,o);d=a.updateFullNode(c.getNode(),p,null)}else{const p=mt(n);if(!c.isCompleteForPath(n)&&bi(n)>1)return t;const g=$t(n),m=c.getNode().getImmediateChild(p).updateChild(g,o);p===".priority"?d=a.updatePriority(c.getNode(),m):d=a.updateChild(c.getNode(),p,m,g,im,null)}const h=Zg(t,d,c.isFullyInitialized()||yt(n),a.filtersNodes()),u=new xh(i,h,s);return sm(e,h,n,i,u,l)}function gd(e,t,n,o,i,s,r){const l=t.eventCache;let c,d;const a=new xh(i,t,s);if(yt(n))d=e.filter.updateFullNode(t.eventCache.getNode(),o,r),c=Sr(t,d,!0,e.filter.filtersNodes());else{const h=mt(n);if(h===".priority")d=e.filter.updatePriority(t.eventCache.getNode(),o),c=Sr(t,d,l.isFullyInitialized(),l.isFiltered());else{const u=$t(n),p=l.getNode().getImmediateChild(h);let g;if(yt(u))g=o;else{const A=a.getCompleteChild(h);A!=null?rh(u)===".priority"&&A.getChild(qg(u)).isEmpty()?g=A:g=A.updateChild(u,o):g=it.EMPTY_NODE}if(p.equals(g))c=t;else{const A=e.filter.updateChild(l.getNode(),h,g,u,a,r);c=Sr(t,A,l.isFullyInitialized(),e.filter.filtersNodes())}}}return c}function Ef(e,t){return e.eventCache.isCompleteForChild(t)}function jS(e,t,n,o,i,s,r){let l=t;return o.foreach((c,d)=>{const a=un(n,c);Ef(t,mt(a))&&(l=gd(e,l,a,d,i,s,r))}),o.foreach((c,d)=>{const a=un(n,c);Ef(t,mt(a))||(l=gd(e,l,a,d,i,s,r))}),l}function Sf(e,t,n){return n.foreach((o,i)=>{t=t.updateChild(o,i)}),t}function md(e,t,n,o,i,s,r,l){if(t.serverCache.getNode().isEmpty()&&!t.serverCache.isFullyInitialized())return t;let c=t,d;yt(n)?d=o:d=new Qt(null).setTree(n,o);const a=t.serverCache.getNode();return d.children.inorderTraversal((h,u)=>{if(a.hasChild(h)){const p=t.serverCache.getNode().getImmediateChild(h),g=Sf(e,p,u);c=ol(e,c,new qt(h),g,i,s,r,l)}}),d.children.inorderTraversal((h,u)=>{const p=!t.serverCache.isCompleteForChild(h)&&u.value===null;if(!a.hasChild(h)&&!p){const g=t.serverCache.getNode().getImmediateChild(h),A=Sf(e,g,u);c=ol(e,c,new qt(h),A,i,s,r,l)}}),c}function JS(e,t,n,o,i,s,r){if(nl(i,n)!=null)return t;const l=t.serverCache.isFiltered(),c=t.serverCache;if(o.value!=null){if(yt(n)&&c.isFullyInitialized()||c.isCompleteForPath(n))return ol(e,t,n,c.getNode().getChild(n),i,s,l,r);if(yt(n)){let d=new Qt(null);return c.getNode().forEachChild(zi,(a,h)=>{d=d.set(new qt(a),h)}),md(e,t,n,d,i,s,l,r)}else return t}else{let d=new Qt(null);return o.foreach((a,h)=>{const u=un(n,a);c.isCompleteForPath(u)&&(d=d.set(a,c.getNode().getChild(u)))}),md(e,t,n,d,i,s,l,r)}}function QS(e,t,n,o,i){const s=t.serverCache,r=Zg(t,s.getNode(),s.isFullyInitialized()||yt(n),s.isFiltered());return sm(e,r,n,o,im,i)}function ZS(e,t,n,o,i,s){let r;if(nl(o,n)!=null)return t;{const l=new xh(o,t,i),c=t.eventCache.getNode();let d;if(yt(n)||mt(n)===".priority"){let a;if(t.serverCache.isFullyInitialized())a=tl(o,Qi(t));else{const h=t.serverCache.getNode();ye(h instanceof it,"serverChildren would be complete if leaf node"),a=mh(o,h)}a=a,d=e.filter.updateFullNode(c,a,s)}else{const a=mt(n);let h=yh(o,a,t.serverCache);h==null&&t.serverCache.isCompleteForChild(a)&&(h=c.getImmediateChild(a)),h!=null?d=e.filter.updateChild(c,a,h,$t(n),l,s):t.eventCache.getNode().hasChild(a)?d=e.filter.updateChild(c,a,it.EMPTY_NODE,$t(n),l,s):d=c,d.isEmpty()&&t.serverCache.isFullyInitialized()&&(r=tl(o,Qi(t)),r.isLeafNode()&&(d=e.filter.updateFullNode(d,r,s)))}return r=t.serverCache.isFullyInitialized()||nl(o,Ut())!=null,Sr(t,d,r,e.filter.filtersNodes())}}class kS{constructor(t,n){this.query_=t,this.eventRegistrations_=[];const o=this.query_._queryParams,i=new hh(o.getIndex()),s=yS(o);this.processor_=KS(s);const r=n.serverCache,l=n.eventCache,c=i.updateFullNode(it.EMPTY_NODE,r.getNode(),null),d=s.updateFullNode(it.EMPTY_NODE,l.getNode(),null),a=new Ji(c,r.isFullyInitialized(),i.filtersNodes()),h=new Ji(d,l.isFullyInitialized(),s.filtersNodes());this.viewCache_=Pl(h,a),this.eventGenerator_=new _S(this.query_)}get query(){return this.query_}}function e5(e){return e.viewCache_.serverCache.getNode()}function t5(e,t){const n=Qi(e.viewCache_);return n&&(e.query._queryParams.loadsAllData()||!yt(t)&&!n.getImmediateChild(mt(t)).isEmpty())?n.getChild(t):null}function Cf(e){return e.eventRegistrations_.length===0}function n5(e,t){e.eventRegistrations_.push(t)}function _f(e,t,n){const o=[];if(n){ye(t==null,"A cancel should cancel all event registrations.");const i=e.query._path;e.eventRegistrations_.forEach(s=>{const r=s.createCancelEvent(n,i);r&&o.push(r)})}if(t){let i=[];for(let s=0;s<e.eventRegistrations_.length;++s){const r=e.eventRegistrations_[s];if(!r.matches(t))i.push(r);else if(t.hasAnyCallback()){i=i.concat(e.eventRegistrations_.slice(s+1));break}}e.eventRegistrations_=i}else e.eventRegistrations_=[];return o}function Af(e,t,n,o){t.type===xo.MERGE&&t.source.queryId!==null&&(ye(Qi(e.viewCache_),"We should always have a full cache before handling merges"),ye(ud(e.viewCache_),"Missing event cache, even though we have a server cache"));const i=e.viewCache_,s=WS(e.processor_,i,t,n,o);return VS(e.processor_,s.viewCache),ye(s.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),e.viewCache_=s.viewCache,rm(e,s.changes,s.viewCache.eventCache.getNode(),null)}function o5(e,t){const n=e.viewCache_.eventCache,o=[];return n.getNode().isLeafNode()||n.getNode().forEachChild(tn,(s,r)=>{o.push(Rs(s,r))}),n.isFullyInitialized()&&o.push(Jg(n.getNode())),rm(e,o,n.getNode(),t)}function rm(e,t,n,o){const i=o?[o]:e.eventRegistrations_;return AS(e.eventGenerator_,t,n,i)}let il;class i5{constructor(){this.views=new Map}}function s5(e){ye(!il,"__referenceConstructor has already been defined"),il=e}function r5(){return ye(il,"Reference.ts has not been loaded"),il}function a5(e){return e.views.size===0}function vh(e,t,n,o){const i=t.source.queryId;if(i!==null){const s=e.views.get(i);return ye(s!=null,"SyncTree gave us an op for an invalid query."),Af(s,t,n,o)}else{let s=[];for(const r of e.views.values())s=s.concat(Af(r,t,n,o));return s}}function l5(e,t,n,o,i){const s=t._queryIdentifier,r=e.views.get(s);if(!r){let l=tl(n,i?o:null),c=!1;l?c=!0:o instanceof it?(l=mh(n,o),c=!1):(l=it.EMPTY_NODE,c=!1);const d=Pl(new Ji(l,c,!1),new Ji(o,i,!1));return new kS(t,d)}return r}function c5(e,t,n,o,i,s){const r=l5(e,t,o,i,s);return e.views.has(t._queryIdentifier)||e.views.set(t._queryIdentifier,r),n5(r,n),o5(r,n)}function d5(e,t,n,o){const i=t._queryIdentifier,s=[];let r=[];const l=Ei(e);if(i==="default")for(const[c,d]of e.views.entries())r=r.concat(_f(d,n,o)),Cf(d)&&(e.views.delete(c),d.query._queryParams.loadsAllData()||s.push(d.query));else{const c=e.views.get(i);c&&(r=r.concat(_f(c,n,o)),Cf(c)&&(e.views.delete(i),c.query._queryParams.loadsAllData()||s.push(c.query)))}return l&&!Ei(e)&&s.push(new(r5())(t._repo,t._path)),{removed:s,events:r}}function am(e){const t=[];for(const n of e.views.values())n.query._queryParams.loadsAllData()||t.push(n);return t}function Cs(e,t){let n=null;for(const o of e.views.values())n=n||t5(o,t);return n}function lm(e,t){if(t._queryParams.loadsAllData())return Ll(e);{const o=t._queryIdentifier;return e.views.get(o)}}function cm(e,t){return lm(e,t)!=null}function Ei(e){return Ll(e)!=null}function Ll(e){for(const t of e.views.values())if(t.query._queryParams.loadsAllData())return t;return null}let sl;function h5(e){ye(!sl,"__referenceConstructor has already been defined"),sl=e}function u5(){return ye(sl,"Reference.ts has not been loaded"),sl}let f5=1;class Tf{constructor(t){this.listenProvider_=t,this.syncPointTree_=new Qt(null),this.pendingWriteTree_=XS(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function dm(e,t,n,o,i){return DS(e.pendingWriteTree_,t,n,o,i),i?ta(e,new ji(Qg(),t,n)):[]}function Ni(e,t,n=!1){const o=IS(e.pendingWriteTree_,t);if(PS(e.pendingWriteTree_,t)){let s=new Qt(null);return o.snap!=null?s=s.set(Ut(),!0):Pn(o.children,r=>{s=s.set(new qt(r),!0)}),ta(e,new el(o.path,s,n))}else return[]}function Ol(e,t,n){return ta(e,new ji(fh(),t,n))}function p5(e,t,n){const o=Qt.fromObject(n);return ta(e,new qr(fh(),t,o))}function g5(e,t){return ta(e,new Xr(fh(),t))}function m5(e,t,n){const o=bh(e,n);if(o){const i=Eh(o),s=i.path,r=i.queryId,l=Xn(s,t),c=new Xr(ph(r),l);return Sh(e,s,c)}else return[]}function yd(e,t,n,o,i=!1){const s=t._path,r=e.syncPointTree_.get(s);let l=[];if(r&&(t._queryIdentifier==="default"||cm(r,t))){const c=d5(r,t,n,o);a5(r)&&(e.syncPointTree_=e.syncPointTree_.remove(s));const d=c.removed;if(l=c.events,!i){const a=d.findIndex(u=>u._queryParams.loadsAllData())!==-1,h=e.syncPointTree_.findOnPath(s,(u,p)=>Ei(p));if(a&&!h){const u=e.syncPointTree_.subtree(s);if(!u.isEmpty()){const p=v5(u);for(let g=0;g<p.length;++g){const A=p[g],m=A.query,C=fm(e,A);e.listenProvider_.startListening(_r(m),rl(e,m),C.hashFn,C.onComplete)}}}!h&&d.length>0&&!o&&(a?e.listenProvider_.stopListening(_r(t),null):d.forEach(u=>{const p=e.queryToTagMap.get(Nl(u));e.listenProvider_.stopListening(_r(u),p)}))}w5(e,d)}return l}function y5(e,t,n,o){const i=bh(e,o);if(i!=null){const s=Eh(i),r=s.path,l=s.queryId,c=Xn(r,t),d=new ji(ph(l),c,n);return Sh(e,r,d)}else return[]}function x5(e,t,n,o){const i=bh(e,o);if(i){const s=Eh(i),r=s.path,l=s.queryId,c=Xn(r,t),d=Qt.fromObject(n),a=new qr(ph(l),c,d);return Sh(e,r,a)}else return[]}function Mf(e,t,n,o=!1){const i=t._path;let s=null,r=!1;e.syncPointTree_.foreachOnPath(i,(u,p)=>{const g=Xn(u,i);s=s||Cs(p,g),r=r||Ei(p)});let l=e.syncPointTree_.get(i);l?(r=r||Ei(l),s=s||Cs(l,Ut())):(l=new i5,e.syncPointTree_=e.syncPointTree_.set(i,l));let c;s!=null?c=!0:(c=!1,s=it.EMPTY_NODE,e.syncPointTree_.subtree(i).foreachChild((p,g)=>{const A=Cs(g,Ut());A&&(s=s.updateImmediateChild(p,A))}));const d=cm(l,t);if(!d&&!t._queryParams.loadsAllData()){const u=Nl(t);ye(!e.queryToTagMap.has(u),"View does not exist, but we have a tag");const p=b5();e.queryToTagMap.set(u,p),e.tagToQueryMap.set(p,u)}const a=gh(e.pendingWriteTree_,i);let h=c5(l,t,n,a,s,c);if(!d&&!r&&!o){const u=lm(l,t);h=h.concat(E5(e,t,u))}return h}function wh(e,t,n){const i=e.pendingWriteTree_,s=e.syncPointTree_.findOnPath(t,(r,l)=>{const c=Xn(r,t),d=Cs(l,c);if(d)return d});return tm(i,t,s,n,!0)}function ta(e,t){return hm(t,e.syncPointTree_,null,gh(e.pendingWriteTree_,Ut()))}function hm(e,t,n,o){if(yt(e.path))return um(e,t,n,o);{const i=t.get(Ut());n==null&&i!=null&&(n=Cs(i,Ut()));let s=[];const r=mt(e.path),l=e.operationForChild(r),c=t.children.get(r);if(c&&l){const d=n?n.getImmediateChild(r):null,a=nm(o,r);s=s.concat(hm(l,c,d,a))}return i&&(s=s.concat(vh(i,e,o,n))),s}}function um(e,t,n,o){const i=t.get(Ut());n==null&&i!=null&&(n=Cs(i,Ut()));let s=[];return t.children.inorderTraversal((r,l)=>{const c=n?n.getImmediateChild(r):null,d=nm(o,r),a=e.operationForChild(r);a&&(s=s.concat(um(a,l,c,d)))}),i&&(s=s.concat(vh(i,e,o,n))),s}function fm(e,t){const n=t.query,o=rl(e,n);return{hashFn:()=>(e5(t)||it.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return o?m5(e,n._path,o):g5(e,n._path);{const s=yE(i,n);return yd(e,n,null,s)}}}}function rl(e,t){const n=Nl(t);return e.queryToTagMap.get(n)}function Nl(e){return e._path.toString()+"$"+e._queryIdentifier}function bh(e,t){return e.tagToQueryMap.get(t)}function Eh(e){const t=e.indexOf("$");return ye(t!==-1&&t<e.length-1,"Bad queryKey."),{queryId:e.substr(t+1),path:new qt(e.substr(0,t))}}function Sh(e,t,n){const o=e.syncPointTree_.get(t);ye(o,"Missing sync point for query tag that we're tracking");const i=gh(e.pendingWriteTree_,t);return vh(o,n,i,null)}function v5(e){return e.fold((t,n,o)=>{if(n&&Ei(n))return[Ll(n)];{let i=[];return n&&(i=am(n)),Pn(o,(s,r)=>{i=i.concat(r)}),i}})}function _r(e){return e._queryParams.loadsAllData()&&!e._queryParams.isDefault()?new(u5())(e._repo,e._path):e}function w5(e,t){for(let n=0;n<t.length;++n){const o=t[n];if(!o._queryParams.loadsAllData()){const i=Nl(o),s=e.queryToTagMap.get(i);e.queryToTagMap.delete(i),e.tagToQueryMap.delete(s)}}}function b5(){return f5++}function E5(e,t,n){const o=t._path,i=rl(e,t),s=fm(e,n),r=e.listenProvider_.startListening(_r(t),i,s.hashFn,s.onComplete),l=e.syncPointTree_.subtree(o);if(i)ye(!Ei(l.value),"If we're adding a query, it shouldn't be shadowed");else{const c=l.fold((d,a,h)=>{if(!yt(d)&&a&&Ei(a))return[Ll(a).query];{let u=[];return a&&(u=u.concat(am(a).map(p=>p.query))),Pn(h,(p,g)=>{u=u.concat(g)}),u}});for(let d=0;d<c.length;++d){const a=c[d];e.listenProvider_.stopListening(_r(a),rl(e,a))}}return r}class Ch{constructor(t){this.node_=t}getImmediateChild(t){const n=this.node_.getImmediateChild(t);return new Ch(n)}node(){return this.node_}}class _h{constructor(t,n){this.syncTree_=t,this.path_=n}getImmediateChild(t){const n=un(this.path_,t);return new _h(this.syncTree_,n)}node(){return wh(this.syncTree_,this.path_)}}const S5=function(e){return e=e||{},e.timestamp=e.timestamp||new Date().getTime(),e},Rf=function(e,t,n){if(!e||typeof e!="object")return e;if(ye(".sv"in e,"Unexpected leaf node or priority contents"),typeof e[".sv"]=="string")return C5(e[".sv"],t,n);if(typeof e[".sv"]=="object")return _5(e[".sv"],t);ye(!1,"Unexpected server value: "+JSON.stringify(e,null,2))},C5=function(e,t,n){switch(e){case"timestamp":return n.timestamp;default:ye(!1,"Unexpected server value: "+e)}},_5=function(e,t,n){e.hasOwnProperty("increment")||ye(!1,"Unexpected server value: "+JSON.stringify(e,null,2));const o=e.increment;typeof o!="number"&&ye(!1,"Unexpected increment value: "+o);const i=t.node();if(ye(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return o;const r=i.getValue();return typeof r!="number"?o:r+o},A5=function(e,t,n,o){return Ah(t,new _h(n,e),o)},pm=function(e,t,n){return Ah(e,new Ch(t),n)};function Ah(e,t,n){const o=e.getPriority().val(),i=Rf(o,t.getImmediateChild(".priority"),n);let s;if(e.isLeafNode()){const r=e,l=Rf(r.getValue(),t,n);return l!==r.getValue()||i!==r.getPriority().val()?new wn(l,pn(i)):e}else{const r=e;return s=r,i!==r.getPriority().val()&&(s=s.updatePriority(new wn(i))),r.forEachChild(tn,(l,c)=>{const d=Ah(c,t.getImmediateChild(l),n);d!==c&&(s=s.updateImmediateChild(l,d))}),s}}class Th{constructor(t="",n=null,o={children:{},childCount:0}){this.name=t,this.parent=n,this.node=o}}function Mh(e,t){let n=t instanceof qt?t:new qt(t),o=e,i=mt(n);for(;i!==null;){const s=Ts(o.node.children,i)||{children:{},childCount:0};o=new Th(i,o,s),n=$t(n),i=mt(n)}return o}function Gs(e){return e.node.value}function gm(e,t){e.node.value=t,xd(e)}function mm(e){return e.node.childCount>0}function T5(e){return Gs(e)===void 0&&!mm(e)}function Bl(e,t){Pn(e.node.children,(n,o)=>{t(new Th(n,e,o))})}function ym(e,t,n,o){n&&t(e),Bl(e,i=>{ym(i,t,!0)})}function M5(e,t,n){let o=e.parent;for(;o!==null;){if(t(o))return!0;o=o.parent}return!1}function na(e){return new qt(e.parent===null?e.name:na(e.parent)+"/"+e.name)}function xd(e){e.parent!==null&&R5(e.parent,e.name,e)}function R5(e,t,n){const o=T5(n),i=Bo(e.node.children,t);o&&i?(delete e.node.children[t],e.node.childCount--,xd(e)):!o&&!i&&(e.node.children[t]=n.node,e.node.childCount++,xd(e))}const D5=/[\[\].#$\/\u0000-\u001F\u007F]/,I5=/[\[\].#$\u0000-\u001F\u007F]/,uc=10*1024*1024,Rh=function(e){return typeof e=="string"&&e.length!==0&&!D5.test(e)},xm=function(e){return typeof e=="string"&&e.length!==0&&!I5.test(e)},P5=function(e){return e&&(e=e.replace(/^\/*\.info(\/|$)/,"/")),xm(e)},al=function(e){return e===null||typeof e=="string"||typeof e=="number"&&!Dl(e)||e&&typeof e=="object"&&Bo(e,".sv")},ll=function(e,t,n,o){o&&t===void 0||Hl(Ms(e,"value"),t,n)},Hl=function(e,t,n){const o=n instanceof qt?new QE(n,e):n;if(t===void 0)throw new Error(e+"contains undefined "+Ii(o));if(typeof t=="function")throw new Error(e+"contains a function "+Ii(o)+" with contents = "+t.toString());if(Dl(t))throw new Error(e+"contains "+t.toString()+" "+Ii(o));if(typeof t=="string"&&t.length>uc/3&&Rl(t)>uc)throw new Error(e+"contains a string greater than "+uc+" utf8 bytes "+Ii(o)+" ('"+t.substring(0,50)+"...')");if(t&&typeof t=="object"){let i=!1,s=!1;if(Pn(t,(r,l)=>{if(r===".value")i=!0;else if(r!==".priority"&&r!==".sv"&&(s=!0,!Rh(r)))throw new Error(e+" contains an invalid key ("+r+") "+Ii(o)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);ZE(o,r),Hl(e,l,o),kE(o)}),i&&s)throw new Error(e+' contains ".value" child '+Ii(o)+" in addition to actual children.")}},L5=function(e,t){let n,o;for(n=0;n<t.length;n++){o=t[n];const s=Hr(o);for(let r=0;r<s.length;r++)if(!(s[r]===".priority"&&r===s.length-1)){if(!Rh(s[r]))throw new Error(e+"contains an invalid key ("+s[r]+") in path "+o.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}t.sort(JE);let i=null;for(n=0;n<t.length;n++){if(o=t[n],i!==null&&ro(i,o))throw new Error(e+"contains a path "+i.toString()+" that is ancestor of another path "+o.toString());i=o}},O5=function(e,t,n,o){const i=Ms(e,"values");if(!(t&&typeof t=="object")||Array.isArray(t))throw new Error(i+" must be an object containing the children to replace.");const s=[];Pn(t,(r,l)=>{const c=new qt(r);if(Hl(i,l,un(n,c)),rh(c)===".priority"&&!al(l))throw new Error(i+"contains an invalid value for '"+c.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(c)}),L5(i,s)},N5=function(e,t,n){if(Dl(t))throw new Error(Ms(e,"priority")+"is "+t.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!al(t))throw new Error(Ms(e,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")},Dh=function(e,t,n,o){if(!xm(n))throw new Error(Ms(e,t)+'was an invalid path = "'+n+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},B5=function(e,t,n,o){n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Dh(e,t,n)},ws=function(e,t){if(mt(t)===".info")throw new Error(e+" failed = Can't modify data under /.info/")},H5=function(e,t){const n=t.path.toString();if(typeof t.repoInfo.host!="string"||t.repoInfo.host.length===0||!Rh(t.repoInfo.namespace)&&t.repoInfo.host.split(":")[0]!=="localhost"||n.length!==0&&!P5(n))throw new Error(Ms(e,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};class z5{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function Ih(e,t){let n=null;for(let o=0;o<t.length;o++){const i=t[o],s=i.getPath();n!==null&&!ah(s,n.path)&&(e.eventLists_.push(n),n=null),n===null&&(n={events:[],path:s}),n.events.push(i)}n&&e.eventLists_.push(n)}function vm(e,t,n){Ih(e,n),wm(e,o=>ah(o,t))}function jo(e,t,n){Ih(e,n),wm(e,o=>ro(o,t)||ro(t,o))}function wm(e,t){e.recursionDepth_++;let n=!0;for(let o=0;o<e.eventLists_.length;o++){const i=e.eventLists_[o];if(i){const s=i.path;t(s)?(U5(e.eventLists_[o]),e.eventLists_[o]=null):n=!1}}n&&(e.eventLists_=[]),e.recursionDepth_--}function U5(e){for(let t=0;t<e.events.length;t++){const n=e.events[t];if(n!==null){e.events[t]=null;const o=n.getEventRunner();br&&Mn("event: "+n.toString()),qs(o)}}}const F5="repo_interrupt",X5=25;class q5{constructor(t,n,o,i){this.repoInfo_=t,this.forceRestClient_=n,this.authTokenProvider_=o,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new z5,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=ka(),this.transactionQueueTree_=new Th,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function Y5(e,t,n){if(e.stats_=ih(e.repoInfo_),e.forceRestClient_||bE())e.server_=new Za(e.repoInfo_,(o,i,s,r)=>{Df(e,o,i,s,r)},e.authTokenProvider_,e.appCheckProvider_),setTimeout(()=>If(e,!0),0);else{if(typeof n<"u"&&n!==null){if(typeof n!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{En(n)}catch(o){throw new Error("Invalid authOverride provided: "+o)}}e.persistentConnection_=new Ko(e.repoInfo_,t,(o,i,s,r)=>{Df(e,o,i,s,r)},o=>{If(e,o)},o=>{G5(e,o)},e.authTokenProvider_,e.appCheckProvider_,n),e.server_=e.persistentConnection_}e.authTokenProvider_.addTokenChangeListener(o=>{e.server_.refreshAuthToken(o)}),e.appCheckProvider_.addTokenChangeListener(o=>{e.server_.refreshAppCheckToken(o.token)}),e.statsReporter_=AE(e.repoInfo_,()=>new CS(e.stats_,e.server_)),e.infoData_=new vS,e.infoSyncTree_=new Tf({startListening:(o,i,s,r)=>{let l=[];const c=e.infoData_.getNode(o._path);return c.isEmpty()||(l=Ol(e.infoSyncTree_,o._path,c),setTimeout(()=>{r("ok")},0)),l},stopListening:()=>{}}),Lh(e,"connected",!1),e.serverSyncTree_=new Tf({startListening:(o,i,s,r)=>(e.server_.listen(o,s,i,(l,c)=>{const d=r(l,c);jo(e.eventQueue_,o._path,d)}),[]),stopListening:(o,i)=>{e.server_.unlisten(o,i)}})}function bm(e){const n=e.infoData_.getNode(new qt(".info/serverTimeOffset")).val()||0;return new Date().getTime()+n}function Ph(e){return S5({timestamp:bm(e)})}function Df(e,t,n,o,i){e.dataUpdateCount++;const s=new qt(t);n=e.interceptServerDataCallback_?e.interceptServerDataCallback_(t,n):n;let r=[];if(i)if(o){const c=Va(n,d=>pn(d));r=x5(e.serverSyncTree_,s,c,i)}else{const c=pn(n);r=y5(e.serverSyncTree_,s,c,i)}else if(o){const c=Va(n,d=>pn(d));r=p5(e.serverSyncTree_,s,c)}else{const c=pn(n);r=Ol(e.serverSyncTree_,s,c)}let l=s;r.length>0&&(l=zl(e,s)),jo(e.eventQueue_,l,r)}function If(e,t){Lh(e,"connected",t),t===!1&&V5(e)}function G5(e,t){Pn(t,(n,o)=>{Lh(e,n,o)})}function Lh(e,t,n){const o=new qt("/.info/"+t),i=pn(n);e.infoData_.updateSnapshot(o,i);const s=Ol(e.infoSyncTree_,o,i);jo(e.eventQueue_,o,s)}function Em(e){return e.nextWriteId_++}function K5(e,t,n,o,i){Oh(e,"set",{path:t.toString(),value:n,priority:o});const s=Ph(e),r=pn(n,o),l=wh(e.serverSyncTree_,t),c=pm(r,l,s),d=Em(e),a=dm(e.serverSyncTree_,t,c,d,!0);Ih(e.eventQueue_,a),e.server_.put(t.toString(),r.val(!0),(u,p)=>{const g=u==="ok";g||Gn("set at "+t+" failed: "+u);const A=Ni(e.serverSyncTree_,d,!g);jo(e.eventQueue_,t,A),Is(e,i,u,p)});const h=Mm(e,t);zl(e,h),jo(e.eventQueue_,h,[])}function V5(e){Oh(e,"onDisconnectEvents");const t=Ph(e),n=ka();hd(e.onDisconnect_,Ut(),(i,s)=>{const r=A5(i,s,e.serverSyncTree_,t);Ys(n,i,r)});let o=[];hd(n,Ut(),(i,s)=>{o=o.concat(Ol(e.serverSyncTree_,i,s));const r=Mm(e,i);zl(e,r)}),e.onDisconnect_=ka(),jo(e.eventQueue_,Ut(),o)}function W5(e,t,n){e.server_.onDisconnectCancel(t.toString(),(o,i)=>{o==="ok"&&dd(e.onDisconnect_,t),Is(e,n,o,i)})}function Pf(e,t,n,o){const i=pn(n);e.server_.onDisconnectPut(t.toString(),i.val(!0),(s,r)=>{s==="ok"&&Ys(e.onDisconnect_,t,i),Is(e,o,s,r)})}function $5(e,t,n,o,i){const s=pn(n,o);e.server_.onDisconnectPut(t.toString(),s.val(!0),(r,l)=>{r==="ok"&&Ys(e.onDisconnect_,t,s),Is(e,i,r,l)})}function j5(e,t,n,o){if(ed(n)){Mn("onDisconnect().update() called with empty data.  Don't do anything."),Is(e,o,"ok",void 0);return}e.server_.onDisconnectMerge(t.toString(),n,(i,s)=>{i==="ok"&&Pn(n,(r,l)=>{const c=pn(l);Ys(e.onDisconnect_,un(t,r),c)}),Is(e,o,i,s)})}function J5(e,t,n){let o;mt(t._path)===".info"?o=Mf(e.infoSyncTree_,t,n):o=Mf(e.serverSyncTree_,t,n),vm(e.eventQueue_,t._path,o)}function Sm(e,t,n){let o;mt(t._path)===".info"?o=yd(e.infoSyncTree_,t,n):o=yd(e.serverSyncTree_,t,n),vm(e.eventQueue_,t._path,o)}function Q5(e){e.persistentConnection_&&e.persistentConnection_.interrupt(F5)}function Oh(e,...t){let n="";e.persistentConnection_&&(n=e.persistentConnection_.id+":"),Mn(n,...t)}function Is(e,t,n,o){t&&qs(()=>{if(n==="ok")t(null);else{const i=(n||"error").toUpperCase();let s=i;o&&(s+=": "+o);const r=new Error(s);r.code=i,t(r)}})}function Cm(e,t,n){return wh(e.serverSyncTree_,t,n)||it.EMPTY_NODE}function Nh(e,t=e.transactionQueueTree_){if(t||Ul(e,t),Gs(t)){const n=Am(e,t);ye(n.length>0,"Sending zero length transaction queue"),n.every(i=>i.status===0)&&Z5(e,na(t),n)}else mm(t)&&Bl(t,n=>{Nh(e,n)})}function Z5(e,t,n){const o=n.map(d=>d.currentWriteId),i=Cm(e,t,o);let s=i;const r=i.hash();for(let d=0;d<n.length;d++){const a=n[d];ye(a.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),a.status=1,a.retryCount++;const h=Xn(t,a.path);s=s.updateChild(h,a.currentOutputSnapshotRaw)}const l=s.val(!0),c=t;e.server_.put(c.toString(),l,d=>{Oh(e,"transaction put response",{path:c.toString(),status:d});let a=[];if(d==="ok"){const h=[];for(let u=0;u<n.length;u++)n[u].status=2,a=a.concat(Ni(e.serverSyncTree_,n[u].currentWriteId)),n[u].onComplete&&h.push(()=>n[u].onComplete(null,!0,n[u].currentOutputSnapshotResolved)),n[u].unwatcher();Ul(e,Mh(e.transactionQueueTree_,t)),Nh(e,e.transactionQueueTree_),jo(e.eventQueue_,t,a);for(let u=0;u<h.length;u++)qs(h[u])}else{if(d==="datastale")for(let h=0;h<n.length;h++)n[h].status===3?n[h].status=4:n[h].status=0;else{Gn("transaction at "+c.toString()+" failed: "+d);for(let h=0;h<n.length;h++)n[h].status=4,n[h].abortReason=d}zl(e,t)}},r)}function zl(e,t){const n=_m(e,t),o=na(n),i=Am(e,n);return k5(e,i,o),o}function k5(e,t,n){if(t.length===0)return;const o=[];let i=[];const r=t.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<t.length;l++){const c=t[l],d=Xn(n,c.path);let a=!1,h;if(ye(d!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),c.status===4)a=!0,h=c.abortReason,i=i.concat(Ni(e.serverSyncTree_,c.currentWriteId,!0));else if(c.status===0)if(c.retryCount>=X5)a=!0,h="maxretry",i=i.concat(Ni(e.serverSyncTree_,c.currentWriteId,!0));else{const u=Cm(e,c.path,r);c.currentInputSnapshot=u;const p=t[l].update(u.val());if(p!==void 0){Hl("transaction failed: Data returned ",p,c.path);let g=pn(p);typeof p=="object"&&p!=null&&Bo(p,".priority")||(g=g.updatePriority(u.getPriority()));const m=c.currentWriteId,C=Ph(e),I=pm(g,u,C);c.currentOutputSnapshotRaw=g,c.currentOutputSnapshotResolved=I,c.currentWriteId=Em(e),r.splice(r.indexOf(m),1),i=i.concat(dm(e.serverSyncTree_,c.path,I,c.currentWriteId,c.applyLocally)),i=i.concat(Ni(e.serverSyncTree_,m,!0))}else a=!0,h="nodata",i=i.concat(Ni(e.serverSyncTree_,c.currentWriteId,!0))}jo(e.eventQueue_,n,i),i=[],a&&(t[l].status=2,(function(u){setTimeout(u,Math.floor(0))})(t[l].unwatcher),t[l].onComplete&&(h==="nodata"?o.push(()=>t[l].onComplete(null,!1,t[l].currentInputSnapshot)):o.push(()=>t[l].onComplete(new Error(h),!1,null))))}Ul(e,e.transactionQueueTree_);for(let l=0;l<o.length;l++)qs(o[l]);Nh(e,e.transactionQueueTree_)}function _m(e,t){let n,o=e.transactionQueueTree_;for(n=mt(t);n!==null&&Gs(o)===void 0;)o=Mh(o,n),t=$t(t),n=mt(t);return o}function Am(e,t){const n=[];return Tm(e,t,n),n.sort((o,i)=>o.order-i.order),n}function Tm(e,t,n){const o=Gs(t);if(o)for(let i=0;i<o.length;i++)n.push(o[i]);Bl(t,i=>{Tm(e,i,n)})}function Ul(e,t){const n=Gs(t);if(n){let o=0;for(let i=0;i<n.length;i++)n[i].status!==2&&(n[o]=n[i],o++);n.length=o,gm(t,n.length>0?n:void 0)}Bl(t,o=>{Ul(e,o)})}function Mm(e,t){const n=na(_m(e,t)),o=Mh(e.transactionQueueTree_,t);return M5(o,i=>{fc(e,i)}),fc(e,o),ym(o,i=>{fc(e,i)}),n}function fc(e,t){const n=Gs(t);if(n){const o=[];let i=[],s=-1;for(let r=0;r<n.length;r++)n[r].status===3||(n[r].status===1?(ye(s===r-1,"All SENT items should be at beginning of queue."),s=r,n[r].status=3,n[r].abortReason="set"):(ye(n[r].status===0,"Unexpected transaction status in abort"),n[r].unwatcher(),i=i.concat(Ni(e.serverSyncTree_,n[r].currentWriteId,!0)),n[r].onComplete&&o.push(n[r].onComplete.bind(null,new Error("set"),!1,null))));s===-1?gm(t,void 0):n.length=s+1,jo(e.eventQueue_,na(t),i);for(let r=0;r<o.length;r++)qs(o[r])}}function eC(e){let t="";const n=e.split("/");for(let o=0;o<n.length;o++)if(n[o].length>0){let i=n[o];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}t+="/"+i}return t}function tC(e){const t={};e.charAt(0)==="?"&&(e=e.substring(1));for(const n of e.split("&")){if(n.length===0)continue;const o=n.split("=");o.length===2?t[decodeURIComponent(o[0])]=decodeURIComponent(o[1]):Gn(`Invalid query segment '${n}' in query '${e}'`)}return t}const Lf=function(e,t){const n=nC(e),o=n.namespace;n.domain==="firebase.com"&&$o(n.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!o||o==="undefined")&&n.domain!=="localhost"&&$o("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),n.secure||uE();const i=n.scheme==="ws"||n.scheme==="wss";return{repoInfo:new Lg(n.host,n.secure,o,i,t,"",o!==n.subdomain),path:new qt(n.pathString)}},nC=function(e){let t="",n="",o="",i="",s="",r=!0,l="https",c=443;if(typeof e=="string"){let d=e.indexOf("//");d>=0&&(l=e.substring(0,d-1),e=e.substring(d+2));let a=e.indexOf("/");a===-1&&(a=e.length);let h=e.indexOf("?");h===-1&&(h=e.length),t=e.substring(0,Math.min(a,h)),a<h&&(i=eC(e.substring(a,h)));const u=tC(e.substring(Math.min(e.length,h)));d=t.indexOf(":"),d>=0?(r=l==="https"||l==="wss",c=parseInt(t.substring(d+1),10)):d=t.length;const p=t.slice(0,d);if(p.toLowerCase()==="localhost")n="localhost";else if(p.split(".").length<=2)n=p;else{const g=t.indexOf(".");o=t.substring(0,g).toLowerCase(),n=t.substring(g+1),s=o}"ns"in u&&(s=u.ns)}return{host:t,port:c,domain:n,subdomain:o,secure:r,scheme:l,pathString:i,namespace:s}};const Of="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",oC=(function(){let e=0;const t=[];return function(n){const o=n===e;e=n;let i;const s=new Array(8);for(i=7;i>=0;i--)s[i]=Of.charAt(n%64),n=Math.floor(n/64);ye(n===0,"Cannot push at time == 0");let r=s.join("");if(o){for(i=11;i>=0&&t[i]===63;i--)t[i]=0;t[i]++}else for(i=0;i<12;i++)t[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)r+=Of.charAt(t[i]);return ye(r.length===20,"nextPushId: Length should be 20."),r}})();class iC{constructor(t,n,o,i){this.eventType=t,this.eventRegistration=n,this.snapshot=o,this.prevName=i}getPath(){const t=this.snapshot.ref;return this.eventType==="value"?t._path:t.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+En(this.snapshot.exportVal())}}class sC{constructor(t,n,o){this.eventRegistration=t,this.error=n,this.path=o}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class rC{constructor(t,n){this.snapshotCallback=t,this.cancelCallback=n}onValue(t,n){this.snapshotCallback.call(null,t,n)}onCancel(t){return ye(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,t)}get hasCancelCallback(){return!!this.cancelCallback}matches(t){return this.snapshotCallback===t.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===t.snapshotCallback.userCallback&&this.snapshotCallback.context===t.snapshotCallback.context}}class aC{constructor(t,n){this._repo=t,this._path=n}cancel(){const t=new Yo;return W5(this._repo,this._path,t.wrapCallback(()=>{})),t.promise}remove(){ws("OnDisconnect.remove",this._path);const t=new Yo;return Pf(this._repo,this._path,null,t.wrapCallback(()=>{})),t.promise}set(t){ws("OnDisconnect.set",this._path),ll("OnDisconnect.set",t,this._path,!1);const n=new Yo;return Pf(this._repo,this._path,t,n.wrapCallback(()=>{})),n.promise}setWithPriority(t,n){ws("OnDisconnect.setWithPriority",this._path),ll("OnDisconnect.setWithPriority",t,this._path,!1),N5("OnDisconnect.setWithPriority",n);const o=new Yo;return $5(this._repo,this._path,t,n,o.wrapCallback(()=>{})),o.promise}update(t){ws("OnDisconnect.update",this._path),O5("OnDisconnect.update",t,this._path);const n=new Yo;return j5(this._repo,this._path,t,n.wrapCallback(()=>{})),n.promise}}class Fl{constructor(t,n,o,i){this._repo=t,this._path=n,this._queryParams=o,this._orderByCalled=i}get key(){return yt(this._path)?null:rh(this._path)}get ref(){return new Ti(this._repo,this._path)}get _queryIdentifier(){const t=mf(this._queryParams),n=nh(t);return n==="{}"?"default":n}get _queryObject(){return mf(this._queryParams)}isEqual(t){if(t=Ai(t),!(t instanceof Fl))return!1;const n=this._repo===t._repo,o=ah(this._path,t._path),i=this._queryIdentifier===t._queryIdentifier;return n&&o&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+jE(this._path)}}function lC(e,t){if(e._orderByCalled===!0)throw new Error(t+": You can't combine multiple orderBy calls.")}function cC(e){let t=null,n=null;if(e.hasStart()&&(t=e.getIndexStartValue()),e.hasEnd()&&(n=e.getIndexEndValue()),e.getIndex()===zi){const o="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(e.hasStart()){if(e.getIndexStartName()!==$i)throw new Error(o);if(typeof t!="string")throw new Error(i)}if(e.hasEnd()){if(e.getIndexEndName()!==wi)throw new Error(o);if(typeof n!="string")throw new Error(i)}}else if(e.getIndex()===tn){if(t!=null&&!al(t)||n!=null&&!al(n))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(ye(e.getIndex()instanceof dh||e.getIndex()===jg,"unknown index type."),t!=null&&typeof t=="object"||n!=null&&typeof n=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}class Ti extends Fl{constructor(t,n){super(t,n,new uh,!1)}get parent(){const t=qg(this._path);return t===null?null:new Ti(this._repo,t)}get root(){let t=this;for(;t.parent!==null;)t=t.parent;return t}}class cl{constructor(t,n,o){this._node=t,this.ref=n,this._index=o}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(t){const n=new qt(t),o=Yr(this.ref,t);return new cl(this._node.getChild(n),o,tn)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(t){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(o,i)=>t(new cl(i,Yr(this.ref,o),tn)))}hasChild(t){const n=new qt(t);return!this._node.getChild(n).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function dC(e,t){return e=Ai(e),e._checkNotDeleted("ref"),Yr(e._root,t)}function Yr(e,t){return e=Ai(e),mt(e._path)===null?B5("child","path",t):Dh("child","path",t),new Ti(e._repo,un(e._path,t))}function hC(e){return e=Ai(e),new aC(e._repo,e._path)}function uC(e,t){e=Ai(e),ws("push",e._path),ll("push",t,e._path,!0);const n=bm(e._repo),o=oC(n),i=Yr(e,o),s=Yr(e,o);let r;return r=Promise.resolve(s),i.then=r.then.bind(r),i.catch=r.then.bind(r,void 0),i}function fC(e,t){e=Ai(e),ws("set",e._path),ll("set",t,e._path,!1);const n=new Yo;return K5(e._repo,e._path,t,null,n.wrapCallback(()=>{})),n.promise}class Bh{constructor(t){this.callbackContext=t}respondsTo(t){return t==="value"}createEvent(t,n){const o=n._queryParams.getIndex();return new iC("value",this,new cl(t.snapshotNode,new Ti(n._repo,n._path),o))}getEventRunner(t){return t.getEventType()==="cancel"?()=>this.callbackContext.onCancel(t.error):()=>this.callbackContext.onValue(t.snapshot,null)}createCancelEvent(t,n){return this.callbackContext.hasCancelCallback?new sC(this,t,n):null}matches(t){return t instanceof Bh?!t.callbackContext||!this.callbackContext?!0:t.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}}function pC(e,t,n,o,i){const s=new rC(n,void 0),r=new Bh(s);return J5(e._repo,e,r),()=>Sm(e._repo,e,r)}function gC(e,t,n,o){return pC(e,"value",t)}function mC(e,t,n){Sm(e._repo,e,null)}class yC{}class xC extends yC{constructor(t){super(),this._path=t,this.type="orderByChild"}_apply(t){lC(t,"orderByChild");const n=new qt(this._path);if(yt(n))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");const o=new dh(n),i=xS(t._queryParams,o);return cC(i),new Fl(t._repo,t._path,i,!0)}}function vC(e){return Dh("orderByChild","path",e),new xC(e)}function wC(e,...t){let n=Ai(e);for(const o of t)n=o._apply(n);return n}s5(Ti);h5(Ti);const bC="FIREBASE_DATABASE_EMULATOR_HOST",vd={};let EC=!1;function SC(e,t,n,o){e.repoInfo_=new Lg(`${t}:${n}`,!1,e.repoInfo_.namespace,e.repoInfo_.webSocketOnly,e.repoInfo_.nodeAdmin,e.repoInfo_.persistenceKey,e.repoInfo_.includeNamespaceInQueryParams,!0),o&&(e.authTokenProvider_=o)}function CC(e,t,n,o,i){let s=o||e.options.databaseURL;s===void 0&&(e.options.projectId||$o("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),Mn("Using default host for project ",e.options.projectId),s=`${e.options.projectId}-default-rtdb.firebaseio.com`);let r=Lf(s,i),l=r.repoInfo,c;typeof process<"u"&&Qu&&(c=Qu[bC]),c?(s=`http://${c}?ns=${l.namespace}`,r=Lf(s,i),l=r.repoInfo):r.repoInfo.secure;const d=new SE(e.name,e.options,t);H5("Invalid Firebase Database URL",r),yt(r.path)||$o("Database URL must point to the root of a Firebase Database (not including a child path).");const a=AC(l,e,d,new EE(e.name,n));return new TC(a,e)}function _C(e,t){const n=vd[t];(!n||n[e.key]!==e)&&$o(`Database ${t}(${e.repoInfo_}) has already been deleted.`),Q5(e),delete n[e.key]}function AC(e,t,n,o){let i=vd[t.name];i||(i={},vd[t.name]=i);let s=i[e.toURLString()];return s&&$o("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new q5(e,EC,n,o),i[e.toURLString()]=s,s}class TC{constructor(t,n){this._repoInternal=t,this.app=n,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(Y5(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new Ti(this._repo,Ut())),this._rootInternal}_delete(){return this._rootInternal!==null&&(_C(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(t){this._rootInternal===null&&$o("Cannot call "+t+" on a deleted database.")}}function MC(e=$2(),t){const n=G2(e,"database").getImmediate({identifier:t});if(!n._instanceStarted){const o=Lb("database");o&&RC(n,...o)}return n}function RC(e,t,n,o={}){e=Ai(e),e._checkNotDeleted("useEmulator"),e._instanceStarted&&$o("Cannot call useEmulator() after instance has already been initialized.");const i=e._repoInternal;let s;if(i.repoInfo_.nodeAdmin)o.mockUserToken&&$o('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),s=new Ra(Ra.OWNER);else if(o.mockUserToken){const r=typeof o.mockUserToken=="string"?o.mockUserToken:Ob(o.mockUserToken,e.app.options.projectId);s=new Ra(r)}SC(i,t,n,s)}function DC(e){rE(W2),$a(new Or("database",(t,{instanceIdentifier:n})=>{const o=t.getProvider("app").getImmediate(),i=t.getProvider("auth-internal"),s=t.getProvider("app-check-internal");return CC(o,i,s,n)},"PUBLIC").setMultipleInstances(!0)),Es(Zu,ku,e),Es(Zu,ku,"esm2017")}Ko.prototype.simpleListen=function(e,t){this.sendRequest("q",{p:e},t)};Ko.prototype.echo=function(e,t){this.sendRequest("echo",{d:e},t)};DC();const wd={apiKey:"AIzaSyCiodw7WUk-nxFoTDUpCVFF7hA9RUObQj4",authDomain:"supersmashtexty.firebaseapp.com",databaseURL:"https://supersmashtexty-default-rtdb.firebaseio.com",projectId:"supersmashtexty",storageBucket:"supersmashtexty.firebasestorage.app",messagingSenderId:"212983770797",appId:"1:212983770797:web:000257ef09b3b68fb3e024"};let Nf=null,Rm=null,Bf=!1,ci=!1,Ui=null,bs=null,Gr=null,dl=null,pc=!1;function IC(){if(Bf)return!0;try{return wd.apiKey==="YOUR_API_KEY"?(console.warn("[Matchmaking] Firebase not configured. Please update firebaseConfig in matchmakingSystem.js"),!1):(Nf=mg(wd),Rm=MC(Nf),Bf=!0,console.log("[Matchmaking] Firebase initialized"),!0)}catch(e){return console.error("[Matchmaking] Failed to initialize Firebase:",e),!1}}function PC(e){Gr=e,console.log("[Matchmaking] Global match handler set up")}function Hf(){return ci}async function LC(e={}){if(ci)return console.log("[Matchmaking] Already searching"),!1;if(!IC())return e.onError?.("Firebase not configured"),!1;if(HC())return console.log("[Matchmaking] Party is full, cannot search"),e.onError?.("Party is full"),!1;dl=e,ci=!0,e.onSearchStart?.();try{const t=Yn(),n=vi(),o=dC(Rm,"matchmaking/queue");return Ui=uC(o),await fC(Ui,{inviteCode:n,playerName:t,timestamp:Date.now()}),hC(Ui).remove(),console.log("[Matchmaking] Added to queue:",n),bs=wC(o,vC("timestamp")),gC(bs,async i=>{if(!ci)return;const s=i.val();if(!s)return;const r=Date.now(),l=6e4,c=Object.entries(s).map(([d,a])=>({key:d,...a})).filter(d=>d.timestamp).filter(d=>r-d.timestamp<l).sort((d,a)=>d.timestamp-a.timestamp);if(console.log("[Matchmaking] Queue updated:",c.length,"active players"),c.length>=2){if(!c.find(h=>h.inviteCode===n))return;const a=c[0];if(a.inviteCode===n)console.log("[Matchmaking] We are the host, waiting for players to join...");else{console.log("[Matchmaking] Found host:",a.inviteCode,"- attempting to join"),Hh(!1),await new Promise(h=>setTimeout(h,500));try{await Im(a.inviteCode)?(console.log("[Matchmaking] Successfully joined host"),e.onMatchFound?.(a.inviteCode),Gr&&Gr.go("menu")):(console.log("[Matchmaking] Failed to join host, restarting search"),e.onError?.("Failed to connect to host"))}catch(h){console.error("[Matchmaking] Error joining host:",h),e.onError?.("Connection error")}e.onSearchEnd?.()}}}),!0}catch(t){return console.error("[Matchmaking] Failed to start matchmaking:",t),ci=!1,e.onError?.(t.message),e.onSearchEnd?.(),!1}}function Hh(e=!0){if(pc||!ci&&!Ui&&!bs)return;pc=!0,console.log("[Matchmaking] Stopping matchmaking"),ci=!1,bs&&(mC(bs),bs=null),Ui&&(Ui=null);const t=dl;dl=null,e&&t?.onSearchEnd&&t.onSearchEnd(),pc=!1}function OC(){if(Zi().isHost&&(ci||Ui)){console.log("[Matchmaking] Player joined our party - stopping matchmaking");const t=dl;Hh(!1),t?.onMatchFound?.(null),t?.onSearchEnd?.(),Gr&&Gr.go("menu")}}function NC(){return wd.apiKey!=="YOUR_API_KEY"}const k={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!0,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!1,peerId:null,isReady:!1}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null,hostInviteCode:null,disconnectedPlayers:new Map,reconnectWindow:15e3,countdownActive:!1,countdownStartTime:0,countdownDuration:3e3,activeEmotes:new Map,emoteCallbacks:[]};let Kr=!1,Vr=!1;async function Dm(e=null){if(e&&(k.kaplayInstance=e),k.isHost){const t=Yn(),n=vi(),o=Qo(),i=Fs();k.slots[0].playerId="local",k.slots[0].playerName=t,k.slots[0].inviteCode=n,k.slots[0].selectedCharacter=o,k.slots[0].selectedPortrait=i,k.slots[0].playerLevel=_i(),k.slots[0].isLocal=!0,k.slots[0].permanentUpgradeLevels={startingHealth:zt("startingHealth"),startingDamage:zt("startingDamage"),startingSpeed:zt("startingSpeed"),propDurability:zt("propDurability"),propDropChance:zt("propDropChance")},console.log("[PartySystem] Host player initialized in slot 0:",{name:k.slots[0].playerName,code:k.slots[0].inviteCode,character:k.slots[0].selectedCharacter})}else console.log("[PartySystem] Client mode - preserving existing slot assignments");if(!k.networkInitialized)try{console.log("[PartySystem] Initializing network as host...");const t=vi(),n=await Zd(t,!0);n!==t&&(console.log(`[PartySystem] Invite code changed: ${t} -> ${n}`),nb(n),k.slots[0].inviteCode=n),k.networkInitialized=!0,k.isHost=!0,BC(),console.log("[PartySystem] Network initialized as host - ready to accept connections")}catch(t){console.error("[PartySystem] Failed to initialize network as host:",t),console.log("[PartySystem] Multiplayer disabled - running in single-player mode")}}function BC(){Kr||(Kr=!0,Ue("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const n=zC(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",e.selectedPortrait||"default",t,e.permanentUpgradeLevels||null,e.playerLevel||1);if(n!==null){const o={slots:k.slots.map(i=>({playerId:i.playerId,playerName:i.playerName,inviteCode:i.inviteCode,selectedCharacter:i.selectedCharacter,selectedPortrait:i.selectedPortrait,playerLevel:i.playerLevel,permanentUpgradeLevels:i.permanentUpgradeLevels,isLocal:!1})),yourSlotIndex:n};console.log("[PartySystem] Sending party_sync to new player:",{hostName:o.slots[0].playerName,hostCharacter:o.slots[0].selectedCharacter,newPlayerSlot:n}),yo(t,"party_sync",o),setTimeout(()=>{__(t)},250),Bi(),OC()}else yo(t,"join_rejected",{reason:"Party full"})}),Ue("player_info",(e,t)=>{const n=k.peerIdToSlot.get(t);n!==void 0&&(e.playerName&&(k.slots[n].playerName=e.playerName),Bi())}),Ue("character_change",(e,t)=>{const n=k.peerIdToSlot.get(t);n!==void 0&&(console.log(`[PartySystem] Player in slot ${n} changed character to:`,e.selectedCharacter),k.slots[n].selectedCharacter=e.selectedCharacter,Bi())}),Ue("ready_change",(e,t)=>{const n=k.peerIdToSlot.get(t);n!==void 0&&(console.log(`[PartySystem] Player in slot ${n} ready state:`,e.isReady),k.slots[n].isReady=e.isReady,Bi(),Pm())}),Ue("party_emote",(e,t)=>{const n=k.peerIdToSlot.get(t);n!==void 0&&(e.slotIndex=n,zh(e),Je("party_emote",e))}),Ue("profile_request",(e,t)=>{const n=e.targetSlot;if(n===0)Om(e,t);else{const o=k.slots[n]?.peerId;o&&yo(o,"profile_request",{requestingSlot:k.peerIdToSlot.get(t),forwardTo:t})}}),Ue("profile_response",(e,t)=>{const n=k.peerIdToSlot.get(t);n!==void 0&&(e.slotIndex=n,e.forwardTo?yo(e.forwardTo,"profile_response",e):Nm(e))}),og((e,t)=>{e==="leave"&&FC(t)}))}function Zi(){return k}function ri(){return k.slots.filter(e=>e.playerId!==null).length}function HC(){return ri()>=k.maxSlots}function zf(){return!k.isHost&&k.hostInviteCode?k.hostInviteCode:vi()}function zC(e,t,n,o,i,s=null,r=1){for(let l=1;l<k.slots.length;l++)if(k.slots[l].playerId===null)return k.slots[l].playerId=`player_${Date.now()}_${l}`,k.slots[l].playerName=e,k.slots[l].inviteCode=t,k.slots[l].selectedCharacter=n,k.slots[l].selectedPortrait=o,k.slots[l].playerLevel=r,k.slots[l].peerId=i,k.slots[l].permanentUpgradeLevels=s,k.peerIdToSlot.set(i,l),l;return null}async function Im(e){const t={playerName:Yn(),inviteCode:vi(),selectedCharacter:Qo()};try{console.log("[PartySystem] Joining as client - clearing all party slots");for(let n=0;n<k.slots.length;n++)k.slots[n]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!1,peerId:null,isReady:!1};return k.networkInitialized&&k.isHost&&(console.log("[PartySystem] Switching from host to client - disconnecting current peer..."),kd(),k.networkInitialized=!1,k.isHost=!1,Kr=!1,Vr=!1),k.networkInitialized||(await Zd("client",!1),k.networkInitialized=!0,k.isHost=!1),k.hostInviteCode=e,UC(),await Eb(e),Ln("join_request",{playerName:t.playerName,inviteCode:t.inviteCode,selectedCharacter:t.selectedCharacter,selectedPortrait:Fs()||"default",playerLevel:_i(),permanentUpgradeLevels:{startingHealth:zt("startingHealth"),startingDamage:zt("startingDamage"),startingSpeed:zt("startingSpeed"),propDurability:zt("propDurability"),propDropChance:zt("propDropChance")}}),!0}catch(n){return console.error("Failed to join party:",n),console.log("[PartySystem] Restoring local player after join failure"),hl(t),!1}}function hl(e){k.networkInitialized&&!k.isHost&&kd(),k.isHost=!0,k.hostInviteCode=null,k.networkInitialized=!1,Kr=!1,Vr=!1;for(let t=0;t<k.slots.length;t++)k.slots[t]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!1,peerId:null,isReady:!1};k.slots[0]={playerId:"local",playerName:e.playerName||Yn(),inviteCode:e.inviteCode||vi(),selectedCharacter:e.selectedCharacter||Qo(),selectedPortrait:Fs(),playerLevel:_i(),isLocal:!0,peerId:null},Dm(k.kaplayInstance).catch(t=>{console.warn("[PartySystem] Failed to re-initialize as host:",t)})}function UC(){Vr||(Vr=!0,Ue("party_sync",e=>{console.log("[PartySystem] Received party sync:",{hostName:e.slots[0].playerName,hostCharacter:e.slots[0].selectedCharacter,yourSlot:e.yourSlotIndex,totalSlots:e.slots.filter(n=>n.playerId!==null).length}),k.slots=e.slots,e.yourSlotIndex!==void 0&&(k.slots[e.yourSlotIndex].isLocal=!0,console.log(`[PartySystem] Marked slot ${e.yourSlotIndex} as local`)),k.slots[0].isLocal=!1;const t=k.slots.filter(n=>n.playerId!==null).length;console.log("[PartySystem] Party synced successfully:",{partySize:t,hostInSlot0:k.slots[0].playerName,localSlot:e.yourSlotIndex})}),Ue("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),Ue("game_start",e=>{console.log("Host started game - joining..."),k.kaplayInstance?k.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),Ue("countdown_start",e=>{console.log("[PartySystem] Countdown started by host:",e.duration),k.countdownActive=!0,k.countdownStartTime=Date.now(),k.countdownDuration=e.duration||3e3}),Ue("countdown_cancel",()=>{console.log("[PartySystem] Countdown cancelled by host"),k.countdownActive=!1,k.countdownStartTime=0}),Ue("party_update",e=>{const t=k.slots.findIndex(n=>n.isLocal);k.slots=e.slots,t!==-1&&(k.slots[t].isLocal=!0)}),Ue("party_emote",e=>{zh(e)}),Ue("profile_request",e=>{Om()}),Ue("profile_response",e=>{Nm(e)}),og(e=>{if(e==="host_disconnect"){console.log("[PartySystem] Host disconnected - returning to solo party"),alert("Host disconnected - returning to main menu");const t={playerName:Yn(),inviteCode:vi(),selectedCharacter:Qo()};hl(t),k.kaplayInstance&&k.kaplayInstance.go("menu")}}))}function Bi(){k.isHost&&Je("party_update",{slots:k.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,selectedPortrait:e.selectedPortrait,permanentUpgradeLevels:e.permanentUpgradeLevels,isLocal:!1,isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))})}function Uf(){k.isHost&&(console.log("Broadcasting game start to all clients"),Je("game_start",{}))}function FC(e){const t=k.peerIdToSlot.get(e);if(t!==void 0){console.log("[PartySystem] Player disconnected from slot",t,"- starting reconnection window");const n={...k.slots[t]};k.disconnectedPlayers.set(t,{disconnectTime:Date.now(),playerData:n,peerId:e}),k.slots[t].isDisconnected=!0,Je("player_disconnected",{slotIndex:t,reconnectWindow:k.reconnectWindow}),k.peerIdToSlot.delete(e),setTimeout(()=>{XC(t)},k.reconnectWindow)}}function XC(e){k.disconnectedPlayers.get(e)&&(console.log("[PartySystem] Reconnection window expired for slot",e,"- removing player"),b_(e),qC(e),k.disconnectedPlayers.delete(e),Je("player_removed",{slotIndex:e}),Bi())}function qC(e){if(e>0&&e<k.slots.length){const t=k.slots[e].peerId;return t&&k.peerIdToSlot.delete(t),k.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,playerLevel:1,isLocal:!1,peerId:null,isReady:!1},!0}return!1}function YC(){return k.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter||"survivor",selectedPortrait:e.selectedPortrait||"default",playerLevel:e.playerLevel||1,isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))}function Ff(e){k.slots[0].selectedCharacter=e,k.networkInitialized&&(k.isHost?Bi():Ln("character_change",{selectedCharacter:e}))}function GC(){const e=Ps();return e===null?!1:(k.slots[e].isReady=!k.slots[e].isReady,k.networkInitialized&&(k.isHost?(Bi(),Pm()):Ln("ready_change",{isReady:k.slots[e].isReady})),k.slots[e].isReady)}function Ps(){const e=k.slots.findIndex(t=>t.isLocal);return e>=0?e:null}function KC(){const e=Ps();return e!==null&&k.slots[e].isReady}function Xf(){const e=k.slots.filter(t=>t.playerId!==null);return e.length<2?!1:e.every(t=>t.isReady)}function Pm(){k.isHost&&(Xf()&&!k.countdownActive?VC():!Xf()&&k.countdownActive&&WC())}function VC(){k.isHost&&(k.countdownActive=!0,k.countdownStartTime=Date.now(),Je("countdown_start",{duration:k.countdownDuration}),console.log("[PartySystem] Countdown started"))}function WC(){k.isHost&&(k.countdownActive=!1,k.countdownStartTime=0,Je("countdown_cancel",{}),console.log("[PartySystem] Countdown cancelled"))}function qf(){if(!k.countdownActive)return{active:!1,timeRemaining:0};const e=Date.now()-k.countdownStartTime;return{active:!0,timeRemaining:Math.max(0,k.countdownDuration-e)}}function zh(e){const{slotIndex:t,emoteType:n}=e;k.activeEmotes.set(t,{emoteType:n,startTime:Date.now()}),k.emoteCallbacks.forEach(o=>{try{o(t,n)}catch(i){console.error("[PartySystem] Emote callback error:",i)}})}function Yf(e){const t=Ps();if(t===null)return;const n={slotIndex:t,emoteType:e};zh(n),k.networkInitialized&&(k.isHost?Je("party_emote",n):Ln("party_emote",n))}function $C(e){k.emoteCallbacks.push(e)}function jC(e){const t=k.emoteCallbacks.indexOf(e);t!==-1&&k.emoteCallbacks.splice(t,1)}function JC(e,t=2e3){const n=k.activeEmotes.get(e);return n?Date.now()-n.startTime>t?(k.activeEmotes.delete(e),null):n.emoteType:null}function QC(){k.emoteCallbacks=[],k.activeEmotes.clear(),Kr=!1,Vr=!1}const Li=new Map;function Lm(){return{playerName:Yn(),selectedPortrait:Fs(),playerLevel:_i(),totalXP:Ml(),stats:Us(),achievements:Z0(),unlockedPortraits:eg()}}function ZC(e,t){const n=k.slots[e];if(!n||n.playerId===null){console.warn("[PartySystem] Cannot request profile for empty slot:",e),t(null);return}if(n.isLocal){t(Lm());return}if(Li.set(e,t),k.isHost){const o=n.peerId;o?yo(o,"profile_request",{requestingSlot:Ps()}):(console.warn("[PartySystem] No peerId for slot:",e),t(null),Li.delete(e))}else Ln("profile_request",{targetSlot:e});setTimeout(()=>{if(Li.has(e)){console.warn("[PartySystem] Profile request timed out for slot:",e);const o=Li.get(e);Li.delete(e),o(null)}},5e3)}function Om(e,t=null){const n=Lm();k.isHost&&t?yo(t,"profile_response",{slotIndex:Ps(),profileData:n}):Ln("profile_response",{slotIndex:Ps(),profileData:n})}function Nm(e){const{slotIndex:t,profileData:n}=e,o=Li.get(t);o&&(Li.delete(t),o(n))}const Io={gatekeeper:{name:"Studio Head",coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{name:"Showrunner",coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{name:"Co-Host (Melee)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{name:"Co-Host (Ranged)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function kC(e){return Io[e]||Io.gatekeeper}function ul(e,t,n,o="gatekeeper",i=1,s=null){const r=kC(o),l=1+(i-1)*.2,c={coreChar:r.coreChar,armorChar:r.armorChar||"()",shieldChar:r.shieldChar||"{}",color:r.color,armorColor:r.armorColor||[200,200,200],shieldColor:r.shieldColor||[100,200,255],health:Math.floor(r.baseHealth*l),armorHealth:Math.floor((r.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((r.baseArmorHealth||0)*l),shieldHealth:Math.floor((r.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((r.baseShieldHealth||0)*l),speed:Math.floor(r.baseSpeed*(1+(i-1)*.05)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),damageReduction:r.damageReduction||0,shieldRegenRate:(r.shieldRegenRate||0)*l};function d(){const h=c.armorHealth>c.maxArmorHealth*.5?"(":"",u=c.armorHealth>0?")":"";return`${h}${c.coreChar}${u}`}const a=e.add([e.text(d(),{size:c.size}),e.pos(t,n),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"boss"]);return a.maxHealth=c.health,a.speed=c.speed,a.xpValue=c.xpValue,a.type=o,a.floor=i,a.textSize=c.size,a.rng=s,r.meleeDamage&&(a.meleeDamage=r.meleeDamage),r.projectileDamage&&(a.projectileDamage=r.projectileDamage),r.projectileSpeed&&(a.projectileSpeed=r.projectileSpeed),r.fireRate&&(a.fireRate=r.fireRate),(o==="twinGuardianMelee"||o==="twinGuardianRanged")&&(a.enraged=!1,a.enrage=function(){this.enraged||(this.enraged=!0,this.speed=Math.floor(this.speed*1.5),this.type==="twinGuardianMelee"?(this.chargeCooldownTimer=0,this.meleeDamage=Math.floor(this.meleeDamage*1.25)):(this.fireRate=this.fireRate*1.5,this.projectileDamage=Math.floor(this.projectileDamage*1.25)),this.color=e.rgb(255,200,0))}),a.armorHealth=c.armorHealth,a.maxArmorHealth=c.maxArmorHealth,a.damageReduction=c.damageReduction,a.coreChar=c.coreChar,a.armorChar=c.armorChar,a.armorColor=c.armorColor,a.shieldHealth=c.shieldHealth,a.maxShieldHealth=c.maxShieldHealth,a.shieldRegenRate=c.shieldRegenRate,a.shieldChar=c.shieldChar,a.shieldColor=c.shieldColor,a.shieldRegenTimer=0,a.shieldRegenCooldown=0,a.lastDamageTime=0,a.updateVisual=function(){let h="",u="",p="",g="";if(a.shieldHealth>0){const m=a.shieldHealth/a.maxShieldHealth;m>.66?(h="",u=""):m>.33?(h="",u=""):(h="",u="")}if(a.armorHealth>0){const m=a.armorHealth/a.maxArmorHealth;m>.66?(p="",g=""):m>.33?(p="",g=""):(p="",g="")}const A=`${h}${p}${a.coreChar}${g}${u}`;a.text=A,a.shieldHealth>0?a.color=e.rgb(...c.shieldColor):a.color=e.rgb(...c.color)},a.takeDamage=function(h){let u=!1,p=!1;const g=a.shieldHealth,A=a.armorHealth;a.lastDamageTime=e.time();const m=3;if(a.shieldRegenCooldown=m,a.shieldHealth>0){const C=Math.min(h,a.shieldHealth);a.shieldHealth=Math.max(0,a.shieldHealth-C),u=a.shieldHealth!==g;const I=h-C;I>0&&a.takeDamageInternal(I)}else a.takeDamageInternal(h);p=a.armorHealth!==A,(u||p)&&a.updateVisual()},a.takeDamageInternal=function(h){if(a.armorHealth>0){const u=Math.floor(h*(1-a.damageReduction)),p=Math.min(u,a.armorHealth);a.armorHealth=Math.max(0,a.armorHealth-p);const g=h-u;if(g>0){const A=a.armorHealth>0?1-a.damageReduction:1,m=Math.floor(g*A);a.hurt(m)}}else a.hurt(h)},a.attackTimer=0,a.minionSpawnTimer=0,a.chargeCooldownTimer=0,a.chargeDurationTimer=0,a.radialBurstTimer=0,a.isCharging=!1,a.chargeDirection=null,a.chargeSpeed=0,a.spawnedMinions=[],a.enraged=!1,a.twinPartner=null,a.getPhase=function(){const h=a.hp()/a.maxHealth;return h>.75?1:h>.5?2:3},a.spawnMinions=function(){if(!a.exists())return;const h=a.getPhase(),u=h===1?2:3;for(let p=0;p<u;p++){const g=a.rng?a.rng.next()*.5:Math.random()*.5,A=Math.PI*2/u*p+g,C=40+(a.rng?a.rng.next()*20:Math.random()*20),I=a.pos.x+Math.cos(A)*C,R=a.pos.y+Math.sin(A)*C,N=(a.rng?a.rng.next():Math.random())<.5?"rusher":"basic",b=mi(e,I,R,N,i);b.isBossMinion=!0,a.spawnedMinions.push(b),de()&&ve()&&fo(b,{type:N,floor:i,isBossMinion:!0})}},a.radialBurst=function(){if(!a.exists())return;const h=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];a.getPhase();const u=200,p=12;h.forEach(g=>{const A=Qn(e,a.pos.x,a.pos.y,g,u,p,0,0,!1);A.isBossProjectile=!0,A.color=e.rgb(255,100,100)})},a.startCharge=function(h){if(!a.exists())return;a.isCharging=!0;const u=e.vec2(h.x-a.pos.x,h.y-a.pos.y);if(u.len()>0&&(a.chargeDirection=u.unit(),!a.chargeSpeed||a.chargeSpeed===0)){const p=a.getPhase?a.getPhase():1;a.chargeSpeed=a.speed*(p===1?2.5:p===2?3:3.5)}},a.onUpdate(()=>{if(e.paused)return;if(a.shieldRegenRate>0&&a.shieldHealth<a.maxShieldHealth&&a.hp()>0&&!a.isDead&&(a.shieldRegenCooldown>0&&(a.shieldRegenCooldown-=e.dt()),a.shieldRegenCooldown<=0)){a.shieldRegenTimer+=e.dt();const C=1;if(a.shieldRegenTimer>=C){const I=a.shieldRegenRate*C;a.shieldHealth=Math.min(a.maxShieldHealth,a.shieldHealth+I),a.shieldRegenTimer=0,a.shieldHealth>0&&a.updateVisual()}}a.burnDuration>0&&a.hp()>0&&!a.isDead&&(a.burnTimer=(a.burnTimer||0)+e.dt(),a.burnTimer>=.5&&((!de()||ve())&&(a.takeDamage?a.takeDamage(a.burnDamage):a.hurt(a.burnDamage)),a.color,a.color=e.rgb(255,150,50),e.wait(.1,()=>{a.exists()&&a.updateVisual()}),a.burnTimer=0),a.burnDuration-=e.dt(),a.burnDuration<=0&&(a.burnDamage=0,a.burnTimer=0));const h=e.get("player")[0];if(!h||!h.exists())return;const u=a.getPhase();if(a.type==="gatekeeper"){a.attackTimer+=e.dt(),a.minionSpawnTimer+=e.dt(),a.radialBurstTimer+=e.dt();const C=u===1?8:u===2?6:5,I=10,R=u===1?8:u===2?6:5;if(a.isCharging){const f=a.chargeDirection.scale(a.chargeSpeed*e.dt());a.pos.x+=f.x,a.pos.y+=f.y,a.chargeDurationTimer+=e.dt(),a.chargeDurationTimer>=1&&(a.isCharging=!1,a.chargeDurationTimer=0,a.chargeCooldownTimer=0)}else{a.chargeCooldownTimer+=e.dt();const f=e.vec2(h.pos.x-a.pos.x,h.pos.y-a.pos.y);if(f.len()>0){const b=f.unit(),T=a.speed*(u===1?1:u===2?1.2:1.5),x=b.scale(T*e.dt()),M=a.pos.x+x.x,_=a.pos.y+x.y;let O=!0,P=!0;const z=e.get("obstacle"),U=a.size||14;for(const F of z){if(!F.exists())continue;const B=F.pos.x-F.width/2,D=F.pos.x+F.width/2,q=F.pos.y-F.height/2,G=F.pos.y+F.height/2,Z=M-U,le=M+U,ie=a.pos.y-U,oe=a.pos.y+U;le>B&&Z<D&&oe>q&&ie<G&&(O=!1,a.isCharging&&(a.isCharging=!1,a.chargeTimer=0));const se=a.pos.x-U,he=a.pos.x+U,Me=_-U,He=_+U;he>B&&se<D&&He>q&&Me<G&&(P=!1,a.isCharging&&(a.isCharging=!1,a.chargeTimer=0))}O&&(a.pos.x=M),P&&(a.pos.y=_)}a.minionSpawnTimer>=C&&(a.spawnMinions(),a.minionSpawnTimer=0),a.chargeCooldownTimer>=I&&(a.color=e.rgb(255,255,0),e.wait(.3,()=>{a.exists()&&(a.color=e.rgb(...c.color),a.startCharge(h.pos))}),a.chargeCooldownTimer=0),a.radialBurstTimer>=R&&(a.radialBurst(),a.radialBurstTimer=0)}}else if(a.type==="twinGuardianMelee"){a.attackTimer+=e.dt(),a.chargeCooldownTimer+=e.dt();const C=8,I=150,R=e.vec2(h.pos.x-a.pos.x,h.pos.y-a.pos.y),f=R.len();if(a.isCharging){const N=a.chargeDirection.scale(a.chargeSpeed*e.dt());a.pos.x+=N.x,a.pos.y+=N.y,a.chargeDurationTimer+=e.dt(),a.chargeDurationTimer>=1.2&&(a.isCharging=!1,a.chargeDurationTimer=0,a.chargeCooldownTimer=0)}else{if(f>0){const N=R.unit(),b=a.speed*(a.enraged?1.5:1),T=N.scale(b*e.dt()),x=a.pos.x+T.x,M=a.pos.y+T.y;let _=!0,O=!0;const P=e.get("obstacle"),z=a.size||14;for(const U of P){if(!U.exists())continue;const F=U.pos.x-U.width/2,B=U.pos.x+U.width/2,D=U.pos.y-U.height/2,q=U.pos.y+U.height/2,G=x-z,Z=x+z,le=a.pos.y-z,ie=a.pos.y+z;Z>F&&G<B&&ie>D&&le<q&&(_=!1);const oe=a.pos.x-z,se=a.pos.x+z,he=M-z,Me=M+z;se>F&&oe<B&&Me>D&&he<q&&(O=!1)}_&&(a.pos.x=x),O&&(a.pos.y=M)}a.chargeCooldownTimer>=C&&f<I&&(a.color=e.rgb(255,255,0),e.wait(.3,()=>{if(a.exists()){a.color=e.rgb(...c.color);const N=a.enraged?3.5:2.5;a.chargeSpeed=a.speed*N,a.startCharge(h.pos)}}),a.chargeCooldownTimer=0)}}else if(a.type==="twinGuardianRanged"){a.attackTimer+=e.dt();const C=200,I=e.vec2(h.pos.x-a.pos.x,h.pos.y-a.pos.y),R=I.len();if(R>0){const N=I.unit();let b=a.speed*(a.enraged?1.5:1);if(R<C){const T=N.scale(-b*e.dt()),x=a.pos.x+T.x,M=a.pos.y+T.y;let _=!0,O=!0;const P=e.get("obstacle"),z=a.size||14;for(const U of P){if(!U.exists())continue;const F=U.pos.x-U.width/2,B=U.pos.x+U.width/2,D=U.pos.y-U.height/2,q=U.pos.y+U.height/2,G=x-z,Z=x+z,le=a.pos.y-z,ie=a.pos.y+z;Z>F&&G<B&&ie>D&&le<q&&(_=!1);const oe=a.pos.x-z,se=a.pos.x+z,he=M-z,Me=M+z;se>F&&oe<B&&Me>D&&he<q&&(O=!1)}_&&(a.pos.x=x),O&&(a.pos.y=M)}else if(R>C*1.5){const T=N.scale(b*e.dt()),x=a.pos.x+T.x,M=a.pos.y+T.y;let _=!0,O=!0;const P=e.get("obstacle"),z=a.size||14;for(const U of P){if(!U.exists())continue;const F=U.pos.x-U.width/2,B=U.pos.x+U.width/2,D=U.pos.y-U.height/2,q=U.pos.y+U.height/2,G=x-z,Z=x+z,le=a.pos.y-z,ie=a.pos.y+z;Z>F&&G<B&&ie>D&&le<q&&(_=!1);const oe=a.pos.x-z,se=a.pos.x+z,he=M-z,Me=M+z;se>F&&oe<B&&Me>D&&he<q&&(O=!1)}_&&(a.pos.x=x),O&&(a.pos.y=M)}}const f=1/(a.fireRate*(a.enraged?1.5:1));if(a.attackTimer>=f){if(R>0){const N=I.unit(),b=Qn(e,a.pos.x,a.pos.y,N,a.projectileSpeed,a.projectileDamage*(a.enraged?1.25:1),0,0,!1);b.isBossProjectile=!0,b.color=e.rgb(100,150,255)}a.attackTimer=0}}else if(a.type==="swarmQueen"){a.minionSpawnTimer+=e.dt();const C=a.hp()/a.maxHealth;let I;C>.66?I=5:C>.33?I=3:I=2;const R=a.spawnedMinions.filter(P=>P.exists()&&P.hp()>0);if(a.minionSpawnTimer>=I&&R.length<8){const P=(a.rng?a.rng.next():Math.random())<.5?"fast":"basic",z=(a.rng?a.rng.next():Math.random())*Math.PI*2,U=50+(a.rng?a.rng.next():Math.random())*30,F=a.pos.x+Math.cos(z)*U,B=a.pos.y+Math.sin(z)*U,D=mi(e,F,B,P,i);D.isBossMinion=!0,a.spawnedMinions.push(D),a.spawnedMinions=a.spawnedMinions.filter(q=>q.exists()),a.minionSpawnTimer=0}const N=e.width()/2,b=e.height()/2,T=150,x=e.vec2(N-a.pos.x,b-a.pos.y),M=e.vec2(h.pos.x-a.pos.x,h.pos.y-a.pos.y),_=M.len();let O=e.vec2(0,0);if(x.len()>30&&(O=O.add(x.unit().scale(.5))),_<T&&(O=O.add(M.unit().scale(-1))),O.len()>0){const z=O.unit().scale(a.speed*e.dt()),U=a.pos.x+z.x,F=a.pos.y+z.y;let B=!0,D=!0;const q=e.get("obstacle"),G=a.size||14;for(const Z of q){if(!Z.exists())continue;const le=Z.pos.x-Z.width/2,ie=Z.pos.x+Z.width/2,oe=Z.pos.y-Z.height/2,se=Z.pos.y+Z.height/2,he=U-G,Me=U+G,He=a.pos.y-G,we=a.pos.y+G;Me>le&&he<ie&&we>oe&&He<se&&(B=!1);const De=a.pos.x-G,Qe=a.pos.x+G,Ae=F-G,pt=F+G;Qe>le&&De<ie&&pt>oe&&Ae<se&&(D=!1)}B&&(a.pos.x=U),D&&(a.pos.y=F)}}else{const C=e.vec2(h.pos.x-a.pos.x,h.pos.y-a.pos.y);if(C.len()>0){const f=C.unit().scale(a.speed*e.dt()),N=a.pos.x+f.x,b=a.pos.y+f.y;let T=!0,x=!0;const M=e.get("obstacle"),_=a.size||14;for(const O of M){if(!O.exists())continue;const P=O.pos.x-O.width/2,z=O.pos.x+O.width/2,U=O.pos.y-O.height/2,F=O.pos.y+O.height/2,B=N-_,D=N+_,q=a.pos.y-_,G=a.pos.y+_;D>P&&B<z&&G>U&&q<F&&(T=!1);const Z=a.pos.x-_,le=a.pos.x+_,ie=b-_,oe=b+_;le>P&&Z<z&&oe>U&&ie<F&&(x=!1)}T&&(a.pos.x=N),x&&(a.pos.y=b)}}const p=e.width(),g=e.height(),A=20,m=a.size||14;a.pos.x=e.clamp(a.pos.x,A+m,p-A-m),a.pos.y=e.clamp(a.pos.y,A+m,g-A-m)}),a.isDead=!1,a.onDeath(()=>{de()&&ve()&&a.mpEntityId&&Vh({entityId:a.mpEntityId,entityType:"boss",x:a.pos.x,y:a.pos.y,xpDropped:a.xpValue})}),o==="swarmQueen"&&a.onDeath(()=>{const h=8+Math.floor((a.rng?a.rng.next():Math.random())*5);for(let u=0;u<h;u++){const p=Math.PI*2/h*u+(a.rng?a.rng.next():Math.random())*.3,g=40+(a.rng?a.rng.next():Math.random())*20,A=a.pos.x+Math.cos(p)*g,m=a.pos.y+Math.sin(p)*g,C=(a.rng?a.rng.next():Math.random())<.5?"fast":"basic",I=mi(e,A,m,C,i);I.isBossMinion=!0}}),a.updateVisual(),de()&&ve()&&(fo(a,{type:o,floor:i,isBoss:!0}),a.enemyType=o),a}function e_(e,t,n,o=1,i=null){const s=ul(e,t.pos.x,t.pos.y,"twinGuardianMelee",o,i),r=ul(e,n.pos.x,n.pos.y,"twinGuardianRanged",o,i);return s.twinPartner=r,r.twinPartner=s,s.onDeath(()=>{r&&r.exists()&&!r.enraged&&(r.enrage(),de()&&ve()&&Jf(r.networkId))}),r.onDeath(()=>{s&&s.exists()&&!s.enraged&&(s.enrage(),de()&&ve()&&Jf(s.networkId))}),[s,r]}const Si={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function t_(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const o=1+(t-1)*.1,s=zt("propDropChance")*.05;for(const[r,l]of Object.entries(Si)){const c=l.dropChance*o+s,d=Math.min(c,1);if(Math.random()<d)return r}return null}function gc(e,t){const n=Si[t];if(!n)return;const o=Zc[n.weaponKey];if(o){if(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=n.weaponKey,e.weaponDef=o,e.fireRate=o.fireRate,e.projectileSpeed=o.projectileSpeed,e.projectileDamage=o.baseDamage,e.projectileCount=o.projectileCount,e.piercing=o.piercing,e.obstaclePiercing=o.obstaclePiercing,e.critChance=o.critChance,e.critDamage=o.critDamage,e.spreadAngle=o.spreadAngle,e.weaponRange=o.range,e.weaponCategory=o.category,o.orbitRadius&&(e.orbitRadius=o.orbitRadius,e.rotationSpeed=o.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),o.explosionRadius&&(e.explosionRadius=o.explosionRadius,e.explosionDamage=o.explosionDamage),o.chainRange&&(e.chainRange=o.chainRange,e.maxJumps=o.maxJumps,e.chainDamageReduction=o.chainDamageReduction),n.isAmmoBased)e.powerupAmmo=n.ammo,e.powerupDuration=null;else if(n.isTimeBased){const s=zt("propDurability")*2;e.powerupDuration=n.duration+s,e.powerupAmmo=null}}}function bd(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function n_(e,t=0){if(!e.powerupWeapon)return!1;const n=Si[e.powerupWeapon];return n&&(n.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||n.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(de()&&ve()&&e.slotIndex!==void 0&&Zf(e.slotIndex,e.powerupWeapon),bd(e),!0):!1}function o_(e){if(!e.powerupWeapon)return;const t=Si[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function i_(e){if(!e.powerupWeapon)return null;const t=Si[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function fr(e,t,n,o){const i=e.add([e.text("+",{size:16}),e.pos(t,n),e.anchor("center"),e.color(...rn.XP_COLOR),e.area(),e.scale(1),"xpPickup"]);return i.value=o,i.lifetime=rn.XP_LIFETIME,i.age=0,i.collected=!1,i.magnetizing=!1,i.magnetizeSpeed=0,i.targetPlayer=null,i.isFlyingToUI=!1,i.velocityY=-150-Math.random()*100,i.gravity=600,i.groundY=n,i.bounceDamping=.5,i.bouncing=!0,i.onUpdate(()=>{if(i.isFlyingToUI){const l=e.vec2(e.width()/2,e.height()-18).sub(i.pos);l.len()<10?e.destroy(i):i.pos=i.pos.add(l.unit().scale(1e3*e.dt()));return}if(e.paused){const r=Math.sin(i.age*rn.XP_PULSE_SPEED)*rn.XP_PULSE_AMOUNT;i.scale=e.vec2(1+r);return}i.age+=e.dt();const s=Math.sin(i.age*rn.XP_PULSE_SPEED)*rn.XP_PULSE_AMOUNT;if(i.scale=e.vec2(1+s),!i.magnetizing&&i.bouncing&&(i.velocityY+=i.gravity*e.dt(),i.pos.y+=i.velocityY*e.dt(),i.pos.y>=i.groundY&&(i.pos.y=i.groundY,i.velocityY=-i.velocityY*i.bounceDamping,Math.abs(i.velocityY)<20&&(i.bouncing=!1,i.velocityY=0))),i.magnetizing&&i.targetPlayer&&i.targetPlayer.exists()){i.bouncing=!1;const r=e.vec2(i.targetPlayer.pos.x-i.pos.x,i.targetPlayer.pos.y-i.pos.y),l=r.len();if(l>0){const c=r.scale(1/l);i.magnetizeSpeed=Math.min(i.magnetizeSpeed+rn.MAGNETIZE_ACCELERATION*e.dt(),rn.MAGNETIZE_SPEED),i.pos=i.pos.add(c.scale(i.magnetizeSpeed*e.dt()))}}i.age>=i.lifetime&&e.destroy(i)}),i.pickupType="xp",de()&&ve()&&Gh(i,{type:"xpPickup",value:o}),de()&&i.onDestroy(()=>{Kh(i)}),i}const Gf=["$","","","","","","",""];function Da(){return Gf[Math.floor(Math.random()*Gf.length)]}function pr(e,t,n,o,i=null){const s=i||Da(),r=e.add([e.text(s,{size:9}),e.pos(t,n),e.anchor("center"),e.color(...rn.CURRENCY_COLOR),e.area(),e.scale(1),e.opacity(1),"currencyPickup"]);return r.value=o,r.lifetime=rn.CURRENCY_LIFETIME,r.age=0,r.collected=!1,r.magnetizing=!1,r.magnetizeSpeed=0,r.targetPlayer=null,r.isFlyingToUI=!1,r.velocityY=-150-Math.random()*100,r.gravity=600,r.groundY=n,r.bounceDamping=.5,r.bouncing=!0,r.onUpdate(()=>{if(r.isFlyingToUI){const a=e.vec2(e.width()-20,20).sub(r.pos);a.len()<10?e.destroy(r):r.pos=r.pos.add(a.unit().scale(1e3*e.dt()));return}if(e.paused){const d=Math.sin(r.age*rn.CURRENCY_PULSE_SPEED)*rn.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+d);return}r.age+=e.dt();const l=Math.sin(r.age*rn.CURRENCY_PULSE_SPEED)*rn.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+l);const c=r.lifetime-r.age;if(c<=4&&c>0){const d=4+(4-c)*2,a=Math.sin(r.age*d*Math.PI*2);r.opacity=.65+a*.35,a>0?r.color=e.rgb(255,255,200):r.color=e.rgb(...rn.CURRENCY_COLOR)}else r.opacity=1;if(!r.magnetizing&&r.bouncing&&(r.velocityY+=r.gravity*e.dt(),r.pos.y+=r.velocityY*e.dt(),r.pos.y>=r.groundY&&(r.pos.y=r.groundY,r.velocityY=-r.velocityY*r.bounceDamping,Math.abs(r.velocityY)<20&&(r.bouncing=!1,r.velocityY=0))),r.magnetizing&&r.targetPlayer&&r.targetPlayer.exists()){r.bouncing=!1;const d=e.vec2(r.targetPlayer.pos.x-r.pos.x,r.targetPlayer.pos.y-r.pos.y),a=d.len();if(a>0){const h=d.scale(1/a);r.magnetizeSpeed=Math.min(r.magnetizeSpeed+rn.MAGNETIZE_ACCELERATION*e.dt(),rn.MAGNETIZE_SPEED),r.pos=r.pos.add(h.scale(r.magnetizeSpeed*e.dt()))}}r.age>=r.lifetime&&e.destroy(r)}),r.pickupType="currency",de()&&ve()&&Gh(r,{type:"currencyPickup",value:o,icon:s}),de()&&r.onDestroy(()=>{Kh(r)}),r}function Kf(e,t,n,o){const i=Si[o];if(!i)return null;const s=e.add([e.text(i.icon,{size:24}),e.pos(t,n),e.anchor("center"),e.color(...i.color),e.area(),e.scale(1),"powerupWeaponPickup"]);return s.powerupKey=o,s.lifetime=rn.CURRENCY_LIFETIME,s.age=0,s.collected=!1,s.magnetizing=!1,s.magnetizeSpeed=0,s.targetPlayer=null,s.velocityY=-150-Math.random()*100,s.gravity=600,s.groundY=n,s.bounceDamping=.5,s.bouncing=!0,s.onUpdate(()=>{if(e.paused){const l=Math.sin(s.age*4)*.15;s.scale=e.vec2(1+l),s.angle=Math.sin(s.age*2)*10;return}s.age+=e.dt();const r=Math.sin(s.age*4)*.15;if(s.scale=e.vec2(1+r),s.angle=Math.sin(s.age*2)*10,!s.magnetizing&&s.bouncing&&(s.velocityY+=s.gravity*e.dt(),s.pos.y+=s.velocityY*e.dt(),s.pos.y>=s.groundY&&(s.pos.y=s.groundY,s.velocityY=-s.velocityY*s.bounceDamping,Math.abs(s.velocityY)<20&&(s.bouncing=!1,s.velocityY=0))),s.magnetizing&&s.targetPlayer&&s.targetPlayer.exists()){s.bouncing=!1;const l=e.vec2(s.targetPlayer.pos.x-s.pos.x,s.targetPlayer.pos.y-s.pos.y),c=l.len();if(c>0){const d=l.scale(1/c);s.magnetizeSpeed=Math.min(s.magnetizeSpeed+rn.MAGNETIZE_ACCELERATION*e.dt(),rn.MAGNETIZE_SPEED),s.pos=s.pos.add(d.scale(s.magnetizeSpeed*e.dt()))}}s.age>=s.lifetime&&e.destroy(s)}),s.pickupType="powerup",de()&&ve()&&Gh(s),de()&&s.onDestroy(()=>{Kh(s)}),s}class Vo{constructor(t){this.seed=t>>>0,this.originalSeed=this.seed}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}range(t,n){return n<=t?(console.warn(`SeededRandom.range: Invalid range [${t}, ${n}). Returning min.`),t):Math.floor(t+this.next()*(n-t))}rangeFloat(t,n){return t+this.next()*(n-t)}choose(t){if(!(!t||t.length===0))return t[this.range(0,t.length)]}shuffle(t){const n=[...t];for(let o=n.length-1;o>0;o--){const i=this.range(0,o+1);[n[o],n[i]]=[n[i],n[o]]}return n}probability(t){return this.next()<t}reset(){this.seed=this.originalSeed}getState(){return this.seed}setState(t){this.seed=t>>>0}}function Uh(...e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e[n]|0;return t>>>0}function s_(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)|0;return t>>>0}const hs={peers:new Map,localLatency:0,lastPingId:0,lastPingSentTime:0,handlersRegistered:!1};function r_(){hs.handlersRegistered||(hs.handlersRegistered=!0,Ue("ping",(e,t)=>{ve()?yo(t,"pong",{pingId:e.pingId,serverTime:Date.now()}):Ln("pong",{pingId:e.pingId,serverTime:Date.now()})}),Ue("pong",(e,t)=>{const n=Date.now(),o=e.pingId;if(ve()){const i=hs.peers.get(t);if(i&&i.pingId===o){const s=n-i.lastPingTime;i.latency=s}}else hs.lastPingId===o&&(hs.localLatency=n-hs.lastPingSentTime)}))}const _t={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10,lifesteal:5,dodgeChance:5,thorns:5,aoeSize:10,knockback:5,magnetRange:10,invulnTime:5,moveDamage:5,lowHealthDmg:5,killSpeed:5},Ls={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${_t.damage})`:""}`,apply:e=>{const t=e.upgradeStacks?.damage||0,n=e.baseProjectileDamage||e.weaponDef?.baseDamage||10,o=Math.pow(1.25,t);e.projectileDamage=Math.floor(n*o)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${_t.fireRate})`:""}`,apply:e=>{const t=e.upgradeStacks?.fireRate||0,n=e.baseFireRate||e.weaponDef?.fireRate||1.5,o=Math.pow(1.2,t);e.fireRate=n*o}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${_t.speed})`:""}`,apply:e=>{const t=e.upgradeStacks?.speed||0,n=e.characterData?.stats?.speed||150,o=Math.pow(1.15,t);e.speed=Math.floor(n*o),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${_t.health})`:""}`,apply:e=>{const t=e.upgradeStacks?.health||0,n=e.characterData?.stats?.health||100,o=t*20,i=e.maxHealth;e.maxHealth=n+o;const s=e.maxHealth-i;s>0&&e.setHP(e.hp()+s)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${_t.projectileSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.projectileSpeed||0,n=e.baseProjectileSpeed||e.weaponDef?.projectileSpeed||300,o=Math.pow(1.25,t);e.projectileSpeed=Math.floor(n*o)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${_t.xpGain})`:""}`,apply:e=>{const t=e.upgradeStacks?.xpGain||0,n=e.characterData?.ability==="xpBoost"?1.1:1;e.xpMultiplier=n+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${_t.pickupRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.pickupRadius||0,n=30,o=Math.pow(1.5,t);e.pickupRadius=Math.floor(n*o)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${_t.multiShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.multiShot||0,n=e.weaponDef?.projectileCount||1;e.projectileCount=n+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${_t.piercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.piercing||0,n=e.weaponDef?.piercing||0;e.piercing=n+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${_t.obstaclePiercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.obstaclePiercing||0,n=e.weaponDef?.obstaclePiercing||0;e.obstaclePiercing=n+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${_t.critChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.critChance||0;let o=(e.weaponDef?.critChance||.05)+t*.1;e.characterData?.ability==="critBoost"&&(o*=1.5),e.critChance=o}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${_t.critDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.critDamage||0;let o=(e.weaponDef?.critDamage||2)+t*.5;e.characterData?.ability==="critBoost"&&(o*=1.25),e.critDamage=o}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${_t.spreadShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.spreadShot||0,n=e.weaponDef?.spreadAngle||0;e.spreadAngle=n+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${_t.pelletCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.pelletCount||0,n=e.weaponDef?.projectileCount||3;e.projectileCount=n+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${_t.range})`:""}`,apply:e=>{const t=e.upgradeStacks?.range||0,n=e.weaponDef?.range||600,o=Math.pow(1.25,t);e.weaponRange=Math.floor(n*o)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${_t.dot})`:""}`,apply:e=>{const t=e.upgradeStacks?.dot||0,n=e.characterData?.ability==="fireDot"?1.25:1;e.fireDotMultiplier=n+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${_t.orbitalCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalCount||0,n=e.weaponDef?.projectileCount||1;e.projectileCount=n+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${_t.orbitalSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalSpeed||0,n=e.weaponDef?.rotationSpeed||180,o=Math.pow(1.5,t);e.rotationSpeed=n*o}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${_t.orbitalRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalRadius||0,n=e.weaponDef?.orbitRadius||45,o=Math.pow(1.2,t);e.orbitRadius=Math.floor(n*o)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${_t.explosionRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionRadius||0,n=e.weaponDef?.explosionRadius||50,o=Math.pow(1.25,t);e.explosionRadius=Math.floor(n*o)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${_t.explosionDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionDamage||0,n=e.weaponDef?.explosionDamage||15,o=Math.pow(1.25,t);e.explosionDamage=Math.floor(n*o)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${_t.chainJumps})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainJumps||0,n=e.weaponDef?.maxJumps||3;e.maxJumps=n+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${_t.chainRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainRange||0,n=e.weaponDef?.chainRange||70,o=Math.pow(1.25,t);e.chainRange=Math.floor(n*o)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${_t.chainDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainDamage||0,n=e.weaponDef?.chainDamageReduction||.15;e.chainDamageReduction=Math.max(.05,n-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${_t.defense})`:""}`,apply:e=>{const t=e.upgradeStacks?.defense||0,n=e.characterData?.ability==="tankStats"?.15:0;e.defense=n+t*2}},lifesteal:{name:"Life Drain",icon:"",description:"Heal 2% of damage dealt",category:"passive",maxStacks:5,getDescription:e=>`Heal ${(e||1)*2}% of damage dealt${e>0?` (${e}/${_t.lifesteal})`:""}`,apply:e=>{const t=e.upgradeStacks?.lifesteal||0;e.lifestealPercent=t*.02}},dodgeChance:{name:"Evasion",icon:"",description:"+5% dodge chance",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% dodge chance${e>0?` (${e}/${_t.dodgeChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.dodgeChance||0,n=e.characterData?.ability==="dodgeChance"?.1:0;e.dodgeChance=n+t*.05}},thorns:{name:"Thorns",icon:"",description:"Reflect 15% damage to attackers",category:"passive",maxStacks:5,getDescription:e=>`Reflect ${(e||1)*15}% damage${e>0?` (${e}/${_t.thorns})`:""}`,apply:e=>{const t=e.upgradeStacks?.thorns||0;e.thornsPercent=t*.15}},aoeSize:{name:"Blast Radius",icon:"",description:"+15% explosion/area size",category:"weapon",upgradeCategory:"explosionRadius",maxStacks:10,getDescription:e=>`+${(e||1)*15}% AoE size${e>0?` (${e}/${_t.aoeSize})`:""}`,apply:e=>{const t=e.upgradeStacks?.aoeSize||0;if(e.aoeSizeMultiplier=1+t*.15,e.explosionRadius){const n=e.weaponDef?.explosionRadius||50;e.explosionRadius=Math.floor(n*e.aoeSizeMultiplier)}}},knockback:{name:"Impact Force",icon:"",description:"+20% knockback",category:"weapon",maxStacks:5,getDescription:e=>`+${(e||1)*20}% knockback${e>0?` (${e}/${_t.knockback})`:""}`,apply:e=>{const t=e.upgradeStacks?.knockback||0;e.knockbackMultiplier=1+t*.2}},magnetRange:{name:"Treasure Hunter",icon:"",description:"+25% pickup radius",category:"passive",maxStacks:10,getDescription:e=>`+${(e||1)*25}% pickup radius${e>0?` (${e}/${_t.magnetRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.magnetRange||0,n=30,o=e.upgradeStacks?.pickupRadius||0,i=Math.pow(1.5,o);e.pickupRadius=Math.floor(n*i*(1+t*.25))}},invulnTime:{name:"Iron Skin",icon:"",description:"+0.15s invulnerability frames",category:"passive",maxStacks:5,getDescription:e=>`+${((e||1)*.15).toFixed(2)}s invuln${e>0?` (${e}/${_t.invulnTime})`:""}`,apply:e=>{const t=e.upgradeStacks?.invulnTime||0,n=1;e.invulnerableDuration=n+t*.15}},moveDamage:{name:"Momentum",icon:"",description:"+2% damage per speed stack",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*2}% damage per speed stack${e>0?` (${e}/${_t.moveDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.moveDamage||0;e.moveDamageBonus=t*.02}},lowHealthDmg:{name:"Desperation",icon:"",description:"+5% damage per 10% missing HP",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% damage per 10% missing HP${e>0?` (${e}/${_t.lowHealthDmg})`:""}`,apply:e=>{const t=e.upgradeStacks?.lowHealthDmg||0;e.lowHealthDmgBonus=t*.05}},killSpeed:{name:"Bloodlust",icon:"",description:"+3% speed for 3s on kill",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*3}% speed for 3s on kill${e>0?` (${e}/${_t.killSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.killSpeed||0;e.killSpeedBonus=t*.03,e.killSpeedDuration=3,e.killSpeedStacks=0,e.killSpeedTimer=0}}};function a_(e,t){if(e.category==="passive"){const n=t.upgradeStacks?.[e.key]||0,o=e.maxStacks||_t[e.key]||10;return!(n>=o)}if(e.category==="weapon"){const n=t.upgradeStacks?.[e.key]||0,o=e.maxStacks||_t[e.key]||10;if(n>=o)return!1;const i=t.characterData?.weapon||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(i):e.upgradeCategory?xb(i,e.upgradeCategory):!0}return!0}function l_(e=3,t=null,n=null){let i=Object.keys(Ls).map(c=>({key:c,...Ls[c],type:"upgrade"})),s=i;t&&(s=i.filter(c=>a_(c,t))),s.length<e&&(s=i);const r=[],l=new Set;for(;r.length<e&&r.length<s.length;){const c=n?n.range(0,s.length):Math.floor(Math.random()*s.length),d=s[c];l.has(d.key)||(l.add(d.key),r.push(d))}return r}function Fh(e,t){const n=Ls[t];n&&(n.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,fl(e))}function fl(e){Object.keys(Ls).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&Ls[t].apply(e)})}function c_(e,t){if(!e)return"";if(e.getDescription){const n=t?.upgradeStacks?.[e.key]||0;return e.getDescription(n)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const Mi={BUTTON:{SM:{width:120,height:30},MD:{width:160,height:36},LG:{width:280,height:45},XL:{width:320,height:50}}},Q={H1:24,H2:18,BODY:16,SMALL:14,TINY:12,MICRO:11,TITLE:36,HEADER:24,LABEL:18,BUTTON:20,HUD:16},y={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},Hn={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},Ia={HEALTH:"HP",FLOOR:"Floor",DAMAGE:"Damage",SPEED:"Speed"};function Wr(e){return e.toUpperCase()}function Vf(e,t){return`${e}/${t}`}const w={BACKGROUND:0,GAME_ENTITIES:10,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1500,TOOLTIP:2e3,PAUSE_MENU:2001,DEBUG:9999},or=["$","","","","","","",""];function oa(e,t={}){const{patternCount:n=12,particleCount:o=20,includeCursorFollowers:i=!1}=t,s=["","","","","","","",""];for(let r=0;r<n;r++){const l=e.add([e.text(s[Math.floor(Math.random()*s.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.15),e.scale(1),e.z(w.PARTICLES)]);l.pulseTime=Math.random()*Math.PI*2,l.pulseSpeed=1+Math.random()*2,l.onUpdate(()=>{l.pulseTime+=e.dt()*l.pulseSpeed;const c=.8+Math.sin(l.pulseTime)*.3;l.scale=e.vec2(c,c),l.opacity=.1+Math.abs(Math.sin(l.pulseTime))*.15})}for(let r=0;r<o;r++){const l=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(w.PARTICLES)]);l.speed=10+Math.random()*20,l.onUpdate(()=>{l.pos.y+=l.speed*e.dt(),l.pos.y>e.height()&&(l.pos.y=0,l.pos.x=Math.random()*e.width())})}if(i){const r=[];e.loop(5,()=>{if(r.length<3&&Math.random()<.3){const l=["","","","","","",""],c=e.add([e.text(l[Math.floor(Math.random()*l.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(w.PARTICLES)]);c.followSpeed=20+Math.random()*30,c.rotationSpeed=50+Math.random()*100,c.lifetime=15+Math.random()*10,c.onUpdate(()=>{const a=e.mousePos().sub(c.pos),h=a.len();if(h>5){const u=a.scale(1/h);c.pos=c.pos.add(u.scale(c.followSpeed*e.dt()))}if(c.angle+=c.rotationSpeed*e.dt(),c.lifetime-=e.dt(),c.lifetime<=0){e.destroy(c);const u=r.indexOf(c);u>-1&&r.splice(u,1)}}),r.push(c)}})}}const d_={CONTESTANTS:["           ","    ","                              ","                            ","                      ","                           "],MERCH:["       ","   ","       ","       ","      ","          "],OPTIONS:["        ","  ","             ","             ","            ","                 "],"RATINGS AND RECORDS":["                           ","            ","                               ","                              ","                         ","                                  "],PROFILE:["         ","     ","            ","             ","            ","              "]};function ia(e,t,n,o,i=8){function s(u,p,g){p/=100,g/=100;const A=(1-Math.abs(2*g-1))*p,m=A*(1-Math.abs(u/60%2-1)),C=g-A/2;let I=0,R=0,f=0;return u>=0&&u<60?(I=A,R=m,f=0):u>=60&&u<120?(I=m,R=A,f=0):u>=120&&u<180?(I=0,R=A,f=m):u>=180&&u<240?(I=0,R=m,f=A):u>=240&&u<300?(I=m,R=0,f=A):u>=300&&u<360&&(I=A,R=0,f=m),[Math.round((I+C)*255),Math.round((R+C)*255),Math.round((f+C)*255)]}const r=Wr(t),l=d_[r];if(!l){console.warn(`ASCII art not found for "${r}", using plain text`);const u=e.add([e.text(r,{size:i*2,font:"monospace"}),e.pos(n,o),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"animatedTitle"]);let p=0;return u.onUpdate(()=>{p+=e.dt();const g=p*50%360,A=s(g,80,60);u.color=e.rgb(...A);const m=Math.sin(p*2)*2;u.pos.y=o+m}),[u]}const c=[],d=10,a=o-l.length*d/2;l.forEach((u,p)=>{const g=e.add([e.text(u,{size:i,font:"monospace"}),e.pos(n,a+p*d),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"animatedTitle"]);c.push(g)});let h=0;return e.onUpdate(()=>{h+=e.dt(),c.forEach((u,p)=>{const g=(h*50+p*20)%360,A=s(g,80,60);u.color=e.rgb(...A);const m=Math.sin(h*2+p*.3)*2;u.pos.y=a+p*d+m,Math.random()<.001&&(u.pos.x=n+(Math.random()-.5)*10,e.wait(.1,()=>{u.exists()&&(u.pos.x=n)}))})}),c}function Xh(e,t,n){const o=()=>2+Math.random()*3,i=e.add([e.text(`${or[0]}: ${t}`,{size:Q.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),s=i.width+30,r=40;e.destroy(i);const l=e.add([e.rect(s,r),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(w.UI_BACKGROUND)]),c=e.add([e.text(`${or[0]}: ${t}`,{size:Q.LABEL}),e.pos(e.width()-20-s/2,40),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);c.symbolIndex=0,c.timeSinceLastChange=0,c.currentCurrency=t,c.symbolChangeInterval=o();const d=a=>{c.currentCurrency=a,c.text=`${or[c.symbolIndex]}: ${a}`;const h=c.width+30;Math.abs(h-s)>10&&(l.width=h,c.pos.x=e.width()-20-h/2)};return c.onUpdate(()=>{c.timeSinceLastChange+=e.dt(),c.timeSinceLastChange>=c.symbolChangeInterval&&(c.timeSinceLastChange=0,c.symbolIndex=(c.symbolIndex+1)%or.length,c.text=`${or[c.symbolIndex]}: ${c.currentCurrency}`,c.symbolChangeInterval=o())}),{panel:l,text:c,updateCurrency:d}}const ft={queue:[],activeToasts:[],k:null,maxActiveToasts:3,toastWidth:300,toastHeight:80,toastMargin:10,animationDuration:.3,displayDuration:3};function qh(e){ft.k=e,ft.queue=[],ft.activeToasts=[]}function Bm(e){if(!ft.k){console.warn("Toast system not initialized");return}const n={title:e.title||"Notification",message:e.message||"",icon:e.icon||"!",iconColor:e.iconColor||y.TEXT_PRIMARY,type:e.type||"info",duration:e.duration||ft.displayDuration};ft.queue.push(n),Hm()}function h_(e){const t=so[e.difficulty]||so.normal;let n=" Achievement Unlocked!";e.difficulty==="challenge"?n=" Challenge Complete!":e.difficulty==="benchmark"&&(n=" Milestone Reached!"),Bm({title:n,message:`${e.name}
${e.description}`,icon:e.icon,iconColor:t,type:"achievement",duration:5,difficulty:e.difficulty})}function u_(e,t){const n=so[t.difficulty]||so.normal;Bm({title:`${e} unlocked:`,message:t.name,icon:t.icon,iconColor:n,type:"achievement",duration:3})}function Hm(){if(ft.k)for(;ft.queue.length>0&&ft.activeToasts.length<ft.maxActiveToasts;){const t=ft.queue.shift();f_(t)}}function f_(e){const t=ft.k;if(!t)return;const n=t.width()+ft.toastWidth,o=t.width()-ft.toastMargin-ft.toastWidth/2,i=ft.activeToasts.length,s=ft.toastMargin+i*(ft.toastHeight+ft.toastMargin)+ft.toastHeight/2+20;let r=y.BORDER,l=[...y.BG_MEDIUM],c=2;e.type==="achievement"?(r=e.iconColor,l=[35,30,45],c=3):e.type==="success"?r=y.SUCCESS:e.type==="error"&&(r=y.ERROR);const d=t.add([t.rect(ft.toastWidth,ft.toastHeight),t.pos(n,s),t.anchor("center"),t.color(...l),t.outline(c,t.rgb(...r)),t.opacity(.95),t.fixed(),t.z(w.TOOLTIP),"toast"]);if(e.type==="achievement"){let I=0;d.onUpdate(()=>{I+=t.dt();const R=Math.sin(I*4)*.2+.8,f=Math.min(255,r[0]*R),N=Math.min(255,r[1]*R),b=Math.min(255,r[2]*R);d.outline.color=t.rgb(f,N,b)})}const a=t.add([t.rect(50,ft.toastHeight-10),t.pos(n-ft.toastWidth/2+30,s),t.anchor("center"),t.color(...l),t.opacity(.5),t.fixed(),t.z(w.TOOLTIP+1),"toast"]),h=e.type==="achievement"?32:28,u=t.add([t.text(e.icon,{size:h}),t.pos(n-ft.toastWidth/2+30,s),t.anchor("center"),t.color(...e.iconColor),t.fixed(),t.z(w.TOOLTIP+2),"toast"]);if(e.type==="achievement"){let I=0;const R=s;u.onUpdate(()=>{I+=t.dt();const f=Math.abs(Math.sin(I*3))*3;u.pos.y=R-f})}const p=t.add([t.text(e.title,{size:14}),t.pos(n-ft.toastWidth/2+65,s-20),t.anchor("left"),t.color(...e.type==="achievement"?[255,220,100]:y.TEXT_PRIMARY),t.fixed(),t.z(w.TOOLTIP+2),"toast"]),g=e.message.split(`
`),A=[];g.forEach((I,R)=>{const f=t.add([t.text(I,{size:12,width:ft.toastWidth-80}),t.pos(n-ft.toastWidth/2+65,s-5+R*16),t.anchor("left"),t.color(...y.TEXT_SECONDARY),t.fixed(),t.z(w.TOOLTIP+2),"toast"]);A.push(f)});const m={container:d,iconBg:a,icon:u,title:p,messages:A,startX:n,targetX:o,y:s,state:"entering",timer:0,data:e};ft.activeToasts.push(m);const C=t.onUpdate(()=>{if(m.state==="done"){C.cancel();return}if(m.timer+=t.dt(),m.state==="entering"){const I=Math.min(m.timer/ft.animationDuration,1),R=m_(I),f=$f(m.startX,m.targetX,R);Wf(m,f),I>=1&&(m.state="visible",m.timer=0)}else if(m.state==="visible")m.timer>=m.data.duration&&(m.state="exiting",m.timer=0);else if(m.state==="exiting"){const I=Math.min(m.timer/ft.animationDuration,1),R=y_(I),f=t.width()+ft.toastWidth,N=$f(m.targetX,f,R);Wf(m,N);const b=1-I;m.container.opacity=b*.95,m.iconBg.opacity=b*.5,m.icon.opacity=b,m.title.opacity=b,m.messages.forEach(T=>T.opacity=b),I>=1&&(m.state="done",p_(m))}});m.updateHandler=C}function Wf(e,t){const n=t-e.container.pos.x;e.container.pos.x=t,e.iconBg.pos.x+=n,e.icon.pos.x+=n,e.title.pos.x+=n,e.messages.forEach(o=>o.pos.x+=n)}function p_(e){const t=ft.k;if(!t)return;e.updateHandler&&e.updateHandler.cancel(),e.container.exists()&&t.destroy(e.container),e.iconBg.exists()&&t.destroy(e.iconBg),e.icon.exists()&&t.destroy(e.icon),e.title.exists()&&t.destroy(e.title),e.messages.forEach(o=>{o.exists()&&t.destroy(o)});const n=ft.activeToasts.indexOf(e);n>-1&&ft.activeToasts.splice(n,1),g_(),Hm()}function g_(){ft.activeToasts.forEach((e,t)=>{if(e.state==="visible"||e.state==="entering"){const n=ft.toastMargin+t*(ft.toastHeight+ft.toastMargin)+ft.toastHeight/2+20,o=e.container.pos.y,i=n-o;e.container.pos.y=n,e.iconBg.pos.y+=i,e.icon.pos.y+=i,e.title.pos.y+=i,e.messages.forEach((s,r)=>{s.pos.y+=i}),e.y=n}})}function m_(e){return 1-Math.pow(1-e,3)}function y_(e){return e*e*e}function $f(e,t,n){return e+(t-e)*n}const H={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/15,lastResyncTime:0,resyncInterval:5,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null,gameSeed:0,floorRng:null,roomRng:null,currentFloor:1,currentRoom:{x:0,y:0},pendingXP:0,onGameSeedCallback:null};function x_(e,t=0,n=null,o=null){H.isActive=!0,H.isHost=e,H.localPlayerSlot=t,H.players.clear(),H.inputBuffer=[],H.lastSyncTime=0,H.k=n,r_(),H.enemies.clear(),H.projectiles.clear(),H.pickups.clear(),H.nextEntityId=1,o!==null?H.gameSeed=o:e&&(H.gameSeed=Math.floor(Math.random()*4294967295)),H.floorRng=new Vo(H.gameSeed),H.currentFloor=1,H.currentRoom={x:0,y:0},e?v_():(pl=!1,w_())}function v_(){Ed||(Ed=!0,Ue("player_input",(e,t)=>{if(!e||typeof e!="object")return;const n=Zi(),o=n.slots.findIndex(i=>i.peerId===t);if(o!==-1&&H.players.has(o)){const i=H.players.get(o);if(!i||!i.exists())return;if(e.move&&typeof e.move=="object"){const s=Math.max(-1,Math.min(1,Number(e.move.x)||0)),r=Math.max(-1,Math.min(1,Number(e.move.y)||0));i.move={x:s,y:r}}if(e.shoot!==void 0&&(i.isShooting=!!e.shoot),e.aimAngle!==void 0){const s=Number(e.aimAngle)||0;i.aimAngle=Math.max(-360,Math.min(360,s))}}else console.warn("[Multiplayer] Could not find player for peer:",t,"slot:",o),console.warn("[Multiplayer] Party slots:",n.slots),console.warn("[Multiplayer] Registered players:",Array.from(H.players.keys()))}),Ue("pause_request",(e,t)=>{H.k&&(H.k.paused=e.paused,H.k.gameData&&H.k.gameData.updatePauseUI&&H.k.gameData.updatePauseUI(e.paused),Je("pause_state",{paused:e.paused}))}),Ue("player_death",(e,t)=>{const n=H.players.get(e.slotIndex);n&&n.exists()&&(n.isDead=!0,n.canMove=!1,n.canShoot=!1,n.isShooting=!1,n.opacity=.5,n.outline&&n.outline.exists()&&(n.outline.opacity=.5),Je("player_death",{slotIndex:e.slotIndex},[t]))}),Ue("enemy_death",(e,t)=>{Je("entity_destroyed",{entityId:e.entityId,entityType:e.entityType,x:e.x,y:e.y})}),Ue("resync_request",(e,t)=>{yo(t,"game_state",Yh())}),Ue("level_up_queued",(e,t)=>{Je("level_up_queued",{slotIndex:e.slotIndex,level:e.level,timestamp:Date.now()})}),Ue("player_emote",(e,t)=>{Je("player_emote",e)}),Ue("upgrade_selected",(e,t)=>{const n=H.players.get(e.slotIndex);n&&n.exists()&&(Fh(n,e.upgradeKey),n.upgradeStacks||(n.upgradeStacks={}),n.upgradeStacks[e.upgradeKey]=(n.upgradeStacks[e.upgradeKey]||0)+1,n.selectedUpgrades||(n.selectedUpgrades=new Set),n.selectedUpgrades.add(e.upgradeKey),fl(n)),Je("upgrade_selected",{slotIndex:e.slotIndex,upgradeKey:e.upgradeKey,timestamp:Date.now()})}),Ue("synergy_activated",(e,t)=>{Je("synergy_activated",{slotIndex:e.slotIndex,synergies:e.synergies,timestamp:Date.now()})}),Ue("achievement_unlocked",(e,t)=>{Je("achievement_unlocked",{achievementId:e.achievementId,playerSlotIndex:e.playerSlotIndex,playerName:e.playerName})}))}let pl=!1,Ed=!1;function w_(){pl||(pl=!0,Ue("game_state",e=>{if(H.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==H.localPlayerSlot){const n=H.players.get(t.slotIndex);n&&n.exists()&&(n.netTarget?(n.netTarget.x=t.x,n.netTarget.y=t.y):n.netTarget={x:t.x,y:t.y},n.angle=t.angle||0,n.outline&&n.outline.exists()&&(n.outline.angle=n.angle),t.maxHealth!==void 0&&(n.maxHealth=t.maxHealth),t.hp!==void 0&&n.setHP&&n.setHP(t.hp),t.invulnerable!==void 0&&(n.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(n.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(n.isDead=t.isDead,n.isDead?(n.canShoot=!1,n.canMove=!1,n.isShooting=!1,n.opacity=.5,n.outline&&n.outline.exists()&&(n.outline.opacity=.5)):(n.canShoot=!0,n.canMove=!0,n.opacity=1,n.outline&&n.outline.exists()&&(n.outline.opacity=1))),t.weapons&&(n.weapons=t.weapons),t.passiveUpgrades&&(n.passiveUpgrades=t.passiveUpgrades),t.upgradeStacks&&(n.upgradeStacks=t.upgradeStacks),t.speed!==void 0&&(n.speed=t.speed),t.damage!==void 0&&(n.damage=t.damage),t.pickupRadius!==void 0&&(n.pickupRadius=t.pickupRadius),t.runStats&&(n.runStats||(n.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),n.runStats.kills=t.runStats.kills,n.runStats.creditsPickedUp=t.runStats.creditsPickedUp,n.runStats.bossesKilled=t.runStats.bossesKilled))}else{const n=H.players.get(H.localPlayerSlot);n&&n.exists()&&(t.hp!==void 0&&n.setHP&&n.setHP(t.hp),t.maxHealth!==void 0&&(n.maxHealth=t.maxHealth),t.invulnerable!==void 0&&(n.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(n.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(n.isDead=t.isDead,n.isDead?(n.canShoot=!1,n.canMove=!1,n.isShooting=!1,n.opacity=.5,n.outline&&n.outline.exists()&&(n.outline.opacity=.5)):(n.canShoot=!0,n.canMove=!0,n.opacity=1,n.outline&&n.outline.exists()&&(n.outline.opacity=1))),t.runStats&&(n.runStats||(n.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),n.runStats.kills=t.runStats.kills,n.runStats.creditsPickedUp=t.runStats.creditsPickedUp,n.runStats.bossesKilled=t.runStats.bossesKilled))}}),e.enemies){const t=new Set;e.enemies.forEach(n=>{t.add(n.id);const o=H.enemies.get(n.id);o&&o.exists()&&(o.netTarget?(o.netTarget.x=n.x,o.netTarget.y=n.y):o.netTarget={x:n.x,y:n.y},n.maxHealth!==void 0&&(o.maxHealth=n.maxHealth),o.setHP&&n.hp!==void 0&&o.setHP(n.hp),n.shieldHealth!==void 0&&(o.shieldHealth=n.shieldHealth),n.armorHealth!==void 0&&(o.armorHealth=n.armorHealth),o.updateVisual&&o.updateVisual())}),H.enemies.forEach((n,o)=>{!t.has(o)&&n.exists()&&(n.cleanupHealthBars&&typeof n.cleanupHealthBars=="function"&&n.cleanupHealthBars(),H.k.destroy(n),H.enemies.delete(o))})}if(e.pickups){const t=new Set;e.pickups.forEach(n=>{t.add(n.id);const o=H.pickups.get(n.id);if(o&&o.exists()){if(o.pos.x=n.x,o.pos.y=n.y,n.magnetizing!==void 0)if(o.magnetizing=n.magnetizing,n.magnetizing&&n.targetPlayerSlot!==void 0){const i=H.players.get(n.targetPlayerSlot);i&&i.exists()?o.targetPlayer=i:(o.magnetizing=!1,o.targetPlayer=null)}else n.magnetizing||(o.targetPlayer=null);n.isFlyingToUI!==void 0&&(o.isFlyingToUI=n.isFlyingToUI)}}),H.pickups.forEach((n,o)=>{!t.has(o)&&n.exists()&&(H.k.destroy(n),H.pickups.delete(o))})}}}),Ue("spawn_entity",e=>{if(H.k){if(e.entityType==="enemy"){let t;e.isBoss?t=ul(H.k,e.x,e.y,e.type,e.floor):t=mi(H.k,e.x,e.y,e.type,e.floor),t.mpEntityId=e.id,e.isBossMinion&&(t.isBossMinion=!0),H.enemies.set(e.id,t)}else if(e.entityType==="xpPickup"){const t=fr(H.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",H.pickups.set(e.id,t)}else if(e.entityType==="currencyPickup"){const t=pr(H.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",H.pickups.set(e.id,t)}}}),Ue("spawn_projectile",e=>{if(!H.k)return;const t=H.k.vec2(e.directionX,e.directionY),n=Qn(H.k,e.x,e.y,t,e.speed,e.damage,e.piercing,e.obstaclePiercing,e.isCrit,e.maxRange);(e.char||e.color)&&(n.text=e.char,e.color&&(n.color=H.k.rgb(...e.color))),n.mpEntityId=e.id,H.projectiles.set(e.id,n)}),Ue("damage_dealt",e=>{if(!H.k)return;const t=H.k.add([H.k.text(e.damage.toString(),{size:e.isCrit?24:18}),H.k.pos(e.x,e.y),H.k.anchor("center"),H.k.color((e.isCrit,255),e.isCrit?200:255,e.isCrit?0:255),H.k.opacity(1),H.k.lifespan(.8),H.k.z(1e3)]);t.onUpdate(()=>{t.exists()&&(t.pos.y-=50*H.k.dt(),t.opacity-=1.25*H.k.dt())});const n=H.enemies.get(e.targetId);if(n&&n.exists()){const o=n.color;n.color=H.k.rgb(255,255,255),H.k.wait(.1,()=>{n.exists()&&(n.color=o)})}}),Ue("entity_destroyed",e=>{if(!H.k)return;const t=H.enemies.get(e.entityId)||H.pickups.get(e.entityId);t&&t.exists()&&(t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),H.k.destroy(t),(e.entityType==="pickup"||e.entityType==="xpPickup"||e.entityType==="currencyPickup")&&H.pickups.delete(e.entityId)),H.enemies.delete(e.entityId),H.projectiles.delete(e.entityId),H.pickups.delete(e.entityId)}),Ue("boss_enrage",e=>{if(!H.k)return;const t=H.enemies.get(e.networkId);t&&t.exists()&&t.enrage&&t.enrage()}),Ue("players_revived",e=>{if(!H.k)return;const n=.05+zt("secondWind")*.05;H.players.forEach((o,i)=>{if(o&&o.exists()&&(o.hp()<=0||o.isDead)){const s=Math.max(1,Math.floor(o.maxHealth*n));o.setHP(s),o.isDead=!1,i===H.localPlayerSlot&&(o.canMove=!0,o.canShoot=!0);const r=Math.round(n*100),l=H.k.add([H.k.text(` REVIVED (${r}% HP) `,{size:16}),H.k.pos(o.pos.x,o.pos.y-40),H.k.anchor("center"),H.k.color(100,255,100),H.k.opacity(1),H.k.lifespan(2),H.k.z(1e3)]);l.onUpdate(()=>{l.exists()&&(l.pos.y-=30*H.k.dt(),l.opacity-=.5*H.k.dt())}),o.opacity=1,o.characterData&&(o.color=H.k.rgb(...o.characterData.color)),o.outline&&o.outline.exists()&&(o.outline.opacity=1)}})}),Ue("game_seed",e=>{H.gameSeed=e.seed,H.floorRng=new Vo(H.gameSeed),e.roomTemplateKey&&(H.firstRoomTemplateKey=e.roomTemplateKey,console.log("[Multiplayer] Client received first room template:",e.roomTemplateKey)),H.onGameSeedCallback&&(H.onGameSeedCallback(),H.onGameSeedCallback=null)}),Ue("pause_state",e=>{H.k&&(H.k.paused=e.paused,H.k.gameData&&H.k.gameData.updatePauseUI&&H.k.gameData.updatePauseUI(e.paused))}),Ue("xp_gain",e=>{const t=H.players.get(H.localPlayerSlot);t&&t.exists()&&!t.isDead&&t.addXP?t.addXP(e.value):H.pendingXP+=e.value}),Ue("currency_gain",e=>{xs(e.value)}),Ue("enemy_split",e=>{H.k&&H.k.gameData&&H.k.gameData.incrementSplitEnemies&&H.k.gameData.incrementSplitEnemies(e.count)}),Ue("player_death",e=>{const t=H.players.get(e.slotIndex);t&&t.exists()&&(t.isDead=!0,t.canMove=!1,t.canShoot=!1,t.isShooting=!1,t.opacity=.5,t.outline&&t.outline.exists()&&(t.outline.opacity=.5))}),Ue("player_disconnected",e=>{const t=H.players.get(e.slotIndex);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),H.k.destroy(t),H.players.delete(e.slotIndex))}),Ue("host_quit",e=>{gs(),H.k&&H.k.go("menu")}),Ue("achievement_unlocked",e=>{if(e.playerSlotIndex!==H.localPlayerSlot){const t=No[e.achievementId];t&&H.k&&(qh(H.k),u_(e.playerName,t))}}))}function jf(e,t){H.players.set(e,t),t.mpSlotIndex=e}function b_(e){const t=H.players.get(e);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),H.k&&H.k.destroy(t),H.players.delete(e),H.isHost&&E_(e))}function E_(e){H.isHost&&Je("player_disconnected",{slotIndex:e})}function S_(e){if(H.isActive)if(H.lastSyncTime+=e,H.lastResyncTime+=e,H.isHost)H.lastSyncTime>=H.syncInterval&&(C_(),H.lastSyncTime=0),H.lastResyncTime>=H.resyncInterval&&(H.players.forEach((t,n)=>{t&&t.exists()&&(t.isDead&&t.hp()>0&&(console.warn("[Multiplayer] Desync detected: Player",n,"is marked dead but has HP. Correcting..."),t.setHP(0)),!t.isDead&&t.hp()<=0&&(console.warn("[Multiplayer] Desync detected: Player",n,"has no HP but not marked dead. Correcting..."),t.isDead=!0,t.canMove=!1,t.canShoot=!1))}),H.lastResyncTime=0);else{if(H.lastSyncTime>=H.syncInterval&&(T_(),H.lastSyncTime=0),H.lastResyncTime>=H.resyncInterval){let n=!1;H.players.forEach((o,i)=>{o&&o.exists()&&(o.isDead&&o.hp()>0&&(console.warn("[Multiplayer] Client desync: Player",i,"is dead but has HP"),n=!0),!o.isDead&&o.hp()<=0&&(console.warn("[Multiplayer] Client desync: Player",i,"has no HP but not dead"),n=!0))}),n&&eA(),H.lastResyncTime=0}const t=Math.min(e*10,1);H.players.forEach(n=>{n.exists()&&n.isRemote&&n.netTarget&&(n.pos.x+=(n.netTarget.x-n.pos.x)*t,n.pos.y+=(n.netTarget.y-n.pos.y)*t)}),H.enemies.forEach(n=>{n.exists()&&n.netTarget&&(n.pos.x+=(n.netTarget.x-n.pos.x)*t,n.pos.y+=(n.netTarget.y-n.pos.y)*t)})}}function Yh(){const e=[],t=[],n=[],o=[];return H.players.forEach((i,s)=>{if(i.exists()){let r=[],l=[],c={};try{i.weapons&&(r=JSON.parse(JSON.stringify(i.weapons))),i.passiveUpgrades&&(l=JSON.parse(JSON.stringify(i.passiveUpgrades))),i.upgradeStacks&&(c=JSON.parse(JSON.stringify(i.upgradeStacks)))}catch(a){console.warn("Failed to serialize player upgrades:",a)}let d=i.maxHealth;i.hp&&typeof i.hp=="function"?d=i.hp():typeof i.hp=="number"&&(d=i.hp),e.push({slotIndex:Number(s),x:Number(i.pos.x),y:Number(i.pos.y),angle:Number(i.angle||0),hp:Number(d),maxHealth:Number(i.maxHealth||100),level:Number(i.level||1),xp:Number(i.xp||0),isDead:!!i.isDead,weapons:r,passiveUpgrades:l,upgradeStacks:c,speed:Number(i.speed||0),damage:Number(i.damage||0),pickupRadius:Number(i.pickupRadius||0),invulnerable:!!i.invulnerable,invulnerableTime:Number(i.invulnerableTime||0),runStats:i.runStats?{kills:Number(i.runStats.kills||0),creditsPickedUp:Number(i.runStats.creditsPickedUp||0),bossesKilled:Number(i.runStats.bossesKilled||0)}:null})}}),H.enemies.forEach((i,s)=>{if(i.exists()){let r=0;i.hp&&typeof i.hp=="function"?r=i.hp():typeof i.hp=="number"&&(r=i.hp),t.push({id:Number(s),x:Number(i.pos.x),y:Number(i.pos.y),hp:Number(r),maxHealth:Number(i.maxHealth||0),type:String(i.enemyType||"basic"),shieldHealth:Number(i.shieldHealth||0),armorHealth:Number(i.armorHealth||0)})}else H.enemies.delete(s)}),H.projectiles.forEach((i,s)=>{i.exists()||H.projectiles.delete(s)}),H.pickups.forEach((i,s)=>{if(i.exists()){const r={id:Number(s),x:Number(i.pos.x),y:Number(i.pos.y),type:String(i.pickupType||"xp"),magnetizing:!!i.magnetizing,isFlyingToUI:!!i.isFlyingToUI};i.magnetizing&&i.targetPlayer&&i.targetPlayer.slotIndex!==void 0&&(r.targetPlayerSlot=Number(i.targetPlayer.slotIndex)),o.push(r)}else H.pickups.delete(s)}),{players:e,enemies:t,projectiles:n,pickups:o}}function C_(){H.isHost&&Je("game_state",Yh())}function __(e){!H.isHost||!H.isActive||(console.log("Sending initial game state to new joiner:",e),yo(e,"game_state",Yh()),A_(e))}function A_(e){!H.isHost||!H.isActive||!H.k||(H.k,console.log("[Multiplayer] Sending existing entities to new joiner:",e),H.enemies.forEach((t,n)=>{if(t&&t.exists()){const o={entityId:n,entityType:"enemy",x:t.pos.x,y:t.pos.y,enemyType:t.type||"basic",floor:t.floor||1,isBoss:t.is("boss")||!1,isMiniboss:t.is("miniboss")||!1,health:t.hp(),maxHealth:t.maxHealth,armorHealth:t.armorHealth||0,shieldHealth:t.shieldHealth||0};yo(e,"spawn_entity",o)}}),H.pickups.forEach((t,n)=>{if(t&&t.exists()){const o={entityId:n,entityType:"pickup",x:t.pos.x,y:t.pos.y,pickupType:t.pickupType||(t.is("xpPickup")?"xp":t.is("currencyPickup")?"currency":"powerup"),xpValue:t.xpValue||0,currencyValue:t.currencyValue||0};yo(e,"spawn_entity",o)}}),console.log("[Multiplayer] Sent",H.enemies.size,"enemies and",H.pickups.size,"pickups to new joiner"))}function T_(){if(H.isHost)return;const e=H.players.get(H.localPlayerSlot);if(!e||!e.exists())return;const t=e.moveDir?{x:Number(e.moveDir.x||0),y:Number(e.moveDir.y||0)}:{x:0,y:0};Ln("player_input",{slotIndex:Number(H.localPlayerSlot),move:t,shoot:!!e.isShooting,aimAngle:Number(e.aimAngle||0)})}function de(){return H.isActive}function M_(){return H.players.size}function gs(){H.isActive=!1,H.players.clear(),H.inputBuffer=[],H.enemies.clear(),H.projectiles.clear(),H.pickups.clear(),H.nextEntityId=1,Xt("player_input"),Xt("pause_request"),Xt("player_death"),Xt("enemy_death"),Xt("resync_request"),Xt("level_up_queued"),Xt("player_emote"),Xt("upgrade_selected"),Xt("synergy_activated"),Xt("achievement_unlocked"),Xt("game_state"),Xt("spawn_entity"),Xt("spawn_projectile"),Xt("damage_dealt"),Xt("entity_destroyed"),Xt("boss_enrage"),Xt("players_revived"),Xt("game_seed"),Xt("pause_state"),Xt("xp_gain"),Xt("currency_gain"),Xt("enemy_split"),Xt("player_disconnected"),Xt("host_quit"),QC(),pl=!1,Ed=!1}function fo(e,t={}){if(!H.isHost)return null;const n=H.nextEntityId++;return e.mpEntityId=n,H.enemies.set(n,e),Je("spawn_entity",{id:n,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1,isBoss:t.isBoss||!1,isBossMinion:t.isBossMinion||!1}),n}function ms(e,t={}){if(!H.isHost)return null;const n=H.nextEntityId++;e.mpEntityId=n,H.projectiles.set(n,e);let o=[255,255,100];return e.color&&e.color.r!==void 0&&(o=[Math.round(e.color.r),Math.round(e.color.g),Math.round(e.color.b)]),Je("spawn_projectile",{id:Number(n),x:Number(e.pos.x),y:Number(e.pos.y),directionX:Number(e.direction.x),directionY:Number(e.direction.y),speed:Number(e.speed),damage:Number(e.damage),piercing:Number(e.piercing||0),obstaclePiercing:Number(e.obstaclePiercing||0),isCrit:!!e.isCrit,maxRange:Number(e.maxRange),angle:Number(e.angle||0),char:e.text||t.char||"*",color:o}),n}function R_(e){H.isActive&&e.mpEntityId!==void 0&&H.projectiles.delete(e.mpEntityId)}function Gh(e,t={}){if(!H.isHost)return null;const n=H.nextEntityId++;e.mpEntityId=n,H.pickups.set(n,e);const o={id:n,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(o.icon=t.icon),Je("spawn_entity",o),n}function Kh(e){H.isActive&&e.mpEntityId!==void 0&&H.pickups.delete(e.mpEntityId)}function ve(){return H.isHost}function D_(e){!H.isHost||!H.isActive||Je("damage_dealt",{targetId:Number(e.targetId),targetType:String(e.targetType),damage:Number(e.damage),isCrit:!!e.isCrit,attackerId:e.attackerId!==void 0?Number(e.attackerId):null,x:Number(e.x),y:Number(e.y)})}function zm(e){!H.isHost||!H.isActive||Je("player_healed",{slotIndex:Number(e.slotIndex),healAmount:Number(e.healAmount),newHP:Number(e.newHP),source:String(e.source||"unknown")})}function mc(e){!H.isHost||!H.isActive||Je("player_dodged",{slotIndex:Number(e.slotIndex),x:Number(e.x),y:Number(e.y)})}function Vh(e){!H.isHost||!H.isActive||Je("entity_destroyed",{entityId:Number(e.entityId),entityType:String(e.entityType),x:Number(e.x),y:Number(e.y),xpDropped:e.xpDropped!==void 0?Number(e.xpDropped):0,currencyDropped:e.currencyDropped!==void 0?Number(e.currencyDropped):0})}function Jf(e){!H.isHost||!H.isActive||Je("boss_enrage",{networkId:e})}function I_(){!H.isHost||!H.isActive||Je("players_revived",{timestamp:Date.now()})}function Qf(e,t,n=[]){!H.isHost||!H.isActive||Je("game_over",{runStats:e,currencyEarned:t,partyStats:n,timestamp:Date.now()})}function P_(){!H.isHost||!H.isActive||Je("host_quit",{timestamp:Date.now()})}function L_(e){!H.isHost||!H.isActive||Je("powerup_weapon_applied",{powerupKey:e,timestamp:Date.now()})}function O_(e,t){H.isActive&&(H.isHost?Je("upgrade_selected",{slotIndex:e,upgradeKey:t,timestamp:Date.now()}):Ln("upgrade_selected",{slotIndex:e,upgradeKey:t}))}function N_(e,t){H.isActive&&(H.isHost?Je("level_up_queued",{slotIndex:e,level:t,timestamp:Date.now()}):Ln("level_up_queued",{slotIndex:e,level:t}))}function B_(e,t){H.isActive&&(H.isHost?Je("synergy_activated",{slotIndex:e,synergies:t,timestamp:Date.now()}):Ln("synergy_activated",{slotIndex:e,synergies:t}))}function Zf(e,t){!H.isHost||!H.isActive||Je("powerup_expired",{slotIndex:e,powerupKey:t,timestamp:Date.now()})}function kf(){return H.gameSeed!==0}function H_(e){H.onGameSeedCallback=e}function z_(e){H.currentFloor=e;const t=Uh(H.gameSeed,e);H.floorRng=new Vo(t)}function ya(){const e=Uh(H.gameSeed,H.currentFloor,H.currentRoom.x,H.currentRoom.y);return new Vo(e)}function U_(){const e=H.firstRoomTemplateKey;return H.firstRoomTemplateKey=null,e}function F_(){return H.floorRng}function X_(e,t){const n=Uh(H.gameSeed,e,t);return new Vo(n)}function q_(e=null){H.isHost&&Je("game_seed",{seed:H.gameSeed,roomTemplateKey:e})}function Y_(e){H.isHost&&Je("pause_state",{paused:e})}function G_(e){H.isHost||Ln("pause_request",{paused:e})}function K_(e){H.isHost||Ln("enemy_death",e)}function V_(e,t=null){H.isHost&&Je("obstacle_data",{obstacles:e,doorStates:t})}function W_(){H.isHost&&Je("room_completed",{})}function $_(e){H.isHost&&Je("xp_gain",{value:e})}function j_(e){H.isHost&&Je("currency_gain",{value:e})}function J_(){const e=H.pendingXP;return H.pendingXP=0,e}function ep(e,t){H.isHost?Je("player_emote",{slotIndex:e,emoteType:t}):Ln("player_emote",{slotIndex:e,emoteType:t})}function Q_(e,t=null,n=null,o=null,i=null){H.isHost&&Je("room_transition",{entryDirection:e,allPlayerStats:t,gridDirection:n,currentFloor:o,roomTemplateKey:i})}function Z_(e){H.isHost&&Je("enemy_split",{count:e})}function k_(e){H.isActive&&(H.isHost?Je("player_death",{slotIndex:e}):Ln("player_death",{slotIndex:e}))}function eA(){H.isHost||Ln("resync_request",{timestamp:Date.now()})}function tA(){return H.localPlayerSlot}function nA(e,t){if(!H.isActive)return;const i=Zi().slots[t]?.name||`Player ${t+1}`;Je("achievement_unlocked",{achievementId:e,playerSlotIndex:t,playerName:i})}class tp{constructor(t,n,o,i=0){this.k=t,this.createFn=n,this.resetFn=o,this.pool=[],this.active=new Set;for(let s=0;s<i;s++){const r=this.createFn(t);r.hidden=!0,r.paused!==void 0&&(r.paused=!0),this.pool.push(r)}}acquire(...t){let n;return this.pool.length>0?(n=this.pool.pop(),n.hidden=!1,n.paused!==void 0&&(n.paused=!1)):n=this.createFn(this.k),this.resetFn&&this.resetFn(n,...t),this.active.add(n),n._pooled=!0,n}release(t){if(!(!t||!t._pooled)){if(!t.exists||!t.exists()){this.active.delete(t);return}t.hidden=!0,t.paused!==void 0&&(t.paused=!0),t.pos&&(t.pos.x=-9999,t.pos.y=-9999),this.active.delete(t),this.pool.push(t)}}clear(){for(const t of this.pool)t.exists&&t.exists()&&this.k.destroy(t);this.pool=[];for(const t of this.active)t.exists&&t.exists()&&this.k.destroy(t);this.active.clear()}getPoolSize(){return this.pool.length}getActiveCount(){return this.active.size}prewarm(t){for(let n=0;n<t;n++){const o=this.createFn(this.k);o.hidden=!0,o.paused!==void 0&&(o.paused=!0),o._pooled=!0,o.pos&&(o.pos.x=-9999,o.pos.y=-9999),this.pool.push(o)}}}const qo={projectiles:null,particles:null};function oA(e){qo.projectiles=new tp(e,t=>{const n=t.add([t.text("*",{size:16}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,100),t.rotate(0),t.area(),"projectile"]);return n.hidden=!0,n},(t,n,o,i,s,r,l,c,d,a)=>{t.pos.x=n,t.pos.y=o,t.damage=r,t.piercing=l||0,t.obstaclePiercing=c||0,t.piercedEnemies=new Set,t.piercedObstacles=new Set,t.isCrit=d||!1,t.maxRange=a||750,t.distanceTraveled=0,t.direction=i,t.speed=s,t.isBoomerang=!1,t.isReturning=!1,t.ownerPlayer=null,t.returnSpeedMultiplier=1.2,t.isExplosive=!1,t.isChainLightning=!1,t.isEnemyProjectile=!1,t.isBossProjectile=!1,t.isReflected=!1,t.reflectionCount=0,t.chainedEnemies=null,t.chainJumps=0,t.ownerSlotIndex=void 0,t.burnDamage=null,t.burnDuration=null,t.text="*",t.color=d?e.rgb(255,200,0):e.rgb(255,255,100);const h=Math.atan2(i.y,i.x)*(180/Math.PI)+90;t.angle=h},50),qo.particles=new tp(e,t=>{const n=t.add([t.text("*",{size:12}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,255),t.z(100),"particle"]);return n.hidden=!0,n},(t,n,o,i={})=>{const{char:s="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:a=1,fadeStart:h=.3,friction:u=.95,zIndex:p=100}=i;t.pos.x=n,t.pos.y=o,t.text=s,t.color=e.rgb(...l),t.z=p,t.opacity=1,t.velocity={x:c.x,y:c.y},t.gravity=d,t.friction=u,t.lifetime=a,t.fadeStart=h,t.age=0,t.initialOpacity=1},100)}function Um(){return qo.particles}function iA(){qo.projectiles&&(qo.projectiles.clear(),qo.projectiles=null),qo.particles&&(qo.particles.clear(),qo.particles=null)}function Qn(e,t,n,o,i,s,r=0,l=0,c=!1,d=null){const a=Math.atan2(o.y,o.x)*(180/Math.PI)+90,h=e.add([e.text("*",{size:16}),e.pos(t,n),e.anchor("center"),e.color(255,c?200:255,c?0:100),e.rotate(a),e.area(),"projectile"]);return h.damage=s,h.piercing=r,h.obstaclePiercing=l,h.piercedEnemies=new Set,h.piercedObstacles=new Set,h.isCrit=c,h.maxRange=d||As.DEFAULT_WEAPON_RANGE,h.distanceTraveled=0,h.direction=o,h.speed=i,h.isBoomerang=!1,h.isReturning=!1,h.ownerPlayer=null,h.returnSpeedMultiplier=1.2,h.useWeaponVisual=function(u){u&&u.char&&(h.text=u.char),u&&u.color&&(h.isCrit||(h.color=e.rgb(...u.color))),u&&u.range&&(h.maxRange=u.range)},h.onUpdate(()=>{if(e.paused)return;if(h.isBoomerang){if(h.isReturning)if(h.ownerPlayer&&h.ownerPlayer.exists()&&!h.ownerPlayer.isDead){const A=e.vec2(h.ownerPlayer.pos.x-h.pos.x,h.ownerPlayer.pos.y-h.pos.y),m=A.len();if(m>0){const C=A.unit(),I=h.speed*h.returnSpeedMultiplier,R=C.scale(I*e.dt());if(h.pos.x+=R.x,h.pos.y+=R.y,h.direction=C,m<30){e.destroy(h);return}}}else{e.destroy(h);return}else{const A=h.direction.scale(h.speed*e.dt());h.distanceTraveled+=A.len(),h.pos.x+=A.x,h.pos.y+=A.y,h.distanceTraveled>=h.maxRange&&(h.isReturning=!0,h.piercedEnemies.clear(),h.distanceTraveled=0)}const g=Math.atan2(h.direction.y,h.direction.x)*(180/Math.PI)+90;h.angle=g;return}const u=h.direction.scale(h.speed*e.dt()),p=u.len();if(h.distanceTraveled+=p,h.pos.x+=u.x,h.pos.y+=u.y,h.distanceTraveled>=h.maxRange){e.destroy(h);return}(h.pos.x<0||h.pos.x>e.width()||h.pos.y<0||h.pos.y>e.height())&&e.destroy(h)}),de()&&ve()&&ms(h),de()&&h.onDestroy(()=>{R_(h)}),h}const Os={rusher:{name:"Security Guard",char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{name:"Camera Operator",char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.53,projectileSpeed:200,projectileDamage:7},zombie:{name:"Audience Member",char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{name:"Fan",char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{name:"Stagehand",char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{name:"Head of Security",char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{name:"Camera Director",char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{name:"Bouncer",char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{name:"Runner",char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{name:"Pyrotechnics Tech",char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{name:"Floor Manager",char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},splitter:{name:"Intern",char:"",color:[200,255,200],baseHealth:40,baseSpeed:75,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,splits:!0,splitCount:2},mage:{name:"Lighting Director",char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{name:"Stage Manager",char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{name:"Set Designer",char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{name:"Editor",char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{name:"Casting Director",char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{name:"Assistant Director",char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},phaser:{name:"Ghost Writer",char:"",color:[180,180,255],baseHealth:25,baseSpeed:100,size:18,baseXPValue:3,behavior:"phase",pathfindingMode:"none",damage:10,phaseOpacity:.5,phaseThroughObstacles:!0},mimic:{name:"Stunt Double",char:"@",color:[255,100,100],baseHealth:35,baseSpeed:150,size:18,baseXPValue:4,behavior:"mimic",pathfindingMode:"none",damage:12,mimicDuration:2,mimicCooldown:4},healer:{name:"Producer",char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{name:"Executive Producer",char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{name:"Network Executive",char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{name:"Talent Agent",char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},reflector:{name:"Mirror Master",char:"",color:[200,200,255],baseHealth:80,baseSpeed:45,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:12,reflectsProjectiles:!0,reflectChance:.4},bomber:{name:"Demolitions Expert",char:"",color:[255,150,100],baseHealth:70,baseSpeed:0,size:22,baseXPValue:5,behavior:"bomber",fireRate:.4,projectileSpeed:100,projectileDamage:20,homingStrength:.5,bombExplosionRadius:50},basic:{name:"Crew Member",char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{name:"Camera Operator",char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{name:"Runner",char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function sA(e){return Os[e]||Os.basic}const Po=32,rA=100;class aA{constructor(){this.elements=[]}enqueue(t,n){this.elements.push({element:t,priority:n}),this.elements.sort((o,i)=>o.priority-i.priority)}dequeue(){return this.elements.shift()?.element}isEmpty(){return this.elements.length===0}}function np(e,t){return{gx:Math.floor(e/Po),gy:Math.floor(t/Po)}}function Fm(e,t){return{x:e*Po+Po/2,y:t*Po+Po/2}}function yc(e,t,n,o,i){if(t<0||n<0||t>=o||n>=i)return!1;const s=Fm(t,n),r=e.get("obstacle");for(const l of r){if(!l.exists())continue;const c=Po/2,d=s.x-c,a=s.x+c,h=s.y-c,u=s.y+c,p=l.pos.x-l.width/2,g=l.pos.x+l.width/2,A=l.pos.y-l.height/2,m=l.pos.y+l.height/2;if(a>p&&d<g&&u>A&&h<m)return!1}return!0}function lA(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function cA(e,t,n,o,i){const s=e.width(),r=e.height(),l=Math.ceil(s/Po),c=Math.ceil(r/Po),d=np(t,n),a=np(o,i);if(!yc(e,d.gx,d.gy,l,c)||!yc(e,a.gx,a.gy,l,c))return[];const h=new aA;h.enqueue(d,0);const u=new Map,p=new Map,g=R=>`${R.gx},${R.gy}`;u.set(g(d),null),p.set(g(d),0);let A=0;const m=l*c;for(;!h.isEmpty()&&A<m;){A++;const R=h.dequeue();if(R.gx===a.gx&&R.gy===a.gy)break;const f=[{gx:R.gx+1,gy:R.gy},{gx:R.gx-1,gy:R.gy},{gx:R.gx,gy:R.gy+1},{gx:R.gx,gy:R.gy-1},{gx:R.gx+1,gy:R.gy+1},{gx:R.gx+1,gy:R.gy-1},{gx:R.gx-1,gy:R.gy+1},{gx:R.gx-1,gy:R.gy-1}];for(const N of f){if(!yc(e,N.gx,N.gy,l,c))continue;const T=N.gx!==R.gx&&N.gy!==R.gy?1.4:1,x=p.get(g(R))+T,M=g(N);if(!p.has(M)||x<p.get(M)){p.set(M,x);const _=x+lA(N,a);h.enqueue(N,_),u.set(M,R)}}}const C=[];let I=a;for(;I&&u.has(g(I));){const R=Fm(I.gx,I.gy);if(C.unshift(R),I=u.get(g(I)),C.length>rA)break}return C}function dA(e,t,n,o){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=cA(e,t.pos.x,t.pos.y,n,o),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const r=t.pathfindingPath[t.pathfindingWaypointIndex];if(r){const l=e.vec2(r.x-t.pos.x,r.y-t.pos.y),c=l.len();if(c<Po/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),c>0)return l.unit()}}const i=e.vec2(n-t.pos.x,o-t.pos.y);return i.len()>0?i.unit():e.vec2(0,0)}function hA(e,t){const n=e.width(),o=e.height(),i=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:i});const s=t.perimeterMode;t.speed*e.dt();const r=20,l=e.vec2(s.targetX-t.pos.x,s.targetY-t.pos.y),c=l.len();if(c<r)switch(s.side){case"top":s.side="right",s.targetX=n-i,s.targetY=i;break;case"right":s.side="bottom",s.targetX=n-i,s.targetY=o-i;break;case"bottom":s.side="left",s.targetX=i,s.targetY=o-i;break;case"left":s.side="top",s.targetX=i,s.targetY=i;break}return c>0?l.unit():e.vec2(0,0)}function mi(e,t,n,o="basic",i=1,s=null){const r=sA(o),l=1+(i-1)*.3,c={char:r.char,color:r.color,health:Math.floor(r.baseHealth*l),speed:Math.floor(r.baseSpeed*(1+(i-1)*.1)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),behavior:r.behavior};function d(){return c.char}const a=e.add([e.text(d(),{size:c.size}),e.pos(t,n),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"enemy"]);a.originalColor=c.color,a.maxHealth=c.health,a.speed=c.speed,a.xpValue=c.xpValue,a.type=o,a.behavior=c.behavior,a.floor=i,a.pathfindingMode=r.pathfindingMode||"none",r.damage&&(a.damage=r.damage),r.fireRate&&(a.fireRate=r.fireRate),r.projectileSpeed&&(a.projectileSpeed=r.projectileSpeed),r.projectileDamage&&(a.projectileDamage=r.projectileDamage),r.chargeCooldown&&(a.chargeCooldown=r.chargeCooldown),r.splits&&(a.splits=!0,a.splitCount=r.splitCount||2,a.splitType=r.splitType||o),r.explodes&&(a.explodes=!0,a.explosionDamage=r.explosionDamage,a.explosionRadius=r.explosionRadius,r.shrapnel&&(a.shrapnel=!0,a.shrapnelCount=r.shrapnelCount||8));let h=0,u=0,p=0;if(i>=2){const T=s?s.next():Math.random();i>=2&&(o==="zombie"||o==="turret"||o==="heavyTank"||T<.3)&&(h=Math.floor(15+(i-2)*5))}if(i>=3){const T=s?s.next():Math.random();(o==="shooter"||o==="turret"||o==="wraith"||T<.2)&&(u=Math.floor(10+(i-3)*5),p=1+(i-3)*.5)}if(i>=4){const T=s?s.next():Math.random();(o==="heavyTank"||o==="spawner"||T<.1)&&(h===0&&(h=Math.floor(20+(i-4)*5)),u===0&&(u=Math.floor(15+(i-4)*5),p=1.5+(i-4)*.5))}const g=(r.baseArmorHealth||0)+h;a.armorHealth=Math.floor(g*l),a.maxArmorHealth=Math.floor(g*l),a.damageReduction=r.damageReduction||(g>0?.2:0),a.armorChar=r.armorChar||"[]",a.armorColor=r.armorColor||[200,200,200];const A=(r.baseShieldHealth||0)+u;a.shieldHealth=Math.floor(A*l),a.maxShieldHealth=Math.floor(A*l),a.shieldRegenRate=((r.shieldRegenRate||0)+p)*l,a.shieldChar=r.shieldChar||"{}",a.shieldColor=r.shieldColor||[100,200,255],a.shieldRegenTimer=0,a.shieldRegenCooldown=0,a.lastDamageTime=0,a.originalColor=c.color,a.coreChar=c.char,a.updateVisual=function(){let T="",x="",M="",_="";if(a.shieldHealth>0){const P=a.shieldHealth/a.maxShieldHealth;P>.66?(T="",x=""):P>.33?(T="",x=""):(T="",x="")}if(a.armorHealth>0){const P=a.armorHealth/a.maxArmorHealth;P>.66?(M="",_=""):P>.33?(M="",_=""):(M="",_="")}const O=`${T}${M}${a.coreChar}${_}${x}`;a.text=O,a.shieldHealth>0?a.color=e.rgb(...a.shieldColor):a.color=e.rgb(...a.originalColor)},a.takeDamage=function(T){let x=!1,M=!1;const _=a.shieldHealth,O=a.armorHealth;a.lastDamageTime=e.time();const P=3;if(a.shieldRegenCooldown=P,a.shieldHealth>0){const z=Math.min(T,a.shieldHealth);a.shieldHealth=Math.max(0,a.shieldHealth-z),x=a.shieldHealth!==_;const U=T-z;U>0&&a.takeDamageInternal(U)}else a.takeDamageInternal(T);M=a.armorHealth!==O,(x||M)&&a.updateVisual()},a.takeDamageInternal=function(T){if(a.armorHealth>0){const x=Math.floor(T*(1-a.damageReduction)),M=Math.min(x,a.armorHealth);a.armorHealth=Math.max(0,a.armorHealth-M);const _=T-x;if(_>0){const O=a.armorHealth>0?1-a.damageReduction:1,P=Math.floor(_*O);a.hurt(P)}}else a.hurt(T)},r.blocksProjectiles&&(a.blocksProjectiles=!0),r.teleportCooldown&&(a.teleportCooldown=r.teleportCooldown),r.teleportRange&&(a.teleportRange=r.teleportRange),r.spawnInterval&&(a.spawnInterval=r.spawnInterval),r.spawnType&&(a.spawnType=r.spawnType),r.buffRadius&&(a.buffRadius=r.buffRadius),r.buffAmount&&(a.buffAmount=r.buffAmount),r.healRadius&&(a.healRadius=r.healRadius),r.healAmount&&(a.healAmount=r.healAmount),r.healInterval&&(a.healInterval=r.healInterval),r.slowRadius&&(a.slowRadius=r.slowRadius),r.slowAmount&&(a.slowAmount=r.slowAmount),r.lifesteal&&(a.lifesteal=r.lifesteal),r.phaseOpacity&&(a.phaseOpacity=r.phaseOpacity),r.phaseThroughObstacles&&(a.phaseThroughObstacles=r.phaseThroughObstacles),r.mimicDuration&&(a.mimicDuration=r.mimicDuration),r.mimicCooldown&&(a.mimicCooldown=r.mimicCooldown),r.reflectsProjectiles&&(a.reflectsProjectiles=r.reflectsProjectiles),r.reflectChance&&(a.reflectChance=r.reflectChance),r.homingStrength&&(a.homingStrength=r.homingStrength),r.bombExplosionRadius&&(a.bombExplosionRadius=r.bombExplosionRadius),a.updateVisual(),a.attackTimer=0,a.chargeTimer=0,a.isCharging=!1,a.chargeDirection=null,a.chargeDuration=0,a.chargePauseTimer=0,a.teleportTimer=0,a.spawnTimer=0,a.healTimer=0,a.buffedEnemies=new Set,a.mimicTimer=0,a.mimicMovementHistory=[],a.isMimicking=!1,a.mimicMoveIndex=0,a.phaseOpacity&&(a.opacity=a.phaseOpacity),a.stuckTimer=0,a.stuckThreshold=1,a.lastPosition={x:t,y:n},a.lastPositionUpdateTime=0,a.avoidanceDirection=null,a.avoidanceTimer=0;const m=30,C=3,I=-20,R=e.add([e.rect(m,C),e.pos(t,n+I),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),f=e.add([e.rect(m,C),e.pos(t,n+I),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);a.healthBarBg=R,a.healthBar=f,a.showHealthThreshold=.5,R.hidden=!0,f.hidden=!0,a.onUpdate(()=>{if(a.exists()&&a.healthBar&&a.healthBarBg){const T=a.hp()/a.maxHealth;if(T<a.showHealthThreshold&&T>0){a.healthBarBg.hidden=!1,a.healthBar.hidden=!1,a.healthBarBg.pos.x=a.pos.x,a.healthBarBg.pos.y=a.pos.y+I,a.healthBar.pos.x=a.pos.x,a.healthBar.pos.y=a.pos.y+I;const M=m*T;a.healthBar.width=Math.max(1,M),a.healthBar.pos.x=a.pos.x-(m-M)/2}else a.healthBarBg.hidden=!0,a.healthBar.hidden=!0}}),a.cleanupHealthBars=function(){a.healthBarBg&&a.healthBarBg.exists()&&e.destroy(a.healthBarBg),a.healthBar&&a.healthBar.exists()&&e.destroy(a.healthBar)};const N=(T,x)=>{const M=e.get("obstacle"),_=a.size||12;for(const O of M){if(!O.exists())continue;const P=O.pos.x-O.width/2,z=O.pos.x+O.width/2,U=O.pos.y-O.height/2,F=O.pos.y+O.height/2,B=T-_,D=T+_,q=x-_,G=x+_;if(D>P&&B<z&&G>U&&q<F)return!1}return!0},b=T=>{const x=T.len(),M=x>0?T.unit():e.vec2(0,0);a.lastPositionUpdateTime+=e.dt(),a.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(a.pos.x-a.lastPosition.x,2)+Math.pow(a.pos.y-a.lastPosition.y,2))<5?a.stuckTimer+=a.lastPositionUpdateTime:a.stuckTimer=0,a.lastPosition={x:a.pos.x,y:a.pos.y},a.lastPositionUpdateTime=0);const _=a.pos.x+T.x,O=a.pos.y+T.y;if(N(_,O))return a.avoidanceDirection=null,a.avoidanceTimer=0,T;if(a.avoidanceTimer-=e.dt(),a.stuckTimer>=a.stuckThreshold||a.avoidanceTimer<=0){const P=e.vec2(-M.y,M.x),z=e.vec2(M.y,-M.x),U=[P.scale(x),z.scale(x),e.vec2(P.x*.7+M.x*.3,P.y*.7+M.y*.3).unit().scale(x),e.vec2(z.x*.7+M.x*.3,z.y*.7+M.y*.3).unit().scale(x),e.vec2(P.x*.5+M.x*.5,P.y*.5+M.y*.5).unit().scale(x),e.vec2(z.x*.5+M.x*.5,z.y*.5+M.y*.5).unit().scale(x)];for(const F of U){const B=a.pos.x+F.x,D=a.pos.y+F.y;if(N(B,D))return a.avoidanceDirection=e.vec2(F.x,F.y).unit(),a.avoidanceTimer=.8,F}if(a.avoidanceDirection){const F=a.avoidanceDirection.scale(x),B=a.pos.x+F.x,D=a.pos.y+F.y;if(N(B,D))return F}return N(_,a.pos.y)?e.vec2(T.x,0):N(a.pos.x,O)?e.vec2(0,T.y):e.vec2(0,0)}else if(a.avoidanceDirection){const P=a.avoidanceDirection.scale(x),z=a.pos.x+P.x,U=a.pos.y+P.y;if(N(z,U))return P;a.avoidanceDirection=null,a.avoidanceTimer=0}return N(_,a.pos.y)?e.vec2(T.x,0):N(a.pos.x,O)?e.vec2(0,T.y):e.vec2(0,0)};return a.onUpdate(()=>{if(e.paused)return;if(a.shieldRegenRate>0&&a.shieldHealth<a.maxShieldHealth&&a.hp()>0&&!a.isDead){if((!de()||ve())&&(a.shieldRegenCooldown>0&&(a.shieldRegenCooldown-=e.dt()),a.shieldRegenCooldown<=0)){a.shieldRegenTimer+=e.dt();const B=1;if(a.shieldRegenTimer>=B){const D=a.shieldRegenRate*B;a.shieldHealth=Math.min(a.maxShieldHealth,a.shieldHealth+D),a.shieldRegenTimer=0}}a.shieldHealth>0&&a.updateVisual&&a.updateVisual()}a.burnDuration>0&&a.hp()>0&&!a.isDead&&(a.burnTimer=(a.burnTimer||0)+e.dt(),a.burnTimer>=.5&&((!de()||ve())&&(a.takeDamage?a.takeDamage(a.burnDamage):a.hurt(a.burnDamage)),a.color=e.rgb(255,150,50),e.wait(.1,()=>{a.exists()&&(a.color=e.rgb(...a.originalColor))}),a.burnTimer=0),a.burnDuration-=e.dt(),a.burnDuration<=0&&(a.burnDamage=0,a.burnTimer=0));const T=e.gameData?.alivePlayers||e.get("player").filter(B=>B.exists()&&!B.isDead&&B.hp()>0);if(T.length===0)return;let x=T[0],M=Math.sqrt(Math.pow(x.pos.x-a.pos.x,2)+Math.pow(x.pos.y-a.pos.y,2));for(let B=1;B<T.length;B++){const D=T[B],q=Math.sqrt(Math.pow(D.pos.x-a.pos.x,2)+Math.pow(D.pos.y-a.pos.y,2));q<M&&(M=q,x=D)}const _=e.vec2(x.pos.x-a.pos.x,x.pos.y-a.pos.y),O=_.len();if(a.behavior==="turret"){if(a.attackTimer+=e.dt(),O>0&&a.attackTimer>=1/a.fireRate){const B=_.unit(),D=Qn(e,a.pos.x,a.pos.y,B,a.projectileSpeed,a.projectileDamage,0,0,!1);D.isEnemyProjectile=!0,D.color=e.rgb(...a.originalColor),a.attackTimer=0}return}if(a.behavior==="shoot"){a.attackTimer+=e.dt();const B=150;let D=e.vec2(0,0);if(O>B*1.2?D=_.unit().scale(a.speed*e.dt()):O<B*.8&&(D=_.unit().scale(-a.speed*e.dt())),O>0&&a.attackTimer>=1/a.fireRate){const q=_.unit(),G=Qn(e,a.pos.x,a.pos.y,q,a.projectileSpeed,a.projectileDamage,0,0,!1);G.isEnemyProjectile=!0,G.color=e.rgb(...a.originalColor),a.attackTimer=0}if(D.len()>0){const q=b(D);a.pos.x+=q.x,a.pos.y+=q.y;const G=20,Z=a.size||12;a.pos.x=e.clamp(a.pos.x,G+Z,e.width()-G-Z),a.pos.y=e.clamp(a.pos.y,G+Z,e.height()-G-Z)}return}if(a.behavior==="charge"){if(a.chargeTimer+=e.dt(),a.isCharging)if(a.chargeDuration+=e.dt(),a.chargeDuration>=.8)a.isCharging=!1,a.chargeDuration=0,a.chargePauseTimer=0;else{const D=a.chargeDirection.scale(a.speed*e.dt()),q=b(D);q.len()<D.len()*.3?(a.isCharging=!1,a.chargePauseTimer=.1):(a.pos.x+=q.x,a.pos.y+=q.y)}else if(a.chargePauseTimer>0)a.chargePauseTimer+=e.dt(),a.chargePauseTimer>=1&&(a.chargePauseTimer=0,a.chargeTimer=0);else if(a.chargeTimer>=a.chargeCooldown)a.color=e.rgb(255,255,0),e.wait(.2,()=>{a.exists()&&(a.color=e.rgb(...a.originalColor),O>0&&(a.isCharging=!0,a.chargeDirection=_.unit(),a.chargeDuration=0))}),a.chargeTimer=0;else{const D=_.unit().scale(a.speed*.5*e.dt()),q=b(D);q.len()<D.len()*.5&&a.isCharging&&(a.isCharging=!1,a.chargePauseTimer=.1),a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="erratic"){if(O>0){const B=_.unit(),D=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),G=e.vec2(B.x+D.x,B.y+D.y).unit().scale(a.speed*e.dt()),Z=b(G);a.pos.x+=Z.x,a.pos.y+=Z.y}return}if(a.behavior==="shield"){if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="teleport"){if(a.teleportTimer+=e.dt(),a.teleportTimer>=a.teleportCooldown&&O>0){const B=_.unit(),D=e.vec2(a.pos.x+B.x*a.teleportRange,a.pos.y+B.y*a.teleportRange);N(D.x,D.y)&&(a.pos.x=D.x,a.pos.y=D.y,a.teleportTimer=0,a.color=e.rgb(255,255,255),e.wait(.1,()=>{a.exists()&&(a.color=e.rgb(...a.originalColor))}))}else if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="spawner"){if(a.spawnTimer+=e.dt(),a.spawnTimer>=a.spawnInterval){const B=Math.random()*Math.PI*2,D=30,q=a.pos.x+Math.cos(B)*D,G=a.pos.y+Math.sin(B)*D;if(N(q,G)){const Z=mi(e,q,G,a.spawnType||"rusher",a.floor);Z.isBossMinion=!0,a.spawnTimer=0}}if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="buffer"){if(a.attackTimer+=e.dt(),a.attackTimer>=1){const B=e.get("enemy");for(const D of B){if(!D.exists()||D===a)continue;e.vec2(D.pos.x-a.pos.x,D.pos.y-a.pos.y).len()<=a.buffRadius?(D.buffed||(D.buffed=!0,D.originalSpeed=D.speed,D.originalDamage=D.damage||10),D.speed=D.originalSpeed*(1+a.buffAmount),D.damage=D.originalDamage*(1+a.buffAmount),a.buffedEnemies.add(D)):a.buffedEnemies.has(D)&&(D.buffed&&(D.speed=D.originalSpeed,D.damage=D.originalDamage,D.buffed=!1),a.buffedEnemies.delete(D))}a.attackTimer=0}if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="healer"){if(a.healTimer+=e.dt(),a.healTimer>=a.healInterval){const B=e.get("enemy");for(const D of B){if(!D.exists()||D===a)continue;if(e.vec2(D.pos.x-a.pos.x,D.pos.y-a.pos.y).len()<=a.healRadius){const Z=D.hp(),le=D.maxHealth;if(Z<le){const ie=Math.min(le,Z+a.healAmount);D.setHP(ie);const oe=e.add([e.text("+",{size:16}),e.pos(D.pos.x,D.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{oe.exists()&&e.destroy(oe)})}}}a.healTimer=0}if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="teleportPlayer"){if(a.teleportTimer+=e.dt(),a.teleportTimer>=a.teleportCooldown&&O<=80){const B=Math.random()*Math.PI*2,D=x.pos.x+Math.cos(B)*a.teleportRange,q=x.pos.y+Math.sin(B)*a.teleportRange,G=Math.max(50,Math.min(e.width()-50,D)),Z=Math.max(50,Math.min(e.height()-50,q));x.pos.x=G,x.pos.y=Z,a.teleportTimer=0;const le=e.add([e.text("!",{size:24}),e.pos(x.pos.x,x.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{le.exists()&&e.destroy(le)})}if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="freeze"){if(O<=a.slowRadius?(x.slowed||(x.slowed=!0,x.originalSpeed=x.speed),x.speed=x.originalSpeed*(1-a.slowAmount)):x.slowed&&(x.speed=x.originalSpeed,x.slowed=!1),O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="phase"){if(O>0){const B=_.unit();a.pos.x+=B.x*a.speed*e.dt(),a.pos.y+=B.y*a.speed*e.dt();const D=e.width(),q=e.height(),G=20,Z=a.size||12;a.pos.x=e.clamp(a.pos.x,G+Z,D-G-Z),a.pos.y=e.clamp(a.pos.y,G+Z,q-G-Z)}return}if(a.behavior==="mimic"){if(a.mimicTimer+=e.dt(),a.isMimicking)if(a.mimicMoveIndex<a.mimicMovementHistory.length){const B=a.mimicMovementHistory[a.mimicMoveIndex],D=e.vec2(B.x*e.dt()*60,B.y*e.dt()*60),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y,a.mimicMoveIndex++}else a.isMimicking=!1,a.mimicTimer=0,a.mimicMovementHistory=[],a.mimicMoveIndex=0;else if(a.mimicTimer<a.mimicDuration){if(x.move&&(x.move.x!==0||x.move.y!==0)&&a.mimicMovementHistory.push({x:x.move.x,y:x.move.y}),O>0){const D=_.unit().scale(a.speed*.5*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}}else if(a.mimicTimer>=a.mimicCooldown)if(a.mimicMovementHistory.length>0)a.isMimicking=!0,a.mimicMoveIndex=0,a.color=e.rgb(255,255,255),e.wait(.15,()=>{a.exists()&&(a.color=e.rgb(...a.originalColor))});else{if(O>0){const D=_.unit().scale(a.speed*1.5*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}a.mimicTimer=0}else if(O>0){const D=_.unit().scale(a.speed*e.dt()),q=b(D);a.pos.x+=q.x,a.pos.y+=q.y}return}if(a.behavior==="bomber"){if(a.attackTimer+=e.dt(),O>0&&a.attackTimer>=1/a.fireRate){const B=_.unit(),D=Qn(e,a.pos.x,a.pos.y,B,a.projectileSpeed,a.projectileDamage,0,0,!1);D.isEnemyProjectile=!0,D.isBomb=!0,D.homingStrength=a.homingStrength,D.bombExplosionRadius=a.bombExplosionRadius,D.targetPlayer=x,D.color=e.rgb(255,100,0),D.text="",D.onUpdate(()=>{if(D.targetPlayer&&D.targetPlayer.exists()&&!D.targetPlayer.isDead){const q=e.vec2(D.targetPlayer.pos.x-D.pos.x,D.targetPlayer.pos.y-D.pos.y),G=q.len()>0?q.unit():e.vec2(0,0);D.direction=e.vec2(D.direction.x+(G.x-D.direction.x)*D.homingStrength*e.dt(),D.direction.y+(G.y-D.direction.y)*D.homingStrength*e.dt()).unit()}}),a.attackTimer=0}return}if(a.behavior==="rush"&&O>0){let B;if(a.pathfindingMode==="smart")B=dA(e,a,x.pos.x,x.pos.y);else{const q=_.unit().scale(a.speed*e.dt());B=b(q).unit()}a.pos.x+=B.x*a.speed*e.dt(),a.pos.y+=B.y*a.speed*e.dt()}if(a.behavior==="perimeter"){const B=hA(e,a);a.pos.x+=B.x*a.speed*e.dt(),a.pos.y+=B.y*a.speed*e.dt()}const P=e.width(),z=e.height(),U=20,F=a.size||12;a.pos.x=e.clamp(a.pos.x,U+F,P-U-F),a.pos.y=e.clamp(a.pos.y,U+F,z-U-F)}),a.isDead=!1,a.onDeath(()=>{if(a.behavior==="buffer"&&a.buffedEnemies)for(const T of a.buffedEnemies)T.exists()&&T.buffed&&(T.speed=T.originalSpeed,T.damage=T.originalDamage,T.buffed=!1)}),a.onDeath(()=>{if(de()&&ve()&&a.mpEntityId&&Vh({entityId:a.mpEntityId,entityType:"enemy",x:a.pos.x,y:a.pos.y,xpDropped:a.xpValue}),a.splits&&a.hp()<=0){if(de()&&!ve())return;const T=a.splitCount||2,x=a.splitType||"slime";for(let M=0;M<T;M++){const _=Math.PI*2/T*M,O=20,P=a.pos.x+Math.cos(_)*O,z=a.pos.y+Math.sin(_)*O,U=mi(e,P,z,x,a.floor);U.maxHealth=Math.max(10,Math.floor(U.maxHealth/2)),U.setHP(U.maxHealth),U.size=Math.max(8,Math.floor(U.size*.8)),U.splits=!1,U.isSplitEnemy=!0,de()&&ve()&&fo&&fo(U,{maxHealth:U.maxHealth,floor:a.floor})}e.gameData&&e.gameData.incrementSplitEnemies&&e.gameData.incrementSplitEnemies(T),de()&&ve()&&Z_(T)}if(a.explodes&&a.hp()<=0){(!de()||ve())&&e.get("player").forEach(M=>{if(M&&M.exists()&&!M.isDead&&e.vec2(M.pos.x-a.pos.x,M.pos.y-a.pos.y).len()<=a.explosionRadius&&!M.invulnerable){const P=Math.max(1,a.explosionDamage-(M.defense||0));M.hurt(P),M.invulnerable=!0,M.invulnerableTime=M.invulnerableDuration,M.color=e.rgb(255,100,100)}});const T=e.add([e.text("*",{size:24}),e.pos(a.pos.x,a.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{T.exists()&&e.destroy(T)})}}),de()&&ve()&&(fo(a,{type:o,floor:i}),a.enemyType=o),a}const ki={brute:{name:"Security Chief",coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{name:"Technical Director",coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{name:"Stunt Coordinator",coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{name:"Studio Manager",coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{name:"Creative Director",coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function uA(e){return ki[e]||ki.brute}function fA(e,t,n,o="brute",i=1){const s=uA(o),r=1+(i-1)*.2,l={coreChar:s.coreChar,armorChar:s.armorChar||"[]",shieldChar:s.shieldChar||"{}",color:s.color,armorColor:s.armorColor||[200,200,200],shieldColor:s.shieldColor||[100,200,255],health:Math.floor(s.baseHealth*r),armorHealth:Math.floor((s.baseArmorHealth||0)*r),maxArmorHealth:Math.floor((s.baseArmorHealth||0)*r),shieldHealth:Math.floor((s.baseShieldHealth||0)*r),maxShieldHealth:Math.floor((s.baseShieldHealth||0)*r),speed:Math.floor(s.baseSpeed*(1+(i-1)*.05)),size:s.size,xpValue:Math.floor(s.baseXPValue*r),damageReduction:s.damageReduction||0,shieldRegenRate:(s.shieldRegenRate||0)*r},c=e.add([e.text(l.coreChar,{size:l.size}),e.pos(t,n),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"miniboss"]);return c.maxHealth=l.health,c.speed=l.speed,c.xpValue=l.xpValue,c.type=o,c.floor=i,s.meleeDamage&&(c.meleeDamage=s.meleeDamage),s.projectileDamage&&(c.projectileDamage=s.projectileDamage),s.projectileSpeed&&(c.projectileSpeed=s.projectileSpeed),s.fireRate&&(c.fireRate=s.fireRate),c.armorHealth=l.armorHealth,c.maxArmorHealth=l.maxArmorHealth,c.damageReduction=l.damageReduction,c.coreChar=l.coreChar,c.armorChar=l.armorChar,c.armorColor=l.armorColor,c.shieldHealth=l.shieldHealth,c.maxShieldHealth=l.maxShieldHealth,c.shieldRegenRate=l.shieldRegenRate,c.shieldChar=l.shieldChar,c.shieldColor=l.shieldColor,c.shieldRegenTimer=0,c.shieldRegenCooldown=0,c.lastDamageTime=0,c.attackTimer=0,c.chargeCooldownTimer=0,c.chargeDurationTimer=0,c.isCharging=!1,c.chargeDirection=null,c.chargeSpeed=0,c.updateVisual=function(){let d="",a="",h="",u="";if(c.shieldHealth>0){const g=c.shieldHealth/c.maxShieldHealth;g>.66?(d="",a=""):g>.33?(d="",a=""):(d="",a="")}if(c.armorHealth>0){const g=c.armorHealth/c.maxArmorHealth;g>.66?(h="",u=""):g>.33?(h="",u=""):(h="",u="")}const p=`${d}${h}${c.coreChar}${u}${a}`;c.text=p,c.shieldHealth>0?c.color=e.rgb(...l.shieldColor):c.color=e.rgb(...l.color)},c.takeDamage=function(d){let a=!1,h=!1;const u=c.shieldHealth,p=c.armorHealth;c.lastDamageTime=e.time();const g=3;if(c.shieldRegenCooldown=g,c.shieldHealth>0){const A=Math.min(d,c.shieldHealth);c.shieldHealth=Math.max(0,c.shieldHealth-A),a=c.shieldHealth!==u;const m=d-A;m>0&&c.takeDamageInternal(m)}else c.takeDamageInternal(d);h=c.armorHealth!==p,(a||h)&&c.updateVisual()},c.takeDamageInternal=function(d){if(c.armorHealth>0){const a=Math.floor(d*(1-c.damageReduction)),h=Math.min(a,c.armorHealth);c.armorHealth=Math.max(0,c.armorHealth-h);const u=d-a;if(u>0){const p=c.armorHealth>0?1-c.damageReduction:1,g=Math.floor(u*p);c.hurt(g)}}else c.hurt(d)},c.startCharge=function(d){if(!c.exists())return;c.isCharging=!0;const a=e.vec2(d.x-c.pos.x,d.y-c.pos.y);a.len()>0&&(c.chargeDirection=a.unit(),c.chargeSpeed=c.speed*2.5)},c.onUpdate(()=>{if(e.paused)return;if(c.shieldRegenRate>0&&c.shieldHealth<c.maxShieldHealth&&c.hp()>0&&!c.isDead&&(c.shieldRegenCooldown>0&&(c.shieldRegenCooldown-=e.dt()),c.shieldRegenCooldown<=0)){c.shieldRegenTimer+=e.dt();const m=1;if(c.shieldRegenTimer>=m){const C=c.shieldRegenRate*m;c.shieldHealth=Math.min(c.maxShieldHealth,c.shieldHealth+C),c.shieldRegenTimer=0,c.shieldHealth>0&&c.updateVisual()}}c.burnDuration>0&&c.hp()>0&&!c.isDead&&(c.burnTimer=(c.burnTimer||0)+e.dt(),c.burnTimer>=.5&&((!de()||ve())&&(c.takeDamage?c.takeDamage(c.burnDamage):c.hurt(c.burnDamage)),c.color,c.color=e.rgb(255,150,50),e.wait(.1,()=>{c.exists()&&c.updateVisual()}),c.burnTimer=0),c.burnDuration-=e.dt(),c.burnDuration<=0&&(c.burnDamage=0,c.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const a=e.vec2(d.pos.x-c.pos.x,d.pos.y-c.pos.y),h=a.len();if(s.behavior==="charge"){c.attackTimer+=e.dt(),c.chargeCooldownTimer+=e.dt();const m=6,C=200;if(c.isCharging){const I=c.chargeDirection.scale(c.chargeSpeed*e.dt());c.pos.x+=I.x,c.pos.y+=I.y,c.chargeDurationTimer+=e.dt(),c.chargeDurationTimer>=1&&(c.isCharging=!1,c.chargeDurationTimer=0,c.chargeCooldownTimer=0)}else{if(h>0){const R=a.unit().scale(c.speed*e.dt());c.pos.x+=R.x,c.pos.y+=R.y}c.chargeCooldownTimer>=m&&h<C&&(c.color=e.rgb(255,255,0),e.wait(.3,()=>{c.exists()&&(c.color=e.rgb(...l.color),c.startCharge(d.pos))}),c.chargeCooldownTimer=0)}}else if(s.behavior==="shoot"){c.attackTimer+=e.dt();const m=180;if(h>0){const I=a.unit();let R=c.speed;if(h<m){const f=I.scale(-R*e.dt());c.pos.x+=f.x,c.pos.y+=f.y}else if(h>m*1.5){const f=I.scale(R*e.dt());c.pos.x+=f.x,c.pos.y+=f.y}}const C=1/c.fireRate;if(c.attackTimer>=C){if(h>0){const I=a.unit(),R=Qn(e,c.pos.x,c.pos.y,I,c.projectileSpeed,c.projectileDamage,0,0,!1);R.isBossProjectile=!0,R.color=e.rgb(...l.color)}c.attackTimer=0}}else if(s.behavior==="rush"&&h>0){const C=a.unit().scale(c.speed*e.dt());c.pos.x+=C.x,c.pos.y+=C.y}const u=e.width(),p=e.height(),g=20,A=c.size||24;c.pos.x=e.clamp(c.pos.x,g+A,u-g-A),c.pos.y=e.clamp(c.pos.y,g+A,p-g-A)}),c.isDead=!1,c.updateVisual(),c}function pA(e,t,n,o){const i=e.add([e.rect(40,40),e.pos(t,n),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return i.direction=o,i.open=!1,i.isSpawnDoor=!1,i.blocked=!1,i.gridDirection=null,i.parts=[],i.updateVisual=()=>{i.parts.forEach(r=>{r.exists()&&e.destroy(r)}),i.parts=[];let s;if(i.blocked?s=e.rgb(80,80,80):i.open?s=e.rgb(100,255,100):i.isSpawnDoor?s=e.rgb(200,50,50):s=e.rgb(200,200,100),o==="north"||o==="south"){const r=i.blocked?"":i.open?"":"",l=e.add([e.text(r,{size:24}),e.pos(t,n),e.anchor("center"),e.color(s),e.fixed(),e.z(100)]);i.parts.push(l);const c=e.add([e.text(i.open?"":"",{size:20}),e.pos(t-35,n),e.anchor("center"),e.color(s),e.fixed(),e.z(100)]);i.parts.push(c);const d=e.add([e.text(i.open?"":"",{size:20}),e.pos(t+35,n),e.anchor("center"),e.color(s),e.fixed(),e.z(100)]);i.parts.push(d)}else{const r=i.blocked?["","",""]:i.open?["","",""]:["","",""],l=16;for(let a=0;a<r.length;a++){const h=(a-1)*l,u=e.add([e.text(r[a],{size:24}),e.pos(t,n+h),e.anchor("center"),e.color(s),e.fixed(),e.z(100)]);i.parts.push(u)}const c=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,n-l*1.5),e.anchor("center"),e.color(s),e.fixed(),e.z(100)]);i.parts.push(c);const d=e.add([e.text(i.open?"":"",{size:20}),e.pos(t,n+l*1.5),e.anchor("center"),e.color(s),e.fixed(),e.z(100)]);i.parts.push(d)}if(i.blocked){const r=e.add([e.text("X",{size:28}),e.pos(t,n),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);i.parts.push(r)}},Object.defineProperty(i,"color",{get:()=>i._color,set:s=>{i._color=s,i.parts.forEach(r=>{r.exists()&&(r.color=s)})}}),Object.defineProperty(i,"text",{get:()=>i._text||"=",set:s=>{i._text=s}}),i.onDestroy(()=>{i.parts.forEach(s=>{s.exists()&&e.destroy(s)}),i.parts=[]}),i.updateVisual(),i}function op(e,t,n,o,i,s="wall",r="#",l=null){const c=s==="wall",d=c?e.rgb(100,100,100):e.rgb(140,140,140),a=c?e.rgb(80,80,80):e.rgb(120,120,120),h=e.add([e.rect(o,i),e.pos(t,n),e.anchor("center"),e.color(l||d),e.outline(2,l||a),e.area({width:o,height:i}),e.fixed(),"obstacle",s==="wall"?"wall":"cover"]);return h.type=s,h.width=o,h.height=i,h}const gA={CHAR:"",SIZE:20,COLOR:[180,80,40],DAMAGED_COLOR:[220,100,30],CRITICAL_COLOR:[255,60,20],MAX_HEALTH:3,EXPLOSION_RADIUS:80,EXPLOSION_DAMAGE:25,CHAIN_DELAY:.15,KNOCKBACK_FORCE:200,SHAKE_INTENSITY:.5,EXPLOSION_DURATION:.3};let Fi=[];function mA(e,t,n,o={}){const i={...gA,...o},s=e.add([e.text(i.CHAR,{size:i.SIZE}),e.pos(t,n),e.anchor("center"),e.area({width:i.SIZE,height:i.SIZE}),e.color(...i.COLOR),e.z(50),e.opacity(1),"barrel","obstacle",{maxHealth:i.MAX_HEALTH,currentHealth:i.MAX_HEALTH,explosionRadius:i.EXPLOSION_RADIUS,explosionDamage:i.EXPLOSION_DAMAGE,chainDelay:i.CHAIN_DELAY,knockbackForce:i.KNOCKBACK_FORCE,isExploding:!1,barrelId:Math.random().toString(36).substr(2,9)}]),r=e.add([e.rect(24,4),e.pos(t,n-18),e.anchor("center"),e.color(40,40,40),e.z(51),"barrelHealthBar"]),l=e.add([e.rect(22,2),e.pos(t-11,n-18),e.anchor("left"),e.color(255,100,50),e.z(52),"barrelHealthBar"]);return s.healthBarBg=r,s.healthBarFill=l,s.updateHealthBar=()=>{if(!s.exists())return;const c=s.currentHealth/s.maxHealth;r.exists()&&(r.pos.x=s.pos.x,r.pos.y=s.pos.y-18),l.exists()&&(l.pos.x=s.pos.x-11,l.pos.y=s.pos.y-18,l.width=22*c,c<=.33?l.color=e.rgb(255,50,50):c<=.66&&(l.color=e.rgb(255,150,50))),c<=.33?(s.color=e.rgb(...i.CRITICAL_COLOR),s.pos.x+=(Math.random()-.5)*2,s.pos.y+=(Math.random()-.5)*2):c<=.66&&(s.color=e.rgb(...i.DAMAGED_COLOR))},s.takeDamage=(c=1,d=null,a=!1)=>{s.isExploding||!s.exists()||(s.currentHealth-=c,s.updateHealthBar(),!a&&de()&&ve()&&Je("barrel_damage",{x:s.pos.x,y:s.pos.y,damage:c,currentHealth:s.currentHealth}),s.color,s.color=e.rgb(255,255,255),e.wait(.05,()=>{s.exists()&&s.updateHealthBar()}),s.currentHealth<=0&&s.explode(d))},s.explode=(c=null)=>{if(s.isExploding||!s.exists())return;s.isExploding=!0;const d=s.pos.x,a=s.pos.y;de()&&ve()&&Je("barrel_explode",{barrelId:s.barrelId,x:d,y:a,radius:s.explosionRadius,damage:s.explosionDamage}),yA(e,d,a,s.explosionRadius),xA(e,d,a,s.explosionRadius,s.explosionDamage,s.knockbackForce),e.wait(s.chainDelay,()=>{vA(e,d,a,s.explosionRadius,s.barrelId)}),r.exists()&&e.destroy(r),l.exists()&&e.destroy(l),Fi=Fi.filter(h=>h!==s),e.destroy(s)},Fi.push(s),s}function yA(e,t,n,o){const i=e.add([e.circle(o),e.pos(t,n),e.anchor("center"),e.color(255,150,50),e.opacity(.8),e.scale(1),e.z(100),"explosionEffect"]),s=e.add([e.circle(o*.6),e.pos(t,n),e.anchor("center"),e.color(255,255,150),e.opacity(.9),e.scale(1),e.z(101),"explosionEffect"]),r=e.add([e.text("*",{size:40}),e.pos(t,n),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.scale(1),e.z(102),"explosionEffect"]);e.tween(i.scale,e.vec2(1.5,1.5),.2,l=>i.scale=l),e.tween(i.opacity,0,.3,l=>i.opacity=l,e.easings.easeOutQuad).onEnd(()=>{i.exists()&&e.destroy(i)}),e.tween(s.scale,e.vec2(1.3,1.3),.15,l=>s.scale=l),e.tween(s.opacity,0,.25,l=>s.opacity=l,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)}),e.tween(r.scale,e.vec2(2,2),.1,l=>r.scale=l),e.tween(r.opacity,0,.2,l=>r.opacity=l).onEnd(()=>{r.exists()&&e.destroy(r)});for(let l=0;l<8;l++){const c=Math.PI*2*l/8,d=100+Math.random()*100,a=e.add([e.text(["#","*","+","~"][Math.floor(Math.random()*4)],{size:12}),e.pos(t,n),e.anchor("center"),e.color(255,150+Math.random()*100,50),e.opacity(1),e.z(99),"explosionDebris"]),h=t+Math.cos(c)*d,u=n+Math.sin(c)*d;e.tween(a.pos,e.vec2(h,u),.4,p=>a.pos=p,e.easings.easeOutQuad),e.tween(a.opacity,0,.4,p=>a.opacity=p).onEnd(()=>{a.exists()&&e.destroy(a)})}}function xA(e,t,n,o,i,s,r){e.get("enemy").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-n).len();if(c<=o){const d=1-c/o*.5,a=Math.floor(i*d);if(l.takeDamage?l.takeDamage(a):l.hp&&l.hurt(a),c>0){const h=e.vec2(l.pos.x-t,l.pos.y-n).unit(),u=s*d;l.pos.x+=h.x*u*.1,l.pos.y+=h.y*u*.1}}}),e.get("miniboss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-n).len();if(c<=o){const d=1-c/o*.5,a=Math.floor(i*d);l.takeDamage&&l.takeDamage(a,null)}}),e.get("boss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-n).len();if(c<=o){const d=1-c/o*.5,a=Math.floor(i*d);l.takeDamage&&l.takeDamage(a,null)}}),e.get("player").forEach(l=>{if(!l.exists()||l.isDead)return;const c=e.vec2(l.pos.x-t,l.pos.y-n).len();if(c<=o){const d=1-c/o*.5,a=Math.floor(i*d*.5);if(!l.invulnerable&&(l.hurt(a),c>0)){const h=e.vec2(l.pos.x-t,l.pos.y-n).unit(),u=s*d;l.pos.x+=h.x*u*.05,l.pos.y+=h.y*u*.05}}})}function vA(e,t,n,o,i){const s=o*1.2;Fi.forEach(r=>{if(!r.exists()||r.isExploding||r.barrelId===i)return;e.vec2(r.pos.x-t,r.pos.y-n).len()<=s&&r.takeDamage(r.maxHealth,i)})}function ip(e,t,n=5){return Fi.find(o=>{if(!o.exists()||o.isExploding)return!1;const i=Math.abs(o.pos.x-e),s=Math.abs(o.pos.y-t);return i<=n&&s<=n})||null}function wA(){Fi.forEach(e=>{e.exists()&&(e.healthBarBg&&e.healthBarBg.exists()&&e.healthBarBg.destroy(),e.healthBarFill&&e.healthBarFill.exists()&&e.healthBarFill.destroy(),e.destroy())}),Fi=[]}class xc{constructor(t=128){this.cellSize=t,this.cells=new Map,this.entityToCell=new Map}getCellKey(t,n){const o=Math.floor(t/this.cellSize),i=Math.floor(n/this.cellSize);return`${o},${i}`}insert(t){if(!t||!t.pos)return;const n=this.getCellKey(t.pos.x,t.pos.y);this.cells.has(n)||this.cells.set(n,new Set),this.cells.get(n).add(t),this.entityToCell.set(t,n)}remove(t){if(!t)return;const n=this.entityToCell.get(t);if(!n)return;const o=this.cells.get(n);o&&(o.delete(t),o.size===0&&this.cells.delete(n)),this.entityToCell.delete(t)}update(t){if(!t||!t.pos)return;const n=this.entityToCell.get(t),o=this.getCellKey(t.pos.x,t.pos.y);n!==o&&(this.remove(t),this.insert(t))}getNearby(t,n,o){const i=[],s=Math.ceil(o/this.cellSize),r=this.getCellKey(t,n),[l,c]=r.split(",").map(Number);for(let d=-s;d<=s;d++)for(let a=-s;a<=s;a++){const h=`${l+d},${c+a}`,u=this.cells.get(h);u&&i.push(...u)}return i}getInBounds(t,n,o,i){const s=[],r=Math.floor(t/this.cellSize),l=Math.floor(n/this.cellSize),c=Math.floor(o/this.cellSize),d=Math.floor(i/this.cellSize);for(let a=r;a<=c;a++)for(let h=l;h<=d;h++){const u=`${a},${h}`,p=this.cells.get(u);p&&s.push(...p)}return s}getAt(t,n){const o=this.getCellKey(t,n),i=this.cells.get(o);return i?[...i]:[]}clear(){this.cells.clear(),this.entityToCell.clear()}getStats(){let t=0,n=0,o=1/0;return this.cells.forEach(i=>{const s=i.size;t+=s,n=Math.max(n,s),o=Math.min(o,s)}),{cellCount:this.cells.size,totalEntities:t,averageEntitiesPerCell:this.cells.size>0?(t/this.cells.size).toFixed(2):0,maxEntitiesInCell:n,minEntitiesInCell:o===1/0?0:o,cellSize:this.cellSize}}}let go=null,Ns=1,gl=1,Wh=1,Xm=!0,$h=!0,zn=null,Sd=null;const bA={menu:"./audio/menu-theme.mp3",combat:"./audio/combat-theme.mp3",defeat:"./audio/defeat-theme.mp3"},vc={};function qm(){return go||(go=new(window.AudioContext||window.webkitAudioContext)),go}function EA(){go&&go.state==="suspended"&&go.resume().then(()=>{console.log("[Audio] AudioContext resumed")}).catch(e=>{console.warn("[Audio] Failed to resume AudioContext:",e)})}function jh(){return go||qm(),go&&go.state==="suspended"&&go.resume(),go}function Ym(e){Ns=Math.max(0,Math.min(1,e)),zn&&(zn.volume=gl*Ns)}function Gm(e){Wh=Math.max(0,Math.min(1,e))}function Km(e){Xm=e}function Vm(e){$h=e}function et(e,t,n="square",o=.3,i={}){if(i.isUI&&!Xm||i.isCombat&&!$h)return;const s=jh(),r=s.currentTime,l=s.createOscillator();l.type=n,l.frequency.setValueAtTime(e,r),i.pitchBend&&l.frequency.exponentialRampToValueAtTime(e*i.pitchBend,r+t);const c=s.createGain(),d=o*Wh*Ns,a=i.attack||.01;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(d,r+a);const h=i.decay||.1;c.gain.setValueAtTime(d,r+t-h),c.gain.exponentialRampToValueAtTime(.01,r+t),l.connect(c),c.connect(s.destination),l.start(r),l.stop(r+t)}function Ks(e,t=.3,n={}){if(n.isCombat&&!$h)return;const o=jh(),i=o.currentTime,s=o.sampleRate*e,r=o.createBuffer(1,s,o.sampleRate),l=r.getChannelData(0);for(let g=0;g<s;g++)l[g]=Math.random()*2-1;const c=o.createBufferSource();c.buffer=r;const d=o.createBiquadFilter();d.type=n.filterType||"lowpass",d.frequency.setValueAtTime(n.filterFreq||2e3,i);const a=o.createGain(),h=t*Wh*Ns,u=n.attack||.01,p=n.decay||.1;a.gain.setValueAtTime(0,i),a.gain.linearRampToValueAtTime(h,i+u),a.gain.setValueAtTime(h,i+e-p),a.gain.exponentialRampToValueAtTime(.01,i+e),c.connect(d),d.connect(a),a.connect(o.destination),c.start(i),c.stop(i+e)}function Fe(e,t=.1){return e*(1+(Math.random()-.5)*t)}function Wm(){const e=Math.random();e<.33?et(Fe(280,.15),.08,"triangle",.14,{attack:.002,decay:.05,pitchBend:.65}):e<.66?et(Fe(320,.15),.09,"sine",.13,{attack:.003,decay:.06,pitchBend:.7}):et(Fe(300,.15),.07,"triangle",.14,{attack:.002,decay:.04,pitchBend:.6})}function SA(){const e=Math.random();e<.33?et(Fe(220,.3),.04,"triangle",.08,{attack:.001,decay:.025,pitchBend:.5}):e<.66?et(Fe(240,.3),.035,"sine",.09,{attack:.001,decay:.02,pitchBend:.6}):et(Fe(200,.3),.045,"triangle",.08,{attack:.001,decay:.03,pitchBend:.4})}function CA(){const e=Fe(60,.15);et(e,.1,"sine",.12,{attack:.002,decay:.08,pitchBend:.4}),Ks(Fe(.04,.2),Fe(.12,.2),{attack:.002,decay:.06,filterType:"lowpass",filterFreq:Fe(800,.3)})}function _A(){et(Fe(350,.2),.05,"triangle",.12,{attack:.001,decay:.03,pitchBend:.3}),et(Fe(50,.15),.1,"sine",.1,{attack:.001,decay:.07,pitchBend:.5})}function AA(){Ks(.08,Fe(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:Fe(800,.5)})}function TA(){et(Fe(55,.2),.15,"sine",.1,{attack:.002,decay:.12,pitchBend:.4}),et(Fe(100,.2),.12,"triangle",.08,{attack:.005,decay:.08,pitchBend:.5})}function MA(){et(Fe(250,.3),.08,"triangle",.1,{attack:.001,decay:.06,pitchBend:1.6}),Ks(Fe(.03,.3),.08,{attack:.001,decay:.04,filterType:"bandpass",filterFreq:Fe(2e3,.4)})}function RA(){et(Fe(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function DA(){Wm()}function sp(){const e=Math.random();e<.25?et(Fe(280,.2),.06,"sine",.12,{attack:.002,decay:.04,pitchBend:.2}):e<.5?et(Fe(320,.2),.05,"triangle",.12,{attack:.002,decay:.035,pitchBend:.15}):e<.75?et(Fe(240,.2),.07,"sine",.14,{attack:.003,decay:.05,pitchBend:.25}):et(Fe(360,.2),.05,"triangle",.1,{attack:.002,decay:.03,pitchBend:.1})}function oi(){const e=Math.random();e<.33?(et(Fe(180,.2),.1,"triangle",.18,{attack:.003,decay:.07,pitchBend:.2}),et(Fe(400,.2),.06,"sine",.1,{attack:.005,decay:.04,pitchBend:.1})):e<.66?(et(Fe(160,.2),.12,"triangle",.18,{attack:.003,decay:.08,pitchBend:.25}),et(Fe(320,.2),.07,"sine",.12,{attack:.005,decay:.05,pitchBend:.15})):(et(Fe(200,.2),.11,"triangle",.18,{attack:.003,decay:.08,pitchBend:.3}),et(Fe(440,.2),.05,"sine",.08,{attack:.005,decay:.03,pitchBend:.1}))}function rp(){const e=Math.random();e<.33?et(Fe(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(et(Fe(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),Ks(.15,.12,{attack:.05,decay:.1,filterFreq:Fe(1500,.4)})):et(Fe(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function $m(){et(Fe(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),et(Fe(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),Ks(Fe(.3,.2),Fe(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:Fe(1200,.5)})}function IA(){const e=Math.random();e<.33?et(Fe(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?et(Fe(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):et(Fe(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function ap(){const e=Math.random();e<.33?(et(Fe(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{et(Fe(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(et(Fe(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),et(Fe(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(et(Fe(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{et(Fe(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function PA(){jh().currentTime;const t=400;[1,1.25,1.5,2].forEach((o,i)=>{setTimeout(()=>{et(t*o,.15,"square",.2,{attack:.01,decay:.1})},i*80)})}function wc(){et(Fe(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Gt(){et(Fe(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function tt(){et(Fe(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function LA(){et(Fe(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{et(Fe(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function lp(){et(Fe(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{et(Fe(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function OA(){for(let t=0;t<8;t++)setTimeout(()=>{et(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{$m()},480)}function NA(){[400,500,600,800].forEach((t,n)=>{setTimeout(()=>{et(t,.2,"square",.18,{attack:.01,decay:.15})},n*100)})}function xa(){et(Fe(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{et(Fe(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function bc(){et(Fe(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),Ks(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:Fe(500,.3)})}function BA(){et(Fe(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function cp(){et(Fe(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function HA(e){const t=e?.toLowerCase()||"";t.includes("pistol")?Wm():t.includes("smg")||t.includes("submachine")?SA():t.includes("shotgun")?CA():t.includes("sniper")||t.includes("rifle")?_A():t.includes("flame")||t.includes("thrower")?AA():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?TA():t.includes("chain")||t.includes("lightning")?MA():t.includes("orbital")?RA():DA()}function jm(e){gl=Math.max(0,Math.min(1,e)),zn&&(zn.volume=gl*Ns)}function Jm(){zn&&(zn.pause(),zn.currentTime=0,zn=null,Sd=null)}function Jh(e,t=!0){if(Sd===e&&zn&&!zn.paused)return;Jm();const n=bA[e];if(!n){console.warn(`[Music] Unknown track: ${e}`);return}try{vc[e]||(vc[e]=new Audio(n)),zn=vc[e],zn.loop=t,zn.volume=gl*Ns,Sd=e;const o=zn.play();o!==void 0&&o.catch(i=>{console.warn(`[Music] Playback failed for ${e}:`,i.message)})}catch(o){console.warn(`[Music] Failed to play ${e}:`,o.message)}}function dp(){Jh("menu")}function zA(){Jh("combat")}function UA(){Jh("defeat")}const Qm="superSmashTexty_settings",$r={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:.35,uiSounds:!0,combatSounds:!0},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showHitFreeze:!0,showDamageNumbers:!0,compactHUD:!1,showFPS:!1,showTimer:!0},gameplay:{autoPause:!1,autoPickupCurrency:!1,autoPickupXP:!1,confirmBeforeQuit:!0,skipIntroAnimation:!1},accessibility:{colorblindMode:"off",reducedMotion:!1,largeText:!1,highContrast:!1}};function Qh(){try{const e=localStorage.getItem(Qm);if(e){const t=JSON.parse(e);return Zm($r,t)}}catch(e){console.error("Error loading settings:",e)}return{...$r}}function Zm(e,t){const n={...e};return Ec(e)&&Ec(t)&&Object.keys(t).forEach(o=>{Ec(t[o])?o in e?n[o]=Zm(e[o],t[o]):Object.assign(n,{[o]:t[o]}):Object.assign(n,{[o]:t[o]})}),n}function Ec(e){return e&&typeof e=="object"&&!Array.isArray(e)}function km(e){try{return localStorage.setItem(Qm,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function Cd(){return Qh()}function Cn(e,t,n){const o=Qh();return o[e]||(o[e]={}),o[e][t]=n,km(o),o}function Un(e,t){return Qh()[e]?.[t]??$r[e]?.[t]}function FA(){return km({...$r}),{...$r}}function wo(e,t,n,o={}){const i=Um();if(i)return i.acquire(t,n,o);const{char:s="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:a=1,fadeStart:h=.3,friction:u=.95,zIndex:p=100}=o,g=e.add([e.text(s,{size:r}),e.pos(t,n),e.anchor("center"),e.color(...l),e.z(p),"particle"]);return g.velocity={x:c.x,y:c.y},g.gravity=d,g.friction=u,g.lifetime=a,g.fadeStart=h,g.age=0,g.initialOpacity=1,g}function XA(e,t){const n=Um();n&&t._pooled?n.release(t):e.destroy(t)}function qA(e){e.get("particle").forEach(n=>{if(!n.exists()||n.hidden)return;if(n.age+=e.dt(),n.age>=n.lifetime){XA(e,n);return}n.pos.x+=n.velocity.x*e.dt()*60,n.pos.y+=n.velocity.y*e.dt()*60,n.velocity.y+=n.gravity*e.dt()*60,n.velocity.x*=n.friction,n.velocity.y*=n.friction;const o=n.age/n.lifetime;if(o>=n.fadeStart){const i=(o-n.fadeStart)/(1-n.fadeStart);n.opacity=n.initialOpacity*(1-i)}})}function sa(){return!(Un("visual","showParticles")===!1||Un("accessibility","reducedMotion"))}function Bn(e,t,n,o={}){if(!sa())return;const{count:i=8,color:s=[255,50,50],speed:r=2,isCrit:l=!1}=o,c=[".",",","'","`","*"],d=l?i*1.5:i,a=l?r*1.5:r,h=l?[255,200,0]:s;for(let u=0;u<d;u++){const p=Math.PI*2*u/d+(Math.random()-.5)*.5,g=.5+Math.random()*.5,A={x:Math.cos(p)*a*g,y:Math.sin(p)*a*g};wo(e,t,n,{char:c[Math.floor(Math.random()*c.length)],size:8+Math.random()*6,color:h,velocity:A,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function gr(e,t,n,o={}){if(!sa())return;const{count:i=8,color:s=[255,100,100],speed:r=2.5,isBoss:l=!1,isMiniboss:c=!1}=o,d=["*","+",""],a=l?i*2:c?i*1.5:i,h=l?r*1.5:c?r*1.2:r;for(let u=0;u<a;u++){const p=Math.PI*2*u/a+(Math.random()-.5)*.3,g=.6+Math.random()*.4,A={x:Math.cos(p)*h*g,y:Math.sin(p)*h*g};wo(e,t,n,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*6,color:s,velocity:A,gravity:.1,lifetime:.5+Math.random()*.3,fadeStart:.2,friction:.92})}}function ir(e,t,n,o,i={}){if(!sa())return;const{count:s=5,color:r=[255,255,100],speed:l=2.5,isCrit:c=!1}=i,d=["","","",""],a=c?s*2:s,h=c?[255,200,0]:r,u=Math.sqrt(o.x*o.x+o.y*o.y),p=u>0?{x:o.x/u,y:o.y/u}:{x:1,y:0};for(let g=0;g<a;g++){const A=(Math.random()-.5)*Math.PI*.6,m=Math.atan2(p.y,p.x)+A,C=.6+Math.random()*.8,I={x:Math.cos(m)*l*C,y:Math.sin(m)*l*C};wo(e,t,n,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*4,color:h,velocity:I,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function YA(e,t,n,o,i){if(!sa())return;const r={trailFire:["","","",""],trailIce:["*","","",""],trailPoison:["~","","",""],trailShadow:["","","",""],trailRainbow:["","","",""]}[o]||["","","*"],l=r[Math.floor(Math.random()*r.length)];let c=i;if(i==="rainbow"){const h=Date.now()*.1%360;c=GA(h,100,60)}const d=(Math.random()-.5)*8,a=(Math.random()-.5)*8;wo(e,t+d,n+a,{char:l,size:10+Math.random()*6,color:c,velocity:{x:(Math.random()-.5)*.3,y:(Math.random()-.5)*.3},gravity:o==="trailFire"?-.02:.01,lifetime:.4+Math.random()*.2,fadeStart:.2,friction:.98,zIndex:-10})}function GA(e,t,n){t/=100,n/=100;const o=t*Math.min(n,1-n),i=s=>{const r=(s+e/30)%12;return n-o*Math.max(Math.min(r-3,9-r,1),-1)};return[Math.round(i(0)*255),Math.round(i(8)*255),Math.round(i(4)*255)]}function hp(e,t,n,o){const i=e.add([e.text("",{size:48}),e.pos(t.pos.x,t.pos.y),e.anchor("center"),e.color(...o),e.opacity(.3),e.z(-5),"playerGlow"]);return i.target=t,i.glowType=n,i.pulseTime=0,i.baseOpacity=.25,i}function KA(e,t){if(!t||!t.exists()||!t.target||!t.target.exists()){t&&t.exists()&&e.destroy(t);return}t.pos=t.target.pos.clone(),t.pulseTime+=e.dt()*3;const n=Math.sin(t.pulseTime)*.1;t.opacity=t.baseOpacity+n,t.glowType==="glowElectric"&&Math.random()<.05&&(t.opacity=t.baseOpacity+.3)}function VA(e,t,n,o,i=[255,100,100]){if(sa())switch(o){case"deathExplosion":WA(e,t,n,i);break;case"deathDisintegrate":$A(e,t,n,i);break;case"deathVaporize":jA(e,t,n,i);break;case"deathPixelate":JA(e,t,n,i);break;case"deathFireworks":QA(e,t,n,i);break;default:gr(e,t,n,{color:i})}}function WA(e,t,n,o){const i=["*","#","@","X","+",""],r=e.add([e.text("",{size:40}),e.pos(t,n),e.anchor("center"),e.color(255,255,200),e.opacity(1),e.z(200),"particle"]);r.age=0,r.lifetime=.2,r.fadeStart=0,r.velocity={x:0,y:0},r.gravity=0,r.friction=1;for(let l=0;l<20;l++){const c=Math.PI*2*l/20,d=4+Math.random()*2;wo(e,t,n,{char:i[Math.floor(Math.random()*i.length)],size:14+Math.random()*10,color:[255,200,100],velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.92})}for(let l=0;l<20/2;l++){const c=Math.random()*Math.PI*2,d=2+Math.random()*2;wo(e,t,n,{char:i[Math.floor(Math.random()*i.length)],size:10+Math.random()*6,color:o,velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}}function $A(e,t,n,o){const i=["","","","","",""];for(let r=0;r<25;r++){const l=(Math.random()-.5)*20,c=(Math.random()-.5)*20,d=Math.random()*Math.PI*2,a=.5+Math.random()*1.5;wo(e,t+l,n+c,{char:i[Math.floor(Math.random()*i.length)],size:8+Math.random()*8,color:[o[0]*(.6+Math.random()*.4),o[1]*(.6+Math.random()*.4),o[2]*(.6+Math.random()*.4)],velocity:{x:Math.cos(d)*a,y:Math.sin(d)*a},gravity:.2,lifetime:1+Math.random()*.5,fadeStart:.5,friction:.96})}}function jA(e,t,n,o){const i=["~","","","",""];for(let r=0;r<20;r++){const l=(Math.random()-.5)*15,c=Math.random()*Math.PI*2,d=.3+Math.random()*.5;wo(e,t+l,n,{char:i[Math.floor(Math.random()*i.length)],size:10+Math.random()*10,color:[Math.min(255,o[0]+100),Math.min(255,o[1]+100),Math.min(255,o[2]+100)],velocity:{x:Math.cos(c)*d,y:-1.5-Math.random()*1.5},gravity:-.05,lifetime:1.2+Math.random()*.5,fadeStart:.3,friction:.98})}}function JA(e,t,n,o){const i=["","","","","",""];for(let l=-5/2;l<=5/2;l++)for(let c=-5/2;c<=5/2;c++){const d=l*6,a=c*6,h=Math.sqrt(l*l+c*c),u=Math.atan2(c,l),p=1+h*.3+Math.random()*.5;wo(e,t+d,n+a,{char:i[Math.floor(Math.random()*i.length)],size:8+Math.random()*4,color:o,velocity:{x:Math.cos(u)*p,y:Math.sin(u)*p},gravity:.08,lifetime:.6+Math.random()*.4,fadeStart:.4,friction:.94})}}function QA(e,t,n,o){const i=["*","+","x","X","#"];for(let c=0;c<12;c++){const d=Math.PI*2*c/12,a=.7+Math.random()*.6,h={x:Math.cos(d)*3*a,y:Math.sin(d)*3*a};wo(e,t,n,{char:i[Math.floor(Math.random()*i.length)],size:12+Math.random()*8,color:o,velocity:h,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const l=Math.floor(12/2);for(let c=0;c<l;c++){const d=Math.random()*Math.PI*2,a=.3+Math.random()*.4,h={x:Math.cos(d)*3*a*.5,y:Math.sin(d)*3*a*.5};wo(e,t,n,{char:i[Math.floor(Math.random()*i.length)],size:16+Math.random()*8,color:[255,200,100],velocity:h,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}let jn=null,To=null,Mo=0,di=0,Ar=!1,_d=0;const ZA=.05;let Ad=0;const kA=100;function eT(e){jn=e}function ii(e=5,t=.1){if(!jn||!Un("visual","showScreenShake")||Un("accessibility","reducedMotion"))return;const n=jn.time();if(n-_d<ZA){Mo>0&&(di=Math.max(di,e),Mo=Math.max(Mo,t));return}_d=n,Mo<=0&&(To=jn.camPos()),di=Math.max(di,e),Mo=Math.max(Mo,t)}function tT(e){if(!(!jn||Mo<=0))if(Mo-=e,Mo>0){const t=(Math.random()-.5)*2*di,n=(Math.random()-.5)*2*di;To&&jn.camPos(To.x+t,To.y+n)}else To&&jn.camPos(To),di=0,To=null}function sr(e=50){if(!jn||!Un("visual","showHitFreeze")||Un("accessibility","reducedMotion")||jn.paused||Ar)return;const t=Date.now();t-Ad<kA||(Ad=t,jn.paused=!0,Ar=!0,setTimeout(()=>{jn.paused=!1,Ar=!1},e))}function nT(){return Ar}const Xo={playerHit:()=>{ii(6,.1),sr(30)},criticalHit:()=>{ii(4,.08),sr(40)},bossHit:()=>{ii(3,.05)},bossDeath:()=>{ii(15,.3),sr(100)},explosion:()=>{ii(10,.2),sr(60)},playerDeath:()=>{ii(12,.25),sr(150)},levelUp:()=>{ii(5,.15)},smallImpact:()=>{ii(2,.05)}};function oT(){Mo=0,di=0,jn&&To&&jn.camPos(To),To=null,_d=0,Ad=0,Ar=!1}function Sc(e,t,n,o,i={}){if(Un("visual","showDamageNumbers")===!1)return;const{isCrit:s=!1,color:r=s?[255,200,50]:[255,255,255]}=i,l=s?18:14,c=s?`${o}!`:`${o}`,d=(Math.random()-.5)*20,a=(Math.random()-.5)*10,h=e.add([e.text(c,{size:l}),e.pos(t+d,n-20+a),e.anchor("center"),e.color(...r),e.z(500),"damageNumber"]);let u=0;const p=.8;h.onUpdate(()=>{u+=e.dt(),h.pos.y-=40*e.dt(),h.opacity=Math.max(0,1-u/p),u>=p&&e.destroy(h)})}function rr(e,t,n,o){if(!t||!t.exists())return;const i=20,s=e.width()-i,r=e.height()-i,l=i,c=i,d=t.pos.x+n.x*o,a=t.pos.y+n.y*o,h=Math.max(l,Math.min(s,d)),u=Math.max(c,Math.min(r,a)),p=t.pos.x,g=t.pos.y;t.pos.x=h,t.pos.y=u;const A=e.get("wall"),m=e.get("obstacle"),C=[...A,...m];let I=!1;for(const R of C)if(R.exists()&&t.isColliding&&t.isColliding(R)){I=!0;break}I&&(t.pos.x=p,t.pos.y=g)}function up(e,t){let n=0;t.weaponKey==="orbital"&&Td(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.isRemote)t.aimAngle!==void 0&&(t.angle=t.aimAngle,t.outline&&t.outline.exists()&&(t.outline.angle=t.aimAngle));else{const a=Fu();let h,u;if(a.active&&(a.x!==0||a.y!==0))h=e.vec2(a.x,a.y),u=1;else{const p=e.mousePos();h=e.vec2(p.x-t.pos.x,p.y-t.pos.y),u=h.len()}if(u>0){const p=Math.atan2(h.y,h.x)*(180/Math.PI);t.angle=p,t.outline&&t.outline.exists()&&(t.outline.angle=p)}}if(t.canShoot===!1){t.isShooting=!1;return}const o=e.get("enemy"),i=e.get("boss"),s=e.get("miniboss");if(!(o.length>0||i.length>0||s.length>0)&&t.weaponKey!=="orbital"){t.isShooting=!1;return}if(t.weaponKey==="orbital"){iT(e,t),t.isShooting=!1;return}const l=e.time();let c,d=!1;if(t.isRemote){if(de()&&!ve()){t.isShooting=!1;return}if(t.aimAngle!==void 0&&t.isShooting){const a=t.aimAngle*(Math.PI/180);c=e.vec2(Math.cos(a),Math.sin(a)),d=!0}else{t.isShooting=!1;return}}else{const a=Fu();let h,u;if(a.active&&(a.x!==0||a.y!==0))h=e.vec2(a.x,a.y),u=1;else{const p=e.mousePos();h=e.vec2(p.x-t.pos.x,p.y-t.pos.y),u=h.len()}if(u>0){if(t.aimAngle=Math.atan2(h.y,h.x)*(180/Math.PI),c=h.unit(),de()&&!ve()){t.isShooting=u>0&&t.canShoot;return}d=!0}else{t.aimAngle=0,t.isShooting=!1;return}t.isShooting=u>0&&t.canShoot}if(d&&c){let a=t.fireRate;if(t.bulletTimeEnabled&&t.bulletTimeBonus&&t.move&&(t.move.x!==0||t.move.y!==0)&&(a=t.fireRate*(1+t.bulletTimeBonus)),t.speedDemonEnabled&&t.speedDemonFireRatePerStack){const h=t.upgradeStacks?.speed||0;h>0&&(a=a*(1+h*t.speedDemonFireRatePerStack))}if(l-n>=1/a){const h=t.projectileCount||1,u=t.spreadAngle||0,p=[];if(h===1)p.push(c);else if(u>0){const g=h>1?u/(h-1):0,A=-u/2;for(let m=0;m<h;m++){const I=(A+g*m)*(Math.PI/180),R=Math.cos(I),f=Math.sin(I),N=e.vec2(c.x*R-c.y*f,c.x*f+c.y*R);p.push(N.unit())}}else for(let g=0;g<h;g++)p.push(c);p.forEach((g,A)=>{const m=u===0&&h>1?A*Dn.MULTISHOT_STAGGER_DELAY:0;e.wait(m,()=>{const C=vb(t.critChance||0);let I=C?wb(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(I=Math.floor(I*t.piercingDamageBonus));let R=t.weaponRange||As.DEFAULT_WEAPON_RANGE;if(C&&t.deadeyeEnabled&&t.deadeyeRangeBonus&&(R=R*(1+t.deadeyeRangeBonus)),HA(t.weaponKey),t.weaponKey==="flamethrower"){const f=Qn(e,t.pos.x,t.pos.y,g,t.projectileSpeed,I,t.piercing||0,t.obstaclePiercing||0,C,R);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex;const N=Math.floor(I*.3),b=2,T=t.fireDotMultiplier||1;f.burnDamage=Math.floor(N*T),f.burnDuration=b,de()&&ve()&&ms(f,{weaponKey:t.weaponKey,burnDamage:f.burnDamage,burnDuration:f.burnDuration})}else if(t.weaponKey==="explosive"){const f=sT(e,t.pos.x,t.pos.y,g,t.projectileSpeed,I,t.explosionRadius,t.explosionDamage,R,C);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,de()&&ve()&&ms(f,{weaponKey:t.weaponKey,explosionRadius:f.explosionRadius,explosionDamage:f.explosionDamage})}else if(t.weaponKey==="chainLightning"){const f=rT(e,t.pos.x,t.pos.y,g,t.projectileSpeed,I,t.chainRange,t.maxJumps,t.chainDamageReduction,R,C);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,de()&&ve()&&ms(f,{weaponKey:t.weaponKey,chainRange:f.chainRange,maxJumps:f.maxJumps,chainDamageReduction:f.chainDamageReduction})}else if(t.weaponKey==="boomerang"){const f=Qn(e,t.pos.x,t.pos.y,g,t.projectileSpeed,I,t.piercing||0,t.obstaclePiercing||0,C,R);f.isBoomerang=!0,f.ownerPlayer=t,f.returnSpeedMultiplier=t.weaponDef?.returnSpeedMultiplier||1.2,t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,de()&&ve()&&ms(f,{weaponKey:t.weaponKey})}else{const f=Qn(e,t.pos.x,t.pos.y,g,t.projectileSpeed,I,t.piercing||0,t.obstaclePiercing||0,C,R);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,de()&&ve()&&ms(f,{weaponKey:t.weaponKey||"pistol"})}})}),n=l,o_(t)}}}),e.onCollide("projectile","wall",(o,i)=>{if(!e.paused){if(o.isExplosive){Cc(e,o,o.pos.x,o.pos.y);return}o.piercedObstacles&&o.piercedObstacles.has(i)||(o.obstaclePiercing>0?(o.piercedObstacles&&o.piercedObstacles.add(i),o.piercedObstacles.size>(o.obstaclePiercing||0)&&e.destroy(o)):e.destroy(o))}}),e.onCollide("projectile","cover",(o,i)=>{if(!e.paused&&o.obstaclePiercing>0&&o.piercedObstacles){if(o.piercedObstacles.has(i))return;o.piercedObstacles.add(i),o.piercedObstacles.size>(o.obstaclePiercing||0)&&e.destroy(o)}}),e.onCollide("projectile","obstacle",(o,i)=>{e.paused||o.isExplosive||o.piercedObstacles&&o.piercedObstacles.has(i)||(o.obstaclePiercing>0?(o.piercedObstacles&&o.piercedObstacles.add(i),o.piercedObstacles.size>(o.obstaclePiercing||0)&&e.destroy(o)):e.destroy(o))}),e.onCollide("projectile","barrel",(o,i)=>{e.paused||!i.exists()||i.isExploding||o.isEnemyProjectile||o.isBossProjectile||(i.takeDamage&&i.takeDamage(1),o.piercing>0||o.obstaclePiercing>0?o.piercedObstacles&&o.piercedObstacles.add(i):o.isExplosive||o.exists()&&e.destroy(o))}),e.onCollide("projectile","enemy",(o,i)=>{if(e.paused||o.isEnemyProjectile||o.isBossProjectile)return;const s=2,r=o.reflectionCount||0;if(i.reflectsProjectiles&&!o.isReflected&&r<s&&Math.random()<(i.reflectChance||.4)){o.isReflected=!0,o.reflectionCount=r+1,o.isEnemyProjectile=!0,o.direction=e.vec2(-o.direction.x,-o.direction.y),o.color=e.rgb(255,100,100),o.damage=Math.floor(o.damage*.7),e.add([e.text("*",{size:20}),e.pos(i.pos.x,i.pos.y),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.lifespan(.3),e.z(500)]);return}if(o.isExplosive){Cc(e,o,i.pos.x,i.pos.y);return}if(o.isChainLightning){if(o.chainedEnemies&&o.chainedEnemies.has(i))return;if(!de()||ve()){const a=o.chainJumps||0,h=1-(o.chainDamageReduction||.15)*a,u=Math.floor(o.damage*Math.max(.1,h));i.takeDamage?i.takeDamage(u):i.hurt(u)}o.chainedEnemies&&o.chainedEnemies.add(i),o.chainJumps<o.maxJumps?fp(e,o,i):e.destroy(o);return}if(o.piercedEnemies&&o.piercedEnemies.has(i))return;if(de()&&!ve()){sp(),Bn(e,i.pos.x,i.pos.y,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(i),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);return}sp();let l=o.damage;if(o.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===o.ownerSlotIndex);h&&h.executionerEnabled&&h.executionerThreshold&&i.hp()/(i.maxHealth||i.hp())<h.executionerThreshold&&(l=Math.floor(l*(1+(h.executionerDamageBonus||1))))}if(i.takeDamage?i.takeDamage(l):i.hurt(l),Sc(e,i.pos.x,i.pos.y,l,{isCrit:o.isCrit}),o.isCrit&&o.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===o.ownerSlotIndex);if(h&&h.vampiricCrits&&h.vampiricHealPercent){const u=Math.floor(l*h.vampiricHealPercent);if(u>0&&h.hp()<h.maxHealth){const p=Math.min(h.maxHealth,h.hp()+u);h.setHP(p)}}}if(o.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===o.ownerSlotIndex);if(h&&h.lifestealPercent&&h.lifestealPercent>0){let u=h.lifestealPercent;o.isCrit&&h.vampireLordEnabled&&h.vampireLordMultiplier&&(u*=h.vampireLordMultiplier);const p=Math.floor(l*u);if(p>0&&h.hp()<h.maxHealth){const g=Math.min(h.maxHealth,h.hp()+p);h.setHP(g),de()&&ve()&&zm({slotIndex:h.slotIndex,healAmount:p,newHP:g,source:"lifesteal"})}}}if(o.ownerSlotIndex!==void 0){i.lastHitBySlot=o.ownerSlotIndex;const h=e.get("player").find(u=>u.slotIndex===o.ownerSlotIndex);h&&h.survivalistEnabled&&(h.survivalistLastCombatTime=e.time())}de()&&ve()&&D_({targetId:i.mpEntityId,targetType:"enemy",damage:l,isCrit:o.isCrit||!1,x:i.pos.x,y:i.pos.y}),o.burnDamage&&o.burnDuration&&(i.burnDamage=o.burnDamage,i.burnDuration=o.burnDuration,i.burnTimer=0),Bn(e,i.pos.x,i.pos.y,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(i),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);const c=e.vec2(i.pos.x-o.pos.x,i.pos.y-o.pos.y);if(c.len()>0){const a=c.unit(),h=Dn.KNOCKBACK_ENEMY_FROM_PROJECTILE;rr(e,i,a,h)}ir(e,i.pos.x,i.pos.y,c,{isCrit:o.isCrit}),o.isCrit&&Xo.criticalHit(),i.color=o.isCrit?e.rgb(...Dn.CRIT_COLOR):e.rgb(...Dn.HIT_COLOR),e.wait(Dn.HIT_FLASH_DURATION,()=>{i.exists()&&(i.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(o,i)=>{if(e.paused)return;if(o.isExplosive){Cc(e,o,i.pos.x,i.pos.y);return}if(o.isChainLightning){if(o.chainedEnemies&&o.chainedEnemies.has(i))return;if(!de()||ve()){const r=o.chainJumps||0,l=1-(o.chainDamageReduction||.15)*r,c=Math.floor(o.damage*Math.max(.1,l));i.takeDamage?i.takeDamage(c):i.hurt(c)}o.chainedEnemies&&o.chainedEnemies.add(i),e.wait(.01,()=>{o.exists()&&(o.chainJumps<o.maxJumps?fp(e,o,i):e.destroy(o))});return}if(o.piercedEnemies&&o.piercedEnemies.has(i))return;if(de()&&!ve()){Bn(e,i.pos.x,i.pos.y,{isCrit:o.isCrit});const r=e.vec2(i.pos.x-o.pos.x,i.pos.y-o.pos.y);ir(e,i.pos.x,i.pos.y,r,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(i),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);return}i.takeDamage?i.takeDamage(o.damage):i.hurt(o.damage),Sc(e,i.pos.x,i.pos.y,o.damage,{isCrit:o.isCrit}),o.ownerSlotIndex!==void 0&&(i.lastHitBySlot=o.ownerSlotIndex),o.burnDamage&&o.burnDuration&&(i.burnDamage=o.burnDamage,i.burnDuration=o.burnDuration,i.burnTimer=0),Bn(e,i.pos.x,i.pos.y,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(i),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);const s=e.vec2(i.pos.x-o.pos.x,i.pos.y-o.pos.y);s.len()>0&&rr(e,i,s.unit(),Dn.KNOCKBACK_BOSS_FROM_PROJECTILE),ir(e,i.pos.x,i.pos.y,s,{isCrit:o.isCrit}),o.isCrit?Xo.criticalHit():Xo.bossHit(),i.color=o.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("projectile","miniboss",(o,i)=>{if(e.paused||o.isEnemyProjectile||o.isBossProjectile||o.piercedEnemies&&o.piercedEnemies.has(i))return;if(de()&&!ve()){Bn(e,i.pos.x,i.pos.y,{isCrit:o.isCrit});const l=e.vec2(i.pos.x-o.pos.x,i.pos.y-o.pos.y);ir(e,i.pos.x,i.pos.y,l,{isCrit:o.isCrit}),o.piercedEnemies&&o.piercedEnemies.add(i),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o);return}let s=o.damage;o.isCrit&&(s=Math.floor(s*1.5)),i.takeDamage?i.takeDamage(s):i.hurt(s),Sc(e,i.pos.x,i.pos.y,s,{isCrit:o.isCrit}),o.ownerSlotIndex!==void 0&&(i.lastHitBySlot=o.ownerSlotIndex),o.burnDamage&&o.burnDuration&&(i.burnDamage=o.burnDamage,i.burnDuration=o.burnDuration,i.burnTimer=0),Bn(e,i.pos.x,i.pos.y,{isCrit:o.isCrit});const r=e.vec2(i.pos.x-o.pos.x,i.pos.y-o.pos.y);ir(e,i.pos.x,i.pos.y,r,{isCrit:o.isCrit}),o.isCrit&&Xo.criticalHit(),o.piercedEnemies&&o.piercedEnemies.add(i),o.piercedEnemies.size>(o.piercing||0)&&e.destroy(o),i.color=o.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&i.updateVisual()})}),e.onCollide("enemy","player",(o,i)=>{if(e.paused||i.isDead||i.hp()<=0||i.invulnerable)return;if(de()&&!ve()){oi(),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),i.color=e.rgb(...Dn.HIT_COLOR);return}if(i.dodgeChance&&Math.random()<i.dodgeChance){de()&&ve()&&mc({slotIndex:i.slotIndex,x:i.pos.x,y:i.pos.y});return}oi(),Xo.playerHit();const s=o.damage||Dn.BASE_ENEMY_DAMAGE,r=tc(s,i.defense||0,i.damageReduction||0);if(i.hurt(r),i.survivalistEnabled&&(i.survivalistLastCombatTime=e.time()),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),o.lifesteal&&o.exists()){const d=o.hp(),a=o.maxHealth;if(d<a){const h=Math.min(a,d+o.lifesteal);o.setHP(h)}}if(o.isVampiric&&o.vampiricHealAmount&&o.exists()){const d=o.hp(),a=o.maxHealth;if(d<a){const h=Math.min(a,d+o.vampiricHealAmount);o.setHP(h)}}if(i.thornsPercent&&i.thornsPercent>0&&o.exists()){const d=Math.floor(s*i.thornsPercent);if(d>0)if(i.thornsIgnoreArmor)o.hurt(d);else{const a=Math.max(1,d-(o.defense||0));o.hurt(a)}}const l=e.vec2(o.pos.x-i.pos.x,o.pos.y-i.pos.y);if(l.len()>0){const d=l.unit(),a=Dn.KNOCKBACK_ENEMY;rr(e,o,d,a)}i.color=e.rgb(...Dn.HIT_COLOR)}),e.onCollide("miniboss","player",(o,i)=>{if(e.paused||i.isDead||i.hp()<=0||i.invulnerable)return;if(de()&&!ve()){oi(),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),i.color=e.rgb(255,100,100);return}if(i.dodgeChance&&Math.random()<i.dodgeChance){de()&&ve()&&mc({slotIndex:i.slotIndex,x:i.pos.x,y:i.pos.y});return}oi(),Xo.playerHit();let s=Dn.BASE_MINIBOSS_DAMAGE;(o.type==="brute"||o.type==="berserker"||o.type==="guardian")&&o.meleeDamage&&(s=o.meleeDamage);const r=tc(s,i.defense||0,i.damageReduction||0);if(i.hurt(r),i.survivalistEnabled&&(i.survivalistLastCombatTime=e.time()),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),i.thornsPercent&&i.thornsPercent>0&&o.exists()){const d=Math.floor(s*i.thornsPercent);if(d>0)if(i.thornsIgnoreArmor)o.takeDamage?o.takeDamage(d):o.hurt(d);else{const a=Math.max(1,d-(o.defense||0));o.takeDamage?o.takeDamage(a):o.hurt(a)}}const l=e.vec2(o.pos.x-i.pos.x,o.pos.y-i.pos.y);if(l.len()>0){const d=l.unit(),a=Dn.KNOCKBACK_MINIBOSS;rr(e,o,d,a)}i.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(o,i)=>{if(e.paused||i.isDead||i.hp()<=0||i.invulnerable)return;if(de()&&!ve()){oi(),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),i.color=e.rgb(255,100,100);return}if(i.dodgeChance&&Math.random()<i.dodgeChance){de()&&ve()&&mc({slotIndex:i.slotIndex,x:i.pos.x,y:i.pos.y});return}oi(),Xo.playerHit();let s=Dn.BASE_BOSS_DAMAGE;if(o.type==="twinGuardianMelee"&&o.meleeDamage){const d=o.enraged?Dn.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;s=o.meleeDamage*d}const r=tc(s,i.defense||0,i.damageReduction||0);if(i.hurt(r),i.survivalistEnabled&&(i.survivalistLastCombatTime=e.time()),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),i.thornsPercent&&i.thornsPercent>0&&o.exists()){const d=Math.floor(s*i.thornsPercent);if(d>0)if(i.thornsIgnoreArmor)o.takeDamage?o.takeDamage(d):o.hurt(d);else{const a=Math.max(1,d-(o.defense||0));o.takeDamage?o.takeDamage(a):o.hurt(a)}}const l=e.vec2(o.pos.x-i.pos.x,o.pos.y-i.pos.y);if(l.len()>0){const d=l.unit(),a=Dn.KNOCKBACK_BOSS;rr(e,o,d,a)}i.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(o,i)=>{if(e.paused||!o.isBossProjectile&&!o.isEnemyProjectile||i.isDead||i.hp()<=0||i.invulnerable)return;if(de()&&!ve()){oi(),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),i.color=e.rgb(255,100,100),e.destroy(o);return}if(i.dodgeChance&&Math.random()<i.dodgeChance){e.destroy(o);return}oi(),Xo.playerHit();const s=o.damage*(1-(i.damageReduction||0)),r=Math.max(1,s-(i.defense||0));i.hurt(r),i.invulnerable||(i.invulnerable=!0,i.invulnerableTime=i.invulnerableDuration),Bn(e,i.pos.x,i.pos.y,{color:[255,100,100]}),e.destroy(o),i.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(o,i)=>{if(!e.paused&&i.exists()&&!(o.contactCooldown>0)){if(de()&&!ve()){o.contactCooldown=o.contactCooldownDuration||.2;return}i.hurt(o.damage),o.contactCooldown=o.contactCooldownDuration||.2}}),e.onCollide("orbital","boss",(o,i)=>{if(!e.paused&&i.exists()&&!(o.contactCooldown>0)){if(de()&&!ve()){o.contactCooldown=o.contactCooldownDuration||.2;return}i.takeDamage?i.takeDamage(o.damage):i.hurt(o.damage),o.contactCooldown=o.contactCooldownDuration||.2}})}function Td(e,t){t.orbitalOrbs&&t.orbitalOrbs.length>0&&t.orbitalOrbs.forEach(i=>{i&&i.exists()&&e.destroy(i)}),t.orbitalOrbs=[],t.orbitalAngles=[];const n=t.projectileCount||1,o=t.orbitRadius||As.BASE_ORBIT_RADIUS;for(let i=0;i<n;i++){const s=360/n*i,r=s*Math.PI/180,l=t.pos.x+Math.cos(r)*o,c=t.pos.y+Math.sin(r)*o,d=e.add([e.text(t.weaponDef?.char||"",{size:16}),e.pos(l,c),e.anchor("center"),e.color(...t.weaponDef?.color||[100,200,255]),e.area(),"orbital","playerProjectile"]);d.damage=t.projectileDamage||12,d.contactCooldown=0,d.contactCooldownDuration=As.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(d),t.orbitalAngles.push(s)}}function iT(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(s=>{s.exists()&&s.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],Td(e,t),t.orbitalNeedsReinit=!1);const n=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==n)&&Td(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const o=t.rotationSpeed||As.BASE_ROTATION_SPEED,i=t.orbitRadius||As.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((s,r)=>{if(!s.exists())return;t.orbitalAngles[r]=(t.orbitalAngles[r]+o*e.dt())%360;const l=t.orbitalAngles[r]*Math.PI/180;s.pos.x=t.pos.x+Math.cos(l)*i,s.pos.y=t.pos.y+Math.sin(l)*i,s.contactCooldown>0&&(s.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(s=>s.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function sT(e,t,n,o,i,s,r,l,c,d=!1){const a=Qn(e,t,n,o,i,s,0,0,d,c);return a.isExplosive=!0,a.explosionRadius=r||50,a.explosionDamage=l||15,a}function rT(e,t,n,o,i,s,r,l,c,d,a=!1){const h=Qn(e,t,n,o,i,s,0,0,a,d);return h.isChainLightning=!0,h.chainRange=r||70,h.maxJumps=l||3,h.chainDamageReduction=c||.15,h.chainJumps=0,h.chainedEnemies=new Set,h}function Cc(e,t,n,o){if(!t.exists())return;$m(),Xo.explosion();const i=t.explosionRadius||50,s=t.explosionDamage||15;if(!de()||ve()){const l=e.get("enemy"),c=e.get("boss"),d=[...l,...c];for(const a of d){if(!a.exists())continue;e.vec2(a.pos.x-n,a.pos.y-o).len()<=i&&(a.takeDamage?a.takeDamage(s):a.hurt(s))}}const r=e.add([e.text("*",{size:24}),e.pos(n,o),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{r.exists()&&e.destroy(r)}),e.destroy(t)}function fp(e,t,n){if(!t.exists())return;const o=t.chainRange||70,i=e.get("enemy"),s=e.get("boss"),r=[...i,...s];let l=null,c=o;for(const d of r){if(!d.exists()||d===n||t.chainedEnemies&&t.chainedEnemies.has(d))continue;const a=e.vec2(d.pos.x-n.pos.x,d.pos.y-n.pos.y).len();a<=o&&a<c&&(l=d,c=a)}if(l){t.chainJumps=(t.chainJumps||0)+1;const d=n.pos,a=l.pos,h=e.vec2(a.x-d.x,a.y-d.y).len(),u=Math.atan2(a.y-d.y,a.x-d.x),p=(d.x+a.x)/2,g=(d.y+a.y)/2,A=e.add([e.rect(h,2),e.pos(p,g),e.anchor("center"),e.rotate(u),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{A.exists()&&e.destroy(A)}),t.pos.x=l.pos.x,t.pos.y=l.pos.y}else e.destroy(t)}const aT={movement:{id:"movement",message:"Use WASD to move",duration:3,trigger:"firstMove"},shooting:{id:"shooting",message:"Aim with mouse - autofire!",duration:3,trigger:"firstShoot"},levelUp:{id:"levelUp",message:"Choose upgrade with 1-3 or click",duration:4,trigger:"firstLevelUp"},synergy:{id:"synergy",message:"Combine upgrades for bonuses!",duration:4,trigger:"firstSynergy"},shop:{id:"shop",message:"Spend credits on permanent upgrades",duration:4,trigger:"firstShopVisit"}},ey="superSmashTexty_tutorialProgress";let _c=null;function ty(){try{const e=localStorage.getItem(ey);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load tutorial progress:",e)}return{hintsShown:[]}}function lT(e){try{localStorage.setItem(ey,JSON.stringify(e))}catch(t){console.warn("Failed to save tutorial progress:",t)}}function cT(e){return ty().hintsShown.includes(e)}function dT(e){const t=ty();t.hintsShown.includes(e)||(t.hintsShown.push(e),lT(t))}function ny(e,t){if(_c||cT(t))return!1;const n=aT[t];if(!n)return!1;dT(t);const o=e.add([e.rect(300,40),e.pos(e.width()/2,50),e.anchor("center"),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(700),"tutorialHint"]),i=e.add([e.text(n.message,{size:16}),e.pos(e.width()/2,50),e.anchor("center"),e.color(255,255,200),e.fixed(),e.z(701),"tutorialHint"]);return _c={bg:o,text:i},e.wait(n.duration,()=>{o.exists()&&e.destroy(o),i.exists()&&e.destroy(i),_c=null}),!0}function hT(e){ny(e,"movement")}function uT(e){ny(e,"synergy")}const oy={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}},glassCannon:{name:"Glass Cannon",description:"Damage x3 + Health: -25% max HP, +100% damage",required:["damage","damage","damage","health"],requiredCounts:{damage:3,health:1},apply:e=>{if((e.upgradeStacks?.damage||0)>=3){const n=Math.floor(e.maxHealth*.75);e.maxHealth=n;const o=Math.max(1,Math.floor(n*.25)),i=Math.max(o,Math.min(e.hp(),n));e.setHP(i),e.projectileDamage=Math.floor(e.projectileDamage*2)}}},vampiricRounds:{name:"Vampiric Rounds",description:"Crit Chance + Crit Damage + Health: Heal 5% of crit damage",required:["critChance","critDamage","health"],apply:e=>{e.vampiricCrits=!0,e.vampiricHealPercent=.05}},bulletTime:{name:"Bullet Time",description:"Speed + Fire Rate: +20% fire rate while moving",required:["speed","fireRate"],apply:e=>{e.bulletTimeEnabled=!0,e.bulletTimeBonus=.2}},berserker:{name:"Berserker",description:"Damage x3 + Speed x2: +50% damage/speed below 30% HP",requiredCounts:{damage:3,speed:2},apply:e=>{e.berserkerEnabled=!0,e.berserkerThreshold=.3,e.berserkerDamageBonus=.5,e.berserkerSpeedBonus=.5}},deadeye:{name:"Deadeye",description:"Crit x2 + Range x2: Crits have +50% range",requiredCounts:{critChance:2,range:2},apply:e=>{e.deadeyeEnabled=!0,e.deadeyeRangeBonus=.5}},survivor:{name:"Survivalist",description:"Health x2 + Defense x2: Regen 1% HP/sec out of combat",requiredCounts:{health:2,defense:2},apply:e=>{e.survivalistEnabled=!0,e.survivalistRegenPercent=.01,e.survivalistCombatCooldown=3,e.survivalistLastCombatTime=0}},thornMaster:{name:"Retribution",description:"Thorns x3 + Defense x2: Thorns ignore enemy armor",requiredCounts:{thorns:3,defense:2},apply:e=>{e.thornsIgnoreArmor=!0,e.thornsPercent=(e.thornsPercent||0)*1.5}},vampireLord:{name:"Vampire Lord",description:"Lifesteal x3 + Crit Dmg x2: Crits heal 3x lifesteal",requiredCounts:{lifesteal:3,critDamage:2},apply:e=>{e.vampireLordEnabled=!0,e.vampireLordMultiplier=3}},executioner:{name:"Executioner",description:"Damage x2 + Piercing x2: +100% damage to enemies <25% HP",requiredCounts:{damage:2,piercing:2},apply:e=>{e.executionerEnabled=!0,e.executionerThreshold=.25,e.executionerDamageBonus=1}},speedDemon:{name:"Speed Demon",description:"Speed x3 + Fire Rate x2: +1% fire rate per speed stack",requiredCounts:{speed:3,fireRate:2},apply:e=>{e.speedDemonEnabled=!0,e.speedDemonFireRatePerStack=.01}},fortress:{name:"Fortress",description:"Health x3 + Invuln x2: Immunity blocks all damage sources",requiredCounts:{health:3,invulnTime:2},apply:e=>{e.fortressEnabled=!0,e.invulnerableDuration=(e.invulnerableDuration||1)*1.5}}};function iy(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function Pa(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const n=[];for(const[o,i]of Object.entries(oy)){let s=!1;if(i.requiredCounts){s=!0;for(const[r,l]of Object.entries(i.requiredCounts))if((t.upgradeStacks?.[r]||0)<l){s=!1;break}}else s=i.required.every(r=>t.selectedUpgrades.has(r));s&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(o)||(i.apply(t),t.activeSynergies.add(o),n.push(i),uT(e),fT(e,i)))}return n}function fT(e,t){const n=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),o=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{n.exists()&&(e.destroy(n),e.destroy(o))})}function pp(e){if(!(!e.activeSynergies||e.activeSynergies.size===0))for(const t of e.activeSynergies){const n=oy[t];n&&n.apply&&n.apply(e)}}let vn=!1;function gp(e,t,n,o=null,i=null,s=null){if(vn)return;vn=!0;const r=de();r||(e.paused=!0),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip());let l=!1;e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(l=!0));const c=zt("toughChoices"),d=zt("mulligan"),a=3+c;let h=s!==null?s:d,u=0;function p(){let N=null;if(de()){const b=t.playerIndex!==void 0?t.playerIndex:0,T=i||t.level||1;N=X_(b,T+u*100)}return l_(a,t,N)}let g=p();const A=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.opacity(1),e.fixed(),e.z(w.MODAL),"upgradeOverlay"]);l&&e.gameData&&e.gameData.minimap&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()),e.wait(.05,()=>{A.exists()&&(A.opacity=.9)});const m=r&&o?`${o} - Level Up! Choose an Upgrade`:"Level Up! Choose an Upgrade";e.add([e.text(m,{size:Q.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.MODAL+1),"upgradeUI"]);function C(){e.get("upgradeCard").forEach(U=>e.destroy(U));const N=200,b=150,T=e.width()-40;let x,M,_;if(g.length<=3)x=N,M=b,_=250;else if(g.length<=5)x=160,M=130,_=180;else{const U=T/g.length;x=Math.min(140,U-10),M=120,_=x+10}const O=e.width()/2-_*(g.length-1)/2,P=e.height()/2,z=[];return g.forEach((U,F)=>{const B=O+F*_,D=e.add([e.rect(x,M),e.pos(B,P),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.MODAL+1),e.area(),"upgradeUI","upgradeCard"]),q=x<=140?32:48;if(U.icon){const oe=U.category==="passive"?y.SUCCESS:U.weaponKey?y.WARNING:y.INFO;e.add([e.text(U.icon,{size:q}),e.pos(B,P-M/3),e.anchor("center"),e.color(...oe),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"])}const G=x<=140?12:Q.BUTTON;e.add([e.text(U.name,{size:G,width:x-10}),e.pos(B,P-5),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"]);const Z=x<=140?10:Q.BODY,le=c_(U,t);e.add([e.text(le,{size:Z,width:x-10}),e.pos(B,P+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"]);const ie=x<=140?14:Q.HEADER;e.add([e.text(`${F+1}`,{size:ie}),e.pos(B+x/2-15,P-M/2+12),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"]),z.push({card:D,upgrade:U,index:F}),D.onClick(()=>{vn&&f(F)})}),z}C();let I=null;if(d>0){const N=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.WARNING)),e.fixed(),e.z(w.MODAL+1),e.area(),"upgradeUI"]);I=e.add([e.text(`(R) Reroll (${h})`,{size:14}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.MODAL+2),"upgradeUI"]),N.onClick(()=>{vn&&h>0&&R()})}function R(){h<=0||(h--,u++,g=p(),C(),I&&I.exists()&&(I.text=`(R) Reroll (${h})`,h===0&&(I.color=e.rgb(...y.TEXT_SECONDARY))))}function f(N){if(!vn)return;const b=g[N];LA(),vn=!1,Fh(t,b.key),iy(t,b.key);const T=Pa(e,t);if(de()&&t.slotIndex!==void 0&&(O_(t.slotIndex,b.key),T&&T.length>0)){const x=T.map(M=>M.name);B_(t.slotIndex,x)}e.get("upgradeUI").forEach(x=>e.destroy(x)),e.get("upgradeOverlay").forEach(x=>e.destroy(x)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),r||(e.paused=!1),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{n&&n(b,h)})}e.onKeyPress("1",()=>{vn&&g.length>=1&&f(0)}),e.onKeyPress("2",()=>{vn&&g.length>=2&&f(1)}),e.onKeyPress("3",()=>{vn&&g.length>=3&&f(2)}),e.onKeyPress("4",()=>{vn&&g.length>=4&&f(3)}),e.onKeyPress("5",()=>{vn&&g.length>=5&&f(4)}),e.onKeyPress("6",()=>{vn&&g.length>=6&&f(5)}),e.onKeyPress("7",()=>{vn&&g.length>=7&&f(6)}),e.onKeyPress("8",()=>{vn&&g.length>=8&&f(7)}),e.onKeyPress("9",()=>{vn&&g.length>=9&&f(8)}),e.onKeyPress("0",()=>{vn&&g.length>=10&&f(9)}),e.onKeyPress("r",()=>{vn&&h>0&&R()})}function va(){return vn}function mp(e,t,n=null,o=!1){let i=!1;t.pendingLevelUps=t.pendingLevelUps||[],t.addXP=function(r){if(e.paused||i)return;const l=t.xpMultiplier||1,c=Math.floor(r*l);for(t.xp+=c;t.xp>=t.xpToNext&&!i&&t.xpToNext>0;){i=!0,t.xp-=t.xpToNext,t.level++;const d=t.level;t.xpToNext=Math.max(1,Math.floor(t.xpToNext*Do.XP_SCALING_FACTOR)),s(e,t,d)}};function s(r,l,c){if(r.paused&&!o){i=!1;return}PA();const d=r.add([r.text(`Level ${c}!`,{size:24}),r.pos(r.width()/2,Do.LEVEL_UP_NOTIFICATION_Y),r.anchor("center"),r.color(255,255,100),r.fixed(),r.z(1e3)]);if(o&&l.slotIndex!==void 0)N_(l.slotIndex,c),l.pendingLevelUps.push(c);else if(l.pendingLevelUps.push(c),Un("gameplay","autoPause")&&!r.paused){r.wait(.3,()=>{if(!r.paused&&l.pendingLevelUps.length>0){r.paused=!0,i=!0;const h=l.pendingLevelUps.shift();gp(r,l,()=>{i=!1,r.paused=!1},null,h)}}),r.wait(Do.LEVEL_UP_NOTIFICATION_DURATION,()=>{d.exists()&&r.destroy(d)});return}r.wait(Do.LEVEL_UP_NOTIFICATION_DURATION,()=>{d.exists()&&r.destroy(d),i=!1})}return{processPendingLevelUp:()=>{if(t.pendingLevelUps.length>0&&!i){i=!0;const r=t.pendingLevelUps.shift(),l=t.playerName||(t.isRemote?`Player ${t.slotIndex+1}`:"You");gp(e,t,()=>{i=!1},o?l:null,r)}}}}const pT={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:18,turret:12,heavyTank:18,zippy:18,exploder:20,splitter:14},3:{mage:15,shieldBearer:12,golem:12,wraith:12,spawner:12,buffer:15,orbiter:7,phaser:8,mimic:7},4:{healer:18,teleporter:15,freezer:18,leech:20,reflector:14,bomber:15}};function gT(){return{basic:15,rusher:25,tank:30,fast:30}}function mT(e,t=null){const n=Object.values(e).reduce((i,s)=>i+s,0);let o=(t?t.next():Math.random())*n;for(const[i,s]of Object.entries(e))if(o-=s,o<=0)return i;return Object.keys(e)[0]}function Md(e=1,t=null){const n=pT[e]||gT();return mT(n,t)}const sy={swift:{name:"Swift",prefix:"",color:[255,255,100],apply:e=>{e.speed=Math.floor(e.speed*1.5)}},armored:{name:"Armored",prefix:"",color:[100,150,255],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*2),e.setHP(e.maxHealth),e.damageReduction=(e.damageReduction||0)+.25}},vampiric:{name:"Vampiric",prefix:"",color:[255,100,100],apply:e=>{e.isVampiric=!0,e.vampiricHealAmount=10}}},yp={2:{spawnChance:.1},3:{spawnChance:.12},4:{spawnChance:.15}};function yT(e,t=null){if(e<2)return!1;const n=yp[e]||yp[4];return(t?t.next():Math.random())<n.spawnChance}function xT(e=null){const t=Object.keys(sy),n=e?e.next():Math.random(),o=Math.floor(n*t.length);return t[o]}function vT(e,t,n){const o=sy[n];if(!o)return;t.isElite=!0,t.eliteModifier=n,o.apply(t);const i=`${o.prefix}${t.coreChar}`;t.coreChar=i,t.text=i,t.originalColor=o.color,t.color=e.rgb(...o.color),t.xpValue=Math.floor(t.xpValue*1.5),t.updateVisual&&t.updateVisual()}function xp(e,t,n,o=null){if(t.isBoss||t.isBossEnemy||!yT(n,o))return!1;const i=xT(o);return vT(e,t,i),!0}const wT=800,bT=600,wa=20;let Tr=null;const Xi={empty:{name:"Empty Room",obstacles:[],barrels:[],spawnDoors:null,floorAffinity:[1]},streetCorners:{name:"Street Corners",obstacles:[{x:150,y:150,width:50,height:50,type:"cover",char:""},{x:650,y:150,width:50,height:50,type:"cover",char:""},{x:150,y:450,width:50,height:50,type:"cover",char:""},{x:650,y:450,width:50,height:50,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:400}],spawnDoors:null,floorAffinity:[1]},alleyway:{name:"Alleyway",obstacles:[{x:200,y:200,width:30,height:200,type:"wall",char:""},{x:600,y:200,width:30,height:200,type:"wall",char:""}],barrels:[{x:250,y:250},{x:550,y:350}],spawnDoors:null,floorAffinity:[1]},factoryFloor:{name:"Factory Floor",obstacles:[{x:200,y:180,width:80,height:40,type:"wall",char:""},{x:600,y:180,width:80,height:40,type:"wall",char:""},{x:200,y:420,width:80,height:40,type:"wall",char:""},{x:600,y:420,width:80,height:40,type:"wall",char:""},{x:400,y:300,width:60,height:60,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:[2]},assemblyLine:{name:"Assembly Line",obstacles:[{x:250,y:250,width:300,height:25,type:"wall",char:""},{x:250,y:350,width:300,height:25,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[2]},storageYard:{name:"Storage Yard",obstacles:[{x:180,y:180,width:50,height:50,type:"cover",char:""},{x:620,y:180,width:50,height:50,type:"cover",char:""},{x:180,y:420,width:50,height:50,type:"cover",char:""},{x:620,y:420,width:50,height:50,type:"cover",char:""},{x:320,y:300,width:40,height:40,type:"cover",char:""},{x:480,y:300,width:40,height:40,type:"cover",char:""}],barrels:[{x:250,y:250},{x:550,y:250},{x:250,y:350},{x:550,y:350},{x:400,y:200}],spawnDoors:null,floorAffinity:[2]},serverRoom:{name:"Server Room",obstacles:[{x:200,y:150,width:30,height:300,type:"wall",char:""},{x:350,y:150,width:30,height:300,type:"wall",char:""},{x:500,y:150,width:30,height:300,type:"wall",char:""},{x:650,y:150,width:30,height:300,type:"wall",char:""}],barrels:[{x:275,y:200},{x:425,y:400},{x:575,y:250}],spawnDoors:null,floorAffinity:[3]},controlCenter:{name:"Control Center",obstacles:[{x:400,y:200,width:120,height:80,type:"wall",char:""},{x:200,y:350,width:60,height:60,type:"cover",char:""},{x:600,y:350,width:60,height:60,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:200},{x:400,y:450}],spawnDoors:null,floorAffinity:[3]},dataVault:{name:"Data Vault",obstacles:[{x:250,y:200,width:40,height:40,type:"wall",char:""},{x:550,y:200,width:40,height:40,type:"wall",char:""},{x:250,y:400,width:40,height:40,type:"wall",char:""},{x:550,y:400,width:40,height:40,type:"wall",char:""},{x:400,y:300,width:100,height:100,type:"wall",char:""}],barrels:[{x:180,y:300},{x:620,y:300}],spawnDoors:null,floorAffinity:[3]},hiveCluster:{name:"Hive Cluster",obstacles:[{x:300,y:180,width:50,height:50,type:"cover",char:""},{x:500,y:180,width:50,height:50,type:"cover",char:""},{x:200,y:300,width:50,height:50,type:"cover",char:""},{x:600,y:300,width:50,height:50,type:"cover",char:""},{x:300,y:420,width:50,height:50,type:"cover",char:""},{x:500,y:420,width:50,height:50,type:"cover",char:""}],barrels:[{x:400,y:180},{x:400,y:420},{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:[4]},bioLab:{name:"Bio Lab",obstacles:[{x:300,y:250,width:200,height:30,type:"wall",char:""},{x:300,y:350,width:200,height:30,type:"wall",char:""},{x:400,y:300,width:30,height:130,type:"wall",char:""}],barrels:[{x:200,y:200},{x:600,y:200},{x:200,y:400},{x:600,y:400},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[4]},xenoNest:{name:"Xeno Nest",obstacles:[{x:400,y:300,width:80,height:80,type:"wall",char:""},{x:250,y:200,width:35,height:35,type:"cover",char:""},{x:550,y:200,width:35,height:35,type:"cover",char:""},{x:250,y:400,width:35,height:35,type:"cover",char:""},{x:550,y:400,width:35,height:35,type:"cover",char:""}],barrels:[{x:180,y:150},{x:620,y:150},{x:180,y:450},{x:620,y:450}],spawnDoors:null,floorAffinity:[4]},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],barrels:[{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],barrels:[{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],barrels:[{x:150,y:290},{x:650,y:290}],spawnDoors:null,floorAffinity:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],barrels:[{x:250,y:200},{x:550,y:200},{x:250,y:400},{x:550,y:400}],spawnDoors:null,floorAffinity:null},barrelRoom:{name:"Barrel Room",obstacles:[{x:400,y:300,width:50,height:50,type:"cover",char:""}],barrels:[{x:250,y:200},{x:300,y:200},{x:275,y:250},{x:500,y:400},{x:550,y:400},{x:525,y:350},{x:150,y:150},{x:650,y:450}],spawnDoors:null,floorAffinity:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],barrels:[{x:450,y:200},{x:250,y:400},{x:600,y:350}],spawnDoors:null,floorAffinity:null}};function ET(e,t,n,o){const i=n/2,s=o/2,r=wa+i,l=wT-wa-i,c=wa+s,d=bT-wa-s,a=Math.max(r,Math.min(l,e)),h=Math.max(c,Math.min(d,t));return{x:a,y:h}}function ST(e,t){const n={1:{wall:[55,55,65],obstacle:[70,70,80],cover:[85,85,95]},2:{wall:[75,60,50],obstacle:[90,70,55],cover:[100,80,65]},3:{wall:[45,55,75],obstacle:[55,70,95],cover:[65,85,115]},4:{wall:[60,45,70],obstacle:[75,55,85],cover:[90,65,100]},5:{wall:[35,30,45],obstacle:[45,38,55],cover:[55,45,65]}},o=n[Math.min(t,5)]||n[5];return{wallColor:e.rgb(...o.wall),obstacleColor:e.rgb(...o.obstacle),coverColor:e.rgb(...o.cover)}}function mr(e,t=null){const n=Object.keys(Xi),o=Tr?n.filter(h=>h!==Tr):n,i=[],s=[];o.forEach(h=>{const u=Xi[h];u.floorAffinity===null?s.push(h):u.floorAffinity.includes(e)&&i.push(h)});const l=i.length>0&&(t?t.next():Math.random())<.7?i:s.length>0?s:o,c=l.length>0?l:n,d=t?t.range(0,c.length):Math.floor(Math.random()*c.length),a=c[d];return Tr=a,{key:a,...Xi[a]}}function CT(e,t=null,n=1){const o=Xi[e];if(!o||!o.barrels||o.barrels.length===0)return[];let i=[...o.barrels];if(n>=2&&(t?t.next():Math.random())<.3+n*.1){const r=100+(t?t.next():Math.random())*600,l=100+(t?t.next():Math.random())*400;i.push({x:r,y:l})}return n===1&&(t?t.next():Math.random())<.5&&i.length>1&&(i=i.slice(0,Math.ceil(i.length/2))),i}function _T(){Tr=null}function vp(e){return Xi[e]?(Tr=e,{key:e,...Xi[e]}):(console.warn(`Unknown room template key: ${e}, falling back to empty`),{key:"empty",...Xi.empty})}let Zh=[],kh=null;function AT(e){if(Jd(e))return!1;if(tb(e)){if(Zh.push(e),kh){const t=No[e];t&&(NA(),h_(t),de()&&nA(e,tA()))}return!0}return!1}function TT(e){Zh=[],kh=e,e&&qh(e)}function MT(){return[...Zh]}function ba(e,t=null){e&&(kh=e,qh(e));const n=Us(),o={bestFloor:Math.max(n.bestFloor||0,t?.floor||0),totalEnemiesKilled:(n.totalEnemiesKilled||0)+(t?.enemiesKilled||0),totalBossesKilled:(n.totalBossesKilled||0)+(t?.bossesKilled||0),totalRuns:n.totalRuns||0,bestLevel:Math.max(n.bestLevel||0,t?.level||0),totalCurrencyEarned:(n.totalCurrencyEarned||0)+(t?.currencyEarned||0)},i=[],s=(r,l)=>{r&&AT(l)&&i.push(l)};return s(o.bestFloor>=2,"floor2"),s(o.bestFloor>=3,"floor3"),s(o.bestFloor>=5,"floor5"),s(o.bestFloor>=10,"floor10"),s(o.bestFloor>=15,"floor15"),s(o.bestFloor>=20,"floor20"),s(o.totalEnemiesKilled>=1,"firstKill"),s(o.totalEnemiesKilled>=100,"kill100"),s(o.totalEnemiesKilled>=500,"kill500"),s(o.totalEnemiesKilled>=1e3,"kill1000"),s(o.totalEnemiesKilled>=5e3,"kill5000"),s(o.totalEnemiesKilled>=1e4,"kill10000"),s(o.totalBossesKilled>=1,"firstBoss"),s(o.totalBossesKilled>=5,"boss5"),s(o.totalBossesKilled>=10,"boss10"),s(o.totalBossesKilled>=25,"boss25"),s(o.totalBossesKilled>=50,"boss50"),s(o.totalRuns>=1,"firstRun"),s(o.totalRuns>=10,"run10"),s(o.totalRuns>=50,"run50"),s(o.totalRuns>=100,"run100"),s(o.bestLevel>=10,"level10"),s(o.bestLevel>=20,"level20"),s(o.bestLevel>=30,"level30"),s(o.bestLevel>=50,"level50"),s(o.totalCurrencyEarned>=100,"earn100"),s(o.totalCurrencyEarned>=500,"earn500"),s(o.totalCurrencyEarned>=1e3,"earn1000"),s(o.totalCurrencyEarned>=5e3,"earn5000"),s(o.totalCurrencyEarned>=1e4,"earn10000"),i}class Ea{constructor(t,n,o="combat"){this.position={x:t,y:n},this.type=o,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=o==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:n,y:o}=this.position;switch(t){case"up":return{x:n,y:o-1};case"down":return{x:n,y:o+1};case"right":return{x:n+1,y:o};default:return null}}}class RT{constructor(t,n=6,o=3,i=null){this.floor=t,this.width=n,this.height=o,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.rng=i,this.generate()}random(){return this.rng?this.rng.next():Math.random()}randomRange(t,n){return this.rng?this.rng.range(t,n):Math.floor(Math.random()*(n-t))+t}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const n=this.height===1?0:this.randomRange(0,this.height);this.bossPosition={x:this.width-1,y:n};const o=new Ea(0,t,"start");this.setRoom(0,t,o);const i=new Ea(this.width-1,n,"boss");this.setRoom(this.width-1,n,i),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const n of t)if(!this.getRoom(n.x,n.y)){const o=new Ea(n.x,n.y,"combat");this.setRoom(n.x,n.y,o)}}findPath(t,n){const o=[];let i={...t};for(;i.x<n.x||i.y!==n.y;)o.push({...i}),i.x<n.x?i.y!==n.y&&this.random()<.3?i.y+=i.y<n.y?1:-1:i.x+=1:i.y+=i.y<n.y?1:-1;return o.push({...n}),o}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let n=0;for(let o=1;o<this.width-1;o++)for(let i=0;i<this.height&&!(n>=t);i++){if(this.getRoom(o,i))continue;if(o>0&&this.getRoom(o-1,i)&&this.random()<.5){const r=new Ea(o,i,"combat");this.setRoom(o,i,r),n++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let n=0;n<this.height;n++){const o=this.getRoom(t,n);o&&(t<this.width-1&&this.getRoom(t+1,n)&&(o.connections.right=!0),n>0&&this.getRoom(t,n-1)&&(o.connections.up=!0),n<this.height-1&&this.getRoom(t,n+1)&&(o.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let n=0;n<this.height;n++){const o=this.getRoom(t,n);if(o&&(o.type!=="boss"&&(o.template=mr(this.floor,this.rng)),o.type==="combat")){const i=this.randomRange(3,6);o.enemyTypes=[];for(let s=0;s<i;s++)o.enemyTypes.push(Md(this.floor,this.rng))}}}validate(){const t=new Set,n=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);n.length>0;){const o=n.shift(),i=this.getRoom(o.x,o.y);if(!i)continue;if(i.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const s=["up","down","right"];for(const r of s)if(i.connections[r]){const l=i.getAdjacentPosition(r),c=`${l.x},${l.y}`;t.has(c)||(t.add(c),n.push(l))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,n){return t<0||t>=this.width||n<0||n>=this.height?null:this.grid[n][t]}setRoom(t,n,o){t<0||t>=this.width||n<0||n>=this.height||(this.grid[n][t]=o,this.rooms.set(o.getKey(),o))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const n=[],o=["up","down","right"];for(const i of o)if(t.connections[i]){const s=t.getAdjacentPosition(i),r=this.getRoom(s.x,s.y);r&&!r.visited&&n.push({direction:i,position:s,room:r})}return n}markRoomVisited(t,n){const o=this.getRoom(t,n);o&&(o.visited=!0,this.visitedRooms.add(o.getKey()))}markRoomCleared(t,n){const o=this.getRoom(t,n);o&&(o.cleared=!0)}moveToRoom(t){const n=this.getCurrentRoom();if(!n||!n.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const o=n.getAdjacentPosition(t);return this.getRoom(o.x,o.y)?(this.currentPosition=o,this.markRoomVisited(o.x,o.y),console.log(`[FloorMap] Moved to room (${o.x}, ${o.y})`),!0):(console.warn(`[FloorMap] No room found at ${o.x}, ${o.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let n=0;n<this.height;n++){const o=[];for(let i=0;i<this.width;i++){const s=this.getRoom(i,n);s?i===this.currentPosition.x&&n===this.currentPosition.y?o.push({type:"current",room:s}):s.visited?o.push({type:"visited",room:s}):this.isRoomRevealed(i,n)?o.push({type:"revealed",room:s}):o.push({type:"hidden"}):o.push({type:"empty"})}t.push(o)}return t}isRoomRevealed(t,n){if(!this.getRoom(t,n))return!1;const i=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:s,dy:r}of i){const l=this.getRoom(t+s,n+r);if(l&&l.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let n="";for(let o=0;o<this.width;o++){const i=this.getRoom(o,t);i?i.type==="start"?n+="[S]":i.type==="boss"?n+="[B]":o===this.currentPosition.x&&t===this.currentPosition.y?n+="[]":i.visited?n+="[]":n+="[R]":n+="[ ]",n+=" "}console.log(n)}console.log(`
Connections:`);for(const[t,n]of this.rooms){const o=[];n.connections.up&&o.push(""),n.connections.down&&o.push(""),n.connections.right&&o.push(""),console.log(`  (${n.position.x}, ${n.position.y}): ${o.join(", ")||"none"}`)}}}function DT(e,t=null){const n=Math.min(3+e,10),o=Math.min(2+Math.floor(e/2),6),i=new RT(e,n,o,t);return i.debugPrint(),i}const si={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"},an={MARGIN_RIGHT:12,MARGIN_TOP:32,BUTTON_SIZE:38,OPEN_WIDTH:130,OPEN_HEIGHT:85,MAX_MIN_WIDTH:200,MAX_MIN_HEIGHT:160,CELL_SIZE_SMALL:11,CELL_SIZE_LARGE:16,Z_BASE:900,Z_TEXT:901,Z_ICON:902},en={BG_PANEL:[25,25,40],BG_HEADER:[35,35,55],BORDER:[80,120,180],BORDER_HOVER:[120,160,220],TEXT_TITLE:[200,210,255],TEXT_MUTED:[140,140,160],ICON_MAP:[130,160,220],BADGE_FLOOR:[255,220,80],CURRENT:[255,255,100],VISITED:[80,220,100],AVAILABLE:[120,120,140],BOSS:[255,90,90],HIDDEN:[50,50,70],CELL_BG:[30,30,45],CELL_BORDER:[45,45,60]};class IT{constructor(t,n){this.k=t,this.floorMap=n,this.mode=si.MINIMIZED,this.elements=[],this.isHovered=!1,this.destroyed=!1,this.floorMap&&typeof this.floorMap.getGridForMinimap=="function"&&this.render()}getRightX(){return this.k.width()-an.MARGIN_RIGHT}getTopY(){return an.MARGIN_TOP}toggle(){if(!this.destroyed){try{tt()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===si.MINIMIZED?this.mode=si.OPEN:this.mode===si.OPEN?this.mode=si.MAXIMIZED:this.mode=si.MINIMIZED,this.update()}}update(){this.destroyed||(this.clear(),this.render())}clear(){this.elements.forEach(t=>{try{t&&t.exists()&&this.k.destroy(t)}catch{}}),this.elements=[]}render(){this.destroyed||(this.mode===si.MINIMIZED?this.renderMinimized():this.mode===si.OPEN?this.renderOpen():this.renderMaximized())}createPanel(t,n,o,i){const s=this.k.add([this.k.rect(t,n),this.k.pos(o,i),this.k.anchor("topright"),this.k.color(...en.BG_PANEL),this.k.outline(2,this.k.rgb(...en.BORDER)),this.k.fixed(),this.k.z(an.Z_BASE),this.k.area(),this.k.opacity(.95),"minimap"]);return s.onHover(()=>{s.outline.color=this.k.rgb(...en.BORDER_HOVER),s.outline.width=3}),s.onHoverEnd(()=>{s.outline.color=this.k.rgb(...en.BORDER),s.outline.width=2}),s.onClick(()=>this.toggle()),this.elements.push(s),s}renderMinimized(){const t=this.getRightX(),n=this.getTopY(),o=an.BUTTON_SIZE;this.createPanel(o,o,t,n);const i=t-o/2,s=n+o/2,r=this.k.add([this.k.text("",{size:22}),this.k.pos(i,s),this.k.anchor("center"),this.k.color(...en.ICON_MAP),this.k.fixed(),this.k.z(an.Z_TEXT),"minimap"]);this.elements.push(r);const l=this.k.add([this.k.text(`F${this.floorMap.floor}`,{size:9}),this.k.pos(t-o+4,n+4),this.k.anchor("topleft"),this.k.color(...en.BADGE_FLOOR),this.k.fixed(),this.k.z(an.Z_ICON),"minimap"]);this.elements.push(l)}renderOpen(){const t=this.getRightX(),n=this.getTopY(),o=an.OPEN_WIDTH,i=an.OPEN_HEIGHT,s=an.CELL_SIZE_SMALL,r=this.floorMap.getGridForMinimap();if(!r||r.length===0||!r[0]){this.renderMinimized();return}this.createPanel(o,i,t,n);const l=18,c=this.k.add([this.k.rect(o-4,l),this.k.pos(t-2,n+2),this.k.anchor("topright"),this.k.color(...en.BG_HEADER),this.k.fixed(),this.k.z(an.Z_TEXT),"minimap"]);this.elements.push(c);const d=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t-o/2,n+2+l/2),this.k.anchor("center"),this.k.color(...en.TEXT_TITLE),this.k.fixed(),this.k.z(an.Z_ICON),"minimap"]);this.elements.push(d);const a=r[0].length*s;r.length*s;const h=t-o/2-a/2,u=n+l+8;this.renderGrid(r,h,u,s,!1);const p=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()} rooms`,{size:8}),this.k.pos(t-o/2,n+i-8),this.k.anchor("center"),this.k.color(...en.TEXT_MUTED),this.k.fixed(),this.k.z(an.Z_TEXT),"minimap"]);this.elements.push(p)}renderMaximized(){const t=this.getRightX(),n=this.getTopY(),o=an.CELL_SIZE_LARGE,i=this.floorMap.getGridForMinimap();if(!i||i.length===0||!i[0]){this.renderMinimized();return}const s=i[0].length*o,r=i.length*o,l=70,c=26,d=16,a=Math.max(an.MAX_MIN_WIDTH,s+d*2),h=Math.max(an.MAX_MIN_HEIGHT,r+c+l+d),u=Math.min(a,this.k.width()-an.MARGIN_RIGHT-10);this.createPanel(u,h,t,n);const p=this.k.add([this.k.rect(u-4,c),this.k.pos(t-2,n+2),this.k.anchor("topright"),this.k.color(...en.BG_HEADER),this.k.fixed(),this.k.z(an.Z_TEXT),"minimap"]);this.elements.push(p);const g=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor}    ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:11}),this.k.pos(t-u/2,n+2+c/2),this.k.anchor("center"),this.k.color(...en.TEXT_TITLE),this.k.fixed(),this.k.z(an.Z_ICON),"minimap"]);this.elements.push(g);const A=Math.min(s,u-d*2),m=t-u/2-A/2,C=n+c+12;this.renderGrid(i,m,C,o,!0);const I=C+r+12;this.renderLegend(t-u+d,I)}renderGrid(t,n,o,i,s){for(let r=0;r<t.length;r++)for(let l=0;l<t[r].length;l++){const c=t[r][l],d=n+l*i,a=o+r*i;if(c.type==="empty")continue;if(s){const p=this.k.add([this.k.rect(i-2,i-2),this.k.pos(d,a),this.k.anchor("topleft"),this.k.color(...en.CELL_BG),this.k.outline(1,this.k.rgb(...en.CELL_BORDER)),this.k.fixed(),this.k.z(an.Z_TEXT),"minimap"]);this.elements.push(p)}const{char:h,color:u}=this.getCellDisplay(c);if(h){const p=s?12:9,g=this.k.add([this.k.text(h,{size:p}),this.k.pos(d+i/2-1,a+i/2-1),this.k.anchor("center"),this.k.color(...u),this.k.fixed(),this.k.z(an.Z_ICON),"minimap"]);this.elements.push(g)}}}getCellDisplay(t){switch(t.type){case"current":return{char:"",color:en.CURRENT};case"visited":return t.room.isBossRoom?{char:"B",color:en.BOSS}:{char:"",color:en.VISITED};case"revealed":return t.room.isBossRoom?{char:"B",color:[...en.BOSS.map(n=>Math.min(255,n+50))]}:{char:"",color:en.AVAILABLE};case"hidden":return{char:"",color:en.HIDDEN};default:return{char:"",color:[100,100,100]}}}renderLegend(t,n){const o=[{char:"",label:"Current",color:en.CURRENT},{char:"",label:"Cleared",color:en.VISITED},{char:"",label:"Available",color:en.AVAILABLE},{char:"B",label:"Boss",color:en.BOSS}],i=80,s=14;o.forEach((r,l)=>{const c=l%2,d=Math.floor(l/2),a=t+c*i,h=n+d*s,u=this.k.add([this.k.text(r.char,{size:10}),this.k.pos(a,h),this.k.anchor("topleft"),this.k.color(...r.color),this.k.fixed(),this.k.z(an.Z_ICON),"minimap"]);this.elements.push(u);const p=this.k.add([this.k.text(r.label,{size:8}),this.k.pos(a+14,h+1),this.k.anchor("topleft"),this.k.color(...en.TEXT_MUTED),this.k.fixed(),this.k.z(an.Z_ICON),"minimap"]);this.elements.push(p)})}destroy(){this.destroyed=!0,this.clear()}}function PT(e,t){return new IT(e,t)}const wp={city:{name:"Urban Streets",description:"Abandoned city blocks overrun by chaos",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.18},{char:"",pattern:"vertical_lines",density:"low",opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.22},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:6,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08}],baseColor:[55,55,65],ambientColor:[70,70,80]},mechanical:{name:"Industrial Complex",description:"Rusted factories and hazardous machinery",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.15},{char:"",pattern:"grid",spacing:70,opacity:.18},{char:"",pattern:"scattered",count:5,opacity:.22},{char:"",pattern:"scattered",count:4,opacity:.2},{char:"",pattern:"edges",count:16,opacity:.16},{char:"",pattern:"corners",opacity:.24},{char:"",pattern:"random",count:10,opacity:.1},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"horizontal_lines",density:"low",opacity:.12}],baseColor:[75,60,50],ambientColor:[90,75,60]},futuristic:{name:"Cyber Station",description:"High-tech facility with malfunctioning systems",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.16},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.16},{char:"",pattern:"grid",spacing:90,opacity:.14},{char:"",pattern:"scattered",count:6,opacity:.18},{char:"",pattern:"corners",opacity:.22},{char:"",pattern:"scattered",count:8,opacity:.16},{char:"",pattern:"grid",spacing:150,opacity:.1},{char:"",pattern:"random",count:5,opacity:.12},{char:"",pattern:"edges",count:20,opacity:.15}],baseColor:[45,55,75],ambientColor:[60,80,120]},alien:{name:"Alien Vessel",description:"Otherworldly organic ship interior",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.15},{char:"~",pattern:"random",count:20,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.2},{char:"",pattern:"grid",spacing:110,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:6,opacity:.16},{char:"",pattern:"random",count:12,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08},{char:"",pattern:"random",count:8,opacity:.12},{char:"",pattern:"random",count:8,opacity:.12}],baseColor:[60,45,70],ambientColor:[80,60,100]},void:{name:"The Void",description:"Reality breaks down at the edge of existence",floors:[5,6,7,8],decorations:[{char:"",pattern:"random",count:25,opacity:.15},{char:"",pattern:"random",count:15,opacity:.12},{char:"",pattern:"scattered",count:8,opacity:.18},{char:"",pattern:"grid",spacing:120,opacity:.14},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:10,opacity:.16},{char:"",pattern:"random",count:20,opacity:.1},{char:"",pattern:"random",count:20,opacity:.1}],baseColor:[35,30,45],ambientColor:[50,40,70]}};function LT(e){for(const[t,n]of Object.entries(wp))if(n.floors.includes(e))return{key:t,...n};return{key:"city",...wp.city}}function OT(e,t,n=800,o=600){const i=LT(t),s=[],r=30;return i.decorations.forEach(l=>{const c=i.baseColor,d=e.rgb(c[0]+(Math.random()-.5)*20,c[1]+(Math.random()-.5)*20,c[2]+(Math.random()-.5)*20);switch(l.pattern){case"horizontal_lines":{const a=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<o-r;h+=a)s.push({char:l.char,x:n/2,y:h+(Math.random()-.5)*20,color:d,opacity:l.opacity,size:12});break}case"vertical_lines":{const a=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<n-r;h+=a)s.push({char:l.char,x:h+(Math.random()-.5)*20,y:o/2,color:d,opacity:l.opacity,size:12});break}case"wavy_lines":{for(let h=r;h<o-r;h+=60)for(let u=r;u<n-r;u+=40)s.push({char:l.char,x:u+Math.sin(h*.05)*15,y:h,color:d,opacity:l.opacity,size:10});break}case"grid":{const a=l.spacing||80;for(let h=r;h<o-r;h+=a)for(let u=r;u<n-r;u+=a)s.push({char:l.char,x:u+(Math.random()-.5)*10,y:h+(Math.random()-.5)*10,color:d,opacity:l.opacity,size:14});break}case"scattered":{const a=l.count||5;for(let h=0;h<a;h++)s.push({char:l.char,x:r+Math.random()*(n-r*2),y:r+Math.random()*(o-r*2),color:d,opacity:l.opacity,size:16});break}case"random":{const a=l.count||10;for(let h=0;h<a;h++)s.push({char:l.char,x:r+Math.random()*(n-r*2),y:r+Math.random()*(o-r*2),color:d,opacity:l.opacity,size:10+Math.random()*6});break}case"corners":{[{x:r+40,y:r+40},{x:n-r-40,y:r+40},{x:r+40,y:o-r-40},{x:n-r-40,y:o-r-40}].forEach(h=>{s.push({char:l.char,x:h.x,y:h.y,color:d,opacity:l.opacity,size:18})});break}case"edges":{const a=l.count||8,h=Math.floor(a/4);for(let u=0;u<h;u++)s.push({char:l.char,x:n/h*u+n/(h*2),y:r+20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)s.push({char:l.char,x:n/h*u+n/(h*2),y:o-r-20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)s.push({char:l.char,x:r+20,y:o/h*u+o/(h*2),color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)s.push({char:l.char,x:n-r-20,y:o/h*u+o/(h*2),color:d,opacity:l.opacity,size:12});break}}}),s}function NT(e,t,n=800,o=600){OT(e,t,n,o).forEach(s=>{e.add([e.text(s.char,{size:s.size}),e.pos(s.x,s.y),e.color(s.color),e.opacity(s.opacity),e.z(0),"floorDecoration"])})}class ml{constructor(t,n){this.playerId=t,this.characterKey=n,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=Do.STARTING_LEVEL,this.xp=Do.STARTING_XP,this.xpToNext=Do.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,velocityX:this.velocityX,velocityY:this.velocityY,health:this.health,maxHealth:this.maxHealth,speed:this.speed,level:this.level,xp:this.xp,xpToNext:this.xpToNext,xpMultiplier:this.xpMultiplier,weaponKey:this.weaponKey,fireRate:this.fireRate,projectileSpeed:this.projectileSpeed,projectileDamage:this.projectileDamage,projectileCount:this.projectileCount,piercing:this.piercing,obstaclePiercing:this.obstaclePiercing,critChance:this.critChance,critDamage:this.critDamage,spreadAngle:this.spreadAngle,weaponRange:this.weaponRange,pickupRadius:this.pickupRadius,defense:this.defense,damageReduction:this.damageReduction,dodgeChance:this.dodgeChance,invulnerable:this.invulnerable,invulnerableTime:this.invulnerableTime,slowed:this.slowed,isDead:this.isDead,weapons:this.weapons,passiveUpgrades:this.passiveUpgrades,upgradeStacks:this.upgradeStacks}}static fromJSON(t){const n=new ml(t.playerId,t.characterKey);return Object.assign(n,t),n}}class yl{constructor(t,n,o,i,s={}){this.id=t,this.type=n,this.x=o,this.y=i,this.data=s,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new yl(t.id,t.type,t.x,t.y,t.data)}}class xl{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,n){const o=new ml(t,n);return this.players.set(t,o),this.localPlayerId===null&&(this.localPlayerId=t),o}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,n,o,i={}){const s=this.generateEntityId(),r=new yl(s,t,n,o,i);return this.entities.set(s,r),r}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(n=>n.type===t&&!n.removed)}removeEntity(t){const n=this.entities.get(t);n&&(n.removed=!0)}cleanupRemovedEntities(){for(const[t,n]of this.entities.entries())n.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,n])=>[t,n.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,n])=>[t,n.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const n=new xl;return n.sessionId=t.sessionId,n.gameMode=t.gameMode,n.isPaused=t.isPaused,n.currentFloor=t.currentFloor,n.currentRoom=t.currentRoom,n.roomCleared=t.roomCleared,n.gameTime=t.gameTime,n.localPlayerId=t.localPlayerId,n.nextEntityId=t.nextEntityId,n.players=new Map(t.players.map(([o,i])=>[o,ml.fromJSON(i)])),n.entities=new Map(t.entities.map(([o,i])=>[o,yl.fromJSON(i)])),n.doors=t.doors,n.obstacles=t.obstacles,n}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class BT{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new xl,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=xl.fromJSON(t),this.gameState}clear(){this.gameState=null}}const bp=new BT;class eu{constructor(t,n,o){this.playerId=t,this.frameNumber=n,this.timestamp=o,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const n=new eu(t.playerId,t.frameNumber,t.timestamp);return Object.assign(n,t),n}}class HT{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1,this.eventHandlers=[]}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(o=>{this.eventHandlers.push(t.onKeyPress(o,()=>{this.keysPressed.add(o)})),this.eventHandlers.push(t.onKeyRelease(o,()=>{this.keysPressed.delete(o)}))}),this.eventHandlers.push(t.onKeyPress("escape",()=>{this.onPausePressed()})),this.eventHandlers.push(t.onKeyPress("space",()=>{this.onInteractPressed()})),this.eventHandlers.push(t.onKeyPress("e",()=>{this.onInteractPressed()}))}setupMouseListeners(){const t=this.k;this.eventHandlers.push(t.onMouseMove(n=>{this.mouseX=n.x,this.mouseY=n.y})),this.eventHandlers.push(t.onMousePress(()=>{this.mousePressed=!0})),this.eventHandlers.push(t.onMouseRelease(()=>{this.mousePressed=!1}))}collectLocalInput(t){const n=new eu(t,this.frameNumber,Date.now());return n.moveX=this.getMoveX(),n.moveY=this.getMoveY(),n.aimX=this.mouseX,n.aimY=this.mouseY,n.firing=!0,n}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const n=new Map;for(const o of t){const i=this.inputQueues.get(o);let s;i&&i.length>0?s=i.shift():s=this.collectLocalInput(o),n.set(o,s)}return this.currentInputs=n,this.inputHistory.push(new Map(n)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,n}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.eventHandlers.forEach(t=>{t&&t.cancel&&t.cancel()}),this.eventHandlers=[],this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class zT{constructor(){this.inputManager=null}init(t){return this.inputManager=new HT,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const Ep=new zT,Sp={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class vl{constructor(t,n,o=null){this.type=t,this.data=n,this.senderId=o,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const n=new vl(t.type,t.data,t.senderId);return n.timestamp=t.timestamp,n}}class UT{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,n){const o=new vl(t,n,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",o),this.messageQueue.push(o))}broadcast(t,n){this.send(t,n)}sendTo(t,n,o){const i=new vl(n,o,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,i)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const n of t)this.handleMessage(n);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Sp.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Sp.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,n){this.players.set(t,{id:t,...n,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:n})}removePlayer(t){const n=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:n})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,n){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(n)}off(t,n){if(this.eventHandlers.has(t)){const o=this.eventHandlers.get(t),i=o.indexOf(n);i>-1&&o.splice(i,1)}}emit(t,n,o=null){if(this.eventHandlers.has(t)){const i=this.eventHandlers.get(t);for(const s of i)s(n,o)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class FT{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new UT,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const XT=new FT;let J={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null,rerollsRemaining:0,playersRevivedThisRun:new Set,isDailyRun:!1,dailyCharacter:null,dailySeed:null,dailyRNG:null},Lt={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},Sa=!1;function Cp(e,t,n=null){const o=n===null,i=o?zt("startingHealth"):n?.startingHealth||0;i>0&&(t.maxHealth+=i*10,t.setHP(t.maxHealth));const s=o?zt("startingDamage"):n?.startingDamage||0;s>0&&(t.projectileDamage+=s);const r=o?zt("startingSpeed"):n?.startingSpeed||0;r>0&&(t.speed+=r*10)}function qT(e,t,n){const o=Zw();if(o.length!==0&&(n.activeBoosters=[],n.creditMultiplier=1,o.forEach(i=>{const s=W0[i.key];if(!s||!s.effect)return;const r=s.effect;switch(r.type){case"startingHealth":t.maxHealth+=r.value,t.setHP(t.hp()+r.value);break;case"tempDamage":t.projectileDamage=Math.floor(t.projectileDamage*(1+r.value)),n.activeBoosters.push({type:"tempDamage",value:r.value,duration:r.duration});break;case"tempSpeed":t.speed=Math.floor(t.speed*(1+r.value)),t.originalSpeed=t.speed,n.activeBoosters.push({type:"tempSpeed",value:r.value,duration:r.duration});break;case"creditMultiplier":n.creditMultiplier=(n.creditMultiplier||1)+r.value;break;case"tempCrit":t.critChance=(t.critChance||0)+r.value,n.activeBoosters.push({type:"tempCrit",value:r.value,duration:r.duration});break;case"tempDefense":t.damageReduction=(t.damageReduction||0)+r.value,n.activeBoosters.push({type:"tempDefense",value:r.value,duration:r.duration});break;case"tempXP":t.xpMultiplier=(t.xpMultiplier||1)*(1+r.value),n.activeBoosters.push({type:"tempXP",value:r.value,duration:r.duration});break;case"autoRevive":t.autoRevive={health:r.value,uses:r.uses};break}}),o.length>0)){const i=e.add([e.text(`${o.length} Booster${o.length>1?"s":""} Active!`,{size:18}),e.pos(e.width()/2,100),e.anchor("center"),e.color(100,255,150),e.fixed(),e.z(2e3),e.opacity(1)]);e.wait(2,()=>{i.exists()&&e.tween(i.opacity,0,.5,s=>i.opacity=s,e.easings.easeOutQuad).onEnd(()=>{i.exists()&&e.destroy(i)})})}}function YT(e){e.scene("game",t=>{if(zA(),t?.resetState){const E=XT.init("local");Ep.init(e),bp.init("singleplayer").addPlayer(E,"survivor")}const n=bp.getState();if(hb(e),fb(e),wA(),e.paused=!1,t?.resetState){J.currentFloor=1,J.currentRoom=1,J.playerStats=null,J.allPlayerStats=null,J.entryDirection=null,J.floorMap=null,J.playersRevivedThisRun=new Set,_T(),J.isDailyRun=t?.isDailyRun||!1,J.dailyCharacter=t?.dailyCharacter||null,J.dailySeed=t?.dailySeed||null,J.dailyRNG=J.isDailyRun&&J.dailySeed?new Vo(J.dailySeed):null,J.isDailyRun&&console.log("[DailyRun] Starting daily run with character:",J.dailyCharacter,"seed:",J.dailySeed),Lt={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{},startTime:Date.now()},TT(e);const E=zt("mulligan");J.rerollsRemaining=E,Sa=!1,e.wait(1,()=>hT(e)),e.gameData&&(e.gameData.weaponDetailSavedState=void 0)}let o=J.currentFloor,i=J.currentRoom;const s={updates:[],keyPresses:[]};let r=!1,l=!1;const c=[];let d=null;const a={enemies:new xc(128),obstacles:new xc(128),pickups:new xc(128)};eT(e),oT();const h=ri();function u(){if(J.isDailyRun&&J.dailySeed){const E=J.dailySeed+o*1e4+i*100;return new Vo(E)}else if(h>1)return ya();return null}const p=()=>{h>1&&(z_(o),console.log("[Multiplayer] Generating floor map with seed:",kf()?"valid":"invalid (0)"));const E=h>1?F_():null;J.floorMap=DT(o,E),J.minimap&&J.minimap.destroy(),J.minimap=PT(e,J.floorMap),e.gameData&&(e.gameData.minimap=J.minimap)};!J.floorMap||J.floorMap.floor!==o?p():J.minimap&&J.minimap.update(),o>Lt.floorsReached&&(Lt.floorsReached=o);const g={1:"Public Access",2:"Local Affiliate",3:"Cable Network",4:"Premium Channel",5:"Streaming Giant",6:"Global Broadcast",7:"Galactic Signal"},A=E=>g[E]||`Network ${E}`,m=Un("gameplay","skipIntroAnimation");if(i===1&&!m){const E=e.add([e.text(`Floor ${o}`,{size:32}),e.pos(e.width()/2,e.height()/3),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.fixed(),e.z(3e3)]),$=e.add([e.text(A(o),{size:20}),e.pos(e.width()/2,e.height()/3+40),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.fixed(),e.z(3e3)]);e.wait(2,()=>{E.exists()&&E.onUpdate(()=>{E.opacity-=.02,E.opacity<=0&&e.destroy(E)}),$.exists()&&$.onUpdate(()=>{$.opacity-=.02,$.opacity<=0&&e.destroy($)})})}const C=30;let I=e.width()/2,R=e.height()/2;if(J.entryDirection)switch(J.entryDirection){case"north":I=e.width()/2,R=C;break;case"south":I=e.width()/2,R=e.height()-C;break;case"west":I=C,R=e.height()/2;break;case"east":I=e.width()-C,R=e.height()/2;break}let f;const N=J.isDailyRun?J.dailyCharacter:null;if(J.playerStats){f=nc(e,I,R,N),Object.assign(f,J.playerStats);const E=f.isRemote;if(f.isRemote=!1,E&&console.log("[Room Transition] Fixed isRemote flag - local player was incorrectly marked as remote"),f.setHP(J.playerStats.currentHP||f.maxHealth),J.playerStats.selectedUpgrades&&(f.selectedUpgrades=new Set(J.playerStats.selectedUpgrades)),J.playerStats.activeSynergies&&(f.activeSynergies=new Set(J.playerStats.activeSynergies)),J.playerStats.pendingLevelUps&&(f.pendingLevelUps=[...J.playerStats.pendingLevelUps]),f.upgradeStacks&&Object.keys(f.upgradeStacks).length>0&&fl(f),f.activeSynergies&&f.activeSynergies.size>0){pp(f);const $=J.playerStats.currentHP||f.maxHealth;f.setHP(Math.min($,f.maxHealth))}if((f.powerupWeapon==="orbital"||f.weaponKey==="orbital")&&(f.orbitalOrbs=[],f.orbitalAngles=[],f.orbitalNeedsReinit=!0),f.slowed=!1,f.isDead?(f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5)):(f.canMove=!0,f.canShoot=!0,f.opacity=1,f.outline&&f.outline.exists()&&(f.outline.opacity=1)),J.equippedCosmetics){if(J.equippedCosmetics.glow&&J.equippedCosmetics.glow!=="glowNone"&&!f.isDead){const $=ys[J.equippedCosmetics.glow];$&&$.color&&(f.glowEffect=hp(e,f,J.equippedCosmetics.glow,$.color))}if(J.equippedCosmetics.trail&&J.equippedCosmetics.trail!=="trailNone"){const $=ys[J.equippedCosmetics.trail];$&&(f.trailType=J.equippedCosmetics.trail,f.trailColor=$.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}}}else{const E=J.isDailyRun?J.dailyCharacter:null;f=nc(e,I,R,E),Cp(e,f),qT(e,f,J);const $=rb();if(J.equippedCosmetics=$,$.glow&&$.glow!=="glowNone"){const Y=ys[$.glow];Y&&Y.color&&(f.glowEffect=hp(e,f,$.glow,Y.color))}if($.trail&&$.trail!=="trailNone"){const Y=ys[$.trail];Y&&(f.trailType=$.trail,f.trailColor=Y.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}f.runStats={kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}const b=Zi(),T=Sb();let x=new Array(b.maxSlots).fill(null);if(h>1&&T.isInitialized){const E=b.slots.findIndex(Y=>Y.isLocal);if(x_(b.isHost,E,e),b.isHost){const Y=ya(),K=mr(o,Y);J.roomTemplateKey=K.key,console.log("[Multiplayer] Host selected first room template:",K.key),q_(K.key)}b.isHost?p():H_(()=>{console.log("[Multiplayer] Client received seed, regenerating floor map"),p()}),f.slotIndex=E,f.playerName=b.slots[E].playerName;const $=E*30;f.pos.x=I+$,jf(E,f),x[E]=f,b.slots.forEach((Y,K)=>{if(K!==E&&Y.playerId!==null){const X=K*30,S=nc(e,I+X,R,Y.selectedCharacter);if(S.isRemote=!0,S.slotIndex=K,S.playerName=Y.playerName,J.allPlayerStats&&J.allPlayerStats.length>0){const Ye=J.allPlayerStats.find(Ne=>Ne.slotIndex===K);if(Ye){if(Object.assign(S,Ye),S.isRemote=!0,S.setHP(Ye.currentHP||S.maxHealth),Ye.selectedUpgrades&&(S.selectedUpgrades=new Set(Ye.selectedUpgrades)),Ye.activeSynergies&&(S.activeSynergies=new Set(Ye.activeSynergies)),Ye.pendingLevelUps&&(S.pendingLevelUps=[...Ye.pendingLevelUps]),S.upgradeStacks&&Object.keys(S.upgradeStacks).length>0&&fl(S),S.activeSynergies&&S.activeSynergies.size>0){pp(S);const Ne=Ye.currentHP||S.maxHealth;S.setHP(Math.min(Ne,S.maxHealth))}(S.powerupWeapon==="orbital"||S.weaponKey==="orbital")&&(S.orbitalOrbs=[],S.orbitalAngles=[],S.orbitalNeedsReinit=!0),S.slowed=!1,S.isDead?(S.canMove=!1,S.canShoot=!1,S.opacity=.5,S.outline&&S.outline.exists()&&(S.outline.opacity=.5)):(S.canMove=!0,S.canShoot=!0,S.opacity=1,S.outline&&S.outline.exists()&&(S.outline.opacity=1))}}else Cp(e,S,Y.permanentUpgradeLevels);up(e,S),mp(e,S,null,!0),jf(K,S),x[K]=S,b.isHost&&S.onDeath(()=>{if(S.isDead=!0,S.canMove=!1,S.canShoot=!1,S.opacity=.5,S.outline&&S.outline.exists()&&(S.outline.opacity=.5),!x.some(Ne=>Ne&&Ne.exists()&&Ne.hp()>0&&!Ne.isDead)){const Ne=ec(Lt),Ct={...Lt,level:f.level,currencyEarned:Ne};kl(Ct),xs(Ne),ba(e);const kt=x.filter(on=>on&&on.exists()).map(on=>({name:on.playerName||"Player",level:on.level||1,characterData:on.characterData,kills:on.runStats?.kills||0,deaths:on.runStats?.deaths||0,revives:on.runStats?.revives||0,damageTaken:on.runStats?.damageTaken||0,damageDealt:on.runStats?.damageDealt||0,xpCollected:on.runStats?.xpPickedUp||0,creditsPickedUp:on.runStats?.creditsPickedUp||0,bossesKilled:on.runStats?.bossesKilled||0}));de()&&(Qf(Lt,Ne,kt),gs()),e.go("gameOver",{runStats:{...Lt},currencyEarned:Ne,partyStats:kt,isDailyRun:J.isDailyRun,dailyCharacter:J.dailyCharacter})}});const W=e.add([e.text(Y.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]),ue=40,Le=4,be=-40,Oe=e.add([e.rect(ue,Le),e.pos(S.pos.x,S.pos.y+be),e.anchor("center"),e.color(50,50,50),e.z(100),"playerHealthBar"]),Te=e.add([e.rect(ue,Le),e.pos(S.pos.x,S.pos.y+be),e.anchor("center"),e.color(100,255,100),e.z(101),"playerHealthBar"]);S.healthBarBg=Oe,S.healthBar=Te,Oe.hidden=!0,Te.hidden=!0,W.onUpdate(()=>{if(S.exists()){W.pos=e.vec2(S.pos.x,S.pos.y-30);const Ye=S.hp()/S.maxHealth;if(Ye<1&&Ye>0){Oe.hidden=!1,Te.hidden=!1,Oe.pos.x=S.pos.x,Oe.pos.y=S.pos.y+be,Te.pos.x=S.pos.x,Te.pos.y=S.pos.y+be;const Ct=Math.max(1,ue*Ye);Te.use(e.rect(Ct,Le)),Te.pos.x=S.pos.x-(ue-Ct)/2}else Oe.hidden=!0,Te.hidden=!0}else W.destroy(),Oe.exists()&&Oe.destroy(),Te.exists()&&Te.destroy()})}}),ve()||Sa||(Sa=!0,Ue("room_transition",Y=>{if(J.entryDirection=Y.entryDirection,Y.allPlayerStats){J.allPlayerStats=Y.allPlayerStats;const X=Zi().slots.findIndex(W=>W.isLocal),S=Y.allPlayerStats.find(W=>W&&W.slotIndex===X);S?(J.playerStats=S,console.log("[Multiplayer] Client restored stats for slot",X,"level:",S.level)):console.warn("[Multiplayer] Client could not find stats for local slot",X,"in",Y.allPlayerStats)}Y.roomTemplateKey&&(J.roomTemplateKey=Y.roomTemplateKey,console.log("[Multiplayer] Client received room template:",Y.roomTemplateKey)),Y.currentFloor&&Y.currentFloor!==J.currentFloor?(console.log(`[Multiplayer] Floor advancement: ${J.currentFloor} -> ${Y.currentFloor}`),J.currentFloor=Y.currentFloor,J.floorMap=null,J.entryDirection=null):Y.gridDirection&&J.floorMap&&J.floorMap.moveToRoom(Y.gridDirection),!r&&(r=!0,wc(),e.go("game"))}),Ue("room_completed",()=>{if(l=!0,d(),c.forEach(X=>{X.exists()&&!X.blocked&&(X.open=!0,X.isSpawnDoor=!1,X.updateVisual())}),B){const X=c.find(S=>S.direction==="north");X&&X.exists()&&(X.blocked=!1,X.open=!0,X.isSpawnDoor=!1,X.isFloorExit=!0,X.updateVisual())}J.minimap&&J.minimap.update();const Y=B?`BOSS DEFEATED! Floor ${o} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",K=e.add([e.text(Y,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{K.exists()&&e.destroy(K)})}),Ue("obstacle_data",Y=>{console.log("[Multiplayer] Client received obstacle data:",Y.obstacles.length,"obstacles"),e.get("obstacle").forEach(K=>e.destroy(K)),Y.obstacles.forEach(K=>{const X=Array.isArray(K.color)?e.rgb(K.color[0],K.color[1],K.color[2]):K.color;op(e,K.x,K.y,K.width,K.height,K.type,K.char,X)})}),Ue("door_states",Y=>{console.log("[Multiplayer] Client received door states:",Y),typeof c<"u"&&c.length>0&&c.forEach(K=>{Y.hasOwnProperty(K.direction)&&(K.blocked=Y[K.direction],K.updateVisual())})}),Ue("game_over",Y=>{const K=Y.currencyEarned||ec(Y.runStats||Lt),X={...Y.runStats||Lt,level:f.level,currencyEarned:K};kl(X),xs(K),ba(e),gs(),e.go("gameOver",{runStats:{...Y.runStats||Lt},currencyEarned:K,partyStats:Y.partyStats||[],isDailyRun:J.isDailyRun,dailyCharacter:J.dailyCharacter})}),Ue("powerup_weapon_applied",Y=>{x.forEach(K=>{!K||!K.exists()||gc(K,Y.powerupKey)})}),Ue("upgrade_selected",Y=>{if(Y.slotIndex===E)return;const K=x.find(X=>X.slotIndex===Y.slotIndex);K&&K.exists()&&(Fh(K,Y.upgradeKey),iy(K,Y.upgradeKey),Pa(e,K))}),Ue("level_up_queued",Y=>{if(Y.slotIndex===E)return;const K=x.find(X=>X.slotIndex===Y.slotIndex);K&&K.exists()&&(K.level=Y.level,K.pendingLevelUps||(K.pendingLevelUps=[]),K.pendingLevelUps.includes(Y.level)||K.pendingLevelUps.push(Y.level))}),Ue("synergy_activated",Y=>{if(Y.slotIndex===E)return;const K=x.find(X=>X.slotIndex===Y.slotIndex);K&&K.exists()&&Pa(e,K)}),Ue("powerup_expired",Y=>{const K=x.find(X=>X.slotIndex===Y.slotIndex);K&&K.exists()&&bd(K)}),Ue("player_healed",Y=>{const K=x.find(X=>X.slotIndex===Y.slotIndex);K&&K.exists()&&K.setHP(Y.newHP)}),Ue("player_dodged",Y=>{const K=x.find(X=>X.slotIndex===Y.slotIndex);if(K&&K.exists()){const X=e.add([e.text("DODGE!",{size:14}),e.pos(Y.x,Y.y-30),e.anchor("center"),e.color(100,200,255),e.opacity(1),e.z(500)]);let S=0;X.onUpdate(()=>{S+=e.dt(),X.pos.y-=30*e.dt(),X.opacity=Math.max(0,1-S/.8),S>=.8&&e.destroy(X)})}}))}else f.slotIndex=0,x[0]=f;x.filter(E=>E!==null);function M(E,$){if(!E||!E.exists())return;const Y=$==="exclamation"?"!":"",K=$==="exclamation"?[255,255,0]:[255,100,150],X=e.add([e.text(Y,{size:24}),e.pos(E.pos.x,E.pos.y-50),e.anchor("center"),e.color(...K),e.opacity(1),e.scale(1),e.z(1e3),"emote"]);let S=0;const W=1.5;X.onUpdate(()=>{S+=e.dt(),X.pos.x=E.pos.x,X.pos.y=E.pos.y-50-S*30,S<.2?X.scale=e.vec2(1+S*2):X.scale=e.vec2(1.4-(S-.2)*.3),S>W*.6&&(X.opacity=1-(S-W*.6)/(W*.4)),S>=W&&e.destroy(X)})}let _=0;const O=.1;e.onKeyPress("q",()=>{if(f.isDead)return;const E=e.time();E-_<O||(_=E,M(f,"exclamation"),de()&&ep(f.slotIndex,"exclamation"))}),e.onKeyPress("e",()=>{if(f.isDead)return;const E=e.time();E-_<O||(_=E,M(f,"heart"),de()&&ep(f.slotIndex,"heart"))}),h>1&&Ue("player_emote",E=>{const $=x[E.slotIndex];$&&$.exists()&&M($,E.emoteType)});const P=n.localPlayerId,z=n.getPlayer(P);z&&(z.x=f.pos.x,z.y=f.pos.y,z.health=f.hp(),z.maxHealth=f.maxHealth,z.speed=f.speed,z.level=f.level,z.xp=f.xp,z.xpToNext=f.xpToNext,z.xpMultiplier=f.xpMultiplier||1,z.weaponKey="pistol",z.fireRate=f.fireRate,z.projectileSpeed=f.projectileSpeed,z.projectileDamage=f.projectileDamage,z.projectileCount=f.projectileCount||1,z.piercing=f.piercing||0,z.obstaclePiercing=f.obstaclePiercing||0,z.critChance=f.critChance||.05,z.critDamage=f.critDamage||2,z.spreadAngle=f.spreadAngle||0,z.weaponRange=f.weaponRange||600,z.pickupRadius=f.pickupRadius,z.defense=f.defense||0,z.damageReduction=f.damageReduction||0,z.dodgeChance=f.dodgeChance||0),d=()=>{if(h<=1)return;const E=zt("secondWind");if(E<=0)return;let $=0;x.forEach((Y,K)=>{if(Y&&(Y.exists()&&Y.hp()<=0||Y.exists()&&Y.isDead)){const X=`player_${K}`;if(J.playersRevivedThisRun.has(X))return;J.playersRevivedThisRun.add(X);const S=.05+E*.05,W=Math.max(1,Math.floor(Y.maxHealth*S));Y.setHP(W),Y.isDead=!1,Y.canMove=!0,Y.canShoot=!0;const ue=Math.round(S*100),Le=e.add([e.text(` REVIVED (${ue}% HP) `,{size:16}),e.pos(Y.pos.x,Y.pos.y-40),e.anchor("center"),e.color(100,255,100),e.opacity(1),e.lifespan(2),e.z(1e3)]);Le.onUpdate(()=>{Le.pos.y-=30*e.dt(),Le.opacity-=.5*e.dt()}),Y.opacity=1,Y.characterData&&Y.characterData.color&&(Y.color=e.rgb(...Y.characterData.color)),Y.outline&&Y.outline.exists()&&(Y.outline.opacity=1),$++}}),$>0&&e.get("projectile").forEach(Y=>{(Y.isEnemyProjectile||Y.isBossProjectile)&&e.destroy(Y)}),$>0&&de()&&ve()&&I_()},up(e,f);const U=mp(e,f,d,h>1);if(f.isDead||(f.canMove=!0,f.canShoot=!0),h>1){const E=J_();E>0&&f.addXP&&(console.log("[Multiplayer] Applying pending XP:",E),f.addXP(E))}J.playerStats&&J.playerStats.selectedUpgrades&&e.wait(.1,()=>{Pa(e,f)});const F=J.floorMap.getCurrentRoom(),B=F?F.isBossRoom:i===3;let D;if(h>1&&J.roomTemplateKey)D=vp(J.roomTemplateKey),console.log("[Multiplayer] Using synced template:",J.roomTemplateKey),J.roomTemplateKey=null;else if(h>1&&!kf()){const E=U_();if(E)D=vp(E),console.log("[Multiplayer] Client using first room template:",E);else{console.warn("[Multiplayer] No seed or template key available, using fallback");const $=ya();D=mr(o,$)}}else F&&F.template?D=F.template:D=mr(o,u());const q=ST(e,o),G=20;NT(e,o,e.width(),e.height()),e.add([e.rect(e.width()-G*2,2),e.pos(e.width()/2,G),e.anchor("center"),e.color(q.wallColor),e.fixed()]),e.add([e.rect(e.width()-G*2,2),e.pos(e.width()/2,e.height()-G),e.anchor("center"),e.color(q.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-G*2),e.pos(G,e.height()/2),e.anchor("center"),e.color(q.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-G*2),e.pos(e.width()-G,e.height()/2),e.anchor("center"),e.color(q.wallColor),e.fixed()]);const Z=i===1&&o===1,le=80;let ie=e.width()/2,oe=e.height()/2;if(J.entryDirection)switch(J.entryDirection){case"north":ie=e.width()/2,oe=C;break;case"south":ie=e.width()/2,oe=e.height()-C;break;case"west":ie=C,oe=e.height()/2;break;case"east":ie=e.width()-C,oe=e.height()/2;break}const se=[],he=[],Me=h<=1||ve();!Z&&Me&&(D.obstacles.forEach(E=>{const $=Math.sqrt(Math.pow(E.x-I,2)+Math.pow(E.y-R,2)),Y=Math.sqrt(Math.pow(E.x-ie,2)+Math.pow(E.y-oe,2)),K=Math.max(E.width,E.height)/2;if($<le+K||Y<le+K)return;const X=ET(E.x,E.y,E.width,E.height),S=E.type==="wall"?q.obstacleColor:q.coverColor,W=op(e,X.x,X.y,E.width,E.height,E.type,E.char||"#",S);if(se.push(W),h>1&&ve()){let ue=null;S&&(Array.isArray(S)?ue=S:S.r!==void 0&&(ue=[S.r,S.g,S.b])),he.push({x:X.x,y:X.y,width:E.width,height:E.height,type:E.type,char:E.char||"#",color:ue})}}),h>1&&ve()&&e.wait(.1,()=>{V_(he)})),!Z&&!B&&Me&&CT(D.key,u(),o).forEach($=>{const Y=Math.sqrt(Math.pow($.x-I,2)+Math.pow($.y-R,2)),K=Math.sqrt(Math.pow($.x-ie,2)+Math.pow($.y-oe,2));if(Y<le+25||K<le+25)return;let X=!1;se.forEach(S=>{if(!S.exists())return;Math.sqrt(Math.pow($.x-S.pos.x,2)+Math.pow($.y-S.pos.y,2))<50&&(X=!0)}),X||mA(e,$.x,$.y)}),e.add([e.rect(82,22),e.pos(8,2),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(w.UI_BG)]);const He=e.add([e.text("",{size:Q.HUD}),e.pos(20,6),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT)]),we=e.add([e.text("0/0",{size:Q.HUD}),e.pos(40,6),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT)]);e.add([e.rect(85,22),e.pos(e.width()-10,2),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(w.UI_BG-1)]),e.add([e.text("$",{size:Q.LABEL}),e.pos(e.width()-20,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);const De=e.add([e.text("0",{size:Q.HUD}),e.pos(e.width()-40,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);let Qe=null,Ae=0;Un("visual","showTimer")!==!1&&(e.add([e.rect(60,18),e.pos(e.width()-10,28),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(w.UI_BG)]),Qe=e.add([e.text("0:00",{size:Q.SMALL-2}),e.pos(e.width()-15,30),e.anchor("topright"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]));let pt=null,pe=0,Se=0,ae=60;if(Un("visual","showFPS")&&(pt=e.add([e.text("60 FPS",{size:Q.SMALL-2}),e.pos(e.width()/2,6),e.anchor("top"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)])),de()){const E=M_(),$=T.isHost?[100,255,100]:[100,200,255],Y=T.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...$),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(`${Y} (${E}P)`,{size:Q.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...$),e.fixed(),e.z(w.UI_TEXT)])}const Xe=e.width()-40,qe=15,Ce=e.height()-18;e.add([e.rect(Xe,qe),e.pos(20,Ce),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.UI_BG)]);const Ve=f.xpToNext>0?f.xp/f.xpToNext:0,We=Math.max(0,(Xe-34)*Ve),At=e.add([e.rect(We,qe-4),e.pos(58,Ce+2),e.color(100,200,255),e.fixed(),e.z(w.UI_BG+1)]),Nt=e.add([e.text(Vf(f.xp||0,f.xpToNext||10),{size:Q.SMALL-2}),e.pos(e.width()/2,Ce+qe/2),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),wt=36,Ie=20+wt/2,Pe=Ce+qe/2;e.add([e.circle(wt/2),e.pos(Ie,Pe),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(w.UI_BG+2)]);const Ge=e.add([e.text(`${f.level||1}`,{size:Q.BODY}),e.pos(Ie,Pe),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_BG+3)]),$e=40,je=8,ct=25,at=e.add([e.rect($e,je),e.pos(0,0),e.anchor("center"),e.color(...y.BG_DARK),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.z(w.OVERLAY)]),st=e.add([e.rect($e-2,je-2),e.pos(0,0),e.anchor("center"),e.color(100,255,100),e.z(w.OVERLAY+1)]);at.hidden=!0,st.hidden=!0;const ut=48,Rt=25,Dt=e.height()-85,Yt=e.add([e.rect(ut,ut),e.pos(Rt,Dt),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(w.UI_BG)]),Pt=e.add([e.text("",{size:32}),e.pos(Rt+ut/2,Dt+ut/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),Zt=220,dt=90,Tt=e.add([e.rect(Zt,dt),e.pos(Rt,Dt-dt-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(w.OVERLAY+5)]),xe=e.add([e.text("",{size:24}),e.pos(Rt+15,Dt-dt-10+15),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+6)]),Ze=e.add([e.text("Basic Pistol",{size:Q.SMALL,width:160}),e.pos(Rt+50,Dt-dt-10+10),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+6)]),re=e.add([e.text("DMG: 10",{size:Q.SMALL-2}),e.pos(Rt+50,Dt-dt-10+30),e.color(255,150,150),e.fixed(),e.z(w.OVERLAY+6)]),Re=e.add([e.text("RATE: 3.75/s",{size:Q.SMALL-2}),e.pos(Rt+50,Dt-dt-10+47),e.color(150,200,255),e.fixed(),e.z(w.OVERLAY+6)]),ke=e.add([e.text("DPS: 37.5",{size:Q.SMALL-2}),e.pos(Rt+50,Dt-dt-10+64),e.color(255,255,150),e.fixed(),e.z(w.OVERLAY+6)]);Tt.hidden=!0,xe.hidden=!0,Ze.hidden=!0,re.hidden=!0,Re.hidden=!0,ke.hidden=!0;let _e=!1;t?.resetState&&(_e=!1),Yt.onClick(()=>{_e=!_e,Tt.hidden=!Tt.hidden,xe.hidden=!xe.hidden,Ze.hidden=!Ze.hidden,re.hidden=!re.hidden,Re.hidden=!Re.hidden,ke.hidden=!ke.hidden});const L=40,V=Rt,ee=Dt-L-10,fe=e.add([e.rect(L,L),e.pos(V,ee),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(w.UI_BG)]),nt=e.add([e.text("",{size:28}),e.pos(V+L/2,ee+L/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),rt=e.add([e.text("20",{size:14}),e.pos(V+L+5,ee+L/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(w.UI_TEXT)]);fe.hidden=!0,nt.hidden=!0,rt.hidden=!0;const Vt=Rt+ut+10,lt=Dt,It=32,Wt=40,fn=[];function Ee(){if(fn.forEach($=>{$.exists()&&e.destroy($)}),fn.length=0,!f.exists())return;const E=[];f.upgradeStacks&&Object.entries(f.upgradeStacks).forEach(([$,Y])=>{Y>0&&E.push({key:$,stacks:Y})}),E.forEach(($,Y)=>{const K=Vt+Y*Wt,X=Ls[$.key];if(!X)return;const S=e.add([e.rect(It,It),e.pos(K,lt),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(w.UI_BG)]),W=e.add([e.text(X.icon,{size:20}),e.pos(K+It/2,lt+It/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),ue=e.add([e.text($.stacks.toString(),{size:10}),e.pos(K+It-4,lt+It-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(w.UI_TEXT+1)]);fn.push(S,W,ue)})}const ot=50,bt=e.width()-ot-25,ge=e.height()-ot-25,ce=e.add([e.rect(ot,ot),e.pos(bt,ge),e.color(100,200,255),e.opacity(.9),e.outline(3,e.rgb(255,255,255)),e.area(),e.fixed(),e.z(w.OVERLAY+5)]),ze=e.add([e.text("+",{size:36}),e.pos(bt+ot/2,ge+ot/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+6)]),me=20,Ke=bt+ot-me/2,Et=ge-me/2,Bt=e.add([e.circle(me/2),e.pos(Ke,Et),e.anchor("center"),e.color(255,50,50),e.outline(2,e.rgb(255,255,255)),e.fixed(),e.z(w.OVERLAY+7)]),St=e.add([e.text("2",{size:12}),e.pos(Ke,Et),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+8)]);ce.hidden=!0,ze.hidden=!0,Bt.hidden=!0,St.hidden=!0,ce.onClick(()=>{U&&f.pendingLevelUps&&f.pendingLevelUps.length>0&&U.processPendingLevelUp()});let Sn=0;ce.onUpdate(()=>{if(ce.hidden)return;Sn+=e.dt()*4;const E=(Math.sin(Sn)+1)/2,$=3+E*3,Y=200+E*55;ce.outline.width=$,ce.outline.color=e.rgb(Y,Y,100+E*155);const K=1+E*.05;ce.scale=e.vec2(K,K),ze.scale=e.vec2(K,K)});const ht=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(w.OVERLAY+10)]),Ht=e.add([e.text("",{size:Q.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+11)]);ht.hidden=!0,Ht.hidden=!0;const Zo={level:()=>`Level ${f.level}
XP: ${f.xp}/${f.xpToNext}
Progress: ${Math.floor(f.xp/f.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${Lt.enemiesKilled}`),currency:()=>`Total Credits: ${Wi()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const E=f.weaponDef;return E?`${E.name}
Damage: ${f.projectileDamage}
Fire Rate: ${f.fireRate.toFixed(2)}/s
DPS: ${(f.projectileDamage*f.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(f.hp())}/${f.maxHealth}
Damage Reduction: ${Math.floor(f.damageReduction*100)}%`};function ss(E,$,Y){const K=Zo[E];if(!K)return;const X=K();Ht.text=X,ht.pos.x=Math.min($+10,e.width()-210),ht.pos.y=Math.min(Y+10,e.height()-70),Ht.pos.x=ht.pos.x+5,Ht.pos.y=ht.pos.y+5,ht.hidden=!1,Ht.hidden=!1}function rs(){ht.hidden=!0,Ht.hidden=!0}function Yl(){return{hidden:ht.hidden,text:Ht.text,tooltipX:ht.pos.x,tooltipY:ht.pos.y,textX:Ht.pos.x,textY:Ht.pos.y}}function Gl(E){E&&(ht.hidden=E.hidden,Ht.hidden=E.hidden,Ht.text=E.text,ht.pos.x=E.tooltipX,ht.pos.y=E.tooltipY,Ht.pos.x=E.textX,Ht.pos.y=E.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=rs,e.gameData.saveTooltipState=Yl,e.gameData.restoreTooltipState=Gl,e.gameData.minimap=J.minimap,oA(e),e.gameData.spatialGrids=a,e.gameData.alivePlayers=[],e.gameData.additionalEnemiesFromSplits=0,e.gameData.incrementSplitEnemies=E=>{ra+=E,e.gameData.additionalEnemiesFromSplits=ra},e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,s.updates.push(e.onUpdate(()=>{e.gameData.alivePlayers=e.get("player").filter(E=>!E.isDead&&E.exists()),a.enemies.clear(),e.get("enemy").forEach(E=>a.enemies.insert(E)),e.get("boss").forEach(E=>a.enemies.insert(E)),e.get("miniboss").forEach(E=>a.enemies.insert(E)),a.pickups.clear(),e.get("xpPickup").forEach(E=>a.pickups.insert(E)),e.get("currencyPickup").forEach(E=>a.pickups.insert(E)),e.get("powerupWeaponPickup").forEach(E=>a.pickups.insert(E))})),s.updates.push(e.onUpdate(()=>{tT(e.dt())})),s.updates.push(e.onUpdate(()=>{const E=e.dt();if(Qe&&Qe.exists()&&!e.paused){Ae+=E;const $=Math.floor(Ae/60),Y=Math.floor(Ae%60);Qe.text=`${$}:${Y.toString().padStart(2,"0")}`}pt&&pt.exists()&&(Se++,pe+=E,pe>=.5&&(ae=Math.round(Se/pe),pt.text=`${ae} FPS`,ae>=50?pt.color=e.rgb(100,255,100):ae>=30?pt.color=e.rgb(255,255,100):pt.color=e.rgb(255,100,100),Se=0,pe=0))})),s.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const E=e.dt();if(f.berserkerEnabled){const Y=f.hp()/f.maxHealth<(f.berserkerThreshold||.3),K=1+(f.berserkerSpeedBonus||.5),X=1+(f.berserkerDamageBonus||.5);Y&&!f.berserkerActive?(f.berserkerActive=!0,f.speed=Math.floor(f.speed*K),f.projectileDamage=Math.floor(f.projectileDamage*X)):!Y&&f.berserkerActive&&(f.berserkerActive=!1,f.speed=Math.floor(f.speed/K),f.projectileDamage=Math.floor(f.projectileDamage/X))}if(f.survivalistEnabled){const $=e.time()-(f.survivalistLastCombatTime||0),Y=f.survivalistCombatCooldown||3;if($>=Y&&f.hp()<f.maxHealth){const K=f.survivalistRegenPercent||.01,X=f.maxHealth*K*E;if(f.survivalistRegenAccum=(f.survivalistRegenAccum||0)+X,f.survivalistRegenAccum>=1){const S=Math.floor(f.survivalistRegenAccum);f.survivalistRegenAccum-=S;const W=Math.min(f.maxHealth,f.hp()+S);f.setHP(W),de()&&ve()&&zm({slotIndex:f.slotIndex,healAmount:S,newHP:W,source:"survivalist"})}}}})),s.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const E=e.dt();if(f.glowEffect&&KA(e,f.glowEffect),f.trailType&&f.trailColor){f.trailTimer=(f.trailTimer||0)+E;const $=.05,Y=f.pos.x-(f.lastTrailPos?.x||f.pos.x),K=f.pos.y-(f.lastTrailPos?.y||f.pos.y),X=Math.sqrt(Y*Y+K*K);f.trailTimer>=$&&X>2&&(YA(e,f.pos.x,f.pos.y,f.trailType,f.trailColor),f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}})),s.updates.push(e.onUpdate(()=>{if(e.paused||va())return;const E=e.mousePos();let $=!1;E.x>=20&&E.x<=180&&E.y>=20&&E.y<=35?(ss("level",E.x,E.y),$=!0):E.x>=20&&E.x<=180&&E.y>=40&&E.y<=55&&!we.hidden?(ss("enemies",E.x,E.y),$=!0):E.x>=e.width()-130&&E.x<=e.width()-10&&E.y>=10&&E.y<=50?(ss("currency",E.x,E.y),$=!0):E.x>=Rt&&E.x<=Rt+ut&&E.y>=Dt&&E.y<=Dt+ut&&(ss("weapon",E.x,E.y),$=!0),$||rs()}));const co=e.add([e.text("",{size:Q.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...y.BOSS_NAME),e.fixed(),e.z(w.OVERLAY)]),as=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.OVERLAY)]),dn=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.HEALTH_LOW),e.fixed(),e.z(w.OVERLAY+1)]),So=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.OVERLAY)]),Rn=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.OVERLAY+1)]),Ho=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]),Vn=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]),ko=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.OVERLAY)]),Nn=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.XP_BAR),e.fixed(),e.z(w.OVERLAY+1)]),ho=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]);co.hidden=!0,as.hidden=!0,dn.hidden=!0,So.hidden=!0,Rn.hidden=!0,Ho.hidden=!0,Vn.hidden=!0,ko.hidden=!0,Nn.hidden=!0,ho.hidden=!0,s.updates.push(e.onUpdate(()=>{e.paused||qA(e)})),s.updates.push(e.onUpdate(()=>{e.paused||de()&&S_(e.dt())})),s.updates.push(e.onUpdate(()=>{const E=f.exists()?f.hp():0,$=f.maxHealth>0?E/f.maxHealth:1;Ge.text=`${f.level||1}`;const Y=f.xpToNext>0?f.xp/f.xpToNext:0;if(At.width=Math.max(0,(Xe-34)*Y),Nt.text=Vf(f.xp,f.xpToNext),De.text=Wi().toString(),$<1&&f.exists()){at.hidden=!1,st.hidden=!1;const S=f.pos.x,W=f.pos.y+ct;at.pos=e.vec2(S,W);const ue=Math.max(1,($e-2)*$);st.use(e.rect(ue,je-2));const Le=S-$e/2+1+ue/2;st.pos=e.vec2(Le,W),$>.6?st.color=e.rgb(100,255,100):$>.3?st.color=e.rgb(255,200,0):st.color=e.rgb(255,50,50)}else at.hidden=!0,st.hidden=!0;if(!B&&!l){const S=e.get("enemy").length,W=Vs+ra+(Ws?1:0),ue=e.get("miniboss").length,Le=S+ue+Math.max(0,W-ls-ra-(Ws&&Kl?1:0));we.text=`${Le}/${W}`,we.hidden=!1,He.hidden=!1}else we.hidden=!0,He.hidden=!0;if(f.exists()&&f.weaponDef){const S=f.weaponDef,W=(f.projectileDamage*f.fireRate).toFixed(1);Pt.text=S.icon||"",Pt.color=e.rgb(...S.color),xe.text=S.icon||"",xe.color=e.rgb(...S.color),Ze.text=S.name,Ze.color=e.rgb(...y.TEXT_PRIMARY),re.text=`DMG: ${f.projectileDamage}`,Re.text=`RATE: ${f.fireRate.toFixed(2)}/s`,ke.text=`DPS: ${W}`,e.paused&&!nT()?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=_e),Tt.hidden=!1,xe.hidden=!1,Ze.hidden=!1,re.hidden=!1,Re.hidden=!1,ke.hidden=!1):(Tt.hidden=!_e,xe.hidden=!_e,Ze.hidden=!_e,re.hidden=!_e,Re.hidden=!_e,ke.hidden=!_e)}if(f.exists()){n_(f,e.dt());const S=i_(f);S?(fe.hidden=!1,nt.hidden=!1,rt.hidden=!1,nt.text=S.icon,nt.color=e.rgb(...S.color),fe.outline.color=e.rgb(...S.color),S.isAmmoBased?rt.text=`${S.ammo}`:S.isTimeBased&&(rt.text=`${Math.ceil(S.duration)}s`)):(fe.hidden=!0,nt.hidden=!0,rt.hidden=!0)}if(e.time()%.5<e.dt()&&Ee(),f.exists()&&f.pendingLevelUps&&f.pendingLevelUps.length>0){ce.hidden=!1,ze.hidden=!1;const S=f.pendingLevelUps.length;S>1?(Bt.hidden=!1,St.hidden=!1,St.text=S.toString()):(Bt.hidden=!0,St.hidden=!0)}else ce.hidden=!0,ze.hidden=!0,Bt.hidden=!0,St.hidden=!0;const K=e.get("boss"),X=K.filter(S=>S.type==="twinGuardianMelee"||S.type==="twinGuardianRanged");if(X.length>0){const S=X.find(ue=>ue.type==="twinGuardianMelee"),W=X.find(ue=>ue.type==="twinGuardianRanged");if(S&&W&&(S.exists()||W.exists())){co.hidden=!1,co.text="THE CO-HOSTS";const ue=S.exists()?S.hp():0,Le=W.exists()?W.hp():0,be=ue+Le,Oe=(S.maxHealth||0)+(W.maxHealth||0),Te=Oe>0?Math.max(0,Math.min(1,be/Oe)):0;dn.width=296*Te,dn.pos.x=e.width()/2-296*(1-Te)/2,Ho.text=`${Math.max(0,Math.floor(be))}/${Oe}`,as.hidden=!1,dn.hidden=!1,Ho.hidden=!1;const Ye=S.exists()&&S.shieldHealth||0,Ne=W.exists()&&W.shieldHealth||0,Ct=Ye+Ne,kt=(S.maxShieldHealth||0)+(W.maxShieldHealth||0);if(kt>0){const js=Math.max(0,Math.min(1,Ct/kt));Nn.width=296*js,Nn.pos.x=e.width()/2-296*(1-js)/2,ho.text=`Shield: ${Math.max(0,Math.floor(Ct))}/${kt}`,ko.hidden=!1,Nn.hidden=!1,ho.hidden=!1}else ko.hidden=!0,Nn.hidden=!0,ho.hidden=!0;const on=S.exists()&&S.armorHealth||0,ti=W.exists()&&W.armorHealth||0,da=on+ti,jl=(S.maxArmorHealth||0)+(W.maxArmorHealth||0);if(jl>0){const js=Math.max(0,Math.min(1,da/jl));Rn.width=296*js,Rn.pos.x=e.width()/2-296*(1-js)/2,Vn.text=`Armor: ${Math.max(0,Math.floor(da))}/${jl}`,So.hidden=!1,Rn.hidden=!1,Vn.hidden=!1}else So.hidden=!0,Rn.hidden=!0,Vn.hidden=!0;Te>.6?dn.color=e.rgb(255,50,50):Te>.3?dn.color=e.rgb(255,150,50):dn.color=e.rgb(255,200,0)}else{const ue=S?.exists()?S:W;if(ue){const Le=ue.hp(),be=ue.maxHealth,Oe=ue.shieldHealth||0,Te=ue.maxShieldHealth||0,Ye=ue.armorHealth||0,Ne=ue.maxArmorHealth||0;co.hidden=!1,co.text=ue.enraged?"THE CO-HOSTS (ENRAGED)":"THE CO-HOSTS";const Ct=Math.max(0,Math.min(1,Le/be));if(dn.width=296*Ct,dn.pos.x=e.width()/2-296*(1-Ct)/2,Ho.text=`${Math.max(0,Math.floor(Le))}/${be}`,as.hidden=!1,dn.hidden=!1,Ho.hidden=!1,Te>0){const kt=Math.max(0,Math.min(1,Oe/Te));Nn.width=296*kt,Nn.pos.x=e.width()/2-296*(1-kt)/2,ho.text=`Shield: ${Math.max(0,Math.floor(Oe))}/${Te}`,ko.hidden=!1,Nn.hidden=!1,ho.hidden=!1}else ko.hidden=!0,Nn.hidden=!0,ho.hidden=!0;if(Ne>0){const kt=Math.max(0,Math.min(1,Ye/Ne));Rn.width=296*kt,Rn.pos.x=e.width()/2-296*(1-kt)/2,Vn.text=`Armor: ${Math.max(0,Math.floor(Ye))}/${Ne}`,So.hidden=!1,Rn.hidden=!1,Vn.hidden=!1}else So.hidden=!0,Rn.hidden=!0,Vn.hidden=!0;Ct>.6?dn.color=e.rgb(255,50,50):Ct>.3?dn.color=e.rgb(255,150,50):dn.color=e.rgb(255,200,0)}else co.hidden=!0,as.hidden=!0,dn.hidden=!0,So.hidden=!0,Rn.hidden=!0,Ho.hidden=!0,Vn.hidden=!0}}else if(K.length>0&&K[0].exists()){const S=K[0],W=S.hp(),ue=S.maxHealth,Le=S.shieldHealth||0,be=S.maxShieldHealth||0,Oe=S.armorHealth||0,Te=S.maxArmorHealth||0;let Ye="BOSS";S.type==="twinGuardianMelee"||S.type==="twinGuardianRanged"?Ye="THE CO-HOSTS":Io[S.type]?.name&&(Ye=`THE ${Io[S.type].name.toUpperCase()}`),co.hidden=!1,as.hidden=!1,dn.hidden=!1,So.hidden=!1,Rn.hidden=!1,Ho.hidden=!1,Vn.hidden=!1,co.text=Ye;const Ne=Math.max(0,Math.min(1,W/ue));if(dn.width=296*Ne,dn.pos.x=e.width()/2-296*(1-Ne)/2,Ho.text=`${Math.max(0,Math.floor(W))}/${ue}`,be>0){const Ct=Math.max(0,Math.min(1,Le/be));Nn.width=296*Ct,Nn.pos.x=e.width()/2-296*(1-Ct)/2,ho.text=`Shield: ${Math.max(0,Math.floor(Le))}/${be}`,ko.hidden=!1,Nn.hidden=!1,ho.hidden=!1}else ko.hidden=!0,Nn.hidden=!0,ho.hidden=!0;if(Te>0){const Ct=Math.max(0,Math.min(1,Oe/Te));Rn.width=296*Ct,Rn.pos.x=e.width()/2-296*(1-Ct)/2,Vn.text=`Armor: ${Math.max(0,Math.floor(Oe))}/${Te}`,So.hidden=!1,Rn.hidden=!1,Vn.hidden=!1}else So.hidden=!0,Rn.hidden=!0,Vn.hidden=!0;Ne>.6?dn.color=e.rgb(255,50,50):Ne>.3?dn.color=e.rgb(255,150,50):dn.color=e.rgb(255,200,0)}else co.hidden=!0,as.hidden=!0,dn.hidden=!0,So.hidden=!0,Rn.hidden=!0,Ho.hidden=!0,Vn.hidden=!0,ko.hidden=!0,Nn.hidden=!0,ho.hidden=!0})),s.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const E=n.getPlayer(P);E&&(E.x=f.pos.x,E.y=f.pos.y,E.velocityX=0,E.velocityY=0,E.health=f.hp(),E.maxHealth=f.maxHealth,E.level=f.level,E.xp=f.xp,E.xpToNext=f.xpToNext,E.projectileDamage=f.projectileDamage,E.fireRate=f.fireRate,E.projectileSpeed=f.projectileSpeed,E.projectileCount=f.projectileCount||1,E.piercing=f.piercing||0,E.critChance=f.critChance||.05,E.critDamage=f.critDamage||2,E.pickupRadius=f.pickupRadius,E.defense=f.defense||0,E.isDead=f.isDead||!f.exists()||f.hp()<=0,E.invulnerable=f.invulnerable||!1,n.updateTime(e.dt()))})),n.currentFloor=o,n.currentRoom=i,n.roomCleared=!1,s.updates.push(e.onUpdate(()=>{if(e.paused)return;Ep.getManager().getInputsForFrame([P]).get(P)}));let Vs=B?0:24+(o-1)*6,ls=0,my=2,ou=!1,Kl=!1,Ws=!1,yy=4,Vl=0,ra=0;const iu=u()||new Vo(Date.now());if(!B&&i!==1){const E=.15+(o-1)*.05;Ws=iu.next()<E}Ws&&(Vs=Math.floor(Vs*.5));function xy(E,$){const Y=["brute","sentinel","berserker","guardian","warlock"];if(E>=3)return Y[$.range(0,Y.length)];{const K=["brute","berserker","guardian"];return K[$.range(0,K.length)]}}function vy(E){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[E]||"gatekeeper"}const wy=[{x:e.width()/2,y:C,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-C,direction:"south",gridDir:"down"},{x:C,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-C,y:e.height()/2,direction:"east",gridDir:"right"}],by=J.floorMap?J.floorMap.getAvailableExits():[],Ey=new Set(by.map(E=>E.direction));wy.forEach(E=>{const $=pA(e,E.x,E.y,E.direction);$.open=!1,$.isSpawnDoor=!0,$.gridDirection=E.gridDir,(E.gridDir===null||!Ey.has(E.gridDir))&&($.blocked=!0),$.updateVisual(),c.push($)}),h>1&&ve()&&e.wait(.1,()=>{const E={};c.forEach($=>{E[$.direction]=$.blocked}),Je("door_states",E)});let aa=0;const Sy=.33;let su=!1;s.updates.push(e.onUpdate(()=>{if(e.paused||l)return;if(su||(Vl=e.time(),su=!0),B){if(!ou&&(!de()||ve())){ou=!0;const X=vy(o),S=u();if(X==="twinGuardian"){const W=c.filter(Te=>Te.direction!==J.entryDirection);let ue,Le;if(W.length>=2){const Te=[...W];for(let Ne=Te.length-1;Ne>0;Ne--){const Ct=S?S.range(0,Ne+1):Math.floor(Math.random()*(Ne+1));[Te[Ne],Te[Ct]]=[Te[Ct],Te[Ne]]}ue=Te[0];const Ye={north:"south",south:"north",east:"west",west:"east"};Le=W.find(Ne=>Ne.direction===Ye[ue.direction])||Te[1]}else ue=c[0],Le=c[c.length>1?1:0];const be=e_(e,ue,Le,o,S);de()&&ve()&&(Array.isArray(be)?be.forEach(Te=>{fo(Te,{type:"twinGuardian",floor:o})}):be&&fo(be,{type:"twinGuardian",floor:o})),lp();const Oe=e.add([e.text("THE CO-HOSTS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Oe.exists()&&e.destroy(Oe)})}else{let W=c.find(Ye=>Ye.direction==="north");if(!W||J.entryDirection==="north"&&c.length>1){const Ye=c.filter(Ne=>Ne.direction!==J.entryDirection);if(Ye.length>0){const Ne=S?S.range(0,Ye.length):Math.floor(Math.random()*Ye.length);W=Ye[Ne]}else{const Ne=S?S.range(0,c.length):Math.floor(Math.random()*c.length);W=c[Ne]}}const ue=W?W.pos.x:e.width()/2,Le=W?W.pos.y:e.height()/2,be=ul(e,ue,Le,X,o,S);de()&&ve()&&fo(be,{type:X,floor:o,isBoss:!0}),lp();let Oe="BOSS";X==="twinGuardian"?Oe="THE CO-HOSTS":Io[X]?.name&&(Oe=`THE ${Io[X].name.toUpperCase()}`);const Te=e.add([e.text(Oe,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Te.exists()&&e.destroy(Te)})}}if(!de()||ve()){const X=e.get("boss"),S=e.get("enemy").filter(W=>W.isBossMinion);X.length===0&&S.length===0&&!l&&(l=!0,au())}return}if(Ws&&!Kl&&(!de()||ve())&&e.time()-Vl>=1){Kl=!0;const X=xy(o,iu),S=u(),W=c.filter(kt=>kt.direction!==J.entryDirection),ue=W.length>0?W:c,Le=S?S.range(0,ue.length):Math.floor(Math.random()*ue.length),be=ue[Le],Oe=be.pos.x,Te=be.pos.y,Ye=fA(e,Oe,Te,X,o);de()&&ve()&&fo(Ye,{type:X,floor:o});const Ne=ki[X]?.name||"MINIBOSS",Ct=e.add([e.text(`MINIBOSS: ${Ne.toUpperCase()}`,{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{Ct.exists()&&e.destroy(Ct)})}const E=e.get("enemy").length,$=e.get("miniboss").length;if(ls>=Vs&&E===0&&$===0&&!l&&(!de()||ve())&&(l=!0,au()),ls<Vs&&(!de()||ve())){if(aa+=e.dt(),ls===0&&aa<my)return;if(aa>=Sy){aa=0,ls++;const X=u();if(X)for(let S=0;S<ls-1;S++)X.next();if(c.length>0){const S=e.time()-Vl,ue=J.entryDirection&&S<yy?c.filter(da=>da.direction!==J.entryDirection):c,Le=ue.length>0?ue:c,be=X?X.range(0,Le.length):Math.floor(Math.random()*Le.length),Oe=Le[be],Te=Oe.pos.x,Ye=Oe.pos.y,Ne=15,Ct=Te+(X?X.next()-.5:Math.random()-.5)*Ne,kt=Ye+(X?X.next()-.5:Math.random()-.5)*Ne,on=Md(o,X),ti=mi(e,Ct,kt,on,o,X);xp(e,ti,o,X),de()&&ve()&&fo(ti,{type:on,floor:o,isElite:ti.isElite,eliteModifier:ti.eliteModifier})}else{const S=X?X.range(0,4):Math.floor(e.rand(0,4));let W,ue;switch(S){case 0:W=X?X.rangeFloat(G,e.width()-G):e.rand(G,e.width()-G),ue=G;break;case 1:W=e.width()-G,ue=X?X.rangeFloat(G,e.height()-G):e.rand(G,e.height()-G);break;case 2:W=X?X.rangeFloat(G,e.width()-G):e.rand(G,e.width()-G),ue=e.height()-G;break;case 3:W=G,ue=X?X.rangeFloat(G,e.height()-G):e.rand(G,e.height()-G);break}const Le=Md(o,X),be=mi(e,W,ue,Le,o,X);xp(e,be,o,X),de()&&ve()&&fo(be,{type:Le,floor:o,isElite:be.isElite,eliteModifier:be.eliteModifier})}}}})),s.updates.push(e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(E=>{if(E.hp()<=0&&!E.isDead){E.isDead=!0;const $=E.xpValue,Y=E.pos.x,K=E.pos.y;if(E.cleanupHealthBars&&E.cleanupHealthBars(),E.explodes&&E.explosionRadius){const W=E.explosionRadius,ue=E.explosionDamage||15;f.exists()&&Math.sqrt(Math.pow(f.pos.x-Y,2)+Math.pow(f.pos.y-K,2))<=W&&f.takeDamage(ue),a.enemies.getNearby(Y,K,W).forEach(be=>{if(be===E||!be.exists())return;const Oe=be.pos.x-Y,Te=be.pos.y-K;Oe*Oe+Te*Te<=W*W&&be.hurt(ue)}),gr(e,Y,K,{color:[255,150,50]})}else{const W=J.equippedCosmetics?.death,ue=E.originalColor||[255,100,100];W&&W!=="deathNone"?VA(e,Y,K,W,ue):gr(e,Y,K,{color:ue})}if(E.shrapnel&&E.shrapnelCount){const W=E.shrapnelCount,ue=Math.PI*2/W,Le=250,be=Math.floor((E.explosionDamage||15)*.6);for(let Oe=0;Oe<W;Oe++){const Te=ue*Oe,Ye=e.vec2(Math.cos(Te),Math.sin(Te)),Ne=Qn(e,Y,K,Ye,Le,be,0,0,!1);Ne.isEnemyProjectile=!0,Ne.color=e.rgb(...E.originalColor)}}E.cleanupHealthBars&&typeof E.cleanupHealthBars=="function"&&E.cleanupHealthBars(),de()&&E.mpEntityId&&(ve()?Vh({entityId:E.mpEntityId,entityType:"enemy",x:Y,y:K}):K_({entityId:E.mpEntityId,entityType:"enemy",x:Y,y:K})),e.destroy(E),rp(),Lt.enemiesKilled++;const X=E.type||E.enemyType||"basic";Lt.killsByType[X]=(Lt.killsByType[X]||0)+1;const S=E.lastHitBySlot;if(S!==void 0&&x[S]&&x[S].runStats?x[S].runStats.kills++:f.runStats&&f.runStats.kills++,!de()||ve()){const W=u();fr(e,Y,K,$);const ue=W?W.range(1,4):Math.floor(Math.random()*3)+1,Le=1;for(let Oe=0;Oe<ue;Oe++){const Te=W?(W.next()-.5)*20:(Math.random()-.5)*20,Ye=W?(W.next()-.5)*20:(Math.random()-.5)*20,Ne=Da();pr(e,Y+Te,K+Ye,Le,Ne)}const be=t_(E.type,o);if(be){const Oe=W?(W.next()-.5)*30:(Math.random()-.5)*30,Te=W?(W.next()-.5)*30:(Math.random()-.5)*30;Kf(e,Y+Oe,K+Te,be)}}}}),e.get("miniboss").forEach(E=>{if(E.hp()<=0&&!E.isDead){E.isDead=!0;const $=E.xpValue,Y=E.pos.x,K=E.pos.y;gr(e,Y,K,{color:[255,150,100],isMiniboss:!0}),e.destroy(E),rp(),Lt.enemiesKilled++;const X=E.type||"miniboss";Lt.killsByType[X]=(Lt.killsByType[X]||0)+1;const S=E.lastHitBySlot;if(S!==void 0&&x[S]&&x[S].runStats?x[S].runStats.kills++:f.runStats&&f.runStats.kills++,!de()||ve()){const ue=u();fr(e,Y,K,$);const Le=ue?ue.range(10,16):Math.floor(Math.random()*6)+10,be=1;for(let Oe=0;Oe<Le;Oe++){const Te=Math.PI*2/Le*Oe,Ye=ue?30+ue.next()*20:30+Math.random()*20,Ne=Math.cos(Te)*Ye,Ct=Math.sin(Te)*Ye;pr(e,Y+Ne,K+Ct,be)}}const W=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(Y,K-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{W.exists()&&e.destroy(W)})}}),e.get("boss").forEach(E=>{if(E.hp()<=0&&!E.isDead){E.isDead=!0;const $=E.xpValue,Y=E.pos.x,K=E.pos.y;gr(e,Y,K,{color:[255,200,100],isBoss:!0}),e.destroy(E),OA(),Lt.enemiesKilled++,Lt.bossesKilled++;const X=E.type||"boss";Lt.killsByType[X]=(Lt.killsByType[X]||0)+1;const S=E.lastHitBySlot;if(S!==void 0&&x[S]&&x[S].runStats?(x[S].runStats.kills++,x[S].runStats.bossesKilled++):f.runStats&&(f.runStats.kills++,f.runStats.bossesKilled++),!de()||ve()){const ue=u();fr(e,Y,K,$);const Le=ue?ue.range(20,31):Math.floor(Math.random()*11)+20,be=1,Oe=Da();for(let Te=0;Te<Le;Te++){const Ye=Math.PI*2/Le*Te,Ne=ue?40+ue.next()*30:40+Math.random()*30,Ct=Math.cos(Ye)*Ne,kt=Math.sin(Ye)*Ne;pr(e,Y+Ct,K+kt,be,Oe)}}const W=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(Y,K-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{W.exists()&&e.destroy(W)})}}))})),s.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const E=Un("gameplay","autoPickupXP"),$=E?2e3:f.pickupRadius,Y=$*1.5,K=new Set;h===1?a.pickups.getNearby(f.pos.x,f.pos.y,Y).forEach(X=>{X.is&&X.is("xpPickup")&&K.add(X)}):x.forEach(X=>{!X||!X.exists()||X.isDead||a.pickups.getNearby(X.pos.x,X.pos.y,Y).forEach(S=>{S.is&&S.is("xpPickup")&&K.add(S)})}),K.forEach(X=>{if(X.collected)return;let S=f,W=e.vec2(f.pos.x-X.pos.x,f.pos.y-X.pos.y).len();h>1&&x.forEach(Le=>{if(!Le||!Le.exists()||Le.isDead)return;const be=e.vec2(Le.pos.x-X.pos.x,Le.pos.y-X.pos.y).len();be<W&&(W=be,S=Le)});const ue=E?$:S.pickupRadius;if(!X.magnetizing&&W<=ue&&(X.magnetizing=!0,X.targetPlayer=S),W<=rn.COLLECTION_RADIUS&&!X.collected){if(de()&&!ve())return;X.collected=!0,IA(),h>1?ve()&&(f.exists()&&!f.isDead&&f.addXP&&f.addXP(X.value),$_(X.value)):f.addXP(X.value),X.isFlyingToUI=!0}})})),s.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const E=Un("gameplay","autoPickupCurrency"),$=E?2e3:f.pickupRadius,Y=$*1.5,K=new Set;h===1?a.pickups.getNearby(f.pos.x,f.pos.y,Y).forEach(S=>{S.is&&S.is("currencyPickup")&&K.add(S)}):x.forEach(S=>{!S||!S.exists()||S.isDead||a.pickups.getNearby(S.pos.x,S.pos.y,Y).forEach(W=>{W.is&&W.is("currencyPickup")&&K.add(W)})}),K.forEach(S=>{if(S.collected)return;let W=f,ue=e.vec2(f.pos.x-S.pos.x,f.pos.y-S.pos.y).len();h>1&&x.forEach(be=>{if(!be||!be.exists()||be.isDead)return;const Oe=e.vec2(be.pos.x-S.pos.x,be.pos.y-S.pos.y).len();Oe<ue&&(ue=Oe,W=be)});const Le=E?$:W.pickupRadius;if(!S.magnetizing&&ue<=Le&&(S.magnetizing=!0,S.targetPlayer=W),ue<=rn.COLLECTION_RADIUS&&!S.collected){if(de()&&!ve())return;S.collected=!0,ap(),xs(S.value),W&&W.runStats&&(W.runStats.creditsPickedUp+=S.value),de()&&j_(S.value),S.isFlyingToUI=!0}}),a.pickups.getNearby(f.pos.x,f.pos.y,f.pickupRadius*1.5).forEach(S=>{if(!S.is||!S.is("powerupWeaponPickup")||S.collected)return;const W=e.vec2(f.pos.x-S.pos.x,f.pos.y-S.pos.y).len();if(!S.magnetizing&&W<=f.pickupRadius&&(S.magnetizing=!0,S.targetPlayer=f),W<=rn.COLLECTION_RADIUS&&!S.collected){if(de()&&!ve())return;S.collected=!0,ap(),de()&&ve()?(e.get("player").forEach(Te=>{gc(Te,S.powerupKey)}),L_(S.powerupKey)):gc(f,S.powerupKey);const ue=Si[S.powerupKey],Le=e.add([e.text(ue.icon,{size:32}),e.pos(f.pos.x,f.pos.y-30),e.color(...ue.color),e.anchor("center"),e.z(w.UI_TEXT+1),e.opacity(1)]);let be=0;Le.onUpdate(()=>{be+=e.dt(),Le.pos.y-=50*e.dt(),Le.opacity=Math.max(0,1-be/.8),be>=.8&&e.destroy(Le)}),e.destroy(S)}})}));let gt=null,Ft=null,ei=0,uo=null,$s=!1;const ru=.5,Cy=10;de()&&!ve()&&(Ue("door_progress",E=>{if(E.clear){Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt),Ft=null,gt=null;return}(!Ft||!Ft.exists())&&(Ft=e.add([e.circle(20),e.pos(E.doorX,E.doorY),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),gt=e.add([e.circle(18),e.pos(E.doorX,E.doorY),e.anchor("center"),e.color(E.isForced?255:100,E.isForced?200:255,E.isForced?0:100),e.opacity(0),e.z(201),"doorProgress"])),gt&&gt.exists()&&(gt.opacity=E.progress,gt.scale=e.vec2(E.progress,E.progress),gt.color=e.rgb(E.isForced?255:100,E.isForced?200:255,E.isForced?0:100))}),Ue("barrel_damage",E=>{const $=ip(E.x,E.y);$&&$.exists()&&!$.isExploding&&($.currentHealth=E.currentHealth,$.updateHealthBar())}),Ue("barrel_explode",E=>{const $=ip(E.x,E.y);$&&$.exists()&&!$.isExploding&&$.explode()})),s.updates.push(e.onUpdate(()=>{!f.exists()||e.paused||r||va()||de()&&!ve()||(e.get("door").forEach(E=>{if(!(!E.open||r||E.isSpawnDoor||E.blocked))if(h>1){let $=!1,Y=!0;x.forEach((W,ue)=>{if(!W||!W.exists()||W.isDead||W.hp()<=0)return;const be=e.vec2(W.pos.x-E.pos.x,W.pos.y-E.pos.y).len()<=40;ue===0&&($=be),be||(Y=!1)});const K=Y||$,X=$&&!Y,S=X?Cy:ru;if(K){(uo!==E||$s!==X)&&(ei=0,uo=E,$s=X,Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt),Ft=e.add([e.circle(20),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),gt=e.add([e.circle(18),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(X?255:100,X?200:255,X?0:100),e.opacity(0),e.z(201),"doorProgress"])),ei+=e.dt();const W=Math.min(ei/S,1);gt&&gt.exists()&&(gt.opacity=W,gt.scale=e.vec2(W,W)),de()&&Je("door_progress",{doorX:E.pos.x,doorY:E.pos.y,progress:W,isForced:X}),W>=1&&(r=!0,wc(),Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt),uo=null,de()&&Je("door_progress",{progress:0,clear:!0}),lu(E.direction))}else uo===E&&(ei=0,uo=null,$s=!1,Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt),de()&&Je("door_progress",{progress:0,clear:!0}))}else{if(f.isDead||f.hp()<=0)return;if(e.vec2(f.pos.x-E.pos.x,f.pos.y-E.pos.y).len()<=40){uo!==E&&(ei=0,uo=E,$s=!1,Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt),Ft=e.add([e.circle(20),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),gt=e.add([e.circle(18),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(100,255,100),e.opacity(0),e.z(201),"doorProgress"])),ei+=e.dt();const K=Math.min(ei/ru,1);gt&&gt.exists()&&(gt.opacity=K,gt.scale=e.vec2(K,K)),K>=1&&(r=!0,wc(),Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt),uo=null,lu(E.direction))}else uo===E&&(ei=0,uo=null,$s=!1,Ft&&Ft.exists()&&e.destroy(Ft),gt&&gt.exists()&&e.destroy(gt))}}),!uo&&Ft&&Ft.exists()&&(e.destroy(Ft),e.destroy(gt)))}));function _y(){if(!f.exists())return;const E=e.width()/2,$=e.height()/2,Y=5,K=3,X=B?3:1,S=B?4:1,W=o*.5,ue=Math.floor((Y+W)*X),Le=Math.floor((K+W)*S),be=u();for(let Oe=0;Oe<ue;Oe++){const Te=Math.PI*2*Oe/ue+(be?be.next():Math.random())*.3,Ye=40+(be?be.next():Math.random())*60,Ne=E+Math.cos(Te)*Ye,Ct=$+Math.sin(Te)*Ye,kt=Math.floor(1+o*.5);fr(e,Ne,Ct,kt)}for(let Oe=0;Oe<Le;Oe++){const Te=Math.PI*2*Oe/Le+(be?be.next():Math.random())*.3+.5,Ye=50+(be?be.next():Math.random())*70,Ne=E+Math.cos(Te)*Ye,Ct=$+Math.sin(Te)*Ye,kt=Math.floor(1+o*.3),on=Da();pr(e,Ne,Ct,kt,on)}if(B){const Oe=Object.keys(Si),Te=1+Math.floor((be?be.next():Math.random())*2);for(let Ye=0;Ye<Te;Ye++){const Ne=(be?be.next():Math.random())*Math.PI*2,Ct=80+(be?be.next():Math.random())*40,kt=E+Math.cos(Ne)*Ct,on=$+Math.sin(Ne)*Ct,ti=Oe[Math.floor((be?be.next():Math.random())*Oe.length)];Kf(e,kt,on,ti)}}}function au(){n.roomCleared=!0,n.clearRoom(),de()&&ve()&&W_(),h>1&&d(),Lt.roomsCleared++;const E=f.exists()?f.level:1;if(ba(e,{floor:J.currentFloor,enemiesKilled:Lt.enemiesKilled,bossesKilled:Lt.bossesKilled,level:E,currencyEarned:0}),J.floorMap&&F&&J.floorMap.markRoomCleared(F.position.x,F.position.y),c.forEach(K=>{K.exists()&&!K.blocked&&(K.open=!0,K.isSpawnDoor=!1,K.updateVisual())}),B){const K=c.find(X=>X.direction==="north");K&&K.exists()&&(K.blocked=!1,K.open=!0,K.isSpawnDoor=!1,K.isFloorExit=!0,K.updateVisual())}J.minimap&&J.minimap.update(),(!de()||ve())&&_y();const $=B?`BOSS DEFEATED! Floor ${o} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",Y=e.add([e.text($,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{Y.exists()&&e.destroy(Y)})}function lu(E){J.allPlayerStats=x.map((S,W)=>!S||!S.exists()?null:{slotIndex:S.slotIndex!==void 0?S.slotIndex:W,playerName:S.playerName,isRemote:S.isRemote||!1,isDead:S.isDead||!1,level:S.level,xp:S.xp,xpToNext:S.xpToNext,maxHealth:S.maxHealth,currentHP:S.hp(),speed:S.slowed?S.originalSpeed:S.speed,originalSpeed:S.originalSpeed||S.speed,slowed:!1,fireRate:S.fireRate,projectileSpeed:S.projectileSpeed,projectileDamage:S.projectileDamage,pickupRadius:S.pickupRadius,xpMultiplier:S.xpMultiplier||1,characterKey:S.characterKey,dodgeChance:S.dodgeChance||0,damageReduction:S.damageReduction||0,fireDotMultiplier:S.fireDotMultiplier||1,invulnerableDuration:S.invulnerableDuration||1,projectileCount:S.projectileCount||1,piercing:S.piercing||0,obstaclePiercing:S.obstaclePiercing||0,critChance:S.critChance||0,critDamage:S.critDamage||2,spreadAngle:S.spreadAngle||0,defense:S.defense||0,weaponRange:S.weaponRange||600,weapons:S.weapons||[],passiveUpgrades:S.passiveUpgrades||[],upgradeStacks:S.upgradeStacks||{},selectedUpgrades:S.selectedUpgrades?Array.from(S.selectedUpgrades):[],activeSynergies:S.activeSynergies?Array.from(S.activeSynergies):[],piercingDamageBonus:S.piercingDamageBonus||1,characterData:S.characterData,weaponDef:S.weaponDef,baseProjectileDamage:S.baseProjectileDamage,baseFireRate:S.baseFireRate,baseProjectileSpeed:S.baseProjectileSpeed,pendingLevelUps:S.pendingLevelUps||[],powerupWeapon:S.powerupWeapon||null,powerupAmmo:S.powerupAmmo!==void 0?S.powerupAmmo:null,powerupDuration:S.powerupDuration!==void 0?S.powerupDuration:null,originalWeapon:S.originalWeapon||null,weaponKey:S.weaponKey,weaponCategory:S.weaponCategory,orbitRadius:S.orbitRadius,rotationSpeed:S.rotationSpeed,explosionRadius:S.explosionRadius,explosionDamage:S.explosionDamage,chainRange:S.chainRange,maxJumps:S.maxJumps,chainDamageReduction:S.chainDamageReduction,thornsPercent:S.thornsPercent||0,thornsIgnoreArmor:S.thornsIgnoreArmor||!1,runStats:S.runStats||{kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}).filter(S=>S!==null);const $=J.allPlayerStats.find(S=>!S.isRemote);$&&(J.playerStats=$);const Y={north:"south",south:"north",west:"east",east:"west"};J.entryDirection=Y[E]||null;const X={north:"up",south:"down",east:"right"}[E];if(J.floorMap)if(F&&F.isBossRoom&&F.cleared){if(o++,Lu(o-1)){const ue=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{ue.exists()&&e.destroy(ue)})}J.floorMap=null,J.entryDirection=null,i=1,n.nextFloor()}else X?J.floorMap.moveToRoom(X)?i=J.floorMap.getVisitedCount():(console.error("[Game] Failed to move in floor map - should not happen!"),i++):(console.warn("[Game] Invalid door direction:",E),i++),n.nextRoom();else if(i++,i>3){if(o++,Lu(o-1)){const W=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{W.exists()&&e.destroy(W)})}i=1,J.entryDirection=null,n.nextFloor()}else n.nextRoom();if(J.currentFloor=o,J.currentRoom=i,de()&&ve()){const S=ya(),W=mr(o,S);J.roomTemplateKey=W.key,console.log("[Multiplayer] Host selected next room template:",W.key),Q_(J.entryDirection,J.allPlayerStats,X,o,J.roomTemplateKey)}e.go("game")}f.onDeath(()=>{if(f.orbitalOrbs&&(f.orbitalOrbs.forEach(X=>{X.exists()&&e.destroy(X)}),f.orbitalOrbs=[]),f.glowEffect&&f.glowEffect.exists()&&(e.destroy(f.glowEffect),f.glowEffect=null),h>1&&(de()&&f.slotIndex!==void 0&&k_(f.slotIndex),f.isDead=!0,f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5),!ve()||x.some(S=>S&&S.exists()&&S.hp()>0&&!S.isDead)))return;const E=ec(Lt),$={...Lt,level:f.level,currencyEarned:E};kl($),xs(E);const Y=Lt.startTime?Math.floor((Date.now()-Lt.startTime)/1e3):0;ob({character:f.characterData?.key||"survivor",weapon:f.weaponKey||"pistol",floorsReached:Lt.floorsReached,roomsCleared:Lt.roomsCleared,enemiesKilled:Lt.enemiesKilled,bossesKilled:Lt.bossesKilled,level:f.level||1,currencyEarned:E,duration:Y,deathCause:"Enemy",upgrades:f.selectedUpgrades?Array.from(f.selectedUpgrades):[],synergies:f.activeSynergies?Array.from(f.activeSynergies):[]}),ba(e);const K=x.filter(X=>X&&X.exists()).map(X=>({name:X.playerName||"Player",level:X.level||1,characterData:X.characterData,kills:X.runStats?.kills||0,deaths:X.runStats?.deaths||0,revives:X.runStats?.revives||0,damageTaken:X.runStats?.damageTaken||0,damageDealt:X.runStats?.damageDealt||0,xpCollected:X.runStats?.xpPickedUp||0,creditsPickedUp:X.runStats?.creditsPickedUp||0,bossesKilled:X.runStats?.bossesKilled||0}));de()&&ve()&&Qf(Lt,E,K),de()&&gs(),e.go("gameOver",{runStats:{...Lt},currencyEarned:E,partyStats:K,isDailyRun:J.isDailyRun,dailyCharacter:J.dailyCharacter})});const Wl=e.add([e.rect(300,260),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_DARK),e.opacity(.95),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(2e3),"pauseOverlay"]),$l=e.add([e.text("PAUSED",{size:Q.H1*2}),e.pos(e.width()/2,e.height()/2-95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2001),"pauseText"]),la=e.height()/2,{LG:cu,SM:du}=Mi.BUTTON,hu=e.add([e.rect(cu.width,cu.height),e.pos(e.width()/2,la-20),e.anchor("center"),e.color(...y.SUCCESS),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("RESUME",{size:Q.H2}),e.pos(e.width()/2,la-20),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]);const uu=e.add([e.rect(du.width,du.height),e.pos(e.width()/2,la+45),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("QUIT",{size:Q.SMALL}),e.pos(e.width()/2,la+45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]),Wl.hidden=!0,$l.hidden=!0,e.get("pauseButton").forEach(E=>E.hidden=!0);const ca=E=>{E?(BA(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=_e)):(cp(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(_e=e.gameData.weaponDetailSavedState,Tt.hidden=!_e,xe.hidden=!_e,Ze.hidden=!_e,re.hidden=!_e,Re.hidden=!_e,ke.hidden=!_e,e.gameData.weaponDetailSavedState=void 0)),Wl.hidden=!E,$l.hidden=!E,e.get("pauseButton").forEach($=>$.hidden=!E)};e.gameData.updatePauseUI=ca,hu.onClick(()=>{!e.paused||hu.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(_e=e.gameData.weaponDetailSavedState,Tt.hidden=!_e,xe.hidden=!_e,Ze.hidden=!_e,re.hidden=!_e,Re.hidden=!_e,ke.hidden=!_e,e.gameData.weaponDetailSavedState=void 0),cp(),Wl.hidden=!0,$l.hidden=!0,e.get("pauseButton").forEach(E=>E.hidden=!0))}),uu.onClick(()=>{if(!(!e.paused||uu.hidden))if(de())if(ve())P_(),gs(),J.currentFloor=1,J.currentRoom=1,J.playerStats=null,e.go("menu");else{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Leave party and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const E=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const $=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const Y=[],K=()=>{Y.forEach(S=>S.cancel()),e.get("confirmDialog").forEach(S=>e.destroy(S)),gs(),J.currentFloor=1,J.currentRoom=1,J.playerStats=null,e.go("menu")},X=()=>{Y.forEach(S=>S.cancel()),e.get("confirmDialog").forEach(S=>e.destroy(S))};E.onClick(K),$.onClick(X),Y.push(e.onKeyPress("y",K)),Y.push(e.onKeyPress("enter",K)),Y.push(e.onKeyPress("n",X)),Y.push(e.onKeyPress("escape",X))}else if(Un("gameplay","confirmBeforeQuit")!==!1){e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Abandon run and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const $=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const Y=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(50,100,50),e.outline(2,e.rgb(100,150,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const K=[],X=()=>{K.forEach(W=>W.cancel()),e.get("confirmDialog").forEach(W=>e.destroy(W)),J.currentFloor=1,J.currentRoom=1,J.playerStats=null,e.go("menu")},S=()=>{K.forEach(W=>W.cancel()),e.get("confirmDialog").forEach(W=>e.destroy(W))};$.onClick(X),Y.onClick(S),K.push(e.onKeyPress("y",X)),K.push(e.onKeyPress("enter",X)),K.push(e.onKeyPress("n",S)),K.push(e.onKeyPress("escape",S))}else J.currentFloor=1,J.currentRoom=1,J.playerStats=null,e.go("menu")}),s.keyPresses.push(e.onKeyPress("m",()=>{J.minimap&&!e.paused&&J.minimap.toggle()})),s.keyPresses.push(e.onKeyPress("escape",()=>{va()||(de()?ve()?(e.paused=!e.paused,Y_(e.paused),ca(e.paused)):G_(!e.paused):(e.paused=!e.paused,ca(e.paused)))}));const fu=()=>{de()||e.paused||va()||(e.paused=!0,ca(!0))};window.addEventListener("blur",fu),e.onSceneLeave(()=>{window.removeEventListener("blur",fu)}),e.onSceneLeave(()=>{if(s.updates.forEach(E=>{try{E&&E.cancel&&E.cancel()}catch($){console.warn("[Game] Error canceling update handler:",$)}}),s.keyPresses.forEach(E=>{try{E&&E.cancel&&E.cancel()}catch($){console.warn("[Game] Error canceling keypress handler:",$)}}),!ve()&&de()){try{Xt("room_transition"),Xt("room_completed"),Xt("game_over")}catch(E){console.warn("[Game] Error unregistering message handlers:",E)}Sa=!1}J.minimap&&(J.minimap.destroy(),J.minimap=null),iA()})})}const jt={LEVEL:"level",CHARACTER:"character",ACHIEVEMENT:"achievement"},es={default:{id:"default",name:"Rookie",icon:"",color:[200,200,200],category:jt.LEVEL,unlockCondition:{type:"default"},description:"Everyone starts somewhere."},veteran:{id:"veteran",name:"Veteran",icon:"",color:[100,200,255],category:jt.LEVEL,unlockCondition:{type:"level",value:10},description:"A seasoned competitor with many battles under their belt."},elite:{id:"elite",name:"Elite",icon:"",color:[255,200,100],category:jt.LEVEL,unlockCondition:{type:"level",value:25},description:"Among the top performers in the arena."},legend:{id:"legend",name:"Legend",icon:"",color:[255,100,255],category:jt.LEVEL,unlockCondition:{type:"level",value:50},description:"A living legend whose name echoes through the halls."},champion:{id:"champion",name:"Champion",icon:"",color:[255,215,0],category:jt.LEVEL,unlockCondition:{type:"level",value:75},description:"A true champion who has conquered all challenges."},immortal:{id:"immortal",name:"Immortal",icon:"",color:[200,255,255],category:jt.LEVEL,unlockCondition:{type:"level",value:100},description:"Transcended mortality. A god among players."},survivor:{id:"survivor",name:"Survivor",icon:"",color:[100,200,100],category:jt.CHARACTER,unlockCondition:{type:"character",value:"survivor"},description:"The default hero. Never gives up."},berserker:{id:"berserker",name:"Berserker",icon:"",color:[255,100,100],category:jt.CHARACTER,unlockCondition:{type:"character",value:"berserker"},description:"Rage incarnate. Pain is just fuel."},ranger:{id:"ranger",name:"Ranger",icon:"",color:[100,255,150],category:jt.CHARACTER,unlockCondition:{type:"character",value:"ranger"},description:"Swift and precise. Death from a distance."},mage:{id:"mage",name:"Mage",icon:"",color:[200,100,255],category:jt.CHARACTER,unlockCondition:{type:"character",value:"mage"},description:"Master of the arcane arts."},tank:{id:"tank",name:"Tank",icon:"",color:[150,150,200],category:jt.CHARACTER,unlockCondition:{type:"character",value:"tank"},description:"An immovable wall. Nothing gets through."},assassin:{id:"assassin",name:"Assassin",icon:"",color:[150,100,150],category:jt.CHARACTER,unlockCondition:{type:"character",value:"assassin"},description:"Silent. Deadly. Gone before you know it."},boss_slayer:{id:"boss_slayer",name:"Boss Slayer",icon:"",color:[255,180,50],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:100},description:"Has ended the reign of 100 bosses."},speedrunner:{id:"speedrunner",name:"Speedrunner",icon:"",color:[255,255,100],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"fastestRunTime",value:600,comparison:"lessThan"},description:"Completed a run in under 10 minutes."},perfectionist:{id:"perfectionist",name:"Perfectionist",icon:"",color:[255,255,255],category:jt.ACHIEVEMENT,unlockCondition:{type:"achievement",value:"flawless_run"},description:"Completed a run without taking damage."},grinder:{id:"grinder",name:"Grinder",icon:"",color:[200,150,100],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:100},description:"Has completed 100 runs. Dedication personified."},collector:{id:"collector",name:"Collector",icon:"",color:[255,215,0],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:1e4},description:"Has earned 10,000 credits total."},exterminator:{id:"exterminator",name:"Exterminator",icon:"",color:[200,50,50],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e4},description:"Has eliminated 10,000 enemies."},explorer:{id:"explorer",name:"Explorer",icon:"",color:[100,180,100],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:5},description:"Reached floor 5. The journey begins."},delver:{id:"delver",name:"Delver",icon:"",color:[180,140,100],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:10},description:"Reached floor 10. Deep into the unknown."},abyssal:{id:"abyssal",name:"Abyssal",icon:"",color:[80,50,150],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:20},description:"Reached floor 20. Touched the abyss."},slayer:{id:"slayer",name:"Slayer",icon:"",color:[200,80,80],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:25},description:"Has slain 25 bosses."},warrior:{id:"warrior",name:"Warrior",icon:"",color:[150,150,200],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e3},description:"Has defeated 1,000 enemies."},rich:{id:"rich",name:"Wealthy",icon:"",color:[100,200,255],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:5e4},description:"Has earned 50,000 credits. Living large."},dedicated:{id:"dedicated",name:"Dedicated",icon:"",color:[150,100,200],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:50},description:"Has completed 50 runs. Committed to the grind."},marathoner:{id:"marathoner",name:"Marathoner",icon:"",color:[100,200,150],category:jt.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRoomsCleared",value:500},description:"Has cleared 500 rooms. Endurance personified."}};function Rd(e){return es[e]||null}function GT(){return Object.values(es)}function KT(e,t){const n=es[e];if(!n)return!1;const o=n.unlockCondition;switch(o.type){case"default":return!0;case"level":return Math.floor(Math.sqrt((t.totalXP||0)/100))+1>=o.value;case"character":return t.unlocks?.characters?.includes(o.value)||!1;case"achievement":return t.achievements?.includes(o.value)||!1;case"stat":const s=t.stats?.[o.stat]||0;return o.comparison==="lessThan"?s>0&&s<o.value:s>=o.value;default:return!1}}function VT(e){const t=es[e];if(!t)return"Unknown";const n=t.unlockCondition;switch(n.type){case"default":return"Unlocked by default";case"level":return`Reach Level ${n.value}`;case"character":return`Unlock the ${n.value.charAt(0).toUpperCase()+n.value.slice(1)} character`;case"achievement":return`Complete the "${n.value}" achievement`;case"stat":const i={totalBossesKilled:"bosses killed",totalRuns:"runs completed",totalCurrencyEarned:"credits earned",totalEnemiesKilled:"enemies killed",fastestRunTime:"second run"}[n.stat]||n.stat;return n.comparison==="lessThan"?`Complete a run in under ${Math.floor(n.value/60)} minutes`:`${n.value.toLocaleString()} ${i}`;default:return"Unknown condition"}}const ry="superSmashTextyDailyRuns",WT=["survivor","scout","tank","sniper","pyro","bomber","engineer","vampire","berserker","ghost"];function bo(){return new Date().toISOString().split("T")[0]}function ay(e=null){const t=e||bo();return s_(t+"SuperSmashTexty")}function tu(e=null){const t=ay(e);return new Vo(t).choose(WT)}function $T(){return tu(bo())}function Xl(){try{const e=localStorage.getItem(ry);return e?JSON.parse(e):{completedDays:{},attempts:{}}}catch(e){return console.warn("[DailyRuns] Failed to parse daily run data:",e),{completedDays:{},attempts:{}}}}function jT(e){try{localStorage.setItem(ry,JSON.stringify(e))}catch(t){console.warn("[DailyRuns] Failed to save daily run data:",t)}}function JT(){const e=Xl(),t=bo();return!!e.completedDays[t]}function QT(e){return Xl().completedDays[e]||null}function ZT(){return QT(bo())}function kT(e){const t=Xl(),n=bo(),o={date:n,score:e.score||0,floor:e.floor||1,character:e.character||$T(),duration:e.duration||0,completedAt:Date.now()};return t.completedDays[n]=o,jT(t),console.log("[DailyRuns] Marked daily completed:",o),o}function eM(){const e=Xl(),t=bo();return e.attempts[t]||0}function tM(){const e=bo(),t=ay(e),n=tu(e),o=JT(),i=ZT(),s=eM();return{date:e,seed:t,character:n,completed:o,completion:i,attempts:s}}const Wn={LEFT_COLUMN_X:20,LEFT_COLUMN_WIDTH:200,RIGHT_COLUMN_WIDTH:200,TOP_MARGIN:20};function us(e,t,n,o,i=Hn.WIDTH,s=Hn.HEIGHT,r=Q.BUTTON){const l=y.SECONDARY,c=y.SECONDARY_HOVER,d=y.TEXT_PRIMARY,a=y.BORDER,h=e.add([e.rect(i,s),e.pos(n,o),e.anchor("center"),e.color(...l),e.outline(2,e.rgb(...a)),e.area(),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS),"menuButton"]),u=Wr(t),p=e.add([e.text(u,{size:r}),e.pos(n,o),e.anchor("center"),e.color(...d),e.fixed(),e.scale(1),e.z(w.UI_TEXT),"menuButtonText"]);return h.originalColor=[...l],h.hoverColor=[...c],h.borderColor=[...a],h.isHovered=!1,h.disabled=!1,h.label=p,h.labels=[p],h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,tt()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...y.BORDER_HOVER),h.scale=e.vec2(Hn.HOVER_SCALE,Hn.HOVER_SCALE),p.scale=e.vec2(Hn.HOVER_SCALE,Hn.HOVER_SCALE))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),p.scale=e.vec2(1,1))}),h.setDisabled=g=>{h.disabled=g,g?(h.color=e.rgb(...y.BG_DISABLED),p.color=e.rgb(...y.TEXT_DISABLED)):(h.color=e.rgb(...h.originalColor),p.color=e.rgb(...d))},h}function Dd(e,t,n){t/=100,n/=100;const o=(1-Math.abs(2*n-1))*t,i=o*(1-Math.abs(e/60%2-1)),s=n-o/2;let r=0,l=0,c=0;return e>=0&&e<60?(r=o,l=i,c=0):e>=60&&e<120?(r=i,l=o,c=0):e>=120&&e<180?(r=0,l=o,c=i):e>=180&&e<240?(r=0,l=i,c=o):e>=240&&e<300?(r=i,l=0,c=o):e>=300&&e<360&&(r=o,l=0,c=i),[Math.round((r+s)*255),Math.round((l+s)*255),Math.round((c+s)*255)]}function nM(e){return Dd(e,80,15)}function oM(e){e.scene("menu",()=>{qm();const t=Cd();Ym(t.audio.masterVolume),jm(t.audio.musicVolume),Gm(t.audio.sfxVolume),t.audio.uiSounds!==void 0&&Km(t.audio.uiSounds),t.audio.combatSounds!==void 0&&Vm(t.audio.combatSounds);let n=!1;const o=()=>{n||(n=!0,EA(),dp())};e.onClick(o),e.onKeyPress(o),dp();const i=Wi(),s=e.width()-Wn.RIGHT_COLUMN_WIDTH-Wn.LEFT_COLUMN_X,r=e.width()/2;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(w.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...y.BORDER),e.fixed(),e.z(w.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...y.BORDER),e.fixed(),e.z(w.UI_BACKGROUND)]);const l=Wn.LEFT_COLUMN_X,c=Wn.TOP_MARGIN+50,d=Wn.LEFT_COLUMN_WIDTH,a=75,h=e.add([e.rect(d,a),e.pos(l,c),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_BACKGROUND),"profileCard"]),u=Rd(Fs())||es.default,p=45,g=l+32,A=c+a/2;e.add([e.rect(p,p),e.pos(g,A),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...u.color||[200,200,200])),e.fixed(),e.z(w.UI_BACKGROUND+1)]),e.add([e.text(u.icon,{size:24}),e.pos(g,A),e.anchor("center"),e.color(...u.color||[200,200,200]),e.fixed(),e.z(w.UI_TEXT)]);const m=Yn(),C=m.length>16?m.substring(0,16)+"..":m,I=g+p/2+10;e.add([e.text(C,{size:Q.SMALL}),e.pos(I,c+15),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);const R=_i();e.add([e.text(`Lv.${R}`,{size:Q.SMALL-2}),e.pos(I,c+32),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);const f=Qd(),N=d-75,b=8,T=I,x=c+50;e.add([e.rect(N,b),e.pos(T,x),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(w.UI_BACKGROUND+1)]);const M=Math.max(2,N*f);e.add([e.rect(M,b-2),e.pos(T+1,x),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(w.UI_ELEMENTS)]),e.add([e.text(`${Math.round(f*100)}%`,{size:9}),e.pos(T+N/2,x),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),h.onClick(()=>{Gt(),e.go("profile")}),h.onHoverUpdate(()=>{h.color=e.rgb(...y.BG_LIGHT)}),h.onHoverEnd(()=>{h.color=e.rgb(...y.BG_MEDIUM)}),Dm(e);const _=Wn.LEFT_COLUMN_X,O=c+a+10,P=Wn.LEFT_COLUMN_WIDTH,z=24,U=3,F=8,B=F+z*4+U*3+87;e.add([e.rect(P,B),e.pos(_,O),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const D=O+F,q=[];function G(){q.forEach(ce=>{ce.forEach(ze=>{ze.exists()&&e.destroy(ze)})}),q.length=0,YC().forEach((ce,ze)=>{const me=D+ze*(z+U),Ke=[],Et=!ce.isEmpty&&!ce.isLocal,Bt=e.add([e.rect(P-16,z),e.pos(_+8,me),e.color(...ce.isEmpty?y.BG_DARK:y.BG_LIGHT),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.UI_BACKGROUND+1),Et?e.area():null,"partySlotUI"].filter(Boolean));Ke.push(Bt),Et&&(Bt.onClick(()=>{Gt(),ZC(ze,Ht=>{Ht?e.go("profile",{externalProfile:Ht}):console.warn("Failed to load profile for slot",ze)})}),Bt.onHoverUpdate(()=>{Bt.color=e.rgb(80,90,110)}),Bt.onHoverEnd(()=>{Bt.color=e.rgb(...y.BG_LIGHT)}));let St=`${ce.slotNumber}`;ce.isEmpty||(St=(Rd(ce.selectedPortrait)||es.default).icon);const Sn=e.add([e.text(St,{size:ce.isEmpty?Q.SMALL:Q.SMALL+2}),e.pos(_+18,me+z/2),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);if(Ke.push(Sn),!ce.isEmpty){const Ht=e.add([e.text(`${ce.playerLevel}`,{size:8}),e.pos(_+9,me+z/2+6),e.anchor("botleft"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT+1),"partySlotUI"]);Ke.push(Ht)}if(!ce.isEmpty){const Ht=ln[ce.selectedCharacter]||ln.survivor,Zo=e.add([e.text(Ht.char,{size:Q.SMALL}),e.pos(_+38,me+z/2),e.anchor("left"),e.color(...Ht.color),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);Ke.push(Zo)}const ht=e.add([e.text(ce.playerName.substring(0,16),{size:Q.SMALL-2}),e.pos(_+(ce.isEmpty?32:55),me+z/2),e.anchor("left"),e.color(...ce.isEmpty?y.TEXT_DISABLED:ce.isLocal?y.GOLD:y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);if(Ke.push(ht),!ce.isEmpty){const Ht=ce.isReady?"":"",Zo=ce.isReady?y.SUCCESS:y.TEXT_DISABLED,ss=e.add([e.text(Ht,{size:Q.SMALL-2}),e.pos(_+P-14,me+z/2),e.anchor("center"),e.color(...Zo),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);Ke.push(ss);const rs=JC(ze);if(rs){const Yl=rs==="exclamation"?"!":"",Gl=rs==="exclamation"?[255,255,0]:[255,100,150],co=e.add([e.text(Yl,{size:Q.SMALL+2}),e.pos(_+P-28,me+z/2),e.anchor("center"),e.color(...Gl),e.fixed(),e.z(w.UI_TEXT+1),"partySlotUI"]);Ke.push(co)}}if(ce.isDisconnected){const Ht=e.add([e.text("",{size:Q.SMALL-2}),e.pos(_+P-28,me+z/2),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);Ke.push(Ht)}q.push(Ke)})}G();let Z=0;e.onUpdate(()=>{Z+=e.dt(),Z>=1&&(Z=0,G(),typeof xe=="function"&&xe())});const le=D+4*(z+U)+6;e.add([e.text("Code:",{size:Q.SMALL-2}),e.pos(_+8,le),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const ie=zf(),oe=e.add([e.text(ie,{size:Q.SMALL-2}),e.pos(_+P-8,le),e.anchor("right"),e.color(...ie==="OFFLINE"?y.TEXT_DISABLED:y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);let se=ie!=="OFFLINE";oe.onUpdate(()=>{if(!se){const ge=zf();ge&&ge!=="OFFLINE"&&(oe.text=ge,oe.color=e.rgb(...y.GOLD),se=!0)}});const he=le+22;us(e,"JOIN PARTY",_+P/2,he,P-20,28,Q.SMALL).onClick(()=>{Gt(),e.go("joinParty")});const He=he+32;let we=null,De=null,Qe=!1;PC(e);function Ae(){if(Qe)return;Qe=!0,we&&we.exists()&&e.destroy(we),De&&De.exists()&&e.destroy(De);const ge=Hf(),ce=ge?"CANCEL SEARCH":"FIND MATCH",ze=ge?[150,120,50]:[60,80,120],me=ge?[180,150,70]:[80,110,160],Ke=ge?[200,180,80]:[80,120,180],Et=ge?[230,210,110]:[120,160,220],Bt=ge?y.GOLD:y.TEXT_PRIMARY;we=e.add([e.rect(P-20,28),e.pos(_+P/2,He),e.anchor("center"),e.color(...ze),e.outline(2,e.rgb(...Ke)),e.area(),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS),"findMatchButton"]),De=e.add([e.text(ce,{size:Q.SMALL}),e.pos(_+P/2,He),e.anchor("center"),e.color(...Bt),e.fixed(),e.scale(1),e.z(w.UI_TEXT),"findMatchButton"]),we.originalColor=ze,we.hoverColor=me,we.originalOutline=Ke,we.hoverOutline=Et,we.isHovered=!1,we.onHoverUpdate(()=>{we.isHovered||(we.isHovered=!0,tt()),we.color=e.rgb(...we.hoverColor),we.outline.color=e.rgb(...we.hoverOutline),we.scale=e.vec2(Hn.HOVER_SCALE,Hn.HOVER_SCALE),De.scale=e.vec2(Hn.HOVER_SCALE,Hn.HOVER_SCALE)}),we.onHoverEnd(()=>{we.isHovered=!1,we.color=e.rgb(...we.originalColor),we.outline.color=e.rgb(...we.originalOutline),we.scale=e.vec2(1,1),De.scale=e.vec2(1,1)}),we.onClick(()=>{Gt(),Hf()?Hh():LC({onSearchStart:()=>{setTimeout(()=>Ae(),0)},onMatchFound:St=>{console.log("[Menu] Match found!",St?`Joined ${St}`:"We are host"),setTimeout(()=>{Ae(),G()},0)},onError:St=>{console.error("[Menu] Matchmaking error:",St),setTimeout(()=>Ae(),0)},onSearchEnd:()=>{setTimeout(()=>Ae(),0)}})}),Qe=!1}NC()&&Ae();const pt=He+32;let pe=[],Se=null,ae={partySize:0,isReady:!1,countdownActive:!1,countdownSeconds:0};function Xe(ge=!1){const ce=ri(),ze=qf(),me=KC(),Ke=ze.active?Math.ceil(ze.timeRemaining/1e3):0;if(!(!ge&&ae.partySize===ce&&ae.isReady===me&&ae.countdownActive===ze.active&&ae.countdownSeconds===Ke)&&(ae={partySize:ce,isReady:me,countdownActive:ze.active,countdownSeconds:Ke},pe.forEach(Et=>{Et.exists()&&e.destroy(Et)}),pe=[],Se&&Se.exists()&&(e.destroy(Se),Se=null),ce>=2)){const Et=me?[100,150,100]:[60,80,120],Bt=me?[120,180,120]:[80,110,160],St=me?[100,200,100]:[80,120,180],Sn=me?[130,230,130]:[120,160,220],ht=e.add([e.rect(P-20,24),e.pos(_+P/2,pt),e.anchor("center"),e.color(...Et),e.outline(2,e.rgb(...St)),e.area(),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS),"readyButtonUI"]);pe.push(ht);const Ht=e.add([e.text(me?" READY":"READY UP",{size:Q.SMALL-2}),e.pos(_+P/2,pt),e.anchor("center"),e.color(me?150:100,me?255:150,me?150:200),e.fixed(),e.scale(1),e.z(w.UI_TEXT),"readyButtonUI"]);pe.push(Ht),ht.originalColor=Et,ht.hoverColor=Bt,ht.originalOutline=St,ht.hoverOutline=Sn,ht.isHovered=!1,ht.onHoverUpdate(()=>{ht.isHovered||(ht.isHovered=!0,tt()),ht.color=e.rgb(...ht.hoverColor),ht.outline.color=e.rgb(...ht.hoverOutline),ht.scale=e.vec2(Hn.HOVER_SCALE,Hn.HOVER_SCALE),Ht.scale=e.vec2(Hn.HOVER_SCALE,Hn.HOVER_SCALE)}),ht.onHoverEnd(()=>{ht.isHovered=!1,ht.color=e.rgb(...ht.originalColor),ht.outline.color=e.rgb(...ht.originalOutline),ht.scale=e.vec2(1,1),Ht.scale=e.vec2(1,1)}),ht.onClick(()=>{Gt(),GC(),Xe(!0),G()}),ze.active&&(Se=e.add([e.text(`Starting in ${Ke}...`,{size:Q.SMALL-2}),e.pos(_+P/2,pt+20),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT),"countdownUI"]))}}Xe(!0);let qe=0;e.onUpdate(()=>{if(qe+=e.dt(),qe<.1)return;qe=0;const ge=qf();ri()>=2&&Xe(),ge.active&&ge.timeRemaining<=0&&Zi().isHost&&(Gt(),Uf(),e.go("game",{resetState:!0}))});const Ce=Wn.RIGHT_COLUMN_WIDTH,Ve=120,We=s,At=Wn.TOP_MARGIN+50,Nt=tM(),wt=ln[Nt.character]||ln.survivor;e.add([e.rect(Ce,Ve),e.pos(We,At),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]),e.add([e.text("DAILY RUN",{size:Q.SMALL}),e.pos(We+Ce/2,At+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(wt.char,{size:28}),e.pos(We+Ce/2,At+45),e.anchor("center"),e.color(...wt.color),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(wt.name,{size:Q.SMALL-2}),e.pos(We+Ce/2,At+68),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const Pe=ri()>1;if(Nt.completed)e.add([e.text("COMPLETED",{size:Q.SMALL-2}),e.pos(We+Ce/2,At+95),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT)]);else if(Pe)e.add([e.text("SOLO ONLY",{size:Q.SMALL-2}),e.pos(We+Ce/2,At+95),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);else{const ge=e.add([e.rect(Ce-40,28),e.pos(We+Ce/2,At+95),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("PLAY",{size:Q.SMALL}),e.pos(We+Ce/2,At+95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),ge.onClick(()=>{ri()>1||(Gt(),e.go("game",{resetState:!0,isDailyRun:!0,dailyCharacter:Nt.character,dailySeed:Nt.seed,dailyDate:Nt.date}))}),ge.onHoverUpdate(()=>{ge.color=e.rgb(...y.SECONDARY_HOVER)}),ge.onHoverEnd(()=>{ge.color=e.rgb(...y.SECONDARY)})}Xh(e,i);const Ge=At+Ve+15;e.add([e.rect(Wn.RIGHT_COLUMN_WIDTH,100),e.pos(s,Ge),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_BACKGROUND),"leaderboardsPanel"]),e.add([e.text("LEADERBOARDS",{size:Q.SMALL}),e.pos(s+Wn.RIGHT_COLUMN_WIDTH/2,Ge+15),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text("",{size:32}),e.pos(s+Wn.RIGHT_COLUMN_WIDTH/2,Ge+50),e.anchor("center"),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text("VIEW",{size:Q.SMALL-2}),e.pos(s+Wn.RIGHT_COLUMN_WIDTH/2,Ge+80),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const je=e.get("leaderboardsPanel")[0];je&&(je.onClick(()=>{Gt(),e.go("leaderboards")}),je.onHoverUpdate(()=>{je.color=e.rgb(...y.BG_LIGHT)}),je.onHoverEnd(()=>{je.color=e.rgb(...y.BG_MEDIUM)}));const ct=160,at=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],st=[],ut=12,Rt=ct-at.length*ut/2;at.forEach((ge,ce)=>{const ze=e.add([e.text(ge,{size:10,font:"monospace"}),e.pos(r,Rt+ce*ut),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.z(w.UI_TEXT),"titleLine"]);st.push(ze)});let Dt=0;e.onUpdate(()=>{Dt+=e.dt(),st.forEach((ge,ce)=>{const ze=(Dt*50+ce*20)%360,me=Dd(ze,80,60);ge.color=e.rgb(...me);const Ke=Math.sin(Dt*2+ce*.3)*2;ge.pos.y=Rt+ce*ut+Ke,Math.random()<.001&&(ge.pos.x=r+(Math.random()-.5)*10,e.wait(.1,()=>{ge.exists()&&(ge.pos.x=r)}))})});const Yt=310,Pt=55,{XL:Zt,LG:dt}=Mi.BUTTON,Tt=us(e,"ACTION!",r,Yt,Zt.width,Zt.height,Q.H1);Tt.onClick(()=>{if(Tt.disabled)return;Gt(),ri()>1&&Uf(),e.go("game",{resetState:!0})});function xe(){const ge=Zi(),ze=ri()>1&&!ge.isHost;Tt.setDisabled(ze)}xe();const Ze=us(e,"CONTESTANTS",r,Yt+Pt,dt.width,dt.height,Q.H2);Ze.onClick(()=>{Gt(),e.go("characterSelect")});const re=Qo(),Re=ln[re];if(Re){const ge=mo("characters",re)||Re.unlockedByDefault,ce=r+dt.width/2+35,ze=Yt+Pt,me=45,Ke=e.add([e.rect(me,me),e.pos(ce,ze),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_BACKGROUND)]),Et=e.add([e.text(Re.char,{size:28}),e.pos(ce,ze),e.anchor("center"),e.color(...ge?Re.color:y.BG_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);Ke.onClick(()=>{Gt(),e.go("characterSelect")}),Ke.onHoverUpdate(()=>{Ke.color=e.rgb(...y.BG_LIGHT),Et.scale=e.vec2(1.1)}),Ke.onHoverEnd(()=>{Ke.color=e.rgb(...y.BG_MEDIUM),Et.scale=e.vec2(1)})}const ke=us(e,"MERCH",r,Yt+Pt*2,dt.width,dt.height,Q.H2);ke.onClick(()=>{Gt(),e.go("shop")});const _e=us(e,"RATINGS",r,Yt+Pt*3,dt.width,dt.height,Q.H2);_e.onClick(()=>{Gt(),e.go("statistics")});const L=us(e,"OPTIONS",r,Yt+Pt*4,dt.width,dt.height,Q.H2);L.onClick(()=>{Gt(),e.go("settings")});const V=[Tt,Ze,ke,_e,L];let ee=0;e.onUpdate(()=>{ee+=e.dt(),V.forEach((ge,ce)=>{if(!ge.exists()||ge.isHovered)return;const ze=(ee*60+ce*50)%360,me=Dd(ze,70,50),Ke=nM(ze);try{ge.color=e.rgb(me[0],me[1],me[2]),ge.originalColor=me,ge.label&&ge.label.exists()&&(ge.label.color=e.rgb(Ke[0],Ke[1],Ke[2]))}catch{}})});const fe=e.onKeyPress("space",()=>{Tt.disabled||(Gt(),e.go("game",{resetState:!0}))}),nt=e.onKeyPress("c",()=>{tt(),e.go("characterSelect")}),rt=e.onKeyPress("s",()=>{tt(),e.go("shop")}),Vt=e.onKeyPress("o",()=>{tt(),e.go("settings")}),lt=e.onKeyPress("t",()=>{tt(),e.go("statistics")});let It=0;const Wt=.5,fn=e.onKeyPress("q",()=>{const ge=e.time();ge-It<Wt||(It=ge,Yf("exclamation"),G())}),Ee=e.onKeyPress("e",()=>{const ge=e.time();ge-It<Wt||(It=ge,Yf("heart"),G())}),ot=(ge,ce)=>{G()};$C(ot),e.onSceneLeave(()=>{fe.cancel(),nt.cancel(),rt.cancel(),Vt.cancel(),lt.cancel(),fn.cancel(),Ee.cancel(),jC(ot)});for(let ge=0;ge<12;ge++){const ce=e.add([e.text(["*","+",""][Math.floor(Math.random()*3)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(w.PARTICLES)]);ce.speed=15+Math.random()*25,ce.onUpdate(()=>{ce.pos.y+=ce.speed*e.dt(),ce.pos.y>e.height()&&(ce.pos.y=0,ce.pos.x=Math.random()*e.width())})}const bt=["","","",""];for(let ge=0;ge<8;ge++){const ce=e.add([e.text(bt[Math.floor(Math.random()*bt.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.1),e.scale(1),e.z(w.PARTICLES)]);ce.pulseTime=Math.random()*Math.PI*2,ce.pulseSpeed=1+Math.random()*1.5,ce.onUpdate(()=>{ce.pulseTime+=e.dt()*ce.pulseSpeed;const ze=.8+Math.sin(ce.pulseTime)*.2;ce.scale=e.vec2(ze,ze),ce.opacity=.08+Math.abs(Math.sin(ce.pulseTime))*.1})}e.add([e.text("v0.1.169",{size:Q.MICRO}),e.pos(e.width()-10,e.height()-10),e.anchor("botright"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]),e.loop(12,()=>{if(Math.random()<.12){const ge=100+Math.random()*(e.height()-200),ce=Math.random()<.5?1:-1,ze=ce>0?-50:e.width()+50,me=e.add([e.text("$",{size:24}),e.pos(ze,ge),e.color(...y.GOLD),e.area({scale:2.5}),e.anchor("center"),e.scale(1),e.z(w.PARTICLES+1),"goldenEnemy"]);me.speed=150+Math.random()*100,me.direction=ce,me.pulseTime=0,me.onClick(()=>{if(!me.exists())return;xs(1);for(let Et=0;Et<8;Et++){const Bt=Math.PI*2*Et/8,St=e.add([e.text(["$",""][Math.floor(Math.random()*2)],{size:12}),e.pos(me.pos.x,me.pos.y),e.color(...y.GOLD),e.opacity(1),e.z(w.PARTICLES+2)]),Sn=80+Math.random()*60;St.velocity=e.vec2(Math.cos(Bt)*Sn,Math.sin(Bt)*Sn),St.life=.8,St.onUpdate(()=>{St.pos=St.pos.add(St.velocity.scale(e.dt())),St.life-=e.dt(),St.opacity=St.life/.8,St.life<=0&&e.destroy(St)})}const Ke=e.add([e.text("+$1",{size:18}),e.pos(me.pos.x,me.pos.y),e.anchor("center"),e.color(...y.SUCCESS),e.opacity(1),e.z(w.UI_TEXT)]);Ke.life=1.2,Ke.onUpdate(()=>{Ke.pos.y-=40*e.dt(),Ke.life-=e.dt(),Ke.opacity=Ke.life/1.2,Ke.life<=0&&e.destroy(Ke)}),e.destroy(me),e.wait(.1,()=>e.go("menu"))}),me.onUpdate(()=>{me.pos.x+=me.speed*me.direction*e.dt(),me.pulseTime+=e.dt();const Ke=Math.sin(me.pulseTime*8)*.15;me.scale=e.vec2(1+Ke,1+Ke),(me.direction>0&&me.pos.x>e.width()+100||me.direction<0&&me.pos.x<-100)&&e.destroy(me)})}})})}function iM(e){const t=[];for(const[n,o]of Object.entries(ln))o.unlockRequirement?.type==="achievement"&&o.unlockRequirement?.value===e&&t.push({key:n,...o});return t}let Ot={isOpen:!1,elements:[],k:null,onClose:null};function ly(e,t,n=null){Ot.isOpen&&Ca(),Ot.k=e,Ot.isOpen=!0,Ot.onClose=n,Ot.elements=[];const o=Us(),i=Jd(t.id),s=qa(t.id,o),r=so[t.difficulty]||so.normal,l=420,c=400,d=e.width()/2,a=e.height()/2,h=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(w.MODAL-1),e.area(),"achievementModalOverlay"]);Ot.elements.push(h),h.onClick(()=>{Ca()});const u=e.add([e.rect(l,c),e.pos(d,a),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...r)),e.fixed(),e.z(w.MODAL),"achievementModal"]);Ot.elements.push(u);const p=e.add([e.text(t.name,{size:Q.HEADER}),e.pos(d,a-130),e.anchor("center"),e.color(...i?r:y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(p);const g=e.add([e.rect(64,64),e.pos(d,a-70),e.anchor("center"),e.color(i?50:30,i?50:30,i?60:30),e.outline(2,e.rgb(...i?r:y.TEXT_DISABLED)),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(g);const A=e.add([e.text(t.icon,{size:36}),e.pos(d,a-70),e.anchor("center"),e.color(...i?[255,255,255]:[80,80,80]),e.fixed(),e.z(w.MODAL+2),"achievementModal"]);Ot.elements.push(A);const m=e.add([e.text(t.description,{size:Q.BODY,width:l-40}),e.pos(d,a-25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(m);const C=iM(t.id),I=t.unlocks&&t.unlocks.length>0,R=C.length>0;if(R||I){const P=[];if(C.forEach(z=>{P.push(`${z.char} ${z.name}`)}),I&&t.unlocks.forEach(z=>{const U=V0[z],F=ys[z];U?P.push(U.name):F&&P.push(F.name)}),P.length>0){const z=e.add([e.text(`Unlocks: ${P.join(", ")}`,{size:Q.SMALL,width:l-40}),e.pos(d,a+5),e.anchor("center"),e.color(...i?y.SUCCESS:y.GOLD),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(z)}}const N=R||I?a+35:a+25;if(s&&!i){const U=N,F=e.add([e.rect(280,20),e.pos(d,U),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(80,80,100)),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(F);const B=Math.max(4,280*s.progress),D=e.add([e.rect(B,16),e.pos(d-280/2+B/2,U),e.anchor("center"),e.color(...r),e.opacity(.8),e.fixed(),e.z(w.MODAL+2),"achievementModal"]);Ot.elements.push(D);const q=e.add([e.text(`${s.current}/${s.target} (${s.percentage}%)`,{size:Q.SMALL}),e.pos(d,U+25),e.anchor("center"),e.color(...y.TEXT_TERTIARY),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(q)}else if(i){const P=e.add([e.text("UNLOCKED",{size:Q.LABEL}),e.pos(d,N),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(P)}const b=G0(t);if(b>0){const P=N+(i?35:s?55:35),z=e.add([e.text("-- REWARD --",{size:Q.SMALL}),e.pos(d,P),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(z);const U=Tl(),F=e.add([e.text(`${U}${b}`,{size:Q.H2}),e.pos(d,P+25),e.anchor("center"),e.color(...i?y.SUCCESS:y.GOLD),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(F)}const T=t.difficulty.charAt(0).toUpperCase()+t.difficulty.slice(1),x=e.add([e.text(`${T}`,{size:Q.SMALL}),e.pos(d,a+c/2-60),e.anchor("center"),e.color(...r),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(x);const M=e.add([e.rect(80,30),e.pos(d,a+c/2-30),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);Ot.elements.push(M);const _=e.add([e.text("CLOSE",{size:Q.SMALL}),e.pos(d,a+c/2-30),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+2),"achievementModal"]);Ot.elements.push(_),M.onClick(()=>{tt(),Ca()});const O=e.onKeyPress("escape",()=>{Ca()});Ot.escHandler=O}function Ca(){if(!Ot.isOpen)return;const e=Ot.k;e&&(Ot.elements.forEach(t=>{t&&t.exists&&t.exists()&&e.destroy(t)}),Ot.elements=[],Ot.escHandler&&(Ot.escHandler.cancel(),Ot.escHandler=null),Ot.isOpen=!1,Ot.onClose&&(Ot.onClose(),Ot.onClose=null))}function cy(){return Ot.isOpen}const dy={allTime:{publicKey:"696eba6f8f40bb1184b6c60f",privateKey:"YRU5IdY0w0uJvRF8cb9S1A21WwOAek3kyr3RcOYHbdYA"},daily:{publicKey:"696ff2ee8f40bb1184b8cc92",privateKey:"SgdqIaI_fkWUlRVwoWLQlA1yEXBc-33UKZYWPWJcOX6Q"}},sM="https://corsproxy.io/?",rM="http://dreamlo.com/lb";function hy(e){return`${sM}${encodeURIComponent(rM+e)}`}const aM=6e4,Id={allTime:{data:null,timestamp:0},daily:{data:null,timestamp:0}},lM=5e3;function uy(e){return e&&e.replace(/[^a-zA-Z0-9_-]/g,"").substring(0,20)||"Anonymous"}function cM(e){return typeof e=="number"&&e>0&&e<=2e5}async function fy(e,t=lM){const n=new AbortController,o=setTimeout(()=>n.abort(),t);try{const i=await fetch(e,{signal:n.signal});return clearTimeout(o),i}catch(i){throw clearTimeout(o),i}}async function nu(e,t="allTime"){try{if(!cM(e.score))return console.warn("[OnlineLeaderboards] Invalid score, skipping submission:",e.score),!1;const n=dy[t];if(!n)return console.warn("[OnlineLeaderboards] Unknown board type:",t),!1;const o=uy(e.name),i=Math.floor(e.score),s=Math.floor(e.time||0),r=`${e.floor||1}|${e.character||"unknown"}|${e.date||""}`,l=`/${n.privateKey}/add/${encodeURIComponent(o)}/${i}/${s}/${encodeURIComponent(r)}`,c=hy(l);console.log(`[OnlineLeaderboards] Submitting score to ${t}:`,{name:o,score:i,floor:e.floor});const d=await fy(c);return d.ok?(console.log(`[OnlineLeaderboards] Score submitted to ${t} successfully`),Id[t].data=null,Id[t].timestamp=0,!0):(console.warn("[OnlineLeaderboards] Submission failed with status:",d.status),!1)}catch(n){return n.name==="AbortError"?console.warn("[OnlineLeaderboards] Submission timed out"):console.warn("[OnlineLeaderboards] Submission error:",n.message),!1}}async function dM(e){return nu(e,"daily")}function _p(e){const t=(e.text||"").split("|");return{name:e.name||"Anonymous",score:parseInt(e.score,10)||0,time:parseInt(e.seconds,10)||0,floor:parseInt(t[0],10)||1,character:t[1]||"survivor",date:t[2]||""}}async function py(e=10,t="allTime"){try{const n=dy[t];if(!n)return console.warn("[OnlineLeaderboards] Unknown board type:",t),{entries:[],totalCount:0,error:"Unknown board type"};const o=Id[t],i=Date.now();if(o.data&&i-o.timestamp<aM)return console.log(`[OnlineLeaderboards] Using cached ${t} leaderboard`),{entries:o.data.slice(0,e),totalCount:o.data.length,error:null};const s=hy(`/${n.publicKey}/json`);console.log(`[OnlineLeaderboards] Fetching ${t} leaderboard...`);const r=await fy(s);if(!r.ok)throw new Error(`HTTP ${r.status}`);const l=await r.json();let c=[];if(l?.dreamlo?.leaderboard?.entry){const d=l.dreamlo.leaderboard.entry;Array.isArray(d)?c=d.map(_p):c=[_p(d)]}return o.data=c,o.timestamp=i,console.log(`[OnlineLeaderboards] Fetched ${c.length} entries from ${t}`),{entries:c.slice(0,e),totalCount:c.length,error:null}}catch(n){return n.name==="AbortError"?(console.warn("[OnlineLeaderboards] Fetch timed out"),{entries:[],totalCount:0,error:"Connection timed out"}):(console.warn("[OnlineLeaderboards] Fetch error:",n.message),{entries:[],totalCount:0,error:"Could not connect to server"})}}async function hM(e,t){try{const n=await py(1e3);if(n.error)return{rank:null,total:0,error:n.error};const o=uy(e),i=n.entries.findIndex(r=>r.name.toLowerCase()===o.toLowerCase());return i>=0?{rank:i+1,total:n.totalCount,error:null}:{rank:n.entries.filter(r=>r.score>t).length+1,total:n.totalCount+1,error:null}}catch(n){return console.warn("[OnlineLeaderboards] Error getting rank:",n.message),{rank:null,total:0,error:"Could not determine rank"}}}const gy="superSmashTextyLeaderboards",Ac=100,Tc=100;function ql(){try{const e=localStorage.getItem(gy),t=e?JSON.parse(e):null;return{daily:t?.daily||{},allTime:t?.allTime||[],personal:t?.personal||{}}}catch(e){return console.warn("[Leaderboards] Failed to load leaderboards:",e),{daily:{},allTime:[],personal:{}}}}function uM(e){try{localStorage.setItem(gy,JSON.stringify(e))}catch(t){console.warn("[Leaderboards] Failed to save leaderboards:",t)}}function fM(e){const t=e.floorsReached*1e3,n=(e.enemiesKilled||0)*10,o=(e.bossesKilled||0)*500,i=e.duration||0,s=Math.max(0,3e4-Math.floor(i*50));return t+n+o+s}function pM(e){const t=ql(),n=Yn(),o=e.date||bo(),i={name:n,score:e.score||0,floor:e.floor||1,character:e.character||"survivor",time:e.time||0,date:o,timestamp:Date.now()};let s={rank:null,isNewBest:!1,dailyRank:null,isNewPersonalBest:!1};e.isDaily&&(t.daily[o]||(t.daily[o]=[]),t.daily[o].push(i),t.daily[o].sort((c,d)=>d.score-c.score),t.daily[o].length>Ac&&(t.daily[o]=t.daily[o].slice(0,Ac)),s.dailyRank=t.daily[o].findIndex(c=>c.timestamp===i.timestamp&&c.name===i.name)+1,(s.dailyRank===0||s.dailyRank>Ac)&&(s.dailyRank=null)),t.allTime.push(i),t.allTime.sort((c,d)=>d.score-c.score),t.allTime.length>Tc&&(t.allTime=t.allTime.slice(0,Tc)),s.rank=t.allTime.findIndex(c=>c.timestamp===i.timestamp&&c.name===i.name)+1,(s.rank===0||s.rank>Tc)&&(s.rank=null);const r=i.character;t.personal[r]||(t.personal[r]={bestScore:0,bestFloor:0,bestTime:1/0});const l=t.personal[r];return i.score>l.bestScore&&(l.bestScore=i.score,s.isNewBest=!0,s.isNewPersonalBest=!0),i.floor>l.bestFloor&&(l.bestFloor=i.floor,s.isNewPersonalBest=!0),i.floor>=3&&i.time<l.bestTime&&(l.bestTime=i.time,s.isNewPersonalBest=!0),uM(t),console.log("[Leaderboards] Score submitted:",i,"Result:",s),nu(i).catch(c=>{console.warn("[Leaderboards] Online submission failed:",c)}),s}function gM(e=null,t=10){const n=ql(),o=e||bo();return(n.daily[o]||[]).slice(0,t)}function mM(e=10){return ql().allTime.slice(0,e)}function yM(){return ql().personal}function Ap(e){if(e===1/0||e===void 0||e===null)return"--:--";const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}function Pd(e){return(e||0).toLocaleString()}function Tp(e){if(e=Math.max(0,Math.min(1,e)),e<.5){const t=e*2;return[255,Math.round(200*t),50]}else{const t=(e-.5)*2;return[Math.round(255*(1-t)),200+Math.round(55*t),50+Math.round(100*t)]}}function Mc(e,t={}){const{label:n="",value:o=0,maxValue:i=100,x:s=0,y:r=0,width:l=80,color:c=y.PRIMARY,usePercentageColor:d=!1}=t,a=[],h=6,u=o/i,p=d?Tp(u):c,g=e.add([e.text(n,{size:Q.TINY}),e.pos(s,r),e.anchor("topleft"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);a.push(g);const A=e.add([e.rect(l,h),e.pos(s,r+14),e.anchor("topleft"),e.color(...y.BG_DARK),e.outline(1,e.rgb(50,50,60)),e.fixed(),e.z(w.UI_ELEMENTS)]);a.push(A);const m=Math.max(0,(l-2)*u),C=e.add([e.rect(m,h-2),e.pos(s+1,r+15),e.anchor("topleft"),e.color(...p),e.fixed(),e.z(w.UI_ELEMENTS+1)]);a.push(C);const I=e.add([e.text(`${o}`,{size:Q.MICRO}),e.pos(s+l+4,r+10),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);return a.push(I),{elements:a,updateValue:N=>{const b=Math.max(0,Math.min(i,N)),T=b/i;if(C.width=Math.max(0,(l-2)*T),I.text=`${b}`,d){const x=Tp(T);C.color=e.rgb(...x)}},destroy:()=>{a.forEach(N=>{N.exists()&&e.destroy(N)})}}}function xM(e){return Os[e]?.name?Os[e].name:ki[e]?.name?ki[e].name:Io[e]?.name?Io[e].name:e}function vM(e){return Os[e]?.char||ki[e]?.char||Io[e]?.char||"E"}function wM(e){return Os[e]?.color||ki[e]?.color||Io[e]?.color||[255,100,100]}const Mp=["$","","","",""],Rp=[{id:"slayer",title:"Slayer",icon:"",desc:"Most enemy kills",check:e=>e.kills||0,color:[255,100,100]},{id:"collector",title:"Hoarder",icon:"",desc:"Most credits collected",check:e=>e.creditsPickedUp||0,color:[255,215,0]},{id:"bossBuster",title:"Boss Buster",icon:"",desc:"Most bosses defeated",check:e=>e.bossesKilled||0,color:[255,150,50]}];function bM(e){e.scene("gameOver",t=>{Jm(),UA();const n=t?.runStats||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{}},o=t?.currencyEarned||0;Wi(),Vw();const i=Tl(),s=t?.partyStats||[],r=t?.isDailyRun||!1,l=t?.dailyCharacter||null,c=t?.dailyDate||bo(),d=n.startTime?(Date.now()-n.startTime)/1e3:0,a=fM({floorsReached:n.floorsReached||1,enemiesKilled:n.enemiesKilled||0,bossesKilled:n.bossesKilled||0,duration:d}),h=l||Qo(),u=pM({score:a,floor:n.floorsReached||1,character:h,time:d,isDaily:r,date:c}),p=Yn(),g=de(),A={name:p,score:a,floor:n.floorsReached||1,character:h,time:d,date:c};nu(A,"allTime"),r&&dM(A),r&&kT({score:a,floor:n.floorsReached||1,character:h,duration:d});const m=s.length>0?s.reduce((Ee,ot)=>Ee+(ot.creditsPickedUp||0),0):o,C=MT(),I=lb({floorsReached:n.floorsReached||1,enemiesKilled:n.enemiesKilled||0,bossesKilled:n.bossesKilled||0,isDailyRun:r}),f=ab(I).levelsGained>0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(20,15,25),e.opacity(.98),e.fixed(),e.z(w.OVERLAY)]);const N=25;e.add([e.text("BROADCAST TERMINATED",{size:28}),e.pos(e.width()/2,N),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.MODAL)]),e.add([e.text(`SCORE: ${Pd(a)}`,{size:22}),e.pos(e.width()/2,N+32),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL)]),e.add([e.text(`Floor ${n.floorsReached} | ${n.roomsCleared} Rooms | ${n.enemiesKilled} Kills | ${Math.floor(d)}s`,{size:12}),e.pos(e.width()/2,N+54),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL)]);const b=N+75;let T="";r&&u.dailyRank?(T=`Daily #${u.dailyRank}`,u.dailyRank===1&&(T+=" NEW RECORD!")):u.rank&&(T=`All-Time #${u.rank}`,u.isNewBest&&(T+=" PERSONAL BEST!")),T&&e.add([e.text(T,{size:14}),e.pos(e.width()/2-120,b),e.anchor("center"),e.color(...u.isNewBest?y.SUCCESS:y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL)]);const x=e.add([e.text("Global: ...",{size:14}),e.pos(e.width()/2+120,b),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL)]);hM(p,a).then(Ee=>{x.exists()&&(Ee.error?x.text="Global: offline":Ee.rank?(x.text=`Global #${Ee.rank} of ${Ee.total}`,x.color=e.rgb(...y.GOLD)):x.text="Global: unranked")});const M=b+30,_=Math.max(s.length,1),O=s.length>0?s:[{name:p,characterData:{char:"@",color:[255,255,255]},kills:n.enemiesKilled,creditsPickedUp:o,bossesKilled:n.bossesKilled,achievements:C}],P={};if(O.length===1){const Ee=O[0];Rp.forEach(ot=>{ot.check(Ee)>0&&(P[Ee.name]||(P[Ee.name]=[]),P[Ee.name].push(ot))})}else Rp.forEach(Ee=>{let ot=null,bt=0;O.forEach(ge=>{const ce=Ee.check(ge);ce>bt&&(bt=ce,ot=ge)}),ot&&bt>0&&(P[ot.name]||(P[ot.name]=[]),P[ot.name].push(Ee))});const U=Math.min(e.width()-210-30,500),F=20,B=(U-80)/_,D=28,q=80,G=D*7+10;e.add([e.rect(U,G),e.pos(F,M),e.color(30,25,35),e.outline(2,e.rgb(60,50,80)),e.fixed(),e.z(w.MODAL)]);let Z=M+8;O.forEach((Ee,ot)=>{const bt=F+q+ot*B+B/2,ge=Ee.characterData?.char||"@",ce=Ee.characterData?.color||[255,255,255];e.add([e.text(ge,{size:20}),e.pos(bt,Z+3),e.anchor("center"),e.color(...ce),e.fixed(),e.z(w.MODAL+1)]);const ze=_<=2?16:_===3?12:10,me=(Ee.name||`P${ot+1}`).substring(0,ze);e.add([e.text(me,{size:11}),e.pos(bt,Z+20),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL+1)])}),Z+=D+8,[{label:"Kills",getValue:Ee=>Ee.kills||0,color:y.DANGER},{label:"Credits",getValue:Ee=>Ee.creditsPickedUp||0,color:y.GOLD},{label:"Bosses",getValue:Ee=>Ee.bossesKilled||0,color:[255,150,50]}].forEach(Ee=>{e.add([e.text(Ee.label,{size:12}),e.pos(F+10,Z),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]),O.forEach((ot,bt)=>{const ge=F+q+bt*B+B/2,ce=Ee.getValue(ot);e.add([e.text(String(ce),{size:14}),e.pos(ge,Z),e.anchor("center"),e.color(...Ee.color),e.fixed(),e.z(w.MODAL+1)])}),Z+=D}),e.add([e.text("Awards",{size:12}),e.pos(F+10,Z),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]);let ie=null;function oe(Ee,ot){ie&&ie.forEach(Et=>{Et.exists()&&e.destroy(Et)});const bt=220,ge=100,ce=e.width()/2,ze=e.height()/2,me=[];me.push(e.add([e.rect(bt,ge),e.pos(ce,ze),e.anchor("center"),e.color(30,25,40),e.outline(3,e.rgb(...Ee.color)),e.fixed(),e.z(w.MODAL+100)])),me.push(e.add([e.text(Ee.icon,{size:28}),e.pos(ce,ze-28),e.anchor("center"),e.color(...Ee.color),e.fixed(),e.z(w.MODAL+101)])),me.push(e.add([e.text(Ee.title,{size:16}),e.pos(ce,ze),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.MODAL+101)])),me.push(e.add([e.text(Ee.desc,{size:11}),e.pos(ce,ze+18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+101)]));const Ke=_>1?`Earned by ${ot.name}`:"Earned this run";me.push(e.add([e.text(Ke,{size:10}),e.pos(ce,ze+34),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(w.MODAL+101)])),ie=me,e.wait(.1,()=>{const Et=e.onClick(()=>{Et.cancel(),ie&&(ie.forEach(Bt=>{Bt.exists()&&e.destroy(Bt)}),ie=null)})})}O.forEach((Ee,ot)=>{const bt=F+q+ot*B+B/2,ge=P[Ee.name]||[];if(ge.length>0){const me=ge.length*22+(ge.length-1)*4,Ke=bt-me/2+22/2;ge.forEach((Et,Bt)=>{const St=Ke+Bt*26,Sn=e.add([e.rect(22,22),e.pos(St,Z),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...Et.color)),e.area(),e.fixed(),e.z(w.MODAL+1)]);e.add([e.text(Et.icon,{size:12}),e.pos(St,Z),e.anchor("center"),e.color(255,220,100),e.fixed(),e.z(w.MODAL+2)]),Sn.onClick(()=>{tt(),oe(Et,Ee)}),Sn.cursor="pointer"})}else e.add([e.text("-",{size:14}),e.pos(bt,Z),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)])}),Z+=D,e.add([e.text("Unlocks",{size:12}),e.pos(F+10,Z),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]),O.forEach((Ee,ot)=>{const bt=F+q+ot*B+B/2,ge=Ee.achievements||(ot===0?C:[]);if(ge.length>0){const ce=Math.min(ge.length,3),ze=22,me=4,Ke=ce*ze+(ce-1)*me,Et=bt-Ke/2+ze/2;if(ge.slice(0,ce).forEach((Bt,St)=>{const Sn=No[Bt];if(!Sn)return;const ht=Et+St*(ze+me),Ht=so[Sn.difficulty]||so.normal,Zo=e.add([e.rect(ze,ze),e.pos(ht,Z),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...Ht)),e.area(),e.fixed(),e.z(w.MODAL+1)]);e.add([e.text(Sn.icon,{size:12}),e.pos(ht,Z),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.MODAL+2)]),Zo.onClick(()=>{tt(),ly(e,Sn)}),Zo.cursor="pointer"}),ge.length>ce){const Bt=ge.length-ce,St=Et+ce*(ze+me);e.add([e.text(`+${Bt}`,{size:10}),e.pos(St,Z),e.anchor("left"),e.color(200,180,100),e.fixed(),e.z(w.MODAL+1)])}}else e.add([e.text("-",{size:14}),e.pos(bt,Z),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)])});const se=M+G+15,he=_===1?240:_===2?180:_===3?140:110,Me=10,we=(U-20-(_-1)*Me)/_,De=Math.min(he,we),Qe=_===1?100:80,Ae=_*De+(_-1)*Me,pt=F+(U-Ae)/2+De/2,pe=[];O.forEach((Ee,ot)=>{const bt=pt+ot*(De+Me),ge=Ee.creditsPickedUp||0;e.add([e.rect(De-10,Qe),e.pos(bt,se+Qe/2),e.anchor("center"),e.outline(3,e.rgb(...y.TEXT_DISABLED)),e.color(0,0,0),e.opacity(.5),e.fixed(),e.z(w.MODAL)]);const ce=_===1?20:16,ze=e.add([e.text(`0 ${i}`,{size:ce}),e.pos(bt,se+Qe+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL+10)]);pe.push({x:bt,y:se,width:De-10,height:Qe,credits:ge,label:ze,particles:[],spawnedCount:0,displayedCount:0})});const Se=_===1?50:35,ae=.06,Xe=280;let qe=0;const Ce=.5;e.onUpdate(()=>{qe+=e.dt(),!(qe<Ce)&&pe.forEach((Ee,ot)=>{if(Ee.credits<=0)return;const bt=Math.min(Ee.credits,Se),ge=Ee.credits/bt,ce=qe-Ce-ot*.12,ze=Math.floor(ce/ae);for(;Ee.spawnedCount<bt&&Ee.spawnedCount<ze;){const me=Ee.x+(Math.random()-.5)*(Ee.width-16),Ke=Ee.y-30-Math.random()*25,Et=Mp[Math.floor(Math.random()*Mp.length)],Bt=e.add([e.text(Et,{size:14}),e.pos(me,Ke),e.anchor("center"),e.color(255,215,0),e.opacity(1),e.fixed(),e.z(w.MODAL+5),"currencyParticle",{velocity:Xe+Math.random()*60,landed:!1,value:ge}]);Ee.particles.push(Bt),Ee.spawnedCount++}Ee.particles.forEach(me=>{if(!me.exists()||me.landed)return;me.pos.y+=me.velocity*e.dt();const Ke=Ee.y+Ee.height-6,Et=Ee.particles.filter(St=>St.landed).length*1.5,Bt=Ke-Et;me.pos.y>=Bt&&(me.pos.y=Bt,me.landed=!0,Ee.displayedCount+=me.value,Ee.label.text=`${Math.floor(Ee.displayedCount)} ${i}`,me.opacity=.85)})})});const Ve=e.width()-110,We=M,At=180,Nt=G+Qe+30;e.add([e.rect(At,Nt),e.pos(Ve-At/2,We),e.color(25,20,30),e.outline(2,e.rgb(50,40,60)),e.fixed(),e.z(w.MODAL)]),e.add([e.text("STAFF",{size:14}),e.pos(Ve,We+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text("TERMINATED",{size:14}),e.pos(Ve,We+26),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL+1)]);const wt=n.killsByType||{},Ie=Object.entries(wt).filter(([Ee,ot])=>ot>0).sort((Ee,ot)=>ot[1]-Ee[1]);let Pe=We+48;const Ge=20,$e=Math.floor((Nt-60)/Ge);if(Ie.length===0)e.add([e.text("No staff",{size:12}),e.pos(Ve,Pe+10),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text("harmed",{size:12}),e.pos(Ve,Pe+24),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)]);else{const Ee=Math.min(Ie.length,$e);for(let ot=0;ot<Ee;ot++){const[bt,ge]=Ie[ot],ce=vM(bt),ze=wM(bt);e.add([e.text(ce,{size:14}),e.pos(Ve-70,Pe),e.anchor("center"),e.color(...ze),e.fixed(),e.z(w.MODAL+1)]);const me=xM(bt),Ke=me.length>14?me.substring(0,12)+"..":me;e.add([e.text(Ke,{size:10}),e.pos(Ve-50,Pe),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text(`x${ge}`,{size:11}),e.pos(Ve+70,Pe),e.anchor("right"),e.color(...y.DANGER),e.fixed(),e.z(w.MODAL+1)]),Pe+=Ge}if(Ie.length>Ee){const ot=Ie.slice(Ee).reduce((bt,[ge,ce])=>bt+ce,0);e.add([e.text(`+${ot} more`,{size:10}),e.pos(Ve,Pe),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)])}}const je=e.height()-90;e.add([e.text(`+${m} ${i}`,{size:16}),e.pos(e.width()/2-100,je),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL)]);const ct=f?y.SUCCESS:[150,200,255],at=f?`+${I} XP (LEVEL UP!)`:`+${I} XP`;e.add([e.text(at,{size:16}),e.pos(e.width()/2+100,je),e.anchor("center"),e.color(...ct),e.fixed(),e.z(w.MODAL)]);const st=_i(),ut=Qd(),Rt=Ml(),Dt=k0();e.add([e.text(`Level ${st}`,{size:12}),e.pos(e.width()/2,je+18),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL)]);const Yt=200,Pt=8,Zt=e.width()/2,dt=je+32;e.add([e.rect(Yt,Pt),e.pos(Zt,dt),e.anchor("center"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(w.MODAL)]);const Tt=Math.max(2,Yt*ut);e.add([e.rect(Tt,Pt-2),e.pos(Zt-Yt/2+Tt/2+1,dt),e.anchor("center"),e.color(100,180,255),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text(`${Rt} / ${Dt} XP`,{size:10}),e.pos(e.width()/2,dt+12),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL)]);const xe=ve(),Ze=e.height()-30,{MD:re,SM:Re}=Mi.BUTTON,ke=20,_e=!g||xe,L=g&&!xe?"Waiting...":"PLAY AGAIN",V=re.width,ee=re.height,fe=Re.width,nt=Re.height,rt=V+ke+fe,Vt=e.width()/2-rt/2,lt=e.add([e.rect(V,ee),e.pos(Vt+V/2,Ze),e.anchor("center"),e.color(..._e?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(..._e?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(w.MODAL)]),It=e.add([e.text(L,{size:Q.H2}),e.pos(Vt+V/2,Ze),e.anchor("center"),e.color(..._e?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(w.MODAL+1)]),Wt=e.add([e.rect(fe,nt),e.pos(Vt+V+ke+fe/2,Ze),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.scale(1),e.z(w.MODAL)]),fn=e.add([e.text("MENU",{size:Q.SMALL}),e.pos(Vt+V+ke+fe/2,Ze),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.scale(1),e.z(w.MODAL+1)]);_e&&(lt.onHoverUpdate(()=>{lt.color=e.rgb(...y.SUCCESS_HOVER||[80,180,80]),lt.scale=e.vec2(1.02,1.02),It.scale=e.vec2(1.02,1.02)}),lt.onHoverEnd(()=>{lt.color=e.rgb(...y.SUCCESS),lt.scale=e.vec2(1,1),It.scale=e.vec2(1,1)})),Wt.onHoverUpdate(()=>{Wt.color=e.rgb(...y.NEUTRAL_HOVER),Wt.scale=e.vec2(1.02,1.02),fn.scale=e.vec2(1.02,1.02)}),Wt.onHoverEnd(()=>{Wt.color=e.rgb(...y.NEUTRAL),Wt.scale=e.vec2(1,1),fn.scale=e.vec2(1,1)}),_e&&lt.onClick(()=>{Gt(),g&&xe&&Je("game_restart",{}),e.go("game",{resetState:!0})}),Wt.onClick(()=>{tt(),g&&!xe&&Xt("game_restart"),e.go("menu")}),g&&!xe&&Ue("game_restart",()=>{Gt(),Xt("game_restart"),e.go("game",{resetState:!0})}),e.onKeyPress("space",()=>{g&&!xe||(Gt(),g&&xe&&Je("game_restart",{}),e.go("game",{resetState:!0}))}),e.onKeyPress("escape",()=>{cy()||(tt(),g&&!xe&&Xt("game_restart"),e.go("menu"))})})}function EM(e){e.scene("shop",()=>{const t=_=>(_.preventDefault(),!1);document.addEventListener("contextmenu",t),e.onSceneLeave(()=>{document.removeEventListener("contextmenu",t)});const n=Wi(),o=Tl();let i="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),oa(e,{patternCount:10,particleCount:15}),ia(e,"MERCH",e.width()/2,35,8);const s=Xh(e,n),r=80,l=95,c=85,d=30,a=[{key:"permanentUpgrades",label:"Upgrades"},{key:"boosters",label:"Boosters"},{key:"cosmetics",label:"Cosmetics"},{key:"weapons",label:"Weapons"},{key:"characters",label:"Chars"}],h=(a.length-1)*l,u=e.width()/2-h/2,p=[];a.forEach((_,O)=>{const P=u+O*l,z=i===_.key,U=e.add([e.rect(c,d),e.pos(P,r),e.anchor("center"),e.color(...z?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),F=e.add([e.text(_.label,{size:Q.BODY}),e.pos(P,r),e.anchor("center"),e.color(...z?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(w.UI_TEXT)]);U.onClick(()=>{tt(),i=_.key,m=0,N()}),p.push({bg:U,label:F,category:_.key})});const g=130;e.height()-g-100;let A=[],m=0;const C=6;let I=[],R=!1,f=!1;function N(){const _=Wi();s.updateCurrency(_),p.forEach(oe=>{const se=i===oe.category;oe.bg.color=e.rgb(se?100:50,se?100:50,se?150:80),oe.label.color=e.rgb(se?255:150,se?255:150,se?255:150)}),x(),A.forEach(oe=>{oe.exists()&&e.destroy(oe)}),A=[],I.forEach(oe=>{oe.exists()&&e.destroy(oe)}),I=[];const O=Gw(i),z=Object.keys(O).filter(oe=>{const se=O[oe];return i==="permanentUpgrades"||i==="boosters"?!0:!se.unlockedByDefault});if(z.length===0){const oe=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,g+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);A.push(oe);return}const U=Math.ceil(z.length/C);m>=U&&(m=Math.max(0,U-1));const F=m*C,B=z.slice(F,F+C),D=340,q=105,G=q+8,Z=g+5,le=3,ie=oe=>{if(!oe)return null;const se=oe.toLowerCase();return se.includes("hp")||se.includes("health")?{icon:"",color:[255,100,100]}:se.includes("damage")||se.includes("dmg")?{icon:"",color:[255,200,100]}:se.includes("speed")?{icon:"",color:[100,200,255]}:se.includes("crit")?{icon:"",color:[255,255,100]}:se.includes("xp")||se.includes("pickup")?{icon:"",color:[100,255,200]}:se.includes("defense")||se.includes("reduction")?{icon:"",color:[150,150,255]}:se.includes("credit")||se.includes("silver")?{icon:"$",color:[200,150,50]}:se.includes("level")?{icon:"",color:[200,100,255]}:se.includes("invuln")||se.includes("immunity")?{icon:"",color:[100,255,255]}:se.includes("trail")||se.includes("glow")||se.includes("effect")?{icon:"",color:[200,150,255]}:null};if(B.forEach((oe,se)=>{const he=O[oe],Me=Math.floor(se/le),He=se%le,we=45+Me*(D+15),De=Z+He*G,Qe=he.requiredAchievement||(he.unlockRequirement?.type==="achievement"?he.unlockRequirement.value:null),Ae=Qe?!Jd(Qe):!1,pt=Qe?K0(Qe):null,pe=i==="characters"&&mo("characters",oe),Se=i==="weapons"&&mo("weapons",oe),ae=i==="permanentUpgrades"&&zt(oe)>=(he.maxLevel||1),Xe=i==="cosmetics"&&he.requiredAchievement&&!Ae,qe=i==="cosmetics"&&(mo("cosmetics",oe)||he.unlockedByDefault||Xe),Ce=i==="cosmetics"&&sb(he.category)===oe;let Ve,We;Ae?(Ve=e.rgb(60,50,50),We=[30,25,25]):Ce?(Ve=e.rgb(100,200,255),We=[35,45,55]):ae||pe||Se||qe?(Ve=e.rgb(80,150,80),We=[35,45,35]):(Ve=e.rgb(80,80,120),We=[35,35,45]);const At=e.add([e.rect(D,q),e.pos(we,De),e.anchor("topleft"),e.color(...We),e.outline(2,Ve),e.area(),e.fixed(),e.z(1e3)]);let Nt=we+10;if((i==="characters"||i==="weapons")&&he.char){const re=e.add([e.rect(40,40),e.pos(we+8,De+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),Re=e.add([e.text(he.char,{size:28}),e.pos(we+28,De+28),e.anchor("center"),e.color(...Ae?[60,60,60]:he.color||[200,200,200]),e.fixed(),e.z(1002)]);A.push(re,Re),Nt=we+55}if(i==="cosmetics"){const re=he.category==="trail"?"~":he.category==="death"?"":"";let Re;he.color==="rainbow"?Re=[255,100,200]:Array.isArray(he.color)?Re=he.color:Re=[150,150,200];const ke=Ae?[60,60,70]:Re,_e=Ae?[50,50,60]:Re,L=e.add([e.rect(36,36),e.pos(we+8,De+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(..._e)),e.fixed(),e.z(1001)]),V=e.add([e.text(re,{size:22}),e.pos(we+26,De+26),e.anchor("center"),e.color(...ke),e.fixed(),e.z(1002)]);A.push(L,V),Nt=we+50}const wt=e.add([e.text(he.name,{size:16}),e.pos(Nt,De+10),e.anchor("topleft"),e.color(Ae?100:255,Ae?100:255,Ae?100:255),e.fixed(),e.z(1001)]),Ie=ie(he.description);if(Ie&&!Ae){const re=e.add([e.text(Ie.icon,{size:18}),e.pos(we+D-12,De+12),e.anchor("topright"),e.color(...Ie.color),e.fixed(),e.z(1001)]);A.push(re)}if(Ae){const re=e.add([e.text("(X)",{size:14}),e.pos(we+D-10,De+10),e.anchor("topright"),e.color(150,80,80),e.fixed(),e.z(1002)]);A.push(re)}const Pe=D-Nt+we-90,Ge=De+30;let $e=he.description,je=null;if(Ae&&pt){const re=Us();re&&(je=qa(pt.id,re)),je?$e=`${pt.name} (${je.current}/${je.target})`:$e=`Requires: ${pt.name}`}const ct=e.add([e.text($e,{size:12,width:Pe}),e.pos(Nt,Ge),e.anchor("topleft"),e.color(Ae?140:180,Ae?110:180,Ae?110:180),e.fixed(),e.z(1001)]);if(Ae&&je&&je.target>1){const re=Math.min(Pe,120),Re=4,ke=Nt,_e=Ge+18,L=e.add([e.rect(re,Re),e.pos(ke,_e),e.anchor("topleft"),e.color(40,35,45),e.fixed(),e.z(1001)]);A.push(L);const V=Math.max(0,je.progress*re);if(V>0){const ee=e.add([e.rect(V,Re),e.pos(ke,_e),e.anchor("topleft"),e.color(100,80,130),e.fixed(),e.z(1002)]);A.push(ee)}}const at=De+q-28,st=we+D-85,ut=75,Rt=24;function Dt(re){const Re=[50,65,90,115,160];return re<Re.length?Re[re]:160+(re-4)*50}let Yt="",Pt=!1,Zt=he.cost,dt=!1,Tt=0,xe=1;if(i==="permanentUpgrades"){const re=zt(oe),Re=he.maxLevel||1;Tt=re,xe=Re,dt=!0,re>=Re?Yt="MAXED":(Zt=Dt(re),Pt=n>=Zt)}else if(i==="boosters"){const re=Qw();Yt=re>0?`Ready (${re})`:"Consumable",Pt=n>=Zt}else i==="cosmetics"?(he.category,Ce?Yt="EQUIPPED":qe?Yt=Xe?"UNLOCKED":"OWNED":Ae||(Pt=n>=Zt)):i==="characters"?pe||(Pt=n>=Zt):i==="weapons"&&(Se||(Pt=n>=Zt));if(dt){const ke=Nt,_e=at+8,L=e.add([e.rect(100,8),e.pos(ke,_e),e.anchor("topleft"),e.color(30,30,40),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),V=Math.max(0,Tt/xe*98);if(V>0){const fe=e.add([e.rect(V,6),e.pos(ke+1,_e+1),e.anchor("topleft"),e.color(Tt>=xe?100:80,Tt>=xe?200:150,Tt>=xe?100:80),e.fixed(),e.z(1002)]);A.push(fe)}const ee=e.add([e.text(`${Tt}/${xe}`,{size:10}),e.pos(ke+100+8,_e+4),e.anchor("left"),e.color(Tt>=xe?100:150,Tt>=xe?255:200,Tt>=xe?100:150),e.fixed(),e.z(1001)]);A.push(L,ee)}let Ze=null;if(Yt&&!dt){let re;switch(Yt){case"EQUIPPED":re=[100,200,255];break;case"UNLOCKED":re=[180,140,255];break;case"MAXED":case"OWNED":re=[100,200,100];break;default:re=[180,180,180]}Ze=e.add([e.text(Yt,{size:11}),e.pos(Nt,at+7),e.anchor("topleft"),e.color(...re),e.fixed(),e.z(1001)])}if(Ae&&pt){const re=e.add([e.rect(ut,Rt),e.pos(st,at),e.anchor("topleft"),e.color(50,40,60),e.outline(1,e.rgb(100,80,130)),e.area({width:ut,height:Rt}),e.fixed(),e.z(1010)]),Re=e.add([e.text("VIEW",{size:11}),e.pos(st+ut/2,at+Rt/2),e.anchor("center"),e.color(160,130,200),e.fixed(),e.z(1011)]);re.onHover(()=>{re.color=e.rgb(70,55,85),re.outline.color=e.rgb(140,110,180),Re.color=e.rgb(200,170,255)}),re.onHoverEnd(()=>{re.color=e.rgb(50,40,60),re.outline.color=e.rgb(100,80,130),Re.color=e.rgb(160,130,200)});const ke=pt;re.onClick(()=>{tt(),ly(e,ke)}),re.cursor="pointer",A.push(re,Re)}else if(Ae){const re=e.add([e.text("LOCKED",{size:11}),e.pos(st+ut/2,at+Rt/2),e.anchor("center"),e.color(100,80,80),e.fixed(),e.z(1001)]);A.push(re)}else if(Pt||i==="permanentUpgrades"&&Tt<xe){const re=e.add([e.rect(ut,Rt),e.pos(st,at),e.anchor("topleft"),e.color(Pt?40:30,Pt?120:40,Pt?40:30),e.outline(1,e.rgb(Pt?80:50,Pt?180:60,Pt?80:50)),e.area(),e.fixed(),e.z(1001)]),Re=e.add([e.text(`$${Zt}`,{size:12}),e.pos(st+ut/2,at+Rt/2),e.anchor("center"),e.color(Pt?255:120,Pt?255:120,Pt?255:120),e.fixed(),e.z(1002)]);if(i==="permanentUpgrades"&&Tt>0){let ke=null;ke=e.onMouseRelease("right",()=>{const _e=e.mousePos();if(_e.x>=st&&_e.x<=st+ut&&_e.y>=at&&_e.y<=at+Rt){if(R)return;R=!0;const L=kw(oe);if(L&&L.success){xa();const V=e.add([e.text(`Refunded $${L.refundAmount}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{V.exists()&&e.destroy(V)}),N(),e.wait(.2,()=>{R=!1})}else R=!1}}),re.onDestroy(()=>{ke&&ke.cancel()})}Pt&&re.onClick(()=>{if(R)return;R=!0;let ke;if(i==="permanentUpgrades"?ke=jw(oe,Zt,he.maxLevel):i==="boosters"?ke=Jw(oe,Zt):ke=$w(i,oe,Zt),i==="permanentUpgrades"||i==="boosters")if(ke&&ke.success){xa();const _e=i==="boosters"?"Booster Ready!":"Purchased!",L=e.add([e.text(_e,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{L.exists()&&e.destroy(L)}),N(),e.wait(.2,()=>{R=!1})}else if(ke&&ke.reason==="insufficientCurrency"){bc();const _e=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{_e.exists()&&e.destroy(_e)}),R=!1}else R=!1;else if(ke){xa();const _e=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{_e.exists()&&e.destroy(_e)}),N(),e.wait(.2,()=>{R=!1})}else{bc();const _e=e.add([e.text(`Not enough ${o}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{_e.exists()&&e.destroy(_e)}),R=!1}}),A.push(re,Re)}else if(i==="cosmetics"&&qe&&!Ce){const re=e.add([e.rect(ut,Rt),e.pos(st,at),e.anchor("topleft"),e.color(40,80,120),e.outline(1,e.rgb(80,140,200)),e.area(),e.fixed(),e.z(1001)]),Re=e.add([e.text("EQUIP",{size:11}),e.pos(st+ut/2,at+Rt/2),e.anchor("center"),e.color(200,230,255),e.fixed(),e.z(1002)]);re.onHover(()=>{re.color=e.rgb(50,100,150),re.outline.color=e.rgb(100,170,240),Re.color=e.rgb(230,245,255)}),re.onHoverEnd(()=>{re.color=e.rgb(40,80,120),re.outline.color=e.rgb(80,140,200),Re.color=e.rgb(200,230,255)}),re.onClick(()=>{R||(R=!0,tt(),Bu(he.category,oe),R=!1,N())}),re.cursor="pointer",A.push(re,Re)}else if(i==="cosmetics"&&Ce&&!oe.includes("None")){const re=e.add([e.rect(ut,Rt),e.pos(st,at),e.anchor("topleft"),e.color(80,50,50),e.outline(1,e.rgb(160,100,100)),e.area(),e.fixed(),e.z(1001)]),Re=e.add([e.text("UNEQUIP",{size:11}),e.pos(st+ut/2,at+Rt/2),e.anchor("center"),e.color(255,180,180),e.fixed(),e.z(1002)]);re.onHover(()=>{re.color=e.rgb(100,60,60),re.outline.color=e.rgb(200,120,120),Re.color=e.rgb(255,210,210)}),re.onHoverEnd(()=>{re.color=e.rgb(80,50,50),re.outline.color=e.rgb(160,100,100),Re.color=e.rgb(255,180,180)}),re.onClick(()=>{if(R)return;R=!0,tt();const ke=he.category+"None";Bu(he.category,ke),R=!1,N()}),re.cursor="pointer",A.push(re,Re)}A.push(At,wt,ct),Ze&&A.push(Ze)}),U>1){const oe=e.height()-115,se=e.width()/2,he=20,Me=se-(U-1)*he/2,He=se+(U-1)*he/2,we=35,De=Me-we,Qe=He+we,Ae=e.add([e.rect(30,30),e.pos(De,oe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+10)]),pt=e.add([e.text("<",{size:24}),e.pos(De,oe),e.anchor("center"),e.color(m>0?255:80,m>0?255:80,m>0?255:80),e.fixed(),e.z(w.UI_TEXT+10)]);m>0&&(Ae.onClick(()=>{f||(f=!0,e.wait(0,()=>{f=!1}),tt(),m--,N())}),Ae.cursor="pointer"),I.push(Ae,pt);const pe=e.add([e.rect(30,30),e.pos(Qe,oe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+10)]),Se=e.add([e.text(">",{size:24}),e.pos(Qe,oe),e.anchor("center"),e.color(m<U-1?255:80,m<U-1?255:80,m<U-1?255:80),e.fixed(),e.z(w.UI_TEXT+10)]);m<U-1&&(pe.onClick(()=>{f||(f=!0,e.wait(0,()=>{f=!1}),tt(),m++,N())}),pe.cursor="pointer"),I.push(pe,Se);for(let ae=0;ae<U;ae++){const Xe=ae===m,qe=Me+ae*he,Ce=e.add([e.rect(16,16),e.pos(qe,oe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),Ve=e.add([e.text(Xe?"":"",{size:14}),e.pos(qe,oe),e.anchor("center"),e.color(Xe?255:120,Xe?255:120,Xe?255:120),e.fixed(),e.z(w.UI_TEXT)]),We=ae;Ce.onClick(()=>{f||(f=!0,e.wait(0,()=>{f=!1}),We!==m&&(tt(),m=We,N()))}),Ce.cursor="pointer",I.push(Ce,Ve)}}}let b=null,T=null;function x(){const _=Q0();i==="permanentUpgrades"&&_>0?b?(T.text=`REFUND: $${_}`,b.hidden=!1,T.hidden=!1):(b=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),T=e.add([e.text(`REFUND: $${_}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(w.UI_TEXT)]),b.onClick(()=>{eb().success?(xa(),N()):bc()})):b&&(b.hidden=!0,T&&(T.hidden=!0))}N();const M=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text(Wr("Back"),{size:Q.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),M.onClick(()=>{tt(),e.go("menu")}),e.onKeyPress("escape",()=>{cy()||e.go("menu")})})}function Dp(e,t){const n=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(w.OVERLAY)]),s=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(w.OVERLAY+1)]),r=[];function l(){r.forEach(A=>{A&&A.exists&&A.exists()&&e.destroy(A)})}const c=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),d=e.add([e.text("Cancel",{size:Q.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+3)]);c.onClick(()=>{l()}),r.push(n,s,c,d);const a=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),h=e.add([e.text("Reset",{size:Q.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(w.OVERLAY+3)]);a.onClick(()=>{l(),t()}),r.push(a,h);const u=e.add([e.text("Reset to Defaults?",{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]);r.push(u);const p=e.add([e.text("This will reset all settings to their default values.",{size:Q.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.OVERLAY+2)]);r.push(p);const g=e.onKeyPress("escape",()=>{l(),g.cancel()})}function SM(e){e.scene("settings",t=>{const n=t?.fromGame||!1;let o=Cd(),i="audio";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),oa(e,{patternCount:10,particleCount:15}),ia(e,"OPTIONS",e.width()/2,35,8);const s=80,r=100,l=90,c=30,d=[{key:"audio",label:"Audio"},{key:"video",label:"Video"},{key:"gameplay",label:"Gameplay"},{key:"controls",label:"Controls"},{key:"access",label:"Access."},{key:"data",label:"Data"}],a=(d.length-1)*r,h=e.width()/2-a/2,u=[];d.forEach((x,M)=>{const _=h+M*r,O=i===x.key,P=e.add([e.rect(l,c),e.pos(_,s),e.anchor("center"),e.color(O?100:50,O?100:50,O?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),z=e.add([e.text(x.label,{size:16}),e.pos(_,s),e.anchor("center"),e.color(O?255:150,O?255:150,O?255:150),e.fixed(),e.z(w.UI_TEXT)]);P.onClick(()=>{i=x.key,C()}),u.push({bg:P,label:z,key:x.key})});const p=120,g=50,A=150;let m=[];function C(){u.forEach(_=>{const O=i===_.key;_.bg.color=e.rgb(O?100:50,O?100:50,O?150:80),_.label.color=e.rgb(O?255:150,O?255:150,O?255:150)}),m.forEach(_=>{_.exists()&&e.destroy(_)}),m=[],o=Cd();const x=p+20;let M=x;if(i==="audio")M=I(e,"Master Volume",o.audio?.masterVolume??1,M,_=>{Cn("audio","masterVolume",_),Ym(_)}),M=I(e,"Music Volume",o.audio?.musicVolume??.35,M,_=>{Cn("audio","musicVolume",_),jm(_)}),M=I(e,"SFX Volume",o.audio?.sfxVolume??1,M,_=>{Cn("audio","sfxVolume",_),Gm(_),tt()}),M=R(e,"UI Sounds",o.audio?.uiSounds!==!1,M,_=>{Cn("audio","uiSounds",_),Km(_)}),M=R(e,"Combat Sounds",o.audio?.combatSounds!==!1,M,_=>{Cn("audio","combatSounds",_),Vm(_)});else if(i==="video")M=R(e,"Show Particles",o.visual?.showParticles!==!1,M,_=>{Cn("visual","showParticles",_)}),M=R(e,"Screen Shake",o.visual?.showScreenShake!==!1,M,_=>{Cn("visual","showScreenShake",_)}),M=R(e,"Hit Freeze",o.visual?.showHitFreeze!==!1,M,_=>{Cn("visual","showHitFreeze",_)}),M=R(e,"Damage Numbers",o.visual?.showDamageNumbers!==!1,M,_=>{Cn("visual","showDamageNumbers",_)}),M=R(e,"FPS Counter",o.visual?.showFPS||!1,M,_=>{Cn("visual","showFPS",_)}),M=R(e,"Show Timer",o.visual?.showTimer!==!1,M,_=>{Cn("visual","showTimer",_)});else if(i==="controls"){const _=o.controls||{},O=[{label:"Move Up",key:"moveUp",value:_.moveUp||"w"},{label:"Move Down",key:"moveDown",value:_.moveDown||"s"},{label:"Move Left",key:"moveLeft",value:_.moveLeft||"a"},{label:"Move Right",key:"moveRight",value:_.moveRight||"d"},{label:"Pause",key:"pause",value:_.pause||"escape"},{label:"Interact",key:"interact",value:_.interact||"space"}];O.forEach((z,U)=>{const F=x+U*g,B=e.add([e.text(z.label+":",{size:16}),e.pos(150,F),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(w.UI_ELEMENTS)]),D=e.add([e.rect(100,30),e.pos(500,F),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(w.UI_ELEMENTS)]),q=e.add([e.text(z.value.toUpperCase(),{size:16}),e.pos(500,F),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]);m.push(B,D,q)});const P=x+O.length*g;if(P<e.height()-A){const z=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,P+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(w.UI_ELEMENTS)]);m.push(z)}}else if(i==="gameplay")M=R(e,"Auto-pause on Level Up",o.gameplay?.autoPause||!1,M,_=>{Cn("gameplay","autoPause",_)}),M=R(e,"Auto-pickup Currency",o.gameplay?.autoPickupCurrency||!1,M,_=>{Cn("gameplay","autoPickupCurrency",_)}),M=R(e,"Auto-pickup XP",o.gameplay?.autoPickupXP||!1,M,_=>{Cn("gameplay","autoPickupXP",_)}),M=R(e,"Confirm Before Quit",o.gameplay?.confirmBeforeQuit!==!1,M,_=>{Cn("gameplay","confirmBeforeQuit",_)}),M=R(e,"Skip Intro Animation",o.gameplay?.skipIntroAnimation||!1,M,_=>{Cn("gameplay","skipIntroAnimation",_)});else if(i==="access"){M=R(e,"Reduced Motion",o.accessibility?.reducedMotion||!1,M,O=>{Cn("accessibility","reducedMotion",O)});const _=e.add([e.text("Disables particles, screen shake, and hit freeze effects",{size:12}),e.pos(e.width()/2,M+10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);m.push(_),M+=40}else if(i==="data"){const _=e.add([e.rect(200,35),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),O=e.add([e.text("Export Save Data",{size:Q.SMALL}),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);let P=null;_.onClick(()=>{try{const q=localStorage.getItem("superSmashTexty_save")||"{}";navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(q).then(()=>{P&&P.exists()&&(P.text="Copied to clipboard!",P.color=e.rgb(...y.SUCCESS))}).catch(()=>{P&&P.exists()&&(P.text="Failed to copy",P.color=e.rgb(...y.DANGER))}):(console.log("Save data:",q),P&&P.exists()&&(P.text="Check browser console (F12)",P.color=e.rgb(...y.TEXT_SECONDARY)))}catch(q){console.error("Export failed:",q)}}),m.push(_,O),M+=50,P=e.add([e.text("",{size:Q.SMALL-2}),e.pos(e.width()/2,M-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),m.push(P),M+=30;const z=e.add([e.rect(200,35),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),U=e.add([e.text("Import Save Data",{size:Q.SMALL}),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);z.onClick(()=>{if(!navigator.clipboard||!navigator.clipboard.readText){P&&P.exists()&&(P.text="Clipboard not available",P.color=e.rgb(...y.DANGER));return}navigator.clipboard.readText().then(q=>{try{const G=JSON.parse(q);G&&typeof G=="object"&&(localStorage.setItem("superSmashTexty_save",q),P&&P.exists()&&(P.text="Import successful! Refresh to apply.",P.color=e.rgb(...y.SUCCESS)))}catch{P&&P.exists()&&(P.text="Invalid save data",P.color=e.rgb(...y.DANGER))}}).catch(()=>{P&&P.exists()&&(P.text="Failed to read clipboard",P.color=e.rgb(...y.DANGER))})}),m.push(z,U),M+=60;const F=e.add([e.rect(200,35),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),B=e.add([e.text("Reset All Progress",{size:Q.SMALL}),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);F.onClick(()=>{Dp(e,()=>{localStorage.removeItem("superSmashTexty_save"),P&&P.exists()&&(P.text="Progress reset! Refresh to apply.",P.color=e.rgb(...y.SUCCESS))})}),m.push(F,B),M+=50;const D=e.add([e.text("Warning: Reset cannot be undone!",{size:10}),e.pos(e.width()/2,M),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.UI_ELEMENTS)]);m.push(D)}}function I(x,M,_,O,P){const z=x.add([x.text(M+":",{size:16}),x.pos(150,O),x.anchor("left"),x.color(200,200,200),x.fixed(),x.z(w.UI_ELEMENTS)]),U=300,F=20,B=x.add([x.rect(U,F),x.pos(500,O),x.anchor("center"),x.color(50,50,70),x.outline(2,x.rgb(100,100,120)),x.area(),x.fixed(),x.z(w.UI_ELEMENTS)]);function D(Me){if(Me<.5){const He=Me*2;return{r:255,g:Math.round(255*He),b:0}}else{const He=(Me-.5)*2;return{r:Math.round(255*(1-He)),g:255,b:0}}}const q=U*_,G=D(_),Z=x.add([x.rect(q,F-4),x.pos(500-(U-q)/2,O),x.anchor("center"),x.color(G.r,G.g,G.b),x.fixed(),x.z(w.UI_TEXT)]),le=500-U/2+q,ie=x.add([x.rect(20,F+4),x.pos(le,O),x.anchor("center"),x.color(200,200,255),x.outline(2,x.rgb(150,150,200)),x.area(),x.fixed(),x.z(1002)]),oe=x.add([x.text(Math.round(_*100)+"%",{size:14}),x.pos(680,O),x.anchor("left"),x.color(255,255,255),x.fixed(),x.z(w.UI_ELEMENTS)]);let se=!1;B.onClick(()=>{const Me=x.mousePos().x,He=500-U/2,we=Me-He,De=Math.max(0,Math.min(1,we/U));he(De)}),ie.onClick(()=>{se=!0}),x.onMouseMove(()=>{if(se&&x.isMouseDown()){const Me=x.mousePos().x,He=500-U/2,we=Me-He,De=Math.max(0,Math.min(1,we/U));he(De)}else se=!1}),x.onMouseRelease(()=>{se=!1});function he(Me){const He=U*Me;Z.width=He,Z.pos.x=500-(U-He)/2,ie.pos.x=500-U/2+He,oe.text=Math.round(Me*100)+"%";const we=D(Me);Z.color=x.rgb(we.r,we.g,we.b),P(Me)}return m.push(z,B,Z,ie,oe),O+g}function R(x,M,_,O,P){const z=x.add([x.text(M+":",{size:16,width:280}),x.pos(150,O),x.anchor("left"),x.color(200,200,200),x.fixed(),x.z(w.UI_ELEMENTS)]),U=80,F=30,B=550,D=x.add([x.rect(U,F),x.pos(B,O),x.anchor("center"),x.color(_?50:70,_?150:50,_?50:70),x.outline(2,x.rgb(100,100,120)),x.area(),x.fixed(),x.z(w.UI_ELEMENTS)]),q=24,G=_?B+U/2-q/2-4:B-U/2+q/2+4,Z=x.add([x.rect(q,q),x.pos(G,O),x.anchor("center"),x.color(255,255,255),x.outline(1,x.rgb(200,200,200)),x.fixed(),x.z(w.UI_TEXT)]),le=_?B-12:B+8,ie=x.add([x.text(_?"ON":"OFF",{size:12}),x.pos(le,O),x.anchor("center"),x.color(_?100:150,_?255:150,_?100:150),x.fixed(),x.z(1002)]);return D.onClick(()=>{const oe=!_;_=oe,D.color=x.rgb(oe?50:70,oe?150:50,oe?50:70),Z.pos.x=oe?B+U/2-q/2-4:B-U/2+q/2+4,ie.text=oe?"ON":"OFF",ie.pos.x=oe?B-12:B+8,ie.color=x.rgb(oe?100:150,oe?255:150,oe?100:150),P(oe)}),m.push(z,D,Z,ie),O+g}const{MD:f,SM:N}=Mi.BUTTON,b=e.add([e.rect(f.width,f.height),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("RESET",{size:Q.SMALL}),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),b.onClick(()=>{Dp(e,()=>{FA(),C()})}),C();const T=e.add([e.rect(N.width,N.height),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),T.onClick(()=>{n?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{n?e.go("game"):e.go("menu")})})}function CM(e,t,n){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),n=Math.max(0,Math.min(1,n));let o,i,s;if(t===0)o=i=s=n;else{const r=(d,a,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?d+(a-d)*6*h:h<.5?a:h<.6666666666666666?d+(a-d)*(.6666666666666666-h)*6:d),l=n<.5?n*(1+t):n+t-n*t,c=2*n-l;o=r(c,l,e+1/3),i=r(c,l,e),s=r(c,l,e-1/3)}return[Math.max(0,Math.min(255,Math.round(o*255))),Math.max(0,Math.min(255,Math.round(i*255))),Math.max(0,Math.min(255,Math.round(s*255)))]}function _M(e){e.scene("statistics",()=>{const t=Us(),n=Z0(),o=Tl();let i="achievements",s="all",r=0;const l=15,c=8;let d=!1,a=null;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),oa(e,{patternCount:10,particleCount:15}),ia(e,"RATINGS AND RECORDS",e.width()/2,35,8);const h=80,u=160,p=150,g=30,A=[{key:"achievements",label:"Achievements"},{key:"history",label:"History"}],m=(A.length-1)*u,C=e.width()/2-m/2,I=[];A.forEach((P,z)=>{const U=C+z*u,F=i===P.key,B=e.add([e.rect(p,g),e.pos(U,h),e.anchor("center"),e.color(...F?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),D=e.add([e.text(P.label,{size:Q.BODY}),e.pos(U,h),e.anchor("center"),e.color(...F?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(w.UI_TEXT)]);B.onClick(()=>{d||(d=!0,tt(),i=P.key,r=0,s="all",e.wait(0,()=>{M(),e.wait(.1,()=>{d=!1})}))}),I.push({bg:B,label:D,key:P.key})});const R=140,N=e.height()-80;let b=[],T=[];const x=["all",...qw()];function M(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(I.forEach(P=>{const z=i===P.key;P.bg.color=e.rgb(z?100:50,z?100:50,z?150:80),P.label.color=e.rgb(z?255:150,z?255:150,z?255:150)}),b.forEach(P=>{if(P&&typeof P.exists=="function"&&P.exists())try{e.destroy(P)}catch(z){console.warn("Error destroying content item:",z)}}),b=[],T.forEach(P=>{if(P&&typeof P.exists=="function"&&P.exists())try{e.destroy(P)}catch(z){console.warn("Error destroying category tab item:",z)}}),T=[],i==="achievements")try{const B=(e.width()-640)/2,D=R+5,q=N-D-80,G=D,Z=70,le=22,ie=75,oe=x.slice(0,7),se=(oe.length-1)*ie,he=e.width()/2-se/2;oe.forEach((xe,Ze)=>{const re=he+Ze*ie,Re=s===xe,ke=xe==="all"?"All":xe.charAt(0).toUpperCase()+xe.slice(1),_e=e.add([e.rect(Z,le),e.pos(re,G),e.anchor("center"),e.color(Re?80:40,Re?80:40,Re?120:60),e.outline(1,e.rgb(100,100,150)),e.area(),e.fixed(),e.z(1e3)]),L=e.add([e.text(ke,{size:11}),e.pos(re,G),e.anchor("center"),e.color(Re?255:150,Re?255:150,Re?255:150),e.fixed(),e.z(1001)]);_e.onClick(()=>{d||(d=!0,tt(),s=xe,r=0,a=null,e.wait(0,()=>{M(),e.wait(.1,()=>{d=!1})}))}),T.push(_e,L)});let Me;s==="all"?Me=Object.values(No):Me=Xw(s);const He=Math.ceil(Me.length/l);r>=He&&(r=Math.max(0,He-1));const we=r*l,De=Me.slice(we,we+l),Qe=D+35,Ae=50,pt=8,pe=5,Se=Ae+22,ae=B,Xe=e.add([e.rect(320,q-35),e.pos(B,Qe),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(999)]);b.push(Xe);const qe=15;De.forEach((xe,Ze)=>{const re=n.includes(xe.id),Re=a&&a.id===xe.id,ke=Math.floor(Ze/pe),_e=Ze%pe,L=ae+qe+_e*(Ae+pt),V=Qe+qe+ke*Se,ee=so[xe.difficulty]||so.normal,fe=Re?[100,100,180]:re?[50,50,65]:[30,30,40],nt=Re?[150,150,255]:re?ee:[50,50,60],rt=e.add([e.rect(Ae,Ae),e.pos(L,V),e.anchor("topleft"),e.color(...fe),e.outline(Re?3:2,e.rgb(...nt)),e.area({width:Ae,height:Ae}),e.fixed(),e.z(1e3)]),Vt=e.add([e.text(xe.icon,{size:24}),e.pos(L+Ae/2,V+Ae/2),e.anchor("center"),e.color(re?255:80,re?255:80,re?255:80),e.fixed(),e.z(1001)]);if(!re){const lt=qa(xe.id,t);if(lt&&lt.percentage>0){const It=Ae-4,Wt=It*lt.progress,fn=e.add([e.rect(It,4),e.pos(L+2,V+Ae-6),e.anchor("topleft"),e.color(20,20,30),e.fixed(),e.z(1001)]);if(b.push(fn),Wt>0){const Ee=e.add([e.rect(Wt,4),e.pos(L+2,V+Ae-6),e.anchor("topleft"),e.color(...ee),e.opacity(.8),e.fixed(),e.z(1002)]);b.push(Ee)}}}rt.onClick(()=>{d||(tt(),a=xe,d=!0,e.wait(0,()=>{M(),e.wait(.1,()=>{d=!1})}))}),b.push(rt,Vt)});const Ce=B+320+20,Ve=e.add([e.rect(300,q-35),e.pos(Ce,Qe),e.anchor("topleft"),e.color(30,28,40),e.outline(2,e.rgb(70,70,100)),e.fixed(),e.z(999)]);b.push(Ve);const We=Ce+300/2,At=Qe+20;if(a){const xe=a,Ze=n.includes(xe.id),re=qa(xe.id,t),Re=so[xe.difficulty]||so.normal,ke=e.add([e.rect(70,70),e.pos(We,At+35),e.anchor("center"),e.color(Ze?45:25,Ze?45:25,Ze?55:30),e.outline(3,e.rgb(...Ze?Re:[60,60,70])),e.fixed(),e.z(1e3)]);b.push(ke);const _e=e.add([e.text(xe.icon,{size:40}),e.pos(We,At+35),e.anchor("center"),e.color(Ze?255:100,Ze?255:100,Ze?255:100),e.fixed(),e.z(1001)]);b.push(_e);const L=e.add([e.text(xe.name,{size:16}),e.pos(We,At+85),e.anchor("center"),e.color(...Ze?[255,255,255]:[180,180,180]),e.fixed(),e.z(1e3)]);b.push(L);const V=xe.difficulty.charAt(0).toUpperCase()+xe.difficulty.slice(1),ee=e.add([e.text(V,{size:11}),e.pos(We,At+105),e.anchor("center"),e.color(...Re),e.fixed(),e.z(1e3)]);b.push(ee);const fe=e.add([e.text(xe.description,{size:12}),e.pos(We,At+130),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1e3)]);b.push(fe);let nt=At+160;if(Ze){const rt=e.add([e.text("UNLOCKED",{size:14}),e.pos(We,nt),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(1e3)]);b.push(rt)}else if(re){const lt=e.add([e.rect(200,16),e.pos(We,nt),e.anchor("center"),e.color(30,30,45),e.outline(1,e.rgb(70,70,90)),e.fixed(),e.z(1e3)]);b.push(lt);const It=Math.max(2,200*re.progress),Wt=e.add([e.rect(It,12),e.pos(We-200/2+It/2,nt),e.anchor("center"),e.color(...Re),e.opacity(.9),e.fixed(),e.z(1001)]);b.push(Wt);const fn=e.add([e.text(`${re.current} / ${re.target}`,{size:11}),e.pos(We,nt+20),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);b.push(fn),nt+=35}if(!Ze&&xe.hint){const rt=nt+15,Vt=e.add([e.text("Hint:",{size:10}),e.pos(We,rt),e.anchor("center"),e.color(120,120,140),e.fixed(),e.z(1e3)]);b.push(Vt);const lt=e.add([e.text(xe.hint,{size:11}),e.pos(We,rt+18),e.anchor("center"),e.color(160,160,180),e.fixed(),e.z(1e3)]);b.push(lt)}}else{const xe=e.add([e.text("",{size:32}),e.pos(We,At+60),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);b.push(xe);const Ze=e.add([e.text("Select an achievement",{size:14}),e.pos(We,At+100),e.anchor("center"),e.color(120,120,150),e.fixed(),e.z(1e3)]);b.push(Ze);const re=e.add([e.text("to view details",{size:12}),e.pos(We,At+120),e.anchor("center"),e.color(100,100,130),e.fixed(),e.z(1e3)]);b.push(re)}if(He>1){const xe=N-55,Ze=e.width()/2,re=20,Re=Ze-(He-1)*re/2,ke=Ze+(He-1)*re/2,_e=25,L=Re-_e,V=ke+_e,ee=lt=>{d||lt===r||lt<0||lt>=He||(d=!0,tt(),r=lt,e.wait(0,()=>{M(),e.wait(.15,()=>{d=!1})}))};for(let lt=0;lt<He;lt++){const It=lt===r,Wt=Re+lt*re,fn=e.add([e.rect(16,16),e.pos(Wt,xe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),Ee=e.add([e.text(It?"":"",{size:14}),e.pos(Wt,xe),e.anchor("center"),e.color(It?255:120,It?255:120,It?255:120),e.fixed(),e.z(w.UI_TEXT)]),ot=lt;fn.onClick(()=>ee(ot)),fn.cursor="pointer",b.push(fn,Ee)}const fe=e.add([e.rect(30,30),e.pos(L,xe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),nt=e.add([e.text("<",{size:24}),e.pos(L,xe),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);if(r>0){const lt=r-1;fe.onClick(()=>ee(lt)),fe.cursor="pointer"}b.push(fe,nt);const rt=e.add([e.rect(30,30),e.pos(V,xe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Vt=e.add([e.text(">",{size:24}),e.pos(V,xe),e.anchor("center"),e.color(r<He-1?255:80,r<He-1?255:80,r<He-1?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);if(r<He-1){const lt=r+1;rt.onClick(()=>ee(lt)),rt.cursor="pointer"}b.push(rt,Vt)}const Nt=Object.keys(No).length,wt=n.length,Ie=wt/Nt,Pe=Ie>=1,Ge=N-20,$e=e.width()/2,je=e.add([e.text("",{size:24}),e.pos($e-220,Ge),e.anchor("center"),e.color(Pe?255:150,Pe?215:150,Pe?0:150),e.fixed(),e.scale(1),e.z(1002)]);if(b.push(je),Pe){let xe=0;je.onUpdate(()=>{xe+=e.dt();const Ze=1+Math.sin(xe*3)*.1;je.scale=e.vec2(Ze,Ze)})}const ct=20,at=Math.floor(Ie*ct),st=ct-at;let ut="";for(let xe=0;xe<at;xe++)ut+="";for(let xe=0;xe<st;xe++)ut+="";const Rt=e.add([e.text("|"+"".repeat(ct)+"|",{size:16}),e.pos($e,Ge),e.anchor("center"),e.color(60,60,80),e.fixed(),e.z(1e3)]);b.push(Rt);let Dt;Pe?Dt=[255,215,0]:Ie>=.75?Dt=[100,255,100]:Ie>=.5?Dt=[255,255,100]:Ie>=.25?Dt=[255,180,100]:Dt=[200,200,200];const Yt=e.add([e.text("|"+ut+"|",{size:16}),e.pos($e,Ge),e.anchor("center"),e.color(...Dt),e.fixed(),e.z(1001)]);if(b.push(Yt),Pe){let xe=0;Yt.onUpdate(()=>{xe+=e.dt();const Ze=xe*60%360,re=CM(Ze/360,1,.6);Yt.color=e.rgb(re[0],re[1],re[2])})}const Pt=Math.round(Ie*100),Zt=Pe?"COMPLETE!":`${Pt}%`,dt=e.add([e.text(`${wt}/${Nt}`,{size:14}),e.pos($e+180,Ge-8),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1002)]);b.push(dt);const Tt=e.add([e.text(Zt,{size:12}),e.pos($e+180,Ge+8),e.anchor("center"),e.color(...Pe?[255,215,0]:[150,150,180]),e.fixed(),e.opacity(1),e.z(1002)]);if(b.push(Tt),Pe){let xe=0;Tt.onUpdate(()=>{xe+=e.dt();const Ze=Math.sin(xe*4)*.3+.7;Tt.opacity=Ze})}}catch(P){console.error("Error rendering achievements:",P);const z=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,R+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);b.push(z)}else if(i==="history"){const P=ib(),z=R+10,U=35;if(P.length===0){const F=e.add([e.text("No run history yet. Complete a run to see it here!",{size:16}),e.pos(e.width()/2,z+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);b.push(F)}else{const F=Math.ceil(P.length/c);r>=F&&(r=Math.max(0,F-1));const B=r*c,D=Math.min(B+c,P.length),q=P.slice(B,D),G=["#","Floor","Rooms","Kills","Level","Credits","Time"],Z=[60,120,200,280,360,450,550];if(G.forEach((se,he)=>{const Me=e.add([e.text(se,{size:14}),e.pos(Z[he],z),e.anchor("left"),e.color(255,200,100),e.fixed(),e.z(1e3)]);b.push(Me)}),q.forEach((se,he)=>{const Me=z+(he+1)*U,He=B+he+1,we=Math.floor(se.duration/60),De=se.duration%60,Qe=`${we}:${De.toString().padStart(2,"0")}`;[`${He}`,`${se.floorsReached}`,`${se.roomsCleared}`,`${se.enemiesKilled}`,`${se.level}`,`${o}${se.currencyEarned}`,Qe].forEach((pt,pe)=>{const Se=e.add([e.text(pt,{size:14}),e.pos(Z[pe],Me),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]);b.push(Se)})}),F>1){const se=N-55,he=e.width()/2,Me=20,He=he-(F-1)*Me/2;for(let pe=0;pe<F;pe++){const Se=pe===r,ae=He+pe*Me,Xe=e.add([e.rect(16,16),e.pos(ae,se),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(1e3)]),qe=e.add([e.text(Se?"":"",{size:14}),e.pos(ae,se),e.anchor("center"),e.color(Se?255:120,Se?255:120,Se?255:120),e.fixed(),e.z(1001)]),Ce=pe;Xe.onClick(()=>{d||Ce===r||(d=!0,tt(),r=Ce,M(),e.wait(.1,()=>{d=!1}))}),Xe.cursor="pointer",b.push(Xe,qe)}const we=Math.max(30,F*Me/2+25),De=e.add([e.rect(30,30),e.pos(he-we,se),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),Qe=e.add([e.text("<",{size:24}),e.pos(he-we,se),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(1003)]);r>0&&(De.onClick(()=>{d||(d=!0,tt(),r--,M(),e.wait(.1,()=>{d=!1}))}),De.cursor="pointer"),b.push(De,Qe);const Ae=e.add([e.rect(30,30),e.pos(he+we,se),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),pt=e.add([e.text(">",{size:24}),e.pos(he+we,se),e.anchor("center"),e.color(r<F-1?255:80,r<F-1?255:80,r<F-1?255:80),e.fixed(),e.z(1003)]);r<F-1&&(Ae.onClick(()=>{d||(d=!0,tt(),r++,M(),e.wait(.1,()=>{d=!1}))}),Ae.cursor="pointer"),b.push(Ae,pt)}const le=B+1,ie=D,oe=e.add([e.text(`Showing ${le}-${ie} of ${P.length} runs`,{size:12}),e.pos(e.width()/2,N-20),e.anchor("center"),e.color(100,100,150),e.fixed(),e.z(1e3)]);b.push(oe)}}}M();const{SM:_}=Mi.BUTTON,O=e.add([e.rect(_.width,_.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),O.onClick(()=>{tt(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const Uo={BREATHE_SPEED:1.5,BREATHE_AMOUNT:.04,BOB_SPEED:2,BOB_AMOUNT:3,GLOW_PULSE_SPEED:2,GLOW_MIN:.3,GLOW_MAX:.7};function AM(e){if(!e.unlockRequirement)return null;if(e.unlockRequirement.type==="floor")return`Unlock: Complete ${Ia.FLOOR} ${e.unlockRequirement.value}`;if(e.unlockRequirement.type==="achievement"){const t=No[e.unlockRequirement.value];return t?`Unlock: ${t.name}`:"Unlock: Achievement required"}return null}function TM(e){e.scene("characterSelect",()=>{const t=Wi(),n=Qo();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),oa(e,{patternCount:10,particleCount:15}),Xh(e,t),ia(e,"CONTESTANTS",e.width()/2,60,8);const o=Object.keys(ln),i=360,s=i+20,r=e.width()-s-20,l=110,c=165,d=70,a=8,h=2,u=5,p=h*u,g=B=>B.replace(/^The\s+/i,""),A=(B,D,q,G)=>{const Z=[],le=/([+-]?\d+%?\s*(?:XP|health|HP|speed|damage|crit|dodge|reduction|lifesteal|blast radius|drones?|orbital))/gi,ie=B.split(le),oe=B.match(le)||[];ie.forEach((he,Me)=>{});const se=e.add([e.text(B,{size:Q.SMALL,width:G}),e.pos(D,q),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);if(Z.push(se),oe.length>0){const he=oe.join(" | "),Me=e.add([e.text(he,{size:Q.TINY}),e.pos(D,q+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT+1)]);Z.push(Me)}return Z},m=Math.ceil(o.length/p);let C=0;const I=o.indexOf(n);I>=0&&(C=Math.floor(I/p));const R=[],f=n;let N=f,b=[],T=[],x=!1;function M(){if(x)return;x=!0,R.forEach(ae=>{ae&&ae.exists&&ae.exists()&&e.destroy(ae)}),R.length=0,b.forEach(ae=>{ae&&ae.exists&&ae.exists()&&e.destroy(ae)}),b=[],T.forEach(ae=>{ae&&ae.exists&&ae.exists()&&e.destroy(ae)}),T=[];const B=C*p,D=Math.min(B+p,o.length);if(o.slice(B,D).forEach((ae,Xe)=>{const qe=ln[ae],Ce=mo("characters",ae)||qe.unlockedByDefault,Ve=N===ae,We=f===ae,At=Math.floor(Xe/h),wt=20+Xe%h*(c+a),Ie=l+At*(d+a),Pe=e.add([e.rect(c,d),e.pos(wt,Ie),e.anchor("topleft"),e.color(...Ve?y.BG_MEDIUM:y.BG_DARK),e.outline(2,Ve?e.rgb(...y.BORDER_ACTIVE):Ce?e.rgb(...y.TEXT_DISABLED):e.rgb(...y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS),{baseX:wt,baseY:Ie,isHovered:!1}]),Ge=e.add([e.text(qe.char,{size:Q.HEADER}),e.pos(wt+28,Ie+d/2),e.anchor("center"),e.color(...Ce?qe.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(w.UI_TEXT),{baseX:wt+28,baseY:Ie+d/2}]),$e=e.add([e.text(g(qe.name),{size:Q.SMALL}),e.pos(wt+60,Ie+d/2),e.anchor("left"),e.color(...Ce?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(w.UI_TEXT),{baseX:wt+60,baseY:Ie+d/2}]);if(Pe.onHoverUpdate(()=>{if(!Pe.isHovered&&!Ve&&(Pe.isHovered=!0,tt()),!Ve){Pe.scale=e.vec2(1.05,1.05),Ge.scale=e.vec2(1.15,1.15),$e.scale=e.vec2(1.05,1.05),Pe.color=e.rgb(50,50,65);const je=Math.sin(e.time()*8)*2;Ge.pos.y=Ge.baseY+je}}),Pe.onHoverEnd(()=>{Pe.isHovered=!1,Pe.scale=e.vec2(1,1),Ge.scale=e.vec2(1,1),$e.scale=e.vec2(1,1),Pe.color=e.rgb(...Ve?y.BG_MEDIUM:y.BG_DARK),Ge.pos.y=Ge.baseY}),!Ce){const je=e.add([e.text("",{size:Q.SMALL}),e.pos(wt+c-18,Ie+d/2),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.OVERLAY)]);R.push(je)}if(We){const je=e.add([e.circle(8),e.pos(wt+c-10,Ie+12),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT+1)]),ct=e.add([e.text("",{size:10}),e.pos(wt+c-10,Ie+12),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT+2)]);R.push(je,ct)}Pe.onClick(()=>{N!==ae&&(Gt(),N=ae,M())}),Pe.cursor="pointer",R.push(Pe,Ge,$e)}),m>1){const ae=l+u*(d+a)+15,Xe=i/2,qe=20,Ce=Xe-(m-1)*qe/2,Ve=Xe+(m-1)*qe/2,We=25,At=Ce-We,Nt=Ve+We;for(let $e=0;$e<m;$e++){const je=$e===C,ct=Ce+$e*qe,at=e.add([e.rect(16,16),e.pos(ct,ae),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),st=e.add([e.text(je?"":"",{size:14}),e.pos(ct,ae),e.anchor("center"),e.color(je?255:120,je?255:120,je?255:120),e.fixed(),e.z(w.UI_TEXT)]),ut=$e;at.onClick(()=>{ut!==C&&(tt(),C=ut,M())}),at.cursor="pointer",T.push(at,st)}const wt=e.add([e.rect(30,30),e.pos(At,ae),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Ie=e.add([e.text("<",{size:24}),e.pos(At,ae),e.anchor("center"),e.color(C>0?255:80,C>0?255:80,C>0?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);C>0&&(wt.onClick(()=>{tt(),C--,M()}),wt.cursor="pointer"),T.push(wt,Ie);const Pe=e.add([e.rect(30,30),e.pos(Nt,ae),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Ge=e.add([e.text(">",{size:24}),e.pos(Nt,ae),e.anchor("center"),e.color(C<m-1?255:80,C<m-1?255:80,C<m-1?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);C<m-1&&(Pe.onClick(()=>{tt(),C++,M()}),Pe.cursor="pointer"),T.push(Pe,Ge)}const G=ln[N],Z=mo("characters",N)||G.unlockedByDefault;let le=l;const ie=e.add([e.rect(r-10,380),e.pos(s+5,l-10),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(w.UI_ELEMENTS-1)]);b.push(ie);const oe=e.add([e.circle(50),e.pos(s+r/2,le+45),e.anchor("center"),e.color(...Z?G.color:[80,80,80]),e.opacity(Uo.GLOW_MIN),e.scale(1),e.fixed(),e.z(w.UI_ELEMENTS)]);b.push(oe);const se=e.add([e.text(G.char,{size:72}),e.pos(s+r/2,le+45),e.anchor("center"),e.color(...Z?G.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS+1),{baseY:le+45,baseScale:1,animTime:Math.random()*Math.PI*2}]);b.push(se);const he=e.onUpdate(()=>{if(!se.exists())return;se.animTime+=e.dt();const ae=1+Math.sin(se.animTime*Uo.BREATHE_SPEED)*Uo.BREATHE_AMOUNT;se.scale=e.vec2(ae,ae);const Xe=Math.sin(se.animTime*Uo.BOB_SPEED)*Uo.BOB_AMOUNT;if(se.pos.y=se.baseY+Xe,oe.exists()){const qe=Uo.GLOW_MIN+(Math.sin(se.animTime*Uo.GLOW_PULSE_SPEED)*.5+.5)*(Uo.GLOW_MAX-Uo.GLOW_MIN);oe.opacity=qe,oe.scale=e.vec2(1+qe*.3,1+qe*.3)}});b.push({exists:()=>!0,destroy:()=>he.cancel()}),le+=110;const Me=e.add([e.text(g(G.name),{size:Q.HEADER}),e.pos(s+r/2,le),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);b.push(Me),le+=35;const He=A(G.description,s+r/2,le,r-40);b.push(...He),le+=55;const we=e.add([e.text("Stats:",{size:Q.LABEL}),e.pos(s+20,le),e.anchor("left"),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT)]);b.push(we),le+=28;const De=100,Qe=s+40,Ae=24,pt=Mc(e,{label:Ia.HEALTH,value:G.stats.health,maxValue:175,x:Qe,y:le,width:De,usePercentageColor:!0});b.push(...pt.elements),le+=Ae;const pe=Mc(e,{label:Ia.SPEED,value:G.stats.speed,maxValue:225,x:Qe,y:le,width:De,usePercentageColor:!0});b.push(...pe.elements),le+=Ae;const Se=Mc(e,{label:Ia.DAMAGE,value:G.stats.damage,maxValue:25,x:Qe,y:le,width:De,usePercentageColor:!0});if(b.push(...Se.elements),le+=30,N===f){const ae=e.add([e.text(" CURRENT SELECTION",{size:Q.LABEL}),e.pos(s+r/2,le),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT)]);b.push(ae)}if(!Z){const ae=AM(G);if(ae){const Xe=e.add([e.text(ae,{size:Q.SMALL,width:r-40}),e.pos(s+r/2,le+30),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);b.push(Xe)}}x=!1}M(),e.onKeyPress("arrowleft",()=>{C>0&&(tt(),C--,M())}),e.onKeyPress("arrowright",()=>{C<m-1&&(tt(),C++,M())});const _=e.add([e.rect(120,35),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text(Wr("Cancel"),{size:Q.BODY}),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),_.onClick(()=>{tt(),e.go("menu")});let O=null,P=null,z=[];function U(){z.forEach(q=>{q&&q.exists&&q.exists()&&e.destroy(q)}),z=[];const B=ln[N],D=mo("characters",N)||B.unlockedByDefault;O=e.add([e.rect(120,35),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(...D?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(...D?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),z.push(O),P=e.add([e.text(Wr("Confirm"),{size:Q.BODY}),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(...D?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]),z.push(P),D&&(O.onClick(()=>{Gt(),Ou(N),Ff(N),e.go("menu")}),O.cursor="pointer")}U();const F=M;M=function(){F(),U()},e.onKeyPress("escape",()=>{tt(),e.go("menu")}),e.onKeyPress("enter",()=>{const B=ln[N];(mo("characters",N)||B.unlockedByDefault)&&(Gt(),Ou(N),Ff(N),e.go("menu"))})})}function MM(e){e.scene("joinParty",()=>{const t={name:Yn(),inviteCode:vi(),character:Qo()};let n=!1;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:Q.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:Q.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(10)]);let o="";const i=e.add([e.text("______",{size:Q.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(10)]),s=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:Q.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(10)]);let r=!1;function l(){let h="";for(let u=0;u<6;u++)u<o.length?h+=o[u]:h+="_";i.text=h}e.onCharInput(h=>{r||/[a-zA-Z0-9]/.test(h)&&o.length<6&&(tt(),o+=h.toUpperCase(),l(),s.text="",o.length===6&&e.wait(.2,c))}),e.onKeyPress("backspace",()=>{r||o.length>0&&(tt(),o=o.slice(0,-1),l(),s.text="")}),e.onKeyPress("escape",()=>{tt(),n=!0,r=!1,hl(t),e.go("menu")}),e.onKeyPress("enter",()=>{r||o.length===6&&c()});async function c(){if(r)return;const h=o.trim();if(!Fw(h)){s.text="Invalid invite code format",s.color=e.rgb(255,100,100);return}r=!0,s.text="Joining party...",s.color=e.rgb(...y.GOLD);try{if(await Im(h)){if(n)return;Gt(),s.text="Successfully joined party!",s.color=e.rgb(...y.SUCCESS),e.wait(1,()=>{n||e.go("menu")})}else r=!1,s.text="Failed to join party. Check the code and try again.",s.color=e.rgb(255,100,100),o="",l()}catch(u){r=!1,console.error("[JoinParty] Error joining party:",u),s.text="Connection error. Please try again.",s.color=e.rgb(255,100,100),o="",l()}}const{MD:d}=Mi.BUTTON,a=e.add([e.rect(d.width,d.height),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("CANCEL",{size:Q.BODY}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(11)]),a.onClick(()=>{tt(),n=!0,r=!1,hl(t),e.go("menu")}),a.onHoverUpdate(()=>{r||(a.color=e.rgb(...y.NEUTRAL_HOVER))}),a.onHoverEnd(()=>{a.color=e.rgb(...y.NEUTRAL)})})}const Ao={DAILY:"daily",ALL_TIME:"allTime",PERSONAL:"personal",GLOBAL:"global"};function RM(e){e.scene("leaderboards",(t={})=>{let o=t.tab||Ao.DAILY;const i=10,s=5;let r=0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(w.BACKGROUND)]),e.add([e.text("LEADERBOARDS",{size:Q.TITLE}),e.pos(e.width()/2,50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);const l=100,c=115,d=8,a=c*4+d*3,h=(e.width()-a)/2,u=160;let p=[];function g(_,O,P){const z=o===O,U=e.add([e.rect(c,40),e.pos(P,l),e.anchor("center"),e.color(...z?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...z?y.BORDER_HOVER:y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS),"tab"]),F=e.add([e.text(_,{size:Q.BODY}),e.pos(P,l),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"tab"]);return U.onClick(()=>{o!==O&&(tt(),o=O,r=0,A(),m())}),U.onHoverUpdate(()=>{o!==O&&(U.color=e.rgb(...y.BG_LIGHT))}),U.onHoverEnd(()=>{o!==O&&(U.color=e.rgb(...y.BG_MEDIUM))}),{bg:U,label:F,tabType:O}}function A(){e.get("tab").forEach(_=>e.destroy(_)),g("DAILY",Ao.DAILY,h+c/2),g("ALL-TIME",Ao.ALL_TIME,h+c+d+c/2),g("PERSONAL",Ao.PERSONAL,h+(c+d)*2+c/2),g("GLOBAL",Ao.GLOBAL,h+(c+d)*3+c/2)}function m(){switch(p.forEach(_=>{_.exists()&&e.destroy(_)}),p=[],o){case Ao.DAILY:C();break;case Ao.ALL_TIME:I();break;case Ao.PERSONAL:R();break;case Ao.GLOBAL:f();break}}function C(){const _=bo(),O=tu(_),P=ln[O]||ln.survivor,z=gM(_,100),U=Yn(),F=Math.ceil(z.length/i);r>=F&&F>0&&(r=F-1);const B=r*i,D=z.slice(B,B+i),q=e.add([e.text(`Date: ${_}`,{size:Q.BODY}),e.pos(e.width()/2-100,u),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(q);const G=e.add([e.text(`Character: ${P.char} ${P.name}`,{size:Q.BODY}),e.pos(e.width()/2+50,u),e.anchor("left"),e.color(...P.color),e.fixed(),e.z(w.UI_TEXT)]);p.push(G);const Z=u+40;if(b(Z),z.length===0){const le=e.add([e.text("No entries yet. Be the first!",{size:Q.BODY}),e.pos(e.width()/2,Z+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);p.push(le)}else D.forEach((le,ie)=>{const oe=Z+40+ie*35,se=le.name.toLowerCase()===U.toLowerCase(),he=B+ie+1;T(he,le,oe,se)}),F>1&&N(Z+40+i*35+10,F)}function I(){const _=mM(100),O=Yn(),P=Math.ceil(_.length/i);r>=P&&P>0&&(r=P-1);const z=r*i,U=_.slice(z,z+i),F=u+10;if(b(F),_.length===0){const B=e.add([e.text("No entries yet. Play a game!",{size:Q.BODY}),e.pos(e.width()/2,F+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);p.push(B)}else U.forEach((B,D)=>{const q=F+40+D*35,G=B.name.toLowerCase()===O.toLowerCase(),Z=z+D+1;T(Z,B,q,G)}),P>1&&N(F+40+i*35+10,P)}function R(){const _=yM(),O=Object.keys(ln),P=Math.ceil(O.length/s);r>=P&&(r=Math.max(0,P-1));const z=r*s,U=O.slice(z,z+s),F=u+10,B=["Character","Best Score","Best Floor","Best Time"],D=[120,280,420,540];B.forEach((G,Z)=>{const le=e.add([e.text(G,{size:Q.SMALL}),e.pos(D[Z],F),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(le)});const q=e.add([e.rect(500,2),e.pos(e.width()/2,F+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(w.UI_ELEMENTS)]);if(p.push(q),U.forEach((G,Z)=>{const le=ln[G],ie=_[G],oe=F+45+Z*40,se=e.add([e.text(`${le.char} ${le.name}`,{size:Q.BODY}),e.pos(D[0],oe),e.anchor("left"),e.color(...le.color),e.fixed(),e.z(w.UI_TEXT)]);if(p.push(se),ie){const he=e.add([e.text(Pd(ie.bestScore),{size:Q.BODY}),e.pos(D[1],oe),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(he);const Me=e.add([e.text(`Floor ${ie.bestFloor}`,{size:Q.BODY}),e.pos(D[2],oe),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(Me);const He=e.add([e.text(Ap(ie.bestTime),{size:Q.BODY}),e.pos(D[3],oe),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(He)}else{const he=e.add([e.text("-- no data --",{size:Q.SMALL}),e.pos(D[1],oe),e.anchor("left"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);p.push(he)}}),P>1){const G=F+45+s*40+20;N(G,P)}}function f(){const _=Yn(),O=u+10,P=e.add([e.text("Connecting to global leaderboard...",{size:Q.BODY}),e.pos(e.width()/2,O+100),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(P),py(10).then(z=>{if(P.exists()){e.destroy(P);const F=p.indexOf(P);F>-1&&p.splice(F,1)}if(o!==Ao.GLOBAL)return;if(z.error){const F=e.add([e.text(z.error,{size:Q.BODY}),e.pos(e.width()/2,O+80),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.UI_TEXT)]);p.push(F);const B=e.add([e.rect(120,35),e.pos(e.width()/2,O+130),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);p.push(B);const D=e.add([e.text("Try Again",{size:Q.SMALL}),e.pos(e.width()/2,O+130),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(D),B.onClick(()=>{tt(),m()}),B.onHoverUpdate(()=>{B.color=e.rgb(...y.SECONDARY_HOVER)}),B.onHoverEnd(()=>{B.color=e.rgb(...y.SECONDARY)});return}const U=z.entries;if(b(O),U.length===0){const F=e.add([e.text("No global entries yet. Be the first!",{size:Q.BODY}),e.pos(e.width()/2,O+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);p.push(F)}else U.forEach((F,B)=>{const D=O+40+B*35,q=F.name.toLowerCase()===_.toLowerCase();T(B+1,F,D,q)});if(z.totalCount>0){const F=O+40+Math.min(U.length,10)*35+20,B=e.add([e.text(`${z.totalCount} player${z.totalCount!==1?"s":""} worldwide`,{size:Q.SMALL}),e.pos(e.width()/2,F),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(B)}})}function N(_,O){const P=e.width()/2,z=20,U=P-(O-1)*z/2,F=P+(O-1)*z/2,B=25,D=U-B,q=F+B;for(let oe=0;oe<O;oe++){const se=oe===r,he=U+oe*z,Me=e.add([e.rect(16,16),e.pos(he,_),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),He=e.add([e.text(se?"":"",{size:14}),e.pos(he,_),e.anchor("center"),e.color(se?255:120,se?255:120,se?255:120),e.fixed(),e.z(w.UI_TEXT)]),we=oe;Me.onClick(()=>{we!==r&&(tt(),r=we,m())}),Me.cursor="pointer",p.push(Me,He)}const G=e.add([e.rect(30,30),e.pos(D,_),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Z=e.add([e.text("<",{size:24}),e.pos(D,_),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);r>0&&(G.onClick(()=>{tt(),r--,m()}),G.cursor="pointer"),p.push(G,Z);const le=e.add([e.rect(30,30),e.pos(q,_),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),ie=e.add([e.text(">",{size:24}),e.pos(q,_),e.anchor("center"),e.color(r<O-1?255:80,r<O-1?255:80,r<O-1?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);r<O-1&&(le.onClick(()=>{tt(),r++,m()}),le.cursor="pointer"),p.push(le,ie)}function b(_){const O=["#","Name","Score","Floor","Time"],P=[80,150,350,470,560];O.forEach((U,F)=>{const B=e.add([e.text(U,{size:Q.SMALL}),e.pos(P[F],_),e.anchor(F===0?"center":"left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);p.push(B)});const z=e.add([e.rect(550,2),e.pos(e.width()/2,_+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(w.UI_ELEMENTS)]);p.push(z)}function T(_,O,P,z=!1){const U=[80,150,350,470,560],F=z?y.GOLD:y.TEXT_PRIMARY,B=ln[O.character]||ln.survivor,D=e.add([e.text(_<=3?["","1st","2nd","3rd"][_]:`${_}`,{size:Q.BODY}),e.pos(U[0],P),e.anchor("center"),e.color(..._===1?[255,215,0]:_===2?[192,192,192]:_===3?[205,127,50]:F),e.fixed(),e.z(w.UI_TEXT)]);p.push(D);const q=e.add([e.text(`${B.char} ${O.name}`,{size:Q.BODY}),e.pos(U[1],P),e.anchor("left"),e.color(...F),e.fixed(),e.z(w.UI_TEXT)]);p.push(q);const G=e.add([e.text(Pd(O.score),{size:Q.BODY}),e.pos(U[2],P),e.anchor("left"),e.color(...F),e.fixed(),e.z(w.UI_TEXT)]);p.push(G);const Z=e.add([e.text(`${O.floor}`,{size:Q.BODY}),e.pos(U[3],P),e.anchor("left"),e.color(...F),e.fixed(),e.z(w.UI_TEXT)]);p.push(Z);const le=e.add([e.text(Ap(O.time),{size:Q.BODY}),e.pos(U[4],P),e.anchor("left"),e.color(...F),e.fixed(),e.z(w.UI_TEXT)]);if(p.push(le),z){const ie=e.add([e.rect(550,30),e.pos(e.width()/2,P),e.anchor("center"),e.color(...y.GOLD),e.opacity(.1),e.fixed(),e.z(w.UI_BACKGROUND+1)]);p.push(ie)}}const{SM:x}=Mi.BUTTON,M=e.add([e.rect(x.width,x.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),M.onClick(()=>{Gt(),e.go("menu")}),M.onHoverUpdate(()=>{M.color=e.rgb(...y.SECONDARY_HOVER)}),M.onHoverEnd(()=>{M.color=e.rgb(...y.SECONDARY)}),e.onKeyPress("escape",()=>{Gt(),e.go("menu")}),A(),m()})}function DM(e,t,n){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(w.OVERLAY)]),r=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(w.OVERLAY+1)]),l=e.add([e.text("Edit Player Name",{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]),c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(w.OVERLAY+2)]);let d=t;const a=e.add([e.text(d,{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.OVERLAY+3)]),h=e.add([e.text("(Max 20 characters)",{size:Q.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.OVERLAY+2)]),u=[o,r,l,c,a,h];function p(){u.forEach(b=>{b&&b.exists&&b.exists()&&e.destroy(b)})}const g=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),A=e.add([e.text("Cancel",{size:Q.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+3)]);g.onClick(()=>{tt(),p()}),u.push(g,A);const m=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),C=e.add([e.text("Save",{size:Q.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.OVERLAY+3)]);m.onClick(()=>{d.trim().length>0?(Gt(),n(d.trim()),p()):(h.text="Name cannot be empty!",h.color=e.rgb(255,100,100))}),u.push(m,C);const I=e.onCharInput(b=>{d.length<20&&/[a-zA-Z0-9 ]/.test(b)&&(d+=b,a.text=d,h.text="(Max 20 characters)",h.color=e.rgb(...y.TEXT_SECONDARY))}),R=e.onKeyPress("backspace",()=>{d.length>0&&(d=d.slice(0,-1),a.text=d||" ")}),f=e.onKeyPress("escape",()=>{p(),I.cancel(),R.cancel(),f.cancel(),N.cancel()}),N=e.onKeyPress("enter",()=>{d.trim().length>0&&(Gt(),n(d.trim()),p(),I.cancel(),R.cancel(),f.cancel(),N.cancel())})}function IM(e){e.scene("profile",(t={})=>{const n=t.externalProfile||null,o=n!==null,i=o?n:vt();let s=o?n.selectedPortrait:Fs();const r=o?n.stats:Us(),l=o?n.playerLevel:_i(),c=o?n.totalXP:Ml(),d=o?n.playerName:Yn();o&&n.achievements;const a=o?n.unlockedPortraits:eg();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),oa(e,{patternCount:8,particleCount:12}),o?e.add([e.text(`${d}'s Profile`,{size:Q.H1}),e.pos(e.width()/2,35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]):ia(e,"PROFILE",e.width()/2,35,8);const h=80,u=140,p=720,g=e.width()/2;e.add([e.rect(p,u),e.pos(g,h+u/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const A=80,m=g-p/2+60,C=h+u/2,I=Rd(s)||es.default;e.add([e.rect(A,A),e.pos(m,C),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(3,e.rgb(...I.color||[200,200,200])),e.fixed(),e.z(w.UI_BACKGROUND+1)]),e.add([e.text(I.icon,{size:40}),e.pos(m,C-5),e.anchor("center"),e.color(...I.color||[200,200,200]),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(`LV${l}`,{size:12}),e.pos(m,C+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);const R=m+80;let f=h+20,N=d;const b=e.add([e.text(N,{size:Q.H1}),e.pos(R,f),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);if(!o){const Pe=g+p/2-20,Ge=Pe-24-8,$e=e.add([e.rect(24,24),e.pos(Ge,f),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Ge-24/2,f),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),$e.onClick(()=>{Gt(),DM(e,N,ct=>{Nu(ct),b.text=ct,N=ct})}),$e.onHoverUpdate(()=>{$e.color=e.rgb(...y.BG_LIGHT)}),$e.onHoverEnd(()=>{$e.color=e.rgb(...y.BG_MEDIUM)});const je=e.add([e.rect(24,24),e.pos(Pe,f),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Pe-24/2,f),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]),je.onClick(()=>{Gt();const ct=$c();Nu(ct),b.text=ct,N=ct}),je.onHoverUpdate(()=>{je.color=e.rgb(...y.BG_LIGHT)}),je.onHoverEnd(()=>{je.color=e.rgb(...y.BG_MEDIUM)})}f+=35;const T=Math.min(5,Math.floor(l/10)),x="".repeat(T)+"".repeat(5-T);e.add([e.text(`Level ${l}  ${x}`,{size:Q.LABEL}),e.pos(R,f),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),f+=30;const M=250,_=16,O=o?0:Qd(),P=c,z=o?c:k0();e.add([e.rect(M,_),e.pos(R,f),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(w.UI_BACKGROUND+1)]);const U=Math.max(2,M*O);e.add([e.rect(U,_-4),e.pos(R+2,f),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(w.UI_ELEMENTS)]),e.add([e.text(`${Math.round(O*100)}%`,{size:10}),e.pos(R+M/2,f),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),f+=22,e.add([e.text(`${P.toLocaleString()} / ${z.toLocaleString()} XP`,{size:Q.SMALL}),e.pos(R,f),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const F=h+u+10,B=165;e.add([e.rect(p,B),e.pos(g,F+B/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const D=GT(),q=40,G=50,Z=13,le=(Z-1)*G,ie=g-le/2,oe=F+28;let se=null,he=null;function Me(Ie){se&&se.exists()&&(se.text=`Selected: "${Ie.name}"`),he&&he.exists()&&(he.text=Ie.description)}D.forEach((Ie,Pe)=>{const Ge=Math.floor(Pe/Z),$e=Pe%Z,je=ie+$e*G,ct=oe+Ge*(G+5),at=o?a.includes(Ie.id):KT(Ie.id,i),st=Ie.id===s,ut=at?st?[80,100,140]:y.BG_LIGHT:[40,40,50],Rt=st?y.GOLD:at?Ie.color:[80,80,80],Dt=e.add([e.rect(q,q),e.pos(je,ct),e.anchor("center"),e.color(...ut),e.outline(st?3:2,e.rgb(...Rt)),o?null:e.area(),e.fixed(),e.z(w.UI_ELEMENTS)].filter(Boolean)),Yt=at?Ie.color:[80,80,80];e.add([e.text(Ie.icon,{size:24}),e.pos(je,ct-3),e.anchor("center"),e.color(...Yt),e.fixed(),e.z(w.UI_TEXT)]);const Pt=at?Ie.name.substring(0,8):"???";e.add([e.text(Pt,{size:8}),e.pos(je,ct+q/2+8),e.anchor("center"),e.color(...at?y.TEXT_SECONDARY:[80,80,80]),e.fixed(),e.z(w.UI_TEXT)]),o||(Dt.onClick(()=>{if(at)Gt(),cb(Ie.id),s=Ie.id,Me(Ie),e.go("profile");else{tt();const Zt=VT(Ie.id);he&&he.exists()&&(he.text=`Locked: ${Zt}`,he.color=e.rgb(...y.DANGER))}}),Dt.onHoverUpdate(()=>{st||(Dt.color=e.rgb(...at?[100,120,160]:[50,50,60]))}),Dt.onHoverEnd(()=>{st||(Dt.color=e.rgb(...ut))}))}),se=e.add([e.text(`Selected: "${I.name}"`,{size:Q.SMALL}),e.pos(g,F+B-35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]),he=e.add([e.text(I.description,{size:Q.SMALL-2}),e.pos(g,F+B-18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const He=F+B+10,we=120;e.add([e.rect(p,we),e.pos(g,He+we/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const De=r,Qe=De.totalRuns||0,Ae=Qe>0?Math.round((De.totalCurrencyEarned||0)/Qe):0,pt=Qe>0?((De.totalFloorsReached||0)/Qe).toFixed(1):"0",pe=Qe>0?((De.totalRoomsCleared||0)/Qe).toFixed(1):"0",Se=De.fastestRunTime||0,ae=Math.floor(Se/60),Xe=Math.floor(Se%60),qe=Se>0?`${ae}:${Xe.toString().padStart(2,"0")}`:"--:--",Ce=[{label:"Total Runs",value:Qe},{label:"Best Floor",value:De.bestFloor||1},{label:"Best Level",value:De.bestLevel||1},{label:"Best Room",value:De.bestRoom||1},{label:"Fastest Run",value:qe}],Ve=p/Ce.length;Ce.forEach((Ie,Pe)=>{const Ge=g-p/2+Ve*Pe+Ve/2,$e=He+15;e.add([e.text(Ie.label,{size:Q.SMALL-2}),e.pos(Ge,$e),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(String(Ie.value),{size:Q.LABEL}),e.pos(Ge,$e+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)])}),[{label:"Enemies",value:(De.totalEnemiesKilled||0).toLocaleString()},{label:"Bosses",value:De.totalBossesKilled||0},{label:"Rooms",value:(De.totalRoomsCleared||0).toLocaleString()},{label:"Avg Floor",value:pt},{label:"Avg Rooms",value:pe}].forEach((Ie,Pe)=>{const Ge=g-p/2+Ve*Pe+Ve/2,$e=He+50;e.add([e.text(Ie.label,{size:Q.SMALL-2}),e.pos(Ge,$e),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(String(Ie.value),{size:Q.SMALL}),e.pos(Ge,$e+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)])}),[{label:"Total Money",value:(De.totalCurrencyEarned||0).toLocaleString()},{label:"Spent",value:(De.totalCurrencySpent||0).toLocaleString()},{label:"Avg Money",value:Ae.toLocaleString()},{label:"Floors",value:(De.totalFloorsReached||0).toLocaleString()},{label:"Play Time",value:(()=>{const Ie=De.totalPlayTime||0,Pe=Math.floor(Ie/3600),Ge=Math.floor(Ie%3600/60);return`${Pe}h ${Ge}m`})()}].forEach((Ie,Pe)=>{const Ge=g-p/2+Ve*Pe+Ve/2,$e=He+85;e.add([e.text(Ie.label,{size:Q.SMALL-2}),e.pos(Ge,$e),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(String(Ie.value),{size:Q.SMALL}),e.pos(Ge,$e+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)])});const{SM:Nt}=Mi.BUTTON,wt=e.add([e.rect(Nt.width,Nt.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),wt.onClick(()=>{tt(),e.go("menu")}),wt.onHoverUpdate(()=>{wt.color=e.rgb(...y.NEUTRAL_HOVER)}),wt.onHoverEnd(()=>{wt.color=e.rgb(...y.NEUTRAL)}),e.onKeyPress("escape",()=>{tt(),e.go("menu")})})}const Eo=Uw({width:Zs.CANVAS_WIDTH,height:Zs.CANVAS_HEIGHT,background:Zs.BACKGROUND_COLOR,scale:Zs.CANVAS_SCALE,debug:Zs.DEBUG_MODE,root:document.querySelector("#game-container"),stretch:!0,letterbox:!0,crisp:!0});oM(Eo);YT(Eo);bM(Eo);EM(Eo);SM(Eo);_M(Eo);TM(Eo);MM(Eo);RM(Eo);IM(Eo);Eo.go("menu");
//# sourceMappingURL=main-ByF80Kgs.js.map
