(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=o(s);fetch(s.href,a)}})();var iu=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return o=>{for(var n=o.length,s=new Uint8Array((n-(o[n-1]=="=")-(o[n-2]=="="))*3/4|0),a=0,r=0;a<n;){var l=e[o.charCodeAt(a++)],c=e[o.charCodeAt(a++)],d=e[o.charCodeAt(a++)],i=e[o.charCodeAt(a++)];s[r++]=l<<2|c>>4,s[r++]=c<<4|d>>2,s[r++]=d<<6|i}return s}})(),au={version:"3001.0.19"};function nn(e,t,o){return t>o?nn(e,o,t):Math.min(Math.max(e,t),o)}var Et=class kt{r=255;g=255;b=255;constructor(t,o,n){this.r=nn(t,0,255),this.g=nn(o,0,255),this.b=nn(n,0,255)}static fromArray(t){return new kt(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new kt(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!o)throw new Error("Invalid hex color format");return new kt(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,o,n){if(o==0)return new kt(255*n,255*n,255*n);let s=(i,h,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<1/6?i+(h-i)*6*u:u<1/2?h:u<2/3?i+(h-i)*(2/3-u)*6:i),a=n<.5?n*(1+o):n+o-n*o,r=2*n-a,l=s(r,a,t+1/3),c=s(r,a,t),d=s(r,a,t-1/3);return new kt(Math.round(l*255),Math.round(c*255),Math.round(d*255))}static RED=new kt(255,0,0);static GREEN=new kt(0,255,0);static BLUE=new kt(0,0,255);static YELLOW=new kt(255,255,0);static MAGENTA=new kt(255,0,255);static CYAN=new kt(0,255,255);static WHITE=new kt(255,255,255);static BLACK=new kt(0,0,0);clone(){return new kt(this.r,this.g,this.b)}lighten(t){return new kt(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new kt(255-this.r,255-this.g,255-this.b)}mult(t){return new kt(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,o){return new kt(So(this.r,t.r,o),So(this.g,t.g,o),So(this.b,t.b,o))}toHSL(){let t=this.r/255,o=this.g/255,n=this.b/255,s=Math.max(t,o,n),a=Math.min(t,o,n),r=(s+a)/2,l=r,c=r;if(s==a)r=l=0;else{let d=s-a;switch(l=c>.5?d/(2-s-a):d/(s+a),s){case t:r=(o-n)/d+(o<n?6:0);break;case o:r=(n-t)/d+2;break;case n:r=(t-o)/d+4;break}r/=6}return[r,l,c]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function Ht(...e){if(e.length===0)return new Et(255,255,255);if(e.length===1){if(e[0]instanceof Et)return e[0].clone();if(typeof e[0]=="string")return Et.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Et.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof Et)return e[0].clone()}else if(e.length===3||e.length===4)return new Et(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var ru=(e,t,o)=>Et.fromHSL(e,t,o);function to(e){return e*Math.PI/180}function qn(e){return e*180/Math.PI}function So(e,t,o){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*o;if(e instanceof ne&&t instanceof ne||e instanceof Et&&t instanceof Et)return e.lerp(t,o);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function en(e,t,o,n,s){return n+(e-t)/(o-t)*(s-n)}function cu(e,t,o,n,s){return nn(en(e,t,o,n,s),n,s)}var ne=class no{x=0;y=0;constructor(t=0,o=t){this.x=t,this.y=o}static fromAngle(t){let o=to(t);return new no(Math.cos(o),Math.sin(o))}static fromArray(t){return new no(t[0],t[1])}static ZERO=new no(0,0);static ONE=new no(1,1);static LEFT=new no(-1,0);static RIGHT=new no(1,0);static UP=new no(0,-1);static DOWN=new no(0,1);clone(){return new no(this.x,this.y)}add(...t){let o=$(...t);return new no(this.x+o.x,this.y+o.y)}sub(...t){let o=$(...t);return new no(this.x-o.x,this.y-o.y)}scale(...t){let o=$(...t);return new no(this.x*o.x,this.y*o.y)}dist(...t){let o=$(...t);return this.sub(o).len()}sdist(...t){let o=$(...t);return this.sub(o).slen()}static sdist(t,o){let n=t.x-o.x,s=t.y-o.y;return n*n+s*s}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new no(0):this.scale(1/t)}normal(){return new no(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,o){return t.x*o.x+t.y*o.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,o){return t.x*o.y-t.y*o.x}angle(...t){let o=$(...t);return qn(Math.atan2(this.y-o.y,this.x-o.x))}angleBetween(...t){let o=$(...t);return qn(Math.atan2(this.cross(o),this.dot(o)))}lerp(t,o){return new no(So(this.x,t.x,o),So(this.y,t.y,o))}slerp(t,o){let n=this.dot(t),s=this.cross(t),a=Math.atan2(s,n);return this.scale(Math.sin((1-o)*a)).add(t.scale(Math.sin(o*a))).scale(1/s)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new no(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Yt(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function $(...e){if(e.length===1){if(e[0]instanceof ne)return new ne(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new ne(...e[0])}return new ne(...e)}var Jt=class Na{x=0;y=0;w=1;h=1;constructor(t,o,n,s){this.x=t,this.y=o,this.w=n,this.h=s}scale(t){return new Na(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new ne(this.x,this.y)}clone(){return new Na(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function eo(e,t,o,n){return new Jt(e,t,o,n)}var Oi=class is{a;b;c;d;constructor(t,o,n,s){this.a=t,this.b=o,this.c=n,this.d=s}mul(t){return new is(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return $(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new is(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new is(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,o=this.det,n=t+Math.sqrt(t*t-o),s=t-Math.sqrt(t*t-o);return[n,s]}eigenvectors(t,o){return this.c!=0?[[t-this.d,this.c],[o-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,o-this.a]]:Math.abs(this.transform($(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let o=Math.cos(t),n=Math.sin(t);return new is(o,n,-n,o)}static scale(t,o){return new is(t,0,0,o)}},zs=class Os{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,o,n,s,a,r,l,c,d){this.m11=t,this.m12=o,this.m13=n,this.m21=s,this.m22=a,this.m23=r,this.m31=l,this.m32=c,this.m33=d}static fromMat2(t){return new Os(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new Oi(this.m11,this.m12,this.m21,this.m22)}mul(t){return new Os(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let o=Math.cos(t),n=Math.sin(t),s=this.m11,a=this.m12;return this.m11=o*this.m11+n*this.m21,this.m12=o*this.m12+n*this.m22,this.m21=o*this.m21-n*s,this.m22=o*this.m22-n*a,this}scale(t,o){return this.m11*=t,this.m12*=t,this.m21*=o,this.m22*=o,this}get inverse(){let t=this.det;return new Os((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new Os(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},sn=class dn{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new dn([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new dn([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t);return new dn([1,0,0,0,0,o,-n,0,0,n,o,0,0,0,0,1])}static rotateY(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t);return new dn([o,0,n,0,0,1,0,0,-n,0,o,0,0,0,0,1])}static rotateZ(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t);return new dn([o,-n,0,0,n,o,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t),s=this.m[0],a=this.m[1],r=this.m[4],l=this.m[5];return this.m[0]=s*o+a*n,this.m[1]=-s*n+a*o,this.m[4]=r*o+l*n,this.m[5]=-r*n+l*o,this}mult(t){let o=[];for(let n=0;n<4;n++)for(let s=0;s<4;s++)o[n*4+s]=this.m[0+s]*t.m[n*4+0]+this.m[4+s]*t.m[n*4+1]+this.m[8+s]*t.m[n*4+2]+this.m[12+s]*t.m[n*4+3];return new dn(o)}multVec2(t){return new ne(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new ne(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new ne(o,t/o)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new ne(t/o,o)}else return new ne(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return qn(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return qn(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new ne(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new ne(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new ne(0,0)}invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],n=this.m[9]*this.m[15]-this.m[13]*this.m[11],s=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],r=this.m[8]*this.m[14]-this.m[12]*this.m[10],l=this.m[8]*this.m[13]-this.m[12]*this.m[9],c=this.m[6]*this.m[15]-this.m[14]*this.m[7],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],i=this.m[5]*this.m[14]-this.m[13]*this.m[6],h=this.m[4]*this.m[15]-this.m[12]*this.m[7],u=this.m[4]*this.m[14]-this.m[12]*this.m[6],p=this.m[5]*this.m[15]-this.m[13]*this.m[7],g=this.m[4]*this.m[13]-this.m[12]*this.m[5],M=this.m[6]*this.m[11]-this.m[10]*this.m[7],m=this.m[5]*this.m[11]-this.m[9]*this.m[7],T=this.m[5]*this.m[10]-this.m[9]*this.m[6],P=this.m[4]*this.m[11]-this.m[8]*this.m[7],f=this.m[4]*this.m[10]-this.m[8]*this.m[6],N=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*n+this.m[7]*s,t[4]=-(this.m[4]*o-this.m[6]*a+this.m[7]*r),t[8]=this.m[4]*n-this.m[5]*a+this.m[7]*l,t[12]=-(this.m[4]*s-this.m[5]*r+this.m[6]*l),t[1]=-(this.m[1]*o-this.m[2]*n+this.m[3]*s),t[5]=this.m[0]*o-this.m[2]*a+this.m[3]*r,t[9]=-(this.m[0]*n-this.m[1]*a+this.m[3]*l),t[13]=this.m[0]*s-this.m[1]*r+this.m[2]*l,t[2]=this.m[1]*c-this.m[2]*d+this.m[3]*i,t[6]=-(this.m[0]*c-this.m[2]*h+this.m[3]*u),t[10]=this.m[0]*p-this.m[1]*h+this.m[3]*g,t[14]=-(this.m[0]*i-this.m[1]*u+this.m[2]*g),t[3]=-(this.m[1]*M-this.m[2]*m+this.m[3]*T),t[7]=this.m[0]*M-this.m[2]*P+this.m[3]*f,t[11]=-(this.m[0]*m-this.m[1]*P+this.m[3]*N),t[15]=this.m[0]*T-this.m[1]*f+this.m[2]*N;let O=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let w=0;w<4;w++)for(let A=0;A<4;A++)t[w*4+A]*=1/O;return new dn(t)}clone(){return new dn([...this.m])}toString(){return this.m.toString()}};function Hl(e,t,o,n=s=>-Math.cos(s)){return e+(n(o)+1)/2*(t-e)}var lu=1103515245,du=12345,mc=2147483648,Ul=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(lu*this.seed+du)%mc,this.seed/mc}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new ne(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new Et(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof ne)return this.genVec2($(0,0),e[0]);if(e[0]instanceof Et)return this.genColor(Ht(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof ne&&e[1]instanceof ne)return this.genVec2(e[0],e[1]);if(e[0]instanceof Et&&e[1]instanceof Et)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},_a=new Ul(Date.now());function hu(e){return e!=null&&(_a.seed=e),_a.seed}function so(...e){return _a.genAny(...e)}function Nl(...e){return Math.floor(so(...e.length>0?e:[2]))}function uu(e){return so()<=e}function _l(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function fu(e,t){return e.length<=t?e.slice():_l(e.slice()).slice(0,t)}function pu(e){return e[Nl(e.length)]}function Xl(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function gu(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let o=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(o===0)return null;let n=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/o,s=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/o;return n<0||n>1||s<0||s>1?null:n}function br(e,t){let o=gu(e,t);return o?$(e.p1.x+o*(e.p2.x-e.p1.x),e.p1.y+o*(e.p2.y-e.p1.y)):null}function wr(e,t){let o=t.p2.sub(t.p1),n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;if(o.x!=0){let a=(e.pos.x-t.p1.x)/o.x,r=(e.pos.x+e.width-t.p1.x)/o.x;n=Math.max(n,Math.min(a,r)),s=Math.min(s,Math.max(a,r))}if(o.y!=0){let a=(e.pos.y-t.p1.y)/o.y,r=(e.pos.y+e.height-t.p1.y)/o.y;n=Math.max(n,Math.min(a,r)),s=Math.min(s,Math.max(a,r))}return s>=n&&s>=0&&n<=1}function oa(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Fl(e,t){let o=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),n=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return $(o,n).sdist(t.center)<=t.radius*t.radius}function Yl(e,t){return ql(t,new xo(e.points()))}function vr(e,t){let o=t.sub(e.p1),n=e.p2.sub(e.p1);if(Math.abs(o.cross(n))>Number.EPSILON)return!1;let s=o.dot(n)/n.dot(n);return s>=0&&s<=1}function ii(e,t){let o=e.p2.sub(e.p1),n=o.dot(o),s=e.p1.sub(t.center),a=2*o.dot(s),r=s.dot(s)-t.radius*t.radius,l=a*a-4*n*r;if(n<=Number.EPSILON||l<0)return!1;if(l==0){let c=-a/(2*n);if(c>=0&&c<=1)return!0}else{let c=(-a+Math.sqrt(l))/(2*n),d=(-a-Math.sqrt(l))/(2*n);if(c>=0&&c<=1||d>=0&&d<=1)return!0}return na(t,e.p1)}function Er(e,t){if(In(t,e.p1)||In(t,e.p2))return!0;for(let o=0;o<t.pts.length;o++){let n=t.pts[o],s=t.pts[(o+1)%t.pts.length];if(br(e,new Co(n,s)))return!0}return!1}function na(e,t){return e.center.sdist(t)<e.radius*e.radius}function mu(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function sa(e,t){let o=t.pts[t.pts.length-1];for(let n of t.pts){if(ii(new Co(o,n),e))return!0;o=n}return na(e,t.pts[0])?!0:In(t,e.center)}function ql(e,t){for(let o=0;o<e.pts.length;o++)if(Er(new Co(e.pts[o],e.pts[(o+1)%e.pts.length]),t))return!0;return!!(e.pts.some(o=>In(t,o))||t.pts.some(o=>In(e,o)))}function In(e,t){let o=!1,n=e.pts;for(let s=0,a=n.length-1;s<n.length;a=s++)n[s].y>t.y!=n[a].y>t.y&&t.x<(n[a].x-n[s].x)*(t.y-n[s].y)/(n[a].y-n[s].y)+n[s].x&&(o=!o);return o}function Ar(e,t){t=t.sub(e.center);let o=to(e.angle),n=Math.cos(o),s=Math.sin(o),a=t.x*n+t.y*s,r=-t.x*s+t.y*n;return a*a/(e.radiusX*e.radiusX)+r*r/(e.radiusY*e.radiusY)<1}function Hi(e,t){let o=t.center.sub(e.center),n=to(e.angle),s=Math.cos(n),a=Math.sin(n),r=o.x*s+o.y*a,l=-o.x*a+o.y*s;return Ar(new gn($(),e.radiusX+t.radius,e.radiusY+t.radius,0),$(r,l))}function Gl(e,t){let o=e.toMat2().inverse;return t=new Co(o.transform(t.p1.sub(e.center)),o.transform(t.p2.sub(e.center))),ii(t,new Do($(),1))}function yu(e,t){if(e.radiusX===e.radiusY)return Hi(t,new Do(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Hi(e,new Do(t.center,t.radiusX));let o=new zs(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),n=new zs(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),s=e.center.x,a=e.center.y,r=t.center.x,l=t.center.y,c=to(e.angle),d=to(t.angle),i=new zs(Math.cos(c),-Math.sin(c),s,Math.sin(c),Math.cos(c),a,0,0,1),h=new zs(Math.cos(d),-Math.sin(d),r,Math.sin(d),Math.cos(d),l,0,0,1),u=i.inverse,p=h.inverse,g=u.transpose.mul(o).mul(u),M=p.transpose.mul(n).mul(p),m=g.m11,T=g.m12,P=g.m13,f=g.m21,N=g.m22,O=g.m23,w=g.m31,A=g.m32,S=g.m33,I=M.m11,E=M.m12,L=M.m13,C=M.m21,F=M.m22,U=M.m23,_=M.m31,H=M.m32,R=M.m33,Y=m*N*S-m*O*A-T*f*S+T*O*w+P*f*A-P*N*w,V=(m*N*R-m*O*H-m*A*U+m*S*F-T*f*R+T*O*_+T*w*U-T*S*C+P*f*H-P*N*_-P*w*F+P*A*C+f*A*L-f*S*E-N*w*L+N*S*I+O*w*E-O*A*I)/Y,Q=(m*F*R-m*U*H-T*C*R+T*U*_+P*C*H-P*F*_-f*E*R+f*L*H+N*I*R-N*L*_-O*I*H+O*E*_+w*E*U-w*L*F-A*I*U+A*L*C+S*I*F-S*E*C)/Y,fe=(I*F*R-I*U*H-E*C*R+E*U*_+L*C*H-L*F*_)/Y;if(V>=0){let se=-3*Q+V**2,ie=3*V*fe+Q*V**2-4*Q**2,ae=-27*fe**2+18*fe*V*Q+V**2*Q**2-4*V**3*fe-4*Q**3;return!(se>0&&ie<0&&ae>0)}else{let se=-3*Q+V**2,ie=-27*fe**2+18*fe*V*Q+V**2*Q**2-4*V**3*fe-4*Q**3;return!(se>0&&ie>0)}}function Kl(e,t){return Sr(e,new xo(t.points()))}function Sr(e,t){let o=e.toMat2().inverse;return t=new xo(t.pts.map(n=>o.transform(n.sub(e.center)))),sa(new Do($(),1),t)}function xu(e,t){return e.x===t.x&&e.y===t.y}function bu(e,t){return t instanceof ne?xu(t,e.pt):t instanceof Do?na(t,e.pt):t instanceof Co?vr(t,e.pt):t instanceof Yt?oa(t,e.pt):t instanceof xo?In(t,e.pt):t instanceof gn?Ar(t,e.pt):!1}function wu(e,t){return t instanceof ne?vr(e,t):t instanceof Do?ii(e,t):t instanceof Co?br(e,t)!=null:t instanceof Yt?wr(t,e):t instanceof xo?Er(e,t):t instanceof gn?Gl(t,e):!1}function vu(e,t){return t instanceof ne?na(e,t):t instanceof Do?mu(e,t):t instanceof Co?ii(t,e):t instanceof Yt?Fl(t,e):t instanceof xo?sa(e,t):t instanceof gn?Hi(t,e):!1}function Eu(e,t){return t instanceof ne?oa(e,t):t instanceof Do?Fl(e,t):t instanceof Co?wr(e,t):t instanceof Yt?Xl(e,t):t instanceof xo?Yl(e,t):t instanceof gn?Kl(t,e):!1}function Au(e,t){return t instanceof ne?In(e,t):t instanceof Do?sa(t,e):t instanceof Co?Er(t,e):t instanceof Yt?Yl(t,e):t instanceof xo?ql(t,e):t instanceof gn?Sr(t,e):!1}function Su(e,t){return t instanceof ne?Ar(e,t):t instanceof Do?Hi(e,t):t instanceof Co?Gl(e,t):t instanceof Yt?Kl(e,t):t instanceof xo?Sr(e,t):t instanceof gn?yu(t,e):!1}function Vl(e,t,o){let n=e,s=o.p1,a=o.p2,r=t,l=a.sub(s),c=r.cross(l);if(Math.abs(c)<Number.EPSILON)return null;let d=s.sub(n),i=d.cross(l)/c;if(i<=0||i>=1)return null;let h=d.cross(r)/c;if(h<=0||h>=1)return null;let u=l.normal().unit();return t.dot(u)>0&&(u.x*=-1,u.y*=-1),{point:n.add(r.scale(i)),normal:u,fraction:i}}function Mu(e,t,o){let n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,a;if(e.x!=0){let r=(o.pos.x-e.x)/t.x,l=(o.pos.x+o.width-e.x)/t.x;a=$(-Math.sign(t.x),0),n=Math.max(n,Math.min(r,l)),s=Math.min(s,Math.max(r,l))}if(e.y!=0){let r=(o.pos.y-e.y)/t.y,l=(o.pos.y+o.height-e.y)/t.y;Math.min(r,l)>n&&(a=$(0,-Math.sign(t.y))),n=Math.max(n,Math.min(r,l)),s=Math.min(s,Math.max(r,l))}return s>=n&&n>=0&&n<=1?{point:e.add(t.scale(n)),normal:a,fraction:n}:null}function Wl(e,t,o){let n=e,s=o.center,a=t,r=a.dot(a),l=n.sub(s),c=2*a.dot(l),d=l.dot(l)-o.radius*o.radius,i=c*c-4*r*d;if(r<=Number.EPSILON||i<0)return null;if(i==0){let h=-c/(2*r);if(h>=0&&h<=1){let u=n.add(a.scale(h));return{point:u,normal:u.sub(s),fraction:h}}}else{let h=(-c+Math.sqrt(i))/(2*r),u=(-c-Math.sqrt(i))/(2*r),p=null;if(h>=0&&h<=1&&(p=h),u>=0&&u<=1&&(p=Math.min(u,p??u)),p!=null){let g=n.add(a.scale(p));return{point:g,normal:g.sub(s).unit(),fraction:p}}}return null}function Tu(e,t,o){let n=o.pts,s=null,a=n[n.length-1];for(let r=0;r<n.length;r++){let l=n[r],c=Vl(e,t,new Co(a,l));c&&(!s||s.fraction>c.fraction)&&(s=c),a=l}return s}function Du(e,t,o){let n=o.toMat2(),s=n.inverse,a=s.transform(e.sub(o.center)),r=s.transform(t),l=Wl(a,r,new Do($(),1));if(l){let c=Oi.rotation(to(-o.angle)),d=Oi.scale(o.radiusX,o.radiusY).transform(l.point),i=n.transform(l.point).add(o.center),h=i.dist(e)/t.len();return{point:i,normal:c.transform($(o.radiusY**2*d.x,o.radiusX**2*d.y)).unit(),fraction:h}}return l}function Cu(e,t,o,n=64){let s=e,a=t.len(),r=t.scale(1/a),l=0,c=$(Math.floor(e.x),Math.floor(e.y)),d=$(r.x>0?1:-1,r.y>0?1:-1),i=$(Math.abs(1/r.x),Math.abs(1/r.y)),h=$(d.x>0?c.x+1-e.x:e.x-c.x,d.y>0?c.y+1-e.y:e.y-c.y),u=$(i.x<1/0?i.x*h.x:1/0,i.y<1/0?i.y*h.y:1/0),p=-1;for(;l<=n;){let g=o(c);if(g===!0)return{point:s.add(r.scale(l)),normal:$(p===0?-d.x:0,p===1?-d.y:0),fraction:l/a,gridPos:c};if(g)return g;u.x<u.y?(c.x+=d.x,l=u.x,u.x+=i.x,p=0):(c.y+=d.y,l=u.y,u.y+=i.y,p=1)}return null}var Ru=class Xa{pt;constructor(t){this.pt=t.clone()}transform(t){return new Xa(t.multVec2(this.pt))}bbox(){return new Yt(this.pt,0,0)}area(){return 0}clone(){return new Xa(this.pt)}collides(t){return bu(this,t)}contains(t){return this.pt.eq(t)}raycast(t,o){return null}random(){return this.pt.clone()}},Co=class Fa{p1;p2;constructor(t,o){this.p1=t.clone(),this.p2=o.clone()}transform(t){return new Fa(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Yt.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Fa(this.p1,this.p2)}collides(t){return wu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Vl(t,o,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(so(1)))}},Yt=class Ya{pos;width;height;constructor(t,o,n){this.pos=t.clone(),this.width=o,this.height=n}static fromPoints(t,o){return new Ya(t.clone(),o.x-t.x,o.y-t.y)}center(){return new ne(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new xo(this.points().map(o=>t.multVec2(o)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Ya(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let o=this.pos,n=this.pos.add(this.width,this.height),s=Math.max(o.x-t.x,0,t.x-n.x),a=Math.max(o.y-t.y,0,t.y-n.y);return s*s+a*a}collides(t){return Eu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Mu(t,o,this)}random(){return this.pos.add(so(this.width),so(this.height))}},Do=class $l{center;radius;constructor(t,o){this.center=t.clone(),this.radius=o}transform(t){return new gn(this.center,this.radius,this.radius).transform(t)}bbox(){return Yt.fromPoints(this.center.sub($(this.radius)),this.center.add($(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new $l(this.center,this.radius)}collides(t){return vu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Wl(t,o,this)}random(){return this.center.add(ne.fromAngle(so(360)).scale(so(this.radius)))}},gn=class as{center;radiusX;radiusY;angle;constructor(t,o,n,s=0){this.center=t.clone(),this.radiusX=o,this.radiusY=n,this.angle=s}static fromMat2(t){let o=t.inverse,n=o.transpose.mul(o),[s,a]=n.eigenvalues,[r,l]=n.eigenvectors(s,a),[c,d]=[1/Math.sqrt(s),1/Math.sqrt(a)];return c>d?new as($(),c,d,qn(Math.atan2(-r[1],r[0]))):new as($(),d,c,qn(Math.atan2(-l[1],l[0])))}toMat2(){let t=to(this.angle),o=Math.cos(t),n=Math.sin(t);return new Oi(o*this.radiusX,-n*this.radiusY,n*this.radiusX,o*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new as(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let o=this.toMat2(),n=t.getRotation(),s=t.getScale();o=zs.fromMat2(o).scale(s.x,s.y).rotate(n).toMat2();let a=as.fromMat2(o);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return Yt.fromPoints(this.center.sub($(this.radiusX,this.radiusY)),this.center.add($(this.radiusX,this.radiusY)));{let t=to(this.angle),o=Math.cos(t),n=Math.sin(t),s=this.radiusX*o,a=this.radiusX*n,r=this.radiusY*n,l=this.radiusY*o,c=Math.sqrt(s*s+r*r),d=Math.sqrt(a*a+l*l);return Yt.fromPoints(this.center.sub($(c,d)),this.center.add($(c,d)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new as(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return Su(this,t)}contains(t){t=t.sub(this.center);let o=to(this.angle),n=Math.cos(o),s=Math.sin(o),a=t.x*n+t.y*s,r=-t.x*s+t.y*n;return a*a/(this.radiusX*this.radiusX)+r*r/(this.radiusY*this.radiusY)<1}raycast(t,o){return Du(t,o,this)}random(){return this.center}};function Iu(e,t,o,n){let s=t.sub(e),a=n.sub(o),r=s.cross(a);return r<1e-5&&r>-1e-5||(r=o.sub(e).cross(a)/r,r<0||r>1)?null:e.add(s.scale(r))}var xo=class Hs{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new Hs(this.pts.map(o=>t.multVec2(o)))}bbox(){let t=$(Number.MAX_VALUE),o=$(-Number.MAX_VALUE);for(let n of this.pts)t.x=Math.min(t.x,n.x),o.x=Math.max(o.x,n.x),t.y=Math.min(t.y,n.y),o.y=Math.max(o.y,n.y);return Yt.fromPoints(t,o)}area(){let t=0,o=this.pts.length;for(let n=0;n<o;n++){let s=this.pts[n],a=this.pts[(n+1)%o];t+=s.x*a.y*.5,t-=a.x*s.y*.5}return Math.abs(t)}clone(){return new Hs(this.pts.map(t=>t.clone()))}collides(t){return Au(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Tu(t,o,this)}random(){return $()}cut(t,o){new Co(t,o);let n=[],s=[],a=o.sub(t),r=this.pts[this.pts.length-1],l=r.sub(t),c=a.cross(l)>0;return this.pts.forEach(d=>{l=d.sub(t);let i=a.cross(l)>0;if(c!=i){let h=Iu(r,d,t,o);n.push(h),s.push(h),c=i}(i?n:s).push(d),r=d}),[n.length?new Hs(n):null,s.length?new Hs(s):null]}};function Pu(e,t,o,n){let s=n*n,a=1-n,r=a*a;return e.scale(r).add(t.scale(2*a*n)).add(o.scale(s))}function Bu(e,t,o,n){let s=1-n;return t.sub(e).scale(2*s).add(o.sub(t).scale(2*n))}function Lu(e,t,o,n){return o.sub(t.scale(2)).add(e).scale(2)}function Mr(e,t,o,n,s){let a=s*s,r=a*s,l=1-s,c=l*l,d=c*l;return e.scale(d).add(t.scale(3*c*s)).add(o.scale(3*l*a)).add(n.scale(r))}function zu(e,t,o,n,s){let a=s*s,r=1-s,l=r*r;return t.sub(e).scale(3*l).add(o.sub(t).scale(6*r*s)).add(n.sub(o).scale(3*a))}function Ou(e,t,o,n,s){let a=1-s;return o.sub(t.scale(2)).add(e).scale(6*a).add(n.sub(o.scale(2)).add(t).scale(6*s))}function Hu(e,t,o,n,s){let a=.5*(((-s+2)*s-1)*s),r=.5*((3*s-5)*s*s+2),l=.5*(((-3*s+4)*s+1)*s),c=.5*((s-1)*s*s);return e.scale(a).add(t.scale(r)).add(o.scale(l)).add(n.scale(c))}function Uu(e,t,o,n,s){let a=.5*((-3*s+4)*s-1),r=.5*((9*s-10)*s),l=.5*((-9*s+8)*s+1),c=.5*((3*s-2)*s);return e.scale(a).add(t.scale(r)).add(o.scale(l)).add(n.scale(c))}function Nu(e){let t=Jl(e),o=t(1);return n=>{let s=n*o,a=t(s,!0);return e(a)}}function Jl(e,t=10,o=10){let n=[0],s=[0],a=1/(t-1)/o,r=0,l=e(0),c=0;for(let d=1;d<t;d++){for(let i=0;i<o;i++){c+=a;let h=e(c),u=h.dist(l);r+=u,l=h}n[d]=r,s[d]=c}return s[t-1]=1,(d,i=!1)=>{if(i){let h=d;if(h<=0)return 0;if(h>=r)return 1;let u=0;for(;n[u+1]<h;)u++;let p=s[u],g=s[u+1],M=n[u],m=n[u+1],T=(h-M)/(m-M);return p+(g-p)*T}else{if(d<=0)return 0;if(d>=1)return n[t-1];let h=0;for(;s[h+1]<d;)h++;let u=s[h],p=s[h+1],g=n[h],M=n[h+1],m=(d-u)/(p-u);return g+(M-g)*m}}}function ai(e,t,o,n){let s=2*e+t-2*n+o,a=-3*e+3*n-2*t-o,r=t,l=e;return c=>{let d=c*c,i=d*c;return s*i+a*d+r*c+l}}function jl(e,t,o,n,s,a=ai){let r=a(t.x,(1-s)*(o.x-e.x),(1-s)*(n.x-t.x),o.x),l=a(t.y,(1-s)*(o.y-e.y),(1-s)*(n.y-t.y),o.y);return c=>new ne(r(c),l(c))}function Ui(e,t,o,n,s=ai){return jl(e,t,o,n,.5,s)}function _u(e,t,o,n,s=ai){return Ui(n.add(e.sub(t).scale(6)),e,n,e.add(n.sub(o).scale(6)),s)}function Xu(e,t,o,n,s,a,r,l=ai){let c=l(t.x,.5*(1-s)*(1+r)*(1+a)*(t.x-e.x)+.5*(1-s)*(1-r)*(1-a)*(o.x-t.x),.5*(1-s)*(1+r)*(1-a)*(o.x-t.x)+.5*(1-s)*(1-r)*(1+a)*(n.x-o.x),o.x),d=l(t.y,.5*(1-s)*(1+r)*(1+a)*(t.y-e.y)+.5*(1-s)*(1-r)*(1-a)*(o.y-t.y),.5*(1-s)*(1+r)*(1-a)*(o.y-t.y)+.5*(1-s)*(1-r)*(1+a)*(n.y-o.y),o.y);return i=>new ne(c(i),d(i))}function Fu(e,t,o,n){let s=2*e+t-2*n+o,a=-3*e+3*n-2*t+o,r=t;return l=>{let c=l*l;return 3*s*c+2*a*l+r}}function Ds(e){return 0<=e&&e<=1}function xa(e,t){return Math.abs(e-t)<=Number.EPSILON}function Cs(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Yu(e,t,o,n){let s=3*e-6*t+3*o,a=-3*e+3*t,r=e,l=-e+3*t-3*o+n;if(xa(l,0)){if(xa(s,0))return xa(a,0)?[]:[-r/a].filter(Ds);let m=Math.sqrt(a*a-4*s*r),T=2*s;return[(m-a)/T,(-a-m)/T].filter(Ds)}s/=l,a/=l,r/=l;let c=(3*a-s*s)/3,d=c/3,i=(2*s*s*s-9*s*a+27*r)/27,h=i/2,u=h*h+d*d*d;if(u<0){let m=-c/3,T=m*m*m,P=Math.sqrt(T),f=-i/(2*P),N=f<-1?-1:f>1?1:f,O=Math.acos(N),w=2*Cs(P),A=w*Math.cos(O/3)-s/3,S=w*Math.cos((O+2*Math.PI)/3)-s/3,I=w*Math.cos((O+4*Math.PI)/3)-s/3;return[A,S,I].filter(Ds)}if(u===0){let m=h<0?Cs(-h):-Cs(h),T=2*m-s/3,P=-m-s/3;return[T,P].filter(Ds)}let p=Math.sqrt(u),g=Cs(p-h),M=Cs(p+h);return[g-M-s/3].filter(Ds)}function qu(e,t,o,n,s){let a=Yu(e.x-s,t.x-s,o.x-s,n.x-s);return a.length>0?Mr(e,t,o,n,a[0]).y:NaN}function Gu(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return o=>{if(o<=0||e.length==1||o<=e[0].x)return e[0].y;for(let n=0;n<t;n++)if(e[n].x>=o)return en(o,e[n-1].x,e[n].x,e[n-1].y,e[n].y);return e[e.length-1].y}}function Ku(e,t){return o=>qu($(0,0),e,t,$(1,1),o)}function Vu(e,t="jump-end"){let o=1/e,n=t=="jump-start"||t=="jump-both",s=t=="jump-end"||t=="jump-both",a=1/(e+(s?1:0)),r=n?a:0;return l=>{let c=Math.floor(l/o);return r+c*a}}function Wu(e,t){let o=Number.MAX_VALUE,n={normal:$(0),distance:0};for(let s of[e,t])for(let a=0;a<s.pts.length;a++){let r=s.pts[a],l=s.pts[(a+1)%s.pts.length].sub(r).normal().unit(),c=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let p=0;p<e.pts.length;p++){let g=e.pts[p].dot(l);c=Math.min(c,g),d=Math.max(d,g)}let i=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let p=0;p<t.pts.length;p++){let g=t.pts[p].dot(l);i=Math.min(i,g),h=Math.max(h,g)}let u=Math.min(d,h)-Math.max(c,i);if(u<0)return null;if(u<Math.abs(o)){let p=h-c,g=i-d;o=Math.abs(p)<Math.abs(g)?p:g,n.normal=l,n.distance=o}}return n}function Zl(e,t,o){return(t.x-e.x)*(o.y-e.y)-(t.y-e.y)*(o.x-e.x)>=0}function $u(e){let t=0,o=e[e.length-1];for(let n=0;n<e.length;n++)t+=(e[n].x-o.x)*(e[n].y+o.y),o=e[n];return t<0}function ba(e,t,o,n){let s=n.x-o.x,a=n.y-o.y,r=s*(e.y-o.y)-a*(e.x-o.x),l=s*(t.y-o.y)-a*(t.x-o.x);return r*l>=0}function Ju(e,t,o,n){return ba(e,t,o,n)&&ba(e,o,t,n)&&ba(e,n,t,o)}function ju(e,t,o,n){for(let s of e)if(s!==t&&s!==o&&s!==n&&Ju(s,t,o,n))return!0;return!1}function Zu(e,t,o,n){return Zl(e,t,o)&&!ju(n,e,t,o)}function Ql(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],o=[],n=0;for(let h=0;h<e.length;h++){let u=e[n],p=e[h];(p.x<u.x||p.x==u.x&&p.y<u.y)&&(n=n),t[h]=h+1,o[h]=h-1}t[t.length-1]=0,o[0]=o.length-1,$u(e)||([t,o]=[o,t]);let s=[];for(let h=0;h<e.length;++h)Zl(e[o[h]],e[h],e[t[h]])||s.push(e[h]);let a=[],r=e.length,l=1,c=0,d,i;for(;r>3;){d=t[l],i=o[l];let h=e[i],u=e[l],p=e[d];if(Zu(h,u,p,s))a.push([h,u,p]),t[i]=d,o[d]=i,s.splice(s.indexOf(u),1),--r,c=0;else if(++c>r)return[];l=d}return d=t[l],i=o[l],a.push([e[i],e[l],e[d]]),a}function Qu(e){if(e.length<3)return!1;let t=e.length-2,o=e.length-1,n=0,s=e[o].sub(e[t]),a=e[n].sub(e[o]),r=s.cross(a);for(;n+1<e.length;)if(t=o,o=n,n++,s=e[o].sub(e[t]),a=e[n].sub(e[o]),s.cross(a)*r<0)return!1;return!0}var kl=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ia="topleft",ku="monospace",Ni="monospace",qa="linear",Tr=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],e0=Tr.reduce((e,t)=>e+t.size,0),ed=2048,t0=ed*4*e0,o0=ed*6,n0=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,s0=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Ga=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Ka=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,i0=new Set(["id","require"]),a0=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),yc=200,r0=640,c0=65536,td=Symbol.for("kaplay.cancel"),od=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Qn=class nd{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let o=new nd(()=>t.forEach(n=>n.cancel()));return Object.defineProperty(o,"paused",{get:()=>t[0].paused,set:n=>t.forEach(s=>s.paused=n)}),o.paused=!1,o}static replace(t,o){return t.cancel=()=>o.cancel(),o.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>o.paused,set:n=>o.paused=n}),t}},yo=class{cancellers=new WeakMap;handlers=new od;add(e){function t(...s){if(!n.paused)return e(...s)}let o=this.handlers.pushd(t),n=new Qn(o);return this.cancellers.set(t,o),n}addOnce(e){let t=this.add((...o)=>{t.cancel(),e(...o)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let o=t(...e),n;o===td&&(n=this.cancellers.get(t))&&n()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},js=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new yo),this.handlers[e].add(t)}onOnce(e,t){let o=this.on(e,(...n)=>{o.cancel(),t(...n)});return o}next(e){return new Promise(t=>{this.onOnce(e,(...o)=>t(o[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},l0=e=>e[0]instanceof Et,d0=e=>e[0]instanceof ne,h0=e=>typeof e[0]=="number",sd=class{_items;_compareFn;constructor(e=(t,o)=>t<o){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function u0(e){let t=window.atob(e),o=t.length,n=new Uint8Array(o);for(let s=0;s<o;s++)n[s]=t.charCodeAt(s);return n.buffer}function f0(e){return u0(e.split(",")[1])}function Dr(e,t){let o=document.createElement("a");o.href=t,o.download=e,o.click()}function id(e,t){Dr(e,"data:text/plain;charset=utf-8,"+t)}function p0(e,t){id(e,JSON.stringify(t))}function xc(e,t){let o=URL.createObjectURL(t);Dr(e,o),URL.revokeObjectURL(o)}var ad=e=>e.match(/^data:\w+\/\w+;base64,.+/),g0=e=>e.split(".").slice(0,-1).join(".");function Cr(e,t){if(e===t)return!0;let o=typeof e,n=typeof t;if(o!==n)return!1;if(o==="object"&&n==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let s=Object.keys(e),a=Object.keys(t);if(s.length!==a.length)return!1;for(let r of s){let l=e[r],c=t[r];if(!Cr(l,c))return!1}return!0}return!1}var bc=new Set,m0=e=>e instanceof Error?e.message:String(e);function y0(e){bc.has(e)||(bc.add(e),console.warn(e))}function xs(e,t){y0(`${e} is deprecated. Use ${t} instead.`)}function Va(e,t){return Number(e.toFixed(t))}function Kt(e,t){return(...o)=>{let n=o.length;if(n===e.length)return e(...o);if(n===t.length)return t(...o)}}var x0=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function b0(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],o=0,n=0;for(;o<e.length;){if(n+=w0(o+n,e),D0(e[o+n])&&n++,S0(e[o+n])&&n++,M0(e[o+n])&&n++,C0(e[o+n])){n++;continue}t.push(e.substring(o,o+n)),o+=n,n=0}return t}function w0(e,t){let o=t[e];if(!v0(o)||e===t.length-1)return 1;let n=o+t[e+1],s=t.substring(e+2,e+5);return wc(n)&&wc(s)?4:E0(n)&&T0(s)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:A0(s)?4:2}function v0(e){return e&&kn(e[0].charCodeAt(0),55296,56319)}function wc(e){return kn(Rr(e),127462,127487)}function E0(e){return kn(Rr(e),127988,127988)}function A0(e){return kn(Rr(e),127995,127999)}function S0(e){return typeof e=="string"&&kn(e.charCodeAt(0),65024,65039)}function M0(e){return typeof e=="string"&&kn(e.charCodeAt(0),8400,8447)}function T0(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&kn(t,917504,917631)}function D0(e){return typeof e=="string"&&x0.includes(e.charCodeAt(0))}function C0(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Rr(e){let t=e.charCodeAt(0)-55296,o=e.charCodeAt(1)-56320;return(t<<10)+o+65536}function kn(e,t,o){return e>=t&&e<=o}var Po=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,Jo=(e,t)=>Array.isArray(t)?t.some(o=>e.has(o)):e.has(t),mi=(e,t,o)=>{e.has(t)?e.get(t)?.push(o):e.set(t,[o])},R0=(()=>{let e=0;return()=>e++})(),I0={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function rd(){let e=x.globalOpt.pixelDensity??1,t=x.globalOpt.width,o=x.globalOpt.height,n=x.gfx.ggl.gl.drawingBufferWidth,s=x.gfx.ggl.gl.drawingBufferHeight,a=n/e,r=s/e,l=0,c=0,d=a,i=r;if(x.globalOpt.letterbox){if(!t||!o)throw new Error("Letterboxing requires width and height defined.");let h=a/r,u=t/o;if(h>u){let p=r*u;l=(a-p)/2,d=p}else{let p=a/u;i=p,c=(r-p)/2}}if(x.globalOpt.stretch&&(!x.globalOpt.width||!x.globalOpt.height))throw new Error("Stretching requires width and height defined.");x.gfx.viewport={x:l,y:c,width:d,height:i,scale:(x.gfx.viewport.width+x.gfx.viewport.height)/(x.gfx.width+x.gfx.height)}}function P0(e){return new ne(e.x*x.gfx.viewport.width/x.gfx.width,e.y*x.gfx.viewport.height/x.gfx.height)}function cn(e){return new ne((e.x-x.gfx.viewport.x)*x.gfx.width/x.gfx.viewport.width,(e.y-x.gfx.viewport.y)*x.gfx.height/x.gfx.viewport.height)}var B0=()=>Un.lastInputDevice,L0=()=>{let e=Un.buttons;for(let t in e){let o=e[t].keyboard&&[e[t].keyboard].flat(),n=e[t].keyboardCode&&[e[t].keyboardCode].flat(),s=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();o&&o.forEach(r=>{mi(Un.buttonsByKey,r,t)}),n&&n.forEach(r=>{mi(Un.buttonsByKeyCode,r,t)}),s&&s.forEach(r=>{mi(Un.buttonsByGamepad,r,t)}),a&&a.forEach(r=>{mi(Un.buttonsByMouse,r,t)})}},Gs=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},z0=class{buttonState=new Gs;stickState=new Map},O0=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,o)=>t+o)/this.dts.length)),this.dts=[])}},Un,vc=I0,H0=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new O0,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new ne(0),mouseDeltaPos:new ne(0),keyState:new Gs,mouseState:new Gs,mergedGamepadState:new z0,gamepadStates:new Map,lastInputDevice:null,buttonState:new Gs,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new js}},U0=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=H0(e);Un=t,L0();function o(){return t.dt*t.timeScale}function n(){return t.fixedDt*t.timeScale}function s(){return t.restDt*t.timeScale}function a(){return t.isHidden}function r(){return t.time}function l(){return t.fpsCounter.fps}function c(){return t.numFrames}function d(){return t.canvas.toDataURL()}function i(B){t.canvas.style.cursor=B}function h(){return t.canvas.style.cursor}function u(B){if(B)try{let K=t.canvas.requestPointerLock();K?.catch&&K.catch(te=>console.error(te))}catch(K){console.error(K)}else document.exitPointerLock()}function p(){return!!document.pointerLockElement}function g(B){B.requestFullscreen?B.requestFullscreen():B.webkitRequestFullscreen&&B.webkitRequestFullscreen()}function M(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function m(B=!0){B?g(t.canvas):M()}function T(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function P(){t.stopped=!0;let B=Object.entries(Ye),K=Object.entries(Ct),te=Object.entries(me);for(let[he,tt]of B)t.canvas.removeEventListener(he,tt);for(let[he,tt]of K)document.removeEventListener(he,tt);for(let[he,tt]of te)window.removeEventListener(he,tt);et.disconnect()}function f(B,K){t.loopID!==null&&cancelAnimationFrame(t.loopID);let te=0,he=0,tt=ot=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(tt);return}let Lt=ot/1e3,at=Math.min(Lt-t.realTime,.25),vt=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Lt,he+=at,he>vt){if(!t.skipTime){for(te+=he,t.dt=t.fixedDt,t.restDt=0;te>t.fixedDt;)te-=t.fixedDt,te<t.fixedDt&&(t.restDt=te),B();t.restDt=te,t.dt=he,t.time+=o(),t.fpsCounter.tick(t.dt)}he=0,t.skipTime=!1,t.numFrames++,K(ct,Bt)}t.loopID=requestAnimationFrame(tt)};tt(0)}function N(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function O(){return t.mousePos.clone()}function w(){return t.mouseDeltaPos.clone()}function A(B="left"){return t.mouseState.pressed.has(B)}function S(B="left"){return t.mouseState.down.has(B)}function I(B="left"){return t.mouseState.released.has(B)}function E(){return t.isMouseMoved}function L(B){return B===void 0?t.keyState.pressed.size>0:Jo(t.keyState.pressed,B)}function C(B){return B===void 0?t.keyState.pressedRepeat.size>0:Jo(t.keyState.pressedRepeat,B)}function F(B){return B===void 0?t.keyState.down.size>0:Jo(t.keyState.down,B)}function U(B){return B===void 0?t.keyState.released.size>0:Jo(t.keyState.released,B)}function _(B){return B===void 0?t.mergedGamepadState.buttonState.pressed.size>0:Jo(t.mergedGamepadState.buttonState.pressed,B)}function H(B){return B===void 0?t.mergedGamepadState.buttonState.down.size>0:Jo(t.mergedGamepadState.buttonState.down,B)}function R(B){return B===void 0?t.mergedGamepadState.buttonState.released.size>0:Jo(t.mergedGamepadState.buttonState.released,B)}function Y(B){return B===void 0?t.buttonState.pressed.size>0:Jo(t.buttonState.pressed,B)}function V(B){return B===void 0?t.buttonState.down.size>0:Jo(t.buttonState.down,B)}function Q(B){return B===void 0?t.buttonState.released.size>0:Jo(t.buttonState.released,B)}function fe(B){return t.buttons?.[B]}function se(B,K){t.buttons[B]={...t.buttons[B],...K}}function ie(B){t.buttonState.press(B),t.events.trigger("buttonPress",B)}function ae(B){t.buttonState.release(B),t.events.trigger("buttonRelease",B)}function ge(B){return t.events.on("resize",B)}let Se=Kt(B=>t.events.on("keyDown",B),(B,K)=>t.events.on("keyDown",te=>Po(B,te)&&K(te))),Ie=Kt(B=>t.events.on("keyPress",K=>B(K)),(B,K)=>t.events.on("keyPress",te=>Po(B,te)&&K(te))),ve=Kt(B=>t.events.on("keyPressRepeat",B),(B,K)=>t.events.on("keyPressRepeat",te=>Po(B,te)&&K(te))),_e=Kt(B=>t.events.on("keyRelease",B),(B,K)=>t.events.on("keyRelease",te=>Po(B,te)&&K(te))),nt=Kt(B=>t.events.on("mouseDown",K=>B(K)),(B,K)=>t.events.on("mouseDown",te=>Po(B,te)&&K(te))),Me=Kt(B=>t.events.on("mousePress",K=>B(K)),(B,K)=>t.events.on("mousePress",te=>Po(B,te)&&K(te))),Tt=Kt(B=>t.events.on("mouseRelease",K=>B(K)),(B,K)=>t.events.on("mouseRelease",te=>te===B&&K(te)));function ee(B){return t.events.on("mouseMove",()=>B(O(),w()))}function we(B){return t.events.on("charInput",B)}function ye(B){return t.events.on("touchStart",B)}function Pe(B){return t.events.on("touchMove",B)}function qe(B){return t.events.on("touchEnd",B)}function Ce(B){return t.events.on("scroll",B)}function rt(B){return t.events.on("hide",B)}function Je(B){return t.events.on("show",B)}let it=Kt(B=>t.events.on("gamepadButtonPress",(K,te)=>B(K,te)),(B,K)=>t.events.on("gamepadButtonPress",(te,he)=>Po(B,te)&&K(te,he))),gt=Kt(B=>t.events.on("gamepadButtonDown",(K,te)=>B(K,te)),(B,K)=>t.events.on("gamepadButtonDown",(te,he)=>Po(B,te)&&K(te,he))),Te=Kt(B=>t.events.on("gamepadButtonRelease",(K,te)=>B(K,te)),(B,K)=>t.events.on("gamepadButtonRelease",(te,he)=>Po(B,te)&&K(te,he)));function Fe(B,K){return t.events.on("gamepadStick",(te,he,tt)=>te===B&&K(he,tt))}function Be(B){t.events.on("gamepadConnect",B)}function Re(B){t.events.on("gamepadDisconnect",B)}function Ke(B){return t.mergedGamepadState.stickState.get(B)||new ne(0)}function dt(){return[...t.charInputted]}function ft(){return[...t.gamepads]}let ht=Kt(B=>t.events.on("buttonPress",K=>B(K)),(B,K)=>t.events.on("buttonPress",te=>Po(B,te)&&K(te))),ut=Kt(B=>t.events.on("buttonDown",K=>B(K)),(B,K)=>t.events.on("buttonDown",te=>Po(B,te)&&K(te))),At=Kt(B=>t.events.on("buttonRelease",K=>B(K)),(B,K)=>t.events.on("buttonRelease",te=>Po(B,te)&&K(te)));function ct(){t.events.trigger("input"),t.keyState.down.forEach(B=>t.events.trigger("keyDown",B)),t.mouseState.down.forEach(B=>t.events.trigger("mouseDown",B)),t.buttonState.down.forEach(B=>{t.events.trigger("buttonDown",B)}),Rt()}function Bt(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((B,K)=>{t.mergedGamepadState.stickState.set(K,new ne(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new ne(0),t.gamepadStates.forEach(B=>{B.buttonState.update(),B.stickState.forEach((K,te)=>{B.stickState.set(te,new ne(0))})})}function Dt(B){let K={index:B.index,isPressed:te=>t.gamepadStates.get(B.index)?.buttonState.pressed.has(te)||!1,isDown:te=>t.gamepadStates.get(B.index)?.buttonState.down.has(te)||!1,isReleased:te=>t.gamepadStates.get(B.index)?.buttonState.released.has(te)||!1,getStick:te=>t.gamepadStates.get(B.index)?.stickState.get(te)||$()};return t.gamepads.push(K),t.gamepadStates.set(B.index,{buttonState:new Gs,stickState:new Map([["left",new ne(0)],["right",new ne(0)]])}),K}function xt(B){t.gamepads=t.gamepads.filter(K=>K.index!==B.index),t.gamepadStates.delete(B.index)}function Rt(){for(let B of navigator.getGamepads())B&&!t.gamepadStates.has(B.index)&&Dt(B);for(let B of t.gamepads){let K=navigator.getGamepads()[B.index];if(!K)continue;let te=(e.gamepads??{})[K.id]||vc[K.id]||vc.default,he=t.gamepadStates.get(B.index);if(he){for(let tt=0;tt<K.buttons.length;tt++){let ot=te.buttons[tt],Lt=K.buttons[tt],at=t.buttonsByGamepad.has(ot);if(Lt.pressed){if(he.buttonState.down.has(ot)){t.events.trigger("gamepadButtonDown",ot,B);continue}t.lastInputDevice="gamepad",at&&t.buttonsByGamepad.get(ot)?.forEach(vt=>{t.buttonState.press(vt),t.events.trigger("buttonPress",vt)}),t.mergedGamepadState.buttonState.press(ot),he.buttonState.press(ot),t.events.trigger("gamepadButtonPress",ot,B)}else he.buttonState.down.has(ot)&&(at&&t.buttonsByGamepad.get(ot)?.forEach(vt=>{t.buttonState.release(vt),t.events.trigger("buttonRelease",vt)}),t.mergedGamepadState.buttonState.release(ot),he.buttonState.release(ot),t.events.trigger("gamepadButtonRelease",ot,B))}for(let tt in te.sticks){let ot=te.sticks[tt];if(!ot)continue;let Lt=new ne(K.axes[ot.x],K.axes[ot.y]);he.stickState.set(tt,Lt),t.mergedGamepadState.stickState.set(tt,Lt),t.events.trigger("gamepadStick",tt,Lt,B)}}}}let Ye={},Ct={},me={},st=e.pixelDensity||1;Ye.mousemove=B=>{let K=cn(new ne(B.offsetX,B.offsetY)),te=new ne(B.movementX,B.movementY);if(T()){let he=t.canvas.width/st,tt=t.canvas.height/st,ot=window.innerWidth,Lt=window.innerHeight,at=ot/Lt,vt=he/tt;if(at>vt){let xe=Lt/tt,be=(ot-he*xe)/2;K.x=en(B.offsetX-be,0,he*xe,0,he),K.y=en(B.offsetY,0,tt*xe,0,tt)}else{let xe=ot/he,be=(Lt-tt*xe)/2;K.x=en(B.offsetX,0,he*xe,0,he),K.y=en(B.offsetY-be,0,tt*xe,0,tt)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=K,t.mouseDeltaPos=te,t.events.trigger("mouseMove")})};let re=["left","middle","right","back","forward"];Ye.mousedown=B=>{t.events.onOnce("input",()=>{let K=re[B.button];K&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(K)&&t.buttonsByMouse.get(K)?.forEach(te=>{t.buttonState.press(te),t.events.trigger("buttonPress",te)}),t.mouseState.press(K),t.events.trigger("mousePress",K))})},Ye.mouseup=B=>{t.events.onOnce("input",()=>{let K=re[B.button];K&&(t.buttonsByMouse.has(K)&&t.buttonsByMouse.get(K)?.forEach(te=>{t.buttonState.release(te),t.events.trigger("buttonRelease",te)}),t.mouseState.release(K),t.events.trigger("mouseRelease",K))})};let Le=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),Qe={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};Ye.keydown=B=>{Le.has(B.key)&&B.preventDefault(),t.events.onOnce("input",()=>{let K=Qe[B.key]||B.key.toLowerCase(),te=B.code;if(K===void 0)throw new Error(`Unknown key: ${B.key}`);K.length===1?(t.events.trigger("charInput",K),t.charInputted.push(K)):K==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),B.repeat?(t.keyState.pressRepeat(K),t.events.trigger("keyPressRepeat",K)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(K)&&t.buttonsByKey.get(K)?.forEach(he=>{t.buttonState.press(he),t.events.trigger("buttonPress",he)}),t.buttonsByKeyCode.has(te)&&t.buttonsByKeyCode.get(te)?.forEach(he=>{t.buttonState.press(he),t.events.trigger("buttonPress",he)}),t.keyState.press(K),t.events.trigger("keyPressRepeat",K),t.events.trigger("keyPress",K))})},Ye.keyup=B=>{t.events.onOnce("input",()=>{let K=Qe[B.key]||B.key.toLowerCase(),te=B.code;t.buttonsByKey.has(K)&&t.buttonsByKey.get(K)?.forEach(he=>{t.buttonState.release(he),t.events.trigger("buttonRelease",he)}),t.buttonsByKeyCode.has(te)&&t.buttonsByKeyCode.get(te)?.forEach(he=>{t.buttonState.release(he),t.events.trigger("buttonRelease",he)}),t.keyState.release(K),t.events.trigger("keyRelease",K)})},Ye.touchstart=B=>{B.preventDefault(),t.events.onOnce("input",()=>{let K=[...B.changedTouches],te=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=cn(new ne(K[0].clientX-te.x,K[0].clientY-te.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(he=>{t.buttonState.press(he),t.events.trigger("buttonPress",he)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),K.forEach(he=>{t.events.trigger("touchStart",cn(new ne(he.clientX-te.x,he.clientY-te.y)),he)})})},Ye.touchmove=B=>{B.preventDefault(),t.events.onOnce("input",()=>{let K=[...B.changedTouches],te=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let he=t.mousePos;t.mousePos=cn(new ne(K[0].clientX-te.x,K[0].clientY-te.y)),t.mouseDeltaPos=t.mousePos.sub(he),t.events.trigger("mouseMove")}K.forEach(he=>{t.events.trigger("touchMove",cn(new ne(he.clientX-te.x,he.clientY-te.y)),he)})})},Ye.touchend=B=>{t.events.onOnce("input",()=>{let K=[...B.changedTouches],te=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=cn(new ne(K[0].clientX-te.x,K[0].clientY-te.y)),t.mouseDeltaPos=new ne(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(he=>{t.buttonState.release(he),t.events.trigger("buttonRelease",he)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),K.forEach(he=>{t.events.trigger("touchEnd",cn(new ne(he.clientX-te.x,he.clientY-te.y)),he)})})},Ye.touchcancel=B=>{t.events.onOnce("input",()=>{let K=[...B.changedTouches],te=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=cn(new ne(K[0].clientX-te.x,K[0].clientY-te.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),K.forEach(he=>{t.events.trigger("touchEnd",cn(new ne(he.clientX-te.x,he.clientY-te.y)),he)})})},Ye.wheel=B=>{B.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new ne(B.deltaX,B.deltaY))})},Ye.contextmenu=B=>B.preventDefault(),Ct.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},me.gamepadconnected=B=>{let K=Dt(B.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",K)})},me.gamepaddisconnected=B=>{let K=ft().filter(te=>te.index===B.gamepad.index)[0];xt(B.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",K)})};for(let[B,K]of Object.entries(Ye))t.canvas.addEventListener(B,K);for(let[B,K]of Object.entries(Ct))document.addEventListener(B,K);for(let[B,K]of Object.entries(me))window.addEventListener(B,K);let et=new ResizeObserver(B=>{for(let K of B)if(K.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return et.observe(t.canvas),{state:t,dt:o,fixedDt:n,restDt:s,time:r,run:f,canvas:t.canvas,fps:l,numFrames:c,quit:P,isHidden:a,setFullscreen:m,isFullscreen:T,setCursor:i,screenshot:d,getGamepads:ft,getCursor:h,setCursorLocked:u,isCursorLocked:p,isTouchscreen:N,mousePos:O,mouseDeltaPos:w,isKeyDown:F,isKeyPressed:L,isKeyPressedRepeat:C,isKeyReleased:U,isMouseDown:S,isMousePressed:A,isMouseReleased:I,isMouseMoved:E,isGamepadButtonPressed:_,isGamepadButtonDown:H,isGamepadButtonReleased:R,getGamepadStick:Ke,isButtonPressed:Y,isButtonDown:V,isButtonReleased:Q,setButton:se,getButton:fe,pressButton:ie,releaseButton:ae,charInputted:dt,onResize:ge,onKeyDown:Se,onKeyPress:Ie,onKeyPressRepeat:ve,onKeyRelease:_e,onMouseDown:nt,onMousePress:Me,onMouseRelease:Tt,onMouseMove:ee,onCharInput:we,onTouchStart:ye,onTouchMove:Pe,onTouchEnd:qe,onScroll:Ce,onHide:rt,onShow:Je,onGamepadButtonDown:gt,onGamepadButtonPress:it,onGamepadButtonRelease:Te,onGamepadStick:Fe,onGamepadConnect:Be,onGamepadDisconnect:Re,onButtonPress:ht,onButtonDown:ut,onButtonRelease:At,getLastInputDeviceType:B0,events:t.events}};function io(){return x.app.dt()}function Wa(){return x.app.fixedDt()}function $a(){return x.app.restDt()}var N0=new ne(-1,-1),_0=new ne(0,-1),X0=new ne(1,-1),F0=new ne(-1,0),Y0=new ne(0,0),q0=new ne(1,0),G0=new ne(-1,1),K0=new ne(0,1),V0=new ne(1,1);function bs(e){switch(e){case"topleft":return N0;case"top":return _0;case"topright":return X0;case"left":return F0;case"center":return Y0;case"right":return q0;case"botleft":return G0;case"bot":return K0;case"botright":return V0;default:return e}}function W0(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function $0(e){return e.createBuffer(1,1,44100)}var yi=2.5949095,Ec=1.70158+1,Ac=2*Math.PI/3,Sc=2*Math.PI/4.5,Ci={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>Ec*e*e*e-1.70158*e*e,easeOutBack:e=>1+Ec*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((yi+1)*2*e-yi)/2:(Math.pow(2*e-2,2)*((yi+1)*(e*2-2)+yi)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*Ac),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*Ac)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Sc))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Sc)/2+1,easeInBounce:e=>1-Ci.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Ci.easeOutBounce(1-2*e))/2:(1+Ci.easeOutBounce(2*e-1))/2},Zs=Ci;function J0(e,t,o){let n=[],s=t;for(n.push(s);s!==e;){if(s=o.get(s),s==null)return null;n.push(s)}return n.reverse()}function j0(e,t,o){let n=new sd((r,l)=>r.cost<l.cost);n.insert({cost:0,node:t});let s=new Map;s.set(t,t);let a=new Map;for(a.set(t,0);n.length!==0;){let r=n.remove()?.node;if(r===o)break;let l=e.getNeighbours(r);for(let c of l){let d=(a.get(r)||0)+e.getCost(r,c)+e.getHeuristic(c,o);(!a.has(c)||d<a.get(c))&&(a.set(c,d),n.insert({cost:d,node:c}),s.set(c,r))}}return J0(t,o,s)}var Z0=class{a;b;polygon;constructor(e,t,o){this.a=e,this.b=t,this.polygon=new WeakRef(o)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},Q0=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,o=0,n=0;for(let s of this._edges){s.polygon=new WeakRef(this);let a=s.a.x*s.b.y-s.a.y*s.b.x;t+=(s.a.x+s.b.x)*a,o+=(s.a.y+s.b.y)*a,n+=a}n/=2,this._centroid=$(t/(6*n),o/(6*n))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let o of this.edges)o.b.y>e.y!=o.a.y>e.y&&e.x<(o.a.x-o.b.x)*(e.y-o.b.y)/(o.a.y-o.b.y)+o.b.x&&(t=!t);return t}},k0=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let o=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[o]}_findCommonEdge(e,t){for(let o of e.edges){let n=this._findEdge(o.b,o.a);if(n&&n.polygon.deref().id===t.id)return n}return null}addPolygon(e){let t=new Q0(this._polygons.length),o=e.map((n,s)=>new Z0(n,e[(s+1)%e.length],t));t.edges=o,this._polygons.push(t);for(let n of t.edges)this._addEdge(n);return t}addRect(e,t){let o=this._addPoint(e),n=this._addPoint(e.add(t.x,0)),s=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([o,n,s,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let o of this._polygons[e].edges){let n=this._findEdge(o.b,o.a);if(n){let s=n.polygon.deref();s&&t.push(s.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let o=this._polygons[e],n=this._polygons[t],s=o.centroid.x-n.centroid.x,a=o.centroid.y-n.centroid.y;return Math.sqrt(s*s+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:j0(this,e,t)}getWaypointPath(e,t,o){let n=o?.type||"centroids",s=this._getLocation(e),a=this._getLocation(t);if(s===void 0||a===void 0)return[];let r=this.getPath(s.id,a.id);if(!r)return[];if(n==="edges"){let l=[];for(let c=1;c<r.length;c++){let d=this._polygons[r[c-1]],i=this._polygons[r[c]],h=this._findCommonEdge(d,i);l.push(h.middle.add(i.centroid.sub(h.middle).unit().scale(4)))}return[e,...l,t]}else return[e,...r.slice(1,-1).map(l=>this._polygons[l].centroid),t]}};function Ks(e){let t=new sn;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function ef(e){return new ne(e.x/co()*2-1,-e.y/uo()*2+1)}function Us(e,t,o,n,s,a=1){n=to(n%360),s=to(s%360),s<=n&&(s+=Math.PI*2);let r=[],l=Math.ceil((s-n)/to(8)*a),c=(s-n)/l,d=$(Math.cos(n),Math.sin(n)),i=$(Math.cos(c),Math.sin(c));for(let h=0;h<=l;h++)r.push(e.add(t*d.x,o*d.y)),d=$(d.x*i.x-d.y*i.y,d.x*i.y+d.y*i.x);return r}function tf(...e){let t=Ht(...e),o=e[3]??1;x.gfx.bgColor=t,x.gfx.bgAlpha=o,x.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,o)}function of(){return x.gfx.bgColor?.clone?.()??null}function jt(...e){if(e[0]===void 0)return;let t=$(...e);t.x===0&&t.y===0||x.gfx.transform.translate(t)}function Bo(){x.gfx.transformStack.push(x.gfx.transform.clone())}function nf(e){x.gfx.transform=e.clone()}function Qs(...e){if(e[0]===void 0)return;let t=$(...e);t.x===1&&t.y===1||x.gfx.transform.scale(t)}function hs(e){e&&x.gfx.transform.rotate(e)}function Eo(){x.gfx.transformStack.length>0&&(x.gfx.transform=x.gfx.transformStack.pop())}function Lo(){x.gfx.renderer.flush()}function co(){return x.gfx.width}function uo(){return x.gfx.height}function cd(){return(x.gfx.viewport.width+x.gfx.viewport.height)/(x.gfx.width+x.gfx.height)}function _i(){return $(co()/2,uo()/2)}var sf=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,o,n){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.textures=[Cn.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=n;let s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get 2d context");this.c2d=s}addSingle(e){let t=Cn.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new Jt(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,o=e.height+this.padding*2;if(t>this.canvas.width||o>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+o>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(Cn.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let n=this.textures[this.textures.length-1],s=new ne(this.x+this.padding,this.y+this.padding);return this.x+=t,o>this.curHeight&&(this.curHeight=o),e instanceof ImageData?this.c2d.putImageData(e,s.x,s.y):this.c2d.drawImage(e,s.x,s.y),n.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:s,size:new ne(e.width,e.height),texture:n}),this.lastTextureId++,[n,new Jt(s.x/this.canvas.width,s.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Ho(e){return typeof e!="string"||ad(e)?e:x.assets.urlPrefix+e}var Uo=class ld{loaded=!1;data=null;error=null;onLoadEvents=new yo;onErrorEvents=new yo;onFinishEvents=new yo;constructor(t){t.then(o=>{this.loaded=!0,this.data=o,this.onLoadEvents.trigger(o)}).catch(o=>{if(this.error=o,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(o);else throw o}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let o=new ld(Promise.resolve(t));return o.data=t,o.loaded=!0,o}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},ts=class{assets=new Map;lastUID=0;add(e,t){let o=e??this.lastUID+++"",n=new Uo(t);return this.assets.set(o,n),n}addLoaded(e,t){let o=e??this.lastUID+++"",n=Uo.loaded(t);return this.assets.set(o,n),n}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function Ir(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function aa(e){return Ir(e).then(t=>t.json())}function af(e){return Ir(e).then(t=>t.text())}function rf(e){return Ir(e).then(t=>t.arrayBuffer())}function cf(e){return e!==void 0&&(x.assets.urlPrefix=e),x.assets.urlPrefix}function lf(e,t){return x.assets.custom.add(e,aa(Ho(t)))}function ra(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((o,n)=>{t.onload=()=>o(t),t.onerror=()=>n(new Error(`Failed to load image from "${e}"`))})}function Gn(){let e=[x.assets.sprites,x.assets.sounds,x.assets.shaders,x.assets.fonts,x.assets.bitmapFonts,x.assets.custom];return e.reduce((t,o)=>t+o.progress(),0)/e.length}function dd(){return[x.assets.sprites,x.assets.sounds,x.assets.shaders,x.assets.fonts,x.assets.bitmapFonts,x.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function df(e){return x.assets.custom.get(e)??null}function Ja(e){return x.assets.custom.add(null,e)}var hf=(e,t)=>({urlPrefix:"",sprites:new ts,fonts:new ts,bitmapFonts:new ts,sounds:new ts,shaders:new ts,custom:new ts,music:{},packer:new sf(e,2048,2048,t),loaded:!1}),uf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Pn=class Ns{tex;frames=[new Jt(0,0,1,1)];anims={};slice9=null;constructor(t,o,n={},s=null){this.tex=t,o&&(this.frames=o),this.anims=n,this.slice9=s}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,o={}){return typeof t=="string"?Ns.fromURL(t,o):Promise.resolve(Ns.fromImage(t,o))}static fromImage(t,o={}){let[n,s]=o.singular?x.assets.packer.addSingle(t):x.assets.packer.add(t),a=o.frames?o.frames.map(r=>new Jt(s.x+r.x*s.w,s.y+r.y*s.h,r.w*s.w,r.h*s.h)):ud(o.sliceX||1,o.sliceY||1,s.x,s.y,s.w,s.h);return new Ns(n,a,o.anims,o.slice9)}static fromURL(t,o={}){return ra(t).then(n=>Ns.fromImage(n,o))}};function Ri(e){if(typeof e=="string"){let t=hd(e);if(t)return t;if(Gn()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Pn)return Uo.loaded(e);if(e instanceof Uo)return e;throw new Error(`Invalid sprite: ${e}`)}}function hd(e){return x.assets.sprites.get(e)??null}function Vs(e,t,o={sliceX:1,sliceY:1,anims:{}}){return t=Ho(t),Array.isArray(t)?t.some(n=>typeof n=="string")?x.assets.sprites.add(e,Promise.all(t.map(n=>typeof n=="string"?ra(n):Promise.resolve(n))).then(n=>Mc(n,o))):x.assets.sprites.addLoaded(e,Mc(t,o)):typeof t=="string"?x.assets.sprites.add(e,Pn.from(t,o)):x.assets.sprites.addLoaded(e,Pn.fromImage(t,o))}function ud(e=1,t=1,o=0,n=0,s=1,a=1){let r=[],l=s/e,c=a/t;for(let d=0;d<t;d++)for(let i=0;i<e;i++)r.push(new Jt(o+i*l,n+d*c,l,c));return r}function Mc(e,t={}){let o=document.createElement("canvas"),n=e[0].width,s=e[0].height;o.width=n*e.length,o.height=s;let a=o.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((l,c)=>{l instanceof ImageData?a.putImageData(l,c*n,0):a.drawImage(l,c*n,0)});let r=a.getImageData(0,0,e.length*n,s);return Pn.fromImage(r,{...t,sliceX:e.length,sliceY:1})}function ff(e="bean"){return Vs(e,uf)}function pf(e,t,o){t=Ho(t),o=Ho(o),typeof t=="string"&&!o&&(o=g0(t)+".json");let n=typeof o=="string"?aa(o):Promise.resolve(o);return x.assets.sprites.add(e,n.then(s=>{let a=s.meta.size,r=s.frames.map(c=>new Jt(c.frame.x/a.w,c.frame.y/a.h,c.frame.w/a.w,c.frame.h/a.h)),l={};for(let c of s.meta.frameTags)c.from===c.to?l[c.name]=c.from:l[c.name]={from:c.from,to:c.to,speed:10,loop:!0,pingpong:c.direction==="pingpong"};return Pn.from(t,{frames:r,anims:l})}))}var Ii=class{fontface;filter=qa;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??qa,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Ht(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function fd(e){if(!e)return fd(x.globalOpt.font??ku);if(typeof e=="string"){let t=gd(e),o=pd(e);if(t)return t.data??t;if(o)return o.data??o;if(document.fonts.check(`64px ${e}`))return e;if(Gn()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof Uo)return e.data?e.data:e;return e}function pd(e){return x.assets.fonts.get(e)??null}function gf(e,t,o={}){let n=Ho(t),s=new FontFace(e,typeof t=="string"?`url(${n})`:n);return document.fonts.add(s),x.assets.fonts.add(e,s.load().catch(a=>{throw new Error(`Failed to load font from "${n}": ${a}`)}).then(a=>new Ii(a,o)))}function mf(e,t,o,n){let s=e.width/t,a={},r=n.split("").entries();for(let[l,c]of r)a[c]=new Jt(l%s*t,Math.floor(l/s)*o,t,o);return{tex:e,map:a,size:o}}function gd(e){return x.assets.bitmapFonts.get(e)??null}function yf(e,t,o,n,s={}){let a=Ho(t);return x.assets.bitmapFonts.add(e,ra(a).then(r=>mf(Cn.fromImage(x.gfx.ggl,r,s),o,n,s.chars??kl)))}function xf(e,t){return t=Ho(t),x.assets.sprites.add(e,new Promise(async o=>{let n=typeof t=="string"?await aa(t):t,s=await Promise.all(n.frames.map(ra)),a=document.createElement("canvas");a.width=n.width,a.height=n.height*n.frames.length;let r=a.getContext("2d");if(!r)throw new Error("Failed to create canvas context");s.forEach((c,d)=>{r.drawImage(c,0,d*n.height)});let l=await Vs(null,a,{sliceY:n.frames.length,anims:n.anims});o(l)}))}var bf=class{ctx;glProgram;constructor(e,t,o,n){this.ctx=e,e.onDestroy(()=>this.free());let s=e.gl,a=s.createShader(s.VERTEX_SHADER),r=s.createShader(s.FRAGMENT_SHADER);if(!a||!r)throw new Error("Failed to create shader");s.shaderSource(a,t),s.shaderSource(r,o),s.compileShader(a),s.compileShader(r);let l=s.createProgram();if(this.glProgram=l,s.attachShader(l,a),s.attachShader(l,r),n.forEach((c,d)=>s.bindAttribLocation(l,d,c)),s.linkProgram(l),!s.getProgramParameter(l,s.LINK_STATUS)){let c=s.getShaderInfoLog(a);if(c)throw new Error("VERTEX SHADER "+c);let d=s.getShaderInfoLog(r);if(d)throw new Error("FRAGMENT SHADER "+d)}s.deleteShader(a),s.deleteShader(r)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let o in e){let n=e[o],s=t.getUniformLocation(this.glProgram,o);if(typeof n=="number")t.uniform1f(s,n);else if(n instanceof sn)t.uniformMatrix4fv(s,!1,new Float32Array(n.m));else if(n instanceof Et)t.uniform3f(s,n.r,n.g,n.b);else if(n instanceof ne)t.uniform2f(s,n.x,n.y);else if(Array.isArray(n))n[0],h0(n)?t.uniform1fv(s,n):d0(n)?t.uniform2fv(s,n.map(a=>[a.x,a.y]).flat()):l0(n)&&t.uniform3fv(s,n.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function Pr(e,t=Ga,o=Ka){let n=n0.replace("{{user}}",t??Ga),s=s0.replace("{{user}}",o??Ka);try{return new bf(e,n,s,Tr.map(a=>a.name))}catch(a){let r=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,l=m0(a).match(r);if(!l?.groups)throw a;let c=Number(l.groups.line)-14,d=l.groups.msg.trim(),i=l.groups.type.toLowerCase();throw new Error(`${i} shader line ${c}: ${d}`)}}function wf(e){if(!e)return x.gfx.defShader;if(typeof e=="string"){let t=md(e);if(t)return t.data??t;if(Gn()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof Uo)return e.data?e.data:e;return e}function md(e){return x.assets.shaders.get(e)??null}function vf(e,t,o){return x.assets.shaders.addLoaded(e,Pr(x.gfx.ggl,t,o))}function Ef(e,t,o){t=Ho(t),o=Ho(o);let n=a=>a?af(a):Promise.resolve(null),s=Promise.all([n(t),n(o)]).then(([a,r])=>Pr(x.gfx.ggl,a,r));return x.assets.shaders.add(e,s)}var ks=class Pi{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((o,n)=>x.audio.ctx.decodeAudioData(t,o,n)).then(o=>new Pi(o))}static fromURL(t){return ad(t)?Pi.fromArrayBuffer(f0(t)):rf(t).then(o=>Pi.fromArrayBuffer(o))}};function Af(e){if(typeof e=="string"){let t=yd(e);if(t)return t;if(Gn()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof ks)return Uo.loaded(e);if(e instanceof Uo)return e;throw new Error(`Invalid sound: ${e}`)}}function yd(e){return x.assets.sounds.get(e)??null}function Sf(e,t){return t=Ho(t),x.assets.sounds.add(e,typeof t=="string"?ks.fromURL(t):ks.fromArrayBuffer(t))}function Mf(e,t){let o=Ho(t),n=new Audio(o);return n.preload="auto",x.assets.music[e]=o}function xd(e,t){return e=Ho(e),Ja(typeof t=="string"?new Promise((o,n)=>{aa(t).then(s=>{xd(e,s).then(o).catch(n)})}):Pn.from(e).then(o=>{let n={};for(let s in t){let a=t[s],r=o.frames[0],l=2048*r.w,c=2048*r.h,d=a.frames?a.frames.map(h=>new Jt(r.x+(a.x+h.x)/l*r.w,r.y+(a.y+h.y)/c*r.h,h.w/l*r.w,h.h/c*r.h)):ud(a.sliceX||1,a.sliceY||1,r.x+a.x/l*r.w,r.y+a.y/c*r.h,a.width/l*r.w,a.height/c*r.h),i=new Pn(o.tex,d,a.anims);x.assets.sprites.addLoaded(s,i),n[s]=i}return n}))}function Ln(e,t,o=!1,n,s,a={}){let r=n??x.gfx.defTex,l=s??x.gfx.defShader,c=wf(l);if(!c||c instanceof Uo)return;let d=x.gfx.fixed||o?x.gfx.transform:x.game.cam.transform.mult(x.gfx.transform),i=[];for(let h of e){let u=ef(d.multVec2(h.pos));i.push(u.x,u.y,h.uv.x,h.uv.y,h.color.r/255,h.color.g/255,h.color.b/255,h.opacity)}x.gfx.renderer.push(x.gfx.ggl.gl.TRIANGLES,i,t,c,r,a)}function Dn(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Bo(),jt(e.pos),Qs(e.scale),hs(e.angle),jt(e.offset),e.fill!==!1){let o=e.color??Et.WHITE,n=e.pts.map((a,r)=>({pos:new ne(a.x,a.y),uv:e.uv?e.uv[r]:new ne(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(o):o,opacity:e.opacity??1})),s;e.triangulate?s=Ql(e.pts).map(a=>a.map(r=>e.pts.indexOf(r))).flat():s=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),Ln(n,e.indices??s,e.fixed,e.uv?e.tex:x.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&Br({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),Eo()}}function bd(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,o=e.end??360,n=bs(e.anchor??"center").scale(new ne(-e.radiusX,-e.radiusY)),s=Us(n,e.radiusX,e.radiusY,t,o,e.resolution);s.unshift(n);let a=Object.assign({},e,{pts:s,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(s.length-1).fill(e.gradient[1])]}:{}});if(o-t>=360&&e.outline){e.fill!==!1&&Dn(Object.assign({},a,{outline:null})),Dn(Object.assign({},a,{pts:s.slice(1),fill:!1}));return}Dn(a)}function ws(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&bd(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function _s(e){let{p1:t,p2:o}=e;if(!t||!o)throw new Error('drawLine() requires properties "p1" and "p2".');let n=e.width||1,s=o.sub(t).unit().normal().scale(n*.5),a=[t.sub(s),t.add(s),o.add(s),o.sub(s)].map(r=>({pos:new ne(r.x,r.y),uv:new ne(0),color:e.color??Et.WHITE,opacity:e.opacity??1}));Ln(a,[0,1,3,1,2,3],e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Tf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||$(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let g=r.scale(-n/l);o.push(i.add(g).add(c)),o.push(i.add(g).sub(c));break}case"round":{let g=Math.max(n,10),M=Math.PI/g,m=c.scale(-1),T=Math.cos(M),P=Math.sin(M);for(let f=0;f<g;f++)o.push(i),o.push(i.sub(m)),m=$(m.x*T-m.y*P,m.x*P+m.y*T)}}for(let g=1;g<t.length;g++){if(i===t[g]||i.eq(t[g]))continue;d=i,i=t[g];let M=i.sub(d),m=M.len(),T=M.normal().scale(-n/m),P=r.cross(M);if(Math.abs(P)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(M)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=M,l=m,c=T;continue}let f=T.sub(c).cross(M)/P,N=c.add(r.scale(f));P>0?(o.push(d.add(N)),o.push(d.sub(c)),o.push(d.add(N)),o.push(d.sub(T))):(o.push(d.add(c)),o.push(d.sub(N)),o.push(d.add(T)),o.push(d.sub(N))),r=M,l=m,c=T}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let g=r.scale(n/l);o.push(i.add(g).add(c)),o.push(i.add(g).sub(c));break}case"round":{let g=Math.max(n,10),M=Math.PI/g,m=c.scale(1),T=Math.cos(M),P=Math.sin(M);for(let f=0;f<g;f++)m=$(m.x*T-m.y*P,m.x*P+m.y*T),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(g=>({pos:a.add(g),uv:$(),color:e.color||Et.WHITE,opacity:e.opacity??1})),u=[],p=0;for(let g=0;g<o.length-2;g+=2)u[p++]=g+1,u[p++]=g,u[p++]=g+2,u[p++]=g+2,u[p++]=g+3,u[p++]=g+1;s&&(u[p++]=o.length-1,u[p++]=o.length-2,u[p++]=0,u[p++]=0,u[p++]=1,u[p++]=o.length-1),Ln(h,u,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Df(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||$(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let g=r.scale(-n/l);o.push(i.add(g).add(c)),o.push(i.add(g).sub(c));break}case"round":{let g=Math.max(n,10),M=Math.PI/g,m=c.scale(-1),T=Math.cos(M),P=Math.sin(M);for(let f=0;f<g;f++)o.push(i),o.push(i.sub(m)),m=$(m.x*T-m.y*P,m.x*P+m.y*T)}}for(let g=1;g<t.length;g++){if(i===t[g]||i.eq(t[g]))continue;d=i,i=t[g];let M=i.sub(d),m=M.len(),T=M.normal().scale(-n/m),P=r.cross(M);if(Math.abs(P)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(M)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=M,l=m,c=T;continue}let f=T.sub(c).cross(M)/P,N=c.add(r.scale(f));if(P>0){let O=d.add(N),w=Math.max(n,10),A=to(c.angleBetween(T)/w),S=c,I=Math.cos(A),E=Math.sin(A);for(let L=0;L<w;L++)o.push(O),o.push(d.sub(S)),S=$(S.x*I-S.y*E,S.x*E+S.y*I)}else{let O=d.sub(N),w=Math.max(n,10),A=to(c.angleBetween(T)/w),S=c,I=Math.cos(A),E=Math.sin(A);for(let L=0;L<w;L++)o.push(d.add(S)),o.push(O),S=$(S.x*I-S.y*E,S.x*E+S.y*I)}r=M,l=m,c=T}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let g=r.scale(n/l);o.push(i.add(g).add(c)),o.push(i.add(g).sub(c));break}case"round":{let g=Math.max(n,10),M=Math.PI/g,m=c.scale(1),T=Math.cos(M),P=Math.sin(M);for(let f=0;f<g;f++)m=$(m.x*T-m.y*P,m.x*P+m.y*T),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(g=>({pos:a.add(g),uv:$(),color:e.color||Et.WHITE,opacity:e.opacity??1})),u=[],p=0;for(let g=0;g<o.length-2;g+=2)u[p++]=g+1,u[p++]=g,u[p++]=g+2,u[p++]=g+2,u[p++]=g+3,u[p++]=g+1;s&&(u[p++]=o.length-1,u[p++]=o.length-2,u[p++]=0,u[p++]=0,u[p++]=1,u[p++]=o.length-1),Ln(h,u,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Cf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||$(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let g=r.scale(-n/l);o.push(i.add(g).add(c)),o.push(i.add(g).sub(c));break}case"round":{let g=Math.max(n,10),M=Math.PI/g,m=c.scale(-1),T=Math.cos(M),P=Math.sin(M);for(let f=0;f<g;f++)o.push(i),o.push(i.sub(m)),m=$(m.x*T-m.y*P,m.x*P+m.y*T)}}for(let g=1;g<t.length;g++){if(i===t[g]||i.eq(t[g]))continue;d=i,i=t[g];let M=i.sub(d),m=M.len(),T=M.normal().scale(-n/m),P=r.cross(M);if(Math.abs(P)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(M)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=M,l=m,c=T;continue}let f=T.sub(c).cross(M)/P,N=c.add(r.scale(f));o.push(d.add(N)),o.push(d.sub(N)),r=M,l=m,c=T}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let g=r.scale(n/l);o.push(i.add(g).add(c)),o.push(i.add(g).sub(c));break}case"round":{let g=Math.max(n,10),M=Math.PI/g,m=c.scale(1),T=Math.cos(M),P=Math.sin(M);for(let f=0;f<g;f++)m=$(m.x*T-m.y*P,m.x*P+m.y*T),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(g=>({pos:a.add(g),uv:$(),color:e.color||Et.WHITE,opacity:e.opacity??1})),u=[],p=0;for(let g=0;g<o.length-2;g+=2)u[p++]=g+1,u[p++]=g,u[p++]=g+2,u[p++]=g+2,u[p++]=g+3,u[p++]=g+1;s&&(u[p++]=o.length-1,u[p++]=o.length-2,u[p++]=0,u[p++]=0,u[p++]=1,u[p++]=o.length-1),Ln(h,u,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Br(e){let t=e.pts,o=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return Tf(e);case"round":return Df(e);case"miter":return Cf(e)}if(e.radius&&t.length>=3){_s(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let s=t[n],a=t[n+1];_s(Object.assign({},e,{p1:s,p2:a}))}_s(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let n=0;n<t.length-1;n++)_s(Object.assign({},e,{p1:t[n],p2:t[n+1]})),e.join!=="none"&&ws(Object.assign({},e,{pos:t[n],radius:o/2}))}}function wd(e,t){let o=t.segments??16,n=[];for(let s=0;s<=o;s++)n.push(e(s/o));Br({pts:n,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Rf(e){wd(t=>Mr(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var Cn=class vd{ctx;src=null;glTex;width;height;constructor(t,o,n,s={}){this.ctx=t;let a=t.gl,r=t.gl.createTexture();if(!r)throw new Error("Failed to create texture");this.glTex=r,t.onDestroy(()=>this.free()),this.width=o,this.height=n;let l={linear:a.LINEAR,nearest:a.NEAREST}[s.filter??t.opts.texFilter??"nearest"],c={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[s.wrap??"clampToEdge"];this.bind(),o&&n&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,o,n,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,c),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,o,n={}){let s=new vd(t,o.width,o.height,n);return s.update(o),s.src=o,s}update(t,o=0,n=0){let s=this.ctx.gl;this.bind(),s.texSubImage2D(s.TEXTURE_2D,0,o,n,s.RGBA,s.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Xi=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,o,n={}){this.ctx=e;let s=e.gl;e.onDestroy(()=>this.free()),this.tex=new Cn(e,t,o,n);let a=s.createFramebuffer(),r=s.createRenderbuffer();if(!a||!r)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=r,this.bind(),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t,o),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tex.glTex,0),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let o=this.width*4,n=new Uint8Array(o);for(let s=0;s<(this.height/2|0);s++){let a=s*o,r=(this.height-s-1)*o;n.set(t.subarray(a,a+o)),t.copyWithin(a,r,r+o),t.set(n,r)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},If=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,o,n){let s=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((r,l)=>r+l.size,0),this.maxVertices=o,this.maxIndices=n;let a=s.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),s.bufferData(s.ARRAY_BUFFER,o*4,s.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=s.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),s.bufferData(s.ELEMENT_ARRAY_BUFFER,n*4,s.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,o,n,s=null,a={}){(e!==this.curPrimitive||s!==this.curTex||n!==this.curShader||!Cr(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+o.length>this.maxIndices)&&this.flush();let r=this.vqueue.length/this.stride;for(let l of t)this.vqueue.push(l);for(let l of o)this.iqueue.push(l+r);this.curPrimitive=e,this.curShader=n,this.curTex=s,this.curUniform=a}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function On(e){let t=[],o=a=>{t.push(a),e(a)},n=()=>{t.pop(),e(s()??null)},s=()=>t[t.length-1];return[o,n,s]}function Pf(e,t={}){let o=[];function n(O){o.push(O)}function s(){o.forEach(w=>w());let O=e.getExtension("WEBGL_lose_context");O&&O.loseContext()}let a=null;function r(O){if(Cr(O,a))return;a=O;let w=O.reduce((A,S)=>A+S.size,0);O.reduce((A,S,I)=>(e.vertexAttribPointer(I,S.size,e.FLOAT,!1,w*4,A),e.enableVertexAttribArray(I),A+S.size*4),0)}let[l,c]=On(O=>e.bindTexture(e.TEXTURE_2D,O)),[d,i]=On(O=>e.bindBuffer(e.ARRAY_BUFFER,O)),[h,u]=On(O=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,O)),[p,g]=On(O=>e.bindFramebuffer(e.FRAMEBUFFER,O)),[M,m]=On(O=>e.bindRenderbuffer(e.RENDERBUFFER,O)),[T,P]=On(O=>{if(!O)return;let{x:w,y:A,w:S,h:I}=O;e.viewport(w,A,S,I)}),[f,N]=On(O=>e.useProgram(O));return T({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:n,destroy:s,pushTexture2D:l,popTexture2D:c,pushArrayBuffer:d,popArrayBuffer:i,pushElementArrayBuffer:h,popElementArrayBuffer:u,pushFramebuffer:p,popFramebuffer:g,pushRenderbuffer:M,popRenderbuffer:m,pushViewport:T,popViewport:P,pushProgram:f,popProgram:N,setVertexFormat:r}}var wa={};function Tc(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale($(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function ja(e){let t={},o="",n=[],s=String(e),a=r=>{n.length>0&&(t[o.length]=n.slice()),o+=r};for(;s!=="";){if(s[0]==="\\"){if(s.length===1)throw new Error("Styled text error: \\ at end of string");a(s[1]),s=s.slice(2);continue}if(s[0]==="["){let r=/^\[(\/)?(\w+?)\]/.exec(s);if(!r){a(s[0]),s=s.slice(1);continue}let[l,c,d]=r;if(c!==void 0){let i=n.pop();if(i!==d)throw i!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${i}], got [/${d}]`):new Error(`Styled text error: stray end tag [/${d}]`)}else n.push(d);s=s.slice(l.length);continue}a(s[0]),s=s.slice(1)}if(n.length>0)throw new Error(`Styled text error: unclosed tags ${n}`);return{charStyleMap:t,text:o}}function Kn(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=fd(e.font);if(!e.text||e.text===""||t instanceof Uo||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:o,text:n}=ja(e.text+""),s=b0(n);if(t instanceof Ii||typeof t=="string"){let f=t instanceof Ii?t.fontface.family:t,N=t instanceof Ii?{outline:t.outline,filter:t.filter}:{outline:null,filter:qa},O=wa[f]??{font:{tex:new Cn(x.gfx.ggl,2048,2048,{filter:N.filter}),map:{},size:64},cursor:new ne(0),maxHeight:0,outline:N.outline};wa[f]||(wa[f]=O),t=O.font;for(let w of s)if(!O.font.map[w]){let A=x.fontCacheC2d;if(!A)throw new Error("fontCacheC2d is not defined.");if(!x.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");A.clearRect(0,0,x.fontCacheCanvas.width,x.fontCacheCanvas.height),A.font=`${t.size}px ${f}`,A.textBaseline="top",A.textAlign="left",A.fillStyle="#ffffff";let S=A.measureText(w),I=Math.ceil(S.width);if(!I)continue;let E=Math.ceil(Math.abs(S.actualBoundingBoxAscent))+Math.ceil(Math.abs(S.actualBoundingBoxDescent));O.outline&&O.outline.width&&O.outline.color&&(A.lineJoin="round",A.lineWidth=O.outline.width*2,A.strokeStyle=O.outline.color.toHex(),A.strokeText(w,O.outline.width,O.outline.width),I+=O.outline.width*2,E+=O.outline.width*3),A.fillText(w,O.outline?.width??0,O.outline?.width??0);let L=A.getImageData(0,0,I,E);if(O.cursor.x+I>2048&&(O.cursor.x=0,O.cursor.y+=O.maxHeight,O.maxHeight=0,O.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(L,O.cursor.x,O.cursor.y),t.map[w]=new Jt(O.cursor.x,O.cursor.y,I,E),O.cursor.x+=I+1,O.maxHeight=Math.max(O.maxHeight,E)}}let a=e.size||t.size,r=$(e.scale??1).scale(a/t.size),l=e.lineSpacing??0,c=e.letterSpacing??0,d=0,i=0,h=0,u=[],p=[],g=0,M=null,m=0,T;for(;g<s.length;){let f=s[g];if(f===`
`)h+=a+l,u.push({width:d-c,chars:p}),M=null,m=0,d=0,p=[],T=void 0;else{let N=t.map[f];if(N){let O=N.w*r.x;e.width&&d+O>e.width&&(h+=a+l,M!=null&&(g-=p.length-M,f=s[g],N=t.map[f],O=N.w*r.x,p=p.slice(0,M-1),d=m),M=null,m=0,u.push({width:d-c,chars:p}),d=T??0,p=[]),p.push({tex:t.tex,width:N.w,height:N.h,quad:new Jt(N.x/t.tex.width,N.y/t.tex.height,N.w/t.tex.width,N.h/t.tex.height),ch:f,pos:new ne(d,h),opacity:e.opacity??1,color:e.color??Et.WHITE,scale:$(r),angle:0}),f===" "&&(M=p.length,m=d),e.indentAll&&T===void 0&&/\S/.test(f)&&(T=d),d+=O,i=Math.max(i,d),d+=c}}g++}u.push({width:d-c,chars:p}),h+=a,e.width&&(i=e.width);let P=[];for(let f=0;f<u.length;f++){let N=(i-u[f].width)*W0(e.align??"left");for(let O of u[f].chars){let w=t.map[O.ch],A=P.length+f;if(O.pos=O.pos.add(N,0).add(w.w*r.x*.5,w.h*r.y*.5),e.transform){let S=typeof e.transform=="function"?e.transform(A,O.ch):e.transform;S&&Tc(O,S)}if(o[A]){let S=o[A];for(let I of S){let E=e.styles?.[I],L=typeof E=="function"?E(A,O.ch):E;L&&Tc(O,L)}}P.push(O)}}return{width:i,height:h,chars:P,opt:e,renderedText:n}}function ei(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,n=bs(e.anchor||ia).scale(new ne(t,o).scale(-.5)),s=e.quad||new Jt(0,0,1,1),a=e.color||Ht(255,255,255),r=e.opacity??1,l=e.tex?.1/e.tex.width:0,c=e.tex?.1/e.tex.height:0,d=s.x+l,i=s.y+c,h=s.w-l*2,u=s.h-c*2;Bo(),jt(e.pos),hs(e.angle),Qs(e.scale),jt(n),Ln([{pos:new ne(-t/2,o/2),uv:new ne(e.flipX?d+h:d,e.flipY?i:i+u),color:a,opacity:r},{pos:new ne(-t/2,-o/2),uv:new ne(e.flipX?d+h:d,e.flipY?i+u:i),color:a,opacity:r},{pos:new ne(t/2,-o/2),uv:new ne(e.flipX?d:d+h,e.flipY?i+u:i),color:a,opacity:r},{pos:new ne(t/2,o/2),uv:new ne(e.flipX?d:d+h,e.flipY?i:i+u),color:a,opacity:r}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),Eo()}function Vn(e){Bo(),jt(e.opt.pos),hs(e.opt.angle),jt(bs(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{ei({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),Eo()}function zo(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,n=bs(e.anchor||ia).add(1,1).scale(new ne(t,o).scale(-.5)),s=[new ne(0,0),new ne(t,0),new ne(t,o),new ne(0,o)];if(e.radius){let a=Math.min(t,o)/2,r=Array.isArray(e.radius)?e.radius.map(l=>Math.min(a,l)):new Array(4).fill(Math.min(a,e.radius));s=[new ne(r[0],0),...r[1]?Us(new ne(t-r[1],r[1]),r[1],r[1],270,360):[$(t,0)],...r[2]?Us(new ne(t-r[2],o-r[2]),r[2],r[2],0,90):[$(t,o)],...r[3]?Us(new ne(r[3],o-r[3]),r[3],r[3],90,180):[$(0,o)],...r[0]?Us(new ne(r[0],r[0]),r[0],r[0],180,270):[]]}Dn(Object.assign({},e,{offset:n,pts:s,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function Sn(e){Lo();let t=x.gfx.width,o=x.gfx.height;x.gfx.width=x.gfx.viewport.width,x.gfx.height=x.gfx.viewport.height,e(),Lo(),x.gfx.width=t,x.gfx.height=o}function Dc(e,t){Sn(()=>{let o=$(8);Bo(),jt(e);let n=Kn({text:t,font:Ni,size:16,pos:o,color:Ht(255,255,255),fixed:!0}),s=n.width+o.x*2,a=n.height+o.x*2;e.x+s>=co()&&jt($(-s,0)),e.y+a>=uo()&&jt($(0,-a)),zo({width:s,height:a,color:Ht(0,0,0),radius:4,opacity:.8,fixed:!0}),Vn(n),Eo()})}function Ed(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return Dn(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Bf(){if(x.debug.inspect){let e=null;for(let t of x.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(x.game.root.drawInspect(),e){let t=[],o=e.inspect();for(let n in o)o[n]?t.push(`${o[n]}`):t.push(`${n}`);Dc(P0(x.k.mousePos()),t.join(`
`))}Dc($(8),`FPS: ${x.debug.fps()}`)}x.debug.paused&&Sn(()=>{Bo(),jt(co(),0),jt(-8,8);let e=32;zo({width:e,height:e,anchor:"topright",color:Ht(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)zo({width:4,height:e*.6,anchor:"center",pos:$(-e/3*t,e*.5),color:Ht(255,255,255),radius:2,fixed:!0});Eo()}),x.debug.timeScale!==1&&Sn(()=>{Bo(),jt(co(),uo()),jt(-8,-8);let e=8,t=Kn({text:x.debug.timeScale.toFixed(1),font:Ni,size:16,color:Ht(255,255,255),pos:$(-e),anchor:"botright",fixed:!0});zo({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Ht(0,0,0),opacity:.8,radius:4,fixed:!0});for(let o=0;o<2;o++){let n=x.debug.timeScale<1;Ed({p1:$(-t.width-e*(n?2:3.5),-e),p2:$(-t.width-e*(n?2:3.5),-e-t.height),p3:$(-t.width-e*(n?3.5:2),-e-t.height/2),pos:$(-o*e*1+(n?-e*.5:0),0),color:Ht(255,255,255),fixed:!0})}Vn(t),Eo()}),x.debug.curRecording&&Sn(()=>{Bo(),jt(0,uo()),jt(24,-24),ws({radius:12,color:Ht(255,0,0),opacity:Hl(0,1,x.app.time()*4),fixed:!0}),Eo()}),x.debug.showLog&&x.game.logs.length>0&&Sn(()=>{Bo(),jt(0,uo()),jt(8,-8);let e=8,t=[];for(let n of x.game.logs){let s="",a=n.msg instanceof Error?"error":"info";s+=`[time]${n.time.toFixed(2)}[/time]`,s+=" ",s+=`[${a}]${Za(n.msg)}[/${a}]`,t.push(s)}x.game.logs=x.game.logs.filter(n=>x.app.time()-n.time<(x.globalOpt.logTime||4));let o=Kn({text:t.join(`
`),font:Ni,pos:$(e,-e),anchor:"botleft",size:16,width:co()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Ht(127,127,127)},info:{color:Ht(255,255,255)},error:{color:Ht(255,0,127)}}});zo({width:o.width+e*2,height:o.height+e*2,anchor:"botleft",color:Ht(0,0,0),radius:4,opacity:.8,fixed:!0}),Vn(o),Eo()})}function Za(e,t=!1,o=new Set){if(o.has(e))return"<recursive>";var n="",s;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(n=["[",e.map(a=>Za(a,!0,o.union(new Set([e])))).join(", "),"]"].join(""),e=n),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(n+=e.constructor.name+" "),n+=["{",(s=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${Za(e[a],!0,o.union(new Set([e])))}`).join(", "))?` ${s} `:"","}"].join(""),e=n),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function Lf(){let e=x.game.cam,t=ne.fromAngle(so(0,360)).scale(e.shake);e.shake=So(e.shake,0,5*io()),e.transform=new sn().translate(_i()).scale(e.scale).rotate(e.angle).translate((e.pos??_i()).scale(-1).add(t)),x.game.root.draw(),Lo()}function zf(){let e=Gn();x.game.events.numListeners("loading")>0?x.game.events.trigger("loading",e):Sn(()=>{let t=co()/2,o=24,n=$(co()/2,uo()/2).sub($(t/2,o/2));zo({pos:$(0),width:co(),height:uo(),color:Ht(0,0,0)}),zo({pos:n,width:t,height:o,fill:!1,outline:{width:4}}),zo({pos:n,width:t*e,height:o})})}function Ad(e,t,o){let n=x.gfx.ggl.gl;Lo(),n.clear(n.STENCIL_BUFFER_BIT),n.enable(n.STENCIL_TEST),n.stencilFunc(n.NEVER,1,255),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),t(),Lo(),n.stencilFunc(o,1,255),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),e(),Lo(),n.disable(n.STENCIL_TEST)}function Of(e,t){let o=x.gfx.ggl.gl;Ad(e,t,o.EQUAL)}function Fi(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new Jt(0,0,1,1),o=e.tex.width*t.w,n=e.tex.height*t.h,s=new ne(1);if(e.tiled){let a=bs(e.anchor||ia);(e.pos?.x||0)-(a.x+1)*.5*(e.width||o),(e.pos?.y||0)-(a.y+1)*.5*(e.height||n);let r=(e.width||o)/o,l=(e.height||n)/n,c=Math.floor(r),d=Math.floor(l),i=r-c,h=l-d,u=(c+i?1:0)*(d+h?1:0),p=new Array(u*6),g=new Array(u*4),M=0,m=(T,P,f,N,O)=>{p[M*6+0]=M*4+0,p[M*6+1]=M*4+1,p[M*6+2]=M*4+3,p[M*6+3]=M*4+1,p[M*6+4]=M*4+2,p[M*6+5]=M*4+3,g[M*4+0]={pos:new ne(T-a.x,P-a.y),uv:new ne(O.x,O.y),color:e.color||Et.WHITE,opacity:e.opacity||1},g[M*4+1]={pos:new ne(T+f-a.x,P-a.y),uv:new ne(O.x+O.w,O.y),color:e.color||Et.WHITE,opacity:e.opacity||1},g[M*4+2]={pos:new ne(T+f-a.x,P+N-a.y),uv:new ne(O.x+O.w,O.y+O.h),color:e.color||Et.WHITE,opacity:e.opacity||1},g[M*4+3]={pos:new ne(T-a.x,P+N-a.y),uv:new ne(O.x,O.y+O.h),color:e.color||Et.WHITE,opacity:e.opacity||1},M++};for(let T=0;T<d;T++){for(let P=0;P<c;P++)m(P*o,T*n,o,n,t);i&&m(c*o,T*n,o*i,n,new Jt(t.x,t.y,t.w*i,t.h))}if(h){for(let T=0;T<c;T++)m(T*o,d*n,o,n*h,new Jt(t.x,t.y,t.w,t.h*h));i&&m(c*o,d*n,o*i,n*h,new Jt(t.x,t.y,t.w*i,t.h*h))}Ln(g,p,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(s.x=e.width/o,s.y=e.height/n):e.width?(s.x=e.width/o,s.y=s.x):e.height&&(s.y=e.height/n,s.x=s.y),ei(Object.assign({},e,{scale:s.scale(e.scale||new ne(1)),tex:e.tex,quad:t,width:o,height:n}))}function Hf(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Ri(e.sprite);if(!t||!t.data)return;let o=t.data.frames[e.frame??0];if(!o)throw new Error(`Frame not found: ${e.frame??0}`);Fi(Object.assign({},e,{tex:t.data.tex,quad:o.scale(e.quad??new Jt(0,0,1,1))}))}function Uf(e,t){let o=x.gfx.ggl.gl;Ad(e,t,o.NOTEQUAL)}function Cc(e){Vn(Kn(e))}var Nf=(e,t)=>{let o=Pr(t,Ga,Ka),n=e.pixelDensity??1,s=e.scale??1,{gl:a}=t,r=Cn.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new Xi(t,e.width*n*s,e.height*n*s):new Xi(t,a.drawingBufferWidth,a.drawingBufferHeight),c=null,d=1;e.background&&(typeof e.background=="string"?c=Ht(e.background):(c=Ht(...e.background),d=e.background[3]??1),a.clearColor(c.r/255,c.g/255,c.b/255,d??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let i=new If(t,Tr,t0,o0),h=Cn.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:o,defTex:r,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:i,transform:new sn,transformStack:[],bgTex:h,bgColor:c,bgAlpha:d,width:e.width??a.drawingBufferWidth/n/s,height:e.height??a.drawingBufferHeight/n/s,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function Xn(e){return e.fixed?!0:e.parent?Xn(e.parent):!1}function Wn(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function _f(e,t={}){return{id:"circle",radius:e,draw(){ws(Object.assign(Wn(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Yt(new ne(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Sd(...e){return{id:"color",color:Ht(...e),inspect(){return`color: ${this.color.toString()}`}}}function Xf(e){return{add(){this.canvas=e}}}function Ff(e=1){let t,o=0,n=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){n||(o+=io(),this.opacity=en(o,0,e,0,t),o>=e&&(this.opacity=t,n=!0))}}}function Yf(e="intersect"){return{id:"mask",mask:e}}function Md(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,o=x.k.easings.linear){return x.game.root.tween(0,this.opacity,t,n=>this.opacity=n,o)},fadeOut(t=1,o=x.k.easings.linear){return x.game.root.tween(this.opacity,0,t,n=>this.opacity=n,o)},inspect(){return`opacity: ${Va(this.opacity,1)}`}}}function qf(e=1,t=Ht(0,0,0),o=1,n="miter",s=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:o,join:n,miterLimit:s,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var Gf=class{pos=$(0);vel=$(0);acc=$(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function Kf(e,t){let o=t.lifetime,n=[],s=e.colors||[Et.WHITE],a=e.opacities||[1],r=e.quads||[new Jt(0,0,1,1)],l=e.scales||[1],c=e.lifeTime,d=t.direction,i=t.spread,h=e.speed||[0,0],u=e.angle||[0,0],p=e.angularVelocity||[0,0],g=e.acceleration||[$(0),$(0)],M=e.damping||[0,0],m=[],T=new Array(e.max),P=0,f=0;for(let w=0;w<e.max;w++){m[w*6+0]=w*4+0,m[w*6+1]=w*4+1,m[w*6+2]=w*4+3,m[w*6+3]=w*4+1,m[w*6+4]=w*4+2,m[w*6+5]=w*4+3;for(let A=0;A<4;A++)T[w*4+A]={pos:new ne(0,0),uv:new ne(0,0),color:Ht(255,255,255),opacity:1};n[w]=new Gf}let N=new yo;function O(w=0){for(;w<e.max;){if(n[w].gc)return w;w++}return null}return{id:"particles",emit(w){let A=0;for(let S=0;S<w;S++){if(A=O(A),A==null)return;let I=so(d-i,d+i),E=ne.fromAngle(I).scale(so(h[0],h[1])),L=so(u[0],u[1]),C=so(p[0],p[1]),F=$(so(g[0].x,g[1].x),so(g[0].y,g[1].y)),U=so(M[0],M[1]),_=c?so(c[0],c[1]):null,H=t.shape?t.shape.random():$(),R=n[A];R.lt=_,R.pos=H,R.vel=E,R.acc=F,R.angle=L,R.angularVelocity=C,R.damping=U,R.angularVelocity=C,R.gc=!1}P+=w},update(){if(o!==void 0&&o<=0)return;let w=io();for(let A of n)if(!A.gc){if(A.t+=w,A.lt&&A.t>=A.lt){A.gc=!0,P--;continue}A.vel=A.vel.add(A.acc.scale(w)).scale(1-A.damping*w),A.pos=A.pos.add(A.vel.scale(w)),A.angle+=A.angularVelocity*w}for(o!==void 0&&(o-=w,o<=0&&N.trigger()),f+=w;P<e.max&&t.rate&&f>t.rate;)this.emit(1),P++,f-=t.rate},draw(){if(!(o!==void 0&&o<=0)){for(let w=0;w<n.length;w++){let A=n[w];if(A.gc)continue;let S=A.progress,I=Math.floor(A.progress*s.length),E=I<s.length-1?So(s[I],s[I+1],en(S,I/s.length,(I+1)/s.length,0,1)):s[I],L=Math.floor(A.progress*a.length),C=L<a.length-1?So(a[L],a[L+1],en(S,L/a.length,(L+1)/a.length,0,1)):a[L],F=Math.floor(A.progress*r.length),U=r[F],_=Math.floor(A.progress*l.length),H=l[_],R=Math.cos(A.angle*Math.PI/180),Y=Math.sin(A.angle*Math.PI/180),V=(e.texture?e.texture.width:10)*U.w/2,Q=(e.texture?e.texture.height:10)*U.h/2,fe=w*4,se=T[fe];se.pos.x=A.pos.x+-V*H*R- -Q*H*Y,se.pos.y=A.pos.y+-V*H*Y+-Q*H*R,se.uv.x=U.x,se.uv.y=U.y,se.color.r=E.r,se.color.g=E.g,se.color.b=E.b,se.opacity=C,se=T[fe+1],se.pos.x=A.pos.x+V*H*R- -Q*H*Y,se.pos.y=A.pos.y+V*H*Y+-Q*H*R,se.uv.x=U.x+U.w,se.uv.y=U.y,se.color.r=E.r,se.color.g=E.g,se.color.b=E.b,se.opacity=C,se=T[fe+2],se.pos.x=A.pos.x+V*H*R-Q*H*Y,se.pos.y=A.pos.y+V*H*Y+Q*H*R,se.uv.x=U.x+U.w,se.uv.y=U.y+U.h,se.color.r=E.r,se.color.g=E.g,se.color.b=E.b,se.opacity=C,se=T[fe+3],se.pos.x=A.pos.x+-V*H*R-Q*H*Y,se.pos.y=A.pos.y+-V*H*Y+Q*H*R,se.uv.x=U.x,se.uv.y=U.y+U.h,se.color.r=E.r,se.color.g=E.g,se.color.b=E.b,se.opacity=C}Ln(T,m,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(w){return N.add(w)},inspect(){return`count: ${P}/${e.max}`}}}function Vf(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){Dn(Object.assign(Wn(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new xo(this.pts)},inspect(){return`polygon: ${this.pts.map(o=>`[${o.x},${o.y}]`).join(",")}`}}}function Td(e,t,o){let n;return x.game.root.get("area").forEach(s=>{if(o&&o.some(r=>s.is(r)))return;let a=s.worldArea().raycast(e,t);a&&(n?a.fraction<n.fraction&&(n=a,n.object=s):(n=a,n.object=s))}),n}function Dd(e,t,o={}){return{id:"rect",width:e,height:t,radius:o.radius||0,draw(){zo(Object.assign(Wn(this),{width:this.width,height:this.height,radius:this.radius,fill:o.fill}))},renderArea(){return new Yt($(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Wf(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function $f(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let o=x.game.root.add([Yi(t.pos??$(0))]),n=e.length,s=0,a=null,r=null,l=null,c=null,d=w=>w.x+w.y*s,i=w=>$(Math.floor(w%s),Math.floor(w/s)),h=()=>{a=[];for(let w of o.children)u(w)},u=w=>{let A=d(w.tilePos);a[A]?a[A].push(w):a[A]=[w]},p=w=>{let A=d(w.tilePos);if(a[A]){let S=a[A].indexOf(w);S>=0&&a[A].splice(S,1)}},g=()=>{let w=!1;for(let A of o.children){let S=o.pos2Tile(A.pos);(A.tilePos.x!=S.x||A.tilePos.y!=S.y)&&(w=!0,p(A),A.tilePos.x=S.x,A.tilePos.y=S.y,u(A))}w&&o.trigger("spatialMapChanged")},M=()=>{let w=o.getSpatialMap(),A=o.numRows()*o.numColumns();r?r.length=A:r=new Array(A),r.fill(1,0,A);for(let S=0;S<w.length;S++){let I=w[S];if(I){let E=0;for(let L of I)if(L.isObstacle){E=1/0;break}else E+=L.cost;r[S]=E||1}}},m=()=>{let w=o.getSpatialMap(),A=o.numRows()*o.numColumns();l?l.length=A:l=new Array(A),l.fill(15,0,A);for(let S=0;S<w.length;S++){let I=w[S];if(I){let E=I.length,L=15;for(let C=0;C<E;C++)L|=I[C].edgeMask;l[S]=L}}},T=()=>{let w=o.numRows()*o.numColumns(),A=(I,E)=>{let L=[];for(L.push(I);L.length>0;){let C=L.pop();N(C).forEach(F=>{c[F]<0&&(c[F]=E,L.push(F))})}};c?c.length=w:c=new Array(w),c.fill(-1,0,w);let S=0;for(let I=0;I<r.length;I++){if(c[I]>=0){S++;continue}A(I,S),S++}},P=(w,A)=>r[A],f=(w,A)=>{let S=i(w),I=i(A);return S.dist(I)},N=(w,A)=>{let S=[],I=Math.floor(w%s),E=I>0&&l[w]&1&&r[w-1]!==1/0,L=w>=s&&l[w]&2&&r[w-s]!==1/0,C=I<s-1&&l[w]&4&&r[w+1]!==1/0,F=w<s*n-s-1&&l[w]&8&&r[w+s]!==1/0;return A?(E&&(L&&S.push(w-s-1),S.push(w-1),F&&S.push(w+s-1)),L&&S.push(w-s),C&&(L&&S.push(w-s+1),S.push(w+1),F&&S.push(w+s+1)),F&&S.push(w+s)):(E&&S.push(w-1),L&&S.push(w-s),C&&S.push(w+1),F&&S.push(w+s)),S},O={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(w,...A){let S=$(...A),I=(()=>{if(typeof w=="string"){if(t.tiles[w]){if(typeof t.tiles[w]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[w](S)}else if(t.wildcardTile)return t.wildcardTile(w,S)}else{if(Array.isArray(w))return w;throw new Error("Expected a symbol or a component list")}})();if(!I)return null;let E=!1,L=!1;for(let F of I)F.id==="tile"&&(L=!0),F.id==="pos"&&(E=!0);E||I.push(Yi(this.tile2Pos(S))),L||I.push(Kd());let C=o.add(I);return E&&(C.tilePosOffset=C.pos.clone()),C.tilePos=S,C.transform=Ks(C),a&&(u(C),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),C},numColumns(){return s},numRows(){return n},levelWidth(){return s*this.tileWidth()},levelHeight(){return n*this.tileHeight()},tile2Pos(...w){return $(...w).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...w){let A=$(...w);return $(Math.floor(A.x/this.tileWidth()),Math.floor(A.y/this.tileHeight()))},getSpatialMap(){return a||h(),a},removeFromSpatialMap:p,insertIntoSpatialMap:u,onSpatialMapChanged(w){return this.on("spatialMapChanged",w)},onNavigationMapInvalid(w){return this.on("navigationMapInvalid",w)},getAt(w){a||h();let A=d(w);return a[A]||[]},raycast(w,A){let S=this.toWorld(w),I=this.toWorld(w.add(A)).sub(S),E=1/this.tileWidth(),L=w.scale(E),C=Cu(L,A,F=>{let U=this.getAt(F);if(U.some(H=>H.isObstacle))return!0;let _=null;for(let H of U)if(H.has("area")){let R=H.worldArea().raycast(S,I);R&&(_?R.fraction<_.fraction&&(_=R,_.object=H):(_=R,_.object=H))}return _&&(_.point=this.fromWorld(_.point).scale(E)),_||!1},64);return C&&(C.point=C.point.scale(this.tileWidth())),C},update(){a&&g()},invalidateNavigationMap(){r=null,l=null,c=null},onNavigationMapChanged(w){return this.on("navigationMapChanged",w)},getTilePath(w,A,S={}){if(r||M(),l||m(),c||T(),w.x<0||w.x>=s||w.y<0||w.y>=n||A.x<0||A.x>=s||A.y<0||A.y>=n)return null;let I=d(w),E=d(A);if(r[E]===1/0)return null;if(I===E)return[];if(c[I]!=-1&&c[I]!==c[E])return null;let L=new sd((R,Y)=>R.cost<Y.cost);L.insert({cost:0,node:I});let C=new Map;C.set(I,I);let F=new Map;for(F.set(I,0);L.length!==0;){let R=L.remove()?.node;if(R===E)break;let Y=N(R,S.allowDiagonals);for(let V of Y){let Q=(F.get(R)||0)+P(R,V)+f(V,E);(!F.has(V)||Q<F.get(V))&&(F.set(V,Q),L.insert({cost:Q,node:V}),C.set(V,R))}}let U=[],_=E,H=i(_);for(U.push(H);_!==I;){let R=C.get(_);if(R===void 0)throw new Error("Bug in pathfinding algorithm");_=R;let Y=i(_);U.push(Y)}return U.reverse()},getPath(w,A,S={}){let I=this.tileWidth(),E=this.tileHeight(),L=this.getTilePath(this.pos2Tile(w),this.pos2Tile(A),S);return L?[w,...L.slice(1,-1).map(C=>C.scale(I,E).add(I/2,E/2)),A]:null}};return o.use(O),o.onNavigationMapInvalid(()=>{o.invalidateNavigationMap(),o.trigger("navigationMapChanged")}),e.forEach((w,A)=>{let S=w.split("");s=Math.max(S.length,s),S.forEach((I,E)=>{o.spawn(I,$(E,A))})}),o}function Ro(e,t,o){return x.game.objEvents.registers[e]||(x.game.objEvents.registers[e]=new od),x.game.objEvents.on(e,(n,...s)=>{n.is(t)&&o(n,...s)})}var Jf=(e,t,...o)=>{for(let n of x.game.root.children)n.is(t)&&n.trigger(e,o)},jf=Kt(e=>{let t=x.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ro("fixedUpdate",e,t)),Cd=Kt(e=>{let t=x.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ro("update",e,t)),Zf=Kt(e=>{let t=x.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(o){t.hidden=o},cancel:()=>t.destroy()}},(e,t)=>Ro("draw",e,t)),Rd=Kt(e=>x.game.events.on("add",e),(e,t)=>Ro("add",e,t)),Qf=Kt(e=>x.game.events.on("destroy",e),(e,t)=>Ro("destroy",e,t)),kf=Kt(e=>x.game.events.on("use",e),(e,t)=>Ro("use",e,t)),ep=Kt(e=>x.game.events.on("unuse",e),(e,t)=>Ro("unuse",e,t)),Id=Kt(e=>x.game.events.on("tag",e),(e,t)=>Ro("tag",e,t)),tp=Kt(e=>x.game.events.on("untag",e),(e,t)=>Ro("untag",e,t));function op(e,t,o){return Ro("collide",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function np(e,t,o){return Ro("collideUpdate",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function sp(e,t,o){return Ro("collideEnd",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function ca(e,t){x.game.root.get(e,{recursive:!0}).forEach(t),Rd(e,t),Id((o,n)=>{n===e&&t(o)})}var ip=Kt(e=>x.app.onMousePress(e),(e,t)=>{let o=[];return ca(e,n=>{if(!n.area)throw new Error("onClick() requires the object to have area() component");o.push(n.onClick(()=>t(n)))}),Qn.join(o)});function ap(e,t){let o=[];return ca(e,n=>{if(!n.area)throw new Error("onHover() requires the object to have area() component");o.push(n.onHover(()=>t(n)))}),Qn.join(o)}function rp(e,t){let o=[];return ca(e,n=>{if(!n.area)throw new Error("onHoverUpdate() requires the object to have area() component");o.push(n.onHoverUpdate(()=>t(n)))}),Qn.join(o)}function cp(e,t){let o=[];return ca(e,n=>{if(!n.area)throw new Error("onHoverEnd() requires the object to have area() component");o.push(n.onHoverEnd(()=>t(n)))}),Qn.join(o)}function lp(e){x.game.events.on("loading",e)}function dp(e){x.app.onResize(e)}function hp(e){x.game.events.on("error",e)}function Lr(e){x.assets.loaded?e():x.game.events.on("load",e)}function up(e){if(x.assets.loaded)dd().forEach(t=>e(...t));else return x.game.events.on("loadError",e)}function Pd(...e){x.game.cam.pos=$(...e)}function Bd(){return x.game.cam.pos?x.game.cam.pos.clone():_i()}function Ld(...e){x.game.cam.scale=$(...e)}function zd(){return x.game.cam.scale.clone()}function Od(e){x.game.cam.angle=e}function Hd(){return x.game.cam.angle}function fp(){return x.game.cam.transform.clone()}function Ud(e=Ht(255,255,255),t=1){let o=x.game.root.add([Dd(co(),uo()),Sd(e),Md(1),$d()]),n=o.fadeOut(t);return n.onEnd(()=>Gd(o)),n}function pp(){return x.game.cam.transform.clone()}function gp(e=12){x.game.cam.shake+=e}function Qa(e){return x.game.cam.transform.multVec2(e)}function Nd(e){return x.game.cam.transform.invert().multVec2(e)}function mp(...e){return xs("camPos","setCamPos / getCamPos"),e.length>0&&Pd(...e),Bd()}function yp(...e){return xs("camScale","setCamScale / getCamScale"),e.length>0&&Ld(...e),zd()}function xp(e){return xs("camRot","setCamRot / getCamRot"),e!==void 0&&Od(e),Hd()}function bp(e=Ht(255,255,255),t=1){return xs("camFlash","flash"),Ud(e,t)}function zr(e=[]){let t=new Map,o=[],n={},s=new js,a=[],r=new Set("*"),l=x.globalOpt.tagsAsComponents,c=null,d=!1,i={id:R0(),hidden:!1,transform:new sn,children:[],parent:null,set paused(u){if(u!==d){d=u;for(let p of a)p.paused=u}},get paused(){return d},get tags(){return Array.from(r)},add(u){let p=Array.isArray(u)?zr(u):u;if(p.parent)throw new Error("Cannot add a game obj that already has a parent.");return p.parent=this,p.transform=Ks(p),this.children.push(p),p.trigger("add",p),x.game.events.trigger("add",p),p},readd(u){let p=this.children.indexOf(u);return p!==-1&&(this.children.splice(p,1),this.children.push(u)),u},remove(u){let p=this.children.indexOf(u);if(p!==-1){u.parent=null,this.children.splice(p,1);let g=M=>{M.trigger("destroy"),x.game.events.trigger("destroy",M),M.children.forEach(m=>g(m))};g(u)}},removeAll(u){if(u)this.get(u).forEach(p=>this.remove(p));else for(let p of[...this.children])this.remove(p)},fixedUpdate(){this.paused||(this.children.forEach(u=>u.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(u=>u.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Lo(),this.canvas.bind());let u=x.gfx.fixed;this.fixed&&(x.gfx.fixed=!0),Bo(),jt(this.pos),Qs(this.scale),hs(this.angle);let p=this.children.sort((g,M)=>{let m=g.layerIndex??x.game.defaultLayerIndex,T=M.layerIndex??x.game.defaultLayerIndex;return m-T||(g.z??0)-(M.z??0)});if(this.mask){let g={intersect:x.k.drawMasked,subtract:x.k.drawSubtracted}[this.mask];if(!g)throw new Error(`Invalid mask func: "${this.mask}"`);g(()=>{p.forEach(M=>M.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),p.forEach(g=>g.draw());Eo(),x.gfx.fixed=u,this.canvas&&(Lo(),this.canvas.unbind())},drawInspect(){this.hidden||(Bo(),jt(this.pos),Qs(this.scale),hs(this.angle),this.children.forEach(u=>u.drawInspect()),this.trigger("drawInspect"),Eo())},use(u){if(typeof u=="string")return r.add(u);if(!u||typeof u!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof u}"`);let p=[];u.id?(this.unuse(u.id),n[u.id]=[],p=n[u.id],t.set(u.id,u),l&&r.add(u.id)):o.push(u);for(let M in u){if(i0.has(M))continue;let m=Object.getOwnPropertyDescriptor(u,M);if(m)if(typeof m.value=="function"&&(u[M]=u[M].bind(this)),m.set&&Object.defineProperty(u,M,{set:m.set.bind(this)}),m.get&&Object.defineProperty(u,M,{get:m.get.bind(this)}),a0.has(M)){let T=M==="add"?()=>{c=P=>p.push(P),u[M]?.(),c=null}:u[M];p.push(this.on(M,T).cancel)}else if(this[M]===void 0)Object.defineProperty(this,M,{get:()=>u[M],set:T=>u[M]=T,configurable:!0,enumerable:!0}),p.push(()=>delete this[M]);else{let T=t.values().find(P=>P[M]!==void 0)?.id;throw new Error(`Duplicate component property: "${M}" while adding component "${u.id}"`+(T?` (originally added by "${T}")`:""))}}let g=()=>{if(u.require){for(let M of u.require)if(!this.c(M))throw new Error(`Component "${u.id}" requires component "${M}"`)}};u.destroy&&p.push(u.destroy.bind(this)),this.exists()?(g(),u.add&&(c=M=>p.push(M),u.add.call(this),c=null),u.id&&(this.trigger("use",u.id),x.game.events.trigger("use",this,u.id))):u.require&&p.push(this.on("add",g).cancel)},unuse(u){if(t.has(u)){for(let p of t.values())if(p.require&&p.require.includes(u))throw new Error(`Can't unuse. Component "${p.id}" requires component "${u}"`);t.delete(u),this.trigger("unuse",u),x.game.events.trigger("unuse",this,u)}else l&&r.has(u)&&r.delete(u);n[u]&&(n[u].forEach(p=>p()),delete n[u])},c(u){return t.get(u)??null},get(u,p={}){let g=(m,T)=>p.only==="comps"?m.has(T):p.only==="tags"?m.is(T):m.is(T)||m.has(T),M=p.recursive?this.children.flatMap(function m(T){return[T,...T.children.flatMap(m)]}):this.children;if(M=M.filter(m=>u?g(m,u):!0),p.liveUpdate){let m=P=>p.recursive?this.isAncestorOf(P):P.parent===this,T=[];T.push(x.k.onAdd(P=>{m(P)&&g(P,u)&&M.push(P)})),T.push(x.k.onDestroy(P=>{if(m(P)&&g(P,u)){let f=M.findIndex(N=>N.id===P.id);f!==-1&&M.splice(f,1)}})),this.onDestroy(()=>{for(let P of T)P.cancel()})}return M},query(u){let p=u.hierarchy||"children",g=u.include,M=u.exclude,m=[];switch(p){case"children":m=this.children;break;case"siblings":m=this.parent?this.parent.children.filter(P=>P!==this):[];break;case"ancestors":let T=this.parent;for(;T;)m.push(T),T=T.parent;break;case"descendants":m=this.children.flatMap(function P(f){return[f,...f.children.flatMap(P)]});break}if(g&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(T=>T.is(g)):m=m.filter(T=>u.include.some(P=>T.is(P)))),M&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(T=>!T.is(M)):m=m.filter(T=>!u.exclude.some(P=>T.is(P)))),u.visible===!0&&(m=m.filter(T=>T.visible)),u.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let T=u.distanceOp||"near",P=u.distance*u.distance;T==="near"?m=m.filter(f=>f.pos&&this.pos.sdist(f.pos)<=P):m=m.filter(f=>f.pos&&this.pos.sdist(f.pos)>P)}return u.name&&(m=m.filter(T=>T.name===u.name)),m},isAncestorOf(u){return u.parent?u.parent===this||this.isAncestorOf(u.parent):!1},exists(){return x.game.root.isAncestorOf(this)},is(u,p="and"){return Array.isArray(u)?p==="and"?u.every(g=>r.has(g)):u.some(g=>r.has(g)):r.has(u)},tag(u){if(Array.isArray(u))for(let p of u)r.add(p),this.trigger("tag",p),x.game.events.trigger("tag",this,p);else r.add(u),this.trigger("tag",u),x.game.events.trigger("tag",this,u)},untag(u){if(Array.isArray(u))for(let p of u)r.delete(p),this.trigger("untag",p),x.game.events.trigger("untag",this,p);else r.delete(u),this.trigger("untag",u),x.game.events.trigger("untag",this,u)},has(u,p="and"){return Array.isArray(u)?p==="and"?u.every(g=>t.has(g)):u.some(g=>t.has(g)):t.has(u)},on(u,p){let g=s.on(u,p.bind(this));return c&&c(()=>g.cancel()),g},trigger(u,...p){s.trigger(u,...p),x.game.objEvents.trigger(u,this,...p)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let u={};for(let[p,g]of t)u[p]=g.inspect?.()??null;for(let[p,g]of o.entries()){if(g.inspect){u[p]=g.inspect();continue}for(let[M,m]of Object.entries(g))typeof m!="function"&&(u[M]=`${M}: ${m}`)}return u},onAdd(u){return this.on("add",u)},onFixedUpdate(u){return this.on("fixedUpdate",u)},onUpdate(u){return this.on("update",u)},onDraw(u){return this.on("draw",u)},onDestroy(u){return this.on("destroy",u)},onUse(u){return this.on("use",u)},onUnuse(u){return this.on("unuse",u)},clearEvents(){s.clear()}},h=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let u of h)i[u]=(...p)=>{let g=x.app[u]?.(...p);return a.push(g),i.onDestroy(()=>g.cancel()),i.on("sceneEnter",()=>{a.splice(a.indexOf(g),1);let M=x.app[u]?.(...p);Qn.replace(g,M),a.push(g)}),g};for(let u of e)i.use(u);return i}var wp=()=>({events:new js,objEvents:new js,root:zr([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new ne(1),angle:0,shake:0,transform:new sn}});function vp(e){x.game.gravity=e?(x.game.gravity||$(0,1)).unit().scale(e):null}function Ep(){return x.game.gravity?x.game.gravity.len():0}function Ap(e){x.game.gravity=e.unit().scale(x.game.gravity?x.game.gravity.len():1)}function Ws(){return x.game.gravity?x.game.gravity.unit():$(0,1)}var Sp=iu("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Mp=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let o=new ks($0(e));return e.decodeAudioData(Sp.buffer.slice(0)).then(n=>{o.buf=n}).catch(n=>{console.error("Failed to load burp: ",n)}),{ctx:e,masterNode:t,burpSnd:o}})();function Tp(e,t={}){let o=new yo,n=new Audio(e);n.crossOrigin="anonymous",n.loop=!!t.loop,x.audio.ctx.createMediaElementSource(n).connect(x.audio.masterNode);function s(){x.debug.paused||x.app.isHidden()&&!x.globalOpt.backgroundAudio||x.audio.ctx.resume()}function a(){s(),n.play()}return t.paused||a(),n.onended=()=>o.trigger(),{play(){a()},seek(r){n.currentTime=r},stop(){n.pause(),this.seek(0)},set loop(r){n.loop=r},get loop(){return n.loop},set paused(r){r?n.pause():a()},get paused(){return n.paused},time(){return n.currentTime},duration(){return n.duration},set volume(r){n.volume=nn(r,0,1)},get volume(){return n.volume},set speed(r){n.playbackRate=Math.max(r,0)},get speed(){return n.playbackRate},set detune(r){},get detune(){return 0},onEnd(r){return o.add(r)},then(r){return this.onEnd(r)}}}function Dp(e,t={}){if(typeof e=="string"&&x.assets.music[e])return Tp(x.assets.music[e],t);let o=x.audio.ctx,n=t.paused??!1,s=o.createBufferSource(),a=new yo,r=o.createGain(),l=o.createStereoPanner(),c=t.seek??0,d=0,i=0,h=!1;s.loop=!!t.loop,s.detune.value=t.detune??0,s.playbackRate.value=t.speed??1,s.connect(l),s.onended=()=>{g()>=(s.buffer?.duration??Number.POSITIVE_INFINITY)&&a.trigger()},l.pan.value=t.pan??0,l.connect(r),r.connect(x.audio.masterNode),r.gain.value=t.volume??1;let u=m=>{s.buffer=m.buf,n||(d=o.currentTime,s.start(0,c),h=!0)},p=Af(e);p instanceof Uo&&p.onLoad(u);let g=()=>{if(!s.buffer)return 0;let m=n?i-d:o.currentTime-d,T=s.buffer.duration;return s.loop?m%T:Math.min(m,T)},M=m=>{let T=o.createBufferSource();return T.buffer=m.buffer,T.loop=m.loop,T.playbackRate.value=m.playbackRate.value,T.detune.value=m.detune.value,T.onended=m.onended,T.connect(l),T};return{stop(){this.paused=!0,this.seek(0)},set paused(m){if(n!==m)if(n=m,m)h&&(s.stop(),h=!1),i=o.currentTime;else{s=M(s);let T=i-d;s.start(0,T),h=!0,d=o.currentTime-T,i=0}},get paused(){return n},play(m=0){this.seek(m),this.paused=!1},seek(m){s.buffer?.duration&&(m>s.buffer.duration||(n?(s=M(s),d=i-m):(s.stop(),s=M(s),d=o.currentTime-m,s.start(0,m),h=!0,i=0)))},set speed(m){s.playbackRate.value=m},get speed(){return s.playbackRate.value},set detune(m){s.detune.value=m},get detune(){return s.detune.value},set volume(m){r.gain.value=Math.max(m,0)},get volume(){return r.gain.value},set pan(m){l.pan.value=m},get pan(){return l.pan.value},set loop(m){s.loop=m},get loop(){return s.loop},duration(){return s.buffer?.duration??0},time(){return g()%this.duration()},onEnd(m){return a.add(m)},then(m){return this.onEnd(m)}}}function _d(e){return x.k.play(x.audio.burpSnd,e)}function Xd(e){x.audio.masterNode.gain.value=e}function Fd(){return x.audio.masterNode.gain.value}function Cp(e){return xs("volume","setVolume / getVolume"),e!==void 0&&Xd(e),Fd()}function Yd(){x.app.onHide(()=>{x.globalOpt.backgroundAudio||x.audio.ctx.suspend()}),x.app.onShow(()=>{!x.globalOpt.backgroundAudio&&!x.debug.paused&&x.audio.ctx.resume()}),x.app.onResize(()=>{if(x.app.isFullscreen())return;let e=x.globalOpt.width&&x.globalOpt.height;e&&!x.globalOpt.stretch&&!x.globalOpt.letterbox||(x.canvas.width=x.canvas.offsetWidth*x.pixelDensity,x.canvas.height=x.canvas.offsetHeight*x.pixelDensity,rd(),e||(x.gfx.frameBuffer.free(),x.gfx.frameBuffer=new Xi(x.gfx.ggl,x.gfx.ggl.gl.drawingBufferWidth,x.gfx.ggl.gl.drawingBufferHeight),x.gfx.width=x.gfx.ggl.gl.drawingBufferWidth/x.pixelDensity/x.gscale,x.gfx.height=x.gfx.ggl.gl.drawingBufferHeight/x.pixelDensity/x.gscale))}),x.globalOpt.debug!==!1&&(x.app.onKeyPress(x.globalOpt.debugKey??"f1",()=>x.debug.inspect=!x.debug.inspect),x.app.onKeyPress("f2",()=>x.debug.clearLog()),x.app.onKeyPress("f8",()=>x.debug.paused=!x.debug.paused),x.app.onKeyPress("f7",()=>{x.debug.timeScale=Va(nn(x.debug.timeScale-.2,0,2),1)}),x.app.onKeyPress("f9",()=>{x.debug.timeScale=Va(nn(x.debug.timeScale+.2,0,2),1)}),x.app.onKeyPress("f10",()=>x.debug.stepFrame())),x.globalOpt.burp&&x.app.onKeyPress("b",()=>_d())}function Rp(e,t={}){let o=x.game.root.add([Yi(e),Wd()]),n=(t.speed||1)*5,s=t.scale||1;o.add([ka(x.boomSprite),qi(0),or("center"),Ic(n,s),...t.comps??[]]);let a=o.add([ka(x.kaSprite),qi(0),or("center"),er(),...t.comps??[]]);return a.wait(.4/n,()=>a.use(Ic(n,s))),a.onDestroy(()=>o.destroy()),o}function qd(e,t){if(x.game.layers)throw Error("Layers can only be assigned once.");let o=e.indexOf(t);if(o==-1)throw Error("The default layer name should be present in the layers list.");x.game.layers=e,x.game.defaultLayerIndex=o}function Ip(){return x.game.layers}function Pp(){return x.game.layers?.[x.game.defaultLayerIndex]??null}function Bp(e,t){xs("layers","setLayers"),qd(e,t)}function Gd(e){e.destroy()}function Lp(){return x.game.root}function zp(e,t){x.game.scenes[e]=t}function Op(e,...t){if(!x.game.scenes[e])throw new Error(`Scene not found: ${e}`);x.game.events.onOnce("frameEnd",()=>{x.game.events.trigger("sceneLeave",e),x.app.events.clear(),x.game.events.clear(),x.game.objEvents.clear(),[...x.game.root.children].forEach(o=>{!o.stay||o.scenesToStay&&!o.scenesToStay.includes(e)?x.game.root.remove(o):o.trigger("sceneEnter",e)}),x.game.root.clearEvents(),Yd(),x.game.cam={pos:null,scale:$(1),angle:0,shake:0,transform:new sn},x.game.scenes[e](...t)}),x.game.currentScene=e}function Hp(e){return x.game.events.on("sceneLeave",e)}function Up(){return x.game.currentScene}function ka(e,t={}){let o=null,n=null,s=null,a=new yo;if(!e)throw new Error("Please pass the resource name or data to sprite()");let r=(d,i,h,u)=>{let p=$(1,1);return h&&u?(p.x=h/(d.width*i.w),p.y=u/(d.height*i.h)):h?(p.x=h/(d.width*i.w),p.y=p.x):u&&(p.y=u/(d.height*i.h),p.x=p.y),p},l=(d,i)=>{if(!i)return;let h=i.frames[0].clone();t.quad&&(h=h.scale(t.quad));let u=r(i.tex,h,t.width,t.height);if(d.width=i.tex.width*h.w*u.x,d.height=i.tex.height*h.h*u.y,i.anims)for(let p in i.anims){let g=i.anims[p];typeof g!="number"&&(g.frames=c(g))}o=i,a.trigger(o),t.anim&&d.play(t.anim)},c=d=>{if(d.frames)return d.frames;let i=[];if(d.from===void 0||d.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let h=Math.abs(d.to-d.from)+1;for(let u=0;u<h;u++)i.push(d.from+u*Math.sign(d.to-d.from));if(d.pingpong)for(let u=h-2;u>0;u--)i.push(i[u]);return i};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new Jt(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(d){let i=Ri(d);i&&i.onLoad(h=>l(this,h))},get animFrame(){if(!o||!n||s===null)return this.frame;let d=o.anims[n.name];return typeof d=="number"?d:d.from===void 0||d.to===void 0?n.frameIndex:this.frame-Math.min(d.from,d.to)},draw(){if(!o)return;let d=o.frames[this.frame??0];if(!d)throw new Error(`Frame not found: ${this.frame??0}`);if(o.slice9){let{left:i,right:h,top:u,bottom:p}=o.slice9,g=o.tex.width*d.w,M=o.tex.height*d.h,m=this.width-i-h,T=this.height-u-p,P=i/g,f=h/g,N=1-P-f,O=u/M,w=p/M,A=1-O-w,S=[eo(0,0,P,O),eo(P,0,N,O),eo(P+N,0,f,O),eo(0,O,P,A),eo(P,O,N,A),eo(P+N,O,f,A),eo(0,O+A,P,w),eo(P,O+A,N,w),eo(P+N,O+A,f,w),eo(0,0,i,u),eo(i,0,m,u),eo(i+m,0,h,u),eo(0,u,i,T),eo(i,u,m,T),eo(i+m,u,h,T),eo(0,u+T,i,p),eo(i,u+T,m,p),eo(i+m,u+T,h,p)];for(let I=0;I<9;I++){let E=S[I],L=S[I+9];Fi(Object.assign(Wn(this),{pos:L.pos(),tex:o.tex,quad:d.scale(E),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:L.w,height:L.h}))}}else Fi(Object.assign(Wn(this),{tex:o.tex,quad:d.scale(this.quad??new Jt(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let d=Ri(e);d?d.onLoad(i=>l(this,i)):Lr(()=>l(this,Ri(e).data))},update(){if(!o||!n||s===null)return;let d=o.anims[n.name];if(typeof d=="number"){this.frame=d;return}if(d.speed===0)throw new Error("Sprite anim speed cannot be 0");if(n.timer+=io()*this.animSpeed,n.timer>=1/n.speed){n.timer=0,n.frameIndex+=s;let i=d.frames;if(n.frameIndex>=i.length)if(n.pingpong&&!d.pingpong)s=-1,n.frameIndex=i.length-2;else if(n.loop)n.frameIndex=0;else{this.frame=i.at(-1),n.onEnd(),this.stop();return}else if(n.frameIndex<0)if(n.pingpong&&n.loop)s=1,n.frameIndex=1;else if(n.loop)n.frameIndex=i.length-1;else{this.frame=i[0],n.onEnd(),this.stop();return}this.frame=i[n.frameIndex]}},play(d,i={}){if(!o){a.add(()=>this.play(d,i));return}let h=o.anims[d];if(h===void 0)throw new Error(`Anim not found: ${d}`);n&&this.stop(),n=typeof h=="number"?{name:d,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:d,timer:0,loop:i.loop??h.loop??!1,pingpong:i.pingpong??h.pingpong??!1,speed:i.speed??h.speed??10,frameIndex:0,onEnd:i.onEnd??(()=>{})},s=typeof h=="number"?null:1,this.frame=typeof h=="number"?h:h.frames[0],this.trigger("animStart",d)},stop(){if(!n)return;let d=n.name;n=null,this.trigger("animEnd",d)},numFrames(){return o?.frames.length??0},getCurAnim(){return n},curAnim(){return n?.name},getAnim(d){return o?.anims[d]??null},hasAnim(d){return!!this.getAnim(d)},onAnimEnd(d){return this.on("animEnd",d)},onAnimStart(d){return this.on("animStart",d)},renderArea(){return new Yt($(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function Np(e,t={}){function o(s){let a=Kn(Object.assign(Wn(s),{text:s.text+"",size:s.textSize,font:s.font,width:t.width&&s.width,align:s.align,letterSpacing:s.letterSpacing,lineSpacing:s.lineSpacing,transform:s.textTransform,styles:s.textStyles,indentAll:t.indentAll}));return t.width||(s.width=a.width/(s.scale?.x||1)),s.height=a.height/(s.scale?.y||1),a}let n={id:"text",set text(s){e=s,o(this),this.renderedText=ja(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?ja(e).text:"",add(){Lr(()=>o(this))},draw(){Vn(o(this))},renderArea(){return new Yt($(0),this.width,this.height)}};return o(n),n}function _p(e,t){return{id:"rect",width:e,height:t,draw(){ei(Object.assign(Wn(this),{width:this.width,height:this.height}))},renderArea(){return new Yt($(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function Xp(e={}){let t=null,o=null,n=null,s=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return o&&n?o[n]:null},getPath(){return o?o.slice():null},getTarget(){return t},isNavigationFinished(){return o?n===null:!0},isTargetReachable(){return o!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n=o?0:null,o&&n!==null?(s||(s=this.getLevel().onNavigationMapChanged(()=>{t&&o&&n!==null&&(o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o?(n=0,this.trigger("navigationNext",this,o[n])):(n=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>s?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,o[n])):this.trigger("navigationEnded",this)},update(){if(t&&o&&n!==null){if(this.pos.sdist(o[n])<2)if(n===o.length-1){this.pos=t.clone(),n=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else n++,this.trigger("navigationNext",this,o[n]);this.moveTo(o[n],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(o)})}}}function Fp(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(o){return this.graph?.getWaypointPath(this.pos,o,e.navigationOpt)},get graph(){if(t)return t;let o=this.parent;for(;o;){if(o.has("pathfinderMap"))return o.graph;o=o.parent}},set graph(o){t=o}}}function Yp(e={}){let t=e.waypoints,o=e.speed||100,n=e.endBehavior||"stop",s=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return o},set patrolSpeed(r){o=r},get waypoints(){return t},set waypoints(r){t=r,s=0,a=!1},get nextLocation(){return t?t[s]:void 0},update(){let r=this.nextLocation;if(!(!t||!r||a)&&(this.moveTo(r,o),this.pos.sdist(r)<9))switch(n){case"loop":s=(s+1)%t.length;break;case"ping-pong":s=s+1,s==t.length&&(t.reverse(),s=0);break;case"stop":s<t.length-1?s+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(r){return this.on("patrolFinished",r)}}}function qp(e,t={}){let o=typeof e=="function"?e:()=>x.game.root.query(e),n=t.checkFrequency||1,s=typeof t.direction=="number"?ne.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?ne.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(r){this.direction=r!==void 0?ne.fromAngle(r):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(r,l,c){let d=(typeof l=="number"?ne.fromAngle(l):l)||s,i=c||t.fieldOfView;if(!d||!i||i>=360)return!0;let h=i/2;return r.pos&&d.angleBetween(r.pos.sub(this.pos))<=h},hasLineOfSight(r){let l=Td(this.pos,r.pos.sub(this.pos),t.raycastExclude);return l!=null&&l.object===r},update(){if(a+=io(),a>n){a-=n;let r=o();if(r.length&&s&&this.fieldOfView&&this.fieldOfView<360){let l=this.fieldOfView/2;r=r.filter(c=>c.pos&&s.angleBetween(c.pos.sub(this.pos))<=l)}r.length&&t.lineOfSight&&(r=r.filter(l=>l.pos&&this.hasLineOfSight(l))),r.length>0&&(this.spotted=r,this.trigger("objectSpotted",r))}},onObjectsSpotted(r){return this.on("objectSpotted",r)}}}function Kd(e={}){let t=$(0),o=e.isObstacle??!1,n=e.cost??0,s=e.edges??[],a=()=>{let l={left:1,top:2,right:4,bottom:8};return s.map(c=>l[c]||0).reduce((c,d)=>c|d,0)},r=a();return{id:"tile",tilePosOffset:e.offset??$(0),set tilePos(l){let c=this.getLevel();t=l.clone(),this.pos=$(this.tilePos.x*c.tileWidth(),this.tilePos.y*c.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(l){o!==l&&(o=l,this.getLevel().invalidateNavigationMap())},get isObstacle(){return o},set cost(l){n!==l&&(n=l,this.getLevel().invalidateNavigationMap())},get cost(){return n},set edges(l){s=l,r=a(),this.getLevel().invalidateNavigationMap()},get edges(){return s},get edgeMask(){return r},getLevel(){return this.parent},tileMove(l){let c=this.getLevel();c.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(l),c.insertIntoSpatialMap(this),c.trigger("spatialMapChanged")},moveLeft(){this.tileMove($(-1,0))},moveRight(){this.tileMove($(1,0))},moveUp(){this.tileMove($(0,-1))},moveDown(){this.tileMove($(0,1))}}}var Or=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,o){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||Zs.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=o}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,o){let n=t-1,s=e/this.duration;if(this.loops!==0&&s>=this.loops)return[n,0,!0];let a=Math.trunc(s);if(s-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(s=1-s),o){let r=0;for(;o[r+1]!==void 0&&o[r+1]<s;)r++;return r>=n?[n,0,!0]:[r,(s-o[r])/(o[r+1]-o[r]),!1]}else{let r=Math.floor((t-1)*s);return[r,(s-r/n)*n,!1]}}setValue(e,t,o){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(o);break;case"angle":e.angle=e.base.angle+o;break;case"scale":e.scale=e.base.scale.scale(o);break;case"opacity":e.opacity=e.base.opacity*o;break;default:e[t]=o}else e[t]=o}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=Zs.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Rc(e,t){return t.add(t.sub(e))}var Gp=class extends Or{keys;constructor(e,t,o,n){super(e,o,n),this.keys=t}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;this.setValue(e,this.name,So(this.keys[o],this.keys[o+1],a(n)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},Kp=class extends Or{keys;curves;dcurves;constructor(e,t,o,n,s){if(super(e,o,n),this.keys=t,this.interpolation==="spline"){this.curves=[],s&&(this.dcurves=[]);for(let a=0;a<this.keys.length-1;a++){let r=this.keys[a],l=a+1,c=this.keys[l],d=a>0?this.keys[a-1]:Rc(c,r),i=l<this.keys.length-1?this.keys[l+1]:Rc(r,c);this.curves.push(Ui(d,r,c,i)),s&&this.dcurves?.push(Ui(d,r,c,i,Fu))}}}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[o].lerp(this.keys[o+1],a(n)));break;case"slerp":this.setValue(e,this.name,this.keys[o].slerp(this.keys[o+1],a(n)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[o](a(n))),this.dcurves&&this.setValue(e,"angle",this.dcurves[o](a(n)).angle());break}}}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},Vp=class extends Or{keys;constructor(e,t,o,n){super(e,o,n),this.keys=t}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;this.setValue(e,this.name,this.keys[o].lerp(this.keys[o+1],a(n)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function Wp(e={}){let t=[],o=0,n=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:$(0,0),angle:0,scale:$(1,1),opacity:1},animation:{paused:!1,seek(s){o=nn(s,0,this.duration),t.forEach(a=>{a.isFinished=!1}),n=!1},get duration(){return t.reduce((s,a)=>Math.max(a.duration,s),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let s=!0,a;o+=io();for(let r of t)a=r.update(this,o),a&&!r.isFinished&&(r.isFinished=!0,this.trigger("animateChannelFinished",r.name)),s&&=a;s&&!n&&(n=!0,this.trigger("animateFinished"))},animate(s,a,r){n=!1,this.unanimate(s),typeof a[0]=="number"?t.push(new Gp(s,a,r,e.relative||!1)):a[0]instanceof ne?t.push(new Kp(s,a,r,e.relative||!1,s==="pos"&&(e.followMotion||!1))):a[0]instanceof Et&&t.push(new Vp(s,a,r,e.relative||!1))},unanimate(s){let a=t.findIndex(r=>r.name===s);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(s){return this.on("animateFinished",s)},onAnimateChannelFinished(s){return this.on("animateChannelFinished",s)},serializeAnimationChannels(){return t.reduce((s,a)=>(s[a.name]=a.serialize(),s),{})},serializeAnimationOptions(){let s={};return e.followMotion&&(s.followMotion=!0),e.relative&&(s.relative=!0),s}}}function Vd(e,t){let o={name:e.name};return e.has("animate")&&(o.channels=e.serializeAnimationChannels(),Object.assign(o,e.serializeAnimationOptions())),e.children.length>0&&(o.children=e.children.filter(n=>n.has("named")).map(n=>Vd(n,n.name))),o}function Ic(e=2,t=1){let o=0;return{require:["scale"],update(){let n=Math.sin(o*e)*t;n<0&&this.destroy(),this.scale=$(n),o+=io()}}}function $p(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(o=1){this.setHP(e-o),this.trigger("hurt",o)},heal(o=1){let n=e;this.setHP(e+o),this.trigger("heal",e-n)},hp(){return e},maxHP(){return t??null},setMaxHP(o){t=o},setHP(o){e=t?Math.min(t,o):o,e<=0&&this.trigger("death")},onHurt(o){return this.on("hurt",o)},onHeal(o){return this.on("heal",o)},onDeath(o){return this.on("death",o)},inspect(){return`health: ${e}`}}}function Jp(e,t={}){if(e==null)throw new Error("lifespan() requires time");let o=t.fade??0;return{id:"lifespan",require:["opacity"],add(){x.game.root.wait(e,()=>{this.opacity=this.opacity??1,o>0?x.game.root.tween(this.opacity,0,o,n=>this.opacity=n,Zs.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function jp(e){return{id:"named",name:e}}function Zp(e,t,o){if(!e)throw new Error("state() requires an initial state");let n={};function s(c){n[c]||(n[c]={enter:new yo,end:new yo,update:new yo,draw:new yo})}function a(c,d,i){return s(d),n[d][c].add(i)}function r(c,d,...i){s(d),n[d][c].trigger(...i)}let l=!1;return{id:"state",state:e,enterState(c,...d){if(l=!0,t&&!t.includes(c))throw new Error(`State not found: ${c}`);let i=this.state;if(o){if(!o?.[i])return;let h=typeof o[i]=="string"?[o[i]]:o[i];if(!h.includes(c))throw new Error(`Cannot transition state from "${i}" to "${c}". Available transitions: ${h.map(u=>`"${u}"`).join(", ")}`)}r("end",i,...d),this.state=c,r("enter",c,...d),r("enter",`${i} -> ${c}`,...d)},onStateTransition(c,d,i){return a("enter",`${c} -> ${d}`,i)},onStateEnter(c,d){return a("enter",c,d)},onStateUpdate(c,d){return a("update",c,d)},onStateDraw(c,d){return a("draw",c,d)},onStateEnd(c,d){return a("end",c,d)},update(){l||(r("enter",e),l=!0),r("update",this.state)},draw(){r("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Wd(e){return{id:"stay",stay:!0,scenesToStay:e}}function Qp(e=!0,t){let o,n;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let s=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};o=x.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(x.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,s())}),n=x.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),s())})},destroy(){o.cancel(),n.cancel()}}}function er(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,o,n=1/0,s=!1){let a=s?0:t,r=new yo,l=this.onUpdate(()=>{a+=x.app.state.dt;for(let c=0;a>=t&&c<this.maxLoopsPerFrame;c++)if(n--,o(),a-=t,n<=0){l.cancel(),r.trigger();return}});return{get paused(){return l.paused},set paused(c){l.paused=c},cancel:l.cancel,onEnd(c){r.add(c)},then(c){return r.add(c),this}}},wait(t,o){return this.loop(t,o??(()=>{}),1,!0)},tween(t,o,n,s,a=Zs.linear){let r=0,l=[],c=this.onUpdate(()=>{r+=x.app.state.dt;let d=Math.min(r/n,1);s(So(t,o,a(d))),d===1&&(c.cancel(),s(o),l.forEach(i=>i()))});return{get paused(){return c.paused},set paused(d){c.paused=d},onEnd(d){l.push(d)},then(d){return this.onEnd(d),this},cancel(){c.cancel()},finish(){c.cancel(),s(o),l.forEach(d=>d())}}}}}var tr=0;function kp(){return tr>0}function eg(e={}){let t={},o=new Set,n=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){tr++,this.area.cursor&&n.push(this.onHover(()=>x.app.setCursor(this.area.cursor))),n.push(this.onCollideUpdate((s,a)=>{if(!s.id)throw new Error("area() requires the object to have an id");t[s.id]||this.trigger("collide",s,a),a&&(t[s.id]=a,o.add(s.id))}))},destroy(){tr--;for(let s of n)s.cancel()},fixedUpdate(){for(let s in t)o.has(Number(s))||(this.trigger("collideEnd",t[s].target),delete t[s]);o.clear()},drawInspect(){let s=this.localArea();Bo(),jt(this.area.offset);let a={outline:{width:4/cd(),color:Ht(0,0,255)},anchor:this.anchor,fill:!1,fixed:Xn(this)};s instanceof Yt?zo({...a,pos:s.pos,width:s.width*this.area.scale.x,height:s.height*this.area.scale.y}):s instanceof xo?Dn({...a,pts:s.pts,scale:this.area.scale}):s instanceof Do&&ws({...a,pos:s.center,radius:s.radius}),Eo()},area:{shape:e.shape??null,scale:e.scale?$(e.scale):$(1),offset:e.offset??$(0),cursor:e.cursor??null},isClicked(){return x.app.isMousePressed()&&this.isHovering()},isHovering(){let s=Xn(this)?x.k.mousePos():x.k.toWorld(x.k.mousePos());return this.hasPoint(s)},checkCollision(s){if(!s.id)throw new Error("checkCollision() requires the object to have an id");return t[s.id]??null},getCollisions(){return Object.values(t)},isColliding(s){if(!s.id)throw new Error("isColliding() requires the object to have an id");return!!t[s.id]},isOverlapping(s){if(!s.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[s.id];return a&&a.hasOverlap()},onClick(s,a="left"){let r=this.onMousePress(a,()=>{this.isHovering()&&s()});return n.push(r),r},onHover(s){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,s())})},onHoverUpdate(s){return this.onUpdate(()=>{this.isHovering()&&s()})},onHoverEnd(s){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,s()):a=this.isHovering()})},onCollide(s,a){if(typeof s=="function"&&a===void 0)return this.on("collide",s);if(typeof s=="string")return this.onCollide((r,l)=>{r.is(s)&&a?.(r,l)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(s,a){if(typeof s=="function"&&a===void 0)return this.on("collideUpdate",s);if(typeof s=="string")return this.on("collideUpdate",(r,l)=>r.is(s)&&a?.(r,l));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(s,a){if(typeof s=="function"&&a===void 0)return this.on("collideEnd",s);if(typeof s=="string")return this.on("collideEnd",r=>r.is(s)&&a?.(r));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(s){return In(this.worldArea(),s)},resolveCollision(s){let a=this.checkCollision(s);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let s=this.localArea();if(!(s instanceof xo||s instanceof Yt))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale($(this.area.scale??1));if(s instanceof Yt){let r=bs(this.anchor||ia).add(1,1).scale(-.5).scale(s.width,s.height);a.translate(r)}return s.transform(a)},screenArea(){let s=this.worldArea();return Xn(this)?s:s.transform(x.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function tg(e={}){let t=null,o=null,n=!1,s=$(0),a=null,r=null,l;return{id:"body",require:["pos"],vel:$(0),drag:e.drag??0,jumpForce:e.jumpForce??r0,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),r=this.pos.clone(),l=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((c,d)=>{if(!d||!c.has("body")||d.resolved)return;this.trigger("beforePhysicsResolve",d);let i=d.reverse();if(c.trigger("beforePhysicsResolve",i),!(d.resolved||i.resolved)&&!(this.isStatic&&c.isStatic)){if(!this.isStatic&&!c.isStatic){let h=this.mass+c.mass;this.pos=this.pos.add(d.displacement.scale(c.mass/h)),c.pos=c.pos.add(d.displacement.scale(-this.mass/h)),this.transform=Ks(this),c.transform=Ks(c)}else{let h=!this.isStatic&&c.isStatic?d:d.reverse();h.source.pos=h.source.pos.add(h.displacement),h.source.transform=Ks(h.source)}d.resolved=!0,this.trigger("physicsResolve",d),c.trigger("physicsResolve",d.reverse())}}),this.onPhysicsResolve(c=>{if(x.game.gravity)if(c.isBottom()&&this.isFalling()){this.vel=this.vel.reject(x.game.gravity.unit());let d=t;t=c.target,d!=t&&(o=c.target.pos),n?n=!1:d||(this.trigger("ground",t),c.target.trigger("land",this))}else c.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(x.game.gravity.unit()),this.trigger("headbutt",c.target),c.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(o&&!t.pos.eq(o)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(o)),o=t.pos);let c=$a();c&&(this.pos.x==l.x&&(this.pos.x=So(a.x,r.x,c/Wa()),l.x=this.pos.x),this.pos.y==l.y&&(this.pos.y=So(a.y,r.y,c/Wa()),l.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==l.x&&(this.pos.x=a.x),this.pos.y==l.y&&(this.pos.y=a.y),a=null),x.game.gravity&&!this.isStatic){n&&(t=null,o=null,this.trigger("fallOff"),n=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(n=!0);let c=this.vel.clone();this.vel=this.vel.add(x.game.gravity.scale(this.gravityScale*io()));let d=e.maxVelocity??c0;this.vel.slen()>d*d&&(this.vel=this.vel.unit().scale(d)),c.dot(x.game.gravity)<0&&this.vel.dot(x.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=s.x*io(),this.vel.y+=s.y*io(),this.vel.x*=1-this.drag*io(),this.vel.y*=1-this.drag*io(),this.move(this.vel),$a()){a=this.pos.clone();let c=this.vel.add(s.scale(io()));r=this.pos.add(c.scale(io())),l=this.pos.clone()}s.x=0,s.y=0},onPhysicsResolve(c){return this.on("physicsResolve",c)},onBeforePhysicsResolve(c){return this.on("beforePhysicsResolve",c)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(Ws())>0},isJumping(){return this.vel.dot(Ws())<0},applyImpulse(c){this.isStatic||(this.vel=this.vel.add(c))},addForce(c){this.isStatic||(s.x+=c.x/this.mass,s.y+=c.y/this.mass)},jump(c){this.isStatic||(t=null,o=null,this.vel=Ws().scale(-c||-this.jumpForce))},onGround(c){return this.on("ground",c)},onFall(c){return this.on("fall",c)},onFallOff(c){return this.on("fallOff",c)},onHeadbutt(c){return this.on("headbutt",c)},onLand(c){return this.on("land",c)},onHeadbutted(c){return this.on("headbutted",c)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function og(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(o){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(o))},onDoubleJump(o){return this.on("doubleJump",o)},inspect(){return`jumpsLeft: ${t}`}}}function ng(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,o)=>{let n=o?.normal.normal(),s=t.vel.project(n),a=n?.scale(this.speed)?.sub(s);t.addForce(a?.scale(t.mass*this.forceScale))})}}}function sg(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{if(!t.has("body"))return;let n=ne.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(n),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function ig(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{let n=this.pos.sub(t.pos),s=n.len(),a=s*this.distanceScale/10,r=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,l=n.scale(this.forceMagnitude*r/s);t.addForce(l),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function ag(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function rg(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let o=t.target.vel,n=Ws().scale(-1).angleBetween(o);Math.abs(n)>this.surfaceArc/2&&t.preventResolution()})}}}function cg(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,o)=>{let n=t,s=n.worldArea(),[a,r]=s.cut($(-100,this.surfaceLevel),$(100,this.surfaceLevel));a&&(this.applyBuoyancy(n,a),this.applyDrag(n,a)),this.flowMagnitude&&n.addForce(ne.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,o){let n=this.density*o.area(),s=$(0,1).scale(-n);t.addForce(s)},applyDrag(t,o){let n=t.vel,s=this.density*this.linearDrag,a=n.scale(-s);t.addForce(a)}}}function or(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function $d(){return{id:"fixed",fixed:!0}}function lg(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??$(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function dg(e){let t=x.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?x.game.layers?.[t]??null:null},set layer(o){if(t=x.game.layers?.indexOf(o),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function hg(e,t){let o=typeof e=="number"?ne.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(o.scale(t))}}}function ug(e={}){let t=!1,o=new Yt($(0),co(),uo()),n=new Yt($(0),0,0),s=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??yc,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(o.width=co(),o.height=uo(),!this.offscreenDistance&&this.width&&this.height)return n.width=this.width,n.height=this.height,n.pos=this.pos,n.collides(o);let r=this.offscreenDistance?this.offscreenDistance:yc;return!oa(o,a)&&o.sdistToPoint(a)>r*r},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?Cd(()=>s(this)):this.onUpdate(()=>s(this))}}}function Yi(...e){return{id:"pos",pos:$(...e),moveBy(...t){this.pos=this.pos.add($(...t))},move(...t){this.moveBy($(...t).scale(io()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo($(t[0],t[1]),t[2]);let o=t[0],n=t[1];if(n===void 0){this.pos=$(o);return}let s=o.sub(this.pos);if(s.len()<=n*io()){this.pos=$(o);return}this.move(s.unit().scale(n))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let o=this.worldPos();return o?Xn(this)?o:Qa(o):null}},toScreen(t){let o=this.toWorld(t);return Xn(this)?o:Qa(o)},fromScreen(t){return Xn(this)?this.fromWorld(t):this.fromWorld(Nd(t))},toOther(t,o){return t.fromWorld(this.toWorld(o))},fromOther(t,o){return t.toOther(this,o)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){ws({color:Ht(255,0,0),radius:4/cd()})}}}function fg(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function qi(...e){if(e.length===0)return qi(1);let t=$(...e);return{id:"scale",set scale(o){if(!(o instanceof ne))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=$(o)},get scale(){return t},scaleTo(...o){t=$(...o)},scaleBy(...o){t=t.scale($(...o))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function pg(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var gg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",mg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",yg=au.version,x={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},xg=(e={tagsAsComponents:!0})=>{x.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),x.k.quit()),x.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let o=e.canvas??t.appendChild(document.createElement("canvas"));x.canvas=o;let n=e.scale??1;x.gscale=n;let s=e.width&&e.height&&!e.stretch&&!e.letterbox;s?(o.width=e.width*n,o.height=e.height*n):(o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(s){let ee=o.width,we=o.height;a.push(`width: ${ee}px`),a.push(`height: ${we}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),o.style.cssText=a.join(";");let r=e.pixelDensity||1;x.pixelDensity=r,o.width*=r,o.height*=r,o.tabIndex=0;let l=document.createElement("canvas");l.width=256,l.height=256,x.fontCacheCanvas=l;let c=l.getContext("2d",{willReadFrequently:!0});x.fontCacheC2d=c;let d=U0({canvas:o,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});x.app=d;let i=[],h=d.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!h)throw new Error("WebGL not supported");let u=h,p=Pf(u,{texFilter:e.texFilter}),g=Nf(e,p);x.gfx=g;let M=Mp();x.audio=M;let m=hf(p,e.spriteAtlasPadding??0);x.assets=m;let T=wp();x.game=T,T.root.use(er());function P(ee,we){let ye=new Xi(p,ee,we);return{clear:()=>ye.clear(),free:()=>ye.free(),toDataURL:()=>ye.toDataURL(),toImageData:()=>ye.toImageData(),width:ye.width,height:ye.height,draw:Pe=>{Lo(),ye.bind(),Pe(),Lo(),ye.unbind()},get fb(){return ye}}}function f(){u.clear(u.COLOR_BUFFER_BIT),g.frameBuffer.bind(),u.clear(u.COLOR_BUFFER_BIT),g.bgColor||Sn(()=>{ei({width:co(),height:uo(),quad:new Jt(0,0,co()/64,uo()/64),tex:g.bgTex,fixed:!0})}),g.renderer.numDraws=0,g.fixed=!1,g.transformStack.length=0,g.transform=new sn}function N(ee,we){g.postShader=ee,g.postShaderUniform=we??null}function O(){Lo(),g.lastDrawCalls=g.renderer.numDraws,g.frameBuffer.unbind(),u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight);let ee=g.width,we=g.height;g.width=u.drawingBufferWidth/r,g.height=u.drawingBufferHeight/r,Fi({flipY:!0,tex:g.frameBuffer.tex,pos:new ne(g.viewport.x,g.viewport.y),width:g.viewport.width,height:g.viewport.height,shader:g.postShader,uniform:typeof g.postShaderUniform=="function"?g.postShaderUniform():g.postShaderUniform,fixed:!0}),Lo(),g.width=ee,g.height=we}let w=!1,A={inspect:!1,set timeScale(ee){x.app.state.timeScale=ee},get timeScale(){return x.app.state.timeScale},showLog:!0,fps:()=>d.fps(),numFrames:()=>d.numFrames(),stepFrame:ae,drawCalls:()=>g.lastDrawCalls,clearLog:()=>T.logs=[],log:(...ee)=>{let we=e.logMax??8,ye=ee.length>1?ee.concat(" ").join(" "):ee[0];T.logs.unshift({msg:ye,time:d.time()}),T.logs.length>we&&(T.logs=T.logs.slice(0,we))},error:ee=>A.log(new Error(ee.toString?ee.toString():ee)),curRecording:null,numObjects:()=>H("*",{recursive:!0}).length,get paused(){return w},set paused(ee){w=ee,ee?M.ctx.suspend():M.ctx.resume()}};x.debug=A;function S(ee,we){try{return JSON.parse(window.localStorage[ee])}catch{return we?(I(ee,we),we):null}}function I(ee,we){window.localStorage[ee]=JSON.stringify(we)}function E(ee,...we){let ye=ee(Me),Pe;typeof ye=="function"?Pe=ye(...we)(Me):Pe=ye;for(let qe in Pe)Me[qe]=Pe[qe],e.global!==!1&&(window[qe]=Pe[qe]);return Me}function L(ee){let we=d.canvas.captureStream(ee),ye=M.ctx.createMediaStreamDestination();M.masterNode.connect(ye);let Pe=new MediaRecorder(we),qe=[];return Pe.ondataavailable=Ce=>{Ce.data.size>0&&qe.push(Ce.data)},Pe.onerror=()=>{M.masterNode.disconnect(ye),we.getTracks().forEach(Ce=>Ce.stop())},Pe.start(),{resume(){Pe.resume()},pause(){Pe.pause()},stop(){return Pe.stop(),M.masterNode.disconnect(ye),we.getTracks().forEach(Ce=>Ce.stop()),new Promise(Ce=>{Pe.onstop=()=>{Ce(new Blob(qe,{type:"video/mp4"}))}})},download(Ce="kaboom.mp4"){this.stop().then(rt=>xc(Ce,rt))}}}function C(){return document.activeElement===d.canvas}let F=T.root.add.bind(T.root),U=T.root.readd.bind(T.root),_=T.root.removeAll.bind(T.root),H=T.root.get.bind(T.root),R=T.root.wait.bind(T.root),Y=T.root.loop.bind(T.root),V=T.root.query.bind(T.root),Q=T.root.tween.bind(T.root),fe=Vs(null,mg),se=Vs(null,gg);x.kaSprite=fe,x.boomSprite=se;function ie(){T.root.fixedUpdate()}function ae(){T.root.update()}class ge{source;target;normal;distance;resolved=!1;constructor(we,ye,Pe,qe,Ce=!1){this.source=we,this.target=ye,this.normal=Pe,this.distance=qe,this.resolved=Ce}get displacement(){return this.normal.scale(this.distance)}reverse(){return new ge(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(T.gravity||$(0,1))>0}isRight(){return this.displacement.cross(T.gravity||$(0,1))<0}isTop(){return this.displacement.dot(T.gravity||$(0,1))>0}isBottom(){return this.displacement.dot(T.gravity||$(0,1))<0}preventResolution(){this.resolved=!0}}function Se(){if(!kp())return;let ee={},we=e.hashGridSize||64,ye=new sn,Pe=[];function qe(Ce){if(Pe.push(ye.clone()),Ce.pos&&ye.translate(Ce.pos),Ce.scale&&ye.scale(Ce.scale),Ce.angle&&ye.rotate(Ce.angle),Ce.transform=ye.clone(),Ce.c("area")&&!Ce.paused){let rt=Ce,Je=rt.worldArea().bbox(),it=Math.floor(Je.pos.x/we),gt=Math.floor(Je.pos.y/we),Te=Math.ceil((Je.pos.x+Je.width)/we),Fe=Math.ceil((Je.pos.y+Je.height)/we),Be=new Set;for(let Re=it;Re<=Te;Re++)for(let Ke=gt;Ke<=Fe;Ke++)if(!ee[Re])ee[Re]={},ee[Re][Ke]=[rt];else if(!ee[Re][Ke])ee[Re][Ke]=[rt];else{let dt=ee[Re][Ke];e:for(let ft of dt){if(ft.paused||!ft.exists()||Be.has(ft.id))continue;for(let ut of rt.collisionIgnore)if(ft.is(ut))continue e;for(let ut of ft.collisionIgnore)if(rt.is(ut))continue e;let ht=Wu(rt.worldArea(),ft.worldArea());if(ht){let ut=new ge(rt,ft,ht.normal,ht.distance);rt.trigger("collideUpdate",ft,ut);let At=ut.reverse();At.resolved=ut.resolved,ft.trigger("collideUpdate",rt,At)}Be.add(ft.id)}dt.push(rt)}}Ce.children.forEach(qe),ye=Pe.pop()}qe(T.root)}function Ie(ee){console.error(ee),M.ctx.suspend();let we=ee.message??String(ee)??"Unknown error, check console for more info";d.run(()=>{},()=>{f(),Sn(()=>{let ye=co(),Pe=uo(),qe={size:36,width:ye-64,letterSpacing:4,lineSpacing:4,font:Ni,fixed:!0};zo({width:ye,height:Pe,color:Ht(0,0,255),fixed:!0});let Ce=Kn({...qe,text:"Error",pos:$(32),color:Ht(255,128,0),fixed:!0});Vn(Ce),Cc({...qe,text:we,pos:$(32,32+Ce.height+16),fixed:!0}),Eo(),T.events.trigger("error",ee)}),O()})}function ve(ee){i.push(ee)}function _e(){T.events.onOnce("frameEnd",()=>{d.quit(),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);let ee=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(let we=0;we<ee;we++)u.activeTexture(u.TEXTURE0+we),u.bindTexture(u.TEXTURE_2D,null),u.bindTexture(u.TEXTURE_CUBE_MAP,null);u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),p.destroy(),i.forEach(we=>we())})}let nt=!0;d.run(()=>{try{m.loaded&&(A.paused||ie(),Se())}catch(ee){Ie(ee)}},(ee,we)=>{try{ee(),m.loaded||Gn()===1&&!nt&&(m.loaded=!0,dd().forEach(ye=>T.events.trigger("loadError",...ye)),T.events.trigger("load")),!m.loaded&&e.loadingScreen!==!1||nt?(f(),zf(),O()):(A.paused||ae(),Se(),f(),Lf(),e.debug!==!1&&Bf(),O()),nt&&(nt=!1),T.events.trigger("frameEnd"),we()}catch(ye){Ie(ye)}}),rd(),Yd();let Me={_k:x,VERSION:yg,loadRoot:cf,loadProgress:Gn,loadSprite:Vs,loadSpriteAtlas:xd,loadSound:Sf,loadMusic:Mf,loadBitmapFont:yf,loadFont:gf,loadShader:vf,loadShaderURL:Ef,loadAseprite:pf,loadPedit:xf,loadBean:ff,loadJSON:lf,load:Ja,getSound:yd,getFont:pd,getBitmapFont:gd,getSprite:hd,getShader:md,getAsset:df,Asset:Uo,SpriteData:Pn,SoundData:ks,width:co,height:uo,center:_i,dt:io,fixedDt:Wa,restDt:$a,time:d.time,screenshot:d.screenshot,record:L,isFocused:C,setCursor:d.setCursor,getCursor:d.getCursor,setCursorLocked:d.setCursorLocked,isCursorLocked:d.isCursorLocked,setFullscreen:d.setFullscreen,isFullscreen:d.isFullscreen,isTouchscreen:d.isTouchscreen,onLoad:Lr,onLoadError:up,onLoading:lp,onResize:dp,onGamepadConnect:d.onGamepadConnect,onGamepadDisconnect:d.onGamepadDisconnect,onError:hp,onCleanup:ve,flash:Ud,setCamPos:Pd,getCamPos:Bd,setCamRot:Od,getCamRot:Hd,setCamScale:Ld,getCamScale:zd,getCamTransform:fp,camPos:mp,camScale:yp,camFlash:bp,camRot:xp,camTransform:pp,shake:gp,toScreen:Qa,toWorld:Nd,setGravity:vp,getGravity:Ep,setGravityDirection:Ap,getGravityDirection:Ws,setBackground:tf,getBackground:of,getGamepads:d.getGamepads,getTreeRoot:Lp,add:F,make:zr,destroy:Gd,destroyAll:_,get:H,query:V,readd:U,pos:Yi,scale:qi,rotate:fg,color:Sd,opacity:Md,anchor:or,area:eg,sprite:ka,text:Np,polygon:Vf,rect:Dd,circle:_f,uvquad:_p,outline:qf,particles:Kf,body:tg,platformEffector:rg,surfaceEffector:ng,areaEffector:sg,pointEffector:ig,buoyancyEffector:cg,constantForce:ag,doubleJump:og,shader:Wf,textInput:Qp,timer:er,fixed:$d,stay:Wd,health:$p,lifespan:Jp,named:jp,state:Zp,z:pg,layer:dg,move:hg,offscreen:ug,follow:lg,fadeIn:Ff,mask:Yf,drawon:Xf,raycast:Td,tile:Kd,animate:Wp,serializeAnimation:Vd,agent:Xp,sentry:qp,patrol:Yp,pathfinder:Fp,trigger:Jf,on:Ro,onFixedUpdate:jf,onUpdate:Cd,onDraw:Zf,onAdd:Rd,onDestroy:Qf,onTag:Id,onUntag:tp,onUse:kf,onUnuse:ep,onClick:ip,onCollide:op,onCollideUpdate:np,onCollideEnd:sp,onHover:ap,onHoverUpdate:rp,onHoverEnd:cp,onKeyDown:d.onKeyDown,onKeyPress:d.onKeyPress,onKeyPressRepeat:d.onKeyPressRepeat,onKeyRelease:d.onKeyRelease,onMouseDown:d.onMouseDown,onMousePress:d.onMousePress,onMouseRelease:d.onMouseRelease,onMouseMove:d.onMouseMove,onCharInput:d.onCharInput,onTouchStart:d.onTouchStart,onTouchMove:d.onTouchMove,onTouchEnd:d.onTouchEnd,onScroll:d.onScroll,onHide:d.onHide,onShow:d.onShow,onGamepadButtonDown:d.onGamepadButtonDown,onGamepadButtonPress:d.onGamepadButtonPress,onGamepadButtonRelease:d.onGamepadButtonRelease,onGamepadStick:d.onGamepadStick,onButtonPress:d.onButtonPress,onButtonDown:d.onButtonDown,onButtonRelease:d.onButtonRelease,mousePos:d.mousePos,mouseDeltaPos:d.mouseDeltaPos,isKeyDown:d.isKeyDown,isKeyPressed:d.isKeyPressed,isKeyPressedRepeat:d.isKeyPressedRepeat,isKeyReleased:d.isKeyReleased,isMouseDown:d.isMouseDown,isMousePressed:d.isMousePressed,isMouseReleased:d.isMouseReleased,isMouseMoved:d.isMouseMoved,isGamepadButtonPressed:d.isGamepadButtonPressed,isGamepadButtonDown:d.isGamepadButtonDown,isGamepadButtonReleased:d.isGamepadButtonReleased,getGamepadStick:d.getGamepadStick,isButtonPressed:d.isButtonPressed,isButtonDown:d.isButtonDown,isButtonReleased:d.isButtonReleased,setButton:d.setButton,getButton:d.getButton,pressButton:d.pressButton,releaseButton:d.releaseButton,getLastInputDeviceType:d.getLastInputDeviceType,charInputted:d.charInputted,loop:Y,wait:R,play:Dp,setVolume:Xd,getVolume:Fd,volume:Cp,burp:_d,audioCtx:M.ctx,Line:Co,Rect:Yt,Circle:Do,Ellipse:gn,Point:Ru,Polygon:xo,Vec2:ne,Color:Et,Mat4:sn,Quad:Jt,RNG:Ul,rand:so,randi:Nl,randSeed:hu,vec2:$,rgb:Ht,hsl2rgb:ru,quad:eo,choose:pu,chooseMultiple:fu,shuffle:_l,chance:uu,lerp:So,tween:Q,easings:Zs,map:en,mapc:cu,wave:Hl,deg2rad:to,rad2deg:qn,clamp:nn,evaluateQuadratic:Pu,evaluateQuadraticFirstDerivative:Bu,evaluateQuadraticSecondDerivative:Lu,evaluateBezier:Mr,evaluateBezierFirstDerivative:zu,evaluateBezierSecondDerivative:Ou,evaluateCatmullRom:Hu,evaluateCatmullRomFirstDerivative:Uu,curveLengthApproximation:Jl,normalizedCurve:Nu,hermite:ai,cardinal:jl,catmullRom:Ui,bezier:_u,kochanekBartels:Xu,easingSteps:Vu,easingLinear:Gu,easingCubicBezier:Ku,testLineLine:br,testRectRect:Xl,testRectLine:wr,testRectPoint:oa,testCirclePolygon:sa,testLinePoint:vr,testLineCircle:ii,isConvex:Qu,triangulate:Ql,NavMesh:k0,drawSprite:Hf,drawText:Cc,formatText:Kn,drawRect:zo,drawLine:_s,drawLines:Br,drawTriangle:Ed,drawCircle:ws,drawEllipse:bd,drawUVQuad:ei,drawPolygon:Dn,drawCurve:wd,drawBezier:Rf,drawFormattedText:Vn,drawMasked:Of,drawSubtracted:Uf,pushTransform:Bo,popTransform:Eo,pushTranslate:jt,pushScale:Qs,pushRotate:hs,pushMatrix:nf,usePostEffect:N,makeCanvas:P,debug:A,scene:zp,getSceneName:Up,go:Op,onSceneLeave:Hp,layers:Bp,getLayers:Ip,setLayers:qd,getDefaultLayer:Pp,addLevel:$f,getData:S,setData:I,download:Dr,downloadJSON:p0,downloadText:id,downloadBlob:xc,plug:E,ASCII_CHARS:kl,canvas:d.canvas,addKaboom:Rp,LEFT:ne.LEFT,RIGHT:ne.RIGHT,UP:ne.UP,DOWN:ne.DOWN,RED:Et.RED,GREEN:Et.GREEN,BLUE:Et.BLUE,YELLOW:Et.YELLOW,MAGENTA:Et.MAGENTA,CYAN:Et.CYAN,WHITE:Et.WHITE,BLACK:Et.BLACK,quit:_e,KEvent:yo,KEventHandler:js,KEventController:Qn,cancel:()=>td};x.k=Me;let Tt=e.plugins;if(Tt&&Tt.forEach(E),e.global!==!1)for(let ee in Me)window[ee]=Me[ee];return e.focus!==!1&&d.canvas.focus(),Me},bg=xg;const Pc=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Royal","Noble","Rogue","Savage","Reigning","Rising","Rookie","Veteran","Seasoned","Underdog","Favored","Viral","Trending","Famous","Infamous","Ultimate","Supreme","Grand","Major","Premier","Star","Main","Top","Peak","Apex","Brutal","Ruthless","Vicious","Crushing","Raging","Furious","Frenzied","Berserk","Mad","Crazy","Lethal","Deadly","Fatal","Killer","Murder","Immortal","Eternal","Heavy","Hard","Tough","Gritty","Scrappy","Mean","Nasty","Dirty","Raw","Primal","Amazing","Awesome","Dazzling","Stunning","Shocking","Dynamic","Radical","Extreme","Intense","Hyper","Ultra","Mega","Super","Power","Atomic","Nuclear","Chaos","Havoc","Mayhem","Rampage","Carnage","Cocky","Sneaky","Tricky","Sly","Cunning","Wicked","Evil","Sinister","Twisted","Crooked","Lucky","Unlucky","Cursed","Blessed","Chosen","Lone","Solo","Outlaw","Rebel","Bandit"],Bc=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter","Finalist","Victor","Winner","Champ","Hopeful","Prospect","Wildcard","Underdog","Favorite","Prodigy","Rookie","Veteran","Pro","Amateur","Phenom","Showman","Icon","Brawler","Bruiser","Slugger","Puncher","Boxer","Fighter","Scrapper","Battler","Duelist","Crusher","Smasher","Basher","Masher","Thrasher","Pummeler","Pounder","Hammer","Mauler","Mangler","Knockout","Haymaker","Uppercut","Jab","Hook","Spartan","Viking","Wrecking","Rampage","Havoc","Mayhem","Chaos","Carnage","Fury","Menace","Terror","Horror","Dread","Fist","Knuckle","Claw","Talon","Spike","Axe","Hammer","Mace","Flail","Club","Cannon","Mortar","Missile","Bomb","Grenade","Shiv","Machete","Cleaver","Hatchet","Gorilla","Rhino","Bull","Boar","Pitbull","Doberman","Mastiff","Bulldog","Scorpion","Mantis","Hornet","Wasp","Spider","Croc","Gator","Piranha","Orca","Hyena","Jackal","Badger","Warthog","Mongoose","Outlaw","Bandit","Thug","Goon","Hooligan","Punk","Rebel","Maverick","Renegade","Assassin","Bounty","Hitman","Enforcer","Boss","Kingpin","Warlord","Overlord","Tyrant"];function nr(){const e=Pc[Math.floor(Math.random()*Pc.length)],t=Bc[Math.floor(Math.random()*Bc.length)];return`${e}${t}`}function sr(){return Math.floor(1e5+Math.random()*9e5).toString()}function wg(e){return/^\d{6}$/.test(e)}const an={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:2},hint:"Progress further into the facility"},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:3},hint:"Keep pushing deeper"},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:5},hint:"The halfway point awaits",unlocks:["trailIce"]},floor10:{id:"floor10",name:"Double Digits",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:10},unlocks:["plasmaRifle"]},firstSynergy:{id:"firstSynergy",name:"Combo Starter",description:"Activate your first synergy",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect upgrades that work together",unlocks:["trailShadow"]},allCharacters:{id:"allCharacters",name:"Full Roster",description:"Unlock all characters",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Progress through floors to unlock characters"},maxUpgrade:{id:"maxUpgrade",name:"Maxed Out",description:"Max out a permanent upgrade",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Purchase the same upgrade multiple times"},firstDoor:{id:"firstDoor",name:"Door Explorer",description:"Enter a special door",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Find and enter a special door in a room"},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1},hint:"Defeat any enemy"},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:100},hint:"Keep fighting!",unlocks:["trailFire"]},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:500},hint:"The carnage continues",unlocks:["trailPoison"]},kill1000:{id:"kill1000",name:"Rampage",description:"Kill 1000 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1e3},hint:"A true warrior emerges"},killStreak10:{id:"killStreak10",name:"On Fire",description:"Kill 10 enemies in 5 seconds",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Defeat enemies rapidly",unlocks:["deathVaporize"]},multikill:{id:"multikill",name:"Multi-Kill",description:"Kill 5 enemies with one attack",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Use piercing or explosive attacks",unlocks:["deathPixelate"]},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:1},hint:"Clear Floor 1 to face a boss",unlocks:["deathExplosion"]},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:5},hint:"Keep defeating floor bosses",unlocks:["deathDisintegrate"]},boss10:{id:"boss10",name:"Boss Veteran",description:"Defeat 10 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:10},hint:"Experience makes perfect"},boss25:{id:"boss25",name:"Boss Crusher",description:"Defeat 25 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:25},unlocks:["railgun"],hint:"Become a boss-hunting expert"},boss50:{id:"boss50",name:"Boss Destroyer",description:"Defeat 50 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:50},hint:"The ultimate boss hunter"},minibossSlayer:{id:"minibossSlayer",name:"Miniboss Hunter",description:"Defeat 10 minibosses",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalMinibossesKilled",value:10},hint:"Minibosses appear in later rooms"},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:1},hint:"Play until you die (or win!)"},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:10},hint:"Practice makes progress"},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:50},hint:"A true fan of the show"},run100:{id:"run100",name:"Century",description:"Complete 100 runs",category:"run",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRuns",value:100},hint:"The ultimate dedication"},quickDeath:{id:"quickDeath",name:"Speedrun Fail",description:"Die within 30 seconds",category:"run",icon:"",unlocked:!1,difficulty:"normal",hint:"Sometimes things go wrong fast"},longRun:{id:"longRun",name:"Marathon",description:"Survive for 30 minutes",category:"run",icon:"",unlocked:!1,difficulty:"challenge",hint:"Keep surviving as long as possible"},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:10},hint:"Collect XP and level up"},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:20},hint:"Keep grinding for XP"},level30:{id:"level30",name:"Powerhouse",description:"Reach level 30 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:30},hint:"Build becomes unstoppable"},level50:{id:"level50",name:"Unstoppable",description:"Reach level 50 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:50},hint:"Ultimate power achieved"},upgradeCollector:{id:"upgradeCollector",name:"Collector",description:"Have 15 upgrades at once",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect many different upgrades"},synergyMaster:{id:"synergyMaster",name:"Synergy Master",description:"Activate 3 synergies in one run",category:"upgrade",icon:"",unlocked:!1,difficulty:"challenge",hint:"Build for multiple synergy combos",unlocks:["trailRainbow"]},earn100:{id:"earn100",name:"Pocket Change",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:100},hint:"Play runs to earn credits"},earn500:{id:"earn500",name:"Savings Account",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:500},hint:"Keep earning and saving",unlocks:["glowGold"]},earn1000:{id:"earn1000",name:"Money Bags",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:1e3},hint:"A fortune awaits"},earn5000:{id:"earn5000",name:"Fortune",description:"Earn 5000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:5e3},hint:"Building an empire"},earn10000:{id:"earn10000",name:"Tycoon",description:"Earn 10000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:1e4},hint:"The ultimate collector"},bigSpender:{id:"bigSpender",name:"Big Spender",description:"Spend 1000 credits in the shop",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencySpent",value:1e3},hint:"Buy upgrades from the shop"},perfectFloor:{id:"perfectFloor",name:"Untouchable",description:"Clear a floor without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Dodge everything on an entire floor",unlocks:["glowVoid"]},speedRunner:{id:"speedRunner",name:"Speed Demon",description:"Clear Floor 3 in under 5 minutes",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Rush through the first 3 floors",unlocks:["glowElectric"]},bossRush:{id:"bossRush",name:"Boss Rush",description:"Defeat 3 bosses in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Reach and defeat multiple floor bosses"},noHitBoss:{id:"noHitBoss",name:"Flawless Victory",description:"Defeat a boss without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Perfect boss fight execution"},glassCannonWin:{id:"glassCannonWin",name:"Living Dangerously",description:"Defeat a boss while below 25% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Living dangerously pays off"},closeCall:{id:"closeCall",name:"Close Call",description:"Survive with 1 HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Get very close to death but survive",unlocks:["glowCrimson"]},pacifist:{id:"pacifist",name:"Pacifist Start",description:"Clear Room 1 without attacking",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Just dodge everything"},noDamageRoom:{id:"noDamageRoom",name:"Perfect Room",description:"Clear 5 rooms without damage in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Master your dodging skills"},kill5000:{id:"kill5000",name:"Exterminator",description:"Kill 5,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:5e3},hint:"A lifetime of combat"},kill10000:{id:"kill10000",name:"Annihilator",description:"Kill 10,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:1e4},hint:"The ultimate destroyer"},floor15:{id:"floor15",name:"Deep Delver",description:"Reach Floor 15",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:15},hint:"Go deeper than ever before"},floor20:{id:"floor20",name:"Abyssal",description:"Reach Floor 20",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:20},hint:"The final frontier"},rooms100:{id:"rooms100",name:"Room Master",description:"Clear 100 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRoomsCleared",value:100},hint:"Clear many rooms across all runs"},rooms500:{id:"rooms500",name:"Hall Walker",description:"Clear 500 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRoomsCleared",value:500},hint:"Keep exploring"},firstPickup:{id:"firstPickup",name:"Loot Goblin",description:"Collect your first pickup",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Pick up health, XP, or other items"},healingAddict:{id:"healingAddict",name:"Healing Addict",description:"Collect 50 health pickups",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalHealthPickups",value:50},hint:"Stay alive by healing"},xpHoarder:{id:"xpHoarder",name:"XP Hoarder",description:"Collect 1000 XP orbs",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalXpOrbs",value:1e3},hint:"Collect all those green orbs"},comeback:{id:"comeback",name:"Comeback King",description:"Win a room after being below 10% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Never give up!"}},Oo={normal:[200,200,200],challenge:[255,200,100],benchmark:[200,150,255]},Lc={normal:25,challenge:50,benchmark:100};function Jd(e){return!e||e.unlocks&&e.unlocks.length>0?0:e.reward!==void 0?e.reward:Lc[e.difficulty]||Lc.normal}function vg(e){return Object.values(an).filter(t=>t.category===e)}function Eg(){const e=new Set;return Object.values(an).forEach(t=>e.add(t.category)),Array.from(e)}function jd(e){return an[e]||null}function Gi(e,t){const o=an[e];if(!o||!o.threshold)return null;const n=t[o.threshold.stat]||0,s=o.threshold.value,a=Math.min(n/s,1);return{current:n,target:s,progress:a,percentage:Math.round(a*100)}}const $t={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"},bomber:{name:"The Bomber",description:"Explosive specialist, +50% blast radius, projectiles explode on hit",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"boss10"},char:"",color:[255,100,100],stats:{health:85,speed:130,damage:15},weapon:"launcher",ability:"explosiveShots"},engineer:{name:"The Engineer",description:"Support class, +2 orbital drones that auto-attack nearby enemies",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"level20"},char:"",color:[100,200,255],stats:{health:80,speed:140,damage:8},weapon:"pistol",ability:"orbitalDrones"},vampire:{name:"The Vampire",description:"Lifesteal specialist, +15% lifesteal, -20% max health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"kill1000"},char:"",color:[180,50,180],stats:{health:70,speed:160,damage:14},weapon:"smg",ability:"vampiric"},berserker:{name:"The Berserker",description:"Rage mode, +100% damage below 30% HP, takes +25% more damage",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"glassCannonWin"},char:"",color:[255,50,50],stats:{health:120,speed:140,damage:18},weapon:"shotgun",ability:"rage"},ghost:{name:"The Ghost",description:"Evasion master, +25% dodge chance, +15% crit, lower health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"perfectFloor"},char:"",color:[200,200,255],stats:{health:60,speed:180,damage:11},weapon:"smg",ability:"ethereal"}},Zd={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0},spreadShot:{name:"Spread Shot",description:"Fires 3 projectiles in a cone, lower damage each",cost:250,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2}},boomerang:{name:"Boomerang Blaster",description:"Projectiles return, hitting enemies twice",cost:400,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},chainLightning:{name:"Chain Lightning",description:"Bounces to 3 nearby enemies, -20% per bounce",cost:500,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},railgun:{name:"Railgun",description:"Pierces ALL enemies in a line, 3s cooldown",cost:600,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4},requiredAchievement:"boss25"},homingMissiles:{name:"Homing Missiles",description:"Slower projectiles that track enemies",cost:700,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4}},plasmaRifle:{name:"Plasma Rifle",description:"High damage, penetrates 2 enemies",cost:800,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:5},requiredAchievement:"floor10"}},ls={trailNone:{name:"No Trail",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"trail"},trailFire:{name:"Fire Trail",description:"Leave a blazing trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[255,100,50],requiredAchievement:"kill100"},trailIce:{name:"Ice Trail",description:"Leave a frosty trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,200,255],requiredAchievement:"floor5"},trailPoison:{name:"Toxic Trail",description:"Leave a poisonous trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,255,100],requiredAchievement:"kill500"},trailShadow:{name:"Shadow Trail",description:"Leave a dark trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[80,50,120],requiredAchievement:"firstSynergy"},trailRainbow:{name:"Rainbow Trail",description:"Leave a colorful trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:"rainbow",requiredAchievement:"synergyMaster"},deathNone:{name:"Standard Death",description:"Default enemy death effect",cost:0,unlockedByDefault:!0,category:"death"},deathExplosion:{name:"Explosive Death",description:"Enemies explode dramatically",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"firstBoss"},deathDisintegrate:{name:"Disintegration",description:"Enemies crumble into particles",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"boss5"},deathVaporize:{name:"Vaporize",description:"Enemies vanish in a puff of smoke",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"killStreak10"},deathPixelate:{name:"Pixelate",description:"Enemies break into pixels",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"multikill"},deathFireworks:{name:"Fireworks",description:"Enemies burst like fireworks",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"floor10"},glowNone:{name:"No Glow",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"glow"},glowGold:{name:"Golden Aura",description:"Radiate a golden glow",cost:0,unlockedByDefault:!1,category:"glow",color:[255,200,50],requiredAchievement:"earn500"},glowCrimson:{name:"Crimson Aura",description:"Radiate a blood-red glow",cost:0,unlockedByDefault:!1,category:"glow",color:[200,50,50],requiredAchievement:"closeCall"},glowElectric:{name:"Electric Aura",description:"Crackle with electricity",cost:0,unlockedByDefault:!1,category:"glow",color:[100,150,255],requiredAchievement:"speedRunner"},glowVoid:{name:"Void Aura",description:"Emanate dark energy",cost:0,unlockedByDefault:!1,category:"glow",color:[50,0,80],requiredAchievement:"perfectFloor"}},Qd={healthPack:{name:"Health Pack",description:"Start next run with +30 bonus HP",cost:30,consumable:!0,effect:{type:"startingHealth",value:30}},damageAmp:{name:"Damage Amp",description:"+25% damage for first floor",cost:35,consumable:!0,effect:{type:"tempDamage",value:.25,duration:"floor"}},speedSerum:{name:"Speed Serum",description:"+30% speed for first floor",cost:25,consumable:!0,effect:{type:"tempSpeed",value:.3,duration:"floor"}},wealthCharm:{name:"Wealth Charm",description:"+30% credits earned this run",cost:50,consumable:!0,effect:{type:"creditMultiplier",value:.3,duration:"run"}},luckyCoin:{name:"Lucky Coin",description:"+15% crit chance for first floor",cost:40,consumable:!0,effect:{type:"tempCrit",value:.15,duration:"floor"}},armorPlating:{name:"Armor Plating",description:"+20% damage reduction for first floor",cost:45,consumable:!0,effect:{type:"tempDefense",value:.2,duration:"floor"}},xpBooster:{name:"XP Booster",description:"+50% XP gained for first floor",cost:40,consumable:!0,effect:{type:"tempXP",value:.5,duration:"floor"}},emergencyRevive:{name:"Emergency Revive",description:"Auto-revive once at 25% HP",cost:75,consumable:!0,effect:{type:"autoRevive",value:.25,uses:1}}},Ag={startingHealth:{name:"Starting Health +10",description:"Start the show with +10 max health",cost:50,maxLevel:5,tier:1},startingDamage:{name:"Starting Damage +1",description:"Start the show with +1 damage",cost:75,maxLevel:5,tier:1},startingSpeed:{name:"Starting Speed +10",description:"Start the show with +10 speed",cost:60,maxLevel:5,tier:1},xpMagnet:{name:"XP Magnet",description:"+15% XP pickup radius per level",cost:60,maxLevel:5,tier:2},propDurability:{name:"Prop Durability",description:"Props last +2 seconds per level",cost:80,maxLevel:5,tier:2},propDropChance:{name:"Prop Drop Chance",description:"+5% prop drop chance per level",cost:100,maxLevel:5,tier:2},creditBonus:{name:"Credit Bonus",description:"+8% credits earned per level",cost:120,maxLevel:5,tier:2},luckyStart:{name:"Lucky Start",description:"+5% starting crit chance per level",cost:100,maxLevel:4,tier:3},thickSkin:{name:"Thick Skin",description:"+3% damage reduction per level",cost:100,maxLevel:5,tier:3},secondWind:{name:"Second Wind",description:"+5% revive health per level (up to 25%)",cost:150,maxLevel:4,tier:3},bossBounty:{name:"Boss Bounty",description:"+15 bonus credits per boss kill",cost:150,maxLevel:3,tier:3},mulligan:{name:"Mulligan",description:"+1 reroll per run for upgrade drafts",cost:300,maxLevel:3,tier:4},comfortZone:{name:"Comfort Zone",description:"+0.1s invulnerability after hit",cost:200,maxLevel:3,tier:4},toughChoices:{name:"Tough Choices",description:"+1 upgrade option in drafts (4 total)",cost:500,maxLevel:1,tier:4},headStart:{name:"Head Start",description:"Begin each run at level 2",cost:750,maxLevel:1,tier:4}};function Sg(e){switch(e){case"characters":return $t;case"weapons":return Zd;case"permanentUpgrades":return Ag;case"cosmetics":return ls;case"boosters":return Qd;default:return{}}}const kd="superSmashTexty_save",Mg="$",ir={version:1,currency:0,playerName:null,inviteCode:null,totalXP:0,playerLevel:1,selectedPortrait:"default",unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[],portraits:["default"]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0,totalPlayTime:0,fastestRunTime:0},achievements:[],runHistory:[]},zc=20;function yt(){try{const t=localStorage.getItem(kd);if(t){const o=JSON.parse(t),n={...ir,...o};return n.playerName||(n.playerName=nr(),Qt(n)),n.inviteCode||(n.inviteCode=sr(),Qt(n)),n}}catch(t){console.error("Error loading save:",t)}const e={...ir};return e.playerName=nr(),e.inviteCode=sr(),Qt(e),e}function Qt(e){try{return localStorage.setItem(kd,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function Tg(){return yt()}function ds(e){const t=yt();return t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+e),Qt(t),t.currency}function $n(){return yt().currency}function Yo(e,t){const o=yt();return o.unlocks[e]&&o.unlocks[e].includes(t)}function eh(e,t){const o=yt();return o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)?!1:(o.unlocks[e].push(t),Qt(o),!0)}function Oc(e){yt();let t=!1;for(const[o,n]of Object.entries($t))n.unlockRequirement&&n.unlockRequirement.type==="floor"&&e>=n.unlockRequirement.value&&(Yo("characters",o)||(eh("characters",o),t=!0));return t}function Dg(e){let t=[];for(const[o,n]of Object.entries($t))n.unlockRequirement&&n.unlockRequirement.type==="achievement"&&n.unlockRequirement.value===e&&(Yo("characters",o)||(eh("characters",o),t.push({type:"character",key:o,name:n.name})));return t}function mn(){return yt().selectedCharacter||"survivor"}function Hc(e){const t=yt();t.selectedCharacter=e,Qt(t)}function Pt(e){const t=yt();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function Cg(e,t,o){const n=yt();return n.currency>=o?(n.currency-=o,n.unlocks[e]||(n.unlocks[e]=[]),n.unlocks[e].includes(t)||n.unlocks[e].push(t),Qt(n),!0):!1}function th(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function Rg(e,t,o){const n=yt(),s=Pt(e);return o&&s>=o?{success:!1,reason:"maxLevel"}:n.currency<t?{success:!1,reason:"insufficientCurrency"}:(n.currency-=t,n.permanentUpgradeLevels||(n.permanentUpgradeLevels={}),n.permanentUpgradeLevels[e]=(s||0)+1,n.permanentUpgradePurchaseHistory||(n.permanentUpgradePurchaseHistory={}),n.permanentUpgradePurchaseHistory[e]||(n.permanentUpgradePurchaseHistory[e]=[]),n.permanentUpgradePurchaseHistory[e].push(t),n.unlocks.permanentUpgrades||(n.unlocks.permanentUpgrades=[]),n.unlocks.permanentUpgrades.includes(e)||n.unlocks.permanentUpgrades.push(e),Qt(n),{success:!0,newLevel:n.permanentUpgradeLevels[e]})}function Ig(e,t){const o=yt();return o.currency<t?{success:!1,reason:"insufficientCurrency"}:(o.activeBoosters||(o.activeBoosters=[]),o.currency-=t,o.stats&&(o.stats.totalCurrencySpent=(o.stats.totalCurrencySpent||0)+t),o.activeBoosters.push({key:e,purchasedAt:Date.now()}),Qt(o),{success:!0,boosterKey:e})}function Pg(){return(yt().activeBoosters||[]).length}function Bg(){const e=yt(),t=e.activeBoosters||[];return e.activeBoosters=[],Qt(e),t}function oh(){const e=yt();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(o=>{const n=e.permanentUpgradePurchaseHistory[o];n&&Array.isArray(n)&&n.forEach(s=>{t+=s})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(o=>{const n=e.permanentUpgradeLevels[o]||0;for(let s=0;s<n;s++)t+=th(s)}),t}return 0}function Lg(e){const t=yt(),o=Pt(e);if(o===0)return{success:!1,reason:"noLevels"};let n=0;if(t.permanentUpgradePurchaseHistory&&t.permanentUpgradePurchaseHistory[e]&&t.permanentUpgradePurchaseHistory[e].length>0){const s=t.permanentUpgradePurchaseHistory[e];n=s[s.length-1],s.pop(),s.length===0&&delete t.permanentUpgradePurchaseHistory[e]}else n=th(o-1);if(t.currency+=n,t.permanentUpgradeLevels[e]=o-1,t.permanentUpgradeLevels[e]===0&&(delete t.permanentUpgradeLevels[e],t.unlocks.permanentUpgrades)){const s=t.unlocks.permanentUpgrades.indexOf(e);s>-1&&t.unlocks.permanentUpgrades.splice(s,1)}return Qt(t),{success:!0,refundAmount:n,newLevel:t.permanentUpgradeLevels[e]||0}}function zg(){const e=yt(),t=oh();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),Qt(e),{success:!0,refundAmount:t})}function va(e){const t=yt();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),Qt(t)}function Hr(e){const t=yt();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function Og(e){const t=yt();if(t.achievements||(t.achievements=[]),!t.achievements.includes(e)){t.achievements.push(e);const o=jd(e),n=Jd(o);return n>0&&(t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+n),console.log(`[MetaProgression] Achievement "${e}" awarded ${n} credits`)),Qt(t),Dg(e).then(s=>{s.length>0&&console.log("[MetaProgression] Achievement unlocked characters:",s)}),!0}return!1}function nh(){return yt().achievements||[]}function vs(){return yt().stats||ir.stats}function Ea(e){let t=0;t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30);const o=Pt("bossBounty");o>0&&e.bossesKilled>0&&(t+=e.bossesKilled*o*15);const n=Pt("creditBonus");return n>0&&(t=Math.floor(t*(1+n*.08))),Math.floor(t)}function la(){return Mg}function Mo(){return yt().playerName||"Player"}function Uc(e){const t=yt();return t.playerName=e,Qt(t),t.playerName}function Jn(){return yt().inviteCode||"000000"}function Hg(e){const t=yt();return t.inviteCode=e,Qt(t),t.inviteCode}function Ug(e){const t=yt();t.runHistory||(t.runHistory=[]);const o={timestamp:Date.now(),character:e.character||"survivor",weapon:e.weapon||"pistol",floorsReached:e.floorsReached||1,roomsCleared:e.roomsCleared||0,enemiesKilled:e.enemiesKilled||0,bossesKilled:e.bossesKilled||0,level:e.level||1,currencyEarned:e.currencyEarned||0,duration:e.duration||0,deathCause:e.deathCause||"Unknown",upgrades:e.upgrades||[],synergies:e.synergies||[]};return t.runHistory.unshift(o),t.runHistory.length>zc&&(t.runHistory=t.runHistory.slice(0,zc)),Qt(t),o}function Ng(){return yt().runHistory||[]}function _g(e){const t=yt();return t.equippedCosmetics&&t.equippedCosmetics[e]||(e==="trail"?"trailNone":e==="death"?"deathNone":"glowNone")}function Nc(e,t){const o=yt();return o.equippedCosmetics||(o.equippedCosmetics={trail:"trailNone",death:"deathNone",glow:"glowNone"}),!t.includes("None")&&!Yo("cosmetics",t)?!1:(o.equippedCosmetics[e]=t,Qt(o),!0)}function Xg(){return yt().equippedCosmetics||{trail:"trailNone",death:"deathNone",glow:"glowNone"}}function Ki(e){return Math.floor(Math.sqrt(e/100))+1}function ar(e){return e<=1?0:Math.pow(e-1,2)*100}function ri(){const e=yt();return Ki(e.totalXP||0)}function da(){return yt().totalXP||0}function sh(){const e=ri();return ar(e+1)}function Ur(){const e=da(),t=Ki(e),o=ar(t),n=ar(t+1);return n===o?1:(e-o)/(n-o)}function Fg(e){const t=yt(),o=Ki(t.totalXP||0);t.totalXP=(t.totalXP||0)+e;const n=Ki(t.totalXP);return t.playerLevel=n,Qt(t),{newXP:t.totalXP,newLevel:n,levelsGained:n-o,oldLevel:o}}function Yg(e){let t=0;return t+=e.floorsReached*50,t+=(e.enemiesKilled||0)*2,t+=(e.bossesKilled||0)*100,e.floorsReached>=5&&(t+=200),e.isDailyRun&&(t+=500),t}function ci(){return yt().selectedPortrait||"default"}function qg(e){const t=yt();return t.selectedPortrait=e,Qt(t),!0}function ih(){return yt().unlocks?.portraits||["default"]}const Gg=.15,Vi=120,_c=50,Mn=.5,xi=.7,oe={systemInitialized:!1,touchInitialized:!1,gamepadConnected:!1,gamepadIndex:null,moveX:0,moveY:0,aimX:0,aimY:0,aimActive:!1,touchEnabled:!1,leftTouch:null,rightTouch:null,leftJoystickCenter:null,rightJoystickCenter:null,leftJoystickBase:null,leftJoystickKnob:null,rightJoystickBase:null,rightJoystickKnob:null,k:null};function bi(e,t=Gg){return Math.abs(e)<t?0:(e>0?1:-1)*(Math.abs(e)-t)/(1-t)}function Kg(e){if(oe.k=e,oe.systemInitialized)return;oe.systemInitialized=!0,window.addEventListener("gamepadconnected",o=>{console.log("[InputSystem] Gamepad connected:",o.gamepad.id),oe.gamepadConnected=!0,oe.gamepadIndex=o.gamepad.index}),window.addEventListener("gamepaddisconnected",o=>{console.log("[InputSystem] Gamepad disconnected:",o.gamepad.id),o.gamepad.index===oe.gamepadIndex&&(oe.gamepadConnected=!1,oe.gamepadIndex=null)});const t=navigator.getGamepads();for(let o=0;o<t.length;o++)if(t[o]){console.log("[InputSystem] Found existing gamepad:",t[o].id),oe.gamepadConnected=!0,oe.gamepadIndex=t[o].index;break}oe.touchEnabled="ontouchstart"in window||navigator.maxTouchPoints>0,console.log("[InputSystem] Initialized. Gamepad:",oe.gamepadConnected,"Touch:",oe.touchEnabled)}function Vg(){if(!oe.gamepadConnected||oe.gamepadIndex===null)return;const t=navigator.getGamepads()[oe.gamepadIndex];if(!t){oe.gamepadConnected=!1,oe.gamepadIndex=null;return}oe.moveX=bi(t.axes[0]||0),oe.moveY=bi(t.axes[1]||0);const o=bi(t.axes[2]||0),n=bi(t.axes[3]||0);oe.aimX=o,oe.aimY=n,oe.aimActive=Math.abs(o)>0||Math.abs(n)>0}function Wg(e){if(!oe.touchEnabled)return;if(Zg(),oe.touchInitialized){Xc(e);return}oe.touchInitialized=!0,Xc(e);const t=e.canvas;t.addEventListener("touchstart",$g,{passive:!1}),t.addEventListener("touchmove",Jg,{passive:!1}),t.addEventListener("touchend",Fc,{passive:!1}),t.addEventListener("touchcancel",Fc,{passive:!1}),console.log("[InputSystem] Touch controls initialized")}function Xc(e){const t=e.width(),o=e.height(),n=t*.15,s=o*.75,a=t*.85,r=o*.75;oe.leftJoystickBase=e.add([e.circle(Vi/2),e.pos(n,s),e.anchor("center"),e.color(100,100,100),e.opacity(Mn),e.fixed(),e.z(1e3),"touchJoystick"]),oe.leftJoystickKnob=e.add([e.circle(_c/2),e.pos(n,s),e.anchor("center"),e.color(200,200,200),e.opacity(Mn),e.fixed(),e.z(1001),"touchJoystick"]),oe.rightJoystickBase=e.add([e.circle(Vi/2),e.pos(a,r),e.anchor("center"),e.color(100,100,100),e.opacity(Mn),e.fixed(),e.z(1e3),"touchJoystick"]),oe.rightJoystickKnob=e.add([e.circle(_c/2),e.pos(a,r),e.anchor("center"),e.color(255,100,100),e.opacity(Mn),e.fixed(),e.z(1001),"touchJoystick"]),oe.leftJoystickCenter={x:n,y:s},oe.rightJoystickCenter={x:a,y:r}}function $g(e){e.preventDefault();const t=oe.k,o=t.canvas.getBoundingClientRect(),n=t.width()/o.width,s=t.height()/o.height;for(const a of e.changedTouches){const r=(a.clientX-o.left)*n,l=(a.clientY-o.top)*s;r<t.width()/2&&oe.leftTouch===null?(oe.leftTouch=a.identifier,oe.leftJoystickCenter={x:r,y:l},oe.leftJoystickBase&&(oe.leftJoystickBase.pos.x=r,oe.leftJoystickBase.pos.y=l,oe.leftJoystickBase.opacity=xi),oe.leftJoystickKnob&&(oe.leftJoystickKnob.pos.x=r,oe.leftJoystickKnob.pos.y=l,oe.leftJoystickKnob.opacity=xi)):r>=t.width()/2&&oe.rightTouch===null&&(oe.rightTouch=a.identifier,oe.rightJoystickCenter={x:r,y:l},oe.rightJoystickBase&&(oe.rightJoystickBase.pos.x=r,oe.rightJoystickBase.pos.y=l,oe.rightJoystickBase.opacity=xi),oe.rightJoystickKnob&&(oe.rightJoystickKnob.pos.x=r,oe.rightJoystickKnob.pos.y=l,oe.rightJoystickKnob.opacity=xi),oe.aimActive=!0)}}function Jg(e){e.preventDefault();const t=oe.k,o=t.canvas.getBoundingClientRect(),n=t.width()/o.width,s=t.height()/o.height;for(const a of e.changedTouches){const r=(a.clientX-o.left)*n,l=(a.clientY-o.top)*s;if(a.identifier===oe.leftTouch&&oe.leftJoystickCenter){const c=r-oe.leftJoystickCenter.x,d=l-oe.leftJoystickCenter.y,i=Math.sqrt(c*c+d*d),h=Vi/2,u=Math.min(i,h),p=Math.atan2(d,c);oe.leftJoystickKnob&&(oe.leftJoystickKnob.pos.x=oe.leftJoystickCenter.x+Math.cos(p)*u,oe.leftJoystickKnob.pos.y=oe.leftJoystickCenter.y+Math.sin(p)*u);const g=u/h;oe.moveX=Math.cos(p)*g,oe.moveY=Math.sin(p)*g}if(a.identifier===oe.rightTouch&&oe.rightJoystickCenter){const c=r-oe.rightJoystickCenter.x,d=l-oe.rightJoystickCenter.y,i=Math.sqrt(c*c+d*d),h=Vi/2,u=Math.min(i,h),p=Math.atan2(d,c);oe.rightJoystickKnob&&(oe.rightJoystickKnob.pos.x=oe.rightJoystickCenter.x+Math.cos(p)*u,oe.rightJoystickKnob.pos.y=oe.rightJoystickCenter.y+Math.sin(p)*u);const g=u/h;oe.aimX=Math.cos(p)*g,oe.aimY=Math.sin(p)*g,oe.aimActive=g>.1}}}function Fc(e){e.preventDefault();for(const t of e.changedTouches)t.identifier===oe.leftTouch&&(oe.leftTouch=null,oe.moveX=0,oe.moveY=0,oe.leftJoystickKnob&&oe.leftJoystickCenter&&(oe.leftJoystickKnob.pos.x=oe.leftJoystickCenter.x,oe.leftJoystickKnob.pos.y=oe.leftJoystickCenter.y),oe.leftJoystickBase&&(oe.leftJoystickBase.opacity=Mn),oe.leftJoystickKnob&&(oe.leftJoystickKnob.opacity=Mn)),t.identifier===oe.rightTouch&&(oe.rightTouch=null,oe.aimX=0,oe.aimY=0,oe.aimActive=!1,oe.rightJoystickKnob&&oe.rightJoystickCenter&&(oe.rightJoystickKnob.pos.x=oe.rightJoystickCenter.x,oe.rightJoystickKnob.pos.y=oe.rightJoystickCenter.y),oe.rightJoystickBase&&(oe.rightJoystickBase.opacity=Mn),oe.rightJoystickKnob&&(oe.rightJoystickKnob.opacity=Mn))}function jg(){return{x:oe.moveX,y:oe.moveY}}function Yc(){return{x:oe.aimX,y:oe.aimY,active:oe.aimActive}}function Zg(){const e=oe.k;if(e){try{e.get("touchJoystick").forEach(t=>{t&&t.exists()&&e.destroy(t)})}catch{}oe.leftJoystickBase=null,oe.leftJoystickKnob=null,oe.rightJoystickBase=null,oe.rightJoystickKnob=null,oe.leftTouch=null,oe.rightTouch=null,oe.moveX=0,oe.moveY=0,oe.aimX=0,oe.aimY=0,oe.aimActive=!1}}const rr={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]},boomerang:{name:"Boomerang Blaster",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:250,baseDamage:14,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,returnsToPlayer:!0,returnSpeedMultiplier:1.2,category:"multiTarget",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},railgun:{name:"Railgun",icon:"",char:"",color:[150,200,255],fireRate:.33,projectileSpeed:800,baseDamage:50,projectileCount:1,spreadAngle:0,piercing:999,obstaclePiercing:1,critChance:.1,critDamage:3,range:1e3,infinitePierce:!0,category:"precision",upgradeCategories:["damage","crit","critDamage","fireRate","obstaclePiercing"]},spreadShot:{name:"Spread Shot",icon:"",char:"",color:[255,180,100],fireRate:2.5,projectileSpeed:280,baseDamage:6,projectileCount:3,spreadAngle:25,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:450,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},homingMissiles:{name:"Homing Missiles",icon:"",char:"",color:[255,100,150],fireRate:1.5,projectileSpeed:180,baseDamage:18,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,homing:!0,homingStrength:3,category:"precision",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},plasmaRifle:{name:"Plasma Rifle",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:350,baseDamage:16,projectileCount:1,spreadAngle:0,piercing:2,obstaclePiercing:0,critChance:.08,critDamage:2.2,range:650,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]}};function ah(e){return rr[e]||rr.pistol}function Qg(e,t){return ah(e).upgradeCategories.includes(t)}const Rs={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},jo={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},fn={BASE_XP_TO_NEXT_LEVEL:15,XP_SCALING_FACTOR:1.25,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},wn={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},ro={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},us={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},Vt={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:800,MAGNETIZE_ACCELERATION:600,COLLECTION_RADIUS:20};function Aa(e,t=0,o=0){const n=e*(1-o);return Math.max(ro.MIN_DAMAGE,n-t)}function kg(e,t=null){return(t?t.next():Math.random())<e}function em(e,t=2){return Math.floor(e*t)}function Sa(e,t,o,n=null){const s=n||mn(),a=$t[s]||$t.survivor,r=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.rotate(0),e.z(-1),"playerOutline"]),l=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...a.color),e.rotate(0),e.area(),e.health(a.stats.health),"player"]);l.outline=r,l.characterKey=s,l.characterData=a,l.speed=a.stats.speed,l.originalSpeed=a.stats.speed,l.slowed=!1,l.maxHealth=a.stats.health;const c=Pt("headStart");l.level=c>0?2:fn.STARTING_LEVEL,l.xp=fn.STARTING_XP,l.xpToNext=fn.BASE_XP_TO_NEXT_LEVEL,l.pickupRadius=jo.BASE_PICKUP_RADIUS,l.invulnerable=!1,l.invulnerableTime=0,l.invulnerableDuration=jo.INVULNERABILITY_DURATION,l.setHP(l.maxHealth);const d=a.weapon||"pistol",i=ah(d);l.weaponKey=d,l.weaponDef=i,l.baseFireRate=i.fireRate,l.baseProjectileSpeed=i.projectileSpeed,l.baseProjectileDamage=i.baseDamage;const h=a.stats.damage||10,u=i.baseDamage,p=h/10;if(l.fireRate=i.fireRate,l.projectileSpeed=i.projectileSpeed,l.projectileDamage=Math.floor(u*p),l.lastFireTime=0,l.projectileCount=i.projectileCount,l.piercing=i.piercing,l.obstaclePiercing=i.obstaclePiercing,l.critChance=i.critChance,l.critDamage=i.critDamage,l.spreadAngle=i.spreadAngle,l.defense=0,l.weaponRange=i.range,l.weaponCategory=i.category,i.orbitRadius&&(l.orbitRadius=i.orbitRadius,l.rotationSpeed=i.rotationSpeed,l.orbitalOrbs=[],l.orbitalAngles=[]),i.explosionRadius&&(l.explosionRadius=i.explosionRadius,l.explosionDamage=i.explosionDamage),i.chainRange&&(l.chainRange=i.chainRange,l.maxJumps=i.maxJumps,l.chainDamageReduction=i.chainDamageReduction),l.xpMultiplier=1,l.dodgeChance=0,l.damageReduction=0,l.weapons=[d],l.passiveUpgrades=[],l.upgradeStacks={},a.ability==="xpBoost"?l.xpMultiplier=wn.SURVIVOR_XP_BOOST:a.ability==="speedBoost"?(l.speed=l.speed*wn.SCOUT_SPEED_BOOST,l.originalSpeed=l.speed,l.dodgeChance=wn.SCOUT_DODGE_CHANCE):a.ability==="tankStats"?(l.maxHealth=Math.floor(l.maxHealth*wn.TANK_HEALTH_BOOST),l.setHP(l.maxHealth),l.damageReduction=wn.TANK_DAMAGE_REDUCTION):a.ability==="critBoost"?(l.critChance=(l.critChance||0)*wn.SNIPER_CRIT_CHANCE_MULTIPLIER,l.critDamage=(l.critDamage||2)*wn.SNIPER_CRIT_DAMAGE_MULTIPLIER):a.ability==="fireDot"&&(l.fireDotMultiplier=wn.PYRO_FIRE_DOT_MULTIPLIER),!a.skipPermanentUpgrades){const f=Pt("luckyStart");f>0&&(l.critChance=(l.critChance||0)+f*.05);const N=Pt("thickSkin");N>0&&(l.damageReduction=(l.damageReduction||0)+N*.03);const O=Pt("xpMagnet");O>0&&(l.pickupRadius=Math.floor(l.pickupRadius*(1+O*.15)));const w=Pt("comfortZone");w>0&&(l.invulnerableDuration=l.invulnerableDuration+w*.1)}l.canMove=!0,l.canShoot=!0,l.isDead=!1;let g=e.vec2(0,0),M=document.hasFocus(),m={w:!1,s:!1,a:!1,d:!1,up:!1,down:!1,left:!1,right:!1};l.moveDir=g,e.onKeyDown(["w","up"],()=>{l.isRemote||!M||m.w||m.up||(g.y=-1,l.moveDir=g)}),e.onKeyDown(["s","down"],()=>{l.isRemote||!M||m.s||m.down||(g.y=1,l.moveDir=g)}),e.onKeyDown(["a","left"],()=>{l.isRemote||!M||m.a||m.left||(g.x=-1,l.moveDir=g)}),e.onKeyDown(["d","right"],()=>{l.isRemote||!M||m.d||m.right||(g.x=1,l.moveDir=g)}),e.onKeyRelease(["w","up"],()=>{l.isRemote||(m.w=!1,m.up=!1,!e.isKeyDown("s")&&!e.isKeyDown("down")&&(g.y=0,l.moveDir=g))}),e.onKeyRelease(["s","down"],()=>{l.isRemote||(m.s=!1,m.down=!1,!e.isKeyDown("w")&&!e.isKeyDown("up")&&(g.y=0,l.moveDir=g))}),e.onKeyRelease(["a","left"],()=>{l.isRemote||(m.a=!1,m.left=!1,!e.isKeyDown("d")&&!e.isKeyDown("right")&&(g.x=0,l.moveDir=g))}),e.onKeyRelease(["d","right"],()=>{l.isRemote||(m.d=!1,m.right=!1,!e.isKeyDown("a")&&!e.isKeyDown("left")&&(g.x=0,l.moveDir=g))});const T=()=>{l.isRemote||(M=!1,g.x=0,g.y=0,l.moveDir=g,l.isShooting=!1,m={w:e.isKeyDown("w"),s:e.isKeyDown("s"),a:e.isKeyDown("a"),d:e.isKeyDown("d"),up:e.isKeyDown("up"),down:e.isKeyDown("down"),left:e.isKeyDown("left"),right:e.isKeyDown("right")})},P=()=>{M=!0};return window.addEventListener("blur",T),window.addEventListener("focus",P),l.onDestroy(()=>{window.removeEventListener("blur",T),window.removeEventListener("focus",P)}),l.onUpdate(()=>{if(l.outline&&l.outline.exists()&&(l.outline.pos=l.pos.clone()),e.paused)return;if(l.invulnerable)if(l.invulnerableTime-=e.dt(),l.invulnerableTime<=0)l.invulnerable=!1,l.color=e.rgb(...jo.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1);else{const A=jo.IMMUNITY_FLASH_RATE;Math.floor(l.invulnerableTime*A)%2===0?(l.color=e.rgb(...jo.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1)):(l.color=e.rgb(...jo.NORMAL_COLOR,jo.IMMUNITY_ALPHA),l.outline&&l.outline.exists()&&(l.outline.opacity=jo.IMMUNITY_ALPHA))}if(l.canMove===!1)return;Vg();let f=g;if(l.isRemote&&l.move)f=e.vec2(l.move.x,l.move.y);else if(!l.isRemote){const A=jg();(A.x!==0||A.y!==0)&&(f=e.vec2(A.x,A.y))}if(f.len()>0){const A=f.len(),I=f.scale(1/A).scale(l.speed*e.dt()),E=l.pos.x+I.x,L=l.pos.y+I.y;let C=!0,F=!0;const U=e.get("obstacle"),_=jo.COLLISION_SIZE;for(const H of U){if(!H.exists())continue;const R=H.pos.x-H.width/2,Y=H.pos.x+H.width/2,V=H.pos.y-H.height/2,Q=H.pos.y+H.height/2,fe=E-_,se=E+_,ie=l.pos.y-_,ae=l.pos.y+_;se>R&&fe<Y&&ae>V&&ie<Q&&(C=!1);const ge=l.pos.x-_,Se=l.pos.x+_,Ie=L-_,ve=L+_;Se>R&&ge<Y&&ve>V&&Ie<Q&&(F=!1)}C&&(l.pos.x=E),F&&(l.pos.y=L)}const N=e.width(),O=e.height(),w=jo.ROOM_MARGIN;l.pos.x=e.clamp(l.pos.x,w,N-w),l.pos.y=e.clamp(l.pos.y,w,O-w)}),l}const Oe={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function Nr(e,t=!0){return new Promise((o,n)=>{if(Oe.isInitialized){console.warn("Network already initialized"),o(e);return}if(window.addEventListener("beforeunload",()=>{_r()}),typeof Peer>"u"){console.error("PeerJS library not loaded"),n(new Error("PeerJS library not available"));return}Oe.isHost=t;const s=t?`smash-${e}`:void 0,a=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";let r;a?r={debug:3,host:"localhost",port:9e3,path:"/",secure:!1,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}}:r={debug:2,secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}};try{Oe.peer=new Peer(s,r),Oe.peer.on("open",l=>{Oe.peerId=l,Oe.isInitialized=!0;const c=t&&l.startsWith("smash-")?l.substring(6):l;o(c)}),Oe.peer.on("error",l=>{if(console.error("Peer error:",l),l.type==="unavailable-id"&&t){if(console.warn("Peer ID already taken - generating new code and retrying..."),Oe.peer){try{Oe.peer.destroy()}catch(c){console.warn("Error destroying peer:",c)}Oe.peer=null,Oe.peerId=null,Oe.isInitialized=!1}setTimeout(()=>{const c=sr();Nr(c,t).then(o).catch(n)},2e3);return}l.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):l.type==="peer-unavailable"?console.warn("Host not found - check invite code"):l.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),Oe.isInitialized||n(new Error(`Multiplayer unavailable: ${l.type||"connection failed"}`))}),t&&Oe.peer.on("connection",l=>{tm(l)})}catch(l){console.error("Failed to create peer:",l),n(l)}})}function tm(e){Oe.isHost&&(e.on("open",()=>{Oe.connections.set(e.peer,e),Oe.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{rh(t,e.peer)}),e.on("close",()=>{Oe.connections.delete(e.peer),Oe.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function om(e){return new Promise((t,o)=>{if(Oe.isHost){o(new Error("Host cannot connect to another host"));return}if(!Oe.isInitialized){o(new Error("Network not initialized"));return}const n=`smash-${e}`;let s,a=!1;const r=Oe.peer.connect(n,{reliable:!0});s=setTimeout(()=>{a||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),r.close(),o(new Error("Connection timeout - could not reach host")))},3e4),r.on("open",()=>{a=!0,clearTimeout(s),s=null,Oe.hostConnection=r,Oe.hostId=n,t()}),r.on("data",l=>{rh(l,n)}),r.on("close",()=>{s&&(clearTimeout(s),s=null),Oe.hostConnection=null,Oe.hostId=null,Oe.connectionCallbacks.forEach(l=>l("host_disconnect"))}),r.on("error",l=>{a=!0,clearTimeout(s),s=null,console.error("[NetworkSystem] Connection error:",l),console.error("[NetworkSystem] Error type:",l.type||"unknown"),o(l)})})}function rh(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const o=Oe.messageHandlers.get(e.type);o?o(e.payload,t):console.warn("No handler for message type:",e.type)}function He(e,t){Oe.messageHandlers.set(e,t)}function Ot(e){Oe.messageHandlers.delete(e)}function ch(e){Oe.connectionCallbacks.includes(e)||Oe.connectionCallbacks.push(e)}function lo(e,t){if(Oe.isHost){console.warn("Host cannot send to itself");return}if(!Oe.hostConnection){console.warn("Not connected to host");return}Oe.hostConnection.send({type:e,payload:t})}function qo(e,t,o){if(!Oe.isHost){console.warn("Only host can send to specific peers");return}const n=Oe.connections.get(e);n?n.send({type:t,payload:o}):console.warn("No connection to peer:",e)}function Ge(e,t,o=[]){if(!Oe.isHost){console.warn("Only host can broadcast");return}Oe.connections.forEach((n,s)=>{o.includes(s)||n.send({type:e,payload:t})})}function _r(){Oe.isHost?(Oe.connections.forEach(e=>e.close()),Oe.connections.clear()):Oe.hostConnection&&(Oe.hostConnection.close(),Oe.hostConnection=null,Oe.hostId=null),Oe.peer&&(Oe.peer.destroy(),Oe.peer=null),Oe.messageHandlers.clear(),Oe.connectionCallbacks=[],Oe.isInitialized=!1,Oe.peerId=null}function nm(){const e=Oe.peerId&&Oe.peerId.startsWith("smash-")?Oe.peerId.substring(6):Oe.peerId;return{isInitialized:Oe.isInitialized,isHost:Oe.isHost,peerId:e,hostId:Oe.hostId,connectedPeers:Array.from(Oe.connections.keys()),peerCount:Oe.connections.size}}const k={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!0,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null,hostInviteCode:null,disconnectedPlayers:new Map,reconnectWindow:15e3,countdownActive:!1,countdownStartTime:0,countdownDuration:3e3,activeEmotes:new Map,emoteCallbacks:[]};let ti=!1,oi=!1;async function lh(e=null){if(e&&(k.kaplayInstance=e),k.isHost){const t=Mo(),o=Jn(),n=mn(),s=ci();k.slots[0].playerId="local",k.slots[0].playerName=t,k.slots[0].inviteCode=o,k.slots[0].selectedCharacter=n,k.slots[0].selectedPortrait=s,k.slots[0].isLocal=!0,k.slots[0].permanentUpgradeLevels={startingHealth:Pt("startingHealth"),startingDamage:Pt("startingDamage"),startingSpeed:Pt("startingSpeed"),propDurability:Pt("propDurability"),propDropChance:Pt("propDropChance")},console.log("[PartySystem] Host player initialized in slot 0:",{name:k.slots[0].playerName,code:k.slots[0].inviteCode,character:k.slots[0].selectedCharacter})}else console.log("[PartySystem] Client mode - preserving existing slot assignments");if(!k.networkInitialized)try{console.log("[PartySystem] Initializing network as host...");const t=Jn(),o=await Nr(t,!0);o!==t&&(console.log(`[PartySystem] Invite code changed: ${t} -> ${o}`),Hg(o),k.slots[0].inviteCode=o),k.networkInitialized=!0,k.isHost=!0,sm(),console.log("[PartySystem] Network initialized as host - ready to accept connections")}catch(t){console.error("[PartySystem] Failed to initialize network as host:",t),console.log("[PartySystem] Multiplayer disabled - running in single-player mode")}}function sm(){ti||(ti=!0,He("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const o=im(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",e.selectedPortrait||"default",t,e.permanentUpgradeLevels||null);if(o!==null){const n={slots:k.slots.map(s=>({playerId:s.playerId,playerName:s.playerName,inviteCode:s.inviteCode,selectedCharacter:s.selectedCharacter,selectedPortrait:s.selectedPortrait,permanentUpgradeLevels:s.permanentUpgradeLevels,isLocal:!1})),yourSlotIndex:o};console.log("[PartySystem] Sending party_sync to new player:",{hostName:n.slots[0].playerName,hostCharacter:n.slots[0].selectedCharacter,newPlayerSlot:o}),qo(t,"party_sync",n),setTimeout(()=>{Wm(t)},250),_n()}else qo(t,"join_rejected",{reason:"Party full"})}),He("player_info",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.playerName&&(k.slots[o].playerName=e.playerName),_n())}),He("character_change",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} changed character to:`,e.selectedCharacter),k.slots[o].selectedCharacter=e.selectedCharacter,_n())}),He("ready_change",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} ready state:`,e.isReady),k.slots[o].isReady=e.isReady,_n(),dh())}),He("party_emote",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.slotIndex=o,Xr(e),Ge("party_emote",e))}),He("profile_request",(e,t)=>{const o=e.targetSlot;if(o===0)uh(e,t);else{const n=k.slots[o]?.peerId;n&&qo(n,"profile_request",{requestingSlot:k.peerIdToSlot.get(t),forwardTo:t})}}),He("profile_response",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.slotIndex=o,e.forwardTo?qo(e.forwardTo,"profile_response",e):fh(e))}),ch((e,t)=>{e==="leave"&&cm(t)}))}function fs(){return k}function Hn(){return k.slots.filter(e=>e.playerId!==null).length}function qc(){return!k.isHost&&k.hostInviteCode?k.hostInviteCode:Jn()}function im(e,t,o,n,s,a=null){for(let r=1;r<k.slots.length;r++)if(k.slots[r].playerId===null)return k.slots[r].playerId=`player_${Date.now()}_${r}`,k.slots[r].playerName=e,k.slots[r].inviteCode=t,k.slots[r].selectedCharacter=o,k.slots[r].selectedPortrait=n,k.slots[r].peerId=s,k.slots[r].permanentUpgradeLevels=a,k.peerIdToSlot.set(s,r),r;return null}async function am(e){const t={playerName:Mo(),inviteCode:Jn(),selectedCharacter:mn()};try{console.log("[PartySystem] Joining as client - clearing all party slots");for(let o=0;o<k.slots.length;o++)k.slots[o]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null};return k.networkInitialized&&k.isHost&&(console.log("[PartySystem] Switching from host to client - disconnecting current peer..."),_r(),k.networkInitialized=!1,k.isHost=!1,ti=!1,oi=!1),k.networkInitialized||(await Nr("client",!1),k.networkInitialized=!0,k.isHost=!1),k.hostInviteCode=e,rm(),await om(e),lo("join_request",{playerName:t.playerName,inviteCode:t.inviteCode,selectedCharacter:t.selectedCharacter,selectedPortrait:ci()||"default",permanentUpgradeLevels:{startingHealth:Pt("startingHealth"),startingDamage:Pt("startingDamage"),startingSpeed:Pt("startingSpeed"),propDurability:Pt("propDurability"),propDropChance:Pt("propDropChance")}}),!0}catch(o){return console.error("Failed to join party:",o),console.log("[PartySystem] Restoring local player after join failure"),Wi(t),!1}}function Wi(e){k.networkInitialized&&!k.isHost&&_r(),k.isHost=!0,k.hostInviteCode=null,k.networkInitialized=!1,ti=!1,oi=!1;for(let t=0;t<k.slots.length;t++)k.slots[t]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null};k.slots[0]={playerId:"local",playerName:e.playerName||Mo(),inviteCode:e.inviteCode||Jn(),selectedCharacter:e.selectedCharacter||mn(),isLocal:!0,peerId:null},lh(k.kaplayInstance).catch(t=>{console.warn("[PartySystem] Failed to re-initialize as host:",t)})}function rm(){oi||(oi=!0,He("party_sync",e=>{console.log("[PartySystem] Received party sync:",{hostName:e.slots[0].playerName,hostCharacter:e.slots[0].selectedCharacter,yourSlot:e.yourSlotIndex,totalSlots:e.slots.filter(o=>o.playerId!==null).length}),k.slots=e.slots,e.yourSlotIndex!==void 0&&(k.slots[e.yourSlotIndex].isLocal=!0,console.log(`[PartySystem] Marked slot ${e.yourSlotIndex} as local`)),k.slots[0].isLocal=!1;const t=k.slots.filter(o=>o.playerId!==null).length;console.log("[PartySystem] Party synced successfully:",{partySize:t,hostInSlot0:k.slots[0].playerName,localSlot:e.yourSlotIndex})}),He("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),He("game_start",e=>{console.log("Host started game - joining..."),k.kaplayInstance?k.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),He("countdown_start",e=>{console.log("[PartySystem] Countdown started by host:",e.duration),k.countdownActive=!0,k.countdownStartTime=Date.now(),k.countdownDuration=e.duration||3e3}),He("countdown_cancel",()=>{console.log("[PartySystem] Countdown cancelled by host"),k.countdownActive=!1,k.countdownStartTime=0}),He("party_update",e=>{const t=k.slots.findIndex(o=>o.isLocal);k.slots=e.slots,t!==-1&&(k.slots[t].isLocal=!0)}),He("party_emote",e=>{Xr(e)}),He("profile_request",e=>{uh()}),He("profile_response",e=>{fh(e)}),ch(e=>{if(e==="host_disconnect"){console.log("[PartySystem] Host disconnected - returning to solo party"),alert("Host disconnected - returning to main menu");const t={playerName:Mo(),inviteCode:Jn(),selectedCharacter:mn()};Wi(t),k.kaplayInstance&&k.kaplayInstance.go("menu")}}))}function _n(){k.isHost&&Ge("party_update",{slots:k.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,selectedPortrait:e.selectedPortrait,permanentUpgradeLevels:e.permanentUpgradeLevels,isLocal:!1,isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))})}function Gc(){k.isHost&&(console.log("Broadcasting game start to all clients"),Ge("game_start",{}))}function cm(e){const t=k.peerIdToSlot.get(e);if(t!==void 0){console.log("[PartySystem] Player disconnected from slot",t,"- starting reconnection window");const o={...k.slots[t]};k.disconnectedPlayers.set(t,{disconnectTime:Date.now(),playerData:o,peerId:e}),k.slots[t].isDisconnected=!0,Ge("player_disconnected",{slotIndex:t,reconnectWindow:k.reconnectWindow}),k.peerIdToSlot.delete(e),setTimeout(()=>{lm(t)},k.reconnectWindow)}}function lm(e){k.disconnectedPlayers.get(e)&&(console.log("[PartySystem] Reconnection window expired for slot",e,"- removing player"),qm(e),dm(e),k.disconnectedPlayers.delete(e),Ge("player_removed",{slotIndex:e}),_n())}function dm(e){if(e>0&&e<k.slots.length){const t=k.slots[e].peerId;return t&&k.peerIdToSlot.delete(t),k.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null,isReady:!1},!0}return!1}function hm(){return k.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter||"survivor",selectedPortrait:e.selectedPortrait||"default",isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))}function Kc(e){k.slots[0].selectedCharacter=e,k.networkInitialized&&(k.isHost?_n():lo("character_change",{selectedCharacter:e}))}function um(){const e=ps();return e===null?!1:(k.slots[e].isReady=!k.slots[e].isReady,k.networkInitialized&&(k.isHost?(_n(),dh()):lo("ready_change",{isReady:k.slots[e].isReady})),k.slots[e].isReady)}function ps(){const e=k.slots.findIndex(t=>t.isLocal);return e>=0?e:null}function fm(){const e=ps();return e!==null&&k.slots[e].isReady}function Vc(){const e=k.slots.filter(t=>t.playerId!==null);return e.length<2?!1:e.every(t=>t.isReady)}function dh(){k.isHost&&(Vc()&&!k.countdownActive?pm():!Vc()&&k.countdownActive&&gm())}function pm(){k.isHost&&(k.countdownActive=!0,k.countdownStartTime=Date.now(),Ge("countdown_start",{duration:k.countdownDuration}),console.log("[PartySystem] Countdown started"))}function gm(){k.isHost&&(k.countdownActive=!1,k.countdownStartTime=0,Ge("countdown_cancel",{}),console.log("[PartySystem] Countdown cancelled"))}function Wc(){if(!k.countdownActive)return{active:!1,timeRemaining:0};const e=Date.now()-k.countdownStartTime;return{active:!0,timeRemaining:Math.max(0,k.countdownDuration-e)}}function Xr(e){const{slotIndex:t,emoteType:o}=e;k.activeEmotes.set(t,{emoteType:o,startTime:Date.now()}),k.emoteCallbacks.forEach(n=>{try{n(t,o)}catch(s){console.error("[PartySystem] Emote callback error:",s)}})}function $c(e){const t=ps();if(t===null)return;const o={slotIndex:t,emoteType:e};Xr(o),k.networkInitialized&&(k.isHost?Ge("party_emote",o):lo("party_emote",o))}function mm(e){k.emoteCallbacks.push(e)}function ym(e){const t=k.emoteCallbacks.indexOf(e);t!==-1&&k.emoteCallbacks.splice(t,1)}function xm(e,t=2e3){const o=k.activeEmotes.get(e);return o?Date.now()-o.startTime>t?(k.activeEmotes.delete(e),null):o.emoteType:null}function bm(){k.emoteCallbacks=[],k.activeEmotes.clear(),ti=!1,oi=!1}const Nn=new Map;function hh(){return{playerName:Mo(),selectedPortrait:ci(),playerLevel:ri(),totalXP:da(),stats:vs(),achievements:nh(),unlockedPortraits:ih()}}function wm(e,t){const o=k.slots[e];if(!o||o.playerId===null){console.warn("[PartySystem] Cannot request profile for empty slot:",e),t(null);return}if(o.isLocal){t(hh());return}if(Nn.set(e,t),k.isHost){const n=o.peerId;n?qo(n,"profile_request",{requestingSlot:ps()}):(console.warn("[PartySystem] No peerId for slot:",e),t(null),Nn.delete(e))}else lo("profile_request",{targetSlot:e});setTimeout(()=>{if(Nn.has(e)){console.warn("[PartySystem] Profile request timed out for slot:",e);const n=Nn.get(e);Nn.delete(e),n(null)}},5e3)}function uh(e,t=null){const o=hh();k.isHost&&t?qo(t,"profile_response",{slotIndex:ps(),profileData:o}):lo("profile_response",{slotIndex:ps(),profileData:o})}function fh(e){const{slotIndex:t,profileData:o}=e,n=Nn.get(t);n&&(Nn.delete(t),n(o))}const tn={gatekeeper:{name:"Studio Head",coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{name:"Showrunner",coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{name:"Co-Host (Melee)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{name:"Co-Host (Ranged)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function vm(e){return tn[e]||tn.gatekeeper}function $i(e,t,o,n="gatekeeper",s=1,a=null){const r=vm(n),l=1+(s-1)*.2,c={coreChar:r.coreChar,armorChar:r.armorChar||"()",shieldChar:r.shieldChar||"{}",color:r.color,armorColor:r.armorColor||[200,200,200],shieldColor:r.shieldColor||[100,200,255],health:Math.floor(r.baseHealth*l),armorHealth:Math.floor((r.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((r.baseArmorHealth||0)*l),shieldHealth:Math.floor((r.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((r.baseShieldHealth||0)*l),speed:Math.floor(r.baseSpeed*(1+(s-1)*.05)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),damageReduction:r.damageReduction||0,shieldRegenRate:(r.shieldRegenRate||0)*l};function d(){const h=c.armorHealth>c.maxArmorHealth*.5?"(":"",u=c.armorHealth>0?")":"";return`${h}${c.coreChar}${u}`}const i=e.add([e.text(d(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"boss"]);return i.maxHealth=c.health,i.speed=c.speed,i.xpValue=c.xpValue,i.type=n,i.floor=s,i.textSize=c.size,i.rng=a,r.meleeDamage&&(i.meleeDamage=r.meleeDamage),r.projectileDamage&&(i.projectileDamage=r.projectileDamage),r.projectileSpeed&&(i.projectileSpeed=r.projectileSpeed),r.fireRate&&(i.fireRate=r.fireRate),(n==="twinGuardianMelee"||n==="twinGuardianRanged")&&(i.enraged=!1,i.enrage=function(){this.enraged||(this.enraged=!0,this.speed=Math.floor(this.speed*1.5),this.type==="twinGuardianMelee"?(this.chargeCooldownTimer=0,this.meleeDamage=Math.floor(this.meleeDamage*1.25)):(this.fireRate=this.fireRate*1.5,this.projectileDamage=Math.floor(this.projectileDamage*1.25)),this.color=e.rgb(255,200,0))}),i.armorHealth=c.armorHealth,i.maxArmorHealth=c.maxArmorHealth,i.damageReduction=c.damageReduction,i.coreChar=c.coreChar,i.armorChar=c.armorChar,i.armorColor=c.armorColor,i.shieldHealth=c.shieldHealth,i.maxShieldHealth=c.maxShieldHealth,i.shieldRegenRate=c.shieldRegenRate,i.shieldChar=c.shieldChar,i.shieldColor=c.shieldColor,i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.updateVisual=function(){let h="",u="",p="",g="";if(i.shieldHealth>0){const m=i.shieldHealth/i.maxShieldHealth;m>.66?(h="",u=""):m>.33?(h="",u=""):(h="",u="")}if(i.armorHealth>0){const m=i.armorHealth/i.maxArmorHealth;m>.66?(p="",g=""):m>.33?(p="",g=""):(p="",g="")}const M=`${h}${p}${i.coreChar}${g}${u}`;i.text=M,i.shieldHealth>0?i.color=e.rgb(...c.shieldColor):i.color=e.rgb(...c.color)},i.takeDamage=function(h){let u=!1,p=!1;const g=i.shieldHealth,M=i.armorHealth;i.lastDamageTime=e.time();const m=3;if(i.shieldRegenCooldown=m,i.shieldHealth>0){const T=Math.min(h,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-T),u=i.shieldHealth!==g;const P=h-T;P>0&&i.takeDamageInternal(P)}else i.takeDamageInternal(h);p=i.armorHealth!==M,(u||p)&&i.updateVisual()},i.takeDamageInternal=function(h){if(i.armorHealth>0){const u=Math.floor(h*(1-i.damageReduction)),p=Math.min(u,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-p);const g=h-u;if(g>0){const M=i.armorHealth>0?1-i.damageReduction:1,m=Math.floor(g*M);i.hurt(m)}}else i.hurt(h)},i.attackTimer=0,i.minionSpawnTimer=0,i.chargeCooldownTimer=0,i.chargeDurationTimer=0,i.radialBurstTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeSpeed=0,i.spawnedMinions=[],i.enraged=!1,i.twinPartner=null,i.getPhase=function(){const h=i.hp()/i.maxHealth;return h>.75?1:h>.5?2:3},i.spawnMinions=function(){if(!i.exists())return;const h=i.getPhase(),u=h===1?2:3;for(let p=0;p<u;p++){const g=i.rng?i.rng.next()*.5:Math.random()*.5,M=Math.PI*2/u*p+g,T=40+(i.rng?i.rng.next()*20:Math.random()*20),P=i.pos.x+Math.cos(M)*T,f=i.pos.y+Math.sin(M)*T,O=(i.rng?i.rng.next():Math.random())<.5?"rusher":"basic",w=Rn(e,P,f,O,s);w.isBossMinion=!0,i.spawnedMinions.push(w),le()&&pe()&&Xo(w,{type:O,floor:s,isBossMinion:!0})}},i.radialBurst=function(){if(!i.exists())return;const h=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];i.getPhase();const u=200,p=12;h.forEach(g=>{const M=To(e,i.pos.x,i.pos.y,g,u,p,0,0,!1);M.isBossProjectile=!0,M.color=e.rgb(255,100,100)})},i.startCharge=function(h){if(!i.exists())return;i.isCharging=!0;const u=e.vec2(h.x-i.pos.x,h.y-i.pos.y);if(u.len()>0&&(i.chargeDirection=u.unit(),!i.chargeSpeed||i.chargeSpeed===0)){const p=i.getPhase?i.getPhase():1;i.chargeSpeed=i.speed*(p===1?2.5:p===2?3:3.5)}},i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const T=1;if(i.shieldRegenTimer>=T){const P=i.shieldRegenRate*T;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+P),i.shieldRegenTimer=0,i.shieldHealth>0&&i.updateVisual()}}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!le()||pe())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color,i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&i.updateVisual()}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const h=e.get("player")[0];if(!h||!h.exists())return;const u=i.getPhase();if(i.type==="gatekeeper"){i.attackTimer+=e.dt(),i.minionSpawnTimer+=e.dt(),i.radialBurstTimer+=e.dt();const T=u===1?8:u===2?6:5,P=10,f=u===1?8:u===2?6:5;if(i.isCharging){const N=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=N.x,i.pos.y+=N.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{i.chargeCooldownTimer+=e.dt();const N=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y);if(N.len()>0){const w=N.unit(),A=i.speed*(u===1?1:u===2?1.2:1.5),S=w.scale(A*e.dt()),I=i.pos.x+S.x,E=i.pos.y+S.y;let L=!0,C=!0;const F=e.get("obstacle"),U=i.size||14;for(const _ of F){if(!_.exists())continue;const H=_.pos.x-_.width/2,R=_.pos.x+_.width/2,Y=_.pos.y-_.height/2,V=_.pos.y+_.height/2,Q=I-U,fe=I+U,se=i.pos.y-U,ie=i.pos.y+U;fe>H&&Q<R&&ie>Y&&se<V&&(L=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0));const ae=i.pos.x-U,ge=i.pos.x+U,Se=E-U,Ie=E+U;ge>H&&ae<R&&Ie>Y&&Se<V&&(C=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0))}L&&(i.pos.x=I),C&&(i.pos.y=E)}i.minionSpawnTimer>=T&&(i.spawnMinions(),i.minionSpawnTimer=0),i.chargeCooldownTimer>=P&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{i.exists()&&(i.color=e.rgb(...c.color),i.startCharge(h.pos))}),i.chargeCooldownTimer=0),i.radialBurstTimer>=f&&(i.radialBurst(),i.radialBurstTimer=0)}}else if(i.type==="twinGuardianMelee"){i.attackTimer+=e.dt(),i.chargeCooldownTimer+=e.dt();const T=8,P=150,f=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),N=f.len();if(i.isCharging){const O=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=O.x,i.pos.y+=O.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1.2&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{if(N>0){const O=f.unit(),w=i.speed*(i.enraged?1.5:1),A=O.scale(w*e.dt()),S=i.pos.x+A.x,I=i.pos.y+A.y;let E=!0,L=!0;const C=e.get("obstacle"),F=i.size||14;for(const U of C){if(!U.exists())continue;const _=U.pos.x-U.width/2,H=U.pos.x+U.width/2,R=U.pos.y-U.height/2,Y=U.pos.y+U.height/2,V=S-F,Q=S+F,fe=i.pos.y-F,se=i.pos.y+F;Q>_&&V<H&&se>R&&fe<Y&&(E=!1);const ie=i.pos.x-F,ae=i.pos.x+F,ge=I-F,Se=I+F;ae>_&&ie<H&&Se>R&&ge<Y&&(L=!1)}E&&(i.pos.x=S),L&&(i.pos.y=I)}i.chargeCooldownTimer>=T&&N<P&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{if(i.exists()){i.color=e.rgb(...c.color);const O=i.enraged?3.5:2.5;i.chargeSpeed=i.speed*O,i.startCharge(h.pos)}}),i.chargeCooldownTimer=0)}}else if(i.type==="twinGuardianRanged"){i.attackTimer+=e.dt();const T=200,P=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),f=P.len();if(f>0){const O=P.unit();let w=i.speed*(i.enraged?1.5:1);if(f<T){const A=O.scale(-w*e.dt()),S=i.pos.x+A.x,I=i.pos.y+A.y;let E=!0,L=!0;const C=e.get("obstacle"),F=i.size||14;for(const U of C){if(!U.exists())continue;const _=U.pos.x-U.width/2,H=U.pos.x+U.width/2,R=U.pos.y-U.height/2,Y=U.pos.y+U.height/2,V=S-F,Q=S+F,fe=i.pos.y-F,se=i.pos.y+F;Q>_&&V<H&&se>R&&fe<Y&&(E=!1);const ie=i.pos.x-F,ae=i.pos.x+F,ge=I-F,Se=I+F;ae>_&&ie<H&&Se>R&&ge<Y&&(L=!1)}E&&(i.pos.x=S),L&&(i.pos.y=I)}else if(f>T*1.5){const A=O.scale(w*e.dt()),S=i.pos.x+A.x,I=i.pos.y+A.y;let E=!0,L=!0;const C=e.get("obstacle"),F=i.size||14;for(const U of C){if(!U.exists())continue;const _=U.pos.x-U.width/2,H=U.pos.x+U.width/2,R=U.pos.y-U.height/2,Y=U.pos.y+U.height/2,V=S-F,Q=S+F,fe=i.pos.y-F,se=i.pos.y+F;Q>_&&V<H&&se>R&&fe<Y&&(E=!1);const ie=i.pos.x-F,ae=i.pos.x+F,ge=I-F,Se=I+F;ae>_&&ie<H&&Se>R&&ge<Y&&(L=!1)}E&&(i.pos.x=S),L&&(i.pos.y=I)}}const N=1/(i.fireRate*(i.enraged?1.5:1));if(i.attackTimer>=N){if(f>0){const O=P.unit(),w=To(e,i.pos.x,i.pos.y,O,i.projectileSpeed,i.projectileDamage*(i.enraged?1.25:1),0,0,!1);w.isBossProjectile=!0,w.color=e.rgb(100,150,255)}i.attackTimer=0}}else if(i.type==="swarmQueen"){i.minionSpawnTimer+=e.dt();const T=i.hp()/i.maxHealth;let P;T>.66?P=5:T>.33?P=3:P=2;const f=i.spawnedMinions.filter(C=>C.exists()&&C.hp()>0);if(i.minionSpawnTimer>=P&&f.length<8){const C=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",F=(i.rng?i.rng.next():Math.random())*Math.PI*2,U=50+(i.rng?i.rng.next():Math.random())*30,_=i.pos.x+Math.cos(F)*U,H=i.pos.y+Math.sin(F)*U,R=Rn(e,_,H,C,s);R.isBossMinion=!0,i.spawnedMinions.push(R),i.spawnedMinions=i.spawnedMinions.filter(Y=>Y.exists()),i.minionSpawnTimer=0}const O=e.width()/2,w=e.height()/2,A=150,S=e.vec2(O-i.pos.x,w-i.pos.y),I=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),E=I.len();let L=e.vec2(0,0);if(S.len()>30&&(L=L.add(S.unit().scale(.5))),E<A&&(L=L.add(I.unit().scale(-1))),L.len()>0){const F=L.unit().scale(i.speed*e.dt()),U=i.pos.x+F.x,_=i.pos.y+F.y;let H=!0,R=!0;const Y=e.get("obstacle"),V=i.size||14;for(const Q of Y){if(!Q.exists())continue;const fe=Q.pos.x-Q.width/2,se=Q.pos.x+Q.width/2,ie=Q.pos.y-Q.height/2,ae=Q.pos.y+Q.height/2,ge=U-V,Se=U+V,Ie=i.pos.y-V,ve=i.pos.y+V;Se>fe&&ge<se&&ve>ie&&Ie<ae&&(H=!1);const _e=i.pos.x-V,nt=i.pos.x+V,Me=_-V,Tt=_+V;nt>fe&&_e<se&&Tt>ie&&Me<ae&&(R=!1)}H&&(i.pos.x=U),R&&(i.pos.y=_)}}else{const T=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y);if(T.len()>0){const N=T.unit().scale(i.speed*e.dt()),O=i.pos.x+N.x,w=i.pos.y+N.y;let A=!0,S=!0;const I=e.get("obstacle"),E=i.size||14;for(const L of I){if(!L.exists())continue;const C=L.pos.x-L.width/2,F=L.pos.x+L.width/2,U=L.pos.y-L.height/2,_=L.pos.y+L.height/2,H=O-E,R=O+E,Y=i.pos.y-E,V=i.pos.y+E;R>C&&H<F&&V>U&&Y<_&&(A=!1);const Q=i.pos.x-E,fe=i.pos.x+E,se=w-E,ie=w+E;fe>C&&Q<F&&ie>U&&se<_&&(S=!1)}A&&(i.pos.x=O),S&&(i.pos.y=w)}}const p=e.width(),g=e.height(),M=20,m=i.size||14;i.pos.x=e.clamp(i.pos.x,M+m,p-M-m),i.pos.y=e.clamp(i.pos.y,M+m,g-M-m)}),i.isDead=!1,i.onDeath(()=>{le()&&pe()&&i.mpEntityId&&$r({entityId:i.mpEntityId,entityType:"boss",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue})}),n==="swarmQueen"&&i.onDeath(()=>{const h=8+Math.floor((i.rng?i.rng.next():Math.random())*5);for(let u=0;u<h;u++){const p=Math.PI*2/h*u+(i.rng?i.rng.next():Math.random())*.3,g=40+(i.rng?i.rng.next():Math.random())*20,M=i.pos.x+Math.cos(p)*g,m=i.pos.y+Math.sin(p)*g,T=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",P=Rn(e,M,m,T,s);P.isBossMinion=!0}}),i.updateVisual(),le()&&pe()&&(Xo(i,{type:n,floor:s,isBoss:!0}),i.enemyType=n),i}function Em(e,t,o,n=1,s=null){const a=$i(e,t.pos.x,t.pos.y,"twinGuardianMelee",n,s),r=$i(e,o.pos.x,o.pos.y,"twinGuardianRanged",n,s);return a.twinPartner=r,r.twinPartner=a,a.onDeath(()=>{r&&r.exists()&&!r.enraged&&(r.enrage(),le()&&pe()&&tl(r.networkId))}),r.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enrage(),le()&&pe()&&tl(a.networkId))}),[a,r]}const Bn={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function Am(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const n=1+(t-1)*.1,a=Pt("propDropChance")*.05;for(const[r,l]of Object.entries(Bn)){const c=l.dropChance*n+a,d=Math.min(c,1);if(Math.random()<d)return r}return null}function Ma(e,t){const o=Bn[t];if(!o)return;const n=rr[o.weaponKey];if(n){if(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=o.weaponKey,e.weaponDef=n,e.fireRate=n.fireRate,e.projectileSpeed=n.projectileSpeed,e.projectileDamage=n.baseDamage,e.projectileCount=n.projectileCount,e.piercing=n.piercing,e.obstaclePiercing=n.obstaclePiercing,e.critChance=n.critChance,e.critDamage=n.critDamage,e.spreadAngle=n.spreadAngle,e.weaponRange=n.range,e.weaponCategory=n.category,n.orbitRadius&&(e.orbitRadius=n.orbitRadius,e.rotationSpeed=n.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),n.explosionRadius&&(e.explosionRadius=n.explosionRadius,e.explosionDamage=n.explosionDamage),n.chainRange&&(e.chainRange=n.chainRange,e.maxJumps=n.maxJumps,e.chainDamageReduction=n.chainDamageReduction),o.isAmmoBased)e.powerupAmmo=o.ammo,e.powerupDuration=null;else if(o.isTimeBased){const a=Pt("propDurability")*2;e.powerupDuration=o.duration+a,e.powerupAmmo=null}}}function cr(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function Sm(e,t=0){if(!e.powerupWeapon)return!1;const o=Bn[e.powerupWeapon];return o&&(o.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||o.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(le()&&pe()&&e.slotIndex!==void 0&&nl(e.slotIndex,e.powerupWeapon),cr(e),!0):!1}function Mm(e){if(!e.powerupWeapon)return;const t=Bn[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function Tm(e){if(!e.powerupWeapon)return null;const t=Bn[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function Xs(e,t,o,n){const s=e.add([e.text("+",{size:16}),e.pos(t,o),e.anchor("center"),e.color(...Vt.XP_COLOR),e.area(),e.scale(1),"xpPickup"]);return s.value=n,s.lifetime=Vt.XP_LIFETIME,s.age=0,s.collected=!1,s.magnetizing=!1,s.magnetizeSpeed=0,s.targetPlayer=null,s.isFlyingToUI=!1,s.velocityY=-150-Math.random()*100,s.gravity=600,s.groundY=o,s.bounceDamping=.5,s.bouncing=!0,s.onUpdate(()=>{if(s.isFlyingToUI){const l=e.vec2(e.width()/2,e.height()-18).sub(s.pos);l.len()<10?e.destroy(s):s.pos=s.pos.add(l.unit().scale(1e3*e.dt()));return}if(e.paused){const r=Math.sin(s.age*Vt.XP_PULSE_SPEED)*Vt.XP_PULSE_AMOUNT;s.scale=e.vec2(1+r);return}s.age+=e.dt();const a=Math.sin(s.age*Vt.XP_PULSE_SPEED)*Vt.XP_PULSE_AMOUNT;if(s.scale=e.vec2(1+a),!s.magnetizing&&s.bouncing&&(s.velocityY+=s.gravity*e.dt(),s.pos.y+=s.velocityY*e.dt(),s.pos.y>=s.groundY&&(s.pos.y=s.groundY,s.velocityY=-s.velocityY*s.bounceDamping,Math.abs(s.velocityY)<20&&(s.bouncing=!1,s.velocityY=0))),s.magnetizing&&s.targetPlayer&&s.targetPlayer.exists()){s.bouncing=!1;const r=e.vec2(s.targetPlayer.pos.x-s.pos.x,s.targetPlayer.pos.y-s.pos.y),l=r.len();if(l>0){const c=r.scale(1/l);s.magnetizeSpeed=Math.min(s.magnetizeSpeed+Vt.MAGNETIZE_ACCELERATION*e.dt(),Vt.MAGNETIZE_SPEED),s.pos=s.pos.add(c.scale(s.magnetizeSpeed*e.dt()))}}s.age>=s.lifetime&&e.destroy(s)}),s.pickupType="xp",le()&&pe()&&Vr(s,{type:"xpPickup",value:n}),le()&&s.onDestroy(()=>{Wr(s)}),s}const Jc=["$","","","","","","",""];function Bi(){return Jc[Math.floor(Math.random()*Jc.length)]}function Fs(e,t,o,n,s=null){const a=s||Bi(),r=e.add([e.text(a,{size:9}),e.pos(t,o),e.anchor("center"),e.color(...Vt.CURRENCY_COLOR),e.area(),e.scale(1),e.opacity(1),"currencyPickup"]);return r.value=n,r.lifetime=Vt.CURRENCY_LIFETIME,r.age=0,r.collected=!1,r.magnetizing=!1,r.magnetizeSpeed=0,r.targetPlayer=null,r.isFlyingToUI=!1,r.velocityY=-150-Math.random()*100,r.gravity=600,r.groundY=o,r.bounceDamping=.5,r.bouncing=!0,r.onUpdate(()=>{if(r.isFlyingToUI){const i=e.vec2(e.width()-20,20).sub(r.pos);i.len()<10?e.destroy(r):r.pos=r.pos.add(i.unit().scale(1e3*e.dt()));return}if(e.paused){const d=Math.sin(r.age*Vt.CURRENCY_PULSE_SPEED)*Vt.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+d);return}r.age+=e.dt();const l=Math.sin(r.age*Vt.CURRENCY_PULSE_SPEED)*Vt.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+l);const c=r.lifetime-r.age;if(c<=4&&c>0){const d=4+(4-c)*2,i=Math.sin(r.age*d*Math.PI*2);r.opacity=.65+i*.35,i>0?r.color=e.rgb(255,255,200):r.color=e.rgb(...Vt.CURRENCY_COLOR)}else r.opacity=1;if(!r.magnetizing&&r.bouncing&&(r.velocityY+=r.gravity*e.dt(),r.pos.y+=r.velocityY*e.dt(),r.pos.y>=r.groundY&&(r.pos.y=r.groundY,r.velocityY=-r.velocityY*r.bounceDamping,Math.abs(r.velocityY)<20&&(r.bouncing=!1,r.velocityY=0))),r.magnetizing&&r.targetPlayer&&r.targetPlayer.exists()){r.bouncing=!1;const d=e.vec2(r.targetPlayer.pos.x-r.pos.x,r.targetPlayer.pos.y-r.pos.y),i=d.len();if(i>0){const h=d.scale(1/i);r.magnetizeSpeed=Math.min(r.magnetizeSpeed+Vt.MAGNETIZE_ACCELERATION*e.dt(),Vt.MAGNETIZE_SPEED),r.pos=r.pos.add(h.scale(r.magnetizeSpeed*e.dt()))}}r.age>=r.lifetime&&e.destroy(r)}),r.pickupType="currency",le()&&pe()&&Vr(r,{type:"currencyPickup",value:n,icon:a}),le()&&r.onDestroy(()=>{Wr(r)}),r}function jc(e,t,o,n){const s=Bn[n];if(!s)return null;const a=e.add([e.text(s.icon,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...s.color),e.area(),e.scale(1),"powerupWeaponPickup"]);return a.powerupKey=n,a.lifetime=Vt.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.velocityY=-150-Math.random()*100,a.gravity=600,a.groundY=o,a.bounceDamping=.5,a.bouncing=!0,a.onUpdate(()=>{if(e.paused){const l=Math.sin(a.age*4)*.15;a.scale=e.vec2(1+l),a.angle=Math.sin(a.age*2)*10;return}a.age+=e.dt();const r=Math.sin(a.age*4)*.15;if(a.scale=e.vec2(1+r),a.angle=Math.sin(a.age*2)*10,!a.magnetizing&&a.bouncing&&(a.velocityY+=a.gravity*e.dt(),a.pos.y+=a.velocityY*e.dt(),a.pos.y>=a.groundY&&(a.pos.y=a.groundY,a.velocityY=-a.velocityY*a.bounceDamping,Math.abs(a.velocityY)<20&&(a.bouncing=!1,a.velocityY=0))),a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){a.bouncing=!1;const l=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),c=l.len();if(c>0){const d=l.scale(1/c);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+Vt.MAGNETIZE_ACCELERATION*e.dt(),Vt.MAGNETIZE_SPEED),a.pos=a.pos.add(d.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="powerup",le()&&pe()&&Vr(a),le()&&a.onDestroy(()=>{Wr(a)}),a}class pn{constructor(t){this.seed=t>>>0,this.originalSeed=this.seed}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}range(t,o){return o<=t?(console.warn(`SeededRandom.range: Invalid range [${t}, ${o}). Returning min.`),t):Math.floor(t+this.next()*(o-t))}rangeFloat(t,o){return t+this.next()*(o-t)}choose(t){if(!(!t||t.length===0))return t[this.range(0,t.length)]}shuffle(t){const o=[...t];for(let n=o.length-1;n>0;n--){const s=this.range(0,n+1);[o[n],o[s]]=[o[s],o[n]]}return o}probability(t){return this.next()<t}reset(){this.seed=this.originalSeed}getState(){return this.seed}setState(t){this.seed=t>>>0}}function Fr(...e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e[o]|0;return t>>>0}function Dm(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)|0;return t>>>0}const os={peers:new Map,localLatency:0,lastPingId:0,lastPingSentTime:0,handlersRegistered:!1};function Cm(){os.handlersRegistered||(os.handlersRegistered=!0,He("ping",(e,t)=>{pe()?qo(t,"pong",{pingId:e.pingId,serverTime:Date.now()}):lo("pong",{pingId:e.pingId,serverTime:Date.now()})}),He("pong",(e,t)=>{const o=Date.now(),n=e.pingId;if(pe()){const s=os.peers.get(t);if(s&&s.pingId===n){const a=o-s.lastPingTime;s.latency=a}}else os.lastPingId===n&&(os.localLatency=o-os.lastPingSentTime)}))}const wt={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10,lifesteal:5,dodgeChance:5,thorns:5,aoeSize:10,knockback:5,magnetRange:10,invulnTime:5,moveDamage:5,lowHealthDmg:5,killSpeed:5},gs={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${wt.damage})`:""}`,apply:e=>{const t=e.upgradeStacks?.damage||0,o=e.baseProjectileDamage||e.weaponDef?.baseDamage||10,n=Math.pow(1.25,t);e.projectileDamage=Math.floor(o*n)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${wt.fireRate})`:""}`,apply:e=>{const t=e.upgradeStacks?.fireRate||0,o=e.baseFireRate||e.weaponDef?.fireRate||1.5,n=Math.pow(1.2,t);e.fireRate=o*n}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${wt.speed})`:""}`,apply:e=>{const t=e.upgradeStacks?.speed||0,o=e.characterData?.stats?.speed||150,n=Math.pow(1.15,t);e.speed=Math.floor(o*n),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${wt.health})`:""}`,apply:e=>{const t=e.upgradeStacks?.health||0,o=e.characterData?.stats?.health||100,n=t*20,s=e.maxHealth;e.maxHealth=o+n;const a=e.maxHealth-s;a>0&&e.setHP(e.hp()+a)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${wt.projectileSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.projectileSpeed||0,o=e.baseProjectileSpeed||e.weaponDef?.projectileSpeed||300,n=Math.pow(1.25,t);e.projectileSpeed=Math.floor(o*n)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${wt.xpGain})`:""}`,apply:e=>{const t=e.upgradeStacks?.xpGain||0,o=e.characterData?.ability==="xpBoost"?1.1:1;e.xpMultiplier=o+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${wt.pickupRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.pickupRadius||0,o=30,n=Math.pow(1.5,t);e.pickupRadius=Math.floor(o*n)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${wt.multiShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.multiShot||0,o=e.weaponDef?.projectileCount||1;e.projectileCount=o+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${wt.piercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.piercing||0,o=e.weaponDef?.piercing||0;e.piercing=o+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${wt.obstaclePiercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.obstaclePiercing||0,o=e.weaponDef?.obstaclePiercing||0;e.obstaclePiercing=o+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${wt.critChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.critChance||0;let n=(e.weaponDef?.critChance||.05)+t*.1;e.characterData?.ability==="critBoost"&&(n*=1.5),e.critChance=n}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${wt.critDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.critDamage||0;let n=(e.weaponDef?.critDamage||2)+t*.5;e.characterData?.ability==="critBoost"&&(n*=1.25),e.critDamage=n}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${wt.spreadShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.spreadShot||0,o=e.weaponDef?.spreadAngle||0;e.spreadAngle=o+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${wt.pelletCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.pelletCount||0,o=e.weaponDef?.projectileCount||3;e.projectileCount=o+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${wt.range})`:""}`,apply:e=>{const t=e.upgradeStacks?.range||0,o=e.weaponDef?.range||600,n=Math.pow(1.25,t);e.weaponRange=Math.floor(o*n)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${wt.dot})`:""}`,apply:e=>{const t=e.upgradeStacks?.dot||0,o=e.characterData?.ability==="fireDot"?1.25:1;e.fireDotMultiplier=o+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${wt.orbitalCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalCount||0,o=e.weaponDef?.projectileCount||1;e.projectileCount=o+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${wt.orbitalSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalSpeed||0,o=e.weaponDef?.rotationSpeed||180,n=Math.pow(1.5,t);e.rotationSpeed=o*n}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${wt.orbitalRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalRadius||0,o=e.weaponDef?.orbitRadius||45,n=Math.pow(1.2,t);e.orbitRadius=Math.floor(o*n)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${wt.explosionRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionRadius||0,o=e.weaponDef?.explosionRadius||50,n=Math.pow(1.25,t);e.explosionRadius=Math.floor(o*n)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${wt.explosionDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionDamage||0,o=e.weaponDef?.explosionDamage||15,n=Math.pow(1.25,t);e.explosionDamage=Math.floor(o*n)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${wt.chainJumps})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainJumps||0,o=e.weaponDef?.maxJumps||3;e.maxJumps=o+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${wt.chainRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainRange||0,o=e.weaponDef?.chainRange||70,n=Math.pow(1.25,t);e.chainRange=Math.floor(o*n)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${wt.chainDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainDamage||0,o=e.weaponDef?.chainDamageReduction||.15;e.chainDamageReduction=Math.max(.05,o-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${wt.defense})`:""}`,apply:e=>{const t=e.upgradeStacks?.defense||0,o=e.characterData?.ability==="tankStats"?.15:0;e.defense=o+t*2}},lifesteal:{name:"Life Drain",icon:"",description:"Heal 2% of damage dealt",category:"passive",maxStacks:5,getDescription:e=>`Heal ${(e||1)*2}% of damage dealt${e>0?` (${e}/${wt.lifesteal})`:""}`,apply:e=>{const t=e.upgradeStacks?.lifesteal||0;e.lifestealPercent=t*.02}},dodgeChance:{name:"Evasion",icon:"",description:"+5% dodge chance",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% dodge chance${e>0?` (${e}/${wt.dodgeChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.dodgeChance||0,o=e.characterData?.ability==="dodgeChance"?.1:0;e.dodgeChance=o+t*.05}},thorns:{name:"Thorns",icon:"",description:"Reflect 15% damage to attackers",category:"passive",maxStacks:5,getDescription:e=>`Reflect ${(e||1)*15}% damage${e>0?` (${e}/${wt.thorns})`:""}`,apply:e=>{const t=e.upgradeStacks?.thorns||0;e.thornsPercent=t*.15}},aoeSize:{name:"Blast Radius",icon:"",description:"+15% explosion/area size",category:"weapon",upgradeCategory:"explosionRadius",maxStacks:10,getDescription:e=>`+${(e||1)*15}% AoE size${e>0?` (${e}/${wt.aoeSize})`:""}`,apply:e=>{const t=e.upgradeStacks?.aoeSize||0;if(e.aoeSizeMultiplier=1+t*.15,e.explosionRadius){const o=e.weaponDef?.explosionRadius||50;e.explosionRadius=Math.floor(o*e.aoeSizeMultiplier)}}},knockback:{name:"Impact Force",icon:"",description:"+20% knockback",category:"weapon",maxStacks:5,getDescription:e=>`+${(e||1)*20}% knockback${e>0?` (${e}/${wt.knockback})`:""}`,apply:e=>{const t=e.upgradeStacks?.knockback||0;e.knockbackMultiplier=1+t*.2}},magnetRange:{name:"Treasure Hunter",icon:"",description:"+25% pickup radius",category:"passive",maxStacks:10,getDescription:e=>`+${(e||1)*25}% pickup radius${e>0?` (${e}/${wt.magnetRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.magnetRange||0,o=30,n=e.upgradeStacks?.pickupRadius||0,s=Math.pow(1.5,n);e.pickupRadius=Math.floor(o*s*(1+t*.25))}},invulnTime:{name:"Iron Skin",icon:"",description:"+0.15s invulnerability frames",category:"passive",maxStacks:5,getDescription:e=>`+${((e||1)*.15).toFixed(2)}s invuln${e>0?` (${e}/${wt.invulnTime})`:""}`,apply:e=>{const t=e.upgradeStacks?.invulnTime||0,o=1;e.invulnerableDuration=o+t*.15}},moveDamage:{name:"Momentum",icon:"",description:"+2% damage per speed stack",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*2}% damage per speed stack${e>0?` (${e}/${wt.moveDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.moveDamage||0;e.moveDamageBonus=t*.02}},lowHealthDmg:{name:"Desperation",icon:"",description:"+5% damage per 10% missing HP",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% damage per 10% missing HP${e>0?` (${e}/${wt.lowHealthDmg})`:""}`,apply:e=>{const t=e.upgradeStacks?.lowHealthDmg||0;e.lowHealthDmgBonus=t*.05}},killSpeed:{name:"Bloodlust",icon:"",description:"+3% speed for 3s on kill",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*3}% speed for 3s on kill${e>0?` (${e}/${wt.killSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.killSpeed||0;e.killSpeedBonus=t*.03,e.killSpeedDuration=3,e.killSpeedStacks=0,e.killSpeedTimer=0}}};function Rm(e,t){if(e.category==="passive"){const o=t.upgradeStacks?.[e.key]||0,n=e.maxStacks||wt[e.key]||10;return!(o>=n)}if(e.category==="weapon"){const o=t.upgradeStacks?.[e.key]||0,n=e.maxStacks||wt[e.key]||10;if(o>=n)return!1;const s=t.characterData?.weapon||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(s):e.upgradeCategory?Qg(s,e.upgradeCategory):!0}return!0}function Im(e=3,t=null,o=null){let s=Object.keys(gs).map(c=>({key:c,...gs[c],type:"upgrade"})),a=s;t&&(a=s.filter(c=>Rm(c,t))),a.length<e&&(a=s);const r=[],l=new Set;for(;r.length<e&&r.length<a.length;){const c=o?o.range(0,a.length):Math.floor(Math.random()*a.length),d=a[c];l.has(d.key)||(l.add(d.key),r.push(d))}return r}function Yr(e,t){const o=gs[t];o&&(o.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,Ji(e))}function Ji(e){Object.keys(gs).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&gs[t].apply(e)})}function Pm(e,t){if(!e)return"";if(e.getDescription){const o=t?.upgradeStacks?.[e.key]||0;return e.getDescription(o)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const zn={BUTTON:{SM:{width:120,height:30},MD:{width:160,height:36},LG:{width:280,height:45},XL:{width:320,height:50}}},Z={H1:24,H2:18,BODY:16,SMALL:14,TINY:12,MICRO:11,TITLE:36,HEADER:24,LABEL:18,BUTTON:20,HUD:16},y={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},ns={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},Li={HEALTH:"HP",FLOOR:"Floor",DAMAGE:"Damage",SPEED:"Speed"};function ni(e){return e.toUpperCase()}function Zc(e,t){return`${e}/${t}`}const b={BACKGROUND:0,GAME_ENTITIES:10,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1500,TOOLTIP:2e3,PAUSE_MENU:2001,DEBUG:9999},Is=["$","","","","","","",""];function li(e,t={}){const{patternCount:o=12,particleCount:n=20,includeCursorFollowers:s=!1}=t,a=["","","","","","","",""];for(let r=0;r<o;r++){const l=e.add([e.text(a[Math.floor(Math.random()*a.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.15),e.scale(1),e.z(b.PARTICLES)]);l.pulseTime=Math.random()*Math.PI*2,l.pulseSpeed=1+Math.random()*2,l.onUpdate(()=>{l.pulseTime+=e.dt()*l.pulseSpeed;const c=.8+Math.sin(l.pulseTime)*.3;l.scale=e.vec2(c,c),l.opacity=.1+Math.abs(Math.sin(l.pulseTime))*.15})}for(let r=0;r<n;r++){const l=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(b.PARTICLES)]);l.speed=10+Math.random()*20,l.onUpdate(()=>{l.pos.y+=l.speed*e.dt(),l.pos.y>e.height()&&(l.pos.y=0,l.pos.x=Math.random()*e.width())})}if(s){const r=[];e.loop(5,()=>{if(r.length<3&&Math.random()<.3){const l=["","","","","","",""],c=e.add([e.text(l[Math.floor(Math.random()*l.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(b.PARTICLES)]);c.followSpeed=20+Math.random()*30,c.rotationSpeed=50+Math.random()*100,c.lifetime=15+Math.random()*10,c.onUpdate(()=>{const i=e.mousePos().sub(c.pos),h=i.len();if(h>5){const u=i.scale(1/h);c.pos=c.pos.add(u.scale(c.followSpeed*e.dt()))}if(c.angle+=c.rotationSpeed*e.dt(),c.lifetime-=e.dt(),c.lifetime<=0){e.destroy(c);const u=r.indexOf(c);u>-1&&r.splice(u,1)}}),r.push(c)}})}}const Bm={CONTESTANTS:["           ","    ","                              ","                            ","                      ","                           "],MERCH:["       ","   ","       ","       ","      ","          "],OPTIONS:["        ","  ","             ","             ","            ","                 "],"RATINGS AND RECORDS":["                           ","            ","                               ","                              ","                         ","                                  "],PROFILE:["         ","     ","            ","             ","            ","              "]};function di(e,t,o,n,s=8){function a(u,p,g){p/=100,g/=100;const M=(1-Math.abs(2*g-1))*p,m=M*(1-Math.abs(u/60%2-1)),T=g-M/2;let P=0,f=0,N=0;return u>=0&&u<60?(P=M,f=m,N=0):u>=60&&u<120?(P=m,f=M,N=0):u>=120&&u<180?(P=0,f=M,N=m):u>=180&&u<240?(P=0,f=m,N=M):u>=240&&u<300?(P=m,f=0,N=M):u>=300&&u<360&&(P=M,f=0,N=m),[Math.round((P+T)*255),Math.round((f+T)*255),Math.round((N+T)*255)]}const r=ni(t),l=Bm[r];if(!l){console.warn(`ASCII art not found for "${r}", using plain text`);const u=e.add([e.text(r,{size:s*2,font:"monospace"}),e.pos(o,n),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"animatedTitle"]);let p=0;return u.onUpdate(()=>{p+=e.dt();const g=p*50%360,M=a(g,80,60);u.color=e.rgb(...M);const m=Math.sin(p*2)*2;u.pos.y=n+m}),[u]}const c=[],d=10,i=n-l.length*d/2;l.forEach((u,p)=>{const g=e.add([e.text(u,{size:s,font:"monospace"}),e.pos(o,i+p*d),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"animatedTitle"]);c.push(g)});let h=0;return e.onUpdate(()=>{h+=e.dt(),c.forEach((u,p)=>{const g=(h*50+p*20)%360,M=a(g,80,60);u.color=e.rgb(...M);const m=Math.sin(h*2+p*.3)*2;u.pos.y=i+p*d+m,Math.random()<.001&&(u.pos.x=o+(Math.random()-.5)*10,e.wait(.1,()=>{u.exists()&&(u.pos.x=o)}))})}),c}function qr(e,t,o){const n=()=>2+Math.random()*3,s=e.add([e.text(`${Is[0]}: ${t}`,{size:Z.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),a=s.width+30,r=40;e.destroy(s);const l=e.add([e.rect(a,r),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(b.UI_BACKGROUND)]),c=e.add([e.text(`${Is[0]}: ${t}`,{size:Z.LABEL}),e.pos(e.width()-20-a/2,40),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);c.symbolIndex=0,c.timeSinceLastChange=0,c.currentCurrency=t,c.symbolChangeInterval=n();const d=i=>{c.currentCurrency=i,c.text=`${Is[c.symbolIndex]}: ${i}`;const h=c.width+30;Math.abs(h-a)>10&&(l.width=h,c.pos.x=e.width()-20-h/2)};return c.onUpdate(()=>{c.timeSinceLastChange+=e.dt(),c.timeSinceLastChange>=c.symbolChangeInterval&&(c.timeSinceLastChange=0,c.symbolIndex=(c.symbolIndex+1)%Is.length,c.text=`${Is[c.symbolIndex]}: ${c.currentCurrency}`,c.symbolChangeInterval=n())}),{panel:l,text:c,updateCurrency:d}}const pt={queue:[],activeToasts:[],k:null,maxActiveToasts:3,toastWidth:300,toastHeight:80,toastMargin:10,animationDuration:.3,displayDuration:3};function Gr(e){pt.k=e,pt.queue=[],pt.activeToasts=[]}function ph(e){if(!pt.k){console.warn("Toast system not initialized");return}const o={title:e.title||"Notification",message:e.message||"",icon:e.icon||"!",iconColor:e.iconColor||y.TEXT_PRIMARY,type:e.type||"info",duration:e.duration||pt.displayDuration};pt.queue.push(o),gh()}function Lm(e){const t=Oo[e.difficulty]||Oo.normal;let o=" Achievement Unlocked!";e.difficulty==="challenge"?o=" Challenge Complete!":e.difficulty==="benchmark"&&(o=" Milestone Reached!"),ph({title:o,message:`${e.name}
${e.description}`,icon:e.icon,iconColor:t,type:"achievement",duration:5,difficulty:e.difficulty})}function zm(e,t){const o=Oo[t.difficulty]||Oo.normal;ph({title:`${e} unlocked:`,message:t.name,icon:t.icon,iconColor:o,type:"achievement",duration:3})}function gh(){if(pt.k)for(;pt.queue.length>0&&pt.activeToasts.length<pt.maxActiveToasts;){const t=pt.queue.shift();Om(t)}}function Om(e){const t=pt.k;if(!t)return;const o=t.width()+pt.toastWidth,n=t.width()-pt.toastMargin-pt.toastWidth/2,s=pt.activeToasts.length,a=pt.toastMargin+s*(pt.toastHeight+pt.toastMargin)+pt.toastHeight/2+20;let r=y.BORDER,l=[...y.BG_MEDIUM],c=2;e.type==="achievement"?(r=e.iconColor,l=[35,30,45],c=3):e.type==="success"?r=y.SUCCESS:e.type==="error"&&(r=y.ERROR);const d=t.add([t.rect(pt.toastWidth,pt.toastHeight),t.pos(o,a),t.anchor("center"),t.color(...l),t.outline(c,t.rgb(...r)),t.opacity(.95),t.fixed(),t.z(b.TOOLTIP),"toast"]);if(e.type==="achievement"){let P=0;d.onUpdate(()=>{P+=t.dt();const f=Math.sin(P*4)*.2+.8,N=Math.min(255,r[0]*f),O=Math.min(255,r[1]*f),w=Math.min(255,r[2]*f);d.outline.color=t.rgb(N,O,w)})}const i=t.add([t.rect(50,pt.toastHeight-10),t.pos(o-pt.toastWidth/2+30,a),t.anchor("center"),t.color(...l),t.opacity(.5),t.fixed(),t.z(b.TOOLTIP+1),"toast"]),h=e.type==="achievement"?32:28,u=t.add([t.text(e.icon,{size:h}),t.pos(o-pt.toastWidth/2+30,a),t.anchor("center"),t.color(...e.iconColor),t.fixed(),t.z(b.TOOLTIP+2),"toast"]);if(e.type==="achievement"){let P=0;const f=a;u.onUpdate(()=>{P+=t.dt();const N=Math.abs(Math.sin(P*3))*3;u.pos.y=f-N})}const p=t.add([t.text(e.title,{size:14}),t.pos(o-pt.toastWidth/2+65,a-20),t.anchor("left"),t.color(...e.type==="achievement"?[255,220,100]:y.TEXT_PRIMARY),t.fixed(),t.z(b.TOOLTIP+2),"toast"]),g=e.message.split(`
`),M=[];g.forEach((P,f)=>{const N=t.add([t.text(P,{size:12,width:pt.toastWidth-80}),t.pos(o-pt.toastWidth/2+65,a-5+f*16),t.anchor("left"),t.color(...y.TEXT_SECONDARY),t.fixed(),t.z(b.TOOLTIP+2),"toast"]);M.push(N)});const m={container:d,iconBg:i,icon:u,title:p,messages:M,startX:o,targetX:n,y:a,state:"entering",timer:0,data:e};pt.activeToasts.push(m);const T=t.onUpdate(()=>{if(m.state==="done"){T.cancel();return}if(m.timer+=t.dt(),m.state==="entering"){const P=Math.min(m.timer/pt.animationDuration,1),f=Nm(P),N=kc(m.startX,m.targetX,f);Qc(m,N),P>=1&&(m.state="visible",m.timer=0)}else if(m.state==="visible")m.timer>=m.data.duration&&(m.state="exiting",m.timer=0);else if(m.state==="exiting"){const P=Math.min(m.timer/pt.animationDuration,1),f=_m(P),N=t.width()+pt.toastWidth,O=kc(m.targetX,N,f);Qc(m,O);const w=1-P;m.container.opacity=w*.95,m.iconBg.opacity=w*.5,m.icon.opacity=w,m.title.opacity=w,m.messages.forEach(A=>A.opacity=w),P>=1&&(m.state="done",Hm(m))}});m.updateHandler=T}function Qc(e,t){const o=t-e.container.pos.x;e.container.pos.x=t,e.iconBg.pos.x+=o,e.icon.pos.x+=o,e.title.pos.x+=o,e.messages.forEach(n=>n.pos.x+=o)}function Hm(e){const t=pt.k;if(!t)return;e.updateHandler&&e.updateHandler.cancel(),e.container.exists()&&t.destroy(e.container),e.iconBg.exists()&&t.destroy(e.iconBg),e.icon.exists()&&t.destroy(e.icon),e.title.exists()&&t.destroy(e.title),e.messages.forEach(n=>{n.exists()&&t.destroy(n)});const o=pt.activeToasts.indexOf(e);o>-1&&pt.activeToasts.splice(o,1),Um(),gh()}function Um(){pt.activeToasts.forEach((e,t)=>{if(e.state==="visible"||e.state==="entering"){const o=pt.toastMargin+t*(pt.toastHeight+pt.toastMargin)+pt.toastHeight/2+20,n=e.container.pos.y,s=o-n;e.container.pos.y=o,e.iconBg.pos.y+=s,e.icon.pos.y+=s,e.title.pos.y+=s,e.messages.forEach((a,r)=>{a.pos.y+=s}),e.y=o}})}function Nm(e){return 1-Math.pow(1-e,3)}function _m(e){return e*e*e}function kc(e,t,o){return e+(t-e)*o}const z={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/15,lastResyncTime:0,resyncInterval:5,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null,gameSeed:0,floorRng:null,roomRng:null,currentFloor:1,currentRoom:{x:0,y:0},pendingXP:0,onGameSeedCallback:null};function Xm(e,t=0,o=null,n=null){z.isActive=!0,z.isHost=e,z.localPlayerSlot=t,z.players.clear(),z.inputBuffer=[],z.lastSyncTime=0,z.k=o,Cm(),z.enemies.clear(),z.projectiles.clear(),z.pickups.clear(),z.nextEntityId=1,n!==null?z.gameSeed=n:e&&(z.gameSeed=Math.floor(Math.random()*4294967295)),z.floorRng=new pn(z.gameSeed),z.currentFloor=1,z.currentRoom={x:0,y:0},e?Fm():(ji=!1,Ym())}function Fm(){lr||(lr=!0,He("player_input",(e,t)=>{if(!e||typeof e!="object")return;const o=fs(),n=o.slots.findIndex(s=>s.peerId===t);if(n!==-1&&z.players.has(n)){const s=z.players.get(n);if(!s||!s.exists())return;if(e.move&&typeof e.move=="object"){const a=Math.max(-1,Math.min(1,Number(e.move.x)||0)),r=Math.max(-1,Math.min(1,Number(e.move.y)||0));s.move={x:a,y:r}}if(e.shoot!==void 0&&(s.isShooting=!!e.shoot),e.aimAngle!==void 0){const a=Number(e.aimAngle)||0;s.aimAngle=Math.max(-360,Math.min(360,a))}}else console.warn("[Multiplayer] Could not find player for peer:",t,"slot:",n),console.warn("[Multiplayer] Party slots:",o.slots),console.warn("[Multiplayer] Registered players:",Array.from(z.players.keys()))}),He("pause_request",(e,t)=>{z.k&&(z.k.paused=e.paused,z.k.gameData&&z.k.gameData.updatePauseUI&&z.k.gameData.updatePauseUI(e.paused),Ge("pause_state",{paused:e.paused}))}),He("player_death",(e,t)=>{const o=z.players.get(e.slotIndex);o&&o.exists()&&(o.isDead=!0,o.canMove=!1,o.canShoot=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5),Ge("player_death",{slotIndex:e.slotIndex},[t]))}),He("enemy_death",(e,t)=>{Ge("entity_destroyed",{entityId:e.entityId,entityType:e.entityType,x:e.x,y:e.y})}),He("resync_request",(e,t)=>{qo(t,"game_state",Kr())}),He("level_up_queued",(e,t)=>{Ge("level_up_queued",{slotIndex:e.slotIndex,level:e.level,timestamp:Date.now()})}),He("player_emote",(e,t)=>{Ge("player_emote",e)}),He("upgrade_selected",(e,t)=>{const o=z.players.get(e.slotIndex);o&&o.exists()&&(Yr(o,e.upgradeKey),o.upgradeStacks||(o.upgradeStacks={}),o.upgradeStacks[e.upgradeKey]=(o.upgradeStacks[e.upgradeKey]||0)+1,o.selectedUpgrades||(o.selectedUpgrades=new Set),o.selectedUpgrades.add(e.upgradeKey),Ji(o)),Ge("upgrade_selected",{slotIndex:e.slotIndex,upgradeKey:e.upgradeKey,timestamp:Date.now()})}),He("synergy_activated",(e,t)=>{Ge("synergy_activated",{slotIndex:e.slotIndex,synergies:e.synergies,timestamp:Date.now()})}),He("achievement_unlocked",(e,t)=>{Ge("achievement_unlocked",{achievementId:e.achievementId,playerSlotIndex:e.playerSlotIndex,playerName:e.playerName})}))}let ji=!1,lr=!1;function Ym(){ji||(ji=!0,He("game_state",e=>{if(z.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==z.localPlayerSlot){const o=z.players.get(t.slotIndex);o&&o.exists()&&(o.netTarget?(o.netTarget.x=t.x,o.netTarget.y=t.y):o.netTarget={x:t.x,y:t.y},o.angle=t.angle||0,o.outline&&o.outline.exists()&&(o.outline.angle=o.angle),t.maxHealth!==void 0&&(o.maxHealth=t.maxHealth),t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.invulnerable!==void 0&&(o.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(o.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(o.isDead=t.isDead,o.isDead?(o.canShoot=!1,o.canMove=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5)):(o.canShoot=!0,o.canMove=!0,o.opacity=1,o.outline&&o.outline.exists()&&(o.outline.opacity=1))),t.weapons&&(o.weapons=t.weapons),t.passiveUpgrades&&(o.passiveUpgrades=t.passiveUpgrades),t.upgradeStacks&&(o.upgradeStacks=t.upgradeStacks),t.speed!==void 0&&(o.speed=t.speed),t.damage!==void 0&&(o.damage=t.damage),t.pickupRadius!==void 0&&(o.pickupRadius=t.pickupRadius),t.runStats&&(o.runStats||(o.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),o.runStats.kills=t.runStats.kills,o.runStats.creditsPickedUp=t.runStats.creditsPickedUp,o.runStats.bossesKilled=t.runStats.bossesKilled))}else{const o=z.players.get(z.localPlayerSlot);o&&o.exists()&&(t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.maxHealth!==void 0&&(o.maxHealth=t.maxHealth),t.invulnerable!==void 0&&(o.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(o.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(o.isDead=t.isDead,o.isDead?(o.canShoot=!1,o.canMove=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5)):(o.canShoot=!0,o.canMove=!0,o.opacity=1,o.outline&&o.outline.exists()&&(o.outline.opacity=1))),t.runStats&&(o.runStats||(o.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),o.runStats.kills=t.runStats.kills,o.runStats.creditsPickedUp=t.runStats.creditsPickedUp,o.runStats.bossesKilled=t.runStats.bossesKilled))}}),e.enemies){const t=new Set;e.enemies.forEach(o=>{t.add(o.id);const n=z.enemies.get(o.id);n&&n.exists()&&(n.netTarget?(n.netTarget.x=o.x,n.netTarget.y=o.y):n.netTarget={x:o.x,y:o.y},o.maxHealth!==void 0&&(n.maxHealth=o.maxHealth),n.setHP&&o.hp!==void 0&&n.setHP(o.hp),o.shieldHealth!==void 0&&(n.shieldHealth=o.shieldHealth),o.armorHealth!==void 0&&(n.armorHealth=o.armorHealth),n.updateVisual&&n.updateVisual())}),z.enemies.forEach((o,n)=>{!t.has(n)&&o.exists()&&(o.cleanupHealthBars&&typeof o.cleanupHealthBars=="function"&&o.cleanupHealthBars(),z.k.destroy(o),z.enemies.delete(n))})}if(e.pickups){const t=new Set;e.pickups.forEach(o=>{t.add(o.id);const n=z.pickups.get(o.id);if(n&&n.exists()){if(n.pos.x=o.x,n.pos.y=o.y,o.magnetizing!==void 0)if(n.magnetizing=o.magnetizing,o.magnetizing&&o.targetPlayerSlot!==void 0){const s=z.players.get(o.targetPlayerSlot);s&&s.exists()?n.targetPlayer=s:(n.magnetizing=!1,n.targetPlayer=null)}else o.magnetizing||(n.targetPlayer=null);o.isFlyingToUI!==void 0&&(n.isFlyingToUI=o.isFlyingToUI)}}),z.pickups.forEach((o,n)=>{!t.has(n)&&o.exists()&&(z.k.destroy(o),z.pickups.delete(n))})}}}),He("spawn_entity",e=>{if(z.k){if(e.entityType==="enemy"){let t;e.isBoss?t=$i(z.k,e.x,e.y,e.type,e.floor):t=Rn(z.k,e.x,e.y,e.type,e.floor),t.mpEntityId=e.id,e.isBossMinion&&(t.isBossMinion=!0),z.enemies.set(e.id,t)}else if(e.entityType==="xpPickup"){const t=Xs(z.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",z.pickups.set(e.id,t)}else if(e.entityType==="currencyPickup"){const t=Fs(z.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",z.pickups.set(e.id,t)}}}),He("spawn_projectile",e=>{if(!z.k)return;const t=z.k.vec2(e.directionX,e.directionY),o=To(z.k,e.x,e.y,t,e.speed,e.damage,e.piercing,e.obstaclePiercing,e.isCrit,e.maxRange);(e.char||e.color)&&(o.text=e.char,e.color&&(o.color=z.k.rgb(...e.color))),o.mpEntityId=e.id,z.projectiles.set(e.id,o)}),He("damage_dealt",e=>{if(!z.k)return;const t=z.k.add([z.k.text(e.damage.toString(),{size:e.isCrit?24:18}),z.k.pos(e.x,e.y),z.k.anchor("center"),z.k.color((e.isCrit,255),e.isCrit?200:255,e.isCrit?0:255),z.k.opacity(1),z.k.lifespan(.8),z.k.z(1e3)]);t.onUpdate(()=>{t.exists()&&(t.pos.y-=50*z.k.dt(),t.opacity-=1.25*z.k.dt())});const o=z.enemies.get(e.targetId);if(o&&o.exists()){const n=o.color;o.color=z.k.rgb(255,255,255),z.k.wait(.1,()=>{o.exists()&&(o.color=n)})}}),He("entity_destroyed",e=>{if(!z.k)return;const t=z.enemies.get(e.entityId)||z.pickups.get(e.entityId);t&&t.exists()&&(t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),z.k.destroy(t),(e.entityType==="pickup"||e.entityType==="xpPickup"||e.entityType==="currencyPickup")&&z.pickups.delete(e.entityId)),z.enemies.delete(e.entityId),z.projectiles.delete(e.entityId),z.pickups.delete(e.entityId)}),He("boss_enrage",e=>{if(!z.k)return;const t=z.enemies.get(e.networkId);t&&t.exists()&&t.enrage&&t.enrage()}),He("players_revived",e=>{if(!z.k)return;const o=.05+Pt("secondWind")*.05;z.players.forEach((n,s)=>{if(n&&n.exists()&&(n.hp()<=0||n.isDead)){const a=Math.max(1,Math.floor(n.maxHealth*o));n.setHP(a),n.isDead=!1,s===z.localPlayerSlot&&(n.canMove=!0,n.canShoot=!0);const r=Math.round(o*100),l=z.k.add([z.k.text(` REVIVED (${r}% HP) `,{size:16}),z.k.pos(n.pos.x,n.pos.y-40),z.k.anchor("center"),z.k.color(100,255,100),z.k.opacity(1),z.k.lifespan(2),z.k.z(1e3)]);l.onUpdate(()=>{l.exists()&&(l.pos.y-=30*z.k.dt(),l.opacity-=.5*z.k.dt())}),n.opacity=1,n.characterData&&(n.color=z.k.rgb(...n.characterData.color)),n.outline&&n.outline.exists()&&(n.outline.opacity=1)}})}),He("game_seed",e=>{z.gameSeed=e.seed,z.floorRng=new pn(z.gameSeed),e.roomTemplateKey&&(z.firstRoomTemplateKey=e.roomTemplateKey,console.log("[Multiplayer] Client received first room template:",e.roomTemplateKey)),z.onGameSeedCallback&&(z.onGameSeedCallback(),z.onGameSeedCallback=null)}),He("pause_state",e=>{z.k&&(z.k.paused=e.paused,z.k.gameData&&z.k.gameData.updatePauseUI&&z.k.gameData.updatePauseUI(e.paused))}),He("xp_gain",e=>{const t=z.players.get(z.localPlayerSlot);t&&t.exists()&&!t.isDead&&t.addXP?t.addXP(e.value):z.pendingXP+=e.value}),He("currency_gain",e=>{ds(e.value)}),He("enemy_split",e=>{z.k&&z.k.gameData&&z.k.gameData.incrementSplitEnemies&&z.k.gameData.incrementSplitEnemies(e.count)}),He("player_death",e=>{const t=z.players.get(e.slotIndex);t&&t.exists()&&(t.isDead=!0,t.canMove=!1,t.canShoot=!1,t.isShooting=!1,t.opacity=.5,t.outline&&t.outline.exists()&&(t.outline.opacity=.5))}),He("player_disconnected",e=>{const t=z.players.get(e.slotIndex);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),z.k.destroy(t),z.players.delete(e.slotIndex))}),He("host_quit",e=>{rs(),z.k&&z.k.go("menu")}),He("achievement_unlocked",e=>{if(e.playerSlotIndex!==z.localPlayerSlot){const t=an[e.achievementId];t&&z.k&&(Gr(z.k),zm(e.playerName,t))}}))}function el(e,t){z.players.set(e,t),t.mpSlotIndex=e}function qm(e){const t=z.players.get(e);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),z.k&&z.k.destroy(t),z.players.delete(e),z.isHost&&Gm(e))}function Gm(e){z.isHost&&Ge("player_disconnected",{slotIndex:e})}function Km(e){if(z.isActive)if(z.lastSyncTime+=e,z.lastResyncTime+=e,z.isHost)z.lastSyncTime>=z.syncInterval&&(Vm(),z.lastSyncTime=0),z.lastResyncTime>=z.resyncInterval&&(z.players.forEach((t,o)=>{t&&t.exists()&&(t.isDead&&t.hp()>0&&(console.warn("[Multiplayer] Desync detected: Player",o,"is marked dead but has HP. Correcting..."),t.setHP(0)),!t.isDead&&t.hp()<=0&&(console.warn("[Multiplayer] Desync detected: Player",o,"has no HP but not marked dead. Correcting..."),t.isDead=!0,t.canMove=!1,t.canShoot=!1))}),z.lastResyncTime=0);else{if(z.lastSyncTime>=z.syncInterval&&(Jm(),z.lastSyncTime=0),z.lastResyncTime>=z.resyncInterval){let o=!1;z.players.forEach((n,s)=>{n&&n.exists()&&(n.isDead&&n.hp()>0&&(console.warn("[Multiplayer] Client desync: Player",s,"is dead but has HP"),o=!0),!n.isDead&&n.hp()<=0&&(console.warn("[Multiplayer] Client desync: Player",s,"has no HP but not dead"),o=!0))}),o&&Ey(),z.lastResyncTime=0}const t=Math.min(e*10,1);z.players.forEach(o=>{o.exists()&&o.isRemote&&o.netTarget&&(o.pos.x+=(o.netTarget.x-o.pos.x)*t,o.pos.y+=(o.netTarget.y-o.pos.y)*t)}),z.enemies.forEach(o=>{o.exists()&&o.netTarget&&(o.pos.x+=(o.netTarget.x-o.pos.x)*t,o.pos.y+=(o.netTarget.y-o.pos.y)*t)})}}function Kr(){const e=[],t=[],o=[],n=[];return z.players.forEach((s,a)=>{if(s.exists()){let r=[],l=[],c={};try{s.weapons&&(r=JSON.parse(JSON.stringify(s.weapons))),s.passiveUpgrades&&(l=JSON.parse(JSON.stringify(s.passiveUpgrades))),s.upgradeStacks&&(c=JSON.parse(JSON.stringify(s.upgradeStacks)))}catch(i){console.warn("Failed to serialize player upgrades:",i)}let d=s.maxHealth;s.hp&&typeof s.hp=="function"?d=s.hp():typeof s.hp=="number"&&(d=s.hp),e.push({slotIndex:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),angle:Number(s.angle||0),hp:Number(d),maxHealth:Number(s.maxHealth||100),level:Number(s.level||1),xp:Number(s.xp||0),isDead:!!s.isDead,weapons:r,passiveUpgrades:l,upgradeStacks:c,speed:Number(s.speed||0),damage:Number(s.damage||0),pickupRadius:Number(s.pickupRadius||0),invulnerable:!!s.invulnerable,invulnerableTime:Number(s.invulnerableTime||0),runStats:s.runStats?{kills:Number(s.runStats.kills||0),creditsPickedUp:Number(s.runStats.creditsPickedUp||0),bossesKilled:Number(s.runStats.bossesKilled||0)}:null})}}),z.enemies.forEach((s,a)=>{if(s.exists()){let r=0;s.hp&&typeof s.hp=="function"?r=s.hp():typeof s.hp=="number"&&(r=s.hp),t.push({id:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),hp:Number(r),maxHealth:Number(s.maxHealth||0),type:String(s.enemyType||"basic"),shieldHealth:Number(s.shieldHealth||0),armorHealth:Number(s.armorHealth||0)})}else z.enemies.delete(a)}),z.projectiles.forEach((s,a)=>{s.exists()||z.projectiles.delete(a)}),z.pickups.forEach((s,a)=>{if(s.exists()){const r={id:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),type:String(s.pickupType||"xp"),magnetizing:!!s.magnetizing,isFlyingToUI:!!s.isFlyingToUI};s.magnetizing&&s.targetPlayer&&s.targetPlayer.slotIndex!==void 0&&(r.targetPlayerSlot=Number(s.targetPlayer.slotIndex)),n.push(r)}else z.pickups.delete(a)}),{players:e,enemies:t,projectiles:o,pickups:n}}function Vm(){z.isHost&&Ge("game_state",Kr())}function Wm(e){!z.isHost||!z.isActive||(console.log("Sending initial game state to new joiner:",e),qo(e,"game_state",Kr()),$m(e))}function $m(e){!z.isHost||!z.isActive||!z.k||(z.k,console.log("[Multiplayer] Sending existing entities to new joiner:",e),z.enemies.forEach((t,o)=>{if(t&&t.exists()){const n={entityId:o,entityType:"enemy",x:t.pos.x,y:t.pos.y,enemyType:t.type||"basic",floor:t.floor||1,isBoss:t.is("boss")||!1,isMiniboss:t.is("miniboss")||!1,health:t.hp(),maxHealth:t.maxHealth,armorHealth:t.armorHealth||0,shieldHealth:t.shieldHealth||0};qo(e,"spawn_entity",n)}}),z.pickups.forEach((t,o)=>{if(t&&t.exists()){const n={entityId:o,entityType:"pickup",x:t.pos.x,y:t.pos.y,pickupType:t.pickupType||(t.is("xpPickup")?"xp":t.is("currencyPickup")?"currency":"powerup"),xpValue:t.xpValue||0,currencyValue:t.currencyValue||0};qo(e,"spawn_entity",n)}}),console.log("[Multiplayer] Sent",z.enemies.size,"enemies and",z.pickups.size,"pickups to new joiner"))}function Jm(){if(z.isHost)return;const e=z.players.get(z.localPlayerSlot);if(!e||!e.exists())return;const t=e.moveDir?{x:Number(e.moveDir.x||0),y:Number(e.moveDir.y||0)}:{x:0,y:0};lo("player_input",{slotIndex:Number(z.localPlayerSlot),move:t,shoot:!!e.isShooting,aimAngle:Number(e.aimAngle||0)})}function le(){return z.isActive}function jm(){return z.players.size}function rs(){z.isActive=!1,z.players.clear(),z.inputBuffer=[],z.enemies.clear(),z.projectiles.clear(),z.pickups.clear(),z.nextEntityId=1,Ot("player_input"),Ot("pause_request"),Ot("player_death"),Ot("enemy_death"),Ot("resync_request"),Ot("level_up_queued"),Ot("player_emote"),Ot("upgrade_selected"),Ot("synergy_activated"),Ot("achievement_unlocked"),Ot("game_state"),Ot("spawn_entity"),Ot("spawn_projectile"),Ot("damage_dealt"),Ot("entity_destroyed"),Ot("boss_enrage"),Ot("players_revived"),Ot("game_seed"),Ot("pause_state"),Ot("xp_gain"),Ot("currency_gain"),Ot("enemy_split"),Ot("player_disconnected"),Ot("host_quit"),bm(),ji=!1,lr=!1}function Xo(e,t={}){if(!z.isHost)return null;const o=z.nextEntityId++;return e.mpEntityId=o,z.enemies.set(o,e),Ge("spawn_entity",{id:o,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1,isBoss:t.isBoss||!1,isBossMinion:t.isBossMinion||!1}),o}function cs(e,t={}){if(!z.isHost)return null;const o=z.nextEntityId++;e.mpEntityId=o,z.projectiles.set(o,e);let n=[255,255,100];return e.color&&e.color.r!==void 0&&(n=[Math.round(e.color.r),Math.round(e.color.g),Math.round(e.color.b)]),Ge("spawn_projectile",{id:Number(o),x:Number(e.pos.x),y:Number(e.pos.y),directionX:Number(e.direction.x),directionY:Number(e.direction.y),speed:Number(e.speed),damage:Number(e.damage),piercing:Number(e.piercing||0),obstaclePiercing:Number(e.obstaclePiercing||0),isCrit:!!e.isCrit,maxRange:Number(e.maxRange),angle:Number(e.angle||0),char:e.text||t.char||"*",color:n}),o}function Zm(e){z.isActive&&e.mpEntityId!==void 0&&z.projectiles.delete(e.mpEntityId)}function Vr(e,t={}){if(!z.isHost)return null;const o=z.nextEntityId++;e.mpEntityId=o,z.pickups.set(o,e);const n={id:o,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(n.icon=t.icon),Ge("spawn_entity",n),o}function Wr(e){z.isActive&&e.mpEntityId!==void 0&&z.pickups.delete(e.mpEntityId)}function pe(){return z.isHost}function Qm(e){!z.isHost||!z.isActive||Ge("damage_dealt",{targetId:Number(e.targetId),targetType:String(e.targetType),damage:Number(e.damage),isCrit:!!e.isCrit,attackerId:e.attackerId!==void 0?Number(e.attackerId):null,x:Number(e.x),y:Number(e.y)})}function mh(e){!z.isHost||!z.isActive||Ge("player_healed",{slotIndex:Number(e.slotIndex),healAmount:Number(e.healAmount),newHP:Number(e.newHP),source:String(e.source||"unknown")})}function Ta(e){!z.isHost||!z.isActive||Ge("player_dodged",{slotIndex:Number(e.slotIndex),x:Number(e.x),y:Number(e.y)})}function $r(e){!z.isHost||!z.isActive||Ge("entity_destroyed",{entityId:Number(e.entityId),entityType:String(e.entityType),x:Number(e.x),y:Number(e.y),xpDropped:e.xpDropped!==void 0?Number(e.xpDropped):0,currencyDropped:e.currencyDropped!==void 0?Number(e.currencyDropped):0})}function tl(e){!z.isHost||!z.isActive||Ge("boss_enrage",{networkId:e})}function km(){!z.isHost||!z.isActive||Ge("players_revived",{timestamp:Date.now()})}function ol(e,t,o=[]){!z.isHost||!z.isActive||Ge("game_over",{runStats:e,currencyEarned:t,partyStats:o,timestamp:Date.now()})}function ey(){!z.isHost||!z.isActive||Ge("host_quit",{timestamp:Date.now()})}function ty(e){!z.isHost||!z.isActive||Ge("powerup_weapon_applied",{powerupKey:e,timestamp:Date.now()})}function oy(e,t){z.isActive&&(z.isHost?Ge("upgrade_selected",{slotIndex:e,upgradeKey:t,timestamp:Date.now()}):lo("upgrade_selected",{slotIndex:e,upgradeKey:t}))}function ny(e,t){z.isActive&&(z.isHost?Ge("level_up_queued",{slotIndex:e,level:t,timestamp:Date.now()}):lo("level_up_queued",{slotIndex:e,level:t}))}function sy(e,t){z.isActive&&(z.isHost?Ge("synergy_activated",{slotIndex:e,synergies:t,timestamp:Date.now()}):lo("synergy_activated",{slotIndex:e,synergies:t}))}function nl(e,t){!z.isHost||!z.isActive||Ge("powerup_expired",{slotIndex:e,powerupKey:t,timestamp:Date.now()})}function sl(){return z.gameSeed!==0}function iy(e){z.onGameSeedCallback=e}function ay(e){z.currentFloor=e;const t=Fr(z.gameSeed,e);z.floorRng=new pn(t)}function wi(){const e=Fr(z.gameSeed,z.currentFloor,z.currentRoom.x,z.currentRoom.y);return new pn(e)}function ry(){const e=z.firstRoomTemplateKey;return z.firstRoomTemplateKey=null,e}function cy(){return z.floorRng}function ly(e,t){const o=Fr(z.gameSeed,e,t);return new pn(o)}function dy(e=null){z.isHost&&Ge("game_seed",{seed:z.gameSeed,roomTemplateKey:e})}function hy(e){z.isHost&&Ge("pause_state",{paused:e})}function uy(e){z.isHost||lo("pause_request",{paused:e})}function fy(e){z.isHost||lo("enemy_death",e)}function py(e,t=null){z.isHost&&Ge("obstacle_data",{obstacles:e,doorStates:t})}function gy(){z.isHost&&Ge("room_completed",{})}function my(e){z.isHost&&Ge("xp_gain",{value:e})}function yy(e){z.isHost&&Ge("currency_gain",{value:e})}function xy(){const e=z.pendingXP;return z.pendingXP=0,e}function il(e,t){z.isHost?Ge("player_emote",{slotIndex:e,emoteType:t}):lo("player_emote",{slotIndex:e,emoteType:t})}function by(e,t=null,o=null,n=null,s=null){z.isHost&&Ge("room_transition",{entryDirection:e,allPlayerStats:t,gridDirection:o,currentFloor:n,roomTemplateKey:s})}function wy(e){z.isHost&&Ge("enemy_split",{count:e})}function vy(e){z.isActive&&(z.isHost?Ge("player_death",{slotIndex:e}):lo("player_death",{slotIndex:e}))}function Ey(){z.isHost||lo("resync_request",{timestamp:Date.now()})}function Ay(){return z.localPlayerSlot}function Sy(e,t){if(!z.isActive)return;const s=fs().slots[t]?.name||`Player ${t+1}`;Ge("achievement_unlocked",{achievementId:e,playerSlotIndex:t,playerName:s})}class al{constructor(t,o,n,s=0){this.k=t,this.createFn=o,this.resetFn=n,this.pool=[],this.active=new Set;for(let a=0;a<s;a++){const r=this.createFn(t);r.hidden=!0,r.paused!==void 0&&(r.paused=!0),this.pool.push(r)}}acquire(...t){let o;return this.pool.length>0?(o=this.pool.pop(),o.hidden=!1,o.paused!==void 0&&(o.paused=!1)):o=this.createFn(this.k),this.resetFn&&this.resetFn(o,...t),this.active.add(o),o._pooled=!0,o}release(t){if(!(!t||!t._pooled)){if(!t.exists||!t.exists()){this.active.delete(t);return}t.hidden=!0,t.paused!==void 0&&(t.paused=!0),t.pos&&(t.pos.x=-9999,t.pos.y=-9999),this.active.delete(t),this.pool.push(t)}}clear(){for(const t of this.pool)t.exists&&t.exists()&&this.k.destroy(t);this.pool=[];for(const t of this.active)t.exists&&t.exists()&&this.k.destroy(t);this.active.clear()}getPoolSize(){return this.pool.length}getActiveCount(){return this.active.size}prewarm(t){for(let o=0;o<t;o++){const n=this.createFn(this.k);n.hidden=!0,n.paused!==void 0&&(n.paused=!0),n._pooled=!0,n.pos&&(n.pos.x=-9999,n.pos.y=-9999),this.pool.push(n)}}}const un={projectiles:null,particles:null};function My(e){un.projectiles=new al(e,t=>{const o=t.add([t.text("*",{size:16}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,100),t.rotate(0),t.area(),"projectile"]);return o.hidden=!0,o},(t,o,n,s,a,r,l,c,d,i)=>{t.pos.x=o,t.pos.y=n,t.damage=r,t.piercing=l||0,t.obstaclePiercing=c||0,t.piercedEnemies=new Set,t.piercedObstacles=new Set,t.isCrit=d||!1,t.maxRange=i||750,t.distanceTraveled=0,t.direction=s,t.speed=a,t.isBoomerang=!1,t.isReturning=!1,t.ownerPlayer=null,t.returnSpeedMultiplier=1.2,t.isExplosive=!1,t.isChainLightning=!1,t.isEnemyProjectile=!1,t.isBossProjectile=!1,t.isReflected=!1,t.reflectionCount=0,t.chainedEnemies=null,t.chainJumps=0,t.ownerSlotIndex=void 0,t.burnDamage=null,t.burnDuration=null,t.text="*",t.color=d?e.rgb(255,200,0):e.rgb(255,255,100);const h=Math.atan2(s.y,s.x)*(180/Math.PI)+90;t.angle=h},50),un.particles=new al(e,t=>{const o=t.add([t.text("*",{size:12}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,255),t.z(100),"particle"]);return o.hidden=!0,o},(t,o,n,s={})=>{const{char:a="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:i=1,fadeStart:h=.3,friction:u=.95,zIndex:p=100}=s;t.pos.x=o,t.pos.y=n,t.text=a,t.color=e.rgb(...l),t.z=p,t.opacity=1,t.velocity={x:c.x,y:c.y},t.gravity=d,t.friction=u,t.lifetime=i,t.fadeStart=h,t.age=0,t.initialOpacity=1},100)}function yh(){return un.particles}function Ty(){un.projectiles&&(un.projectiles.clear(),un.projectiles=null),un.particles&&(un.particles.clear(),un.particles=null)}function To(e,t,o,n,s,a,r=0,l=0,c=!1,d=null){const i=Math.atan2(n.y,n.x)*(180/Math.PI)+90,h=e.add([e.text("*",{size:16}),e.pos(t,o),e.anchor("center"),e.color(255,c?200:255,c?0:100),e.rotate(i),e.area(),"projectile"]);return h.damage=a,h.piercing=r,h.obstaclePiercing=l,h.piercedEnemies=new Set,h.piercedObstacles=new Set,h.isCrit=c,h.maxRange=d||us.DEFAULT_WEAPON_RANGE,h.distanceTraveled=0,h.direction=n,h.speed=s,h.isBoomerang=!1,h.isReturning=!1,h.ownerPlayer=null,h.returnSpeedMultiplier=1.2,h.useWeaponVisual=function(u){u&&u.char&&(h.text=u.char),u&&u.color&&(h.isCrit||(h.color=e.rgb(...u.color))),u&&u.range&&(h.maxRange=u.range)},h.onUpdate(()=>{if(e.paused)return;if(h.isBoomerang){if(h.isReturning)if(h.ownerPlayer&&h.ownerPlayer.exists()&&!h.ownerPlayer.isDead){const M=e.vec2(h.ownerPlayer.pos.x-h.pos.x,h.ownerPlayer.pos.y-h.pos.y),m=M.len();if(m>0){const T=M.unit(),P=h.speed*h.returnSpeedMultiplier,f=T.scale(P*e.dt());if(h.pos.x+=f.x,h.pos.y+=f.y,h.direction=T,m<30){e.destroy(h);return}}}else{e.destroy(h);return}else{const M=h.direction.scale(h.speed*e.dt());h.distanceTraveled+=M.len(),h.pos.x+=M.x,h.pos.y+=M.y,h.distanceTraveled>=h.maxRange&&(h.isReturning=!0,h.piercedEnemies.clear(),h.distanceTraveled=0)}const g=Math.atan2(h.direction.y,h.direction.x)*(180/Math.PI)+90;h.angle=g;return}const u=h.direction.scale(h.speed*e.dt()),p=u.len();if(h.distanceTraveled+=p,h.pos.x+=u.x,h.pos.y+=u.y,h.distanceTraveled>=h.maxRange){e.destroy(h);return}(h.pos.x<0||h.pos.x>e.width()||h.pos.y<0||h.pos.y>e.height())&&e.destroy(h)}),le()&&pe()&&cs(h),le()&&h.onDestroy(()=>{Zm(h)}),h}const ms={rusher:{name:"Security Guard",char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{name:"Camera Operator",char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.53,projectileSpeed:200,projectileDamage:7},zombie:{name:"Audience Member",char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{name:"Fan",char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{name:"Stagehand",char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{name:"Head of Security",char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{name:"Camera Director",char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{name:"Bouncer",char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{name:"Runner",char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{name:"Pyrotechnics Tech",char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{name:"Floor Manager",char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},splitter:{name:"Intern",char:"",color:[200,255,200],baseHealth:40,baseSpeed:75,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,splits:!0,splitCount:2},mage:{name:"Lighting Director",char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{name:"Stage Manager",char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{name:"Set Designer",char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{name:"Editor",char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{name:"Casting Director",char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{name:"Assistant Director",char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},phaser:{name:"Ghost Writer",char:"",color:[180,180,255],baseHealth:25,baseSpeed:100,size:18,baseXPValue:3,behavior:"phase",pathfindingMode:"none",damage:10,phaseOpacity:.5,phaseThroughObstacles:!0},mimic:{name:"Stunt Double",char:"@",color:[255,100,100],baseHealth:35,baseSpeed:150,size:18,baseXPValue:4,behavior:"mimic",pathfindingMode:"none",damage:12,mimicDuration:2,mimicCooldown:4},healer:{name:"Producer",char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{name:"Executive Producer",char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{name:"Network Executive",char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{name:"Talent Agent",char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},reflector:{name:"Mirror Master",char:"",color:[200,200,255],baseHealth:80,baseSpeed:45,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:12,reflectsProjectiles:!0,reflectChance:.4},bomber:{name:"Demolitions Expert",char:"",color:[255,150,100],baseHealth:70,baseSpeed:0,size:22,baseXPValue:5,behavior:"bomber",fireRate:.4,projectileSpeed:100,projectileDamage:20,homingStrength:.5,bombExplosionRadius:50},basic:{name:"Crew Member",char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{name:"Camera Operator",char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{name:"Runner",char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function Dy(e){return ms[e]||ms.basic}const on=32,Cy=100;class Ry{constructor(){this.elements=[]}enqueue(t,o){this.elements.push({element:t,priority:o}),this.elements.sort((n,s)=>n.priority-s.priority)}dequeue(){return this.elements.shift()?.element}isEmpty(){return this.elements.length===0}}function rl(e,t){return{gx:Math.floor(e/on),gy:Math.floor(t/on)}}function xh(e,t){return{x:e*on+on/2,y:t*on+on/2}}function Da(e,t,o,n,s){if(t<0||o<0||t>=n||o>=s)return!1;const a=xh(t,o),r=e.get("obstacle");for(const l of r){if(!l.exists())continue;const c=on/2,d=a.x-c,i=a.x+c,h=a.y-c,u=a.y+c,p=l.pos.x-l.width/2,g=l.pos.x+l.width/2,M=l.pos.y-l.height/2,m=l.pos.y+l.height/2;if(i>p&&d<g&&u>M&&h<m)return!1}return!0}function Iy(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function Py(e,t,o,n,s){const a=e.width(),r=e.height(),l=Math.ceil(a/on),c=Math.ceil(r/on),d=rl(t,o),i=rl(n,s);if(!Da(e,d.gx,d.gy,l,c)||!Da(e,i.gx,i.gy,l,c))return[];const h=new Ry;h.enqueue(d,0);const u=new Map,p=new Map,g=f=>`${f.gx},${f.gy}`;u.set(g(d),null),p.set(g(d),0);let M=0;const m=l*c;for(;!h.isEmpty()&&M<m;){M++;const f=h.dequeue();if(f.gx===i.gx&&f.gy===i.gy)break;const N=[{gx:f.gx+1,gy:f.gy},{gx:f.gx-1,gy:f.gy},{gx:f.gx,gy:f.gy+1},{gx:f.gx,gy:f.gy-1},{gx:f.gx+1,gy:f.gy+1},{gx:f.gx+1,gy:f.gy-1},{gx:f.gx-1,gy:f.gy+1},{gx:f.gx-1,gy:f.gy-1}];for(const O of N){if(!Da(e,O.gx,O.gy,l,c))continue;const A=O.gx!==f.gx&&O.gy!==f.gy?1.4:1,S=p.get(g(f))+A,I=g(O);if(!p.has(I)||S<p.get(I)){p.set(I,S);const E=S+Iy(O,i);h.enqueue(O,E),u.set(I,f)}}}const T=[];let P=i;for(;P&&u.has(g(P));){const f=xh(P.gx,P.gy);if(T.unshift(f),P=u.get(g(P)),T.length>Cy)break}return T}function By(e,t,o,n){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=Py(e,t.pos.x,t.pos.y,o,n),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const r=t.pathfindingPath[t.pathfindingWaypointIndex];if(r){const l=e.vec2(r.x-t.pos.x,r.y-t.pos.y),c=l.len();if(c<on/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),c>0)return l.unit()}}const s=e.vec2(o-t.pos.x,n-t.pos.y);return s.len()>0?s.unit():e.vec2(0,0)}function Ly(e,t){const o=e.width(),n=e.height(),s=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:s});const a=t.perimeterMode;t.speed*e.dt();const r=20,l=e.vec2(a.targetX-t.pos.x,a.targetY-t.pos.y),c=l.len();if(c<r)switch(a.side){case"top":a.side="right",a.targetX=o-s,a.targetY=s;break;case"right":a.side="bottom",a.targetX=o-s,a.targetY=n-s;break;case"bottom":a.side="left",a.targetX=s,a.targetY=n-s;break;case"left":a.side="top",a.targetX=s,a.targetY=s;break}return c>0?l.unit():e.vec2(0,0)}function Rn(e,t,o,n="basic",s=1,a=null){const r=Dy(n),l=1+(s-1)*.3,c={char:r.char,color:r.color,health:Math.floor(r.baseHealth*l),speed:Math.floor(r.baseSpeed*(1+(s-1)*.1)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),behavior:r.behavior};function d(){return c.char}const i=e.add([e.text(d(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"enemy"]);i.originalColor=c.color,i.maxHealth=c.health,i.speed=c.speed,i.xpValue=c.xpValue,i.type=n,i.behavior=c.behavior,i.floor=s,i.pathfindingMode=r.pathfindingMode||"none",r.damage&&(i.damage=r.damage),r.fireRate&&(i.fireRate=r.fireRate),r.projectileSpeed&&(i.projectileSpeed=r.projectileSpeed),r.projectileDamage&&(i.projectileDamage=r.projectileDamage),r.chargeCooldown&&(i.chargeCooldown=r.chargeCooldown),r.splits&&(i.splits=!0,i.splitCount=r.splitCount||2,i.splitType=r.splitType||n),r.explodes&&(i.explodes=!0,i.explosionDamage=r.explosionDamage,i.explosionRadius=r.explosionRadius,r.shrapnel&&(i.shrapnel=!0,i.shrapnelCount=r.shrapnelCount||8));let h=0,u=0,p=0;if(s>=2){const A=a?a.next():Math.random();s>=2&&(n==="zombie"||n==="turret"||n==="heavyTank"||A<.3)&&(h=Math.floor(15+(s-2)*5))}if(s>=3){const A=a?a.next():Math.random();(n==="shooter"||n==="turret"||n==="wraith"||A<.2)&&(u=Math.floor(10+(s-3)*5),p=1+(s-3)*.5)}if(s>=4){const A=a?a.next():Math.random();(n==="heavyTank"||n==="spawner"||A<.1)&&(h===0&&(h=Math.floor(20+(s-4)*5)),u===0&&(u=Math.floor(15+(s-4)*5),p=1.5+(s-4)*.5))}const g=(r.baseArmorHealth||0)+h;i.armorHealth=Math.floor(g*l),i.maxArmorHealth=Math.floor(g*l),i.damageReduction=r.damageReduction||(g>0?.2:0),i.armorChar=r.armorChar||"[]",i.armorColor=r.armorColor||[200,200,200];const M=(r.baseShieldHealth||0)+u;i.shieldHealth=Math.floor(M*l),i.maxShieldHealth=Math.floor(M*l),i.shieldRegenRate=((r.shieldRegenRate||0)+p)*l,i.shieldChar=r.shieldChar||"{}",i.shieldColor=r.shieldColor||[100,200,255],i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.originalColor=c.color,i.coreChar=c.char,i.updateVisual=function(){let A="",S="",I="",E="";if(i.shieldHealth>0){const C=i.shieldHealth/i.maxShieldHealth;C>.66?(A="",S=""):C>.33?(A="",S=""):(A="",S="")}if(i.armorHealth>0){const C=i.armorHealth/i.maxArmorHealth;C>.66?(I="",E=""):C>.33?(I="",E=""):(I="",E="")}const L=`${A}${I}${i.coreChar}${E}${S}`;i.text=L,i.shieldHealth>0?i.color=e.rgb(...i.shieldColor):i.color=e.rgb(...i.originalColor)},i.takeDamage=function(A){let S=!1,I=!1;const E=i.shieldHealth,L=i.armorHealth;i.lastDamageTime=e.time();const C=3;if(i.shieldRegenCooldown=C,i.shieldHealth>0){const F=Math.min(A,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-F),S=i.shieldHealth!==E;const U=A-F;U>0&&i.takeDamageInternal(U)}else i.takeDamageInternal(A);I=i.armorHealth!==L,(S||I)&&i.updateVisual()},i.takeDamageInternal=function(A){if(i.armorHealth>0){const S=Math.floor(A*(1-i.damageReduction)),I=Math.min(S,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-I);const E=A-S;if(E>0){const L=i.armorHealth>0?1-i.damageReduction:1,C=Math.floor(E*L);i.hurt(C)}}else i.hurt(A)},r.blocksProjectiles&&(i.blocksProjectiles=!0),r.teleportCooldown&&(i.teleportCooldown=r.teleportCooldown),r.teleportRange&&(i.teleportRange=r.teleportRange),r.spawnInterval&&(i.spawnInterval=r.spawnInterval),r.spawnType&&(i.spawnType=r.spawnType),r.buffRadius&&(i.buffRadius=r.buffRadius),r.buffAmount&&(i.buffAmount=r.buffAmount),r.healRadius&&(i.healRadius=r.healRadius),r.healAmount&&(i.healAmount=r.healAmount),r.healInterval&&(i.healInterval=r.healInterval),r.slowRadius&&(i.slowRadius=r.slowRadius),r.slowAmount&&(i.slowAmount=r.slowAmount),r.lifesteal&&(i.lifesteal=r.lifesteal),r.phaseOpacity&&(i.phaseOpacity=r.phaseOpacity),r.phaseThroughObstacles&&(i.phaseThroughObstacles=r.phaseThroughObstacles),r.mimicDuration&&(i.mimicDuration=r.mimicDuration),r.mimicCooldown&&(i.mimicCooldown=r.mimicCooldown),r.reflectsProjectiles&&(i.reflectsProjectiles=r.reflectsProjectiles),r.reflectChance&&(i.reflectChance=r.reflectChance),r.homingStrength&&(i.homingStrength=r.homingStrength),r.bombExplosionRadius&&(i.bombExplosionRadius=r.bombExplosionRadius),i.updateVisual(),i.attackTimer=0,i.chargeTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeDuration=0,i.chargePauseTimer=0,i.teleportTimer=0,i.spawnTimer=0,i.healTimer=0,i.buffedEnemies=new Set,i.mimicTimer=0,i.mimicMovementHistory=[],i.isMimicking=!1,i.mimicMoveIndex=0,i.phaseOpacity&&(i.opacity=i.phaseOpacity),i.stuckTimer=0,i.stuckThreshold=1,i.lastPosition={x:t,y:o},i.lastPositionUpdateTime=0,i.avoidanceDirection=null,i.avoidanceTimer=0;const m=30,T=3,P=-20,f=e.add([e.rect(m,T),e.pos(t,o+P),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),N=e.add([e.rect(m,T),e.pos(t,o+P),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);i.healthBarBg=f,i.healthBar=N,i.showHealthThreshold=.5,f.hidden=!0,N.hidden=!0,i.onUpdate(()=>{if(i.exists()&&i.healthBar&&i.healthBarBg){const A=i.hp()/i.maxHealth;if(A<i.showHealthThreshold&&A>0){i.healthBarBg.hidden=!1,i.healthBar.hidden=!1,i.healthBarBg.pos.x=i.pos.x,i.healthBarBg.pos.y=i.pos.y+P,i.healthBar.pos.x=i.pos.x,i.healthBar.pos.y=i.pos.y+P;const I=m*A;i.healthBar.width=Math.max(1,I),i.healthBar.pos.x=i.pos.x-(m-I)/2}else i.healthBarBg.hidden=!0,i.healthBar.hidden=!0}}),i.cleanupHealthBars=function(){i.healthBarBg&&i.healthBarBg.exists()&&e.destroy(i.healthBarBg),i.healthBar&&i.healthBar.exists()&&e.destroy(i.healthBar)};const O=(A,S)=>{const I=e.get("obstacle"),E=i.size||12;for(const L of I){if(!L.exists())continue;const C=L.pos.x-L.width/2,F=L.pos.x+L.width/2,U=L.pos.y-L.height/2,_=L.pos.y+L.height/2,H=A-E,R=A+E,Y=S-E,V=S+E;if(R>C&&H<F&&V>U&&Y<_)return!1}return!0},w=A=>{const S=A.len(),I=S>0?A.unit():e.vec2(0,0);i.lastPositionUpdateTime+=e.dt(),i.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(i.pos.x-i.lastPosition.x,2)+Math.pow(i.pos.y-i.lastPosition.y,2))<5?i.stuckTimer+=i.lastPositionUpdateTime:i.stuckTimer=0,i.lastPosition={x:i.pos.x,y:i.pos.y},i.lastPositionUpdateTime=0);const E=i.pos.x+A.x,L=i.pos.y+A.y;if(O(E,L))return i.avoidanceDirection=null,i.avoidanceTimer=0,A;if(i.avoidanceTimer-=e.dt(),i.stuckTimer>=i.stuckThreshold||i.avoidanceTimer<=0){const C=e.vec2(-I.y,I.x),F=e.vec2(I.y,-I.x),U=[C.scale(S),F.scale(S),e.vec2(C.x*.7+I.x*.3,C.y*.7+I.y*.3).unit().scale(S),e.vec2(F.x*.7+I.x*.3,F.y*.7+I.y*.3).unit().scale(S),e.vec2(C.x*.5+I.x*.5,C.y*.5+I.y*.5).unit().scale(S),e.vec2(F.x*.5+I.x*.5,F.y*.5+I.y*.5).unit().scale(S)];for(const _ of U){const H=i.pos.x+_.x,R=i.pos.y+_.y;if(O(H,R))return i.avoidanceDirection=e.vec2(_.x,_.y).unit(),i.avoidanceTimer=.8,_}if(i.avoidanceDirection){const _=i.avoidanceDirection.scale(S),H=i.pos.x+_.x,R=i.pos.y+_.y;if(O(H,R))return _}return O(E,i.pos.y)?e.vec2(A.x,0):O(i.pos.x,L)?e.vec2(0,A.y):e.vec2(0,0)}else if(i.avoidanceDirection){const C=i.avoidanceDirection.scale(S),F=i.pos.x+C.x,U=i.pos.y+C.y;if(O(F,U))return C;i.avoidanceDirection=null,i.avoidanceTimer=0}return O(E,i.pos.y)?e.vec2(A.x,0):O(i.pos.x,L)?e.vec2(0,A.y):e.vec2(0,0)};return i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead){if((!le()||pe())&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const H=1;if(i.shieldRegenTimer>=H){const R=i.shieldRegenRate*H;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+R),i.shieldRegenTimer=0}}i.shieldHealth>0&&i.updateVisual&&i.updateVisual()}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!le()||pe())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const A=e.gameData?.alivePlayers||e.get("player").filter(H=>H.exists()&&!H.isDead&&H.hp()>0);if(A.length===0)return;let S=A[0],I=Math.sqrt(Math.pow(S.pos.x-i.pos.x,2)+Math.pow(S.pos.y-i.pos.y,2));for(let H=1;H<A.length;H++){const R=A[H],Y=Math.sqrt(Math.pow(R.pos.x-i.pos.x,2)+Math.pow(R.pos.y-i.pos.y,2));Y<I&&(I=Y,S=R)}const E=e.vec2(S.pos.x-i.pos.x,S.pos.y-i.pos.y),L=E.len();if(i.behavior==="turret"){if(i.attackTimer+=e.dt(),L>0&&i.attackTimer>=1/i.fireRate){const H=E.unit(),R=To(e,i.pos.x,i.pos.y,H,i.projectileSpeed,i.projectileDamage,0,0,!1);R.isEnemyProjectile=!0,R.color=e.rgb(...i.originalColor),i.attackTimer=0}return}if(i.behavior==="shoot"){i.attackTimer+=e.dt();const H=150;let R=e.vec2(0,0);if(L>H*1.2?R=E.unit().scale(i.speed*e.dt()):L<H*.8&&(R=E.unit().scale(-i.speed*e.dt())),L>0&&i.attackTimer>=1/i.fireRate){const Y=E.unit(),V=To(e,i.pos.x,i.pos.y,Y,i.projectileSpeed,i.projectileDamage,0,0,!1);V.isEnemyProjectile=!0,V.color=e.rgb(...i.originalColor),i.attackTimer=0}if(R.len()>0){const Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y;const V=20,Q=i.size||12;i.pos.x=e.clamp(i.pos.x,V+Q,e.width()-V-Q),i.pos.y=e.clamp(i.pos.y,V+Q,e.height()-V-Q)}return}if(i.behavior==="charge"){if(i.chargeTimer+=e.dt(),i.isCharging)if(i.chargeDuration+=e.dt(),i.chargeDuration>=.8)i.isCharging=!1,i.chargeDuration=0,i.chargePauseTimer=0;else{const R=i.chargeDirection.scale(i.speed*e.dt()),Y=w(R);Y.len()<R.len()*.3?(i.isCharging=!1,i.chargePauseTimer=.1):(i.pos.x+=Y.x,i.pos.y+=Y.y)}else if(i.chargePauseTimer>0)i.chargePauseTimer+=e.dt(),i.chargePauseTimer>=1&&(i.chargePauseTimer=0,i.chargeTimer=0);else if(i.chargeTimer>=i.chargeCooldown)i.color=e.rgb(255,255,0),e.wait(.2,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor),L>0&&(i.isCharging=!0,i.chargeDirection=E.unit(),i.chargeDuration=0))}),i.chargeTimer=0;else{const R=E.unit().scale(i.speed*.5*e.dt()),Y=w(R);Y.len()<R.len()*.5&&i.isCharging&&(i.isCharging=!1,i.chargePauseTimer=.1),i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="erratic"){if(L>0){const H=E.unit(),R=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),V=e.vec2(H.x+R.x,H.y+R.y).unit().scale(i.speed*e.dt()),Q=w(V);i.pos.x+=Q.x,i.pos.y+=Q.y}return}if(i.behavior==="shield"){if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="teleport"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&L>0){const H=E.unit(),R=e.vec2(i.pos.x+H.x*i.teleportRange,i.pos.y+H.y*i.teleportRange);O(R.x,R.y)&&(i.pos.x=R.x,i.pos.y=R.y,i.teleportTimer=0,i.color=e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}))}else if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="spawner"){if(i.spawnTimer+=e.dt(),i.spawnTimer>=i.spawnInterval){const H=Math.random()*Math.PI*2,R=30,Y=i.pos.x+Math.cos(H)*R,V=i.pos.y+Math.sin(H)*R;if(O(Y,V)){const Q=Rn(e,Y,V,i.spawnType||"rusher",i.floor);Q.isBossMinion=!0,i.spawnTimer=0}}if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="buffer"){if(i.attackTimer+=e.dt(),i.attackTimer>=1){const H=e.get("enemy");for(const R of H){if(!R.exists()||R===i)continue;e.vec2(R.pos.x-i.pos.x,R.pos.y-i.pos.y).len()<=i.buffRadius?(R.buffed||(R.buffed=!0,R.originalSpeed=R.speed,R.originalDamage=R.damage||10),R.speed=R.originalSpeed*(1+i.buffAmount),R.damage=R.originalDamage*(1+i.buffAmount),i.buffedEnemies.add(R)):i.buffedEnemies.has(R)&&(R.buffed&&(R.speed=R.originalSpeed,R.damage=R.originalDamage,R.buffed=!1),i.buffedEnemies.delete(R))}i.attackTimer=0}if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="healer"){if(i.healTimer+=e.dt(),i.healTimer>=i.healInterval){const H=e.get("enemy");for(const R of H){if(!R.exists()||R===i)continue;if(e.vec2(R.pos.x-i.pos.x,R.pos.y-i.pos.y).len()<=i.healRadius){const Q=R.hp(),fe=R.maxHealth;if(Q<fe){const se=Math.min(fe,Q+i.healAmount);R.setHP(se);const ie=e.add([e.text("+",{size:16}),e.pos(R.pos.x,R.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{ie.exists()&&e.destroy(ie)})}}}i.healTimer=0}if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="teleportPlayer"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&L<=80){const H=Math.random()*Math.PI*2,R=S.pos.x+Math.cos(H)*i.teleportRange,Y=S.pos.y+Math.sin(H)*i.teleportRange,V=Math.max(50,Math.min(e.width()-50,R)),Q=Math.max(50,Math.min(e.height()-50,Y));S.pos.x=V,S.pos.y=Q,i.teleportTimer=0;const fe=e.add([e.text("!",{size:24}),e.pos(S.pos.x,S.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{fe.exists()&&e.destroy(fe)})}if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="freeze"){if(L<=i.slowRadius?(S.slowed||(S.slowed=!0,S.originalSpeed=S.speed),S.speed=S.originalSpeed*(1-i.slowAmount)):S.slowed&&(S.speed=S.originalSpeed,S.slowed=!1),L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="phase"){if(L>0){const H=E.unit();i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt();const R=e.width(),Y=e.height(),V=20,Q=i.size||12;i.pos.x=e.clamp(i.pos.x,V+Q,R-V-Q),i.pos.y=e.clamp(i.pos.y,V+Q,Y-V-Q)}return}if(i.behavior==="mimic"){if(i.mimicTimer+=e.dt(),i.isMimicking)if(i.mimicMoveIndex<i.mimicMovementHistory.length){const H=i.mimicMovementHistory[i.mimicMoveIndex],R=e.vec2(H.x*e.dt()*60,H.y*e.dt()*60),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y,i.mimicMoveIndex++}else i.isMimicking=!1,i.mimicTimer=0,i.mimicMovementHistory=[],i.mimicMoveIndex=0;else if(i.mimicTimer<i.mimicDuration){if(S.move&&(S.move.x!==0||S.move.y!==0)&&i.mimicMovementHistory.push({x:S.move.x,y:S.move.y}),L>0){const R=E.unit().scale(i.speed*.5*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}}else if(i.mimicTimer>=i.mimicCooldown)if(i.mimicMovementHistory.length>0)i.isMimicking=!0,i.mimicMoveIndex=0,i.color=e.rgb(255,255,255),e.wait(.15,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))});else{if(L>0){const R=E.unit().scale(i.speed*1.5*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}i.mimicTimer=0}else if(L>0){const R=E.unit().scale(i.speed*e.dt()),Y=w(R);i.pos.x+=Y.x,i.pos.y+=Y.y}return}if(i.behavior==="bomber"){if(i.attackTimer+=e.dt(),L>0&&i.attackTimer>=1/i.fireRate){const H=E.unit(),R=To(e,i.pos.x,i.pos.y,H,i.projectileSpeed,i.projectileDamage,0,0,!1);R.isEnemyProjectile=!0,R.isBomb=!0,R.homingStrength=i.homingStrength,R.bombExplosionRadius=i.bombExplosionRadius,R.targetPlayer=S,R.color=e.rgb(255,100,0),R.text="",R.onUpdate(()=>{if(R.targetPlayer&&R.targetPlayer.exists()&&!R.targetPlayer.isDead){const Y=e.vec2(R.targetPlayer.pos.x-R.pos.x,R.targetPlayer.pos.y-R.pos.y),V=Y.len()>0?Y.unit():e.vec2(0,0);R.direction=e.vec2(R.direction.x+(V.x-R.direction.x)*R.homingStrength*e.dt(),R.direction.y+(V.y-R.direction.y)*R.homingStrength*e.dt()).unit()}}),i.attackTimer=0}return}if(i.behavior==="rush"&&L>0){let H;if(i.pathfindingMode==="smart")H=By(e,i,S.pos.x,S.pos.y);else{const Y=E.unit().scale(i.speed*e.dt());H=w(Y).unit()}i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt()}if(i.behavior==="perimeter"){const H=Ly(e,i);i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt()}const C=e.width(),F=e.height(),U=20,_=i.size||12;i.pos.x=e.clamp(i.pos.x,U+_,C-U-_),i.pos.y=e.clamp(i.pos.y,U+_,F-U-_)}),i.isDead=!1,i.onDeath(()=>{if(i.behavior==="buffer"&&i.buffedEnemies)for(const A of i.buffedEnemies)A.exists()&&A.buffed&&(A.speed=A.originalSpeed,A.damage=A.originalDamage,A.buffed=!1)}),i.onDeath(()=>{if(le()&&pe()&&i.mpEntityId&&$r({entityId:i.mpEntityId,entityType:"enemy",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue}),i.splits&&i.hp()<=0){if(le()&&!pe())return;const A=i.splitCount||2,S=i.splitType||"slime";for(let I=0;I<A;I++){const E=Math.PI*2/A*I,L=20,C=i.pos.x+Math.cos(E)*L,F=i.pos.y+Math.sin(E)*L,U=Rn(e,C,F,S,i.floor);U.maxHealth=Math.max(10,Math.floor(U.maxHealth/2)),U.setHP(U.maxHealth),U.size=Math.max(8,Math.floor(U.size*.8)),U.splits=!1,U.isSplitEnemy=!0,le()&&pe()&&Xo&&Xo(U,{maxHealth:U.maxHealth,floor:i.floor})}e.gameData&&e.gameData.incrementSplitEnemies&&e.gameData.incrementSplitEnemies(A),le()&&pe()&&wy(A)}if(i.explodes&&i.hp()<=0){(!le()||pe())&&e.get("player").forEach(I=>{if(I&&I.exists()&&!I.isDead&&e.vec2(I.pos.x-i.pos.x,I.pos.y-i.pos.y).len()<=i.explosionRadius&&!I.invulnerable){const C=Math.max(1,i.explosionDamage-(I.defense||0));I.hurt(C),I.invulnerable=!0,I.invulnerableTime=I.invulnerableDuration,I.color=e.rgb(255,100,100)}});const A=e.add([e.text("*",{size:24}),e.pos(i.pos.x,i.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{A.exists()&&e.destroy(A)})}}),le()&&pe()&&(Xo(i,{type:n,floor:s}),i.enemyType=n),i}const jn={brute:{name:"Security Chief",coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{name:"Technical Director",coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{name:"Stunt Coordinator",coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{name:"Studio Manager",coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{name:"Creative Director",coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function zy(e){return jn[e]||jn.brute}function Oy(e,t,o,n="brute",s=1){const a=zy(n),r=1+(s-1)*.2,l={coreChar:a.coreChar,armorChar:a.armorChar||"[]",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*r),armorHealth:Math.floor((a.baseArmorHealth||0)*r),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*r),shieldHealth:Math.floor((a.baseShieldHealth||0)*r),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*r),speed:Math.floor(a.baseSpeed*(1+(s-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*r),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*r},c=e.add([e.text(l.coreChar,{size:l.size}),e.pos(t,o),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"miniboss"]);return c.maxHealth=l.health,c.speed=l.speed,c.xpValue=l.xpValue,c.type=n,c.floor=s,a.meleeDamage&&(c.meleeDamage=a.meleeDamage),a.projectileDamage&&(c.projectileDamage=a.projectileDamage),a.projectileSpeed&&(c.projectileSpeed=a.projectileSpeed),a.fireRate&&(c.fireRate=a.fireRate),c.armorHealth=l.armorHealth,c.maxArmorHealth=l.maxArmorHealth,c.damageReduction=l.damageReduction,c.coreChar=l.coreChar,c.armorChar=l.armorChar,c.armorColor=l.armorColor,c.shieldHealth=l.shieldHealth,c.maxShieldHealth=l.maxShieldHealth,c.shieldRegenRate=l.shieldRegenRate,c.shieldChar=l.shieldChar,c.shieldColor=l.shieldColor,c.shieldRegenTimer=0,c.shieldRegenCooldown=0,c.lastDamageTime=0,c.attackTimer=0,c.chargeCooldownTimer=0,c.chargeDurationTimer=0,c.isCharging=!1,c.chargeDirection=null,c.chargeSpeed=0,c.updateVisual=function(){let d="",i="",h="",u="";if(c.shieldHealth>0){const g=c.shieldHealth/c.maxShieldHealth;g>.66?(d="",i=""):g>.33?(d="",i=""):(d="",i="")}if(c.armorHealth>0){const g=c.armorHealth/c.maxArmorHealth;g>.66?(h="",u=""):g>.33?(h="",u=""):(h="",u="")}const p=`${d}${h}${c.coreChar}${u}${i}`;c.text=p,c.shieldHealth>0?c.color=e.rgb(...l.shieldColor):c.color=e.rgb(...l.color)},c.takeDamage=function(d){let i=!1,h=!1;const u=c.shieldHealth,p=c.armorHealth;c.lastDamageTime=e.time();const g=3;if(c.shieldRegenCooldown=g,c.shieldHealth>0){const M=Math.min(d,c.shieldHealth);c.shieldHealth=Math.max(0,c.shieldHealth-M),i=c.shieldHealth!==u;const m=d-M;m>0&&c.takeDamageInternal(m)}else c.takeDamageInternal(d);h=c.armorHealth!==p,(i||h)&&c.updateVisual()},c.takeDamageInternal=function(d){if(c.armorHealth>0){const i=Math.floor(d*(1-c.damageReduction)),h=Math.min(i,c.armorHealth);c.armorHealth=Math.max(0,c.armorHealth-h);const u=d-i;if(u>0){const p=c.armorHealth>0?1-c.damageReduction:1,g=Math.floor(u*p);c.hurt(g)}}else c.hurt(d)},c.startCharge=function(d){if(!c.exists())return;c.isCharging=!0;const i=e.vec2(d.x-c.pos.x,d.y-c.pos.y);i.len()>0&&(c.chargeDirection=i.unit(),c.chargeSpeed=c.speed*2.5)},c.onUpdate(()=>{if(e.paused)return;if(c.shieldRegenRate>0&&c.shieldHealth<c.maxShieldHealth&&c.hp()>0&&!c.isDead&&(c.shieldRegenCooldown>0&&(c.shieldRegenCooldown-=e.dt()),c.shieldRegenCooldown<=0)){c.shieldRegenTimer+=e.dt();const m=1;if(c.shieldRegenTimer>=m){const T=c.shieldRegenRate*m;c.shieldHealth=Math.min(c.maxShieldHealth,c.shieldHealth+T),c.shieldRegenTimer=0,c.shieldHealth>0&&c.updateVisual()}}c.burnDuration>0&&c.hp()>0&&!c.isDead&&(c.burnTimer=(c.burnTimer||0)+e.dt(),c.burnTimer>=.5&&((!le()||pe())&&(c.takeDamage?c.takeDamage(c.burnDamage):c.hurt(c.burnDamage)),c.color,c.color=e.rgb(255,150,50),e.wait(.1,()=>{c.exists()&&c.updateVisual()}),c.burnTimer=0),c.burnDuration-=e.dt(),c.burnDuration<=0&&(c.burnDamage=0,c.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const i=e.vec2(d.pos.x-c.pos.x,d.pos.y-c.pos.y),h=i.len();if(a.behavior==="charge"){c.attackTimer+=e.dt(),c.chargeCooldownTimer+=e.dt();const m=6,T=200;if(c.isCharging){const P=c.chargeDirection.scale(c.chargeSpeed*e.dt());c.pos.x+=P.x,c.pos.y+=P.y,c.chargeDurationTimer+=e.dt(),c.chargeDurationTimer>=1&&(c.isCharging=!1,c.chargeDurationTimer=0,c.chargeCooldownTimer=0)}else{if(h>0){const f=i.unit().scale(c.speed*e.dt());c.pos.x+=f.x,c.pos.y+=f.y}c.chargeCooldownTimer>=m&&h<T&&(c.color=e.rgb(255,255,0),e.wait(.3,()=>{c.exists()&&(c.color=e.rgb(...l.color),c.startCharge(d.pos))}),c.chargeCooldownTimer=0)}}else if(a.behavior==="shoot"){c.attackTimer+=e.dt();const m=180;if(h>0){const P=i.unit();let f=c.speed;if(h<m){const N=P.scale(-f*e.dt());c.pos.x+=N.x,c.pos.y+=N.y}else if(h>m*1.5){const N=P.scale(f*e.dt());c.pos.x+=N.x,c.pos.y+=N.y}}const T=1/c.fireRate;if(c.attackTimer>=T){if(h>0){const P=i.unit(),f=To(e,c.pos.x,c.pos.y,P,c.projectileSpeed,c.projectileDamage,0,0,!1);f.isBossProjectile=!0,f.color=e.rgb(...l.color)}c.attackTimer=0}}else if(a.behavior==="rush"&&h>0){const T=i.unit().scale(c.speed*e.dt());c.pos.x+=T.x,c.pos.y+=T.y}const u=e.width(),p=e.height(),g=20,M=c.size||24;c.pos.x=e.clamp(c.pos.x,g+M,u-g-M),c.pos.y=e.clamp(c.pos.y,g+M,p-g-M)}),c.isDead=!1,c.updateVisual(),c}function Hy(e,t,o,n){const s=e.add([e.rect(40,40),e.pos(t,o),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return s.direction=n,s.open=!1,s.isSpawnDoor=!1,s.blocked=!1,s.gridDirection=null,s.parts=[],s.updateVisual=()=>{s.parts.forEach(r=>{r.exists()&&e.destroy(r)}),s.parts=[];let a;if(s.blocked?a=e.rgb(80,80,80):s.open?a=e.rgb(100,255,100):s.isSpawnDoor?a=e.rgb(200,50,50):a=e.rgb(200,200,100),n==="north"||n==="south"){const r=s.blocked?"":s.open?"":"",l=e.add([e.text(r,{size:24}),e.pos(t,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(l);const c=e.add([e.text(s.open?"":"",{size:20}),e.pos(t-35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(c);const d=e.add([e.text(s.open?"":"",{size:20}),e.pos(t+35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(d)}else{const r=s.blocked?["","",""]:s.open?["","",""]:["","",""],l=16;for(let i=0;i<r.length;i++){const h=(i-1)*l,u=e.add([e.text(r[i],{size:24}),e.pos(t,o+h),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(u)}const c=e.add([e.text(s.open?"":"",{size:20}),e.pos(t,o-l*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(c);const d=e.add([e.text(s.open?"":"",{size:20}),e.pos(t,o+l*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(d)}if(s.blocked){const r=e.add([e.text("X",{size:28}),e.pos(t,o),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);s.parts.push(r)}},Object.defineProperty(s,"color",{get:()=>s._color,set:a=>{s._color=a,s.parts.forEach(r=>{r.exists()&&(r.color=a)})}}),Object.defineProperty(s,"text",{get:()=>s._text||"=",set:a=>{s._text=a}}),s.onDestroy(()=>{s.parts.forEach(a=>{a.exists()&&e.destroy(a)}),s.parts=[]}),s.updateVisual(),s}function cl(e,t,o,n,s,a="wall",r="#",l=null){const c=a==="wall",d=c?e.rgb(100,100,100):e.rgb(140,140,140),i=c?e.rgb(80,80,80):e.rgb(120,120,120),h=e.add([e.rect(n,s),e.pos(t,o),e.anchor("center"),e.color(l||d),e.outline(2,l||i),e.area({width:n,height:s}),e.fixed(),"obstacle",a==="wall"?"wall":"cover"]);return h.type=a,h.width=n,h.height=s,h}const Uy={CHAR:"",SIZE:20,COLOR:[180,80,40],DAMAGED_COLOR:[220,100,30],CRITICAL_COLOR:[255,60,20],MAX_HEALTH:3,EXPLOSION_RADIUS:80,EXPLOSION_DAMAGE:25,CHAIN_DELAY:.15,KNOCKBACK_FORCE:200,SHAKE_INTENSITY:.5,EXPLOSION_DURATION:.3};let Fn=[];function Ny(e,t,o,n={}){const s={...Uy,...n},a=e.add([e.text(s.CHAR,{size:s.SIZE}),e.pos(t,o),e.anchor("center"),e.area({width:s.SIZE,height:s.SIZE}),e.color(...s.COLOR),e.z(50),e.opacity(1),"barrel","obstacle",{maxHealth:s.MAX_HEALTH,currentHealth:s.MAX_HEALTH,explosionRadius:s.EXPLOSION_RADIUS,explosionDamage:s.EXPLOSION_DAMAGE,chainDelay:s.CHAIN_DELAY,knockbackForce:s.KNOCKBACK_FORCE,isExploding:!1,barrelId:Math.random().toString(36).substr(2,9)}]),r=e.add([e.rect(24,4),e.pos(t,o-18),e.anchor("center"),e.color(40,40,40),e.z(51),"barrelHealthBar"]),l=e.add([e.rect(22,2),e.pos(t-11,o-18),e.anchor("left"),e.color(255,100,50),e.z(52),"barrelHealthBar"]);return a.healthBarBg=r,a.healthBarFill=l,a.updateHealthBar=()=>{if(!a.exists())return;const c=a.currentHealth/a.maxHealth;r.exists()&&(r.pos.x=a.pos.x,r.pos.y=a.pos.y-18),l.exists()&&(l.pos.x=a.pos.x-11,l.pos.y=a.pos.y-18,l.width=22*c,c<=.33?l.color=e.rgb(255,50,50):c<=.66&&(l.color=e.rgb(255,150,50))),c<=.33?(a.color=e.rgb(...s.CRITICAL_COLOR),a.pos.x+=(Math.random()-.5)*2,a.pos.y+=(Math.random()-.5)*2):c<=.66&&(a.color=e.rgb(...s.DAMAGED_COLOR))},a.takeDamage=(c=1,d=null,i=!1)=>{a.isExploding||!a.exists()||(a.currentHealth-=c,a.updateHealthBar(),!i&&le()&&pe()&&Ge("barrel_damage",{x:a.pos.x,y:a.pos.y,damage:c,currentHealth:a.currentHealth}),a.color,a.color=e.rgb(255,255,255),e.wait(.05,()=>{a.exists()&&a.updateHealthBar()}),a.currentHealth<=0&&a.explode(d))},a.explode=(c=null)=>{if(a.isExploding||!a.exists())return;a.isExploding=!0;const d=a.pos.x,i=a.pos.y;le()&&pe()&&Ge("barrel_explode",{barrelId:a.barrelId,x:d,y:i,radius:a.explosionRadius,damage:a.explosionDamage}),_y(e,d,i,a.explosionRadius),Xy(e,d,i,a.explosionRadius,a.explosionDamage,a.knockbackForce),e.wait(a.chainDelay,()=>{Fy(e,d,i,a.explosionRadius,a.barrelId)}),r.exists()&&e.destroy(r),l.exists()&&e.destroy(l),Fn=Fn.filter(h=>h!==a),e.destroy(a)},Fn.push(a),a}function _y(e,t,o,n){const s=e.add([e.circle(n),e.pos(t,o),e.anchor("center"),e.color(255,150,50),e.opacity(.8),e.scale(1),e.z(100),"explosionEffect"]),a=e.add([e.circle(n*.6),e.pos(t,o),e.anchor("center"),e.color(255,255,150),e.opacity(.9),e.scale(1),e.z(101),"explosionEffect"]),r=e.add([e.text("*",{size:40}),e.pos(t,o),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.scale(1),e.z(102),"explosionEffect"]);e.tween(s.scale,e.vec2(1.5,1.5),.2,l=>s.scale=l),e.tween(s.opacity,0,.3,l=>s.opacity=l,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)}),e.tween(a.scale,e.vec2(1.3,1.3),.15,l=>a.scale=l),e.tween(a.opacity,0,.25,l=>a.opacity=l,e.easings.easeOutQuad).onEnd(()=>{a.exists()&&e.destroy(a)}),e.tween(r.scale,e.vec2(2,2),.1,l=>r.scale=l),e.tween(r.opacity,0,.2,l=>r.opacity=l).onEnd(()=>{r.exists()&&e.destroy(r)});for(let l=0;l<8;l++){const c=Math.PI*2*l/8,d=100+Math.random()*100,i=e.add([e.text(["#","*","+","~"][Math.floor(Math.random()*4)],{size:12}),e.pos(t,o),e.anchor("center"),e.color(255,150+Math.random()*100,50),e.opacity(1),e.z(99),"explosionDebris"]),h=t+Math.cos(c)*d,u=o+Math.sin(c)*d;e.tween(i.pos,e.vec2(h,u),.4,p=>i.pos=p,e.easings.easeOutQuad),e.tween(i.opacity,0,.4,p=>i.opacity=p).onEnd(()=>{i.exists()&&e.destroy(i)})}}function Xy(e,t,o,n,s,a,r){e.get("enemy").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);if(l.takeDamage?l.takeDamage(i):l.hp&&l.hurt(i),c>0){const h=e.vec2(l.pos.x-t,l.pos.y-o).unit(),u=a*d;l.pos.x+=h.x*u*.1,l.pos.y+=h.y*u*.1}}}),e.get("miniboss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);l.takeDamage&&l.takeDamage(i,null)}}),e.get("boss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);l.takeDamage&&l.takeDamage(i,null)}}),e.get("player").forEach(l=>{if(!l.exists()||l.isDead)return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d*.5);if(!l.invulnerable&&(l.hurt(i),c>0)){const h=e.vec2(l.pos.x-t,l.pos.y-o).unit(),u=a*d;l.pos.x+=h.x*u*.05,l.pos.y+=h.y*u*.05}}})}function Fy(e,t,o,n,s){const a=n*1.2;Fn.forEach(r=>{if(!r.exists()||r.isExploding||r.barrelId===s)return;e.vec2(r.pos.x-t,r.pos.y-o).len()<=a&&r.takeDamage(r.maxHealth,s)})}function ll(e,t,o=5){return Fn.find(n=>{if(!n.exists()||n.isExploding)return!1;const s=Math.abs(n.pos.x-e),a=Math.abs(n.pos.y-t);return s<=o&&a<=o})||null}function Yy(){Fn.forEach(e=>{e.exists()&&(e.healthBarBg&&e.healthBarBg.exists()&&e.healthBarBg.destroy(),e.healthBarFill&&e.healthBarFill.exists()&&e.healthBarFill.destroy(),e.destroy())}),Fn=[]}class Ca{constructor(t=128){this.cellSize=t,this.cells=new Map,this.entityToCell=new Map}getCellKey(t,o){const n=Math.floor(t/this.cellSize),s=Math.floor(o/this.cellSize);return`${n},${s}`}insert(t){if(!t||!t.pos)return;const o=this.getCellKey(t.pos.x,t.pos.y);this.cells.has(o)||this.cells.set(o,new Set),this.cells.get(o).add(t),this.entityToCell.set(t,o)}remove(t){if(!t)return;const o=this.entityToCell.get(t);if(!o)return;const n=this.cells.get(o);n&&(n.delete(t),n.size===0&&this.cells.delete(o)),this.entityToCell.delete(t)}update(t){if(!t||!t.pos)return;const o=this.entityToCell.get(t),n=this.getCellKey(t.pos.x,t.pos.y);o!==n&&(this.remove(t),this.insert(t))}getNearby(t,o,n){const s=[],a=Math.ceil(n/this.cellSize),r=this.getCellKey(t,o),[l,c]=r.split(",").map(Number);for(let d=-a;d<=a;d++)for(let i=-a;i<=a;i++){const h=`${l+d},${c+i}`,u=this.cells.get(h);u&&s.push(...u)}return s}getInBounds(t,o,n,s){const a=[],r=Math.floor(t/this.cellSize),l=Math.floor(o/this.cellSize),c=Math.floor(n/this.cellSize),d=Math.floor(s/this.cellSize);for(let i=r;i<=c;i++)for(let h=l;h<=d;h++){const u=`${i},${h}`,p=this.cells.get(u);p&&a.push(...p)}return a}getAt(t,o){const n=this.getCellKey(t,o),s=this.cells.get(n);return s?[...s]:[]}clear(){this.cells.clear(),this.entityToCell.clear()}getStats(){let t=0,o=0,n=1/0;return this.cells.forEach(s=>{const a=s.size;t+=a,o=Math.max(o,a),n=Math.min(n,a)}),{cellCount:this.cells.size,totalEntities:t,averageEntitiesPerCell:this.cells.size>0?(t/this.cells.size).toFixed(2):0,maxEntitiesInCell:o,minEntitiesInCell:n===1/0?0:n,cellSize:this.cellSize}}}let Fo=null,ys=1,Zi=1,Jr=1,bh=!0,jr=!0,mo=null,dr=null;const qy={menu:"./audio/menu-theme.mp3",combat:"./audio/combat-theme.mp3",defeat:"./audio/defeat-theme.mp3"},Ra={};function wh(){return Fo||(Fo=new(window.AudioContext||window.webkitAudioContext)),Fo}function Gy(){Fo&&Fo.state==="suspended"&&Fo.resume().then(()=>{console.log("[Audio] AudioContext resumed")}).catch(e=>{console.warn("[Audio] Failed to resume AudioContext:",e)})}function Zr(){return Fo||wh(),Fo&&Fo.state==="suspended"&&Fo.resume(),Fo}function vh(e){ys=Math.max(0,Math.min(1,e)),mo&&(mo.volume=Zi*ys)}function Eh(e){Jr=Math.max(0,Math.min(1,e))}function Ah(e){bh=e}function Sh(e){jr=e}function Ve(e,t,o="square",n=.3,s={}){if(s.isUI&&!bh||s.isCombat&&!jr)return;const a=Zr(),r=a.currentTime,l=a.createOscillator();l.type=o,l.frequency.setValueAtTime(e,r),s.pitchBend&&l.frequency.exponentialRampToValueAtTime(e*s.pitchBend,r+t);const c=a.createGain(),d=n*Jr*ys,i=s.attack||.01;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(d,r+i);const h=s.decay||.1;c.gain.setValueAtTime(d,r+t-h),c.gain.exponentialRampToValueAtTime(.01,r+t),l.connect(c),c.connect(a.destination),l.start(r),l.stop(r+t)}function Es(e,t=.3,o={}){if(o.isCombat&&!jr)return;const n=Zr(),s=n.currentTime,a=n.sampleRate*e,r=n.createBuffer(1,a,n.sampleRate),l=r.getChannelData(0);for(let g=0;g<a;g++)l[g]=Math.random()*2-1;const c=n.createBufferSource();c.buffer=r;const d=n.createBiquadFilter();d.type=o.filterType||"lowpass",d.frequency.setValueAtTime(o.filterFreq||2e3,s);const i=n.createGain(),h=t*Jr*ys,u=o.attack||.01,p=o.decay||.1;i.gain.setValueAtTime(0,s),i.gain.linearRampToValueAtTime(h,s+u),i.gain.setValueAtTime(h,s+e-p),i.gain.exponentialRampToValueAtTime(.01,s+e),c.connect(d),d.connect(i),i.connect(n.destination),c.start(s),c.stop(s+e)}function Ue(e,t=.1){return e*(1+(Math.random()-.5)*t)}function Mh(){const e=Math.random();e<.33?Ve(Ue(280,.15),.08,"triangle",.14,{attack:.002,decay:.05,pitchBend:.65}):e<.66?Ve(Ue(320,.15),.09,"sine",.13,{attack:.003,decay:.06,pitchBend:.7}):Ve(Ue(300,.15),.07,"triangle",.14,{attack:.002,decay:.04,pitchBend:.6})}function Ky(){const e=Math.random();e<.33?Ve(Ue(220,.3),.04,"triangle",.08,{attack:.001,decay:.025,pitchBend:.5}):e<.66?Ve(Ue(240,.3),.035,"sine",.09,{attack:.001,decay:.02,pitchBend:.6}):Ve(Ue(200,.3),.045,"triangle",.08,{attack:.001,decay:.03,pitchBend:.4})}function Vy(){const e=Ue(60,.15);Ve(e,.1,"sine",.12,{attack:.002,decay:.08,pitchBend:.4}),Es(Ue(.04,.2),Ue(.12,.2),{attack:.002,decay:.06,filterType:"lowpass",filterFreq:Ue(800,.3)})}function Wy(){Ve(Ue(350,.2),.05,"triangle",.12,{attack:.001,decay:.03,pitchBend:.3}),Ve(Ue(50,.15),.1,"sine",.1,{attack:.001,decay:.07,pitchBend:.5})}function $y(){Es(.08,Ue(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:Ue(800,.5)})}function Jy(){Ve(Ue(55,.2),.15,"sine",.1,{attack:.002,decay:.12,pitchBend:.4}),Ve(Ue(100,.2),.12,"triangle",.08,{attack:.005,decay:.08,pitchBend:.5})}function jy(){Ve(Ue(250,.3),.08,"triangle",.1,{attack:.001,decay:.06,pitchBend:1.6}),Es(Ue(.03,.3),.08,{attack:.001,decay:.04,filterType:"bandpass",filterFreq:Ue(2e3,.4)})}function Zy(){Ve(Ue(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function Qy(){Mh()}function dl(){const e=Math.random();e<.25?Ve(Ue(280,.2),.06,"sine",.12,{attack:.002,decay:.04,pitchBend:.2}):e<.5?Ve(Ue(320,.2),.05,"triangle",.12,{attack:.002,decay:.035,pitchBend:.15}):e<.75?Ve(Ue(240,.2),.07,"sine",.14,{attack:.003,decay:.05,pitchBend:.25}):Ve(Ue(360,.2),.05,"triangle",.1,{attack:.002,decay:.03,pitchBend:.1})}function vn(){const e=Math.random();e<.33?(Ve(Ue(180,.2),.1,"triangle",.18,{attack:.003,decay:.07,pitchBend:.2}),Ve(Ue(400,.2),.06,"sine",.1,{attack:.005,decay:.04,pitchBend:.1})):e<.66?(Ve(Ue(160,.2),.12,"triangle",.18,{attack:.003,decay:.08,pitchBend:.25}),Ve(Ue(320,.2),.07,"sine",.12,{attack:.005,decay:.05,pitchBend:.15})):(Ve(Ue(200,.2),.11,"triangle",.18,{attack:.003,decay:.08,pitchBend:.3}),Ve(Ue(440,.2),.05,"sine",.08,{attack:.005,decay:.03,pitchBend:.1}))}function hl(){const e=Math.random();e<.33?Ve(Ue(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(Ve(Ue(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),Es(.15,.12,{attack:.05,decay:.1,filterFreq:Ue(1500,.4)})):Ve(Ue(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function Th(){Ve(Ue(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),Ve(Ue(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),Es(Ue(.3,.2),Ue(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:Ue(1200,.5)})}function ky(){const e=Math.random();e<.33?Ve(Ue(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?Ve(Ue(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):Ve(Ue(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function ul(){const e=Math.random();e<.33?(Ve(Ue(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{Ve(Ue(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(Ve(Ue(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),Ve(Ue(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(Ve(Ue(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{Ve(Ue(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function ex(){Zr().currentTime;const t=400;[1,1.25,1.5,2].forEach((n,s)=>{setTimeout(()=>{Ve(t*n,.15,"square",.2,{attack:.01,decay:.1})},s*80)})}function Ia(){Ve(Ue(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Ut(){Ve(Ue(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function Ze(){Ve(Ue(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function tx(){Ve(Ue(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{Ve(Ue(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function fl(){Ve(Ue(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{Ve(Ue(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function ox(){for(let t=0;t<8;t++)setTimeout(()=>{Ve(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{Th()},480)}function nx(){[400,500,600,800].forEach((t,o)=>{setTimeout(()=>{Ve(t,.2,"square",.18,{attack:.01,decay:.15})},o*100)})}function vi(){Ve(Ue(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{Ve(Ue(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function Pa(){Ve(Ue(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),Es(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:Ue(500,.3)})}function sx(){Ve(Ue(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function pl(){Ve(Ue(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function ix(e){const t=e?.toLowerCase()||"";t.includes("pistol")?Mh():t.includes("smg")||t.includes("submachine")?Ky():t.includes("shotgun")?Vy():t.includes("sniper")||t.includes("rifle")?Wy():t.includes("flame")||t.includes("thrower")?$y():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?Jy():t.includes("chain")||t.includes("lightning")?jy():t.includes("orbital")?Zy():Qy()}function Dh(e){Zi=Math.max(0,Math.min(1,e)),mo&&(mo.volume=Zi*ys)}function Ch(){mo&&(mo.pause(),mo.currentTime=0,mo=null,dr=null)}function Qr(e,t=!0){if(dr===e&&mo&&!mo.paused)return;Ch();const o=qy[e];if(!o){console.warn(`[Music] Unknown track: ${e}`);return}try{Ra[e]||(Ra[e]=new Audio(o)),mo=Ra[e],mo.loop=t,mo.volume=Zi*ys,dr=e;const n=mo.play();n!==void 0&&n.catch(s=>{console.warn(`[Music] Playback failed for ${e}:`,s.message)})}catch(n){console.warn(`[Music] Failed to play ${e}:`,n.message)}}function gl(){Qr("menu")}function ax(){Qr("combat")}function rx(){Qr("defeat")}function Go(e,t,o,n={}){const s=yh();if(s)return s.acquire(t,o,n);const{char:a="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:i=1,fadeStart:h=.3,friction:u=.95,zIndex:p=100}=n,g=e.add([e.text(a,{size:r}),e.pos(t,o),e.anchor("center"),e.color(...l),e.z(p),"particle"]);return g.velocity={x:c.x,y:c.y},g.gravity=d,g.friction=u,g.lifetime=i,g.fadeStart=h,g.age=0,g.initialOpacity=1,g}function cx(e,t){const o=yh();o&&t._pooled?o.release(t):e.destroy(t)}function lx(e){e.get("particle").forEach(o=>{if(!o.exists()||o.hidden)return;if(o.age+=e.dt(),o.age>=o.lifetime){cx(e,o);return}o.pos.x+=o.velocity.x*e.dt()*60,o.pos.y+=o.velocity.y*e.dt()*60,o.velocity.y+=o.gravity*e.dt()*60,o.velocity.x*=o.friction,o.velocity.y*=o.friction;const n=o.age/o.lifetime;if(n>=o.fadeStart){const s=(n-o.fadeStart)/(1-o.fadeStart);o.opacity=o.initialOpacity*(1-s)}})}function go(e,t,o,n={}){const{count:s=8,color:a=[255,50,50],speed:r=2,isCrit:l=!1}=n,c=[".",",","'","`","*"],d=l?s*1.5:s,i=l?r*1.5:r,h=l?[255,200,0]:a;for(let u=0;u<d;u++){const p=Math.PI*2*u/d+(Math.random()-.5)*.5,g=.5+Math.random()*.5,M={x:Math.cos(p)*i*g,y:Math.sin(p)*i*g};Go(e,t,o,{char:c[Math.floor(Math.random()*c.length)],size:8+Math.random()*6,color:h,velocity:M,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function Ys(e,t,o,n={}){const{count:s=8,color:a=[255,100,100],speed:r=2.5,isBoss:l=!1,isMiniboss:c=!1}=n,d=["*","+",""],i=l?s*2:c?s*1.5:s,h=l?r*1.5:c?r*1.2:r;for(let u=0;u<i;u++){const p=Math.PI*2*u/i+(Math.random()-.5)*.3,g=.6+Math.random()*.4,M={x:Math.cos(p)*h*g,y:Math.sin(p)*h*g};Go(e,t,o,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*6,color:a,velocity:M,gravity:.1,lifetime:.5+Math.random()*.3,fadeStart:.2,friction:.92})}}function Ps(e,t,o,n,s={}){const{count:a=5,color:r=[255,255,100],speed:l=2.5,isCrit:c=!1}=s,d=["","","",""],i=c?a*2:a,h=c?[255,200,0]:r,u=Math.sqrt(n.x*n.x+n.y*n.y),p=u>0?{x:n.x/u,y:n.y/u}:{x:1,y:0};for(let g=0;g<i;g++){const M=(Math.random()-.5)*Math.PI*.6,m=Math.atan2(p.y,p.x)+M,T=.6+Math.random()*.8,P={x:Math.cos(m)*l*T,y:Math.sin(m)*l*T};Go(e,t,o,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*4,color:h,velocity:P,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function dx(e,t,o,n,s){const r={trailFire:["","","",""],trailIce:["*","","",""],trailPoison:["~","","",""],trailShadow:["","","",""],trailRainbow:["","","",""]}[n]||["","","*"],l=r[Math.floor(Math.random()*r.length)];let c=s;if(s==="rainbow"){const h=Date.now()*.1%360;c=hx(h,100,60)}const d=(Math.random()-.5)*8,i=(Math.random()-.5)*8;Go(e,t+d,o+i,{char:l,size:10+Math.random()*6,color:c,velocity:{x:(Math.random()-.5)*.3,y:(Math.random()-.5)*.3},gravity:n==="trailFire"?-.02:.01,lifetime:.4+Math.random()*.2,fadeStart:.2,friction:.98,zIndex:-10})}function hx(e,t,o){t/=100,o/=100;const n=t*Math.min(o,1-o),s=a=>{const r=(a+e/30)%12;return o-n*Math.max(Math.min(r-3,9-r,1),-1)};return[Math.round(s(0)*255),Math.round(s(8)*255),Math.round(s(4)*255)]}function ml(e,t,o,n){const s=e.add([e.text("",{size:48}),e.pos(t.pos.x,t.pos.y),e.anchor("center"),e.color(...n),e.opacity(.3),e.z(-5),"playerGlow"]);return s.target=t,s.glowType=o,s.pulseTime=0,s.baseOpacity=.25,s}function ux(e,t){if(!t||!t.exists()||!t.target||!t.target.exists()){t&&t.exists()&&e.destroy(t);return}t.pos=t.target.pos.clone(),t.pulseTime+=e.dt()*3;const o=Math.sin(t.pulseTime)*.1;t.opacity=t.baseOpacity+o,t.glowType==="glowElectric"&&Math.random()<.05&&(t.opacity=t.baseOpacity+.3)}function fx(e,t,o,n,s=[255,100,100]){switch(n){case"deathExplosion":px(e,t,o,s);break;case"deathDisintegrate":gx(e,t,o,s);break;case"deathVaporize":mx(e,t,o,s);break;case"deathPixelate":yx(e,t,o,s);break;case"deathFireworks":xx(e,t,o,s);break;default:Ys(e,t,o,{color:s})}}function px(e,t,o,n){const s=["*","#","@","X","+",""],r=e.add([e.text("",{size:40}),e.pos(t,o),e.anchor("center"),e.color(255,255,200),e.opacity(1),e.z(200),"particle"]);r.age=0,r.lifetime=.2,r.fadeStart=0,r.velocity={x:0,y:0},r.gravity=0,r.friction=1;for(let l=0;l<20;l++){const c=Math.PI*2*l/20,d=4+Math.random()*2;Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:14+Math.random()*10,color:[255,200,100],velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.92})}for(let l=0;l<20/2;l++){const c=Math.random()*Math.PI*2,d=2+Math.random()*2;Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:10+Math.random()*6,color:n,velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}}function gx(e,t,o,n){const s=["","","","","",""];for(let r=0;r<25;r++){const l=(Math.random()-.5)*20,c=(Math.random()-.5)*20,d=Math.random()*Math.PI*2,i=.5+Math.random()*1.5;Go(e,t+l,o+c,{char:s[Math.floor(Math.random()*s.length)],size:8+Math.random()*8,color:[n[0]*(.6+Math.random()*.4),n[1]*(.6+Math.random()*.4),n[2]*(.6+Math.random()*.4)],velocity:{x:Math.cos(d)*i,y:Math.sin(d)*i},gravity:.2,lifetime:1+Math.random()*.5,fadeStart:.5,friction:.96})}}function mx(e,t,o,n){const s=["~","","","",""];for(let r=0;r<20;r++){const l=(Math.random()-.5)*15,c=Math.random()*Math.PI*2,d=.3+Math.random()*.5;Go(e,t+l,o,{char:s[Math.floor(Math.random()*s.length)],size:10+Math.random()*10,color:[Math.min(255,n[0]+100),Math.min(255,n[1]+100),Math.min(255,n[2]+100)],velocity:{x:Math.cos(c)*d,y:-1.5-Math.random()*1.5},gravity:-.05,lifetime:1.2+Math.random()*.5,fadeStart:.3,friction:.98})}}function yx(e,t,o,n){const s=["","","","","",""];for(let l=-5/2;l<=5/2;l++)for(let c=-5/2;c<=5/2;c++){const d=l*6,i=c*6,h=Math.sqrt(l*l+c*c),u=Math.atan2(c,l),p=1+h*.3+Math.random()*.5;Go(e,t+d,o+i,{char:s[Math.floor(Math.random()*s.length)],size:8+Math.random()*4,color:n,velocity:{x:Math.cos(u)*p,y:Math.sin(u)*p},gravity:.08,lifetime:.6+Math.random()*.4,fadeStart:.4,friction:.94})}}function xx(e,t,o,n){const s=["*","+","x","X","#"];for(let c=0;c<12;c++){const d=Math.PI*2*c/12,i=.7+Math.random()*.6,h={x:Math.cos(d)*3*i,y:Math.sin(d)*3*i};Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:12+Math.random()*8,color:n,velocity:h,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const l=Math.floor(12/2);for(let c=0;c<l;c++){const d=Math.random()*Math.PI*2,i=.3+Math.random()*.4,h={x:Math.cos(d)*3*i*.5,y:Math.sin(d)*3*i*.5};Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:16+Math.random()*8,color:[255,200,100],velocity:h,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}const Rh="superSmashTexty_settings",si={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:.35,uiSounds:!0,combatSounds:!0},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showHitFreeze:!0,showDamageNumbers:!0,compactHUD:!1,showFPS:!1,showTimer:!0},gameplay:{autoPause:!1,autoPickupCurrency:!1,autoPickupXP:!1,confirmBeforeQuit:!0,skipIntroAnimation:!1},accessibility:{colorblindMode:"off",reducedMotion:!1,largeText:!1,highContrast:!1}};function kr(){try{const e=localStorage.getItem(Rh);if(e){const t=JSON.parse(e);return Ih(si,t)}}catch(e){console.error("Error loading settings:",e)}return{...si}}function Ih(e,t){const o={...e};return Ba(e)&&Ba(t)&&Object.keys(t).forEach(n=>{Ba(t[n])?n in e?o[n]=Ih(e[n],t[n]):Object.assign(o,{[n]:t[n]}):Object.assign(o,{[n]:t[n]})}),o}function Ba(e){return e&&typeof e=="object"&&!Array.isArray(e)}function Ph(e){try{return localStorage.setItem(Rh,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function hr(){return kr()}function Gt(e,t,o){const n=kr();return n[e]||(n[e]={}),n[e][t]=o,Ph(n),n}function Bh(e,t){return kr()[e]?.[t]??si[e]?.[t]}function bx(){return Ph({...si}),{...si}}let Ao=null,Qo=null,ko=0,Tn=0,$s=!1,ur=0;const wx=.05;let fr=0;const vx=100;function Ex(e){Ao=e}function En(e=5,t=.1){if(!Ao||!Bh("visual","showScreenShake"))return;const o=Ao.time();if(o-ur<wx){ko>0&&(Tn=Math.max(Tn,e),ko=Math.max(ko,t));return}ur=o,ko<=0&&(Qo=Ao.camPos()),Tn=Math.max(Tn,e),ko=Math.max(ko,t)}function Ax(e){if(!(!Ao||ko<=0))if(ko-=e,ko>0){const t=(Math.random()-.5)*2*Tn,o=(Math.random()-.5)*2*Tn;Qo&&Ao.camPos(Qo.x+t,Qo.y+o)}else Qo&&Ao.camPos(Qo),Tn=0,Qo=null}function Bs(e=50){if(!Ao||!Bh("visual","showHitFreeze")||Ao.paused||$s)return;const t=Date.now();t-fr<vx||(fr=t,Ao.paused=!0,$s=!0,setTimeout(()=>{Ao.paused=!1,$s=!1},e))}function Sx(){return $s}const hn={playerHit:()=>{En(6,.1),Bs(30)},criticalHit:()=>{En(4,.08),Bs(40)},bossHit:()=>{En(3,.05)},bossDeath:()=>{En(15,.3),Bs(100)},explosion:()=>{En(10,.2),Bs(60)},playerDeath:()=>{En(12,.25),Bs(150)},levelUp:()=>{En(5,.15)},smallImpact:()=>{En(2,.05)}};function Mx(){ko=0,Tn=0,Ao&&Qo&&Ao.camPos(Qo),Qo=null,ur=0,fr=0,$s=!1}function Ls(e,t,o,n){if(!t||!t.exists())return;const s=20,a=e.width()-s,r=e.height()-s,l=s,c=s,d=t.pos.x+o.x*n,i=t.pos.y+o.y*n,h=Math.max(l,Math.min(a,d)),u=Math.max(c,Math.min(r,i)),p=t.pos.x,g=t.pos.y;t.pos.x=h,t.pos.y=u;const M=e.get("wall"),m=e.get("obstacle"),T=[...M,...m];let P=!1;for(const f of T)if(f.exists()&&t.isColliding&&t.isColliding(f)){P=!0;break}P&&(t.pos.x=p,t.pos.y=g)}function yl(e,t){let o=0;t.weaponKey==="orbital"&&pr(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.isRemote)t.aimAngle!==void 0&&(t.angle=t.aimAngle,t.outline&&t.outline.exists()&&(t.outline.angle=t.aimAngle));else{const i=Yc();let h,u;if(i.active&&(i.x!==0||i.y!==0))h=e.vec2(i.x,i.y),u=1;else{const p=e.mousePos();h=e.vec2(p.x-t.pos.x,p.y-t.pos.y),u=h.len()}if(u>0){const p=Math.atan2(h.y,h.x)*(180/Math.PI);t.angle=p,t.outline&&t.outline.exists()&&(t.outline.angle=p)}}if(t.canShoot===!1){t.isShooting=!1;return}const n=e.get("enemy"),s=e.get("boss"),a=e.get("miniboss");if(!(n.length>0||s.length>0||a.length>0)&&t.weaponKey!=="orbital"){t.isShooting=!1;return}if(t.weaponKey==="orbital"){Tx(e,t),t.isShooting=!1;return}const l=e.time();let c,d=!1;if(t.isRemote){if(le()&&!pe()){t.isShooting=!1;return}if(t.aimAngle!==void 0&&t.isShooting){const i=t.aimAngle*(Math.PI/180);c=e.vec2(Math.cos(i),Math.sin(i)),d=!0}else{t.isShooting=!1;return}}else{const i=Yc();let h,u;if(i.active&&(i.x!==0||i.y!==0))h=e.vec2(i.x,i.y),u=1;else{const p=e.mousePos();h=e.vec2(p.x-t.pos.x,p.y-t.pos.y),u=h.len()}if(u>0){if(t.aimAngle=Math.atan2(h.y,h.x)*(180/Math.PI),c=h.unit(),le()&&!pe()){t.isShooting=u>0&&t.canShoot;return}d=!0}else{t.aimAngle=0,t.isShooting=!1;return}t.isShooting=u>0&&t.canShoot}if(d&&c){let i=t.fireRate;if(t.bulletTimeEnabled&&t.bulletTimeBonus&&t.move&&(t.move.x!==0||t.move.y!==0)&&(i=t.fireRate*(1+t.bulletTimeBonus)),t.speedDemonEnabled&&t.speedDemonFireRatePerStack){const h=t.upgradeStacks?.speed||0;h>0&&(i=i*(1+h*t.speedDemonFireRatePerStack))}if(l-o>=1/i){const h=t.projectileCount||1,u=t.spreadAngle||0,p=[];if(h===1)p.push(c);else if(u>0){const g=h>1?u/(h-1):0,M=-u/2;for(let m=0;m<h;m++){const P=(M+g*m)*(Math.PI/180),f=Math.cos(P),N=Math.sin(P),O=e.vec2(c.x*f-c.y*N,c.x*N+c.y*f);p.push(O.unit())}}else for(let g=0;g<h;g++)p.push(c);p.forEach((g,M)=>{const m=u===0&&h>1?M*ro.MULTISHOT_STAGGER_DELAY:0;e.wait(m,()=>{const T=kg(t.critChance||0);let P=T?em(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(P=Math.floor(P*t.piercingDamageBonus));let f=t.weaponRange||us.DEFAULT_WEAPON_RANGE;if(T&&t.deadeyeEnabled&&t.deadeyeRangeBonus&&(f=f*(1+t.deadeyeRangeBonus)),ix(t.weaponKey),t.weaponKey==="flamethrower"){const N=To(e,t.pos.x,t.pos.y,g,t.projectileSpeed,P,t.piercing||0,t.obstaclePiercing||0,T,f);t.weaponDef&&N.useWeaponVisual(t.weaponDef),N.ownerSlotIndex=t.slotIndex;const O=Math.floor(P*.3),w=2,A=t.fireDotMultiplier||1;N.burnDamage=Math.floor(O*A),N.burnDuration=w,le()&&pe()&&cs(N,{weaponKey:t.weaponKey,burnDamage:N.burnDamage,burnDuration:N.burnDuration})}else if(t.weaponKey==="explosive"){const N=Dx(e,t.pos.x,t.pos.y,g,t.projectileSpeed,P,t.explosionRadius,t.explosionDamage,f,T);t.weaponDef&&N.useWeaponVisual(t.weaponDef),N.ownerSlotIndex=t.slotIndex,le()&&pe()&&cs(N,{weaponKey:t.weaponKey,explosionRadius:N.explosionRadius,explosionDamage:N.explosionDamage})}else if(t.weaponKey==="chainLightning"){const N=Cx(e,t.pos.x,t.pos.y,g,t.projectileSpeed,P,t.chainRange,t.maxJumps,t.chainDamageReduction,f,T);t.weaponDef&&N.useWeaponVisual(t.weaponDef),N.ownerSlotIndex=t.slotIndex,le()&&pe()&&cs(N,{weaponKey:t.weaponKey,chainRange:N.chainRange,maxJumps:N.maxJumps,chainDamageReduction:N.chainDamageReduction})}else if(t.weaponKey==="boomerang"){const N=To(e,t.pos.x,t.pos.y,g,t.projectileSpeed,P,t.piercing||0,t.obstaclePiercing||0,T,f);N.isBoomerang=!0,N.ownerPlayer=t,N.returnSpeedMultiplier=t.weaponDef?.returnSpeedMultiplier||1.2,t.weaponDef&&N.useWeaponVisual(t.weaponDef),N.ownerSlotIndex=t.slotIndex,le()&&pe()&&cs(N,{weaponKey:t.weaponKey})}else{const N=To(e,t.pos.x,t.pos.y,g,t.projectileSpeed,P,t.piercing||0,t.obstaclePiercing||0,T,f);t.weaponDef&&N.useWeaponVisual(t.weaponDef),N.ownerSlotIndex=t.slotIndex,le()&&pe()&&cs(N,{weaponKey:t.weaponKey||"pistol"})}})}),o=l,Mm(t)}}}),e.onCollide("projectile","wall",(n,s)=>{if(!e.paused){if(n.isExplosive){La(e,n,n.pos.x,n.pos.y);return}n.piercedObstacles&&n.piercedObstacles.has(s)||(n.obstaclePiercing>0?(n.piercedObstacles&&n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)):e.destroy(n))}}),e.onCollide("projectile","cover",(n,s)=>{if(!e.paused&&n.obstaclePiercing>0&&n.piercedObstacles){if(n.piercedObstacles.has(s))return;n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)}}),e.onCollide("projectile","obstacle",(n,s)=>{e.paused||n.isExplosive||n.piercedObstacles&&n.piercedObstacles.has(s)||(n.obstaclePiercing>0?(n.piercedObstacles&&n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)):e.destroy(n))}),e.onCollide("projectile","barrel",(n,s)=>{e.paused||!s.exists()||s.isExploding||n.isEnemyProjectile||n.isBossProjectile||(s.takeDamage&&s.takeDamage(1),n.piercing>0||n.obstaclePiercing>0?n.piercedObstacles&&n.piercedObstacles.add(s):n.isExplosive||n.exists()&&e.destroy(n))}),e.onCollide("projectile","enemy",(n,s)=>{if(e.paused||n.isEnemyProjectile||n.isBossProjectile)return;const a=2,r=n.reflectionCount||0;if(s.reflectsProjectiles&&!n.isReflected&&r<a&&Math.random()<(s.reflectChance||.4)){n.isReflected=!0,n.reflectionCount=r+1,n.isEnemyProjectile=!0,n.direction=e.vec2(-n.direction.x,-n.direction.y),n.color=e.rgb(255,100,100),n.damage=Math.floor(n.damage*.7),e.add([e.text("*",{size:20}),e.pos(s.pos.x,s.pos.y),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.lifespan(.3),e.z(500)]);return}if(n.isExplosive){La(e,n,s.pos.x,s.pos.y);return}if(n.isChainLightning){if(n.chainedEnemies&&n.chainedEnemies.has(s))return;if(!le()||pe()){const i=n.chainJumps||0,h=1-(n.chainDamageReduction||.15)*i,u=Math.floor(n.damage*Math.max(.1,h));s.takeDamage?s.takeDamage(u):s.hurt(u)}n.chainedEnemies&&n.chainedEnemies.add(s),n.chainJumps<n.maxJumps?xl(e,n,s):e.destroy(n);return}if(n.piercedEnemies&&n.piercedEnemies.has(s))return;if(le()&&!pe()){dl(),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}dl();let l=n.damage;if(n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);h&&h.executionerEnabled&&h.executionerThreshold&&s.hp()/(s.maxHealth||s.hp())<h.executionerThreshold&&(l=Math.floor(l*(1+(h.executionerDamageBonus||1))))}if(s.takeDamage?s.takeDamage(l):s.hurt(l),n.isCrit&&n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);if(h&&h.vampiricCrits&&h.vampiricHealPercent){const u=Math.floor(l*h.vampiricHealPercent);if(u>0&&h.hp()<h.maxHealth){const p=Math.min(h.maxHealth,h.hp()+u);h.setHP(p)}}}if(n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);if(h&&h.lifestealPercent&&h.lifestealPercent>0){let u=h.lifestealPercent;n.isCrit&&h.vampireLordEnabled&&h.vampireLordMultiplier&&(u*=h.vampireLordMultiplier);const p=Math.floor(l*u);if(p>0&&h.hp()<h.maxHealth){const g=Math.min(h.maxHealth,h.hp()+p);h.setHP(g),le()&&pe()&&mh({slotIndex:h.slotIndex,healAmount:p,newHP:g,source:"lifesteal"})}}}if(n.ownerSlotIndex!==void 0){s.lastHitBySlot=n.ownerSlotIndex;const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);h&&h.survivalistEnabled&&(h.survivalistLastCombatTime=e.time())}le()&&pe()&&Qm({targetId:s.mpEntityId,targetType:"enemy",damage:l,isCrit:n.isCrit||!1,x:s.pos.x,y:s.pos.y}),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);const c=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);if(c.len()>0){const i=c.unit(),h=ro.KNOCKBACK_ENEMY_FROM_PROJECTILE;Ls(e,s,i,h)}Ps(e,s.pos.x,s.pos.y,c,{isCrit:n.isCrit}),n.isCrit&&hn.criticalHit(),s.color=n.isCrit?e.rgb(...ro.CRIT_COLOR):e.rgb(...ro.HIT_COLOR),e.wait(ro.HIT_FLASH_DURATION,()=>{s.exists()&&(s.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(n,s)=>{if(e.paused)return;if(n.isExplosive){La(e,n,s.pos.x,s.pos.y);return}if(n.isChainLightning){if(n.chainedEnemies&&n.chainedEnemies.has(s))return;if(!le()||pe()){const r=n.chainJumps||0,l=1-(n.chainDamageReduction||.15)*r,c=Math.floor(n.damage*Math.max(.1,l));s.takeDamage?s.takeDamage(c):s.hurt(c)}n.chainedEnemies&&n.chainedEnemies.add(s),e.wait(.01,()=>{n.exists()&&(n.chainJumps<n.maxJumps?xl(e,n,s):e.destroy(n))});return}if(n.piercedEnemies&&n.piercedEnemies.has(s))return;if(le()&&!pe()){go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const r=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Ps(e,s.pos.x,s.pos.y,r,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}s.takeDamage?s.takeDamage(n.damage):s.hurt(n.damage),n.ownerSlotIndex!==void 0&&(s.lastHitBySlot=n.ownerSlotIndex),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);const a=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);a.len()>0&&Ls(e,s,a.unit(),ro.KNOCKBACK_BOSS_FROM_PROJECTILE),Ps(e,s.pos.x,s.pos.y,a,{isCrit:n.isCrit}),n.isCrit?hn.criticalHit():hn.bossHit(),s.color=n.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{s.exists()&&s.updateVisual()})}),e.onCollide("projectile","miniboss",(n,s)=>{if(e.paused||n.isEnemyProjectile||n.isBossProjectile||n.piercedEnemies&&n.piercedEnemies.has(s))return;if(le()&&!pe()){go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const l=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Ps(e,s.pos.x,s.pos.y,l,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}let a=n.damage;n.isCrit&&(a=Math.floor(a*1.5)),s.takeDamage?s.takeDamage(a):s.hurt(a),n.ownerSlotIndex!==void 0&&(s.lastHitBySlot=n.ownerSlotIndex),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const r=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Ps(e,s.pos.x,s.pos.y,r,{isCrit:n.isCrit}),n.isCrit&&hn.criticalHit(),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n),s.color=n.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{s.exists()&&s.updateVisual()})}),e.onCollide("enemy","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(le()&&!pe()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(...ro.HIT_COLOR);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){le()&&pe()&&Ta({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}vn(),hn.playerHit();const a=n.damage||ro.BASE_ENEMY_DAMAGE,r=Aa(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),n.lifesteal&&n.exists()){const d=n.hp(),i=n.maxHealth;if(d<i){const h=Math.min(i,d+n.lifesteal);n.setHP(h)}}if(n.isVampiric&&n.vampiricHealAmount&&n.exists()){const d=n.hp(),i=n.maxHealth;if(d<i){const h=Math.min(i,d+n.vampiricHealAmount);n.setHP(h)}}if(s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=ro.KNOCKBACK_ENEMY;Ls(e,n,d,i)}s.color=e.rgb(...ro.HIT_COLOR)}),e.onCollide("miniboss","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(le()&&!pe()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){le()&&pe()&&Ta({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}vn(),hn.playerHit();let a=ro.BASE_MINIBOSS_DAMAGE;(n.type==="brute"||n.type==="berserker"||n.type==="guardian")&&n.meleeDamage&&(a=n.meleeDamage);const r=Aa(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.takeDamage?n.takeDamage(d):n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.takeDamage?n.takeDamage(i):n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=ro.KNOCKBACK_MINIBOSS;Ls(e,n,d,i)}s.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(le()&&!pe()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){le()&&pe()&&Ta({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}vn(),hn.playerHit();let a=ro.BASE_BOSS_DAMAGE;if(n.type==="twinGuardianMelee"&&n.meleeDamage){const d=n.enraged?ro.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;a=n.meleeDamage*d}const r=Aa(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.takeDamage?n.takeDamage(d):n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.takeDamage?n.takeDamage(i):n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=ro.KNOCKBACK_BOSS;Ls(e,n,d,i)}s.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(n,s)=>{if(e.paused||!n.isBossProjectile&&!n.isEnemyProjectile||s.isDead||s.hp()<=0||s.invulnerable)return;if(le()&&!pe()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100),e.destroy(n);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){e.destroy(n);return}vn(),hn.playerHit();const a=n.damage*(1-(s.damageReduction||0)),r=Math.max(1,a-(s.defense||0));s.hurt(r),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),e.destroy(n),s.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(n,s)=>{if(!e.paused&&s.exists()&&!(n.contactCooldown>0)){if(le()&&!pe()){n.contactCooldown=n.contactCooldownDuration||.2;return}s.hurt(n.damage),n.contactCooldown=n.contactCooldownDuration||.2}}),e.onCollide("orbital","boss",(n,s)=>{if(!e.paused&&s.exists()&&!(n.contactCooldown>0)){if(le()&&!pe()){n.contactCooldown=n.contactCooldownDuration||.2;return}s.takeDamage?s.takeDamage(n.damage):s.hurt(n.damage),n.contactCooldown=n.contactCooldownDuration||.2}})}function pr(e,t){t.orbitalOrbs&&t.orbitalOrbs.length>0&&t.orbitalOrbs.forEach(s=>{s&&s.exists()&&e.destroy(s)}),t.orbitalOrbs=[],t.orbitalAngles=[];const o=t.projectileCount||1,n=t.orbitRadius||us.BASE_ORBIT_RADIUS;for(let s=0;s<o;s++){const a=360/o*s,r=a*Math.PI/180,l=t.pos.x+Math.cos(r)*n,c=t.pos.y+Math.sin(r)*n,d=e.add([e.text(t.weaponDef?.char||"",{size:16}),e.pos(l,c),e.anchor("center"),e.color(...t.weaponDef?.color||[100,200,255]),e.area(),"orbital","playerProjectile"]);d.damage=t.projectileDamage||12,d.contactCooldown=0,d.contactCooldownDuration=us.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(d),t.orbitalAngles.push(a)}}function Tx(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(a=>{a.exists()&&a.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],pr(e,t),t.orbitalNeedsReinit=!1);const o=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==o)&&pr(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const n=t.rotationSpeed||us.BASE_ROTATION_SPEED,s=t.orbitRadius||us.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((a,r)=>{if(!a.exists())return;t.orbitalAngles[r]=(t.orbitalAngles[r]+n*e.dt())%360;const l=t.orbitalAngles[r]*Math.PI/180;a.pos.x=t.pos.x+Math.cos(l)*s,a.pos.y=t.pos.y+Math.sin(l)*s,a.contactCooldown>0&&(a.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(a=>a.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function Dx(e,t,o,n,s,a,r,l,c,d=!1){const i=To(e,t,o,n,s,a,0,0,d,c);return i.isExplosive=!0,i.explosionRadius=r||50,i.explosionDamage=l||15,i}function Cx(e,t,o,n,s,a,r,l,c,d,i=!1){const h=To(e,t,o,n,s,a,0,0,i,d);return h.isChainLightning=!0,h.chainRange=r||70,h.maxJumps=l||3,h.chainDamageReduction=c||.15,h.chainJumps=0,h.chainedEnemies=new Set,h}function La(e,t,o,n){if(!t.exists())return;Th(),hn.explosion();const s=t.explosionRadius||50,a=t.explosionDamage||15;if(!le()||pe()){const l=e.get("enemy"),c=e.get("boss"),d=[...l,...c];for(const i of d){if(!i.exists())continue;e.vec2(i.pos.x-o,i.pos.y-n).len()<=s&&(i.takeDamage?i.takeDamage(a):i.hurt(a))}}const r=e.add([e.text("*",{size:24}),e.pos(o,n),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{r.exists()&&e.destroy(r)}),e.destroy(t)}function xl(e,t,o){if(!t.exists())return;const n=t.chainRange||70,s=e.get("enemy"),a=e.get("boss"),r=[...s,...a];let l=null,c=n;for(const d of r){if(!d.exists()||d===o||t.chainedEnemies&&t.chainedEnemies.has(d))continue;const i=e.vec2(d.pos.x-o.pos.x,d.pos.y-o.pos.y).len();i<=n&&i<c&&(l=d,c=i)}if(l){t.chainJumps=(t.chainJumps||0)+1;const d=o.pos,i=l.pos,h=e.vec2(i.x-d.x,i.y-d.y).len(),u=Math.atan2(i.y-d.y,i.x-d.x),p=(d.x+i.x)/2,g=(d.y+i.y)/2,M=e.add([e.rect(h,2),e.pos(p,g),e.anchor("center"),e.rotate(u),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{M.exists()&&e.destroy(M)}),t.pos.x=l.pos.x,t.pos.y=l.pos.y}else e.destroy(t)}const Rx={movement:{id:"movement",message:"Use WASD to move",duration:3,trigger:"firstMove"},shooting:{id:"shooting",message:"Aim with mouse - autofire!",duration:3,trigger:"firstShoot"},levelUp:{id:"levelUp",message:"Choose upgrade with 1-3 or click",duration:4,trigger:"firstLevelUp"},synergy:{id:"synergy",message:"Combine upgrades for bonuses!",duration:4,trigger:"firstSynergy"},shop:{id:"shop",message:"Spend credits on permanent upgrades",duration:4,trigger:"firstShopVisit"}},Lh="superSmashTexty_tutorialProgress";let za=null;function zh(){try{const e=localStorage.getItem(Lh);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load tutorial progress:",e)}return{hintsShown:[]}}function Ix(e){try{localStorage.setItem(Lh,JSON.stringify(e))}catch(t){console.warn("Failed to save tutorial progress:",t)}}function Px(e){return zh().hintsShown.includes(e)}function Bx(e){const t=zh();t.hintsShown.includes(e)||(t.hintsShown.push(e),Ix(t))}function Oh(e,t){if(za||Px(t))return!1;const o=Rx[t];if(!o)return!1;Bx(t);const n=e.add([e.rect(300,40),e.pos(e.width()/2,50),e.anchor("center"),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(700),"tutorialHint"]),s=e.add([e.text(o.message,{size:16}),e.pos(e.width()/2,50),e.anchor("center"),e.color(255,255,200),e.fixed(),e.z(701),"tutorialHint"]);return za={bg:n,text:s},e.wait(o.duration,()=>{n.exists()&&e.destroy(n),s.exists()&&e.destroy(s),za=null}),!0}function Lx(e){Oh(e,"movement")}function zx(e){Oh(e,"synergy")}const Hh={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}},glassCannon:{name:"Glass Cannon",description:"Damage x3 + Health: -25% max HP, +100% damage",required:["damage","damage","damage","health"],requiredCounts:{damage:3,health:1},apply:e=>{if((e.upgradeStacks?.damage||0)>=3){const o=Math.floor(e.maxHealth*.75);e.maxHealth=o;const n=Math.max(1,Math.floor(o*.25)),s=Math.max(n,Math.min(e.hp(),o));e.setHP(s),e.projectileDamage=Math.floor(e.projectileDamage*2)}}},vampiricRounds:{name:"Vampiric Rounds",description:"Crit Chance + Crit Damage + Health: Heal 5% of crit damage",required:["critChance","critDamage","health"],apply:e=>{e.vampiricCrits=!0,e.vampiricHealPercent=.05}},bulletTime:{name:"Bullet Time",description:"Speed + Fire Rate: +20% fire rate while moving",required:["speed","fireRate"],apply:e=>{e.bulletTimeEnabled=!0,e.bulletTimeBonus=.2}},berserker:{name:"Berserker",description:"Damage x3 + Speed x2: +50% damage/speed below 30% HP",requiredCounts:{damage:3,speed:2},apply:e=>{e.berserkerEnabled=!0,e.berserkerThreshold=.3,e.berserkerDamageBonus=.5,e.berserkerSpeedBonus=.5}},deadeye:{name:"Deadeye",description:"Crit x2 + Range x2: Crits have +50% range",requiredCounts:{critChance:2,range:2},apply:e=>{e.deadeyeEnabled=!0,e.deadeyeRangeBonus=.5}},survivor:{name:"Survivalist",description:"Health x2 + Defense x2: Regen 1% HP/sec out of combat",requiredCounts:{health:2,defense:2},apply:e=>{e.survivalistEnabled=!0,e.survivalistRegenPercent=.01,e.survivalistCombatCooldown=3,e.survivalistLastCombatTime=0}},thornMaster:{name:"Retribution",description:"Thorns x3 + Defense x2: Thorns ignore enemy armor",requiredCounts:{thorns:3,defense:2},apply:e=>{e.thornsIgnoreArmor=!0,e.thornsPercent=(e.thornsPercent||0)*1.5}},vampireLord:{name:"Vampire Lord",description:"Lifesteal x3 + Crit Dmg x2: Crits heal 3x lifesteal",requiredCounts:{lifesteal:3,critDamage:2},apply:e=>{e.vampireLordEnabled=!0,e.vampireLordMultiplier=3}},executioner:{name:"Executioner",description:"Damage x2 + Piercing x2: +100% damage to enemies <25% HP",requiredCounts:{damage:2,piercing:2},apply:e=>{e.executionerEnabled=!0,e.executionerThreshold=.25,e.executionerDamageBonus=1}},speedDemon:{name:"Speed Demon",description:"Speed x3 + Fire Rate x2: +1% fire rate per speed stack",requiredCounts:{speed:3,fireRate:2},apply:e=>{e.speedDemonEnabled=!0,e.speedDemonFireRatePerStack=.01}},fortress:{name:"Fortress",description:"Health x3 + Invuln x2: Immunity blocks all damage sources",requiredCounts:{health:3,invulnTime:2},apply:e=>{e.fortressEnabled=!0,e.invulnerableDuration=(e.invulnerableDuration||1)*1.5}}};function Uh(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function zi(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const o=[];for(const[n,s]of Object.entries(Hh)){let a=!1;if(s.requiredCounts){a=!0;for(const[r,l]of Object.entries(s.requiredCounts))if((t.upgradeStacks?.[r]||0)<l){a=!1;break}}else a=s.required.every(r=>t.selectedUpgrades.has(r));a&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(n)||(s.apply(t),t.activeSynergies.add(n),o.push(s),zx(e),Ox(e,s)))}return o}function Ox(e,t){const o=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),n=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{o.exists()&&(e.destroy(o),e.destroy(n))})}function bl(e){if(!(!e.activeSynergies||e.activeSynergies.size===0))for(const t of e.activeSynergies){const o=Hh[t];o&&o.apply&&o.apply(e)}}let oo=!1;function Hx(e,t,o,n=null,s=null,a=null){if(oo)return;oo=!0;const r=le();r||(e.paused=!0),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()));const l=Pt("toughChoices"),c=Pt("mulligan"),d=3+l;let i=a!==null?a:c,h=0;function u(){let f=null;if(le()){const N=t.playerIndex!==void 0?t.playerIndex:0,O=s||t.level||1;f=ly(N,O+h*100)}return Im(d,t,f)}let p=u();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.opacity(.9),e.fixed(),e.z(b.MODAL),"upgradeOverlay"]);const g=r&&n?`${n} - Level Up! Choose an Upgrade`:"Level Up! Choose an Upgrade";e.add([e.text(g,{size:Z.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.MODAL+1),"upgradeUI"]);function M(){e.get("upgradeCard").forEach(C=>e.destroy(C));const f=200,N=150,O=e.width()-40;let w,A,S;if(p.length<=3)w=f,A=N,S=250;else if(p.length<=5)w=160,A=130,S=180;else{const C=O/p.length;w=Math.min(140,C-10),A=120,S=w+10}const I=e.width()/2-S*(p.length-1)/2,E=e.height()/2,L=[];return p.forEach((C,F)=>{const U=I+F*S,_=e.add([e.rect(w,A),e.pos(U,E),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.MODAL+1),e.area(),"upgradeUI","upgradeCard"]),H=w<=140?32:48;if(C.icon){const fe=C.category==="passive"?y.SUCCESS:C.weaponKey?y.WARNING:y.INFO;e.add([e.text(C.icon,{size:H}),e.pos(U,E-A/3),e.anchor("center"),e.color(...fe),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"])}const R=w<=140?12:Z.BUTTON;e.add([e.text(C.name,{size:R,width:w-10}),e.pos(U,E-5),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"]);const Y=w<=140?10:Z.BODY,V=Pm(C,t);e.add([e.text(V,{size:Y,width:w-10}),e.pos(U,E+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"]);const Q=w<=140?14:Z.HEADER;e.add([e.text(`${F+1}`,{size:Q}),e.pos(U+w/2-15,E-A/2+12),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"]),L.push({card:_,upgrade:C,index:F}),_.onClick(()=>{oo&&P(F)})}),L}M();let m=null;if(c>0){const f=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.WARNING)),e.fixed(),e.z(b.MODAL+1),e.area(),"upgradeUI"]);m=e.add([e.text(`(R) Reroll (${i})`,{size:14}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.MODAL+2),"upgradeUI"]),f.onClick(()=>{oo&&i>0&&T()})}function T(){i<=0||(i--,h++,p=u(),M(),m&&m.exists()&&(m.text=`(R) Reroll (${i})`,i===0&&(m.color=e.rgb(...y.TEXT_SECONDARY))))}function P(f){if(!oo)return;const N=p[f];tx(),oo=!1,Yr(t,N.key),Uh(t,N.key);const O=zi(e,t);if(le()&&t.slotIndex!==void 0&&(oy(t.slotIndex,N.key),O&&O.length>0)){const w=O.map(A=>A.name);sy(t.slotIndex,w)}e.get("upgradeUI").forEach(w=>e.destroy(w)),e.get("upgradeOverlay").forEach(w=>e.destroy(w)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),r||(e.paused=!1),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{o&&o(N,i)})}e.onKeyPress("1",()=>{oo&&p.length>=1&&P(0)}),e.onKeyPress("2",()=>{oo&&p.length>=2&&P(1)}),e.onKeyPress("3",()=>{oo&&p.length>=3&&P(2)}),e.onKeyPress("4",()=>{oo&&p.length>=4&&P(3)}),e.onKeyPress("5",()=>{oo&&p.length>=5&&P(4)}),e.onKeyPress("6",()=>{oo&&p.length>=6&&P(5)}),e.onKeyPress("7",()=>{oo&&p.length>=7&&P(6)}),e.onKeyPress("8",()=>{oo&&p.length>=8&&P(7)}),e.onKeyPress("9",()=>{oo&&p.length>=9&&P(8)}),e.onKeyPress("0",()=>{oo&&p.length>=10&&P(9)}),e.onKeyPress("r",()=>{oo&&i>0&&T()})}function Ei(){return oo}function wl(e,t,o=null,n=!1){let s=!1;t.pendingLevelUps=t.pendingLevelUps||[],t.addXP=function(r){if(e.paused||s)return;const l=t.xpMultiplier||1,c=Math.floor(r*l);for(t.xp+=c;t.xp>=t.xpToNext&&!s&&t.xpToNext>0;){s=!0,t.xp-=t.xpToNext,t.level++;const d=t.level;t.xpToNext=Math.max(1,Math.floor(t.xpToNext*fn.XP_SCALING_FACTOR)),a(e,t,d)}};function a(r,l,c){if(r.paused&&!n){s=!1;return}ex();const d=r.add([r.text(`Level ${c}!`,{size:24}),r.pos(r.width()/2,fn.LEVEL_UP_NOTIFICATION_Y),r.anchor("center"),r.color(255,255,100),r.fixed(),r.z(1e3)]);n&&l.slotIndex!==void 0&&ny(l.slotIndex,c),l.pendingLevelUps.push(c),r.wait(fn.LEVEL_UP_NOTIFICATION_DURATION,()=>{d.exists()&&r.destroy(d),s=!1})}return{processPendingLevelUp:()=>{if(t.pendingLevelUps.length>0&&!s){s=!0;const r=t.pendingLevelUps.shift(),l=t.playerName||(t.isRemote?`Player ${t.slotIndex+1}`:"You");Hx(e,t,()=>{s=!1},n?l:null,r)}}}}const Ux={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:18,turret:12,heavyTank:18,zippy:18,exploder:20,splitter:14},3:{mage:15,shieldBearer:12,golem:12,wraith:12,spawner:12,buffer:15,orbiter:7,phaser:8,mimic:7},4:{healer:18,teleporter:15,freezer:18,leech:20,reflector:14,bomber:15}};function Nx(){return{basic:15,rusher:25,tank:30,fast:30}}function _x(e,t=null){const o=Object.values(e).reduce((s,a)=>s+a,0);let n=(t?t.next():Math.random())*o;for(const[s,a]of Object.entries(e))if(n-=a,n<=0)return s;return Object.keys(e)[0]}function gr(e=1,t=null){const o=Ux[e]||Nx();return _x(o,t)}const Nh={swift:{name:"Swift",prefix:"",color:[255,255,100],apply:e=>{e.speed=Math.floor(e.speed*1.5)}},armored:{name:"Armored",prefix:"",color:[100,150,255],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*2),e.setHP(e.maxHealth),e.damageReduction=(e.damageReduction||0)+.25}},vampiric:{name:"Vampiric",prefix:"",color:[255,100,100],apply:e=>{e.isVampiric=!0,e.vampiricHealAmount=10}}},vl={2:{spawnChance:.1},3:{spawnChance:.12},4:{spawnChance:.15}};function Xx(e,t=null){if(e<2)return!1;const o=vl[e]||vl[4];return(t?t.next():Math.random())<o.spawnChance}function Fx(e=null){const t=Object.keys(Nh),o=e?e.next():Math.random(),n=Math.floor(o*t.length);return t[n]}function Yx(e,t,o){const n=Nh[o];if(!n)return;t.isElite=!0,t.eliteModifier=o,n.apply(t);const s=`${n.prefix}${t.coreChar}`;t.coreChar=s,t.text=s,t.originalColor=n.color,t.color=e.rgb(...n.color),t.xpValue=Math.floor(t.xpValue*1.5),t.updateVisual&&t.updateVisual()}function El(e,t,o,n=null){if(t.isBoss||t.isBossEnemy||!Xx(o,n))return!1;const s=Fx(n);return Yx(e,t,s),!0}const qx=800,Gx=600,Ai=20;let Js=null;const Yn={empty:{name:"Empty Room",obstacles:[],barrels:[],spawnDoors:null,floorAffinity:[1]},streetCorners:{name:"Street Corners",obstacles:[{x:150,y:150,width:50,height:50,type:"cover",char:""},{x:650,y:150,width:50,height:50,type:"cover",char:""},{x:150,y:450,width:50,height:50,type:"cover",char:""},{x:650,y:450,width:50,height:50,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:400}],spawnDoors:null,floorAffinity:[1]},alleyway:{name:"Alleyway",obstacles:[{x:200,y:200,width:30,height:200,type:"wall",char:""},{x:600,y:200,width:30,height:200,type:"wall",char:""}],barrels:[{x:250,y:250},{x:550,y:350}],spawnDoors:null,floorAffinity:[1]},factoryFloor:{name:"Factory Floor",obstacles:[{x:200,y:180,width:80,height:40,type:"wall",char:""},{x:600,y:180,width:80,height:40,type:"wall",char:""},{x:200,y:420,width:80,height:40,type:"wall",char:""},{x:600,y:420,width:80,height:40,type:"wall",char:""},{x:400,y:300,width:60,height:60,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:[2]},assemblyLine:{name:"Assembly Line",obstacles:[{x:250,y:250,width:300,height:25,type:"wall",char:""},{x:250,y:350,width:300,height:25,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[2]},storageYard:{name:"Storage Yard",obstacles:[{x:180,y:180,width:50,height:50,type:"cover",char:""},{x:620,y:180,width:50,height:50,type:"cover",char:""},{x:180,y:420,width:50,height:50,type:"cover",char:""},{x:620,y:420,width:50,height:50,type:"cover",char:""},{x:320,y:300,width:40,height:40,type:"cover",char:""},{x:480,y:300,width:40,height:40,type:"cover",char:""}],barrels:[{x:250,y:250},{x:550,y:250},{x:250,y:350},{x:550,y:350},{x:400,y:200}],spawnDoors:null,floorAffinity:[2]},serverRoom:{name:"Server Room",obstacles:[{x:200,y:150,width:30,height:300,type:"wall",char:""},{x:350,y:150,width:30,height:300,type:"wall",char:""},{x:500,y:150,width:30,height:300,type:"wall",char:""},{x:650,y:150,width:30,height:300,type:"wall",char:""}],barrels:[{x:275,y:200},{x:425,y:400},{x:575,y:250}],spawnDoors:null,floorAffinity:[3]},controlCenter:{name:"Control Center",obstacles:[{x:400,y:200,width:120,height:80,type:"wall",char:""},{x:200,y:350,width:60,height:60,type:"cover",char:""},{x:600,y:350,width:60,height:60,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:200},{x:400,y:450}],spawnDoors:null,floorAffinity:[3]},dataVault:{name:"Data Vault",obstacles:[{x:250,y:200,width:40,height:40,type:"wall",char:""},{x:550,y:200,width:40,height:40,type:"wall",char:""},{x:250,y:400,width:40,height:40,type:"wall",char:""},{x:550,y:400,width:40,height:40,type:"wall",char:""},{x:400,y:300,width:100,height:100,type:"wall",char:""}],barrels:[{x:180,y:300},{x:620,y:300}],spawnDoors:null,floorAffinity:[3]},hiveCluster:{name:"Hive Cluster",obstacles:[{x:300,y:180,width:50,height:50,type:"cover",char:""},{x:500,y:180,width:50,height:50,type:"cover",char:""},{x:200,y:300,width:50,height:50,type:"cover",char:""},{x:600,y:300,width:50,height:50,type:"cover",char:""},{x:300,y:420,width:50,height:50,type:"cover",char:""},{x:500,y:420,width:50,height:50,type:"cover",char:""}],barrels:[{x:400,y:180},{x:400,y:420},{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:[4]},bioLab:{name:"Bio Lab",obstacles:[{x:300,y:250,width:200,height:30,type:"wall",char:""},{x:300,y:350,width:200,height:30,type:"wall",char:""},{x:400,y:300,width:30,height:130,type:"wall",char:""}],barrels:[{x:200,y:200},{x:600,y:200},{x:200,y:400},{x:600,y:400},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[4]},xenoNest:{name:"Xeno Nest",obstacles:[{x:400,y:300,width:80,height:80,type:"wall",char:""},{x:250,y:200,width:35,height:35,type:"cover",char:""},{x:550,y:200,width:35,height:35,type:"cover",char:""},{x:250,y:400,width:35,height:35,type:"cover",char:""},{x:550,y:400,width:35,height:35,type:"cover",char:""}],barrels:[{x:180,y:150},{x:620,y:150},{x:180,y:450},{x:620,y:450}],spawnDoors:null,floorAffinity:[4]},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],barrels:[{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],barrels:[{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],barrels:[{x:150,y:290},{x:650,y:290}],spawnDoors:null,floorAffinity:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],barrels:[{x:250,y:200},{x:550,y:200},{x:250,y:400},{x:550,y:400}],spawnDoors:null,floorAffinity:null},barrelRoom:{name:"Barrel Room",obstacles:[{x:400,y:300,width:50,height:50,type:"cover",char:""}],barrels:[{x:250,y:200},{x:300,y:200},{x:275,y:250},{x:500,y:400},{x:550,y:400},{x:525,y:350},{x:150,y:150},{x:650,y:450}],spawnDoors:null,floorAffinity:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],barrels:[{x:450,y:200},{x:250,y:400},{x:600,y:350}],spawnDoors:null,floorAffinity:null}};function Kx(e,t,o,n){const s=o/2,a=n/2,r=Ai+s,l=qx-Ai-s,c=Ai+a,d=Gx-Ai-a,i=Math.max(r,Math.min(l,e)),h=Math.max(c,Math.min(d,t));return{x:i,y:h}}function Vx(e,t){const o={1:{wall:[55,55,65],obstacle:[70,70,80],cover:[85,85,95]},2:{wall:[75,60,50],obstacle:[90,70,55],cover:[100,80,65]},3:{wall:[45,55,75],obstacle:[55,70,95],cover:[65,85,115]},4:{wall:[60,45,70],obstacle:[75,55,85],cover:[90,65,100]},5:{wall:[35,30,45],obstacle:[45,38,55],cover:[55,45,65]}},n=o[Math.min(t,5)]||o[5];return{wallColor:e.rgb(...n.wall),obstacleColor:e.rgb(...n.obstacle),coverColor:e.rgb(...n.cover)}}function qs(e,t=null){const o=Object.keys(Yn),n=Js?o.filter(h=>h!==Js):o,s=[],a=[];n.forEach(h=>{const u=Yn[h];u.floorAffinity===null?a.push(h):u.floorAffinity.includes(e)&&s.push(h)});const l=s.length>0&&(t?t.next():Math.random())<.7?s:a.length>0?a:n,c=l.length>0?l:o,d=t?t.range(0,c.length):Math.floor(Math.random()*c.length),i=c[d];return Js=i,{key:i,...Yn[i]}}function Wx(e,t=null,o=1){const n=Yn[e];if(!n||!n.barrels||n.barrels.length===0)return[];let s=[...n.barrels];if(o>=2&&(t?t.next():Math.random())<.3+o*.1){const r=100+(t?t.next():Math.random())*600,l=100+(t?t.next():Math.random())*400;s.push({x:r,y:l})}return o===1&&(t?t.next():Math.random())<.5&&s.length>1&&(s=s.slice(0,Math.ceil(s.length/2))),s}function $x(){Js=null}function Al(e){return Yn[e]?(Js=e,{key:e,...Yn[e]}):(console.warn(`Unknown room template key: ${e}, falling back to empty`),{key:"empty",...Yn.empty})}let ec=[],tc=null;function Jx(e){if(Hr(e))return!1;if(Og(e)){if(ec.push(e),tc){const t=an[e];t&&(nx(),Lm(t),le()&&Sy(e,Ay()))}return!0}return!1}function jx(e){ec=[],tc=e,e&&Gr(e)}function Zx(){return[...ec]}function Si(e,t=null){e&&(tc=e,Gr(e));const o=vs(),n={bestFloor:Math.max(o.bestFloor||0,t?.floor||0),totalEnemiesKilled:(o.totalEnemiesKilled||0)+(t?.enemiesKilled||0),totalBossesKilled:(o.totalBossesKilled||0)+(t?.bossesKilled||0),totalRuns:o.totalRuns||0,bestLevel:Math.max(o.bestLevel||0,t?.level||0),totalCurrencyEarned:(o.totalCurrencyEarned||0)+(t?.currencyEarned||0)},s=[],a=(r,l)=>{r&&Jx(l)&&s.push(l)};return a(n.bestFloor>=2,"floor2"),a(n.bestFloor>=3,"floor3"),a(n.bestFloor>=5,"floor5"),a(n.bestFloor>=10,"floor10"),a(n.bestFloor>=15,"floor15"),a(n.bestFloor>=20,"floor20"),a(n.totalEnemiesKilled>=1,"firstKill"),a(n.totalEnemiesKilled>=100,"kill100"),a(n.totalEnemiesKilled>=500,"kill500"),a(n.totalEnemiesKilled>=1e3,"kill1000"),a(n.totalEnemiesKilled>=5e3,"kill5000"),a(n.totalEnemiesKilled>=1e4,"kill10000"),a(n.totalBossesKilled>=1,"firstBoss"),a(n.totalBossesKilled>=5,"boss5"),a(n.totalBossesKilled>=10,"boss10"),a(n.totalBossesKilled>=25,"boss25"),a(n.totalBossesKilled>=50,"boss50"),a(n.totalRuns>=1,"firstRun"),a(n.totalRuns>=10,"run10"),a(n.totalRuns>=50,"run50"),a(n.totalRuns>=100,"run100"),a(n.bestLevel>=10,"level10"),a(n.bestLevel>=20,"level20"),a(n.bestLevel>=30,"level30"),a(n.bestLevel>=50,"level50"),a(n.totalCurrencyEarned>=100,"earn100"),a(n.totalCurrencyEarned>=500,"earn500"),a(n.totalCurrencyEarned>=1e3,"earn1000"),a(n.totalCurrencyEarned>=5e3,"earn5000"),a(n.totalCurrencyEarned>=1e4,"earn10000"),s}class Mi{constructor(t,o,n="combat"){this.position={x:t,y:o},this.type=n,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=n==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:o,y:n}=this.position;switch(t){case"up":return{x:o,y:n-1};case"down":return{x:o,y:n+1};case"right":return{x:o+1,y:n};default:return null}}}class Qx{constructor(t,o=6,n=3,s=null){this.floor=t,this.width=o,this.height=n,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.rng=s,this.generate()}random(){return this.rng?this.rng.next():Math.random()}randomRange(t,o){return this.rng?this.rng.range(t,o):Math.floor(Math.random()*(o-t))+t}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const o=this.height===1?0:this.randomRange(0,this.height);this.bossPosition={x:this.width-1,y:o};const n=new Mi(0,t,"start");this.setRoom(0,t,n);const s=new Mi(this.width-1,o,"boss");this.setRoom(this.width-1,o,s),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const o of t)if(!this.getRoom(o.x,o.y)){const n=new Mi(o.x,o.y,"combat");this.setRoom(o.x,o.y,n)}}findPath(t,o){const n=[];let s={...t};for(;s.x<o.x||s.y!==o.y;)n.push({...s}),s.x<o.x?s.y!==o.y&&this.random()<.3?s.y+=s.y<o.y?1:-1:s.x+=1:s.y+=s.y<o.y?1:-1;return n.push({...o}),n}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let o=0;for(let n=1;n<this.width-1;n++)for(let s=0;s<this.height&&!(o>=t);s++){if(this.getRoom(n,s))continue;if(n>0&&this.getRoom(n-1,s)&&this.random()<.5){const r=new Mi(n,s,"combat");this.setRoom(n,s,r),o++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const n=this.getRoom(t,o);n&&(t<this.width-1&&this.getRoom(t+1,o)&&(n.connections.right=!0),o>0&&this.getRoom(t,o-1)&&(n.connections.up=!0),o<this.height-1&&this.getRoom(t,o+1)&&(n.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const n=this.getRoom(t,o);if(n&&(n.type!=="boss"&&(n.template=qs(this.floor,this.rng)),n.type==="combat")){const s=this.randomRange(3,6);n.enemyTypes=[];for(let a=0;a<s;a++)n.enemyTypes.push(gr(this.floor,this.rng))}}}validate(){const t=new Set,o=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);o.length>0;){const n=o.shift(),s=this.getRoom(n.x,n.y);if(!s)continue;if(s.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const a=["up","down","right"];for(const r of a)if(s.connections[r]){const l=s.getAdjacentPosition(r),c=`${l.x},${l.y}`;t.has(c)||(t.add(c),o.push(l))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,o){return t<0||t>=this.width||o<0||o>=this.height?null:this.grid[o][t]}setRoom(t,o,n){t<0||t>=this.width||o<0||o>=this.height||(this.grid[o][t]=n,this.rooms.set(n.getKey(),n))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const o=[],n=["up","down","right"];for(const s of n)if(t.connections[s]){const a=t.getAdjacentPosition(s),r=this.getRoom(a.x,a.y);r&&!r.visited&&o.push({direction:s,position:a,room:r})}return o}markRoomVisited(t,o){const n=this.getRoom(t,o);n&&(n.visited=!0,this.visitedRooms.add(n.getKey()))}markRoomCleared(t,o){const n=this.getRoom(t,o);n&&(n.cleared=!0)}moveToRoom(t){const o=this.getCurrentRoom();if(!o||!o.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const n=o.getAdjacentPosition(t);return this.getRoom(n.x,n.y)?(this.currentPosition=n,this.markRoomVisited(n.x,n.y),console.log(`[FloorMap] Moved to room (${n.x}, ${n.y})`),!0):(console.warn(`[FloorMap] No room found at ${n.x}, ${n.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let o=0;o<this.height;o++){const n=[];for(let s=0;s<this.width;s++){const a=this.getRoom(s,o);a?s===this.currentPosition.x&&o===this.currentPosition.y?n.push({type:"current",room:a}):a.visited?n.push({type:"visited",room:a}):this.isRoomRevealed(s,o)?n.push({type:"revealed",room:a}):n.push({type:"hidden"}):n.push({type:"empty"})}t.push(n)}return t}isRoomRevealed(t,o){if(!this.getRoom(t,o))return!1;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:a,dy:r}of s){const l=this.getRoom(t+a,o+r);if(l&&l.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let o="";for(let n=0;n<this.width;n++){const s=this.getRoom(n,t);s?s.type==="start"?o+="[S]":s.type==="boss"?o+="[B]":n===this.currentPosition.x&&t===this.currentPosition.y?o+="[]":s.visited?o+="[]":o+="[R]":o+="[ ]",o+=" "}console.log(o)}console.log(`
Connections:`);for(const[t,o]of this.rooms){const n=[];o.connections.up&&n.push(""),o.connections.down&&n.push(""),o.connections.right&&n.push(""),console.log(`  (${o.position.x}, ${o.position.y}): ${n.join(", ")||"none"}`)}}}function kx(e,t=null){const o=Math.min(3+e,10),n=Math.min(2+Math.floor(e/2),6),s=new Qx(e,o,n,t);return s.debugPrint(),s}const An={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"},Wt={MARGIN_RIGHT:12,MARGIN_TOP:32,BUTTON_SIZE:38,OPEN_WIDTH:130,OPEN_HEIGHT:85,MAX_MIN_WIDTH:200,MAX_MIN_HEIGHT:160,CELL_SIZE_SMALL:11,CELL_SIZE_LARGE:16,Z_BASE:900,Z_TEXT:901,Z_ICON:902},Ft={BG_PANEL:[25,25,40],BG_HEADER:[35,35,55],BORDER:[80,120,180],BORDER_HOVER:[120,160,220],TEXT_TITLE:[200,210,255],TEXT_MUTED:[140,140,160],ICON_MAP:[130,160,220],BADGE_FLOOR:[255,220,80],CURRENT:[255,255,100],VISITED:[80,220,100],AVAILABLE:[120,120,140],BOSS:[255,90,90],HIDDEN:[50,50,70],CELL_BG:[30,30,45],CELL_BORDER:[45,45,60]};class e1{constructor(t,o){this.k=t,this.floorMap=o,this.mode=An.MINIMIZED,this.elements=[],this.isHovered=!1,this.floorMap&&typeof this.floorMap.getGridForMinimap=="function"&&this.render()}getRightX(){return this.k.width()-Wt.MARGIN_RIGHT}getTopY(){return Wt.MARGIN_TOP}toggle(){try{Ze()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===An.MINIMIZED?this.mode=An.OPEN:this.mode===An.OPEN?this.mode=An.MAXIMIZED:this.mode=An.MINIMIZED,this.k.wait(0,()=>{this.update()})}update(){this.clear(),this.render()}clear(){this.elements.forEach(t=>{t.exists()&&this.k.destroy(t)}),this.elements=[]}render(){this.mode===An.MINIMIZED?this.renderMinimized():this.mode===An.OPEN?this.renderOpen():this.renderMaximized()}createPanel(t,o,n,s){const a=this.k.add([this.k.rect(t,o),this.k.pos(n,s),this.k.anchor("topright"),this.k.color(...Ft.BG_PANEL),this.k.outline(2,this.k.rgb(...Ft.BORDER)),this.k.fixed(),this.k.z(Wt.Z_BASE),this.k.area(),this.k.opacity(.95),"minimap"]);return a.onHover(()=>{a.outline.color=this.k.rgb(...Ft.BORDER_HOVER),a.outline.width=3}),a.onHoverEnd(()=>{a.outline.color=this.k.rgb(...Ft.BORDER),a.outline.width=2}),a.onClick(()=>this.toggle()),this.elements.push(a),a}renderMinimized(){const t=this.getRightX(),o=this.getTopY(),n=Wt.BUTTON_SIZE;this.createPanel(n,n,t,o);const s=t-n/2,a=o+n/2,r=this.k.add([this.k.text("",{size:22}),this.k.pos(s,a),this.k.anchor("center"),this.k.color(...Ft.ICON_MAP),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(r);const l=this.k.add([this.k.text(`F${this.floorMap.floor}`,{size:9}),this.k.pos(t-n+4,o+4),this.k.anchor("topleft"),this.k.color(...Ft.BADGE_FLOOR),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(l)}renderOpen(){const t=this.getRightX(),o=this.getTopY(),n=Wt.OPEN_WIDTH,s=Wt.OPEN_HEIGHT,a=Wt.CELL_SIZE_SMALL,r=this.floorMap.getGridForMinimap();if(!r||r.length===0||!r[0]){this.renderMinimized();return}this.createPanel(n,s,t,o);const l=18,c=this.k.add([this.k.rect(n-4,l),this.k.pos(t-2,o+2),this.k.anchor("topright"),this.k.color(...Ft.BG_HEADER),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(c);const d=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t-n/2,o+2+l/2),this.k.anchor("center"),this.k.color(...Ft.TEXT_TITLE),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(d);const i=r[0].length*a;r.length*a;const h=t-n/2-i/2,u=o+l+8;this.renderGrid(r,h,u,a,!1);const p=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()} rooms`,{size:8}),this.k.pos(t-n/2,o+s-8),this.k.anchor("center"),this.k.color(...Ft.TEXT_MUTED),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(p)}renderMaximized(){const t=this.getRightX(),o=this.getTopY(),n=Wt.CELL_SIZE_LARGE,s=this.floorMap.getGridForMinimap();if(!s||s.length===0||!s[0]){this.renderMinimized();return}const a=s[0].length*n,r=s.length*n,l=70,c=26,d=16,i=Math.max(Wt.MAX_MIN_WIDTH,a+d*2),h=Math.max(Wt.MAX_MIN_HEIGHT,r+c+l+d),u=Math.min(i,this.k.width()-Wt.MARGIN_RIGHT-10);this.createPanel(u,h,t,o);const p=this.k.add([this.k.rect(u-4,c),this.k.pos(t-2,o+2),this.k.anchor("topright"),this.k.color(...Ft.BG_HEADER),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(p);const g=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor}    ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:11}),this.k.pos(t-u/2,o+2+c/2),this.k.anchor("center"),this.k.color(...Ft.TEXT_TITLE),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(g);const M=Math.min(a,u-d*2),m=t-u/2-M/2,T=o+c+12;this.renderGrid(s,m,T,n,!0);const P=T+r+12;this.renderLegend(t-u+d,P)}renderGrid(t,o,n,s,a){for(let r=0;r<t.length;r++)for(let l=0;l<t[r].length;l++){const c=t[r][l],d=o+l*s,i=n+r*s;if(c.type==="empty")continue;if(a){const p=this.k.add([this.k.rect(s-2,s-2),this.k.pos(d,i),this.k.anchor("topleft"),this.k.color(...Ft.CELL_BG),this.k.outline(1,this.k.rgb(...Ft.CELL_BORDER)),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(p)}const{char:h,color:u}=this.getCellDisplay(c);if(h){const p=a?12:9,g=this.k.add([this.k.text(h,{size:p}),this.k.pos(d+s/2-1,i+s/2-1),this.k.anchor("center"),this.k.color(...u),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(g)}}}getCellDisplay(t){switch(t.type){case"current":return{char:"",color:Ft.CURRENT};case"visited":return t.room.isBossRoom?{char:"B",color:Ft.BOSS}:{char:"",color:Ft.VISITED};case"revealed":return t.room.isBossRoom?{char:"B",color:[...Ft.BOSS.map(o=>Math.min(255,o+50))]}:{char:"",color:Ft.AVAILABLE};case"hidden":return{char:"",color:Ft.HIDDEN};default:return{char:"",color:[100,100,100]}}}renderLegend(t,o){const n=[{char:"",label:"Current",color:Ft.CURRENT},{char:"",label:"Cleared",color:Ft.VISITED},{char:"",label:"Available",color:Ft.AVAILABLE},{char:"B",label:"Boss",color:Ft.BOSS}],s=80,a=14;n.forEach((r,l)=>{const c=l%2,d=Math.floor(l/2),i=t+c*s,h=o+d*a,u=this.k.add([this.k.text(r.char,{size:10}),this.k.pos(i,h),this.k.anchor("topleft"),this.k.color(...r.color),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(u);const p=this.k.add([this.k.text(r.label,{size:8}),this.k.pos(i+14,h+1),this.k.anchor("topleft"),this.k.color(...Ft.TEXT_MUTED),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(p)})}destroy(){this.clear()}}function t1(e,t){return new e1(e,t)}const Sl={city:{name:"Urban Streets",description:"Abandoned city blocks overrun by chaos",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.18},{char:"",pattern:"vertical_lines",density:"low",opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.22},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:6,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08}],baseColor:[55,55,65],ambientColor:[70,70,80]},mechanical:{name:"Industrial Complex",description:"Rusted factories and hazardous machinery",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.15},{char:"",pattern:"grid",spacing:70,opacity:.18},{char:"",pattern:"scattered",count:5,opacity:.22},{char:"",pattern:"scattered",count:4,opacity:.2},{char:"",pattern:"edges",count:16,opacity:.16},{char:"",pattern:"corners",opacity:.24},{char:"",pattern:"random",count:10,opacity:.1},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"horizontal_lines",density:"low",opacity:.12}],baseColor:[75,60,50],ambientColor:[90,75,60]},futuristic:{name:"Cyber Station",description:"High-tech facility with malfunctioning systems",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.16},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.16},{char:"",pattern:"grid",spacing:90,opacity:.14},{char:"",pattern:"scattered",count:6,opacity:.18},{char:"",pattern:"corners",opacity:.22},{char:"",pattern:"scattered",count:8,opacity:.16},{char:"",pattern:"grid",spacing:150,opacity:.1},{char:"",pattern:"random",count:5,opacity:.12},{char:"",pattern:"edges",count:20,opacity:.15}],baseColor:[45,55,75],ambientColor:[60,80,120]},alien:{name:"Alien Vessel",description:"Otherworldly organic ship interior",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.15},{char:"~",pattern:"random",count:20,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.2},{char:"",pattern:"grid",spacing:110,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:6,opacity:.16},{char:"",pattern:"random",count:12,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08},{char:"",pattern:"random",count:8,opacity:.12},{char:"",pattern:"random",count:8,opacity:.12}],baseColor:[60,45,70],ambientColor:[80,60,100]},void:{name:"The Void",description:"Reality breaks down at the edge of existence",floors:[5,6,7,8],decorations:[{char:"",pattern:"random",count:25,opacity:.15},{char:"",pattern:"random",count:15,opacity:.12},{char:"",pattern:"scattered",count:8,opacity:.18},{char:"",pattern:"grid",spacing:120,opacity:.14},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:10,opacity:.16},{char:"",pattern:"random",count:20,opacity:.1},{char:"",pattern:"random",count:20,opacity:.1}],baseColor:[35,30,45],ambientColor:[50,40,70]}};function o1(e){for(const[t,o]of Object.entries(Sl))if(o.floors.includes(e))return{key:t,...o};return{key:"city",...Sl.city}}function n1(e,t,o=800,n=600){const s=o1(t),a=[],r=30;return s.decorations.forEach(l=>{const c=s.baseColor,d=e.rgb(c[0]+(Math.random()-.5)*20,c[1]+(Math.random()-.5)*20,c[2]+(Math.random()-.5)*20);switch(l.pattern){case"horizontal_lines":{const i=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<n-r;h+=i)a.push({char:l.char,x:o/2,y:h+(Math.random()-.5)*20,color:d,opacity:l.opacity,size:12});break}case"vertical_lines":{const i=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<o-r;h+=i)a.push({char:l.char,x:h+(Math.random()-.5)*20,y:n/2,color:d,opacity:l.opacity,size:12});break}case"wavy_lines":{for(let h=r;h<n-r;h+=60)for(let u=r;u<o-r;u+=40)a.push({char:l.char,x:u+Math.sin(h*.05)*15,y:h,color:d,opacity:l.opacity,size:10});break}case"grid":{const i=l.spacing||80;for(let h=r;h<n-r;h+=i)for(let u=r;u<o-r;u+=i)a.push({char:l.char,x:u+(Math.random()-.5)*10,y:h+(Math.random()-.5)*10,color:d,opacity:l.opacity,size:14});break}case"scattered":{const i=l.count||5;for(let h=0;h<i;h++)a.push({char:l.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(n-r*2),color:d,opacity:l.opacity,size:16});break}case"random":{const i=l.count||10;for(let h=0;h<i;h++)a.push({char:l.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(n-r*2),color:d,opacity:l.opacity,size:10+Math.random()*6});break}case"corners":{[{x:r+40,y:r+40},{x:o-r-40,y:r+40},{x:r+40,y:n-r-40},{x:o-r-40,y:n-r-40}].forEach(h=>{a.push({char:l.char,x:h.x,y:h.y,color:d,opacity:l.opacity,size:18})});break}case"edges":{const i=l.count||8,h=Math.floor(i/4);for(let u=0;u<h;u++)a.push({char:l.char,x:o/h*u+o/(h*2),y:r+20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:o/h*u+o/(h*2),y:n-r-20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:r+20,y:n/h*u+n/(h*2),color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:o-r-20,y:n/h*u+n/(h*2),color:d,opacity:l.opacity,size:12});break}}}),a}function s1(e,t,o=800,n=600){n1(e,t,o,n).forEach(a=>{e.add([e.text(a.char,{size:a.size}),e.pos(a.x,a.y),e.color(a.color),e.opacity(a.opacity),e.z(0),"floorDecoration"])})}class Qi{constructor(t,o){this.playerId=t,this.characterKey=o,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=fn.STARTING_LEVEL,this.xp=fn.STARTING_XP,this.xpToNext=fn.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,velocityX:this.velocityX,velocityY:this.velocityY,health:this.health,maxHealth:this.maxHealth,speed:this.speed,level:this.level,xp:this.xp,xpToNext:this.xpToNext,xpMultiplier:this.xpMultiplier,weaponKey:this.weaponKey,fireRate:this.fireRate,projectileSpeed:this.projectileSpeed,projectileDamage:this.projectileDamage,projectileCount:this.projectileCount,piercing:this.piercing,obstaclePiercing:this.obstaclePiercing,critChance:this.critChance,critDamage:this.critDamage,spreadAngle:this.spreadAngle,weaponRange:this.weaponRange,pickupRadius:this.pickupRadius,defense:this.defense,damageReduction:this.damageReduction,dodgeChance:this.dodgeChance,invulnerable:this.invulnerable,invulnerableTime:this.invulnerableTime,slowed:this.slowed,isDead:this.isDead,weapons:this.weapons,passiveUpgrades:this.passiveUpgrades,upgradeStacks:this.upgradeStacks}}static fromJSON(t){const o=new Qi(t.playerId,t.characterKey);return Object.assign(o,t),o}}class ki{constructor(t,o,n,s,a={}){this.id=t,this.type=o,this.x=n,this.y=s,this.data=a,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new ki(t.id,t.type,t.x,t.y,t.data)}}class ea{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,o){const n=new Qi(t,o);return this.players.set(t,n),this.localPlayerId===null&&(this.localPlayerId=t),n}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,o,n,s={}){const a=this.generateEntityId(),r=new ki(a,t,o,n,s);return this.entities.set(a,r),r}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(o=>o.type===t&&!o.removed)}removeEntity(t){const o=this.entities.get(t);o&&(o.removed=!0)}cleanupRemovedEntities(){for(const[t,o]of this.entities.entries())o.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,o])=>[t,o.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,o])=>[t,o.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const o=new ea;return o.sessionId=t.sessionId,o.gameMode=t.gameMode,o.isPaused=t.isPaused,o.currentFloor=t.currentFloor,o.currentRoom=t.currentRoom,o.roomCleared=t.roomCleared,o.gameTime=t.gameTime,o.localPlayerId=t.localPlayerId,o.nextEntityId=t.nextEntityId,o.players=new Map(t.players.map(([n,s])=>[n,Qi.fromJSON(s)])),o.entities=new Map(t.entities.map(([n,s])=>[n,ki.fromJSON(s)])),o.doors=t.doors,o.obstacles=t.obstacles,o}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class i1{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new ea,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=ea.fromJSON(t),this.gameState}clear(){this.gameState=null}}const Ml=new i1;class oc{constructor(t,o,n){this.playerId=t,this.frameNumber=o,this.timestamp=n,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const o=new oc(t.playerId,t.frameNumber,t.timestamp);return Object.assign(o,t),o}}class a1{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1,this.eventHandlers=[]}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(n=>{this.eventHandlers.push(t.onKeyPress(n,()=>{this.keysPressed.add(n)})),this.eventHandlers.push(t.onKeyRelease(n,()=>{this.keysPressed.delete(n)}))}),this.eventHandlers.push(t.onKeyPress("escape",()=>{this.onPausePressed()})),this.eventHandlers.push(t.onKeyPress("space",()=>{this.onInteractPressed()})),this.eventHandlers.push(t.onKeyPress("e",()=>{this.onInteractPressed()}))}setupMouseListeners(){const t=this.k;this.eventHandlers.push(t.onMouseMove(o=>{this.mouseX=o.x,this.mouseY=o.y})),this.eventHandlers.push(t.onMousePress(()=>{this.mousePressed=!0})),this.eventHandlers.push(t.onMouseRelease(()=>{this.mousePressed=!1}))}collectLocalInput(t){const o=new oc(t,this.frameNumber,Date.now());return o.moveX=this.getMoveX(),o.moveY=this.getMoveY(),o.aimX=this.mouseX,o.aimY=this.mouseY,o.firing=!0,o}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const o=new Map;for(const n of t){const s=this.inputQueues.get(n);let a;s&&s.length>0?a=s.shift():a=this.collectLocalInput(n),o.set(n,a)}return this.currentInputs=o,this.inputHistory.push(new Map(o)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,o}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.eventHandlers.forEach(t=>{t&&t.cancel&&t.cancel()}),this.eventHandlers=[],this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class r1{constructor(){this.inputManager=null}init(t){return this.inputManager=new a1,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const Tl=new r1,Dl={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class ta{constructor(t,o,n=null){this.type=t,this.data=o,this.senderId=n,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const o=new ta(t.type,t.data,t.senderId);return o.timestamp=t.timestamp,o}}class c1{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,o){const n=new ta(t,o,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",n),this.messageQueue.push(n))}broadcast(t,o){this.send(t,o)}sendTo(t,o,n){const s=new ta(o,n,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,s)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const o of t)this.handleMessage(o);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Dl.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Dl.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,o){this.players.set(t,{id:t,...o,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:o})}removePlayer(t){const o=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:o})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,o){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(o)}off(t,o){if(this.eventHandlers.has(t)){const n=this.eventHandlers.get(t),s=n.indexOf(o);s>-1&&n.splice(s,1)}}emit(t,o,n=null){if(this.eventHandlers.has(t)){const s=this.eventHandlers.get(t);for(const a of s)a(o,n)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class l1{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new c1,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const d1=new l1;let j={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null,rerollsRemaining:0,playersRevivedThisRun:new Set,isDailyRun:!1,dailyCharacter:null,dailySeed:null,dailyRNG:null},St={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},Ti=!1;function Cl(e,t,o=null){const n=o===null,s=n?Pt("startingHealth"):o?.startingHealth||0;s>0&&(t.maxHealth+=s*10,t.setHP(t.maxHealth));const a=n?Pt("startingDamage"):o?.startingDamage||0;a>0&&(t.projectileDamage+=a);const r=n?Pt("startingSpeed"):o?.startingSpeed||0;r>0&&(t.speed+=r*10)}function h1(e,t,o){const n=Bg();if(n.length!==0&&(o.activeBoosters=[],o.creditMultiplier=1,n.forEach(s=>{const a=Qd[s.key];if(!a||!a.effect)return;const r=a.effect;switch(r.type){case"startingHealth":t.maxHealth+=r.value,t.setHP(t.hp()+r.value);break;case"tempDamage":t.projectileDamage=Math.floor(t.projectileDamage*(1+r.value)),o.activeBoosters.push({type:"tempDamage",value:r.value,duration:r.duration});break;case"tempSpeed":t.speed=Math.floor(t.speed*(1+r.value)),t.originalSpeed=t.speed,o.activeBoosters.push({type:"tempSpeed",value:r.value,duration:r.duration});break;case"creditMultiplier":o.creditMultiplier=(o.creditMultiplier||1)+r.value;break;case"tempCrit":t.critChance=(t.critChance||0)+r.value,o.activeBoosters.push({type:"tempCrit",value:r.value,duration:r.duration});break;case"tempDefense":t.damageReduction=(t.damageReduction||0)+r.value,o.activeBoosters.push({type:"tempDefense",value:r.value,duration:r.duration});break;case"tempXP":t.xpMultiplier=(t.xpMultiplier||1)*(1+r.value),o.activeBoosters.push({type:"tempXP",value:r.value,duration:r.duration});break;case"autoRevive":t.autoRevive={health:r.value,uses:r.uses};break}}),n.length>0)){const s=e.add([e.text(`${n.length} Booster${n.length>1?"s":""} Active!`,{size:18}),e.pos(e.width()/2,100),e.anchor("center"),e.color(100,255,150),e.fixed(),e.z(2e3),e.opacity(1)]);e.wait(2,()=>{s.exists()&&e.tween(s.opacity,0,.5,a=>s.opacity=a,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)})})}}function u1(e){e.scene("game",t=>{if(ax(),t?.resetState){const v=d1.init("local");Tl.init(e),Ml.init("singleplayer").addPlayer(v,"survivor")}const o=Ml.getState();if(Kg(e),Wg(e),Yy(),e.paused=!1,t?.resetState){j.currentFloor=1,j.currentRoom=1,j.playerStats=null,j.allPlayerStats=null,j.entryDirection=null,j.floorMap=null,j.playersRevivedThisRun=new Set,$x(),j.isDailyRun=t?.isDailyRun||!1,j.dailyCharacter=t?.dailyCharacter||null,j.dailySeed=t?.dailySeed||null,j.dailyRNG=j.isDailyRun&&j.dailySeed?new pn(j.dailySeed):null,j.isDailyRun&&console.log("[DailyRun] Starting daily run with character:",j.dailyCharacter,"seed:",j.dailySeed),St={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{},startTime:Date.now()},jx(e);const v=Pt("mulligan");j.rerollsRemaining=v,Ti=!1,e.wait(1,()=>Lx(e)),e.gameData&&(e.gameData.weaponDetailSavedState=void 0)}let n=j.currentFloor,s=j.currentRoom;const a={updates:[],keyPresses:[]};let r=!1,l=!1;const c=[];let d=null;const i={enemies:new Ca(128),obstacles:new Ca(128),pickups:new Ca(128)};Ex(e),Mx();const h=Hn();function u(){if(j.isDailyRun&&j.dailySeed){const v=j.dailySeed+n*1e4+s*100;return new pn(v)}else if(h>1)return wi();return null}const p=()=>{h>1&&(ay(n),console.log("[Multiplayer] Generating floor map with seed:",sl()?"valid":"invalid (0)"));const v=h>1?cy():null;j.floorMap=kx(n,v),j.minimap&&j.minimap.destroy(),j.minimap=t1(e,j.floorMap),e.gameData&&(e.gameData.minimap=j.minimap)};!j.floorMap||j.floorMap.floor!==n?p():j.minimap&&j.minimap.update(),n>St.floorsReached&&(St.floorsReached=n);const g={1:"Public Access",2:"Local Affiliate",3:"Cable Network",4:"Premium Channel",5:"Streaming Giant",6:"Global Broadcast",7:"Galactic Signal"},M=v=>g[v]||`Network ${v}`;if(s===1){const v=e.add([e.text(`Floor ${n}`,{size:32}),e.pos(e.width()/2,e.height()/3),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.fixed(),e.z(3e3)]),W=e.add([e.text(M(n),{size:20}),e.pos(e.width()/2,e.height()/3+40),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.fixed(),e.z(3e3)]);e.wait(2,()=>{v.exists()&&v.onUpdate(()=>{v.opacity-=.02,v.opacity<=0&&e.destroy(v)}),W.exists()&&W.onUpdate(()=>{W.opacity-=.02,W.opacity<=0&&e.destroy(W)})})}const m=30;let T=e.width()/2,P=e.height()/2;if(j.entryDirection)switch(j.entryDirection){case"north":T=e.width()/2,P=m;break;case"south":T=e.width()/2,P=e.height()-m;break;case"west":T=m,P=e.height()/2;break;case"east":T=e.width()-m,P=e.height()/2;break}let f;const N=j.isDailyRun?j.dailyCharacter:null;if(j.playerStats){f=Sa(e,T,P,N),Object.assign(f,j.playerStats);const v=f.isRemote;if(f.isRemote=!1,v&&console.log("[Room Transition] Fixed isRemote flag - local player was incorrectly marked as remote"),f.setHP(j.playerStats.currentHP||f.maxHealth),j.playerStats.selectedUpgrades&&(f.selectedUpgrades=new Set(j.playerStats.selectedUpgrades)),j.playerStats.activeSynergies&&(f.activeSynergies=new Set(j.playerStats.activeSynergies)),j.playerStats.pendingLevelUps&&(f.pendingLevelUps=[...j.playerStats.pendingLevelUps]),f.upgradeStacks&&Object.keys(f.upgradeStacks).length>0&&Ji(f),f.activeSynergies&&f.activeSynergies.size>0){bl(f);const W=j.playerStats.currentHP||f.maxHealth;f.setHP(Math.min(W,f.maxHealth))}if((f.powerupWeapon==="orbital"||f.weaponKey==="orbital")&&(f.orbitalOrbs=[],f.orbitalAngles=[],f.orbitalNeedsReinit=!0),f.slowed=!1,f.isDead?(f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5)):(f.canMove=!0,f.canShoot=!0,f.opacity=1,f.outline&&f.outline.exists()&&(f.outline.opacity=1)),j.equippedCosmetics){if(j.equippedCosmetics.glow&&j.equippedCosmetics.glow!=="glowNone"&&!f.isDead){const W=ls[j.equippedCosmetics.glow];W&&W.color&&(f.glowEffect=ml(e,f,j.equippedCosmetics.glow,W.color))}if(j.equippedCosmetics.trail&&j.equippedCosmetics.trail!=="trailNone"){const W=ls[j.equippedCosmetics.trail];W&&(f.trailType=j.equippedCosmetics.trail,f.trailColor=W.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}}}else{const v=j.isDailyRun?j.dailyCharacter:null;f=Sa(e,T,P,v),Cl(e,f),h1(e,f,j);const W=Xg();if(j.equippedCosmetics=W,W.glow&&W.glow!=="glowNone"){const q=ls[W.glow];q&&q.color&&(f.glowEffect=ml(e,f,W.glow,q.color))}if(W.trail&&W.trail!=="trailNone"){const q=ls[W.trail];q&&(f.trailType=W.trail,f.trailColor=q.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}f.runStats={kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}const O=fs(),w=nm();let A=new Array(O.maxSlots).fill(null);if(h>1&&w.isInitialized){const v=O.slots.findIndex(q=>q.isLocal);if(Xm(O.isHost,v,e),O.isHost){const q=wi(),X=qs(n,q);j.roomTemplateKey=X.key,console.log("[Multiplayer] Host selected first room template:",X.key),dy(X.key)}O.isHost?p():iy(()=>{console.log("[Multiplayer] Client received seed, regenerating floor map"),p()}),f.slotIndex=v,f.playerName=O.slots[v].playerName;const W=v*30;f.pos.x=T+W,el(v,f),A[v]=f,O.slots.forEach((q,X)=>{if(X!==v&&q.playerId!==null){const G=X*30,D=Sa(e,T+G,P,q.selectedCharacter);if(D.isRemote=!0,D.slotIndex=X,D.playerName=q.playerName,j.allPlayerStats&&j.allPlayerStats.length>0){const Xe=j.allPlayerStats.find(ze=>ze.slotIndex===X);if(Xe){if(Object.assign(D,Xe),D.isRemote=!0,D.setHP(Xe.currentHP||D.maxHealth),Xe.selectedUpgrades&&(D.selectedUpgrades=new Set(Xe.selectedUpgrades)),Xe.activeSynergies&&(D.activeSynergies=new Set(Xe.activeSynergies)),Xe.pendingLevelUps&&(D.pendingLevelUps=[...Xe.pendingLevelUps]),D.upgradeStacks&&Object.keys(D.upgradeStacks).length>0&&Ji(D),D.activeSynergies&&D.activeSynergies.size>0){bl(D);const ze=Xe.currentHP||D.maxHealth;D.setHP(Math.min(ze,D.maxHealth))}(D.powerupWeapon==="orbital"||D.weaponKey==="orbital")&&(D.orbitalOrbs=[],D.orbitalAngles=[],D.orbitalNeedsReinit=!0),D.slowed=!1,D.isDead?(D.canMove=!1,D.canShoot=!1,D.opacity=.5,D.outline&&D.outline.exists()&&(D.outline.opacity=.5)):(D.canMove=!0,D.canShoot=!0,D.opacity=1,D.outline&&D.outline.exists()&&(D.outline.opacity=1))}}else Cl(e,D,q.permanentUpgradeLevels);yl(e,D),wl(e,D,null,!0),el(X,D),A[X]=D,O.isHost&&D.onDeath(()=>{if(D.isDead=!0,D.canMove=!1,D.canShoot=!1,D.opacity=.5,D.outline&&D.outline.exists()&&(D.outline.opacity=.5),!A.some(ze=>ze&&ze.exists()&&ze.hp()>0&&!ze.isDead)){const ze=Ea(St),bt={...St,level:f.level,currencyEarned:ze};va(bt),ds(ze),Si(e);const Xt=A.filter(qt=>qt&&qt.exists()).map(qt=>({name:qt.playerName||"Player",level:qt.level||1,characterData:qt.characterData,kills:qt.runStats?.kills||0,deaths:qt.runStats?.deaths||0,revives:qt.runStats?.revives||0,damageTaken:qt.runStats?.damageTaken||0,damageDealt:qt.runStats?.damageDealt||0,xpCollected:qt.runStats?.xpPickedUp||0,creditsPickedUp:qt.runStats?.creditsPickedUp||0,bossesKilled:qt.runStats?.bossesKilled||0}));le()&&(ol(St,ze,Xt),rs()),e.go("gameOver",{runStats:{...St},currencyEarned:ze,partyStats:Xt,isDailyRun:j.isDailyRun,dailyCharacter:j.dailyCharacter})}});const J=e.add([e.text(q.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]),ue=40,$e=4,Ae=-40,Ne=e.add([e.rect(ue,$e),e.pos(D.pos.x,D.pos.y+Ae),e.anchor("center"),e.color(50,50,50),e.z(100),"playerHealthBar"]),De=e.add([e.rect(ue,$e),e.pos(D.pos.x,D.pos.y+Ae),e.anchor("center"),e.color(100,255,100),e.z(101),"playerHealthBar"]);D.healthBarBg=Ne,D.healthBar=De,Ne.hidden=!0,De.hidden=!0,J.onUpdate(()=>{if(D.exists()){J.pos=e.vec2(D.pos.x,D.pos.y-30);const Xe=D.hp()/D.maxHealth;if(Xe<1&&Xe>0){Ne.hidden=!1,De.hidden=!1,Ne.pos.x=D.pos.x,Ne.pos.y=D.pos.y+Ae,De.pos.x=D.pos.x,De.pos.y=D.pos.y+Ae;const bt=Math.max(1,ue*Xe);De.use(e.rect(bt,$e)),De.pos.x=D.pos.x-(ue-bt)/2}else Ne.hidden=!0,De.hidden=!0}else J.destroy(),Ne.exists()&&Ne.destroy(),De.exists()&&De.destroy()})}}),pe()||Ti||(Ti=!0,He("room_transition",q=>{if(j.entryDirection=q.entryDirection,q.allPlayerStats){j.allPlayerStats=q.allPlayerStats;const G=fs().slots.findIndex(J=>J.isLocal),D=q.allPlayerStats.find(J=>J&&J.slotIndex===G);D?(j.playerStats=D,console.log("[Multiplayer] Client restored stats for slot",G,"level:",D.level)):console.warn("[Multiplayer] Client could not find stats for local slot",G,"in",q.allPlayerStats)}q.roomTemplateKey&&(j.roomTemplateKey=q.roomTemplateKey,console.log("[Multiplayer] Client received room template:",q.roomTemplateKey)),q.currentFloor&&q.currentFloor!==j.currentFloor?(console.log(`[Multiplayer] Floor advancement: ${j.currentFloor} -> ${q.currentFloor}`),j.currentFloor=q.currentFloor,j.floorMap=null,j.entryDirection=null):q.gridDirection&&j.floorMap&&j.floorMap.moveToRoom(q.gridDirection),!r&&(r=!0,Ia(),e.go("game"))}),He("room_completed",()=>{if(l=!0,d(),c.forEach(G=>{G.exists()&&!G.blocked&&(G.open=!0,G.isSpawnDoor=!1,G.updateVisual())}),_){const G=c.find(D=>D.direction==="north");G&&G.exists()&&(G.blocked=!1,G.open=!0,G.isSpawnDoor=!1,G.isFloorExit=!0,G.updateVisual())}j.minimap&&j.minimap.update();const q=_?`BOSS DEFEATED! Floor ${n} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",X=e.add([e.text(q,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{X.exists()&&e.destroy(X)})}),He("obstacle_data",q=>{console.log("[Multiplayer] Client received obstacle data:",q.obstacles.length,"obstacles"),e.get("obstacle").forEach(X=>e.destroy(X)),q.obstacles.forEach(X=>{const G=Array.isArray(X.color)?e.rgb(X.color[0],X.color[1],X.color[2]):X.color;cl(e,X.x,X.y,X.width,X.height,X.type,X.char,G)})}),He("door_states",q=>{console.log("[Multiplayer] Client received door states:",q),typeof c<"u"&&c.length>0&&c.forEach(X=>{q.hasOwnProperty(X.direction)&&(X.blocked=q[X.direction],X.updateVisual())})}),He("game_over",q=>{const X=q.currencyEarned||Ea(q.runStats||St),G={...q.runStats||St,level:f.level,currencyEarned:X};va(G),ds(X),Si(e),rs(),e.go("gameOver",{runStats:{...q.runStats||St},currencyEarned:X,partyStats:q.partyStats||[],isDailyRun:j.isDailyRun,dailyCharacter:j.dailyCharacter})}),He("powerup_weapon_applied",q=>{A.forEach(X=>{!X||!X.exists()||Ma(X,q.powerupKey)})}),He("upgrade_selected",q=>{if(q.slotIndex===v)return;const X=A.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&(Yr(X,q.upgradeKey),Uh(X,q.upgradeKey),zi(e,X))}),He("level_up_queued",q=>{if(q.slotIndex===v)return;const X=A.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&(X.level=q.level,X.pendingLevelUps||(X.pendingLevelUps=[]),X.pendingLevelUps.includes(q.level)||X.pendingLevelUps.push(q.level))}),He("synergy_activated",q=>{if(q.slotIndex===v)return;const X=A.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&zi(e,X)}),He("powerup_expired",q=>{const X=A.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&cr(X)}),He("player_healed",q=>{const X=A.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&X.setHP(q.newHP)}),He("player_dodged",q=>{const X=A.find(G=>G.slotIndex===q.slotIndex);if(X&&X.exists()){const G=e.add([e.text("DODGE!",{size:14}),e.pos(q.x,q.y-30),e.anchor("center"),e.color(100,200,255),e.opacity(1),e.z(500)]);let D=0;G.onUpdate(()=>{D+=e.dt(),G.pos.y-=30*e.dt(),G.opacity=Math.max(0,1-D/.8),D>=.8&&e.destroy(G)})}}))}else f.slotIndex=0,A[0]=f;A.filter(v=>v!==null);function S(v,W){if(!v||!v.exists())return;const q=W==="exclamation"?"!":"",X=W==="exclamation"?[255,255,0]:[255,100,150],G=e.add([e.text(q,{size:24}),e.pos(v.pos.x,v.pos.y-50),e.anchor("center"),e.color(...X),e.opacity(1),e.scale(1),e.z(1e3),"emote"]);let D=0;const J=1.5;G.onUpdate(()=>{D+=e.dt(),G.pos.x=v.pos.x,G.pos.y=v.pos.y-50-D*30,D<.2?G.scale=e.vec2(1+D*2):G.scale=e.vec2(1.4-(D-.2)*.3),D>J*.6&&(G.opacity=1-(D-J*.6)/(J*.4)),D>=J&&e.destroy(G)})}let I=0;const E=.1;e.onKeyPress("q",()=>{if(f.isDead)return;const v=e.time();v-I<E||(I=v,S(f,"exclamation"),le()&&il(f.slotIndex,"exclamation"))}),e.onKeyPress("e",()=>{if(f.isDead)return;const v=e.time();v-I<E||(I=v,S(f,"heart"),le()&&il(f.slotIndex,"heart"))}),h>1&&He("player_emote",v=>{const W=A[v.slotIndex];W&&W.exists()&&S(W,v.emoteType)});const L=o.localPlayerId,C=o.getPlayer(L);C&&(C.x=f.pos.x,C.y=f.pos.y,C.health=f.hp(),C.maxHealth=f.maxHealth,C.speed=f.speed,C.level=f.level,C.xp=f.xp,C.xpToNext=f.xpToNext,C.xpMultiplier=f.xpMultiplier||1,C.weaponKey="pistol",C.fireRate=f.fireRate,C.projectileSpeed=f.projectileSpeed,C.projectileDamage=f.projectileDamage,C.projectileCount=f.projectileCount||1,C.piercing=f.piercing||0,C.obstaclePiercing=f.obstaclePiercing||0,C.critChance=f.critChance||.05,C.critDamage=f.critDamage||2,C.spreadAngle=f.spreadAngle||0,C.weaponRange=f.weaponRange||600,C.pickupRadius=f.pickupRadius,C.defense=f.defense||0,C.damageReduction=f.damageReduction||0,C.dodgeChance=f.dodgeChance||0),d=()=>{if(h<=1)return;const v=Pt("secondWind");if(v<=0)return;let W=0;A.forEach((q,X)=>{if(q&&(q.exists()&&q.hp()<=0||q.exists()&&q.isDead)){const G=`player_${X}`;if(j.playersRevivedThisRun.has(G))return;j.playersRevivedThisRun.add(G);const D=.05+v*.05,J=Math.max(1,Math.floor(q.maxHealth*D));q.setHP(J),q.isDead=!1,q.canMove=!0,q.canShoot=!0;const ue=Math.round(D*100),$e=e.add([e.text(` REVIVED (${ue}% HP) `,{size:16}),e.pos(q.pos.x,q.pos.y-40),e.anchor("center"),e.color(100,255,100),e.opacity(1),e.lifespan(2),e.z(1e3)]);$e.onUpdate(()=>{$e.pos.y-=30*e.dt(),$e.opacity-=.5*e.dt()}),q.opacity=1,q.characterData&&q.characterData.color&&(q.color=e.rgb(...q.characterData.color)),q.outline&&q.outline.exists()&&(q.outline.opacity=1),W++}}),W>0&&e.get("projectile").forEach(q=>{(q.isEnemyProjectile||q.isBossProjectile)&&e.destroy(q)}),W>0&&le()&&pe()&&km()},yl(e,f);const F=wl(e,f,d,h>1);if(f.isDead||(f.canMove=!0,f.canShoot=!0),h>1){const v=xy();v>0&&f.addXP&&(console.log("[Multiplayer] Applying pending XP:",v),f.addXP(v))}j.playerStats&&j.playerStats.selectedUpgrades&&e.wait(.1,()=>{zi(e,f)});const U=j.floorMap.getCurrentRoom(),_=U?U.isBossRoom:s===3;let H;if(h>1&&j.roomTemplateKey)H=Al(j.roomTemplateKey),console.log("[Multiplayer] Using synced template:",j.roomTemplateKey),j.roomTemplateKey=null;else if(h>1&&!sl()){const v=ry();if(v)H=Al(v),console.log("[Multiplayer] Client using first room template:",v);else{console.warn("[Multiplayer] No seed or template key available, using fallback");const W=wi();H=qs(n,W)}}else U&&U.template?H=U.template:H=qs(n,u());const R=Vx(e,n),Y=20;s1(e,n,e.width(),e.height()),e.add([e.rect(e.width()-Y*2,2),e.pos(e.width()/2,Y),e.anchor("center"),e.color(R.wallColor),e.fixed()]),e.add([e.rect(e.width()-Y*2,2),e.pos(e.width()/2,e.height()-Y),e.anchor("center"),e.color(R.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-Y*2),e.pos(Y,e.height()/2),e.anchor("center"),e.color(R.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-Y*2),e.pos(e.width()-Y,e.height()/2),e.anchor("center"),e.color(R.wallColor),e.fixed()]);const V=s===1&&n===1,Q=80;let fe=e.width()/2,se=e.height()/2;if(j.entryDirection)switch(j.entryDirection){case"north":fe=e.width()/2,se=m;break;case"south":fe=e.width()/2,se=e.height()-m;break;case"west":fe=m,se=e.height()/2;break;case"east":fe=e.width()-m,se=e.height()/2;break}const ie=[],ae=[],ge=h<=1||pe();!V&&ge&&(H.obstacles.forEach(v=>{const W=Math.sqrt(Math.pow(v.x-T,2)+Math.pow(v.y-P,2)),q=Math.sqrt(Math.pow(v.x-fe,2)+Math.pow(v.y-se,2)),X=Math.max(v.width,v.height)/2;if(W<Q+X||q<Q+X)return;const G=Kx(v.x,v.y,v.width,v.height),D=v.type==="wall"?R.obstacleColor:R.coverColor,J=cl(e,G.x,G.y,v.width,v.height,v.type,v.char||"#",D);if(ie.push(J),h>1&&pe()){let ue=null;D&&(Array.isArray(D)?ue=D:D.r!==void 0&&(ue=[D.r,D.g,D.b])),ae.push({x:G.x,y:G.y,width:v.width,height:v.height,type:v.type,char:v.char||"#",color:ue})}}),h>1&&pe()&&e.wait(.1,()=>{py(ae)})),!V&&!_&&ge&&Wx(H.key,u(),n).forEach(W=>{const q=Math.sqrt(Math.pow(W.x-T,2)+Math.pow(W.y-P,2)),X=Math.sqrt(Math.pow(W.x-fe,2)+Math.pow(W.y-se,2));if(q<Q+25||X<Q+25)return;let G=!1;ie.forEach(D=>{if(!D.exists())return;Math.sqrt(Math.pow(W.x-D.pos.x,2)+Math.pow(W.y-D.pos.y,2))<50&&(G=!0)}),G||Ny(e,W.x,W.y)}),e.add([e.rect(82,22),e.pos(8,2),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(b.UI_BG)]);const Se=e.add([e.text("",{size:Z.HUD}),e.pos(20,6),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT)]),Ie=e.add([e.text("0/0",{size:Z.HUD}),e.pos(40,6),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT)]);e.add([e.rect(85,22),e.pos(e.width()-10,2),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(b.UI_BG-1)]),e.add([e.text("$",{size:Z.LABEL}),e.pos(e.width()-20,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);const ve=e.add([e.text("0",{size:Z.HUD}),e.pos(e.width()-40,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);if(le()){const v=jm(),W=w.isHost?[100,255,100]:[100,200,255],q=w.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...W),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(`${q} (${v}P)`,{size:Z.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...W),e.fixed(),e.z(b.UI_TEXT)])}const _e=e.width()-40,nt=15,Me=e.height()-18;e.add([e.rect(_e,nt),e.pos(20,Me),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.UI_BG)]);const Tt=f.xpToNext>0?f.xp/f.xpToNext:0,ee=Math.max(0,(_e-34)*Tt),we=e.add([e.rect(ee,nt-4),e.pos(58,Me+2),e.color(100,200,255),e.fixed(),e.z(b.UI_BG+1)]),ye=e.add([e.text(Zc(f.xp||0,f.xpToNext||10),{size:Z.SMALL-2}),e.pos(e.width()/2,Me+nt/2),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),Pe=36,qe=20+Pe/2,Ce=Me+nt/2;e.add([e.circle(Pe/2),e.pos(qe,Ce),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(b.UI_BG+2)]);const rt=e.add([e.text(`${f.level||1}`,{size:Z.BODY}),e.pos(qe,Ce),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_BG+3)]),Je=40,it=8,gt=25,Te=e.add([e.rect(Je,it),e.pos(0,0),e.anchor("center"),e.color(...y.BG_DARK),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.z(b.OVERLAY)]),Fe=e.add([e.rect(Je-2,it-2),e.pos(0,0),e.anchor("center"),e.color(100,255,100),e.z(b.OVERLAY+1)]);Te.hidden=!0,Fe.hidden=!0;const Be=48,Re=25,Ke=e.height()-85,dt=e.add([e.rect(Be,Be),e.pos(Re,Ke),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(b.UI_BG)]),ft=e.add([e.text("",{size:32}),e.pos(Re+Be/2,Ke+Be/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),ht=220,ut=90,At=e.add([e.rect(ht,ut),e.pos(Re,Ke-ut-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(b.OVERLAY+5)]),ct=e.add([e.text("",{size:24}),e.pos(Re+15,Ke-ut-10+15),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+6)]),Bt=e.add([e.text("Basic Pistol",{size:Z.SMALL,width:160}),e.pos(Re+50,Ke-ut-10+10),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+6)]),Dt=e.add([e.text("DMG: 10",{size:Z.SMALL-2}),e.pos(Re+50,Ke-ut-10+30),e.color(255,150,150),e.fixed(),e.z(b.OVERLAY+6)]),xt=e.add([e.text("RATE: 3.75/s",{size:Z.SMALL-2}),e.pos(Re+50,Ke-ut-10+47),e.color(150,200,255),e.fixed(),e.z(b.OVERLAY+6)]),Rt=e.add([e.text("DPS: 37.5",{size:Z.SMALL-2}),e.pos(Re+50,Ke-ut-10+64),e.color(255,255,150),e.fixed(),e.z(b.OVERLAY+6)]);At.hidden=!0,ct.hidden=!0,Bt.hidden=!0,Dt.hidden=!0,xt.hidden=!0,Rt.hidden=!0;let Ye=!1;t?.resetState&&(Ye=!1),dt.onClick(()=>{Ye=!Ye,At.hidden=!At.hidden,ct.hidden=!ct.hidden,Bt.hidden=!Bt.hidden,Dt.hidden=!Dt.hidden,xt.hidden=!xt.hidden,Rt.hidden=!Rt.hidden});const Ct=40,me=Re,st=Ke-Ct-10,re=e.add([e.rect(Ct,Ct),e.pos(me,st),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(b.UI_BG)]),Le=e.add([e.text("",{size:28}),e.pos(me+Ct/2,st+Ct/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),Qe=e.add([e.text("20",{size:14}),e.pos(me+Ct+5,st+Ct/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(b.UI_TEXT)]);re.hidden=!0,Le.hidden=!0,Qe.hidden=!0;const et=Re+Be+10,B=Ke,K=32,te=40,he=[];function tt(){if(he.forEach(W=>{W.exists()&&e.destroy(W)}),he.length=0,!f.exists())return;const v=[];f.upgradeStacks&&Object.entries(f.upgradeStacks).forEach(([W,q])=>{q>0&&v.push({key:W,stacks:q})}),v.forEach((W,q)=>{const X=et+q*te,G=gs[W.key];if(!G)return;const D=e.add([e.rect(K,K),e.pos(X,B),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(b.UI_BG)]),J=e.add([e.text(G.icon,{size:20}),e.pos(X+K/2,B+K/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),ue=e.add([e.text(W.stacks.toString(),{size:10}),e.pos(X+K-4,B+K-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(b.UI_TEXT+1)]);he.push(D,J,ue)})}const ot=50,Lt=e.width()-ot-25,at=e.height()-ot-25,vt=e.add([e.rect(ot,ot),e.pos(Lt,at),e.color(100,200,255),e.opacity(.9),e.outline(3,e.rgb(255,255,255)),e.area(),e.fixed(),e.z(b.OVERLAY+5)]),xe=e.add([e.text("+",{size:36}),e.pos(Lt+ot/2,at+ot/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+6)]),be=20,ce=Lt+ot-be/2,de=at-be/2,Ee=e.add([e.circle(be/2),e.pos(ce,de),e.anchor("center"),e.color(255,50,50),e.outline(2,e.rgb(255,255,255)),e.fixed(),e.z(b.OVERLAY+7)]),ke=e.add([e.text("2",{size:12}),e.pos(ce,de),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+8)]);vt.hidden=!0,xe.hidden=!0,Ee.hidden=!0,ke.hidden=!0,vt.onClick(()=>{F&&f.pendingLevelUps&&f.pendingLevelUps.length>0&&F.processPendingLevelUp()});let lt=0;vt.onUpdate(()=>{if(vt.hidden)return;lt+=e.dt()*4;const v=(Math.sin(lt)+1)/2,W=3+v*3,q=200+v*55;vt.outline.width=W,vt.outline.color=e.rgb(q,q,100+v*155);const X=1+v*.05;vt.scale=e.vec2(X,X),xe.scale=e.vec2(X,X)});const We=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(b.OVERLAY+10)]),je=e.add([e.text("",{size:Z.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+11)]);We.hidden=!0,je.hidden=!0;const ho={level:()=>`Level ${f.level}
XP: ${f.xp}/${f.xpToNext}
Progress: ${Math.floor(f.xp/f.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${St.enemiesKilled}`),currency:()=>`Total Credits: ${$n()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const v=f.weaponDef;return v?`${v.name}
Damage: ${f.projectileDamage}
Fire Rate: ${f.fireRate.toFixed(2)}/s
DPS: ${(f.projectileDamage*f.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(f.hp())}/${f.maxHealth}
Damage Reduction: ${Math.floor(f.damageReduction*100)}%`};function It(v,W,q){const X=ho[v];if(!X)return;const G=X();je.text=G,We.pos.x=Math.min(W+10,e.width()-210),We.pos.y=Math.min(q+10,e.height()-70),je.pos.x=We.pos.x+5,je.pos.y=We.pos.y+5,We.hidden=!1,je.hidden=!1}function Zt(){We.hidden=!0,je.hidden=!0}function Io(){return{hidden:We.hidden,text:je.text,tooltipX:We.pos.x,tooltipY:We.pos.y,textX:je.pos.x,textY:je.pos.y}}function bo(v){v&&(We.hidden=v.hidden,je.hidden=v.hidden,je.text=v.text,We.pos.x=v.tooltipX,We.pos.y=v.tooltipY,je.pos.x=v.textX,je.pos.y=v.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=Zt,e.gameData.saveTooltipState=Io,e.gameData.restoreTooltipState=bo,e.gameData.minimap=j.minimap,My(e),e.gameData.spatialGrids=i,e.gameData.alivePlayers=[],e.gameData.additionalEnemiesFromSplits=0,e.gameData.incrementSplitEnemies=v=>{hi+=v,e.gameData.additionalEnemiesFromSplits=hi},e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,a.updates.push(e.onUpdate(()=>{e.gameData.alivePlayers=e.get("player").filter(v=>!v.isDead&&v.exists()),i.enemies.clear(),e.get("enemy").forEach(v=>i.enemies.insert(v)),e.get("boss").forEach(v=>i.enemies.insert(v)),e.get("miniboss").forEach(v=>i.enemies.insert(v)),i.pickups.clear(),e.get("xpPickup").forEach(v=>i.pickups.insert(v)),e.get("currencyPickup").forEach(v=>i.pickups.insert(v)),e.get("powerupWeaponPickup").forEach(v=>i.pickups.insert(v))})),a.updates.push(e.onUpdate(()=>{Ax(e.dt())})),a.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const v=e.dt();if(f.berserkerEnabled){const q=f.hp()/f.maxHealth<(f.berserkerThreshold||.3),X=1+(f.berserkerSpeedBonus||.5),G=1+(f.berserkerDamageBonus||.5);q&&!f.berserkerActive?(f.berserkerActive=!0,f.speed=Math.floor(f.speed*X),f.projectileDamage=Math.floor(f.projectileDamage*G)):!q&&f.berserkerActive&&(f.berserkerActive=!1,f.speed=Math.floor(f.speed/X),f.projectileDamage=Math.floor(f.projectileDamage/G))}if(f.survivalistEnabled){const W=e.time()-(f.survivalistLastCombatTime||0),q=f.survivalistCombatCooldown||3;if(W>=q&&f.hp()<f.maxHealth){const X=f.survivalistRegenPercent||.01,G=f.maxHealth*X*v;if(f.survivalistRegenAccum=(f.survivalistRegenAccum||0)+G,f.survivalistRegenAccum>=1){const D=Math.floor(f.survivalistRegenAccum);f.survivalistRegenAccum-=D;const J=Math.min(f.maxHealth,f.hp()+D);f.setHP(J),le()&&pe()&&mh({slotIndex:f.slotIndex,healAmount:D,newHP:J,source:"survivalist"})}}}})),a.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const v=e.dt();if(f.glowEffect&&ux(e,f.glowEffect),f.trailType&&f.trailColor){f.trailTimer=(f.trailTimer||0)+v;const W=.05,q=f.pos.x-(f.lastTrailPos?.x||f.pos.x),X=f.pos.y-(f.lastTrailPos?.y||f.pos.y),G=Math.sqrt(q*q+X*X);f.trailTimer>=W&&G>2&&(dx(e,f.pos.x,f.pos.y,f.trailType,f.trailColor),f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}})),a.updates.push(e.onUpdate(()=>{if(e.paused||Ei())return;const v=e.mousePos();let W=!1;v.x>=20&&v.x<=180&&v.y>=20&&v.y<=35?(It("level",v.x,v.y),W=!0):v.x>=20&&v.x<=180&&v.y>=40&&v.y<=55&&!Ie.hidden?(It("enemies",v.x,v.y),W=!0):v.x>=e.width()-130&&v.x<=e.width()-10&&v.y>=10&&v.y<=50?(It("currency",v.x,v.y),W=!0):v.x>=Re&&v.x<=Re+Be&&v.y>=Ke&&v.y<=Ke+Be&&(It("weapon",v.x,v.y),W=!0),W||Zt()}));const fo=e.add([e.text("",{size:Z.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...y.BOSS_NAME),e.fixed(),e.z(b.OVERLAY)]),Wo=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.OVERLAY)]),Nt=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.HEALTH_LOW),e.fixed(),e.z(b.OVERLAY+1)]),$o=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.OVERLAY)]),ao=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.OVERLAY+1)]),rn=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]),wo=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]),yn=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.OVERLAY)]),po=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.XP_BAR),e.fixed(),e.z(b.OVERLAY+1)]),No=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]);fo.hidden=!0,Wo.hidden=!0,Nt.hidden=!0,$o.hidden=!0,ao.hidden=!0,rn.hidden=!0,wo.hidden=!0,yn.hidden=!0,po.hidden=!0,No.hidden=!0,a.updates.push(e.onUpdate(()=>{e.paused||lx(e)})),a.updates.push(e.onUpdate(()=>{e.paused||le()&&Km(e.dt())})),a.updates.push(e.onUpdate(()=>{const v=f.exists()?f.hp():0,W=f.maxHealth>0?v/f.maxHealth:1;rt.text=`${f.level||1}`;const q=f.xpToNext>0?f.xp/f.xpToNext:0;if(we.width=Math.max(0,(_e-34)*q),ye.text=Zc(f.xp,f.xpToNext),ve.text=$n().toString(),W<1&&f.exists()){Te.hidden=!1,Fe.hidden=!1;const D=f.pos.x,J=f.pos.y+gt;Te.pos=e.vec2(D,J);const ue=Math.max(1,(Je-2)*W);Fe.use(e.rect(ue,it-2));const $e=D-Je/2+1+ue/2;Fe.pos=e.vec2($e,J),W>.6?Fe.color=e.rgb(100,255,100):W>.3?Fe.color=e.rgb(255,200,0):Fe.color=e.rgb(255,50,50)}else Te.hidden=!0,Fe.hidden=!0;if(!_&&!l){const D=e.get("enemy").length,J=As+hi+(Ss?1:0),ue=e.get("miniboss").length,$e=D+ue+Math.max(0,J-es-hi-(Ss&&fa?1:0));Ie.text=`${$e}/${J}`,Ie.hidden=!1,Se.hidden=!1}else Ie.hidden=!0,Se.hidden=!0;if(f.exists()&&f.weaponDef){const D=f.weaponDef,J=(f.projectileDamage*f.fireRate).toFixed(1);ft.text=D.icon||"",ft.color=e.rgb(...D.color),ct.text=D.icon||"",ct.color=e.rgb(...D.color),Bt.text=D.name,Bt.color=e.rgb(...y.TEXT_PRIMARY),Dt.text=`DMG: ${f.projectileDamage}`,xt.text=`RATE: ${f.fireRate.toFixed(2)}/s`,Rt.text=`DPS: ${J}`,e.paused&&!Sx()?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Ye),At.hidden=!1,ct.hidden=!1,Bt.hidden=!1,Dt.hidden=!1,xt.hidden=!1,Rt.hidden=!1):(At.hidden=!Ye,ct.hidden=!Ye,Bt.hidden=!Ye,Dt.hidden=!Ye,xt.hidden=!Ye,Rt.hidden=!Ye)}if(f.exists()){Sm(f,e.dt());const D=Tm(f);D?(re.hidden=!1,Le.hidden=!1,Qe.hidden=!1,Le.text=D.icon,Le.color=e.rgb(...D.color),re.outline.color=e.rgb(...D.color),D.isAmmoBased?Qe.text=`${D.ammo}`:D.isTimeBased&&(Qe.text=`${Math.ceil(D.duration)}s`)):(re.hidden=!0,Le.hidden=!0,Qe.hidden=!0)}if(e.time()%.5<e.dt()&&tt(),f.exists()&&f.pendingLevelUps&&f.pendingLevelUps.length>0){vt.hidden=!1,xe.hidden=!1;const D=f.pendingLevelUps.length;D>1?(Ee.hidden=!1,ke.hidden=!1,ke.text=D.toString()):(Ee.hidden=!0,ke.hidden=!0)}else vt.hidden=!0,xe.hidden=!0,Ee.hidden=!0,ke.hidden=!0;const X=e.get("boss"),G=X.filter(D=>D.type==="twinGuardianMelee"||D.type==="twinGuardianRanged");if(G.length>0){const D=G.find(ue=>ue.type==="twinGuardianMelee"),J=G.find(ue=>ue.type==="twinGuardianRanged");if(D&&J&&(D.exists()||J.exists())){fo.hidden=!1,fo.text="THE CO-HOSTS";const ue=D.exists()?D.hp():0,$e=J.exists()?J.hp():0,Ae=ue+$e,Ne=(D.maxHealth||0)+(J.maxHealth||0),De=Ne>0?Math.max(0,Math.min(1,Ae/Ne)):0;Nt.width=296*De,Nt.pos.x=e.width()/2-296*(1-De)/2,rn.text=`${Math.max(0,Math.floor(Ae))}/${Ne}`,Wo.hidden=!1,Nt.hidden=!1,rn.hidden=!1;const Xe=D.exists()&&D.shieldHealth||0,ze=J.exists()&&J.shieldHealth||0,bt=Xe+ze,Xt=(D.maxShieldHealth||0)+(J.maxShieldHealth||0);if(Xt>0){const Ts=Math.max(0,Math.min(1,bt/Xt));po.width=296*Ts,po.pos.x=e.width()/2-296*(1-Ts)/2,No.text=`Shield: ${Math.max(0,Math.floor(bt))}/${Xt}`,yn.hidden=!1,po.hidden=!1,No.hidden=!1}else yn.hidden=!0,po.hidden=!0,No.hidden=!0;const qt=D.exists()&&D.armorHealth||0,bn=J.exists()&&J.armorHealth||0,gi=qt+bn,ya=(D.maxArmorHealth||0)+(J.maxArmorHealth||0);if(ya>0){const Ts=Math.max(0,Math.min(1,gi/ya));ao.width=296*Ts,ao.pos.x=e.width()/2-296*(1-Ts)/2,wo.text=`Armor: ${Math.max(0,Math.floor(gi))}/${ya}`,$o.hidden=!1,ao.hidden=!1,wo.hidden=!1}else $o.hidden=!0,ao.hidden=!0,wo.hidden=!0;De>.6?Nt.color=e.rgb(255,50,50):De>.3?Nt.color=e.rgb(255,150,50):Nt.color=e.rgb(255,200,0)}else{const ue=D?.exists()?D:J;if(ue){const $e=ue.hp(),Ae=ue.maxHealth,Ne=ue.shieldHealth||0,De=ue.maxShieldHealth||0,Xe=ue.armorHealth||0,ze=ue.maxArmorHealth||0;fo.hidden=!1,fo.text=ue.enraged?"THE CO-HOSTS (ENRAGED)":"THE CO-HOSTS";const bt=Math.max(0,Math.min(1,$e/Ae));if(Nt.width=296*bt,Nt.pos.x=e.width()/2-296*(1-bt)/2,rn.text=`${Math.max(0,Math.floor($e))}/${Ae}`,Wo.hidden=!1,Nt.hidden=!1,rn.hidden=!1,De>0){const Xt=Math.max(0,Math.min(1,Ne/De));po.width=296*Xt,po.pos.x=e.width()/2-296*(1-Xt)/2,No.text=`Shield: ${Math.max(0,Math.floor(Ne))}/${De}`,yn.hidden=!1,po.hidden=!1,No.hidden=!1}else yn.hidden=!0,po.hidden=!0,No.hidden=!0;if(ze>0){const Xt=Math.max(0,Math.min(1,Xe/ze));ao.width=296*Xt,ao.pos.x=e.width()/2-296*(1-Xt)/2,wo.text=`Armor: ${Math.max(0,Math.floor(Xe))}/${ze}`,$o.hidden=!1,ao.hidden=!1,wo.hidden=!1}else $o.hidden=!0,ao.hidden=!0,wo.hidden=!0;bt>.6?Nt.color=e.rgb(255,50,50):bt>.3?Nt.color=e.rgb(255,150,50):Nt.color=e.rgb(255,200,0)}else fo.hidden=!0,Wo.hidden=!0,Nt.hidden=!0,$o.hidden=!0,ao.hidden=!0,rn.hidden=!0,wo.hidden=!0}}else if(X.length>0&&X[0].exists()){const D=X[0],J=D.hp(),ue=D.maxHealth,$e=D.shieldHealth||0,Ae=D.maxShieldHealth||0,Ne=D.armorHealth||0,De=D.maxArmorHealth||0;let Xe="BOSS";D.type==="twinGuardianMelee"||D.type==="twinGuardianRanged"?Xe="THE CO-HOSTS":tn[D.type]?.name&&(Xe=`THE ${tn[D.type].name.toUpperCase()}`),fo.hidden=!1,Wo.hidden=!1,Nt.hidden=!1,$o.hidden=!1,ao.hidden=!1,rn.hidden=!1,wo.hidden=!1,fo.text=Xe;const ze=Math.max(0,Math.min(1,J/ue));if(Nt.width=296*ze,Nt.pos.x=e.width()/2-296*(1-ze)/2,rn.text=`${Math.max(0,Math.floor(J))}/${ue}`,Ae>0){const bt=Math.max(0,Math.min(1,$e/Ae));po.width=296*bt,po.pos.x=e.width()/2-296*(1-bt)/2,No.text=`Shield: ${Math.max(0,Math.floor($e))}/${Ae}`,yn.hidden=!1,po.hidden=!1,No.hidden=!1}else yn.hidden=!0,po.hidden=!0,No.hidden=!0;if(De>0){const bt=Math.max(0,Math.min(1,Ne/De));ao.width=296*bt,ao.pos.x=e.width()/2-296*(1-bt)/2,wo.text=`Armor: ${Math.max(0,Math.floor(Ne))}/${De}`,$o.hidden=!1,ao.hidden=!1,wo.hidden=!1}else $o.hidden=!0,ao.hidden=!0,wo.hidden=!0;ze>.6?Nt.color=e.rgb(255,50,50):ze>.3?Nt.color=e.rgb(255,150,50):Nt.color=e.rgb(255,200,0)}else fo.hidden=!0,Wo.hidden=!0,Nt.hidden=!0,$o.hidden=!0,ao.hidden=!0,rn.hidden=!0,wo.hidden=!0,yn.hidden=!0,po.hidden=!0,No.hidden=!0})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const v=o.getPlayer(L);v&&(v.x=f.pos.x,v.y=f.pos.y,v.velocityX=0,v.velocityY=0,v.health=f.hp(),v.maxHealth=f.maxHealth,v.level=f.level,v.xp=f.xp,v.xpToNext=f.xpToNext,v.projectileDamage=f.projectileDamage,v.fireRate=f.fireRate,v.projectileSpeed=f.projectileSpeed,v.projectileCount=f.projectileCount||1,v.piercing=f.piercing||0,v.critChance=f.critChance||.05,v.critDamage=f.critDamage||2,v.pickupRadius=f.pickupRadius,v.defense=f.defense||0,v.isDead=f.isDead||!f.exists()||f.hp()<=0,v.invulnerable=f.invulnerable||!1,o.updateTime(e.dt()))})),o.currentFloor=n,o.currentRoom=s,o.roomCleared=!1,a.updates.push(e.onUpdate(()=>{if(e.paused)return;Tl.getManager().getInputsForFrame([L]).get(L)}));let As=_?0:24+(n-1)*6,es=0,Jh=2,ic=!1,fa=!1,Ss=!1,jh=4,pa=0,hi=0;const ac=u()||new pn(Date.now());if(!_&&s!==1){const v=.15+(n-1)*.05;Ss=ac.next()<v}Ss&&(As=Math.floor(As*.5));function Zh(v,W){const q=["brute","sentinel","berserker","guardian","warlock"];if(v>=3)return q[W.range(0,q.length)];{const X=["brute","berserker","guardian"];return X[W.range(0,X.length)]}}function Qh(v){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[v]||"gatekeeper"}const kh=[{x:e.width()/2,y:m,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-m,direction:"south",gridDir:"down"},{x:m,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-m,y:e.height()/2,direction:"east",gridDir:"right"}],eu=j.floorMap?j.floorMap.getAvailableExits():[],tu=new Set(eu.map(v=>v.direction));kh.forEach(v=>{const W=Hy(e,v.x,v.y,v.direction);W.open=!1,W.isSpawnDoor=!0,W.gridDirection=v.gridDir,(v.gridDir===null||!tu.has(v.gridDir))&&(W.blocked=!0),W.updateVisual(),c.push(W)}),h>1&&pe()&&e.wait(.1,()=>{const v={};c.forEach(W=>{v[W.direction]=W.blocked}),Ge("door_states",v)});let ui=0;const ou=.33;let rc=!1;a.updates.push(e.onUpdate(()=>{if(e.paused||l)return;if(rc||(pa=e.time(),rc=!0),_){if(!ic&&(!le()||pe())){ic=!0;const G=Qh(n),D=u();if(G==="twinGuardian"){const J=c.filter(De=>De.direction!==j.entryDirection);let ue,$e;if(J.length>=2){const De=[...J];for(let ze=De.length-1;ze>0;ze--){const bt=D?D.range(0,ze+1):Math.floor(Math.random()*(ze+1));[De[ze],De[bt]]=[De[bt],De[ze]]}ue=De[0];const Xe={north:"south",south:"north",east:"west",west:"east"};$e=J.find(ze=>ze.direction===Xe[ue.direction])||De[1]}else ue=c[0],$e=c[c.length>1?1:0];const Ae=Em(e,ue,$e,n,D);le()&&pe()&&(Array.isArray(Ae)?Ae.forEach(De=>{Xo(De,{type:"twinGuardian",floor:n})}):Ae&&Xo(Ae,{type:"twinGuardian",floor:n})),fl();const Ne=e.add([e.text("THE CO-HOSTS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Ne.exists()&&e.destroy(Ne)})}else{let J=c.find(Xe=>Xe.direction==="north");if(!J||j.entryDirection==="north"&&c.length>1){const Xe=c.filter(ze=>ze.direction!==j.entryDirection);if(Xe.length>0){const ze=D?D.range(0,Xe.length):Math.floor(Math.random()*Xe.length);J=Xe[ze]}else{const ze=D?D.range(0,c.length):Math.floor(Math.random()*c.length);J=c[ze]}}const ue=J?J.pos.x:e.width()/2,$e=J?J.pos.y:e.height()/2,Ae=$i(e,ue,$e,G,n,D);le()&&pe()&&Xo(Ae,{type:G,floor:n,isBoss:!0}),fl();let Ne="BOSS";G==="twinGuardian"?Ne="THE CO-HOSTS":tn[G]?.name&&(Ne=`THE ${tn[G].name.toUpperCase()}`);const De=e.add([e.text(Ne,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{De.exists()&&e.destroy(De)})}}if(!le()||pe()){const G=e.get("boss"),D=e.get("enemy").filter(J=>J.isBossMinion);G.length===0&&D.length===0&&!l&&(l=!0,lc())}return}if(Ss&&!fa&&(!le()||pe())&&e.time()-pa>=1){fa=!0;const G=Zh(n,ac),D=u(),J=c.filter(Xt=>Xt.direction!==j.entryDirection),ue=J.length>0?J:c,$e=D?D.range(0,ue.length):Math.floor(Math.random()*ue.length),Ae=ue[$e],Ne=Ae.pos.x,De=Ae.pos.y,Xe=Oy(e,Ne,De,G,n);le()&&pe()&&Xo(Xe,{type:G,floor:n});const ze=jn[G]?.name||"MINIBOSS",bt=e.add([e.text(`MINIBOSS: ${ze.toUpperCase()}`,{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{bt.exists()&&e.destroy(bt)})}const v=e.get("enemy").length,W=e.get("miniboss").length;if(es>=As&&v===0&&W===0&&!l&&(!le()||pe())&&(l=!0,lc()),es<As&&(!le()||pe())){if(ui+=e.dt(),es===0&&ui<Jh)return;if(ui>=ou){ui=0,es++;const G=u();if(G)for(let D=0;D<es-1;D++)G.next();if(c.length>0){const D=e.time()-pa,ue=j.entryDirection&&D<jh?c.filter(gi=>gi.direction!==j.entryDirection):c,$e=ue.length>0?ue:c,Ae=G?G.range(0,$e.length):Math.floor(Math.random()*$e.length),Ne=$e[Ae],De=Ne.pos.x,Xe=Ne.pos.y,ze=15,bt=De+(G?G.next()-.5:Math.random()-.5)*ze,Xt=Xe+(G?G.next()-.5:Math.random()-.5)*ze,qt=gr(n,G),bn=Rn(e,bt,Xt,qt,n,G);El(e,bn,n,G),le()&&pe()&&Xo(bn,{type:qt,floor:n,isElite:bn.isElite,eliteModifier:bn.eliteModifier})}else{const D=G?G.range(0,4):Math.floor(e.rand(0,4));let J,ue;switch(D){case 0:J=G?G.rangeFloat(Y,e.width()-Y):e.rand(Y,e.width()-Y),ue=Y;break;case 1:J=e.width()-Y,ue=G?G.rangeFloat(Y,e.height()-Y):e.rand(Y,e.height()-Y);break;case 2:J=G?G.rangeFloat(Y,e.width()-Y):e.rand(Y,e.width()-Y),ue=e.height()-Y;break;case 3:J=Y,ue=G?G.rangeFloat(Y,e.height()-Y):e.rand(Y,e.height()-Y);break}const $e=gr(n,G),Ae=Rn(e,J,ue,$e,n,G);El(e,Ae,n,G),le()&&pe()&&Xo(Ae,{type:$e,floor:n,isElite:Ae.isElite,eliteModifier:Ae.eliteModifier})}}}})),a.updates.push(e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(v=>{if(v.hp()<=0&&!v.isDead){v.isDead=!0;const W=v.xpValue,q=v.pos.x,X=v.pos.y;if(v.cleanupHealthBars&&v.cleanupHealthBars(),v.explodes&&v.explosionRadius){const J=v.explosionRadius,ue=v.explosionDamage||15;f.exists()&&Math.sqrt(Math.pow(f.pos.x-q,2)+Math.pow(f.pos.y-X,2))<=J&&f.takeDamage(ue),i.enemies.getNearby(q,X,J).forEach(Ae=>{if(Ae===v||!Ae.exists())return;const Ne=Ae.pos.x-q,De=Ae.pos.y-X;Ne*Ne+De*De<=J*J&&Ae.hurt(ue)}),Ys(e,q,X,{color:[255,150,50]})}else{const J=j.equippedCosmetics?.death,ue=v.originalColor||[255,100,100];J&&J!=="deathNone"?fx(e,q,X,J,ue):Ys(e,q,X,{color:ue})}if(v.shrapnel&&v.shrapnelCount){const J=v.shrapnelCount,ue=Math.PI*2/J,$e=250,Ae=Math.floor((v.explosionDamage||15)*.6);for(let Ne=0;Ne<J;Ne++){const De=ue*Ne,Xe=e.vec2(Math.cos(De),Math.sin(De)),ze=To(e,q,X,Xe,$e,Ae,0,0,!1);ze.isEnemyProjectile=!0,ze.color=e.rgb(...v.originalColor)}}v.cleanupHealthBars&&typeof v.cleanupHealthBars=="function"&&v.cleanupHealthBars(),le()&&v.mpEntityId&&(pe()?$r({entityId:v.mpEntityId,entityType:"enemy",x:q,y:X}):fy({entityId:v.mpEntityId,entityType:"enemy",x:q,y:X})),e.destroy(v),hl(),St.enemiesKilled++;const G=v.type||v.enemyType||"basic";St.killsByType[G]=(St.killsByType[G]||0)+1;const D=v.lastHitBySlot;if(D!==void 0&&A[D]&&A[D].runStats?A[D].runStats.kills++:f.runStats&&f.runStats.kills++,!le()||pe()){const J=u();Xs(e,q,X,W);const ue=J?J.range(1,4):Math.floor(Math.random()*3)+1,$e=1;for(let Ne=0;Ne<ue;Ne++){const De=J?(J.next()-.5)*20:(Math.random()-.5)*20,Xe=J?(J.next()-.5)*20:(Math.random()-.5)*20,ze=Bi();Fs(e,q+De,X+Xe,$e,ze)}const Ae=Am(v.type,n);if(Ae){const Ne=J?(J.next()-.5)*30:(Math.random()-.5)*30,De=J?(J.next()-.5)*30:(Math.random()-.5)*30;jc(e,q+Ne,X+De,Ae)}}}}),e.get("miniboss").forEach(v=>{if(v.hp()<=0&&!v.isDead){v.isDead=!0;const W=v.xpValue,q=v.pos.x,X=v.pos.y;Ys(e,q,X,{color:[255,150,100],isMiniboss:!0}),e.destroy(v),hl(),St.enemiesKilled++;const G=v.type||"miniboss";St.killsByType[G]=(St.killsByType[G]||0)+1;const D=v.lastHitBySlot;if(D!==void 0&&A[D]&&A[D].runStats?A[D].runStats.kills++:f.runStats&&f.runStats.kills++,!le()||pe()){const ue=u();Xs(e,q,X,W);const $e=ue?ue.range(10,16):Math.floor(Math.random()*6)+10,Ae=1;for(let Ne=0;Ne<$e;Ne++){const De=Math.PI*2/$e*Ne,Xe=ue?30+ue.next()*20:30+Math.random()*20,ze=Math.cos(De)*Xe,bt=Math.sin(De)*Xe;Fs(e,q+ze,X+bt,Ae)}}const J=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(q,X-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{J.exists()&&e.destroy(J)})}}),e.get("boss").forEach(v=>{if(v.hp()<=0&&!v.isDead){v.isDead=!0;const W=v.xpValue,q=v.pos.x,X=v.pos.y;Ys(e,q,X,{color:[255,200,100],isBoss:!0}),e.destroy(v),ox(),St.enemiesKilled++,St.bossesKilled++;const G=v.type||"boss";St.killsByType[G]=(St.killsByType[G]||0)+1;const D=v.lastHitBySlot;if(D!==void 0&&A[D]&&A[D].runStats?(A[D].runStats.kills++,A[D].runStats.bossesKilled++):f.runStats&&(f.runStats.kills++,f.runStats.bossesKilled++),!le()||pe()){const ue=u();Xs(e,q,X,W);const $e=ue?ue.range(20,31):Math.floor(Math.random()*11)+20,Ae=1,Ne=Bi();for(let De=0;De<$e;De++){const Xe=Math.PI*2/$e*De,ze=ue?40+ue.next()*30:40+Math.random()*30,bt=Math.cos(Xe)*ze,Xt=Math.sin(Xe)*ze;Fs(e,q+bt,X+Xt,Ae,Ne)}}const J=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(q,X-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{J.exists()&&e.destroy(J)})}}))})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const v=f.pickupRadius*1.5,W=new Set;h===1?i.pickups.getNearby(f.pos.x,f.pos.y,v).forEach(q=>{q.is&&q.is("xpPickup")&&W.add(q)}):A.forEach(q=>{!q||!q.exists()||q.isDead||i.pickups.getNearby(q.pos.x,q.pos.y,v).forEach(X=>{X.is&&X.is("xpPickup")&&W.add(X)})}),W.forEach(q=>{if(q.collected)return;let X=f,G=e.vec2(f.pos.x-q.pos.x,f.pos.y-q.pos.y).len();if(h>1&&A.forEach(D=>{if(!D||!D.exists()||D.isDead)return;const J=e.vec2(D.pos.x-q.pos.x,D.pos.y-q.pos.y).len();J<G&&(G=J,X=D)}),!q.magnetizing&&G<=X.pickupRadius&&(q.magnetizing=!0,q.targetPlayer=X),G<=Vt.COLLECTION_RADIUS&&!q.collected){if(le()&&!pe())return;q.collected=!0,ky(),h>1?pe()&&(f.exists()&&!f.isDead&&f.addXP&&f.addXP(q.value),my(q.value)):f.addXP(q.value),q.isFlyingToUI=!0}})})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const v=f.pickupRadius*1.5,W=new Set;h===1?i.pickups.getNearby(f.pos.x,f.pos.y,v).forEach(X=>{X.is&&X.is("currencyPickup")&&W.add(X)}):A.forEach(X=>{!X||!X.exists()||X.isDead||i.pickups.getNearby(X.pos.x,X.pos.y,v).forEach(G=>{G.is&&G.is("currencyPickup")&&W.add(G)})}),W.forEach(X=>{if(X.collected)return;let G=f,D=e.vec2(f.pos.x-X.pos.x,f.pos.y-X.pos.y).len();if(h>1&&A.forEach(J=>{if(!J||!J.exists()||J.isDead)return;const ue=e.vec2(J.pos.x-X.pos.x,J.pos.y-X.pos.y).len();ue<D&&(D=ue,G=J)}),!X.magnetizing&&D<=G.pickupRadius&&(X.magnetizing=!0,X.targetPlayer=G),D<=Vt.COLLECTION_RADIUS&&!X.collected){if(le()&&!pe())return;X.collected=!0,ul(),ds(X.value),G&&G.runStats&&(G.runStats.creditsPickedUp+=X.value),le()&&yy(X.value),X.isFlyingToUI=!0}}),i.pickups.getNearby(f.pos.x,f.pos.y,f.pickupRadius*1.5).forEach(X=>{if(!X.is||!X.is("powerupWeaponPickup")||X.collected)return;const G=e.vec2(f.pos.x-X.pos.x,f.pos.y-X.pos.y).len();if(!X.magnetizing&&G<=f.pickupRadius&&(X.magnetizing=!0,X.targetPlayer=f),G<=Vt.COLLECTION_RADIUS&&!X.collected){if(le()&&!pe())return;X.collected=!0,ul(),le()&&pe()?(e.get("player").forEach(Ae=>{Ma(Ae,X.powerupKey)}),ty(X.powerupKey)):Ma(f,X.powerupKey);const D=Bn[X.powerupKey],J=e.add([e.text(D.icon,{size:32}),e.pos(f.pos.x,f.pos.y-30),e.color(...D.color),e.anchor("center"),e.z(b.UI_TEXT+1),e.opacity(1)]);let ue=0;J.onUpdate(()=>{ue+=e.dt(),J.pos.y-=50*e.dt(),J.opacity=Math.max(0,1-ue/.8),ue>=.8&&e.destroy(J)}),e.destroy(X)}})}));let mt=null,zt=null,xn=0,_o=null,Ms=!1;const cc=.5,nu=10;le()&&!pe()&&(He("door_progress",v=>{if(v.clear){zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt),zt=null,mt=null;return}(!zt||!zt.exists())&&(zt=e.add([e.circle(20),e.pos(v.doorX,v.doorY),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),mt=e.add([e.circle(18),e.pos(v.doorX,v.doorY),e.anchor("center"),e.color(v.isForced?255:100,v.isForced?200:255,v.isForced?0:100),e.opacity(0),e.z(201),"doorProgress"])),mt&&mt.exists()&&(mt.opacity=v.progress,mt.scale=e.vec2(v.progress,v.progress),mt.color=e.rgb(v.isForced?255:100,v.isForced?200:255,v.isForced?0:100))}),He("barrel_damage",v=>{const W=ll(v.x,v.y);W&&W.exists()&&!W.isExploding&&(W.currentHealth=v.currentHealth,W.updateHealthBar())}),He("barrel_explode",v=>{const W=ll(v.x,v.y);W&&W.exists()&&!W.isExploding&&W.explode()})),a.updates.push(e.onUpdate(()=>{!f.exists()||e.paused||r||Ei()||le()&&!pe()||(e.get("door").forEach(v=>{if(!(!v.open||r||v.isSpawnDoor||v.blocked))if(h>1){let W=!1,q=!0;A.forEach((J,ue)=>{if(!J||!J.exists()||J.isDead||J.hp()<=0)return;const Ae=e.vec2(J.pos.x-v.pos.x,J.pos.y-v.pos.y).len()<=40;ue===0&&(W=Ae),Ae||(q=!1)});const X=q||W,G=W&&!q,D=G?nu:cc;if(X){(_o!==v||Ms!==G)&&(xn=0,_o=v,Ms=G,zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt),zt=e.add([e.circle(20),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),mt=e.add([e.circle(18),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(G?255:100,G?200:255,G?0:100),e.opacity(0),e.z(201),"doorProgress"])),xn+=e.dt();const J=Math.min(xn/D,1);mt&&mt.exists()&&(mt.opacity=J,mt.scale=e.vec2(J,J)),le()&&Ge("door_progress",{doorX:v.pos.x,doorY:v.pos.y,progress:J,isForced:G}),J>=1&&(r=!0,Ia(),zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt),_o=null,le()&&Ge("door_progress",{progress:0,clear:!0}),dc(v.direction))}else _o===v&&(xn=0,_o=null,Ms=!1,zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt),le()&&Ge("door_progress",{progress:0,clear:!0}))}else{if(f.isDead||f.hp()<=0)return;if(e.vec2(f.pos.x-v.pos.x,f.pos.y-v.pos.y).len()<=40){_o!==v&&(xn=0,_o=v,Ms=!1,zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt),zt=e.add([e.circle(20),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),mt=e.add([e.circle(18),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(100,255,100),e.opacity(0),e.z(201),"doorProgress"])),xn+=e.dt();const X=Math.min(xn/cc,1);mt&&mt.exists()&&(mt.opacity=X,mt.scale=e.vec2(X,X)),X>=1&&(r=!0,Ia(),zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt),_o=null,dc(v.direction))}else _o===v&&(xn=0,_o=null,Ms=!1,zt&&zt.exists()&&e.destroy(zt),mt&&mt.exists()&&e.destroy(mt))}}),!_o&&zt&&zt.exists()&&(e.destroy(zt),e.destroy(mt)))}));function su(){if(!f.exists())return;const v=e.width()/2,W=e.height()/2,q=5,X=3,G=_?3:1,D=_?4:1,J=n*.5,ue=Math.floor((q+J)*G),$e=Math.floor((X+J)*D),Ae=u();for(let Ne=0;Ne<ue;Ne++){const De=Math.PI*2*Ne/ue+(Ae?Ae.next():Math.random())*.3,Xe=40+(Ae?Ae.next():Math.random())*60,ze=v+Math.cos(De)*Xe,bt=W+Math.sin(De)*Xe,Xt=Math.floor(1+n*.5);Xs(e,ze,bt,Xt)}for(let Ne=0;Ne<$e;Ne++){const De=Math.PI*2*Ne/$e+(Ae?Ae.next():Math.random())*.3+.5,Xe=50+(Ae?Ae.next():Math.random())*70,ze=v+Math.cos(De)*Xe,bt=W+Math.sin(De)*Xe,Xt=Math.floor(1+n*.3),qt=Bi();Fs(e,ze,bt,Xt,qt)}if(_){const Ne=Object.keys(Bn),De=1+Math.floor((Ae?Ae.next():Math.random())*2);for(let Xe=0;Xe<De;Xe++){const ze=(Ae?Ae.next():Math.random())*Math.PI*2,bt=80+(Ae?Ae.next():Math.random())*40,Xt=v+Math.cos(ze)*bt,qt=W+Math.sin(ze)*bt,bn=Ne[Math.floor((Ae?Ae.next():Math.random())*Ne.length)];jc(e,Xt,qt,bn)}}}function lc(){o.roomCleared=!0,o.clearRoom(),le()&&pe()&&gy(),h>1&&d(),St.roomsCleared++;const v=f.exists()?f.level:1;if(Si(e,{floor:j.currentFloor,enemiesKilled:St.enemiesKilled,bossesKilled:St.bossesKilled,level:v,currencyEarned:0}),j.floorMap&&U&&j.floorMap.markRoomCleared(U.position.x,U.position.y),c.forEach(X=>{X.exists()&&!X.blocked&&(X.open=!0,X.isSpawnDoor=!1,X.updateVisual())}),_){const X=c.find(G=>G.direction==="north");X&&X.exists()&&(X.blocked=!1,X.open=!0,X.isSpawnDoor=!1,X.isFloorExit=!0,X.updateVisual())}j.minimap&&j.minimap.update(),(!le()||pe())&&su();const W=_?`BOSS DEFEATED! Floor ${n} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",q=e.add([e.text(W,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{q.exists()&&e.destroy(q)})}function dc(v){j.allPlayerStats=A.map((D,J)=>!D||!D.exists()?null:{slotIndex:D.slotIndex!==void 0?D.slotIndex:J,playerName:D.playerName,isRemote:D.isRemote||!1,isDead:D.isDead||!1,level:D.level,xp:D.xp,xpToNext:D.xpToNext,maxHealth:D.maxHealth,currentHP:D.hp(),speed:D.slowed?D.originalSpeed:D.speed,originalSpeed:D.originalSpeed||D.speed,slowed:!1,fireRate:D.fireRate,projectileSpeed:D.projectileSpeed,projectileDamage:D.projectileDamage,pickupRadius:D.pickupRadius,xpMultiplier:D.xpMultiplier||1,characterKey:D.characterKey,dodgeChance:D.dodgeChance||0,damageReduction:D.damageReduction||0,fireDotMultiplier:D.fireDotMultiplier||1,invulnerableDuration:D.invulnerableDuration||1,projectileCount:D.projectileCount||1,piercing:D.piercing||0,obstaclePiercing:D.obstaclePiercing||0,critChance:D.critChance||0,critDamage:D.critDamage||2,spreadAngle:D.spreadAngle||0,defense:D.defense||0,weaponRange:D.weaponRange||600,weapons:D.weapons||[],passiveUpgrades:D.passiveUpgrades||[],upgradeStacks:D.upgradeStacks||{},selectedUpgrades:D.selectedUpgrades?Array.from(D.selectedUpgrades):[],activeSynergies:D.activeSynergies?Array.from(D.activeSynergies):[],piercingDamageBonus:D.piercingDamageBonus||1,characterData:D.characterData,weaponDef:D.weaponDef,baseProjectileDamage:D.baseProjectileDamage,baseFireRate:D.baseFireRate,baseProjectileSpeed:D.baseProjectileSpeed,pendingLevelUps:D.pendingLevelUps||[],powerupWeapon:D.powerupWeapon||null,powerupAmmo:D.powerupAmmo!==void 0?D.powerupAmmo:null,powerupDuration:D.powerupDuration!==void 0?D.powerupDuration:null,originalWeapon:D.originalWeapon||null,weaponKey:D.weaponKey,weaponCategory:D.weaponCategory,orbitRadius:D.orbitRadius,rotationSpeed:D.rotationSpeed,explosionRadius:D.explosionRadius,explosionDamage:D.explosionDamage,chainRange:D.chainRange,maxJumps:D.maxJumps,chainDamageReduction:D.chainDamageReduction,thornsPercent:D.thornsPercent||0,thornsIgnoreArmor:D.thornsIgnoreArmor||!1,runStats:D.runStats||{kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}).filter(D=>D!==null);const W=j.allPlayerStats.find(D=>!D.isRemote);W&&(j.playerStats=W);const q={north:"south",south:"north",west:"east",east:"west"};j.entryDirection=q[v]||null;const G={north:"up",south:"down",east:"right"}[v];if(j.floorMap)if(U&&U.isBossRoom&&U.cleared){if(n++,Oc(n-1)){const ue=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{ue.exists()&&e.destroy(ue)})}j.floorMap=null,j.entryDirection=null,s=1,o.nextFloor()}else G?j.floorMap.moveToRoom(G)?s=j.floorMap.getVisitedCount():(console.error("[Game] Failed to move in floor map - should not happen!"),s++):(console.warn("[Game] Invalid door direction:",v),s++),o.nextRoom();else if(s++,s>3){if(n++,Oc(n-1)){const J=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{J.exists()&&e.destroy(J)})}s=1,j.entryDirection=null,o.nextFloor()}else o.nextRoom();if(j.currentFloor=n,j.currentRoom=s,le()&&pe()){const D=wi(),J=qs(n,D);j.roomTemplateKey=J.key,console.log("[Multiplayer] Host selected next room template:",J.key),by(j.entryDirection,j.allPlayerStats,G,n,j.roomTemplateKey)}e.go("game")}f.onDeath(()=>{if(f.orbitalOrbs&&(f.orbitalOrbs.forEach(G=>{G.exists()&&e.destroy(G)}),f.orbitalOrbs=[]),f.glowEffect&&f.glowEffect.exists()&&(e.destroy(f.glowEffect),f.glowEffect=null),h>1&&(le()&&f.slotIndex!==void 0&&vy(f.slotIndex),f.isDead=!0,f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5),!pe()||A.some(D=>D&&D.exists()&&D.hp()>0&&!D.isDead)))return;const v=Ea(St),W={...St,level:f.level,currencyEarned:v};va(W),ds(v);const q=St.startTime?Math.floor((Date.now()-St.startTime)/1e3):0;Ug({character:f.characterData?.key||"survivor",weapon:f.weaponKey||"pistol",floorsReached:St.floorsReached,roomsCleared:St.roomsCleared,enemiesKilled:St.enemiesKilled,bossesKilled:St.bossesKilled,level:f.level||1,currencyEarned:v,duration:q,deathCause:"Enemy",upgrades:f.selectedUpgrades?Array.from(f.selectedUpgrades):[],synergies:f.activeSynergies?Array.from(f.activeSynergies):[]}),Si(e);const X=A.filter(G=>G&&G.exists()).map(G=>({name:G.playerName||"Player",level:G.level||1,characterData:G.characterData,kills:G.runStats?.kills||0,deaths:G.runStats?.deaths||0,revives:G.runStats?.revives||0,damageTaken:G.runStats?.damageTaken||0,damageDealt:G.runStats?.damageDealt||0,xpCollected:G.runStats?.xpPickedUp||0,creditsPickedUp:G.runStats?.creditsPickedUp||0,bossesKilled:G.runStats?.bossesKilled||0}));le()&&pe()&&ol(St,v,X),le()&&rs(),e.go("gameOver",{runStats:{...St},currencyEarned:v,partyStats:X,isDailyRun:j.isDailyRun,dailyCharacter:j.dailyCharacter})});const ga=e.add([e.rect(300,260),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_DARK),e.opacity(.95),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(2e3),"pauseOverlay"]),ma=e.add([e.text("PAUSED",{size:Z.H1*2}),e.pos(e.width()/2,e.height()/2-95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2001),"pauseText"]),fi=e.height()/2,{LG:hc,SM:uc}=zn.BUTTON,fc=e.add([e.rect(hc.width,hc.height),e.pos(e.width()/2,fi-20),e.anchor("center"),e.color(...y.SUCCESS),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("RESUME",{size:Z.H2}),e.pos(e.width()/2,fi-20),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]);const pc=e.add([e.rect(uc.width,uc.height),e.pos(e.width()/2,fi+45),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("QUIT",{size:Z.SMALL}),e.pos(e.width()/2,fi+45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]),ga.hidden=!0,ma.hidden=!0,e.get("pauseButton").forEach(v=>v.hidden=!0);const pi=v=>{v?(sx(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Ye)):(pl(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Ye=e.gameData.weaponDetailSavedState,At.hidden=!Ye,ct.hidden=!Ye,Bt.hidden=!Ye,Dt.hidden=!Ye,xt.hidden=!Ye,Rt.hidden=!Ye,e.gameData.weaponDetailSavedState=void 0)),ga.hidden=!v,ma.hidden=!v,e.get("pauseButton").forEach(W=>W.hidden=!v)};e.gameData.updatePauseUI=pi,fc.onClick(()=>{!e.paused||fc.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Ye=e.gameData.weaponDetailSavedState,At.hidden=!Ye,ct.hidden=!Ye,Bt.hidden=!Ye,Dt.hidden=!Ye,xt.hidden=!Ye,Rt.hidden=!Ye,e.gameData.weaponDetailSavedState=void 0),pl(),ga.hidden=!0,ma.hidden=!0,e.get("pauseButton").forEach(v=>v.hidden=!0))}),pc.onClick(()=>{if(!(!e.paused||pc.hidden))if(le())if(pe())ey(),rs(),j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu");else{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Leave party and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const v=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const W=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]),v.onClick(()=>{e.get("confirmDialog").forEach(q=>e.destroy(q)),rs(),j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu")}),W.onClick(()=>{e.get("confirmDialog").forEach(q=>e.destroy(q))})}else j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu")}),a.keyPresses.push(e.onKeyPress("m",()=>{j.minimap&&!e.paused&&j.minimap.toggle()})),a.keyPresses.push(e.onKeyPress("escape",()=>{Ei()||(le()?pe()?(e.paused=!e.paused,hy(e.paused),pi(e.paused)):uy(!e.paused):(e.paused=!e.paused,pi(e.paused)))}));const gc=()=>{le()||e.paused||Ei()||(e.paused=!0,pi(!0))};window.addEventListener("blur",gc),e.onSceneLeave(()=>{window.removeEventListener("blur",gc)}),e.onSceneLeave(()=>{if(a.updates.forEach(v=>{try{v&&v.cancel&&v.cancel()}catch(W){console.warn("[Game] Error canceling update handler:",W)}}),a.keyPresses.forEach(v=>{try{v&&v.cancel&&v.cancel()}catch(W){console.warn("[Game] Error canceling keypress handler:",W)}}),!pe()&&le()){try{Ot("room_transition"),Ot("room_completed"),Ot("game_over")}catch(v){console.warn("[Game] Error unregistering message handlers:",v)}Ti=!1}j.minimap&&(j.minimap.destroy(),j.minimap=null),Ty()})})}const _t={LEVEL:"level",CHARACTER:"character",ACHIEVEMENT:"achievement"},Zn={default:{id:"default",name:"Rookie",icon:"",color:[200,200,200],category:_t.LEVEL,unlockCondition:{type:"default"},description:"Everyone starts somewhere."},veteran:{id:"veteran",name:"Veteran",icon:"",color:[100,200,255],category:_t.LEVEL,unlockCondition:{type:"level",value:10},description:"A seasoned competitor with many battles under their belt."},elite:{id:"elite",name:"Elite",icon:"",color:[255,200,100],category:_t.LEVEL,unlockCondition:{type:"level",value:25},description:"Among the top performers in the arena."},legend:{id:"legend",name:"Legend",icon:"",color:[255,100,255],category:_t.LEVEL,unlockCondition:{type:"level",value:50},description:"A living legend whose name echoes through the halls."},champion:{id:"champion",name:"Champion",icon:"",color:[255,215,0],category:_t.LEVEL,unlockCondition:{type:"level",value:75},description:"A true champion who has conquered all challenges."},immortal:{id:"immortal",name:"Immortal",icon:"",color:[200,255,255],category:_t.LEVEL,unlockCondition:{type:"level",value:100},description:"Transcended mortality. A god among players."},survivor:{id:"survivor",name:"Survivor",icon:"",color:[100,200,100],category:_t.CHARACTER,unlockCondition:{type:"character",value:"survivor"},description:"The default hero. Never gives up."},berserker:{id:"berserker",name:"Berserker",icon:"",color:[255,100,100],category:_t.CHARACTER,unlockCondition:{type:"character",value:"berserker"},description:"Rage incarnate. Pain is just fuel."},ranger:{id:"ranger",name:"Ranger",icon:"",color:[100,255,150],category:_t.CHARACTER,unlockCondition:{type:"character",value:"ranger"},description:"Swift and precise. Death from a distance."},mage:{id:"mage",name:"Mage",icon:"",color:[200,100,255],category:_t.CHARACTER,unlockCondition:{type:"character",value:"mage"},description:"Master of the arcane arts."},tank:{id:"tank",name:"Tank",icon:"",color:[150,150,200],category:_t.CHARACTER,unlockCondition:{type:"character",value:"tank"},description:"An immovable wall. Nothing gets through."},assassin:{id:"assassin",name:"Assassin",icon:"",color:[150,100,150],category:_t.CHARACTER,unlockCondition:{type:"character",value:"assassin"},description:"Silent. Deadly. Gone before you know it."},boss_slayer:{id:"boss_slayer",name:"Boss Slayer",icon:"",color:[255,180,50],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:100},description:"Has ended the reign of 100 bosses."},speedrunner:{id:"speedrunner",name:"Speedrunner",icon:"",color:[255,255,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"fastestRunTime",value:600,comparison:"lessThan"},description:"Completed a run in under 10 minutes."},perfectionist:{id:"perfectionist",name:"Perfectionist",icon:"",color:[255,255,255],category:_t.ACHIEVEMENT,unlockCondition:{type:"achievement",value:"flawless_run"},description:"Completed a run without taking damage."},grinder:{id:"grinder",name:"Grinder",icon:"",color:[200,150,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:100},description:"Has completed 100 runs. Dedication personified."},collector:{id:"collector",name:"Collector",icon:"",color:[255,215,0],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:1e4},description:"Has earned 10,000 credits total."},exterminator:{id:"exterminator",name:"Exterminator",icon:"",color:[200,50,50],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e4},description:"Has eliminated 10,000 enemies."},explorer:{id:"explorer",name:"Explorer",icon:"",color:[100,180,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:5},description:"Reached floor 5. The journey begins."},delver:{id:"delver",name:"Delver",icon:"",color:[180,140,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:10},description:"Reached floor 10. Deep into the unknown."},abyssal:{id:"abyssal",name:"Abyssal",icon:"",color:[80,50,150],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:20},description:"Reached floor 20. Touched the abyss."},slayer:{id:"slayer",name:"Slayer",icon:"",color:[200,80,80],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:25},description:"Has slain 25 bosses."},warrior:{id:"warrior",name:"Warrior",icon:"",color:[150,150,200],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e3},description:"Has defeated 1,000 enemies."},rich:{id:"rich",name:"Wealthy",icon:"",color:[100,200,255],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:5e4},description:"Has earned 50,000 credits. Living large."},dedicated:{id:"dedicated",name:"Dedicated",icon:"",color:[150,100,200],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:50},description:"Has completed 50 runs. Committed to the grind."},marathoner:{id:"marathoner",name:"Marathoner",icon:"",color:[100,200,150],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRoomsCleared",value:500},description:"Has cleared 500 rooms. Endurance personified."}};function mr(e){return Zn[e]||null}function f1(){return Object.values(Zn)}function p1(e,t){const o=Zn[e];if(!o)return!1;const n=o.unlockCondition;switch(n.type){case"default":return!0;case"level":return Math.floor(Math.sqrt((t.totalXP||0)/100))+1>=n.value;case"character":return t.unlocks?.characters?.includes(n.value)||!1;case"achievement":return t.achievements?.includes(n.value)||!1;case"stat":const a=t.stats?.[n.stat]||0;return n.comparison==="lessThan"?a>0&&a<n.value:a>=n.value;default:return!1}}function g1(e){const t=Zn[e];if(!t)return"Unknown";const o=t.unlockCondition;switch(o.type){case"default":return"Unlocked by default";case"level":return`Reach Level ${o.value}`;case"character":return`Unlock the ${o.value.charAt(0).toUpperCase()+o.value.slice(1)} character`;case"achievement":return`Complete the "${o.value}" achievement`;case"stat":const s={totalBossesKilled:"bosses killed",totalRuns:"runs completed",totalCurrencyEarned:"credits earned",totalEnemiesKilled:"enemies killed",fastestRunTime:"second run"}[o.stat]||o.stat;return o.comparison==="lessThan"?`Complete a run in under ${Math.floor(o.value/60)} minutes`:`${o.value.toLocaleString()} ${s}`;default:return"Unknown condition"}}const _h="superSmashTextyDailyRuns",m1=["survivor","scout","tank","sniper","pyro","bomber","engineer","vampire","berserker","ghost"];function Ko(){return new Date().toISOString().split("T")[0]}function Xh(e=null){const t=e||Ko();return Dm(t+"SuperSmashTexty")}function nc(e=null){const t=Xh(e);return new pn(t).choose(m1)}function y1(){return nc(Ko())}function ha(){try{const e=localStorage.getItem(_h);return e?JSON.parse(e):{completedDays:{},attempts:{}}}catch(e){return console.warn("[DailyRuns] Failed to parse daily run data:",e),{completedDays:{},attempts:{}}}}function x1(e){try{localStorage.setItem(_h,JSON.stringify(e))}catch(t){console.warn("[DailyRuns] Failed to save daily run data:",t)}}function b1(){const e=ha(),t=Ko();return!!e.completedDays[t]}function w1(e){return ha().completedDays[e]||null}function v1(){return w1(Ko())}function E1(e){const t=ha(),o=Ko(),n={date:o,score:e.score||0,floor:e.floor||1,character:e.character||y1(),duration:e.duration||0,completedAt:Date.now()};return t.completedDays[o]=n,x1(t),console.log("[DailyRuns] Marked daily completed:",n),n}function A1(){const e=ha(),t=Ko();return e.attempts[t]||0}function S1(){const e=Ko(),t=Xh(e),o=nc(e),n=b1(),s=v1(),a=A1();return{date:e,seed:t,character:o,completed:n,completion:s,attempts:a}}const vo={LEFT_COLUMN_X:20,LEFT_COLUMN_WIDTH:200,RIGHT_COLUMN_WIDTH:200,TOP_MARGIN:20};function ss(e,t,o,n,s=ns.WIDTH,a=ns.HEIGHT,r=Z.BUTTON){const l=y.SECONDARY,c=y.SECONDARY_HOVER,d=y.TEXT_PRIMARY,i=y.BORDER,h=e.add([e.rect(s,a),e.pos(o,n),e.anchor("center"),e.color(...l),e.outline(2,e.rgb(...i)),e.area(),e.fixed(),e.scale(1),e.z(b.UI_ELEMENTS),"menuButton"]),u=ni(t),p=e.add([e.text(u,{size:r}),e.pos(o,n),e.anchor("center"),e.color(...d),e.fixed(),e.scale(1),e.z(b.UI_TEXT),"menuButtonText"]);return h.originalColor=[...l],h.hoverColor=[...c],h.borderColor=[...i],h.isHovered=!1,h.disabled=!1,h.label=p,h.labels=[p],h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,Ze()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...y.BORDER_HOVER),h.scale=e.vec2(ns.HOVER_SCALE,ns.HOVER_SCALE),p.scale=e.vec2(ns.HOVER_SCALE,ns.HOVER_SCALE))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),p.scale=e.vec2(1,1))}),h.setDisabled=g=>{h.disabled=g,g?(h.color=e.rgb(...y.BG_DISABLED),p.color=e.rgb(...y.TEXT_DISABLED)):(h.color=e.rgb(...h.originalColor),p.color=e.rgb(...d))},h}function Rl(e,t,o){t/=100,o/=100;const n=(1-Math.abs(2*o-1))*t,s=n*(1-Math.abs(e/60%2-1)),a=o-n/2;let r=0,l=0,c=0;return e>=0&&e<60?(r=n,l=s,c=0):e>=60&&e<120?(r=s,l=n,c=0):e>=120&&e<180?(r=0,l=n,c=s):e>=180&&e<240?(r=0,l=s,c=n):e>=240&&e<300?(r=s,l=0,c=n):e>=300&&e<360&&(r=n,l=0,c=s),[Math.round((r+a)*255),Math.round((l+a)*255),Math.round((c+a)*255)]}function M1(e){e.scene("menu",()=>{wh();const t=hr();vh(t.audio.masterVolume),Dh(t.audio.musicVolume),Eh(t.audio.sfxVolume),t.audio.uiSounds!==void 0&&Ah(t.audio.uiSounds),t.audio.combatSounds!==void 0&&Sh(t.audio.combatSounds);let o=!1;const n=()=>{o||(o=!0,Gy(),gl())};e.onClick(n),e.onKeyPress(n),gl();const s=$n(),a=e.width()-vo.RIGHT_COLUMN_WIDTH-vo.LEFT_COLUMN_X,r=e.width()/2;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(b.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...y.BORDER),e.fixed(),e.z(b.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...y.BORDER),e.fixed(),e.z(b.UI_BACKGROUND)]);const l=vo.LEFT_COLUMN_X,c=vo.TOP_MARGIN+50,d=vo.LEFT_COLUMN_WIDTH,i=75,h=e.add([e.rect(d,i),e.pos(l,c),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_BACKGROUND),"profileCard"]),u=mr(ci())||Zn.default,p=45,g=l+32,M=c+i/2;e.add([e.rect(p,p),e.pos(g,M),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...u.color||[200,200,200])),e.fixed(),e.z(b.UI_BACKGROUND+1)]),e.add([e.text(u.icon,{size:24}),e.pos(g,M),e.anchor("center"),e.color(...u.color||[200,200,200]),e.fixed(),e.z(b.UI_TEXT)]);const m=Mo(),T=m.length>16?m.substring(0,16)+"..":m,P=g+p/2+10;e.add([e.text(T,{size:Z.SMALL}),e.pos(P,c+15),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);const f=ri();e.add([e.text(`Lv.${f}`,{size:Z.SMALL-2}),e.pos(P,c+32),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);const N=Ur(),O=d-75,w=8,A=P,S=c+50;e.add([e.rect(O,w),e.pos(A,S),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(b.UI_BACKGROUND+1)]);const I=Math.max(2,O*N);e.add([e.rect(I,w-2),e.pos(A+1,S),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(b.UI_ELEMENTS)]),e.add([e.text(`${Math.round(N*100)}%`,{size:9}),e.pos(A+O/2,S),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),h.onClick(()=>{Ut(),e.go("profile")}),h.onHoverUpdate(()=>{h.color=e.rgb(...y.BG_LIGHT)}),h.onHoverEnd(()=>{h.color=e.rgb(...y.BG_MEDIUM)}),lh(e);const E=vo.LEFT_COLUMN_X,L=c+i+10,C=vo.LEFT_COLUMN_WIDTH,F=24,U=3,_=8,H=_+F*4+U*3+55;e.add([e.rect(C,H),e.pos(E,L),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const R=L+_,Y=[];function V(){Y.forEach(be=>{be.forEach(ce=>{ce.exists()&&e.destroy(ce)})}),Y.length=0,hm().forEach((be,ce)=>{const de=R+ce*(F+U),Ee=[],ke=!be.isEmpty&&!be.isLocal,lt=e.add([e.rect(C-16,F),e.pos(E+8,de),e.color(be.isEmpty?y.BG_DARK:y.BG_LIGHT),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.UI_BACKGROUND+1),ke?e.area():null,"partySlotUI"].filter(Boolean));Ee.push(lt),ke&&(lt.onClick(()=>{Ut(),wm(ce,It=>{It?e.go("profile",{externalProfile:It}):console.warn("Failed to load profile for slot",ce)})}),lt.onHoverUpdate(()=>{lt.color=e.rgb(80,90,110)}),lt.onHoverEnd(()=>{lt.color=e.rgb(...y.BG_LIGHT)}));let We=`${be.slotNumber}`;be.isEmpty||(We=(mr(be.selectedPortrait)||Zn.default).icon);const je=e.add([e.text(We,{size:be.isEmpty?Z.SMALL:Z.SMALL+2}),e.pos(E+18,de+F/2),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);if(Ee.push(je),!be.isEmpty){const It=$t[be.selectedCharacter]||$t.survivor,Zt=e.add([e.text(It.char,{size:Z.SMALL}),e.pos(E+38,de+F/2),e.anchor("left"),e.color(...It.color),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);Ee.push(Zt)}const ho=e.add([e.text(be.playerName.substring(0,16),{size:Z.SMALL-2}),e.pos(E+(be.isEmpty?32:55),de+F/2),e.anchor("left"),e.color(be.isEmpty?y.TEXT_DISABLED:be.isLocal?y.GOLD:y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);if(Ee.push(ho),!be.isEmpty){const It=be.isReady?"":"",Zt=be.isReady?y.SUCCESS:y.TEXT_DISABLED,Io=e.add([e.text(It,{size:Z.SMALL-2}),e.pos(E+C-14,de+F/2),e.anchor("center"),e.color(...Zt),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);Ee.push(Io);const bo=xm(ce);if(bo){const fo=bo==="exclamation"?"!":"",Wo=bo==="exclamation"?[255,255,0]:[255,100,150],Nt=e.add([e.text(fo,{size:Z.SMALL+2}),e.pos(E+C-28,de+F/2),e.anchor("center"),e.color(...Wo),e.fixed(),e.z(b.UI_TEXT+1),"partySlotUI"]);Ee.push(Nt)}}if(be.isDisconnected){const It=e.add([e.text("",{size:Z.SMALL-2}),e.pos(E+C-28,de+F/2),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);Ee.push(It)}Y.push(Ee)})}V();let Q=0;e.onUpdate(()=>{Q+=e.dt(),Q>=1&&(Q=0,V(),typeof Dt=="function"&&Dt())});const fe=R+4*(F+U)+6;e.add([e.text("Code:",{size:Z.SMALL-2}),e.pos(E+8,fe),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const se=qc(),ie=e.add([e.text(se,{size:Z.SMALL-2}),e.pos(E+C-8,fe),e.anchor("right"),e.color(se==="OFFLINE"?[...y.TEXT_DISABLED]:[...y.GOLD]),e.fixed(),e.z(b.UI_TEXT)]);let ae=se!=="OFFLINE";ie.onUpdate(()=>{if(!ae){const xe=qc();xe&&xe!=="OFFLINE"&&(ie.text=xe,ie.color=e.rgb(...y.GOLD),ae=!0)}});const ge=fe+22;ss(e,"JOIN PARTY",E+C/2,ge,C-20,28,Z.SMALL).onClick(()=>{Ut(),e.go("joinParty")});const Ie=ge+30;let ve=[],_e=null,nt={partySize:0,isReady:!1,countdownActive:!1,countdownSeconds:0};function Me(xe=!1){const be=Hn(),ce=Wc(),de=fm(),Ee=ce.active?Math.ceil(ce.timeRemaining/1e3):0;if(!(!xe&&nt.partySize===be&&nt.isReady===de&&nt.countdownActive===ce.active&&nt.countdownSeconds===Ee)&&(nt={partySize:be,isReady:de,countdownActive:ce.active,countdownSeconds:Ee},ve.forEach(ke=>{ke.exists()&&e.destroy(ke)}),ve=[],_e&&_e.exists()&&(e.destroy(_e),_e=null),be>=2)){const ke=e.add([e.rect(C-20,24),e.pos(E+C/2,Ie),e.anchor("center"),e.color(de?100:60,de?150:80,de?100:120),e.outline(2,e.rgb(de?100:80,de?200:120,de?100:180)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS),"readyButtonUI"]);ve.push(ke);const lt=e.add([e.text(de?" READY":"READY UP",{size:Z.SMALL-2}),e.pos(E+C/2,Ie),e.anchor("center"),e.color(de?150:100,de?255:150,de?150:200),e.fixed(),e.z(b.UI_TEXT),"readyButtonUI"]);ve.push(lt),ke.onClick(()=>{Ut(),um(),Me(!0),V()}),ce.active&&(_e=e.add([e.text(`Starting in ${Ee}...`,{size:Z.SMALL-2}),e.pos(E+C/2,Ie+20),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT),"countdownUI"]))}}Me(!0);let Tt=0;e.onUpdate(()=>{if(Tt+=e.dt(),Tt<.1)return;Tt=0;const xe=Wc();Hn()>=2&&Me(),xe.active&&xe.timeRemaining<=0&&fs().isHost&&(Ut(),Gc(),e.go("game",{resetState:!0}))});const ee=vo.RIGHT_COLUMN_WIDTH,we=120,ye=a,Pe=vo.TOP_MARGIN+50,qe=S1(),Ce=$t[qe.character]||$t.survivor;e.add([e.rect(ee,we),e.pos(ye,Pe),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]),e.add([e.text("DAILY RUN",{size:Z.SMALL}),e.pos(ye+ee/2,Pe+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(Ce.char,{size:28}),e.pos(ye+ee/2,Pe+45),e.anchor("center"),e.color(...Ce.color),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(Ce.name,{size:Z.SMALL-2}),e.pos(ye+ee/2,Pe+68),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const Je=Hn()>1;if(qe.completed)e.add([e.text("COMPLETED",{size:Z.SMALL-2}),e.pos(ye+ee/2,Pe+95),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT)]);else if(Je)e.add([e.text("SOLO ONLY",{size:Z.SMALL-2}),e.pos(ye+ee/2,Pe+95),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);else{const xe=e.add([e.rect(ee-40,28),e.pos(ye+ee/2,Pe+95),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("PLAY",{size:Z.SMALL}),e.pos(ye+ee/2,Pe+95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),xe.onClick(()=>{Hn()>1||(Ut(),e.go("game",{resetState:!0,isDailyRun:!0,dailyCharacter:qe.character,dailySeed:qe.seed,dailyDate:qe.date}))}),xe.onHoverUpdate(()=>{xe.color=e.rgb(...y.SECONDARY_HOVER)}),xe.onHoverEnd(()=>{xe.color=e.rgb(...y.SECONDARY)})}qr(e,s);const it=Pe+we+15;e.add([e.rect(vo.RIGHT_COLUMN_WIDTH,100),e.pos(a,it),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_BACKGROUND),"leaderboardsPanel"]),e.add([e.text("LEADERBOARDS",{size:Z.SMALL}),e.pos(a+vo.RIGHT_COLUMN_WIDTH/2,it+15),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text("",{size:32}),e.pos(a+vo.RIGHT_COLUMN_WIDTH/2,it+50),e.anchor("center"),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text("VIEW",{size:Z.SMALL-2}),e.pos(a+vo.RIGHT_COLUMN_WIDTH/2,it+80),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const Te=e.get("leaderboardsPanel")[0];Te&&(Te.onClick(()=>{Ut(),e.go("leaderboards")}),Te.onHoverUpdate(()=>{Te.color=e.rgb(...y.BG_LIGHT)}),Te.onHoverEnd(()=>{Te.color=e.rgb(...y.BG_MEDIUM)}));const Fe=160,Be=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],Re=[],Ke=12,dt=Fe-Be.length*Ke/2;Be.forEach((xe,be)=>{const ce=e.add([e.text(xe,{size:10,font:"monospace"}),e.pos(r,dt+be*Ke),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.z(b.UI_TEXT),"titleLine"]);Re.push(ce)});let ft=0;e.onUpdate(()=>{ft+=e.dt(),Re.forEach((xe,be)=>{const ce=(ft*50+be*20)%360,de=Rl(ce,80,60);xe.color=e.rgb(...de);const Ee=Math.sin(ft*2+be*.3)*2;xe.pos.y=dt+be*Ke+Ee,Math.random()<.001&&(xe.pos.x=r+(Math.random()-.5)*10,e.wait(.1,()=>{xe.exists()&&(xe.pos.x=r)}))})});const ht=310,ut=55,{XL:At,LG:ct}=zn.BUTTON,Bt=ss(e,"ACTION!",r,ht,At.width,At.height,Z.H1);Bt.onClick(()=>{if(Bt.disabled)return;Ut(),Hn()>1&&Gc(),e.go("game",{resetState:!0})});function Dt(){const xe=fs(),ce=Hn()>1&&!xe.isHost;Bt.setDisabled(ce)}Dt();const xt=ss(e,"CONTESTANTS",r,ht+ut,ct.width,ct.height,Z.H2);xt.onClick(()=>{Ut(),e.go("characterSelect")});const Rt=mn(),Ye=$t[Rt];if(Ye){const xe=Yo("characters",Rt)||Ye.unlockedByDefault,be=r+ct.width/2+35,ce=ht+ut,de=45,Ee=e.add([e.rect(de,de),e.pos(be,ce),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_BACKGROUND)]),ke=e.add([e.text(Ye.char,{size:28}),e.pos(be,ce),e.anchor("center"),e.color(...xe?Ye.color:y.BG_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);Ee.onClick(()=>{Ut(),e.go("characterSelect")}),Ee.onHoverUpdate(()=>{Ee.color=e.rgb(...y.BG_LIGHT),ke.scale=e.vec2(1.1)}),Ee.onHoverEnd(()=>{Ee.color=e.rgb(...y.BG_MEDIUM),ke.scale=e.vec2(1)})}const Ct=ss(e,"MERCH",r,ht+ut*2,ct.width,ct.height,Z.H2);Ct.onClick(()=>{Ut(),e.go("shop")});const me=ss(e,"RATINGS",r,ht+ut*3,ct.width,ct.height,Z.H2);me.onClick(()=>{Ut(),e.go("statistics")});const st=ss(e,"OPTIONS",r,ht+ut*4,ct.width,ct.height,Z.H2);st.onClick(()=>{Ut(),e.go("settings")});const re=[Bt,xt,Ct,me,st];let Le=0;e.onUpdate(()=>{Le+=e.dt(),re.forEach((xe,be)=>{if(!xe.exists()||xe.isHovered)return;const ce=(Le*60+be*50)%360,de=Rl(ce,70,50);try{xe.color=e.rgb(de[0],de[1],de[2]),xe.originalColor=de}catch{}})});const Qe=e.onKeyPress("space",()=>{Bt.disabled||(Ut(),e.go("game",{resetState:!0}))}),et=e.onKeyPress("c",()=>{Ze(),e.go("characterSelect")}),B=e.onKeyPress("s",()=>{Ze(),e.go("shop")}),K=e.onKeyPress("o",()=>{Ze(),e.go("settings")}),te=e.onKeyPress("t",()=>{Ze(),e.go("statistics")});let he=0;const tt=.5,ot=e.onKeyPress("q",()=>{const xe=e.time();xe-he<tt||(he=xe,$c("exclamation"),V())}),Lt=e.onKeyPress("e",()=>{const xe=e.time();xe-he<tt||(he=xe,$c("heart"),V())}),at=(xe,be)=>{V()};mm(at),e.onSceneLeave(()=>{Qe.cancel(),et.cancel(),B.cancel(),K.cancel(),te.cancel(),ot.cancel(),Lt.cancel(),ym(at)});for(let xe=0;xe<12;xe++){const be=e.add([e.text(["*","+",""][Math.floor(Math.random()*3)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(b.PARTICLES)]);be.speed=15+Math.random()*25,be.onUpdate(()=>{be.pos.y+=be.speed*e.dt(),be.pos.y>e.height()&&(be.pos.y=0,be.pos.x=Math.random()*e.width())})}const vt=["","","",""];for(let xe=0;xe<8;xe++){const be=e.add([e.text(vt[Math.floor(Math.random()*vt.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.1),e.scale(1),e.z(b.PARTICLES)]);be.pulseTime=Math.random()*Math.PI*2,be.pulseSpeed=1+Math.random()*1.5,be.onUpdate(()=>{be.pulseTime+=e.dt()*be.pulseSpeed;const ce=.8+Math.sin(be.pulseTime)*.2;be.scale=e.vec2(ce,ce),be.opacity=.08+Math.abs(Math.sin(be.pulseTime))*.1})}e.add([e.text("v0.1.1",{size:Z.MICRO}),e.pos(e.width()-10,e.height()-10),e.anchor("botright"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]),e.loop(12,()=>{if(Math.random()<.12){const xe=100+Math.random()*(e.height()-200),be=Math.random()<.5?1:-1,ce=be>0?-50:e.width()+50,de=e.add([e.text("$",{size:24}),e.pos(ce,xe),e.color(...y.GOLD),e.area({scale:2.5}),e.anchor("center"),e.scale(1),e.z(b.PARTICLES+1),"goldenEnemy"]);de.speed=150+Math.random()*100,de.direction=be,de.pulseTime=0,de.onClick(()=>{if(!de.exists())return;ds(1);for(let ke=0;ke<8;ke++){const lt=Math.PI*2*ke/8,We=e.add([e.text(["$",""][Math.floor(Math.random()*2)],{size:12}),e.pos(de.pos.x,de.pos.y),e.color(...y.GOLD),e.opacity(1),e.z(b.PARTICLES+2)]),je=80+Math.random()*60;We.velocity=e.vec2(Math.cos(lt)*je,Math.sin(lt)*je),We.life=.8,We.onUpdate(()=>{We.pos=We.pos.add(We.velocity.scale(e.dt())),We.life-=e.dt(),We.opacity=We.life/.8,We.life<=0&&e.destroy(We)})}const Ee=e.add([e.text("+$1",{size:18}),e.pos(de.pos.x,de.pos.y),e.anchor("center"),e.color(...y.SUCCESS),e.opacity(1),e.z(b.UI_TEXT)]);Ee.life=1.2,Ee.onUpdate(()=>{Ee.pos.y-=40*e.dt(),Ee.life-=e.dt(),Ee.opacity=Ee.life/1.2,Ee.life<=0&&e.destroy(Ee)}),e.destroy(de),e.wait(.1,()=>e.go("menu"))}),de.onUpdate(()=>{de.pos.x+=de.speed*de.direction*e.dt(),de.pulseTime+=e.dt();const Ee=Math.sin(de.pulseTime*8)*.15;de.scale=e.vec2(1+Ee,1+Ee),(de.direction>0&&de.pos.x>e.width()+100||de.direction<0&&de.pos.x<-100)&&e.destroy(de)})}})})}function T1(e){const t=[];for(const[o,n]of Object.entries($t))n.unlockRequirement?.type==="achievement"&&n.unlockRequirement?.value===e&&t.push({key:o,...n});return t}let Mt={isOpen:!1,elements:[],k:null,onClose:null};function Fh(e,t,o=null){Mt.isOpen&&Di(),Mt.k=e,Mt.isOpen=!0,Mt.onClose=o,Mt.elements=[];const n=vs(),s=Hr(t.id),a=Gi(t.id,n),r=Oo[t.difficulty]||Oo.normal,l=420,c=400,d=e.width()/2,i=e.height()/2,h=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(b.MODAL-1),e.area(),"achievementModalOverlay"]);Mt.elements.push(h),h.onClick(()=>{Di()});const u=e.add([e.rect(l,c),e.pos(d,i),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...r)),e.fixed(),e.z(b.MODAL),"achievementModal"]);Mt.elements.push(u);const p=e.add([e.text(t.name,{size:Z.HEADER}),e.pos(d,i-130),e.anchor("center"),e.color(...s?r:y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(p);const g=e.add([e.rect(64,64),e.pos(d,i-70),e.anchor("center"),e.color(s?50:30,s?50:30,s?60:30),e.outline(2,e.rgb(...s?r:y.TEXT_DISABLED)),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(g);const M=e.add([e.text(t.icon,{size:36}),e.pos(d,i-70),e.anchor("center"),e.color(...s?[255,255,255]:[80,80,80]),e.fixed(),e.z(b.MODAL+2),"achievementModal"]);Mt.elements.push(M);const m=e.add([e.text(t.description,{size:Z.BODY,width:l-40}),e.pos(d,i-25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(m);const T=T1(t.id),P=t.unlocks&&t.unlocks.length>0,f=T.length>0;if(f||P){const C=[];if(T.forEach(F=>{C.push(`${F.char} ${F.name}`)}),P&&t.unlocks.forEach(F=>{const U=Zd[F],_=ls[F];U?C.push(U.name):_&&C.push(_.name)}),C.length>0){const F=e.add([e.text(`Unlocks: ${C.join(", ")}`,{size:Z.SMALL,width:l-40}),e.pos(d,i+5),e.anchor("center"),e.color(...s?y.SUCCESS:y.GOLD),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(F)}}const O=f||P?i+35:i+25;if(a&&!s){const U=O,_=e.add([e.rect(280,20),e.pos(d,U),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(80,80,100)),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(_);const H=Math.max(4,280*a.progress),R=e.add([e.rect(H,16),e.pos(d-280/2+H/2,U),e.anchor("center"),e.color(...r),e.opacity(.8),e.fixed(),e.z(b.MODAL+2),"achievementModal"]);Mt.elements.push(R);const Y=e.add([e.text(`${a.current}/${a.target} (${a.percentage}%)`,{size:Z.SMALL}),e.pos(d,U+25),e.anchor("center"),e.color(...y.TEXT_TERTIARY),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(Y)}else if(s){const C=e.add([e.text("UNLOCKED",{size:Z.LABEL}),e.pos(d,O),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(C)}const w=Jd(t);if(w>0){const C=O+(s?35:a?55:35),F=e.add([e.text("-- REWARD --",{size:Z.SMALL}),e.pos(d,C),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(F);const U=la(),_=e.add([e.text(`${U}${w}`,{size:Z.H2}),e.pos(d,C+25),e.anchor("center"),e.color(...s?y.SUCCESS:y.GOLD),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(_)}const A=t.difficulty.charAt(0).toUpperCase()+t.difficulty.slice(1),S=e.add([e.text(`${A}`,{size:Z.SMALL}),e.pos(d,i+c/2-60),e.anchor("center"),e.color(...r),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(S);const I=e.add([e.rect(80,30),e.pos(d,i+c/2-30),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);Mt.elements.push(I);const E=e.add([e.text("CLOSE",{size:Z.SMALL}),e.pos(d,i+c/2-30),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+2),"achievementModal"]);Mt.elements.push(E),I.onClick(()=>{Ze(),Di()});const L=e.onKeyPress("escape",()=>{Di()});Mt.escHandler=L}function Di(){if(!Mt.isOpen)return;const e=Mt.k;e&&(Mt.elements.forEach(t=>{t&&t.exists&&t.exists()&&e.destroy(t)}),Mt.elements=[],Mt.escHandler&&(Mt.escHandler.cancel(),Mt.escHandler=null),Mt.isOpen=!1,Mt.onClose&&(Mt.onClose(),Mt.onClose=null))}function Yh(){return Mt.isOpen}const qh={allTime:{publicKey:"696eba6f8f40bb1184b6c60f",privateKey:"YRU5IdY0w0uJvRF8cb9S1A21WwOAek3kyr3RcOYHbdYA"},daily:{publicKey:"696ff2ee8f40bb1184b8cc92",privateKey:"SgdqIaI_fkWUlRVwoWLQlA1yEXBc-33UKZYWPWJcOX6Q"}},D1="https://corsproxy.io/?",C1="http://dreamlo.com/lb";function Gh(e){return`${D1}${encodeURIComponent(C1+e)}`}const R1=6e4,yr={allTime:{data:null,timestamp:0},daily:{data:null,timestamp:0}},I1=5e3;function Kh(e){return e&&e.replace(/[^a-zA-Z0-9_-]/g,"").substring(0,20)||"Anonymous"}function P1(e){return typeof e=="number"&&e>0&&e<=2e5}async function Vh(e,t=I1){const o=new AbortController,n=setTimeout(()=>o.abort(),t);try{const s=await fetch(e,{signal:o.signal});return clearTimeout(n),s}catch(s){throw clearTimeout(n),s}}async function sc(e,t="allTime"){try{if(!P1(e.score))return console.warn("[OnlineLeaderboards] Invalid score, skipping submission:",e.score),!1;const o=qh[t];if(!o)return console.warn("[OnlineLeaderboards] Unknown board type:",t),!1;const n=Kh(e.name),s=Math.floor(e.score),a=Math.floor(e.time||0),r=`${e.floor||1}|${e.character||"unknown"}|${e.date||""}`,l=`/${o.privateKey}/add/${encodeURIComponent(n)}/${s}/${a}/${encodeURIComponent(r)}`,c=Gh(l);console.log(`[OnlineLeaderboards] Submitting score to ${t}:`,{name:n,score:s,floor:e.floor});const d=await Vh(c);return d.ok?(console.log(`[OnlineLeaderboards] Score submitted to ${t} successfully`),yr[t].data=null,yr[t].timestamp=0,!0):(console.warn("[OnlineLeaderboards] Submission failed with status:",d.status),!1)}catch(o){return o.name==="AbortError"?console.warn("[OnlineLeaderboards] Submission timed out"):console.warn("[OnlineLeaderboards] Submission error:",o.message),!1}}async function B1(e){return sc(e,"daily")}function Il(e){const t=(e.text||"").split("|");return{name:e.name||"Anonymous",score:parseInt(e.score,10)||0,time:parseInt(e.seconds,10)||0,floor:parseInt(t[0],10)||1,character:t[1]||"survivor",date:t[2]||""}}async function Wh(e=10,t="allTime"){try{const o=qh[t];if(!o)return console.warn("[OnlineLeaderboards] Unknown board type:",t),{entries:[],totalCount:0,error:"Unknown board type"};const n=yr[t],s=Date.now();if(n.data&&s-n.timestamp<R1)return console.log(`[OnlineLeaderboards] Using cached ${t} leaderboard`),{entries:n.data.slice(0,e),totalCount:n.data.length,error:null};const a=Gh(`/${o.publicKey}/json`);console.log(`[OnlineLeaderboards] Fetching ${t} leaderboard...`);const r=await Vh(a);if(!r.ok)throw new Error(`HTTP ${r.status}`);const l=await r.json();let c=[];if(l?.dreamlo?.leaderboard?.entry){const d=l.dreamlo.leaderboard.entry;Array.isArray(d)?c=d.map(Il):c=[Il(d)]}return n.data=c,n.timestamp=s,console.log(`[OnlineLeaderboards] Fetched ${c.length} entries from ${t}`),{entries:c.slice(0,e),totalCount:c.length,error:null}}catch(o){return o.name==="AbortError"?(console.warn("[OnlineLeaderboards] Fetch timed out"),{entries:[],totalCount:0,error:"Connection timed out"}):(console.warn("[OnlineLeaderboards] Fetch error:",o.message),{entries:[],totalCount:0,error:"Could not connect to server"})}}async function L1(e,t){try{const o=await Wh(1e3);if(o.error)return{rank:null,total:0,error:o.error};const n=Kh(e),s=o.entries.findIndex(r=>r.name.toLowerCase()===n.toLowerCase());return s>=0?{rank:s+1,total:o.totalCount,error:null}:{rank:o.entries.filter(r=>r.score>t).length+1,total:o.totalCount+1,error:null}}catch(o){return console.warn("[OnlineLeaderboards] Error getting rank:",o.message),{rank:null,total:0,error:"Could not determine rank"}}}const $h="superSmashTextyLeaderboards",Oa=100,Ha=100;function ua(){try{const e=localStorage.getItem($h),t=e?JSON.parse(e):null;return{daily:t?.daily||{},allTime:t?.allTime||[],personal:t?.personal||{}}}catch(e){return console.warn("[Leaderboards] Failed to load leaderboards:",e),{daily:{},allTime:[],personal:{}}}}function z1(e){try{localStorage.setItem($h,JSON.stringify(e))}catch(t){console.warn("[Leaderboards] Failed to save leaderboards:",t)}}function O1(e){const t=e.floorsReached*1e3,o=(e.enemiesKilled||0)*10,n=(e.bossesKilled||0)*500,s=e.duration||0,a=Math.max(0,3e4-Math.floor(s*50));return t+o+n+a}function H1(e){const t=ua(),o=Mo(),n=e.date||Ko(),s={name:o,score:e.score||0,floor:e.floor||1,character:e.character||"survivor",time:e.time||0,date:n,timestamp:Date.now()};let a={rank:null,isNewBest:!1,dailyRank:null,isNewPersonalBest:!1};e.isDaily&&(t.daily[n]||(t.daily[n]=[]),t.daily[n].push(s),t.daily[n].sort((c,d)=>d.score-c.score),t.daily[n].length>Oa&&(t.daily[n]=t.daily[n].slice(0,Oa)),a.dailyRank=t.daily[n].findIndex(c=>c.timestamp===s.timestamp&&c.name===s.name)+1,(a.dailyRank===0||a.dailyRank>Oa)&&(a.dailyRank=null)),t.allTime.push(s),t.allTime.sort((c,d)=>d.score-c.score),t.allTime.length>Ha&&(t.allTime=t.allTime.slice(0,Ha)),a.rank=t.allTime.findIndex(c=>c.timestamp===s.timestamp&&c.name===s.name)+1,(a.rank===0||a.rank>Ha)&&(a.rank=null);const r=s.character;t.personal[r]||(t.personal[r]={bestScore:0,bestFloor:0,bestTime:1/0});const l=t.personal[r];return s.score>l.bestScore&&(l.bestScore=s.score,a.isNewBest=!0,a.isNewPersonalBest=!0),s.floor>l.bestFloor&&(l.bestFloor=s.floor,a.isNewPersonalBest=!0),s.floor>=3&&s.time<l.bestTime&&(l.bestTime=s.time,a.isNewPersonalBest=!0),z1(t),console.log("[Leaderboards] Score submitted:",s,"Result:",a),sc(s).catch(c=>{console.warn("[Leaderboards] Online submission failed:",c)}),a}function U1(e=null,t=10){const o=ua(),n=e||Ko();return(o.daily[n]||[]).slice(0,t)}function N1(e=10){return ua().allTime.slice(0,e)}function _1(){return ua().personal}function Pl(e){if(e===1/0||e===void 0||e===null)return"--:--";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t}:${o.toString().padStart(2,"0")}`}function xr(e){return(e||0).toLocaleString()}function Bl(e){if(e=Math.max(0,Math.min(1,e)),e<.5){const t=e*2;return[255,Math.round(200*t),50]}else{const t=(e-.5)*2;return[Math.round(255*(1-t)),200+Math.round(55*t),50+Math.round(100*t)]}}function Ua(e,t={}){const{label:o="",value:n=0,maxValue:s=100,x:a=0,y:r=0,width:l=80,color:c=y.PRIMARY,usePercentageColor:d=!1}=t,i=[],h=6,u=n/s,p=d?Bl(u):c,g=e.add([e.text(o,{size:Z.TINY}),e.pos(a,r),e.anchor("topleft"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);i.push(g);const M=e.add([e.rect(l,h),e.pos(a,r+14),e.anchor("topleft"),e.color(...y.BG_DARK),e.outline(1,e.rgb(50,50,60)),e.fixed(),e.z(b.UI_ELEMENTS)]);i.push(M);const m=Math.max(0,(l-2)*u),T=e.add([e.rect(m,h-2),e.pos(a+1,r+15),e.anchor("topleft"),e.color(...p),e.fixed(),e.z(b.UI_ELEMENTS+1)]);i.push(T);const P=e.add([e.text(`${n}`,{size:Z.MICRO}),e.pos(a+l+4,r+10),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);return i.push(P),{elements:i,updateValue:O=>{const w=Math.max(0,Math.min(s,O)),A=w/s;if(T.width=Math.max(0,(l-2)*A),P.text=`${w}`,d){const S=Bl(A);T.color=e.rgb(...S)}},destroy:()=>{i.forEach(O=>{O.exists()&&e.destroy(O)})}}}function X1(e){return ms[e]?.name?ms[e].name:jn[e]?.name?jn[e].name:tn[e]?.name?tn[e].name:e}function F1(e){return ms[e]?.char||jn[e]?.char||tn[e]?.char||"E"}function Y1(e){return ms[e]?.color||jn[e]?.color||tn[e]?.color||[255,100,100]}const Ll=["$","","","",""],zl=[{id:"slayer",title:"Slayer",icon:"",desc:"Most enemy kills",check:e=>e.kills||0,color:[255,100,100]},{id:"collector",title:"Hoarder",icon:"",desc:"Most credits collected",check:e=>e.creditsPickedUp||0,color:[255,215,0]},{id:"bossBuster",title:"Boss Buster",icon:"",desc:"Most bosses defeated",check:e=>e.bossesKilled||0,color:[255,150,50]}];function q1(e){e.scene("gameOver",t=>{Ch(),rx();const o=t?.runStats||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{}},n=t?.currencyEarned||0;$n(),Tg();const s=la(),a=t?.partyStats||[],r=t?.isDailyRun||!1,l=t?.dailyCharacter||null,c=t?.dailyDate||Ko(),d=o.startTime?(Date.now()-o.startTime)/1e3:0,i=O1({floorsReached:o.floorsReached||1,enemiesKilled:o.enemiesKilled||0,bossesKilled:o.bossesKilled||0,duration:d}),h=l||mn(),u=H1({score:i,floor:o.floorsReached||1,character:h,time:d,isDaily:r,date:c}),p=Mo(),g=le(),M={name:p,score:i,floor:o.floorsReached||1,character:h,time:d,date:c};sc(M,"allTime"),r&&B1(M),r&&E1({score:i,floor:o.floorsReached||1,character:h,duration:d});const m=a.length>0?a.reduce((ce,de)=>ce+(de.creditsPickedUp||0),0):n,T=Zx(),P=Yg({floorsReached:o.floorsReached||1,enemiesKilled:o.enemiesKilled||0,bossesKilled:o.bossesKilled||0,isDailyRun:r}),N=Fg(P).levelsGained>0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(20,15,25),e.opacity(.98),e.fixed(),e.z(b.OVERLAY)]);const O=25;e.add([e.text("BROADCAST TERMINATED",{size:28}),e.pos(e.width()/2,O),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.MODAL)]),e.add([e.text(`SCORE: ${xr(i)}`,{size:22}),e.pos(e.width()/2,O+32),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL)]),e.add([e.text(`Floor ${o.floorsReached} | ${o.roomsCleared} Rooms | ${o.enemiesKilled} Kills | ${Math.floor(d)}s`,{size:12}),e.pos(e.width()/2,O+54),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL)]);const w=O+75;let A="";r&&u.dailyRank?(A=`Daily #${u.dailyRank}`,u.dailyRank===1&&(A+=" NEW RECORD!")):u.rank&&(A=`All-Time #${u.rank}`,u.isNewBest&&(A+=" PERSONAL BEST!")),A&&e.add([e.text(A,{size:14}),e.pos(e.width()/2-120,w),e.anchor("center"),e.color(...u.isNewBest?y.SUCCESS:y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL)]);const S=e.add([e.text("Global: ...",{size:14}),e.pos(e.width()/2+120,w),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL)]);L1(p,i).then(ce=>{S.exists()&&(ce.error?S.text="Global: offline":ce.rank?(S.text=`Global #${ce.rank} of ${ce.total}`,S.color=e.rgb(...y.GOLD)):S.text="Global: unranked")});const I=w+30,E=Math.max(a.length,1),L=a.length>0?a:[{name:p,characterData:{char:"@",color:[255,255,255]},kills:o.enemiesKilled,creditsPickedUp:n,bossesKilled:o.bossesKilled,achievements:T}],C={};if(L.length===1){const ce=L[0];zl.forEach(de=>{de.check(ce)>0&&(C[ce.name]||(C[ce.name]=[]),C[ce.name].push(de))})}else zl.forEach(ce=>{let de=null,Ee=0;L.forEach(ke=>{const lt=ce.check(ke);lt>Ee&&(Ee=lt,de=ke)}),de&&Ee>0&&(C[de.name]||(C[de.name]=[]),C[de.name].push(ce))});const U=Math.min(e.width()-210-30,500),_=20,H=(U-80)/E,R=28,Y=80,V=R*7+10;e.add([e.rect(U,V),e.pos(_,I),e.color(30,25,35),e.outline(2,e.rgb(60,50,80)),e.fixed(),e.z(b.MODAL)]);let Q=I+8;L.forEach((ce,de)=>{const Ee=_+Y+de*H+H/2,ke=ce.characterData?.char||"@",lt=ce.characterData?.color||[255,255,255];e.add([e.text(ke,{size:20}),e.pos(Ee,Q+3),e.anchor("center"),e.color(...lt),e.fixed(),e.z(b.MODAL+1)]);const We=E<=2?16:E===3?12:10,je=(ce.name||`P${de+1}`).substring(0,We);e.add([e.text(je,{size:11}),e.pos(Ee,Q+20),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL+1)])}),Q+=R+8,[{label:"Kills",getValue:ce=>ce.kills||0,color:y.DANGER},{label:"Credits",getValue:ce=>ce.creditsPickedUp||0,color:y.GOLD},{label:"Bosses",getValue:ce=>ce.bossesKilled||0,color:[255,150,50]}].forEach(ce=>{e.add([e.text(ce.label,{size:12}),e.pos(_+10,Q),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]),L.forEach((de,Ee)=>{const ke=_+Y+Ee*H+H/2,lt=ce.getValue(de);e.add([e.text(String(lt),{size:14}),e.pos(ke,Q),e.anchor("center"),e.color(...ce.color),e.fixed(),e.z(b.MODAL+1)])}),Q+=R}),e.add([e.text("Awards",{size:12}),e.pos(_+10,Q),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]);let se=null;function ie(ce,de){se&&se.forEach(It=>{It.exists()&&e.destroy(It)});const Ee=220,ke=100,lt=e.width()/2,We=e.height()/2,je=[];je.push(e.add([e.rect(Ee,ke),e.pos(lt,We),e.anchor("center"),e.color(30,25,40),e.outline(3,e.rgb(...ce.color)),e.fixed(),e.z(b.MODAL+100)])),je.push(e.add([e.text(ce.icon,{size:28}),e.pos(lt,We-28),e.anchor("center"),e.color(...ce.color),e.fixed(),e.z(b.MODAL+101)])),je.push(e.add([e.text(ce.title,{size:16}),e.pos(lt,We),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.MODAL+101)])),je.push(e.add([e.text(ce.desc,{size:11}),e.pos(lt,We+18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+101)]));const ho=E>1?`Earned by ${de.name}`:"Earned this run";je.push(e.add([e.text(ho,{size:10}),e.pos(lt,We+34),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(b.MODAL+101)])),se=je,e.wait(.1,()=>{const It=e.onClick(()=>{It.cancel(),se&&(se.forEach(Zt=>{Zt.exists()&&e.destroy(Zt)}),se=null)})})}L.forEach((ce,de)=>{const Ee=_+Y+de*H+H/2,ke=C[ce.name]||[];if(ke.length>0){const je=ke.length*22+(ke.length-1)*4,ho=Ee-je/2+22/2;ke.forEach((It,Zt)=>{const Io=ho+Zt*26,bo=e.add([e.rect(22,22),e.pos(Io,Q),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...It.color)),e.area(),e.fixed(),e.z(b.MODAL+1)]);e.add([e.text(It.icon,{size:12}),e.pos(Io,Q),e.anchor("center"),e.color(255,220,100),e.fixed(),e.z(b.MODAL+2)]),bo.onClick(()=>{Ze(),ie(It,ce)}),bo.cursor="pointer"})}else e.add([e.text("-",{size:14}),e.pos(Ee,Q),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)])}),Q+=R,e.add([e.text("Unlocks",{size:12}),e.pos(_+10,Q),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]),L.forEach((ce,de)=>{const Ee=_+Y+de*H+H/2,ke=ce.achievements||(de===0?T:[]);if(ke.length>0){const lt=Math.min(ke.length,3),We=22,je=4,ho=lt*We+(lt-1)*je,It=Ee-ho/2+We/2;if(ke.slice(0,lt).forEach((Zt,Io)=>{const bo=an[Zt];if(!bo)return;const fo=It+Io*(We+je),Wo=Oo[bo.difficulty]||Oo.normal,Nt=e.add([e.rect(We,We),e.pos(fo,Q),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...Wo)),e.area(),e.fixed(),e.z(b.MODAL+1)]);e.add([e.text(bo.icon,{size:12}),e.pos(fo,Q),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.MODAL+2)]),Nt.onClick(()=>{Ze(),Fh(e,bo)}),Nt.cursor="pointer"}),ke.length>lt){const Zt=ke.length-lt,Io=It+lt*(We+je);e.add([e.text(`+${Zt}`,{size:10}),e.pos(Io,Q),e.anchor("left"),e.color(200,180,100),e.fixed(),e.z(b.MODAL+1)])}}else e.add([e.text("-",{size:14}),e.pos(Ee,Q),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)])});const ae=I+V+15,ge=E===1?240:E===2?180:E===3?140:110,Se=10,ve=(U-20-(E-1)*Se)/E,_e=Math.min(ge,ve),nt=E===1?100:80,Me=E*_e+(E-1)*Se,Tt=_+(U-Me)/2+_e/2,ee=[];L.forEach((ce,de)=>{const Ee=Tt+de*(_e+Se),ke=ce.creditsPickedUp||0;e.add([e.rect(_e-10,nt),e.pos(Ee,ae+nt/2),e.anchor("center"),e.outline(3,e.rgb(...y.TEXT_DISABLED)),e.color(0,0,0),e.opacity(.5),e.fixed(),e.z(b.MODAL)]);const lt=E===1?20:16,We=e.add([e.text(`0 ${s}`,{size:lt}),e.pos(Ee,ae+nt+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL+10)]);ee.push({x:Ee,y:ae,width:_e-10,height:nt,credits:ke,label:We,particles:[],spawnedCount:0,displayedCount:0})});const we=E===1?50:35,ye=.06,Pe=280;let qe=0;const Ce=.5;e.onUpdate(()=>{qe+=e.dt(),!(qe<Ce)&&ee.forEach((ce,de)=>{if(ce.credits<=0)return;const Ee=Math.min(ce.credits,we),ke=ce.credits/Ee,lt=qe-Ce-de*.12,We=Math.floor(lt/ye);for(;ce.spawnedCount<Ee&&ce.spawnedCount<We;){const je=ce.x+(Math.random()-.5)*(ce.width-16),ho=ce.y-30-Math.random()*25,It=Ll[Math.floor(Math.random()*Ll.length)],Zt=e.add([e.text(It,{size:14}),e.pos(je,ho),e.anchor("center"),e.color(255,215,0),e.opacity(1),e.fixed(),e.z(b.MODAL+5),"currencyParticle",{velocity:Pe+Math.random()*60,landed:!1,value:ke}]);ce.particles.push(Zt),ce.spawnedCount++}ce.particles.forEach(je=>{if(!je.exists()||je.landed)return;je.pos.y+=je.velocity*e.dt();const ho=ce.y+ce.height-6,It=ce.particles.filter(Io=>Io.landed).length*1.5,Zt=ho-It;je.pos.y>=Zt&&(je.pos.y=Zt,je.landed=!0,ce.displayedCount+=je.value,ce.label.text=`${Math.floor(ce.displayedCount)} ${s}`,je.opacity=.85)})})});const rt=e.width()-110,Je=I,it=180,gt=V+nt+30;e.add([e.rect(it,gt),e.pos(rt-it/2,Je),e.color(25,20,30),e.outline(2,e.rgb(50,40,60)),e.fixed(),e.z(b.MODAL)]),e.add([e.text("STAFF",{size:14}),e.pos(rt,Je+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text("TERMINATED",{size:14}),e.pos(rt,Je+26),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL+1)]);const Te=o.killsByType||{},Fe=Object.entries(Te).filter(([ce,de])=>de>0).sort((ce,de)=>de[1]-ce[1]);let Be=Je+48;const Re=20,Ke=Math.floor((gt-60)/Re);if(Fe.length===0)e.add([e.text("No staff",{size:12}),e.pos(rt,Be+10),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text("harmed",{size:12}),e.pos(rt,Be+24),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)]);else{const ce=Math.min(Fe.length,Ke);for(let de=0;de<ce;de++){const[Ee,ke]=Fe[de],lt=F1(Ee),We=Y1(Ee);e.add([e.text(lt,{size:14}),e.pos(rt-70,Be),e.anchor("center"),e.color(...We),e.fixed(),e.z(b.MODAL+1)]);const je=X1(Ee),ho=je.length>14?je.substring(0,12)+"..":je;e.add([e.text(ho,{size:10}),e.pos(rt-50,Be),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text(`x${ke}`,{size:11}),e.pos(rt+70,Be),e.anchor("right"),e.color(...y.DANGER),e.fixed(),e.z(b.MODAL+1)]),Be+=Re}if(Fe.length>ce){const de=Fe.slice(ce).reduce((Ee,[ke,lt])=>Ee+lt,0);e.add([e.text(`+${de} more`,{size:10}),e.pos(rt,Be),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)])}}const dt=e.height()-90;e.add([e.text(`+${m} ${s}`,{size:16}),e.pos(e.width()/2-100,dt),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL)]);const ft=N?y.SUCCESS:[150,200,255],ht=N?`+${P} XP (LEVEL UP!)`:`+${P} XP`;e.add([e.text(ht,{size:16}),e.pos(e.width()/2+100,dt),e.anchor("center"),e.color(...ft),e.fixed(),e.z(b.MODAL)]);const ut=ri(),At=Ur(),ct=da(),Bt=sh();e.add([e.text(`Level ${ut}`,{size:12}),e.pos(e.width()/2,dt+18),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL)]);const Dt=200,xt=8,Rt=e.width()/2,Ye=dt+32;e.add([e.rect(Dt,xt),e.pos(Rt,Ye),e.anchor("center"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(b.MODAL)]);const Ct=Math.max(2,Dt*At);e.add([e.rect(Ct,xt-2),e.pos(Rt-Dt/2+Ct/2+1,Ye),e.anchor("center"),e.color(100,180,255),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text(`${ct} / ${Bt} XP`,{size:10}),e.pos(e.width()/2,Ye+12),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL)]);const me=pe(),st=e.height()-30,{MD:re,SM:Le}=zn.BUTTON,Qe=20,et=!g||me,B=g&&!me?"Waiting...":"PLAY AGAIN",K=re.width,te=re.height,he=Le.width,tt=Le.height,ot=K+Qe+he,Lt=e.width()/2-ot/2,at=e.add([e.rect(K,te),e.pos(Lt+K/2,st),e.anchor("center"),e.color(...et?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(...et?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(b.MODAL)]),vt=e.add([e.text(B,{size:Z.H2}),e.pos(Lt+K/2,st),e.anchor("center"),e.color(...et?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(b.MODAL+1)]),xe=e.add([e.rect(he,tt),e.pos(Lt+K+Qe+he/2,st),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.scale(1),e.z(b.MODAL)]),be=e.add([e.text("MENU",{size:Z.SMALL}),e.pos(Lt+K+Qe+he/2,st),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.scale(1),e.z(b.MODAL+1)]);et&&(at.onHoverUpdate(()=>{at.color=e.rgb(...y.SUCCESS_HOVER||[80,180,80]),at.scale=e.vec2(1.02,1.02),vt.scale=e.vec2(1.02,1.02)}),at.onHoverEnd(()=>{at.color=e.rgb(...y.SUCCESS),at.scale=e.vec2(1,1),vt.scale=e.vec2(1,1)})),xe.onHoverUpdate(()=>{xe.color=e.rgb(...y.NEUTRAL_HOVER),xe.scale=e.vec2(1.02,1.02),be.scale=e.vec2(1.02,1.02)}),xe.onHoverEnd(()=>{xe.color=e.rgb(...y.NEUTRAL),xe.scale=e.vec2(1,1),be.scale=e.vec2(1,1)}),et&&at.onClick(()=>{Ut(),g&&me&&Ge("game_restart",{}),e.go("game",{resetState:!0})}),xe.onClick(()=>{Ze(),g&&!me&&Ot("game_restart"),e.go("menu")}),g&&!me&&He("game_restart",()=>{Ut(),Ot("game_restart"),e.go("game",{resetState:!0})}),e.onKeyPress("space",()=>{g&&!me||(Ut(),g&&me&&Ge("game_restart",{}),e.go("game",{resetState:!0}))}),e.onKeyPress("escape",()=>{Yh()||(Ze(),g&&!me&&Ot("game_restart"),e.go("menu"))})})}function G1(e){e.scene("shop",()=>{const t=E=>(E.preventDefault(),!1);document.addEventListener("contextmenu",t),e.onSceneLeave(()=>{document.removeEventListener("contextmenu",t)});const o=$n(),n=la();let s="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),di(e,"MERCH",e.width()/2,35,8);const a=qr(e,o),r=80,l=95,c=85,d=30,i=[{key:"permanentUpgrades",label:"Upgrades"},{key:"boosters",label:"Boosters"},{key:"cosmetics",label:"Cosmetics"},{key:"weapons",label:"Weapons"},{key:"characters",label:"Chars"}],h=(i.length-1)*l,u=e.width()/2-h/2,p=[];i.forEach((E,L)=>{const C=u+L*l,F=s===E.key,U=e.add([e.rect(c,d),e.pos(C,r),e.anchor("center"),e.color(...F?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),_=e.add([e.text(E.label,{size:Z.BODY}),e.pos(C,r),e.anchor("center"),e.color(...F?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(b.UI_TEXT)]);U.onClick(()=>{Ze(),s=E.key,m=0,O()}),p.push({bg:U,label:_,category:E.key})});const g=130;e.height()-g-100;let M=[],m=0;const T=6;let P=[],f=!1,N=!1;function O(){const E=$n();a.updateCurrency(E),p.forEach(ie=>{const ae=s===ie.category;ie.bg.color=e.rgb(ae?100:50,ae?100:50,ae?150:80),ie.label.color=e.rgb(ae?255:150,ae?255:150,ae?255:150)}),S(),M.forEach(ie=>{ie.exists()&&e.destroy(ie)}),M=[],P.forEach(ie=>{ie.exists()&&e.destroy(ie)}),P=[];const L=Sg(s),F=Object.keys(L).filter(ie=>{const ae=L[ie];return s==="permanentUpgrades"||s==="boosters"?!0:!ae.unlockedByDefault});if(F.length===0){const ie=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,g+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);M.push(ie);return}const U=Math.ceil(F.length/T);m>=U&&(m=Math.max(0,U-1));const _=m*T,H=F.slice(_,_+T),R=340,Y=105,V=Y+8,Q=g+5,fe=3,se=ie=>{if(!ie)return null;const ae=ie.toLowerCase();return ae.includes("hp")||ae.includes("health")?{icon:"",color:[255,100,100]}:ae.includes("damage")||ae.includes("dmg")?{icon:"",color:[255,200,100]}:ae.includes("speed")?{icon:"",color:[100,200,255]}:ae.includes("crit")?{icon:"",color:[255,255,100]}:ae.includes("xp")||ae.includes("pickup")?{icon:"",color:[100,255,200]}:ae.includes("defense")||ae.includes("reduction")?{icon:"",color:[150,150,255]}:ae.includes("credit")||ae.includes("silver")?{icon:"$",color:[200,150,50]}:ae.includes("level")?{icon:"",color:[200,100,255]}:ae.includes("invuln")||ae.includes("immunity")?{icon:"",color:[100,255,255]}:ae.includes("trail")||ae.includes("glow")||ae.includes("effect")?{icon:"",color:[200,150,255]}:null};if(H.forEach((ie,ae)=>{const ge=L[ie],Se=Math.floor(ae/fe),Ie=ae%fe,ve=45+Se*(R+15),_e=Q+Ie*V,nt=ge.requiredAchievement||(ge.unlockRequirement?.type==="achievement"?ge.unlockRequirement.value:null),Me=nt?!Hr(nt):!1,Tt=nt?jd(nt):null,ee=s==="characters"&&Yo("characters",ie),we=s==="weapons"&&Yo("weapons",ie),ye=s==="permanentUpgrades"&&Pt(ie)>=(ge.maxLevel||1),Pe=s==="cosmetics"&&ge.requiredAchievement&&!Me,qe=s==="cosmetics"&&(Yo("cosmetics",ie)||ge.unlockedByDefault||Pe),Ce=s==="cosmetics"&&_g(ge.category)===ie;let rt,Je;Me?(rt=e.rgb(60,50,50),Je=[30,25,25]):Ce?(rt=e.rgb(100,200,255),Je=[35,45,55]):ye||ee||we||qe?(rt=e.rgb(80,150,80),Je=[35,45,35]):(rt=e.rgb(80,80,120),Je=[35,35,45]);const it=e.add([e.rect(R,Y),e.pos(ve,_e),e.anchor("topleft"),e.color(...Je),e.outline(2,rt),e.area(),e.fixed(),e.z(1e3)]);let gt=ve+10;if((s==="characters"||s==="weapons")&&ge.char){const re=e.add([e.rect(40,40),e.pos(ve+8,_e+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),Le=e.add([e.text(ge.char,{size:28}),e.pos(ve+28,_e+28),e.anchor("center"),e.color(...Me?[60,60,60]:ge.color||[200,200,200]),e.fixed(),e.z(1002)]);M.push(re,Le),gt=ve+55}if(s==="cosmetics"){const re=ge.category==="trail"?"~":ge.category==="death"?"":"";let Le;ge.color==="rainbow"?Le=[255,100,200]:Array.isArray(ge.color)?Le=ge.color:Le=[150,150,200];const Qe=Me?[60,60,70]:Le,et=Me?[50,50,60]:Le,B=e.add([e.rect(36,36),e.pos(ve+8,_e+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(...et)),e.fixed(),e.z(1001)]),K=e.add([e.text(re,{size:22}),e.pos(ve+26,_e+26),e.anchor("center"),e.color(...Qe),e.fixed(),e.z(1002)]);M.push(B,K),gt=ve+50}const Te=e.add([e.text(ge.name,{size:16}),e.pos(gt,_e+10),e.anchor("topleft"),e.color(Me?100:255,Me?100:255,Me?100:255),e.fixed(),e.z(1001)]),Fe=se(ge.description);if(Fe&&!Me){const re=e.add([e.text(Fe.icon,{size:18}),e.pos(ve+R-12,_e+12),e.anchor("topright"),e.color(...Fe.color),e.fixed(),e.z(1001)]);M.push(re)}if(Me){const re=e.add([e.text("(X)",{size:14}),e.pos(ve+R-10,_e+10),e.anchor("topright"),e.color(150,80,80),e.fixed(),e.z(1002)]);M.push(re)}const Be=R-gt+ve-90,Re=_e+30;let Ke=ge.description,dt=null;if(Me&&Tt){const re=vs();re&&(dt=Gi(Tt.id,re)),dt?Ke=`${Tt.name} (${dt.current}/${dt.target})`:Ke=`Requires: ${Tt.name}`}const ft=e.add([e.text(Ke,{size:12,width:Be}),e.pos(gt,Re),e.anchor("topleft"),e.color(Me?140:180,Me?110:180,Me?110:180),e.fixed(),e.z(1001)]);if(Me&&dt&&dt.target>1){const re=Math.min(Be,120),Le=4,Qe=gt,et=Re+18,B=e.add([e.rect(re,Le),e.pos(Qe,et),e.anchor("topleft"),e.color(40,35,45),e.fixed(),e.z(1001)]);M.push(B);const K=Math.max(0,dt.progress*re);if(K>0){const te=e.add([e.rect(K,Le),e.pos(Qe,et),e.anchor("topleft"),e.color(100,80,130),e.fixed(),e.z(1002)]);M.push(te)}}const ht=_e+Y-28,ut=ve+R-85,At=75,ct=24;function Bt(re){const Le=[50,65,90,115,160];return re<Le.length?Le[re]:160+(re-4)*50}let Dt="",xt=!1,Rt=ge.cost,Ye=!1,Ct=0,me=1;if(s==="permanentUpgrades"){const re=Pt(ie),Le=ge.maxLevel||1;Ct=re,me=Le,Ye=!0,re>=Le?Dt="MAXED":(Rt=Bt(re),xt=o>=Rt)}else if(s==="boosters"){const re=Pg();Dt=re>0?`Ready (${re})`:"Consumable",xt=o>=Rt}else s==="cosmetics"?(ge.category,Ce?Dt="EQUIPPED":qe?Dt=Pe?"UNLOCKED":"OWNED":Me||(xt=o>=Rt)):s==="characters"?ee||(xt=o>=Rt):s==="weapons"&&(we||(xt=o>=Rt));if(Ye){const Qe=gt,et=ht+8,B=e.add([e.rect(100,8),e.pos(Qe,et),e.anchor("topleft"),e.color(30,30,40),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),K=Math.max(0,Ct/me*98);if(K>0){const he=e.add([e.rect(K,6),e.pos(Qe+1,et+1),e.anchor("topleft"),e.color(Ct>=me?100:80,Ct>=me?200:150,Ct>=me?100:80),e.fixed(),e.z(1002)]);M.push(he)}const te=e.add([e.text(`${Ct}/${me}`,{size:10}),e.pos(Qe+100+8,et+4),e.anchor("left"),e.color(Ct>=me?100:150,Ct>=me?255:200,Ct>=me?100:150),e.fixed(),e.z(1001)]);M.push(B,te)}let st=null;if(Dt&&!Ye){let re;switch(Dt){case"EQUIPPED":re=[100,200,255];break;case"UNLOCKED":re=[180,140,255];break;case"MAXED":case"OWNED":re=[100,200,100];break;default:re=[180,180,180]}st=e.add([e.text(Dt,{size:11}),e.pos(gt,ht+7),e.anchor("topleft"),e.color(...re),e.fixed(),e.z(1001)])}if(Me&&Tt){const re=e.add([e.rect(At,ct),e.pos(ut,ht),e.anchor("topleft"),e.color(50,40,60),e.outline(1,e.rgb(100,80,130)),e.area({width:At,height:ct}),e.fixed(),e.z(1010)]),Le=e.add([e.text("VIEW",{size:11}),e.pos(ut+At/2,ht+ct/2),e.anchor("center"),e.color(160,130,200),e.fixed(),e.z(1011)]);re.onHover(()=>{re.color=e.rgb(70,55,85),re.outline.color=e.rgb(140,110,180),Le.color=e.rgb(200,170,255)}),re.onHoverEnd(()=>{re.color=e.rgb(50,40,60),re.outline.color=e.rgb(100,80,130),Le.color=e.rgb(160,130,200)});const Qe=Tt;re.onClick(()=>{Ze(),Fh(e,Qe)}),re.cursor="pointer",M.push(re,Le)}else if(Me){const re=e.add([e.text("LOCKED",{size:11}),e.pos(ut+At/2,ht+ct/2),e.anchor("center"),e.color(100,80,80),e.fixed(),e.z(1001)]);M.push(re)}else if(xt||s==="permanentUpgrades"&&Ct<me){const re=e.add([e.rect(At,ct),e.pos(ut,ht),e.anchor("topleft"),e.color(xt?40:30,xt?120:40,xt?40:30),e.outline(1,e.rgb(xt?80:50,xt?180:60,xt?80:50)),e.area(),e.fixed(),e.z(1001)]),Le=e.add([e.text(`$${Rt}`,{size:12}),e.pos(ut+At/2,ht+ct/2),e.anchor("center"),e.color(xt?255:120,xt?255:120,xt?255:120),e.fixed(),e.z(1002)]);if(s==="permanentUpgrades"&&Ct>0){let Qe=null;Qe=e.onMouseRelease("right",()=>{const et=e.mousePos();if(et.x>=ut&&et.x<=ut+At&&et.y>=ht&&et.y<=ht+ct){if(f)return;f=!0;const B=Lg(ie);if(B&&B.success){vi();const K=e.add([e.text(`Refunded $${B.refundAmount}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{K.exists()&&e.destroy(K)}),O(),e.wait(.2,()=>{f=!1})}else f=!1}}),re.onDestroy(()=>{Qe&&Qe.cancel()})}xt&&re.onClick(()=>{if(f)return;f=!0;let Qe;if(s==="permanentUpgrades"?Qe=Rg(ie,Rt,ge.maxLevel):s==="boosters"?Qe=Ig(ie,Rt):Qe=Cg(s,ie,Rt),s==="permanentUpgrades"||s==="boosters")if(Qe&&Qe.success){vi();const et=s==="boosters"?"Booster Ready!":"Purchased!",B=e.add([e.text(et,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{B.exists()&&e.destroy(B)}),O(),e.wait(.2,()=>{f=!1})}else if(Qe&&Qe.reason==="insufficientCurrency"){Pa();const et=e.add([e.text(`Not enough ${n}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{et.exists()&&e.destroy(et)}),f=!1}else f=!1;else if(Qe){vi();const et=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{et.exists()&&e.destroy(et)}),O(),e.wait(.2,()=>{f=!1})}else{Pa();const et=e.add([e.text(`Not enough ${n}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{et.exists()&&e.destroy(et)}),f=!1}}),M.push(re,Le)}else if(s==="cosmetics"&&qe&&!Ce){const re=e.add([e.rect(At,ct),e.pos(ut,ht),e.anchor("topleft"),e.color(40,80,120),e.outline(1,e.rgb(80,140,200)),e.area(),e.fixed(),e.z(1001)]),Le=e.add([e.text("EQUIP",{size:11}),e.pos(ut+At/2,ht+ct/2),e.anchor("center"),e.color(200,230,255),e.fixed(),e.z(1002)]);re.onHover(()=>{re.color=e.rgb(50,100,150),re.outline.color=e.rgb(100,170,240),Le.color=e.rgb(230,245,255)}),re.onHoverEnd(()=>{re.color=e.rgb(40,80,120),re.outline.color=e.rgb(80,140,200),Le.color=e.rgb(200,230,255)}),re.onClick(()=>{f||(f=!0,Ze(),Nc(ge.category,ie),f=!1,O())}),re.cursor="pointer",M.push(re,Le)}else if(s==="cosmetics"&&Ce&&!ie.includes("None")){const re=e.add([e.rect(At,ct),e.pos(ut,ht),e.anchor("topleft"),e.color(80,50,50),e.outline(1,e.rgb(160,100,100)),e.area(),e.fixed(),e.z(1001)]),Le=e.add([e.text("UNEQUIP",{size:11}),e.pos(ut+At/2,ht+ct/2),e.anchor("center"),e.color(255,180,180),e.fixed(),e.z(1002)]);re.onHover(()=>{re.color=e.rgb(100,60,60),re.outline.color=e.rgb(200,120,120),Le.color=e.rgb(255,210,210)}),re.onHoverEnd(()=>{re.color=e.rgb(80,50,50),re.outline.color=e.rgb(160,100,100),Le.color=e.rgb(255,180,180)}),re.onClick(()=>{if(f)return;f=!0,Ze();const Qe=ge.category+"None";Nc(ge.category,Qe),f=!1,O()}),re.cursor="pointer",M.push(re,Le)}M.push(it,Te,ft),st&&M.push(st)}),U>1){const ie=e.height()-115,ae=e.width()/2,ge=20,Se=ae-(U-1)*ge/2,Ie=ae+(U-1)*ge/2,ve=35,_e=Se-ve,nt=Ie+ve,Me=e.add([e.rect(30,30),e.pos(_e,ie),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+10)]),Tt=e.add([e.text("<",{size:24}),e.pos(_e,ie),e.anchor("center"),e.color(m>0?255:80,m>0?255:80,m>0?255:80),e.fixed(),e.z(b.UI_TEXT+10)]);m>0&&(Me.onClick(()=>{N||(N=!0,e.wait(0,()=>{N=!1}),Ze(),m--,O())}),Me.cursor="pointer"),P.push(Me,Tt);const ee=e.add([e.rect(30,30),e.pos(nt,ie),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+10)]),we=e.add([e.text(">",{size:24}),e.pos(nt,ie),e.anchor("center"),e.color(m<U-1?255:80,m<U-1?255:80,m<U-1?255:80),e.fixed(),e.z(b.UI_TEXT+10)]);m<U-1&&(ee.onClick(()=>{N||(N=!0,e.wait(0,()=>{N=!1}),Ze(),m++,O())}),ee.cursor="pointer"),P.push(ee,we);for(let ye=0;ye<U;ye++){const Pe=ye===m,qe=Se+ye*ge,Ce=e.add([e.rect(16,16),e.pos(qe,ie),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),rt=e.add([e.text(Pe?"":"",{size:14}),e.pos(qe,ie),e.anchor("center"),e.color(Pe?255:120,Pe?255:120,Pe?255:120),e.fixed(),e.z(b.UI_TEXT)]),Je=ye;Ce.onClick(()=>{N||(N=!0,e.wait(0,()=>{N=!1}),Je!==m&&(Ze(),m=Je,O()))}),Ce.cursor="pointer",P.push(Ce,rt)}}}let w=null,A=null;function S(){const E=oh();s==="permanentUpgrades"&&E>0?w?(A.text=`REFUND: $${E}`,w.hidden=!1,A.hidden=!1):(w=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),A=e.add([e.text(`REFUND: $${E}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(b.UI_TEXT)]),w.onClick(()=>{zg().success?(vi(),O()):Pa()})):w&&(w.hidden=!0,A&&(A.hidden=!0))}O();const I=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text(ni("Back"),{size:Z.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),I.onClick(()=>{Ze(),e.go("menu")}),e.onKeyPress("escape",()=>{Yh()||e.go("menu")})})}function Ol(e,t){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(b.OVERLAY)]),a=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(b.OVERLAY+1)]),r=[];function l(){r.forEach(M=>{M&&M.exists&&M.exists()&&e.destroy(M)})}const c=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),d=e.add([e.text("Cancel",{size:Z.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+3)]);c.onClick(()=>{l()}),r.push(o,a,c,d);const i=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),h=e.add([e.text("Reset",{size:Z.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(b.OVERLAY+3)]);i.onClick(()=>{l(),t()}),r.push(i,h);const u=e.add([e.text("Reset to Defaults?",{size:Z.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]);r.push(u);const p=e.add([e.text("This will reset all settings to their default values.",{size:Z.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.OVERLAY+2)]);r.push(p);const g=e.onKeyPress("escape",()=>{l(),g.cancel()})}function K1(e){e.scene("settings",t=>{const o=t?.fromGame||!1;let n=hr(),s="audio";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),di(e,"OPTIONS",e.width()/2,35,8);const a=80,r=100,l=90,c=30,d=[{key:"audio",label:"Audio"},{key:"video",label:"Video"},{key:"gameplay",label:"Gameplay"},{key:"controls",label:"Controls"},{key:"access",label:"Access."},{key:"data",label:"Data"}],i=(d.length-1)*r,h=e.width()/2-i/2,u=[];d.forEach((S,I)=>{const E=h+I*r,L=s===S.key,C=e.add([e.rect(l,c),e.pos(E,a),e.anchor("center"),e.color(L?100:50,L?100:50,L?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),F=e.add([e.text(S.label,{size:16}),e.pos(E,a),e.anchor("center"),e.color(L?255:150,L?255:150,L?255:150),e.fixed(),e.z(b.UI_TEXT)]);C.onClick(()=>{s=S.key,T()}),u.push({bg:C,label:F,key:S.key})});const p=120,g=50,M=150;let m=[];function T(){u.forEach(E=>{const L=s===E.key;E.bg.color=e.rgb(L?100:50,L?100:50,L?150:80),E.label.color=e.rgb(L?255:150,L?255:150,L?255:150)}),m.forEach(E=>{E.exists()&&e.destroy(E)}),m=[],n=hr();const S=p+20;let I=S;if(s==="audio")I=P(e,"Master Volume",n.audio?.masterVolume??1,I,E=>{Gt("audio","masterVolume",E),vh(E)}),I=P(e,"Music Volume",n.audio?.musicVolume??.35,I,E=>{Gt("audio","musicVolume",E),Dh(E)}),I=P(e,"SFX Volume",n.audio?.sfxVolume??1,I,E=>{Gt("audio","sfxVolume",E),Eh(E),Ze()}),I=f(e,"UI Sounds",n.audio?.uiSounds!==!1,I,E=>{Gt("audio","uiSounds",E),Ah(E)}),I=f(e,"Combat Sounds",n.audio?.combatSounds!==!1,I,E=>{Gt("audio","combatSounds",E),Sh(E)});else if(s==="video")I=f(e,"Show Particles",n.visual?.showParticles!==!1,I,E=>{Gt("visual","showParticles",E)}),I=f(e,"Screen Shake",n.visual?.showScreenShake!==!1,I,E=>{Gt("visual","showScreenShake",E)}),I=f(e,"Hit Freeze",n.visual?.showHitFreeze!==!1,I,E=>{Gt("visual","showHitFreeze",E)}),I=f(e,"Damage Numbers",n.visual?.showDamageNumbers!==!1,I,E=>{Gt("visual","showDamageNumbers",E)}),I=f(e,"Compact HUD",n.visual?.compactHUD||!1,I,E=>{Gt("visual","compactHUD",E)}),I=f(e,"FPS Counter",n.visual?.showFPS||!1,I,E=>{Gt("visual","showFPS",E)}),I=f(e,"Show Timer",n.visual?.showTimer!==!1,I,E=>{Gt("visual","showTimer",E)});else if(s==="controls"){const E=n.controls||{},L=[{label:"Move Up",key:"moveUp",value:E.moveUp||"w"},{label:"Move Down",key:"moveDown",value:E.moveDown||"s"},{label:"Move Left",key:"moveLeft",value:E.moveLeft||"a"},{label:"Move Right",key:"moveRight",value:E.moveRight||"d"},{label:"Pause",key:"pause",value:E.pause||"escape"},{label:"Interact",key:"interact",value:E.interact||"space"}];L.forEach((F,U)=>{const _=S+U*g,H=e.add([e.text(F.label+":",{size:16}),e.pos(150,_),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(b.UI_ELEMENTS)]),R=e.add([e.rect(100,30),e.pos(500,_),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(b.UI_ELEMENTS)]),Y=e.add([e.text(F.value.toUpperCase(),{size:16}),e.pos(500,_),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]);m.push(H,R,Y)});const C=S+L.length*g;if(C<e.height()-M){const F=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,C+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(b.UI_ELEMENTS)]);m.push(F)}}else if(s==="gameplay")I=f(e,"Auto-pause on Level Up",n.gameplay?.autoPause||!1,I,E=>{Gt("gameplay","autoPause",E)}),I=f(e,"Auto-pickup Currency",n.gameplay?.autoPickupCurrency||!1,I,E=>{Gt("gameplay","autoPickupCurrency",E)}),I=f(e,"Auto-pickup XP",n.gameplay?.autoPickupXP||!1,I,E=>{Gt("gameplay","autoPickupXP",E)}),I=f(e,"Confirm Before Quit",n.gameplay?.confirmBeforeQuit!==!1,I,E=>{Gt("gameplay","confirmBeforeQuit",E)}),I=f(e,"Skip Intro Animation",n.gameplay?.skipIntroAnimation||!1,I,E=>{Gt("gameplay","skipIntroAnimation",E)});else if(s==="access")I=f(e,"Colorblind Mode",n.accessibility?.colorblindMode!=="off",I,E=>{Gt("accessibility","colorblindMode",E?"deuteranopia":"off")}),I=f(e,"Reduced Motion",n.accessibility?.reducedMotion||!1,I,E=>{Gt("accessibility","reducedMotion",E),E&&(Gt("visual","showParticles",!1),Gt("visual","showScreenShake",!1))}),I=f(e,"Large Text",n.accessibility?.largeText||!1,I,E=>{Gt("accessibility","largeText",E)}),I=f(e,"High Contrast",n.accessibility?.highContrast||!1,I,E=>{Gt("accessibility","highContrast",E)});else if(s==="data"){const E=e.add([e.rect(200,35),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),L=e.add([e.text("Export Save Data",{size:Z.SMALL}),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);let C=null;E.onClick(()=>{try{const Y=localStorage.getItem("superSmashTexty_save")||"{}";navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(Y).then(()=>{C&&C.exists()&&(C.text="Copied to clipboard!",C.color=e.rgb(...y.SUCCESS))}).catch(()=>{C&&C.exists()&&(C.text="Failed to copy",C.color=e.rgb(...y.DANGER))}):(console.log("Save data:",Y),C&&C.exists()&&(C.text="Check browser console (F12)",C.color=e.rgb(...y.TEXT_SECONDARY)))}catch(Y){console.error("Export failed:",Y)}}),m.push(E,L),I+=50,C=e.add([e.text("",{size:Z.SMALL-2}),e.pos(e.width()/2,I-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),m.push(C),I+=30;const F=e.add([e.rect(200,35),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),U=e.add([e.text("Import Save Data",{size:Z.SMALL}),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);F.onClick(()=>{if(!navigator.clipboard||!navigator.clipboard.readText){C&&C.exists()&&(C.text="Clipboard not available",C.color=e.rgb(...y.DANGER));return}navigator.clipboard.readText().then(Y=>{try{const V=JSON.parse(Y);V&&typeof V=="object"&&(localStorage.setItem("superSmashTexty_save",Y),C&&C.exists()&&(C.text="Import successful! Refresh to apply.",C.color=e.rgb(...y.SUCCESS)))}catch{C&&C.exists()&&(C.text="Invalid save data",C.color=e.rgb(...y.DANGER))}}).catch(()=>{C&&C.exists()&&(C.text="Failed to read clipboard",C.color=e.rgb(...y.DANGER))})}),m.push(F,U),I+=60;const _=e.add([e.rect(200,35),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),H=e.add([e.text("Reset All Progress",{size:Z.SMALL}),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);_.onClick(()=>{Ol(e,()=>{localStorage.removeItem("superSmashTexty_save"),C&&C.exists()&&(C.text="Progress reset! Refresh to apply.",C.color=e.rgb(...y.SUCCESS))})}),m.push(_,H),I+=50;const R=e.add([e.text("Warning: Reset cannot be undone!",{size:10}),e.pos(e.width()/2,I),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.UI_ELEMENTS)]);m.push(R)}}function P(S,I,E,L,C){const F=S.add([S.text(I+":",{size:16}),S.pos(150,L),S.anchor("left"),S.color(200,200,200),S.fixed(),S.z(b.UI_ELEMENTS)]),U=300,_=20,H=S.add([S.rect(U,_),S.pos(500,L),S.anchor("center"),S.color(50,50,70),S.outline(2,S.rgb(100,100,120)),S.area(),S.fixed(),S.z(b.UI_ELEMENTS)]);function R(Se){if(Se<.5){const Ie=Se*2;return{r:255,g:Math.round(255*Ie),b:0}}else{const Ie=(Se-.5)*2;return{r:Math.round(255*(1-Ie)),g:255,b:0}}}const Y=U*E,V=R(E),Q=S.add([S.rect(Y,_-4),S.pos(500-(U-Y)/2,L),S.anchor("center"),S.color(V.r,V.g,V.b),S.fixed(),S.z(b.UI_TEXT)]),fe=500-U/2+Y,se=S.add([S.rect(20,_+4),S.pos(fe,L),S.anchor("center"),S.color(200,200,255),S.outline(2,S.rgb(150,150,200)),S.area(),S.fixed(),S.z(1002)]),ie=S.add([S.text(Math.round(E*100)+"%",{size:14}),S.pos(680,L),S.anchor("left"),S.color(255,255,255),S.fixed(),S.z(b.UI_ELEMENTS)]);let ae=!1;H.onClick(()=>{const Se=S.mousePos().x,Ie=500-U/2,ve=Se-Ie,_e=Math.max(0,Math.min(1,ve/U));ge(_e)}),se.onClick(()=>{ae=!0}),S.onMouseMove(()=>{if(ae&&S.isMouseDown()){const Se=S.mousePos().x,Ie=500-U/2,ve=Se-Ie,_e=Math.max(0,Math.min(1,ve/U));ge(_e)}else ae=!1}),S.onMouseRelease(()=>{ae=!1});function ge(Se){const Ie=U*Se;Q.width=Ie,Q.pos.x=500-(U-Ie)/2,se.pos.x=500-U/2+Ie,ie.text=Math.round(Se*100)+"%";const ve=R(Se);Q.color=S.rgb(ve.r,ve.g,ve.b),C(Se)}return m.push(F,H,Q,se,ie),L+g}function f(S,I,E,L,C){const F=S.add([S.text(I+":",{size:16,width:280}),S.pos(150,L),S.anchor("left"),S.color(200,200,200),S.fixed(),S.z(b.UI_ELEMENTS)]),U=80,_=30,H=550,R=S.add([S.rect(U,_),S.pos(H,L),S.anchor("center"),S.color(E?50:70,E?150:50,E?50:70),S.outline(2,S.rgb(100,100,120)),S.area(),S.fixed(),S.z(b.UI_ELEMENTS)]),Y=24,V=E?H+U/2-Y/2-4:H-U/2+Y/2+4,Q=S.add([S.rect(Y,Y),S.pos(V,L),S.anchor("center"),S.color(255,255,255),S.outline(1,S.rgb(200,200,200)),S.fixed(),S.z(b.UI_TEXT)]),fe=E?H-12:H+8,se=S.add([S.text(E?"ON":"OFF",{size:12}),S.pos(fe,L),S.anchor("center"),S.color(E?100:150,E?255:150,E?100:150),S.fixed(),S.z(1002)]);return R.onClick(()=>{const ie=!E;E=ie,R.color=S.rgb(ie?50:70,ie?150:50,ie?50:70),Q.pos.x=ie?H+U/2-Y/2-4:H-U/2+Y/2+4,se.text=ie?"ON":"OFF",se.pos.x=ie?H-12:H+8,se.color=S.rgb(ie?100:150,ie?255:150,ie?100:150),C(ie)}),m.push(F,R,Q,se),L+g}const{MD:N,SM:O}=zn.BUTTON,w=e.add([e.rect(N.width,N.height),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("RESET",{size:Z.SMALL}),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),w.onClick(()=>{Ol(e,()=>{bx(),T()})}),T();const A=e.add([e.rect(O.width,O.height),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),A.onClick(()=>{o?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{o?e.go("game"):e.go("menu")})})}function V1(e,t,o){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),o=Math.max(0,Math.min(1,o));let n,s,a;if(t===0)n=s=a=o;else{const r=(d,i,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?d+(i-d)*6*h:h<.5?i:h<.6666666666666666?d+(i-d)*(.6666666666666666-h)*6:d),l=o<.5?o*(1+t):o+t-o*t,c=2*o-l;n=r(c,l,e+1/3),s=r(c,l,e),a=r(c,l,e-1/3)}return[Math.max(0,Math.min(255,Math.round(n*255))),Math.max(0,Math.min(255,Math.round(s*255))),Math.max(0,Math.min(255,Math.round(a*255)))]}function W1(e){e.scene("statistics",()=>{const t=vs(),o=nh(),n=la();let s="achievements",a="all",r=0;const l=15,c=8;let d=!1,i=null;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),di(e,"RATINGS AND RECORDS",e.width()/2,35,8);const h=80,u=160,p=150,g=30,M=[{key:"achievements",label:"Achievements"},{key:"stats",label:"Statistics"},{key:"history",label:"History"}],m=(M.length-1)*u,T=e.width()/2-m/2,P=[];M.forEach((C,F)=>{const U=T+F*u,_=s===C.key,H=e.add([e.rect(p,g),e.pos(U,h),e.anchor("center"),e.color(..._?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),R=e.add([e.text(C.label,{size:Z.BODY}),e.pos(U,h),e.anchor("center"),e.color(..._?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(b.UI_TEXT)]);H.onClick(()=>{d||(d=!0,Ze(),s=C.key,r=0,a="all",e.wait(0,()=>{I(),e.wait(.1,()=>{d=!1})}))}),P.push({bg:H,label:R,key:C.key})});const f=140,O=e.height()-80;let w=[],A=[];const S=["all",...Eg()];function I(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(P.forEach(C=>{const F=s===C.key;C.bg.color=e.rgb(F?100:50,F?100:50,F?150:80),C.label.color=e.rgb(F?255:150,F?255:150,F?255:150)}),w.forEach(C=>{if(C&&typeof C.exists=="function"&&C.exists())try{e.destroy(C)}catch(F){console.warn("Error destroying content item:",F)}}),w=[],A.forEach(C=>{if(C&&typeof C.exists=="function"&&C.exists())try{e.destroy(C)}catch(F){console.warn("Error destroying category tab item:",F)}}),A=[],s==="stats"){const C=f+20,F=30;[{label:"Total Runs",value:t.totalRuns||0},{label:"Best Floor",value:t.bestFloor||1},{label:"Best Room",value:t.bestRoom||1},{label:"Best Level",value:t.bestLevel||1},{label:"Total Enemies Killed",value:t.totalEnemiesKilled||0},{label:"Total Bosses Killed",value:t.totalBossesKilled||0},{label:"Total Rooms Cleared",value:t.totalRoomsCleared||0},{label:"Total Floors Reached",value:t.totalFloorsReached||0},{label:`Total ${n} Earned`,value:t.totalCurrencyEarned||0}].forEach((_,H)=>{const R=C+H*F,Y=e.add([e.text(_.label+":",{size:18}),e.pos(200,R),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]),V=e.add([e.text(_.value.toString(),{size:18}),e.pos(500,R),e.anchor("left"),e.color(255,255,255),e.fixed(),e.z(1e3)]);w.push(Y,V)})}else if(s==="achievements")try{const H=(e.width()-640)/2,R=f+5,Y=O-R-80,V=R,Q=70,fe=22,se=75,ie=S.slice(0,7),ae=(ie.length-1)*se,ge=e.width()/2-ae/2;ie.forEach((me,st)=>{const re=ge+st*se,Le=a===me,Qe=me==="all"?"All":me.charAt(0).toUpperCase()+me.slice(1),et=e.add([e.rect(Q,fe),e.pos(re,V),e.anchor("center"),e.color(Le?80:40,Le?80:40,Le?120:60),e.outline(1,e.rgb(100,100,150)),e.area(),e.fixed(),e.z(1e3)]),B=e.add([e.text(Qe,{size:11}),e.pos(re,V),e.anchor("center"),e.color(Le?255:150,Le?255:150,Le?255:150),e.fixed(),e.z(1001)]);et.onClick(()=>{d||(d=!0,Ze(),a=me,r=0,i=null,e.wait(0,()=>{I(),e.wait(.1,()=>{d=!1})}))}),A.push(et,B)});let Se;a==="all"?Se=Object.values(an):Se=vg(a);const Ie=Math.ceil(Se.length/l);r>=Ie&&(r=Math.max(0,Ie-1));const ve=r*l,_e=Se.slice(ve,ve+l),nt=R+35,Me=50,Tt=8,ee=5,we=Me+22,ye=H,Pe=e.add([e.rect(320,Y-35),e.pos(H,nt),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(999)]);w.push(Pe);const qe=15;_e.forEach((me,st)=>{const re=o.includes(me.id),Le=i&&i.id===me.id,Qe=Math.floor(st/ee),et=st%ee,B=ye+qe+et*(Me+Tt),K=nt+qe+Qe*we,te=Oo[me.difficulty]||Oo.normal,he=Le?[100,100,180]:re?[50,50,65]:[30,30,40],tt=Le?[150,150,255]:re?te:[50,50,60],ot=e.add([e.rect(Me,Me),e.pos(B,K),e.anchor("topleft"),e.color(...he),e.outline(Le?3:2,e.rgb(...tt)),e.area({width:Me,height:Me}),e.fixed(),e.z(1e3)]),Lt=e.add([e.text(me.icon,{size:24}),e.pos(B+Me/2,K+Me/2),e.anchor("center"),e.color(re?255:80,re?255:80,re?255:80),e.fixed(),e.z(1001)]);if(!re){const at=Gi(me.id,t);if(at&&at.percentage>0){const vt=Me-4,xe=vt*at.progress,be=e.add([e.rect(vt,4),e.pos(B+2,K+Me-6),e.anchor("topleft"),e.color(20,20,30),e.fixed(),e.z(1001)]);if(w.push(be),xe>0){const ce=e.add([e.rect(xe,4),e.pos(B+2,K+Me-6),e.anchor("topleft"),e.color(...te),e.opacity(.8),e.fixed(),e.z(1002)]);w.push(ce)}}}ot.onClick(()=>{d||(Ze(),i=me,d=!0,e.wait(0,()=>{I(),e.wait(.1,()=>{d=!1})}))}),w.push(ot,Lt)});const Ce=H+320+20,rt=e.add([e.rect(300,Y-35),e.pos(Ce,nt),e.anchor("topleft"),e.color(30,28,40),e.outline(2,e.rgb(70,70,100)),e.fixed(),e.z(999)]);w.push(rt);const Je=Ce+300/2,it=nt+20;if(i){const me=i,st=o.includes(me.id),re=Gi(me.id,t),Le=Oo[me.difficulty]||Oo.normal,Qe=e.add([e.rect(70,70),e.pos(Je,it+35),e.anchor("center"),e.color(st?45:25,st?45:25,st?55:30),e.outline(3,e.rgb(...st?Le:[60,60,70])),e.fixed(),e.z(1e3)]);w.push(Qe);const et=e.add([e.text(me.icon,{size:40}),e.pos(Je,it+35),e.anchor("center"),e.color(st?255:100,st?255:100,st?255:100),e.fixed(),e.z(1001)]);w.push(et);const B=e.add([e.text(me.name,{size:16}),e.pos(Je,it+85),e.anchor("center"),e.color(...st?[255,255,255]:[180,180,180]),e.fixed(),e.z(1e3)]);w.push(B);const K=me.difficulty.charAt(0).toUpperCase()+me.difficulty.slice(1),te=e.add([e.text(K,{size:11}),e.pos(Je,it+105),e.anchor("center"),e.color(...Le),e.fixed(),e.z(1e3)]);w.push(te);const he=e.add([e.text(me.description,{size:12}),e.pos(Je,it+130),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1e3)]);w.push(he);let tt=it+160;if(st){const ot=e.add([e.text("UNLOCKED",{size:14}),e.pos(Je,tt),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(1e3)]);w.push(ot)}else if(re){const at=e.add([e.rect(200,16),e.pos(Je,tt),e.anchor("center"),e.color(30,30,45),e.outline(1,e.rgb(70,70,90)),e.fixed(),e.z(1e3)]);w.push(at);const vt=Math.max(2,200*re.progress),xe=e.add([e.rect(vt,12),e.pos(Je-200/2+vt/2,tt),e.anchor("center"),e.color(...Le),e.opacity(.9),e.fixed(),e.z(1001)]);w.push(xe);const be=e.add([e.text(`${re.current} / ${re.target}`,{size:11}),e.pos(Je,tt+20),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);w.push(be),tt+=35}if(!st&&me.hint){const ot=tt+15,Lt=e.add([e.text("Hint:",{size:10}),e.pos(Je,ot),e.anchor("center"),e.color(120,120,140),e.fixed(),e.z(1e3)]);w.push(Lt);const at=e.add([e.text(me.hint,{size:11}),e.pos(Je,ot+18),e.anchor("center"),e.color(160,160,180),e.fixed(),e.z(1e3)]);w.push(at)}}else{const me=e.add([e.text("",{size:32}),e.pos(Je,it+60),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);w.push(me);const st=e.add([e.text("Select an achievement",{size:14}),e.pos(Je,it+100),e.anchor("center"),e.color(120,120,150),e.fixed(),e.z(1e3)]);w.push(st);const re=e.add([e.text("to view details",{size:12}),e.pos(Je,it+120),e.anchor("center"),e.color(100,100,130),e.fixed(),e.z(1e3)]);w.push(re)}if(Ie>1){const me=O-55,st=e.width()/2,re=20,Le=st-(Ie-1)*re/2,Qe=st+(Ie-1)*re/2,et=25,B=Le-et,K=Qe+et,te=at=>{d||at===r||at<0||at>=Ie||(d=!0,Ze(),r=at,e.wait(0,()=>{I(),e.wait(.15,()=>{d=!1})}))};for(let at=0;at<Ie;at++){const vt=at===r,xe=Le+at*re,be=e.add([e.rect(16,16),e.pos(xe,me),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),ce=e.add([e.text(vt?"":"",{size:14}),e.pos(xe,me),e.anchor("center"),e.color(vt?255:120,vt?255:120,vt?255:120),e.fixed(),e.z(b.UI_TEXT)]),de=at;be.onClick(()=>te(de)),be.cursor="pointer",w.push(be,ce)}const he=e.add([e.rect(30,30),e.pos(B,me),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),tt=e.add([e.text("<",{size:24}),e.pos(B,me),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);if(r>0){const at=r-1;he.onClick(()=>te(at)),he.cursor="pointer"}w.push(he,tt);const ot=e.add([e.rect(30,30),e.pos(K,me),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Lt=e.add([e.text(">",{size:24}),e.pos(K,me),e.anchor("center"),e.color(r<Ie-1?255:80,r<Ie-1?255:80,r<Ie-1?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);if(r<Ie-1){const at=r+1;ot.onClick(()=>te(at)),ot.cursor="pointer"}w.push(ot,Lt)}const gt=Object.keys(an).length,Te=o.length,Fe=Te/gt,Be=Fe>=1,Re=O-20,Ke=e.width()/2,dt=e.add([e.text("",{size:24}),e.pos(Ke-220,Re),e.anchor("center"),e.color(Be?255:150,Be?215:150,Be?0:150),e.fixed(),e.scale(1),e.z(1002)]);if(w.push(dt),Be){let me=0;dt.onUpdate(()=>{me+=e.dt();const st=1+Math.sin(me*3)*.1;dt.scale=e.vec2(st,st)})}const ft=20,ht=Math.floor(Fe*ft),ut=ft-ht;let At="";for(let me=0;me<ht;me++)At+="";for(let me=0;me<ut;me++)At+="";const ct=e.add([e.text("|"+"".repeat(ft)+"|",{size:16}),e.pos(Ke,Re),e.anchor("center"),e.color(60,60,80),e.fixed(),e.z(1e3)]);w.push(ct);let Bt;Be?Bt=[255,215,0]:Fe>=.75?Bt=[100,255,100]:Fe>=.5?Bt=[255,255,100]:Fe>=.25?Bt=[255,180,100]:Bt=[200,200,200];const Dt=e.add([e.text("|"+At+"|",{size:16}),e.pos(Ke,Re),e.anchor("center"),e.color(...Bt),e.fixed(),e.z(1001)]);if(w.push(Dt),Be){let me=0;Dt.onUpdate(()=>{me+=e.dt();const st=me*60%360,re=V1(st/360,1,.6);Dt.color=e.rgb(re[0],re[1],re[2])})}const xt=Math.round(Fe*100),Rt=Be?"COMPLETE!":`${xt}%`,Ye=e.add([e.text(`${Te}/${gt}`,{size:14}),e.pos(Ke+180,Re-8),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1002)]);w.push(Ye);const Ct=e.add([e.text(Rt,{size:12}),e.pos(Ke+180,Re+8),e.anchor("center"),e.color(...Be?[255,215,0]:[150,150,180]),e.fixed(),e.opacity(1),e.z(1002)]);if(w.push(Ct),Be){let me=0;Ct.onUpdate(()=>{me+=e.dt();const st=Math.sin(me*4)*.3+.7;Ct.opacity=st})}}catch(C){console.error("Error rendering achievements:",C);const F=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,f+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);w.push(F)}else if(s==="history"){const C=Ng(),F=f+10,U=35;if(C.length===0){const _=e.add([e.text("No run history yet. Complete a run to see it here!",{size:16}),e.pos(e.width()/2,F+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);w.push(_)}else{const _=Math.ceil(C.length/c);r>=_&&(r=Math.max(0,_-1));const H=r*c,R=Math.min(H+c,C.length),Y=C.slice(H,R),V=["#","Floor","Rooms","Kills","Level","Credits","Time"],Q=[60,120,200,280,360,450,550];if(V.forEach((ae,ge)=>{const Se=e.add([e.text(ae,{size:14}),e.pos(Q[ge],F),e.anchor("left"),e.color(255,200,100),e.fixed(),e.z(1e3)]);w.push(Se)}),Y.forEach((ae,ge)=>{const Se=F+(ge+1)*U,Ie=H+ge+1,ve=Math.floor(ae.duration/60),_e=ae.duration%60,nt=`${ve}:${_e.toString().padStart(2,"0")}`;[`${Ie}`,`${ae.floorsReached}`,`${ae.roomsCleared}`,`${ae.enemiesKilled}`,`${ae.level}`,`${n}${ae.currencyEarned}`,nt].forEach((Tt,ee)=>{const we=e.add([e.text(Tt,{size:14}),e.pos(Q[ee],Se),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]);w.push(we)})}),_>1){const ae=O-55,ge=e.width()/2,Se=20,Ie=ge-(_-1)*Se/2;for(let ee=0;ee<_;ee++){const we=ee===r,ye=Ie+ee*Se,Pe=e.add([e.rect(16,16),e.pos(ye,ae),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(1e3)]),qe=e.add([e.text(we?"":"",{size:14}),e.pos(ye,ae),e.anchor("center"),e.color(we?255:120,we?255:120,we?255:120),e.fixed(),e.z(1001)]),Ce=ee;Pe.onClick(()=>{d||Ce===r||(d=!0,Ze(),r=Ce,I(),e.wait(.1,()=>{d=!1}))}),Pe.cursor="pointer",w.push(Pe,qe)}const ve=Math.max(30,_*Se/2+25),_e=e.add([e.rect(30,30),e.pos(ge-ve,ae),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),nt=e.add([e.text("<",{size:24}),e.pos(ge-ve,ae),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(1003)]);r>0&&(_e.onClick(()=>{d||(d=!0,Ze(),r--,I(),e.wait(.1,()=>{d=!1}))}),_e.cursor="pointer"),w.push(_e,nt);const Me=e.add([e.rect(30,30),e.pos(ge+ve,ae),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),Tt=e.add([e.text(">",{size:24}),e.pos(ge+ve,ae),e.anchor("center"),e.color(r<_-1?255:80,r<_-1?255:80,r<_-1?255:80),e.fixed(),e.z(1003)]);r<_-1&&(Me.onClick(()=>{d||(d=!0,Ze(),r++,I(),e.wait(.1,()=>{d=!1}))}),Me.cursor="pointer"),w.push(Me,Tt)}const fe=H+1,se=R,ie=e.add([e.text(`Showing ${fe}-${se} of ${C.length} runs`,{size:12}),e.pos(e.width()/2,O-20),e.anchor("center"),e.color(100,100,150),e.fixed(),e.z(1e3)]);w.push(ie)}}}I();const{SM:E}=zn.BUTTON,L=e.add([e.rect(E.width,E.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),L.onClick(()=>{Ze(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const ln={BREATHE_SPEED:1.5,BREATHE_AMOUNT:.04,BOB_SPEED:2,BOB_AMOUNT:3,GLOW_PULSE_SPEED:2,GLOW_MIN:.3,GLOW_MAX:.7};function $1(e){if(!e.unlockRequirement)return null;if(e.unlockRequirement.type==="floor")return`Unlock: Complete ${Li.FLOOR} ${e.unlockRequirement.value}`;if(e.unlockRequirement.type==="achievement"){const t=an[e.unlockRequirement.value];return t?`Unlock: ${t.name}`:"Unlock: Achievement required"}return null}function J1(e){e.scene("characterSelect",()=>{const t=$n(),o=mn();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),qr(e,t),di(e,"CONTESTANTS",e.width()/2,60,8);const n=Object.keys($t),s=360,a=s+20,r=e.width()-a-20,l=110,c=165,d=70,i=8,h=2,u=5,p=h*u,g=Math.ceil(n.length/p);let M=0;const m=n.indexOf(o);m>=0&&(M=Math.floor(m/p));const T=[],P=o;let f=P,N=[],O=[],w=!1;function A(){if(w)return;w=!0,T.forEach(ee=>{ee&&ee.exists&&ee.exists()&&e.destroy(ee)}),T.length=0,N.forEach(ee=>{ee&&ee.exists&&ee.exists()&&e.destroy(ee)}),N=[],O.forEach(ee=>{ee&&ee.exists&&ee.exists()&&e.destroy(ee)}),O=[];const U=M*p,_=Math.min(U+p,n.length);if(n.slice(U,_).forEach((ee,we)=>{const ye=$t[ee],Pe=Yo("characters",ee)||ye.unlockedByDefault,qe=f===ee,Ce=P===ee,rt=Math.floor(we/h),it=20+we%h*(c+i),gt=l+rt*(d+i),Te=e.add([e.rect(c,d),e.pos(it,gt),e.anchor("topleft"),e.color(...qe?y.BG_MEDIUM:y.BG_DARK),e.outline(2,qe?e.rgb(...y.BORDER_ACTIVE):Pe?e.rgb(...y.TEXT_DISABLED):e.rgb(...y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(b.UI_ELEMENTS),{baseX:it,baseY:gt,isHovered:!1}]),Fe=e.add([e.text(ye.char,{size:Z.TITLE}),e.pos(it+c/2,gt+30),e.anchor("center"),e.color(...Pe?ye.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(b.UI_TEXT),{baseX:it+c/2,baseY:gt+30}]),Be=e.add([e.text(ye.name,{size:Z.SMALL}),e.pos(it+c/2,gt+70),e.anchor("center"),e.color(...Pe?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(b.UI_TEXT),{baseX:it+c/2,baseY:gt+70}]);if(Te.onHoverUpdate(()=>{if(!Te.isHovered&&!qe&&(Te.isHovered=!0,Ze()),!qe){Te.scale=e.vec2(1.05,1.05),Fe.scale=e.vec2(1.15,1.15),Be.scale=e.vec2(1.05,1.05),Te.color=e.rgb(50,50,65);const Re=Math.sin(e.time()*8)*2;Fe.pos.y=Fe.baseY+Re}}),Te.onHoverEnd(()=>{Te.isHovered=!1,Te.scale=e.vec2(1,1),Fe.scale=e.vec2(1,1),Be.scale=e.vec2(1,1),Te.color=e.rgb(...qe?y.BG_MEDIUM:y.BG_DARK),Fe.pos.y=Fe.baseY}),!Pe){const Re=e.add([e.text("",{size:Z.BUTTON}),e.pos(it+c/2,gt+d/2),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.OVERLAY)]);T.push(Re)}if(Ce){const Re=e.add([e.circle(10),e.pos(it+c-8,gt+8),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT+1)]),Ke=e.add([e.text("",{size:12}),e.pos(it+c-8,gt+8),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT+2)]);T.push(Re,Ke)}Te.onClick(()=>{f!==ee&&(Ut(),f=ee,A())}),Te.cursor="pointer",T.push(Te,Fe,Be)}),g>1){const ee=l+u*(d+i)+15,we=s/2,ye=20,Pe=we-(g-1)*ye/2,qe=we+(g-1)*ye/2,Ce=25,rt=Pe-Ce,Je=qe+Ce;for(let Be=0;Be<g;Be++){const Re=Be===M,Ke=Pe+Be*ye,dt=e.add([e.rect(16,16),e.pos(Ke,ee),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),ft=e.add([e.text(Re?"":"",{size:14}),e.pos(Ke,ee),e.anchor("center"),e.color(Re?255:120,Re?255:120,Re?255:120),e.fixed(),e.z(b.UI_TEXT)]),ht=Be;dt.onClick(()=>{ht!==M&&(Ze(),M=ht,A())}),dt.cursor="pointer",O.push(dt,ft)}const it=e.add([e.rect(30,30),e.pos(rt,ee),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),gt=e.add([e.text("<",{size:24}),e.pos(rt,ee),e.anchor("center"),e.color(M>0?255:80,M>0?255:80,M>0?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);M>0&&(it.onClick(()=>{Ze(),M--,A()}),it.cursor="pointer"),O.push(it,gt);const Te=e.add([e.rect(30,30),e.pos(Je,ee),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Fe=e.add([e.text(">",{size:24}),e.pos(Je,ee),e.anchor("center"),e.color(M<g-1?255:80,M<g-1?255:80,M<g-1?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);M<g-1&&(Te.onClick(()=>{Ze(),M++,A()}),Te.cursor="pointer"),O.push(Te,Fe)}const R=$t[f],Y=Yo("characters",f)||R.unlockedByDefault;let V=l;const Q=e.add([e.rect(r-10,380),e.pos(a+5,l-10),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(b.UI_ELEMENTS-1)]);N.push(Q);const fe=e.add([e.circle(50),e.pos(a+r/2,V+45),e.anchor("center"),e.color(...Y?R.color:[80,80,80]),e.opacity(ln.GLOW_MIN),e.scale(1),e.fixed(),e.z(b.UI_ELEMENTS)]);N.push(fe);const se=e.add([e.text(R.char,{size:72}),e.pos(a+r/2,V+45),e.anchor("center"),e.color(...Y?R.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(b.UI_ELEMENTS+1),{baseY:V+45,baseScale:1,animTime:Math.random()*Math.PI*2}]);N.push(se);const ie=e.onUpdate(()=>{if(!se.exists())return;se.animTime+=e.dt();const ee=1+Math.sin(se.animTime*ln.BREATHE_SPEED)*ln.BREATHE_AMOUNT;se.scale=e.vec2(ee,ee);const we=Math.sin(se.animTime*ln.BOB_SPEED)*ln.BOB_AMOUNT;if(se.pos.y=se.baseY+we,fe.exists()){const ye=ln.GLOW_MIN+(Math.sin(se.animTime*ln.GLOW_PULSE_SPEED)*.5+.5)*(ln.GLOW_MAX-ln.GLOW_MIN);fe.opacity=ye,fe.scale=e.vec2(1+ye*.3,1+ye*.3)}});N.push({exists:()=>!0,destroy:()=>ie.cancel()}),V+=110;const ae=e.add([e.text(R.name,{size:Z.HEADER}),e.pos(a+r/2,V),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);N.push(ae),V+=40;const ge=e.add([e.text(R.description,{size:Z.SMALL,width:r-40}),e.pos(a+r/2,V),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);N.push(ge),V+=60;const Se=e.add([e.text("Stats:",{size:Z.LABEL}),e.pos(a+20,V),e.anchor("left"),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT)]);N.push(Se),V+=28;const Ie=100,ve=a+40,_e=24,nt=Ua(e,{label:Li.HEALTH,value:R.stats.health,maxValue:175,x:ve,y:V,width:Ie,color:y.SUCCESS});N.push(...nt.elements),V+=_e;const Me=Ua(e,{label:Li.SPEED,value:R.stats.speed,maxValue:225,x:ve,y:V,width:Ie,color:y.PRIMARY});N.push(...Me.elements),V+=_e;const Tt=Ua(e,{label:Li.DAMAGE,value:R.stats.damage,maxValue:25,x:ve,y:V,width:Ie,color:y.DANGER});if(N.push(...Tt.elements),V+=35,f===P){const ee=e.add([e.text(" CURRENT SELECTION",{size:Z.LABEL}),e.pos(a+r/2,V),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT)]);N.push(ee)}if(!Y){const ee=$1(R);if(ee){const we=e.add([e.text(ee,{size:Z.SMALL,width:r-40}),e.pos(a+r/2,V+30),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);N.push(we)}}w=!1}A(),e.onKeyPress("arrowleft",()=>{M>0&&(Ze(),M--,A())}),e.onKeyPress("arrowright",()=>{M<g-1&&(Ze(),M++,A())});const S=e.add([e.rect(120,35),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text(ni("Cancel"),{size:Z.BODY}),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),S.onClick(()=>{Ze(),e.go("menu")});let I=null,E=null,L=[];function C(){L.forEach(H=>{H&&H.exists&&H.exists()&&e.destroy(H)}),L=[];const U=$t[f],_=Yo("characters",f)||U.unlockedByDefault;I=e.add([e.rect(120,35),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(..._?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(..._?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),L.push(I),E=e.add([e.text(ni("Confirm"),{size:Z.BODY}),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(..._?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]),L.push(E),_&&(I.onClick(()=>{Ut(),Hc(f),Kc(f),e.go("menu")}),I.cursor="pointer")}C();const F=A;A=function(){F(),C()},e.add([e.text("Click a character to preview | Confirm to select",{size:Z.BODY}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(...y.TEXT_TERTIARY),e.fixed(),e.z(b.UI_TEXT)]),e.onKeyPress("escape",()=>{Ze(),e.go("menu")}),e.onKeyPress("enter",()=>{const U=$t[f];(Yo("characters",f)||U.unlockedByDefault)&&(Ut(),Hc(f),Kc(f),e.go("menu"))})})}function j1(e){e.scene("joinParty",()=>{const t={name:Mo(),inviteCode:Jn(),character:mn()};let o=!1;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:Z.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:Z.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(10)]);let n="";const s=e.add([e.text("______",{size:Z.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(10)]),a=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:Z.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(10)]);let r=!1;function l(){let h="";for(let u=0;u<6;u++)u<n.length?h+=n[u]:h+="_";s.text=h}e.onCharInput(h=>{r||/[a-zA-Z0-9]/.test(h)&&n.length<6&&(Ze(),n+=h.toUpperCase(),l(),a.text="",n.length===6&&e.wait(.2,c))}),e.onKeyPress("backspace",()=>{r||n.length>0&&(Ze(),n=n.slice(0,-1),l(),a.text="")}),e.onKeyPress("escape",()=>{Ze(),o=!0,r=!1,Wi(t),e.go("menu")}),e.onKeyPress("enter",()=>{r||n.length===6&&c()});async function c(){if(r)return;const h=n.trim();if(!wg(h)){a.text="Invalid invite code format",a.color=e.rgb(255,100,100);return}r=!0,a.text="Joining party...",a.color=e.rgb(...y.GOLD);try{if(await am(h)){if(o)return;Ut(),a.text="Successfully joined party!",a.color=e.rgb(...y.SUCCESS),e.wait(1,()=>{o||e.go("menu")})}else r=!1,a.text="Failed to join party. Check the code and try again.",a.color=e.rgb(255,100,100),n="",l()}catch(u){r=!1,console.error("[JoinParty] Error joining party:",u),a.text="Connection error. Please try again.",a.color=e.rgb(255,100,100),n="",l()}}const{MD:d}=zn.BUTTON,i=e.add([e.rect(d.width,d.height),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("CANCEL",{size:Z.BODY}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(11)]),i.onClick(()=>{Ze(),o=!0,r=!1,Wi(t),e.go("menu")}),i.onHoverUpdate(()=>{r||(i.color=e.rgb(...y.NEUTRAL_HOVER))}),i.onHoverEnd(()=>{i.color=e.rgb(...y.NEUTRAL)})})}const Zo={DAILY:"daily",ALL_TIME:"allTime",PERSONAL:"personal",GLOBAL:"global"};function Z1(e){e.scene("leaderboards",(t={})=>{let n=t.tab||Zo.DAILY;const s=10,a=5;let r=0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(b.BACKGROUND)]),e.add([e.text("LEADERBOARDS",{size:Z.TITLE}),e.pos(e.width()/2,50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);const l=100,c=115,d=8,i=c*4+d*3,h=(e.width()-i)/2,u=160;let p=[];function g(E,L,C){const F=n===L,U=e.add([e.rect(c,40),e.pos(C,l),e.anchor("center"),e.color(...F?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...F?y.BORDER_HOVER:y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS),"tab"]),_=e.add([e.text(E,{size:Z.BODY}),e.pos(C,l),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"tab"]);return U.onClick(()=>{n!==L&&(Ze(),n=L,r=0,M(),m())}),U.onHoverUpdate(()=>{n!==L&&(U.color=e.rgb(...y.BG_LIGHT))}),U.onHoverEnd(()=>{n!==L&&(U.color=e.rgb(...y.BG_MEDIUM))}),{bg:U,label:_,tabType:L}}function M(){e.get("tab").forEach(E=>e.destroy(E)),g("DAILY",Zo.DAILY,h+c/2),g("ALL-TIME",Zo.ALL_TIME,h+c+d+c/2),g("PERSONAL",Zo.PERSONAL,h+(c+d)*2+c/2),g("GLOBAL",Zo.GLOBAL,h+(c+d)*3+c/2)}function m(){switch(p.forEach(E=>{E.exists()&&e.destroy(E)}),p=[],n){case Zo.DAILY:T();break;case Zo.ALL_TIME:P();break;case Zo.PERSONAL:f();break;case Zo.GLOBAL:N();break}}function T(){const E=Ko(),L=nc(E),C=$t[L]||$t.survivor,F=U1(E,100),U=Mo(),_=Math.ceil(F.length/s);r>=_&&_>0&&(r=_-1);const H=r*s,R=F.slice(H,H+s),Y=e.add([e.text(`Date: ${E}`,{size:Z.BODY}),e.pos(e.width()/2-100,u),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(Y);const V=e.add([e.text(`Character: ${C.char} ${C.name}`,{size:Z.BODY}),e.pos(e.width()/2+50,u),e.anchor("left"),e.color(...C.color),e.fixed(),e.z(b.UI_TEXT)]);p.push(V);const Q=u+40;if(w(Q),F.length===0){const fe=e.add([e.text("No entries yet. Be the first!",{size:Z.BODY}),e.pos(e.width()/2,Q+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);p.push(fe)}else R.forEach((fe,se)=>{const ie=Q+40+se*35,ae=fe.name.toLowerCase()===U.toLowerCase(),ge=H+se+1;A(ge,fe,ie,ae)}),_>1&&O(Q+40+s*35+10,_)}function P(){const E=N1(100),L=Mo(),C=Math.ceil(E.length/s);r>=C&&C>0&&(r=C-1);const F=r*s,U=E.slice(F,F+s),_=u+10;if(w(_),E.length===0){const H=e.add([e.text("No entries yet. Play a game!",{size:Z.BODY}),e.pos(e.width()/2,_+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);p.push(H)}else U.forEach((H,R)=>{const Y=_+40+R*35,V=H.name.toLowerCase()===L.toLowerCase(),Q=F+R+1;A(Q,H,Y,V)}),C>1&&O(_+40+s*35+10,C)}function f(){const E=_1(),L=Object.keys($t),C=Math.ceil(L.length/a);r>=C&&(r=Math.max(0,C-1));const F=r*a,U=L.slice(F,F+a),_=u+10,H=["Character","Best Score","Best Floor","Best Time"],R=[120,280,420,540];H.forEach((V,Q)=>{const fe=e.add([e.text(V,{size:Z.SMALL}),e.pos(R[Q],_),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(fe)});const Y=e.add([e.rect(500,2),e.pos(e.width()/2,_+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(b.UI_ELEMENTS)]);if(p.push(Y),U.forEach((V,Q)=>{const fe=$t[V],se=E[V],ie=_+45+Q*40,ae=e.add([e.text(`${fe.char} ${fe.name}`,{size:Z.BODY}),e.pos(R[0],ie),e.anchor("left"),e.color(...fe.color),e.fixed(),e.z(b.UI_TEXT)]);if(p.push(ae),se){const ge=e.add([e.text(xr(se.bestScore),{size:Z.BODY}),e.pos(R[1],ie),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(ge);const Se=e.add([e.text(`Floor ${se.bestFloor}`,{size:Z.BODY}),e.pos(R[2],ie),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(Se);const Ie=e.add([e.text(Pl(se.bestTime),{size:Z.BODY}),e.pos(R[3],ie),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(Ie)}else{const ge=e.add([e.text("-- no data --",{size:Z.SMALL}),e.pos(R[1],ie),e.anchor("left"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);p.push(ge)}}),C>1){const V=_+45+a*40+20;O(V,C)}}function N(){const E=Mo(),L=u+10,C=e.add([e.text("Connecting to global leaderboard...",{size:Z.BODY}),e.pos(e.width()/2,L+100),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(C),Wh(10).then(F=>{if(C.exists()){e.destroy(C);const _=p.indexOf(C);_>-1&&p.splice(_,1)}if(n!==Zo.GLOBAL)return;if(F.error){const _=e.add([e.text(F.error,{size:Z.BODY}),e.pos(e.width()/2,L+80),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.UI_TEXT)]);p.push(_);const H=e.add([e.rect(120,35),e.pos(e.width()/2,L+130),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);p.push(H);const R=e.add([e.text("Try Again",{size:Z.SMALL}),e.pos(e.width()/2,L+130),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(R),H.onClick(()=>{Ze(),m()}),H.onHoverUpdate(()=>{H.color=e.rgb(...y.SECONDARY_HOVER)}),H.onHoverEnd(()=>{H.color=e.rgb(...y.SECONDARY)});return}const U=F.entries;if(w(L),U.length===0){const _=e.add([e.text("No global entries yet. Be the first!",{size:Z.BODY}),e.pos(e.width()/2,L+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);p.push(_)}else U.forEach((_,H)=>{const R=L+40+H*35,Y=_.name.toLowerCase()===E.toLowerCase();A(H+1,_,R,Y)});if(F.totalCount>0){const _=L+40+Math.min(U.length,10)*35+20,H=e.add([e.text(`${F.totalCount} player${F.totalCount!==1?"s":""} worldwide`,{size:Z.SMALL}),e.pos(e.width()/2,_),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(H)}})}function O(E,L){const C=e.width()/2,F=20,U=C-(L-1)*F/2,_=C+(L-1)*F/2,H=25,R=U-H,Y=_+H;for(let ie=0;ie<L;ie++){const ae=ie===r,ge=U+ie*F,Se=e.add([e.rect(16,16),e.pos(ge,E),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),Ie=e.add([e.text(ae?"":"",{size:14}),e.pos(ge,E),e.anchor("center"),e.color(ae?255:120,ae?255:120,ae?255:120),e.fixed(),e.z(b.UI_TEXT)]),ve=ie;Se.onClick(()=>{ve!==r&&(Ze(),r=ve,m())}),Se.cursor="pointer",p.push(Se,Ie)}const V=e.add([e.rect(30,30),e.pos(R,E),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Q=e.add([e.text("<",{size:24}),e.pos(R,E),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);r>0&&(V.onClick(()=>{Ze(),r--,m()}),V.cursor="pointer"),p.push(V,Q);const fe=e.add([e.rect(30,30),e.pos(Y,E),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),se=e.add([e.text(">",{size:24}),e.pos(Y,E),e.anchor("center"),e.color(r<L-1?255:80,r<L-1?255:80,r<L-1?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);r<L-1&&(fe.onClick(()=>{Ze(),r++,m()}),fe.cursor="pointer"),p.push(fe,se)}function w(E){const L=["#","Name","Score","Floor","Time"],C=[80,150,350,470,560];L.forEach((U,_)=>{const H=e.add([e.text(U,{size:Z.SMALL}),e.pos(C[_],E),e.anchor(_===0?"center":"left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);p.push(H)});const F=e.add([e.rect(550,2),e.pos(e.width()/2,E+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(b.UI_ELEMENTS)]);p.push(F)}function A(E,L,C,F=!1){const U=[80,150,350,470,560],_=F?y.GOLD:y.TEXT_PRIMARY,H=$t[L.character]||$t.survivor,R=e.add([e.text(E<=3?["","1st","2nd","3rd"][E]:`${E}`,{size:Z.BODY}),e.pos(U[0],C),e.anchor("center"),e.color(...E===1?[255,215,0]:E===2?[192,192,192]:E===3?[205,127,50]:_),e.fixed(),e.z(b.UI_TEXT)]);p.push(R);const Y=e.add([e.text(`${H.char} ${L.name}`,{size:Z.BODY}),e.pos(U[1],C),e.anchor("left"),e.color(..._),e.fixed(),e.z(b.UI_TEXT)]);p.push(Y);const V=e.add([e.text(xr(L.score),{size:Z.BODY}),e.pos(U[2],C),e.anchor("left"),e.color(..._),e.fixed(),e.z(b.UI_TEXT)]);p.push(V);const Q=e.add([e.text(`${L.floor}`,{size:Z.BODY}),e.pos(U[3],C),e.anchor("left"),e.color(..._),e.fixed(),e.z(b.UI_TEXT)]);p.push(Q);const fe=e.add([e.text(Pl(L.time),{size:Z.BODY}),e.pos(U[4],C),e.anchor("left"),e.color(..._),e.fixed(),e.z(b.UI_TEXT)]);if(p.push(fe),F){const se=e.add([e.rect(550,30),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.GOLD),e.opacity(.1),e.fixed(),e.z(b.UI_BACKGROUND+1)]);p.push(se)}}const{SM:S}=zn.BUTTON,I=e.add([e.rect(S.width,S.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),I.onClick(()=>{Ut(),e.go("menu")}),I.onHoverUpdate(()=>{I.color=e.rgb(...y.SECONDARY_HOVER)}),I.onHoverEnd(()=>{I.color=e.rgb(...y.SECONDARY)}),e.onKeyPress("escape",()=>{Ut(),e.go("menu")}),M(),m()})}function Q1(e,t,o){const n=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(b.OVERLAY)]),r=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(b.OVERLAY+1)]),l=e.add([e.text("Edit Player Name",{size:Z.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]),c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(b.OVERLAY+2)]);let d=t;const i=e.add([e.text(d,{size:Z.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.OVERLAY+3)]),h=e.add([e.text("(Max 20 characters)",{size:Z.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.OVERLAY+2)]),u=[n,r,l,c,i,h];function p(){u.forEach(w=>{w&&w.exists&&w.exists()&&e.destroy(w)})}const g=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),M=e.add([e.text("Cancel",{size:Z.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+3)]);g.onClick(()=>{Ze(),p()}),u.push(g,M);const m=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),T=e.add([e.text("Save",{size:Z.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.OVERLAY+3)]);m.onClick(()=>{d.trim().length>0?(Ut(),o(d.trim()),p()):(h.text="Name cannot be empty!",h.color=e.rgb(255,100,100))}),u.push(m,T);const P=e.onCharInput(w=>{d.length<20&&/[a-zA-Z0-9 ]/.test(w)&&(d+=w,i.text=d,h.text="(Max 20 characters)",h.color=e.rgb(...y.TEXT_SECONDARY))}),f=e.onKeyPress("backspace",()=>{d.length>0&&(d=d.slice(0,-1),i.text=d||" ")}),N=e.onKeyPress("escape",()=>{p(),P.cancel(),f.cancel(),N.cancel(),O.cancel()}),O=e.onKeyPress("enter",()=>{d.trim().length>0&&(Ut(),o(d.trim()),p(),P.cancel(),f.cancel(),N.cancel(),O.cancel())})}function k1(e){e.scene("profile",(t={})=>{const o=t.externalProfile||null,n=o!==null,s=n?o:yt();let a=n?o.selectedPortrait:ci();const r=n?o.stats:vs(),l=n?o.playerLevel:ri(),c=n?o.totalXP:da(),d=n?o.playerName:Mo();n&&o.achievements;const i=n?o.unlockedPortraits:ih();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),li(e,{patternCount:8,particleCount:12}),n?e.add([e.text(`${d}'s Profile`,{size:Z.H1}),e.pos(e.width()/2,35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]):di(e,"PROFILE",e.width()/2,35,8);const h=80,u=140,p=720,g=e.width()/2;e.add([e.rect(p,u),e.pos(g,h+u/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const M=80,m=g-p/2+60,T=h+u/2,P=mr(a)||Zn.default;e.add([e.rect(M,M),e.pos(m,T),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(3,e.rgb(...P.color||[200,200,200])),e.fixed(),e.z(b.UI_BACKGROUND+1)]),e.add([e.text(P.icon,{size:40}),e.pos(m,T-5),e.anchor("center"),e.color(...P.color||[200,200,200]),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(`LV${l}`,{size:12}),e.pos(m,T+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);const f=m+80;let N=h+20,O=d;const w=e.add([e.text(O,{size:Z.H1}),e.pos(f,N),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);if(!n){const Fe=g+p/2-20,Be=Fe-24-8,Re=e.add([e.rect(24,24),e.pos(Be,N),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Be-24/2,N),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),Re.onClick(()=>{Ut(),Q1(e,O,dt=>{Uc(dt),w.text=dt,O=dt})}),Re.onHoverUpdate(()=>{Re.color=e.rgb(...y.BG_LIGHT)}),Re.onHoverEnd(()=>{Re.color=e.rgb(...y.BG_MEDIUM)});const Ke=e.add([e.rect(24,24),e.pos(Fe,N),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Fe-24/2,N),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]),Ke.onClick(()=>{Ut();const dt=nr();Uc(dt),w.text=dt,O=dt}),Ke.onHoverUpdate(()=>{Ke.color=e.rgb(...y.BG_LIGHT)}),Ke.onHoverEnd(()=>{Ke.color=e.rgb(...y.BG_MEDIUM)})}N+=35;const A=Math.min(5,Math.floor(l/10)),S="".repeat(A)+"".repeat(5-A);e.add([e.text(`Level ${l}  ${S}`,{size:Z.LABEL}),e.pos(f,N),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),N+=30;const I=250,E=16,L=n?0:Ur(),C=c,F=n?c:sh();e.add([e.rect(I,E),e.pos(f,N),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(b.UI_BACKGROUND+1)]);const U=Math.max(2,I*L);e.add([e.rect(U,E-4),e.pos(f+2,N),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(b.UI_ELEMENTS)]),e.add([e.text(`${Math.round(L*100)}%`,{size:10}),e.pos(f+I/2,N),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),N+=22,e.add([e.text(`${C.toLocaleString()} / ${F.toLocaleString()} XP`,{size:Z.SMALL}),e.pos(f,N),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const _=h+u+10,H=165;e.add([e.rect(p,H),e.pos(g,_+H/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const R=f1(),Y=g-p/2+30,V=_+20,Q=40,fe=50,se=13;let ie=null,ae=null;function ge(Te){ie&&ie.exists()&&(ie.text=`Selected: "${Te.name}"`),ae&&ae.exists()&&(ae.text=Te.description)}R.forEach((Te,Fe)=>{const Be=Math.floor(Fe/se),Re=Fe%se,Ke=Y+Re*fe,dt=V+Be*(fe+5),ft=n?i.includes(Te.id):p1(Te.id,s),ht=Te.id===a,ut=ft?ht?[80,100,140]:y.BG_LIGHT:[40,40,50],At=ht?y.GOLD:ft?Te.color:[80,80,80],ct=e.add([e.rect(Q,Q),e.pos(Ke,dt),e.anchor("center"),e.color(...ut),e.outline(ht?3:2,e.rgb(...At)),n?null:e.area(),e.fixed(),e.z(b.UI_ELEMENTS)].filter(Boolean)),Bt=ft?Te.icon:"",Dt=ft?Te.color:[100,100,100];e.add([e.text(Bt,{size:ft?24:16}),e.pos(Ke,dt-3),e.anchor("center"),e.color(...Dt),e.fixed(),e.z(b.UI_TEXT)]);const xt=ft?Te.name.substring(0,8):"???";e.add([e.text(xt,{size:8}),e.pos(Ke,dt+Q/2+8),e.anchor("center"),e.color(...ft?y.TEXT_SECONDARY:[80,80,80]),e.fixed(),e.z(b.UI_TEXT)]),n||(ct.onClick(()=>{if(ft)Ut(),qg(Te.id),a=Te.id,ge(Te),e.go("profile");else{Ze();const Rt=g1(Te.id);ae&&ae.exists()&&(ae.text=`Locked: ${Rt}`,ae.color=e.rgb(...y.DANGER))}}),ct.onHoverUpdate(()=>{ht||(ct.color=e.rgb(...ft?[100,120,160]:[50,50,60]))}),ct.onHoverEnd(()=>{ht||(ct.color=e.rgb(...ut))}))}),ie=e.add([e.text(`Selected: "${P.name}"`,{size:Z.SMALL}),e.pos(g,_+H-35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]),ae=e.add([e.text(P.description,{size:Z.SMALL-2}),e.pos(g,_+H-18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const Se=_+H+10,Ie=120;e.add([e.rect(p,Ie),e.pos(g,Se+Ie/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const ve=r,_e=ve.totalRuns||0,nt=_e>0?Math.round((ve.totalCurrencyEarned||0)/_e):0,Me=_e>0?((ve.totalFloorsReached||0)/_e).toFixed(1):"0",Tt=_e>0?((ve.totalRoomsCleared||0)/_e).toFixed(1):"0",ee=ve.fastestRunTime||0,we=Math.floor(ee/60),ye=Math.floor(ee%60),Pe=ee>0?`${we}:${ye.toString().padStart(2,"0")}`:"--:--",qe=[{label:"Total Runs",value:_e},{label:"Best Floor",value:ve.bestFloor||1},{label:"Best Level",value:ve.bestLevel||1},{label:"Best Room",value:ve.bestRoom||1},{label:"Fastest Run",value:Pe}],Ce=p/qe.length;qe.forEach((Te,Fe)=>{const Be=g-p/2+Ce*Fe+Ce/2,Re=Se+15;e.add([e.text(Te.label,{size:Z.SMALL-2}),e.pos(Be,Re),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(String(Te.value),{size:Z.LABEL}),e.pos(Be,Re+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)])}),[{label:"Enemies",value:(ve.totalEnemiesKilled||0).toLocaleString()},{label:"Bosses",value:ve.totalBossesKilled||0},{label:"Rooms",value:(ve.totalRoomsCleared||0).toLocaleString()},{label:"Avg Floor",value:Me},{label:"Avg Rooms",value:Tt}].forEach((Te,Fe)=>{const Be=g-p/2+Ce*Fe+Ce/2,Re=Se+50;e.add([e.text(Te.label,{size:Z.SMALL-2}),e.pos(Be,Re),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(String(Te.value),{size:Z.SMALL}),e.pos(Be,Re+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)])}),[{label:"Total Money",value:(ve.totalCurrencyEarned||0).toLocaleString()},{label:"Spent",value:(ve.totalCurrencySpent||0).toLocaleString()},{label:"Avg Money",value:nt.toLocaleString()},{label:"Floors",value:(ve.totalFloorsReached||0).toLocaleString()},{label:"Play Time",value:(()=>{const Te=ve.totalPlayTime||0,Fe=Math.floor(Te/3600),Be=Math.floor(Te%3600/60);return`${Fe}h ${Be}m`})()}].forEach((Te,Fe)=>{const Be=g-p/2+Ce*Fe+Ce/2,Re=Se+85;e.add([e.text(Te.label,{size:Z.SMALL-2}),e.pos(Be,Re),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(String(Te.value),{size:Z.SMALL}),e.pos(Be,Re+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)])});const{SM:it}=zn.BUTTON,gt=e.add([e.rect(it.width,it.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),gt.onClick(()=>{Ze(),e.go("menu")}),gt.onHoverUpdate(()=>{gt.color=e.rgb(...y.NEUTRAL_HOVER)}),gt.onHoverEnd(()=>{gt.color=e.rgb(...y.NEUTRAL)}),e.onKeyPress("escape",()=>{Ze(),e.go("menu")})})}const Vo=bg({width:Rs.CANVAS_WIDTH,height:Rs.CANVAS_HEIGHT,background:Rs.BACKGROUND_COLOR,scale:Rs.CANVAS_SCALE,debug:Rs.DEBUG_MODE,root:document.querySelector("#game-container"),stretch:!0,letterbox:!0,crisp:!0});M1(Vo);u1(Vo);q1(Vo);G1(Vo);K1(Vo);W1(Vo);J1(Vo);j1(Vo);Z1(Vo);k1(Vo);Vo.go("menu");
//# sourceMappingURL=main-Im9BqK9w.js.map
