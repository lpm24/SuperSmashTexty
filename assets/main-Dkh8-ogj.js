(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=o(s);fetch(s.href,a)}})();var iu=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return o=>{for(var n=o.length,s=new Uint8Array((n-(o[n-1]=="=")-(o[n-2]=="="))*3/4|0),a=0,r=0;a<n;){var l=e[o.charCodeAt(a++)],c=e[o.charCodeAt(a++)],d=e[o.charCodeAt(a++)],i=e[o.charCodeAt(a++)];s[r++]=l<<2|c>>4,s[r++]=c<<4|d>>2,s[r++]=d<<6|i}return s}})(),au={version:"3001.0.19"};function nn(e,t,o){return t>o?nn(e,o,t):Math.min(Math.max(e,t),o)}var vt=class kt{r=255;g=255;b=255;constructor(t,o,n){this.r=nn(t,0,255),this.g=nn(o,0,255),this.b=nn(n,0,255)}static fromArray(t){return new kt(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new kt(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!o)throw new Error("Invalid hex color format");return new kt(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,o,n){if(o==0)return new kt(255*n,255*n,255*n);let s=(i,h,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<1/6?i+(h-i)*6*u:u<1/2?h:u<2/3?i+(h-i)*(2/3-u)*6:i),a=n<.5?n*(1+o):n+o-n*o,r=2*n-a,l=s(r,a,t+1/3),c=s(r,a,t),d=s(r,a,t-1/3);return new kt(Math.round(l*255),Math.round(c*255),Math.round(d*255))}static RED=new kt(255,0,0);static GREEN=new kt(0,255,0);static BLUE=new kt(0,0,255);static YELLOW=new kt(255,255,0);static MAGENTA=new kt(255,0,255);static CYAN=new kt(0,255,255);static WHITE=new kt(255,255,255);static BLACK=new kt(0,0,0);clone(){return new kt(this.r,this.g,this.b)}lighten(t){return new kt(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new kt(255-this.r,255-this.g,255-this.b)}mult(t){return new kt(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,o){return new kt(So(this.r,t.r,o),So(this.g,t.g,o),So(this.b,t.b,o))}toHSL(){let t=this.r/255,o=this.g/255,n=this.b/255,s=Math.max(t,o,n),a=Math.min(t,o,n),r=(s+a)/2,l=r,c=r;if(s==a)r=l=0;else{let d=s-a;switch(l=c>.5?d/(2-s-a):d/(s+a),s){case t:r=(o-n)/d+(o<n?6:0);break;case o:r=(n-t)/d+2;break;case n:r=(t-o)/d+4;break}r/=6}return[r,l,c]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function Ht(...e){if(e.length===0)return new vt(255,255,255);if(e.length===1){if(e[0]instanceof vt)return e[0].clone();if(typeof e[0]=="string")return vt.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return vt.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof vt)return e[0].clone()}else if(e.length===3||e.length===4)return new vt(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var ru=(e,t,o)=>vt.fromHSL(e,t,o);function to(e){return e*Math.PI/180}function qn(e){return e*180/Math.PI}function So(e,t,o){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*o;if(e instanceof oe&&t instanceof oe||e instanceof vt&&t instanceof vt)return e.lerp(t,o);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function en(e,t,o,n,s){return n+(e-t)/(o-t)*(s-n)}function cu(e,t,o,n,s){return nn(en(e,t,o,n,s),n,s)}var oe=class no{x=0;y=0;constructor(t=0,o=t){this.x=t,this.y=o}static fromAngle(t){let o=to(t);return new no(Math.cos(o),Math.sin(o))}static fromArray(t){return new no(t[0],t[1])}static ZERO=new no(0,0);static ONE=new no(1,1);static LEFT=new no(-1,0);static RIGHT=new no(1,0);static UP=new no(0,-1);static DOWN=new no(0,1);clone(){return new no(this.x,this.y)}add(...t){let o=$(...t);return new no(this.x+o.x,this.y+o.y)}sub(...t){let o=$(...t);return new no(this.x-o.x,this.y-o.y)}scale(...t){let o=$(...t);return new no(this.x*o.x,this.y*o.y)}dist(...t){let o=$(...t);return this.sub(o).len()}sdist(...t){let o=$(...t);return this.sub(o).slen()}static sdist(t,o){let n=t.x-o.x,s=t.y-o.y;return n*n+s*s}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new no(0):this.scale(1/t)}normal(){return new no(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,o){return t.x*o.x+t.y*o.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,o){return t.x*o.y-t.y*o.x}angle(...t){let o=$(...t);return qn(Math.atan2(this.y-o.y,this.x-o.x))}angleBetween(...t){let o=$(...t);return qn(Math.atan2(this.cross(o),this.dot(o)))}lerp(t,o){return new no(So(this.x,t.x,o),So(this.y,t.y,o))}slerp(t,o){let n=this.dot(t),s=this.cross(t),a=Math.atan2(s,n);return this.scale(Math.sin((1-o)*a)).add(t.scale(Math.sin(o*a))).scale(1/s)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new no(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Yt(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function $(...e){if(e.length===1){if(e[0]instanceof oe)return new oe(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new oe(...e[0])}return new oe(...e)}var Jt=class Na{x=0;y=0;w=1;h=1;constructor(t,o,n,s){this.x=t,this.y=o,this.w=n,this.h=s}scale(t){return new Na(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new oe(this.x,this.y)}clone(){return new Na(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function eo(e,t,o,n){return new Jt(e,t,o,n)}var Oi=class is{a;b;c;d;constructor(t,o,n,s){this.a=t,this.b=o,this.c=n,this.d=s}mul(t){return new is(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return $(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new is(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new is(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,o=this.det,n=t+Math.sqrt(t*t-o),s=t-Math.sqrt(t*t-o);return[n,s]}eigenvectors(t,o){return this.c!=0?[[t-this.d,this.c],[o-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,o-this.a]]:Math.abs(this.transform($(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let o=Math.cos(t),n=Math.sin(t);return new is(o,n,-n,o)}static scale(t,o){return new is(t,0,0,o)}},zs=class Os{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,o,n,s,a,r,l,c,d){this.m11=t,this.m12=o,this.m13=n,this.m21=s,this.m22=a,this.m23=r,this.m31=l,this.m32=c,this.m33=d}static fromMat2(t){return new Os(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new Oi(this.m11,this.m12,this.m21,this.m22)}mul(t){return new Os(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let o=Math.cos(t),n=Math.sin(t),s=this.m11,a=this.m12;return this.m11=o*this.m11+n*this.m21,this.m12=o*this.m12+n*this.m22,this.m21=o*this.m21-n*s,this.m22=o*this.m22-n*a,this}scale(t,o){return this.m11*=t,this.m12*=t,this.m21*=o,this.m22*=o,this}get inverse(){let t=this.det;return new Os((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new Os(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},sn=class dn{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new dn([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new dn([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t);return new dn([1,0,0,0,0,o,-n,0,0,n,o,0,0,0,0,1])}static rotateY(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t);return new dn([o,0,n,0,0,1,0,0,-n,0,o,0,0,0,0,1])}static rotateZ(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t);return new dn([o,-n,0,0,n,o,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=to(-t);let o=Math.cos(t),n=Math.sin(t),s=this.m[0],a=this.m[1],r=this.m[4],l=this.m[5];return this.m[0]=s*o+a*n,this.m[1]=-s*n+a*o,this.m[4]=r*o+l*n,this.m[5]=-r*n+l*o,this}mult(t){let o=[];for(let n=0;n<4;n++)for(let s=0;s<4;s++)o[n*4+s]=this.m[0+s]*t.m[n*4+0]+this.m[4+s]*t.m[n*4+1]+this.m[8+s]*t.m[n*4+2]+this.m[12+s]*t.m[n*4+3];return new dn(o)}multVec2(t){return new oe(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new oe(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new oe(o,t/o)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new oe(t/o,o)}else return new oe(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return qn(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return qn(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new oe(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new oe(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new oe(0,0)}invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],n=this.m[9]*this.m[15]-this.m[13]*this.m[11],s=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],r=this.m[8]*this.m[14]-this.m[12]*this.m[10],l=this.m[8]*this.m[13]-this.m[12]*this.m[9],c=this.m[6]*this.m[15]-this.m[14]*this.m[7],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],i=this.m[5]*this.m[14]-this.m[13]*this.m[6],h=this.m[4]*this.m[15]-this.m[12]*this.m[7],u=this.m[4]*this.m[14]-this.m[12]*this.m[6],g=this.m[5]*this.m[15]-this.m[13]*this.m[7],p=this.m[4]*this.m[13]-this.m[12]*this.m[5],T=this.m[6]*this.m[11]-this.m[10]*this.m[7],m=this.m[5]*this.m[11]-this.m[9]*this.m[7],M=this.m[5]*this.m[10]-this.m[9]*this.m[6],P=this.m[4]*this.m[11]-this.m[8]*this.m[7],f=this.m[4]*this.m[10]-this.m[8]*this.m[6],_=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*n+this.m[7]*s,t[4]=-(this.m[4]*o-this.m[6]*a+this.m[7]*r),t[8]=this.m[4]*n-this.m[5]*a+this.m[7]*l,t[12]=-(this.m[4]*s-this.m[5]*r+this.m[6]*l),t[1]=-(this.m[1]*o-this.m[2]*n+this.m[3]*s),t[5]=this.m[0]*o-this.m[2]*a+this.m[3]*r,t[9]=-(this.m[0]*n-this.m[1]*a+this.m[3]*l),t[13]=this.m[0]*s-this.m[1]*r+this.m[2]*l,t[2]=this.m[1]*c-this.m[2]*d+this.m[3]*i,t[6]=-(this.m[0]*c-this.m[2]*h+this.m[3]*u),t[10]=this.m[0]*g-this.m[1]*h+this.m[3]*p,t[14]=-(this.m[0]*i-this.m[1]*u+this.m[2]*p),t[3]=-(this.m[1]*T-this.m[2]*m+this.m[3]*M),t[7]=this.m[0]*T-this.m[2]*P+this.m[3]*f,t[11]=-(this.m[0]*m-this.m[1]*P+this.m[3]*_),t[15]=this.m[0]*M-this.m[1]*f+this.m[2]*_;let B=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let b=0;b<4;b++)for(let S=0;S<4;S++)t[b*4+S]*=1/B;return new dn(t)}clone(){return new dn([...this.m])}toString(){return this.m.toString()}};function Hl(e,t,o,n=s=>-Math.cos(s)){return e+(n(o)+1)/2*(t-e)}var lu=1103515245,du=12345,yc=2147483648,Ul=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(lu*this.seed+du)%yc,this.seed/yc}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new oe(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new vt(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof oe)return this.genVec2($(0,0),e[0]);if(e[0]instanceof vt)return this.genColor(Ht(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof oe&&e[1]instanceof oe)return this.genVec2(e[0],e[1]);if(e[0]instanceof vt&&e[1]instanceof vt)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},_a=new Ul(Date.now());function hu(e){return e!=null&&(_a.seed=e),_a.seed}function so(...e){return _a.genAny(...e)}function Nl(...e){return Math.floor(so(...e.length>0?e:[2]))}function uu(e){return so()<=e}function _l(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function fu(e,t){return e.length<=t?e.slice():_l(e.slice()).slice(0,t)}function pu(e){return e[Nl(e.length)]}function Xl(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function gu(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let o=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(o===0)return null;let n=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/o,s=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/o;return n<0||n>1||s<0||s>1?null:n}function br(e,t){let o=gu(e,t);return o?$(e.p1.x+o*(e.p2.x-e.p1.x),e.p1.y+o*(e.p2.y-e.p1.y)):null}function vr(e,t){let o=t.p2.sub(t.p1),n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;if(o.x!=0){let a=(e.pos.x-t.p1.x)/o.x,r=(e.pos.x+e.width-t.p1.x)/o.x;n=Math.max(n,Math.min(a,r)),s=Math.min(s,Math.max(a,r))}if(o.y!=0){let a=(e.pos.y-t.p1.y)/o.y,r=(e.pos.y+e.height-t.p1.y)/o.y;n=Math.max(n,Math.min(a,r)),s=Math.min(s,Math.max(a,r))}return s>=n&&s>=0&&n<=1}function oa(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function Fl(e,t){let o=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),n=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return $(o,n).sdist(t.center)<=t.radius*t.radius}function Yl(e,t){return ql(t,new xo(e.points()))}function Er(e,t){let o=t.sub(e.p1),n=e.p2.sub(e.p1);if(Math.abs(o.cross(n))>Number.EPSILON)return!1;let s=o.dot(n)/n.dot(n);return s>=0&&s<=1}function ii(e,t){let o=e.p2.sub(e.p1),n=o.dot(o),s=e.p1.sub(t.center),a=2*o.dot(s),r=s.dot(s)-t.radius*t.radius,l=a*a-4*n*r;if(n<=Number.EPSILON||l<0)return!1;if(l==0){let c=-a/(2*n);if(c>=0&&c<=1)return!0}else{let c=(-a+Math.sqrt(l))/(2*n),d=(-a-Math.sqrt(l))/(2*n);if(c>=0&&c<=1||d>=0&&d<=1)return!0}return na(t,e.p1)}function Ar(e,t){if(In(t,e.p1)||In(t,e.p2))return!0;for(let o=0;o<t.pts.length;o++){let n=t.pts[o],s=t.pts[(o+1)%t.pts.length];if(br(e,new Co(n,s)))return!0}return!1}function na(e,t){return e.center.sdist(t)<e.radius*e.radius}function mu(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function sa(e,t){let o=t.pts[t.pts.length-1];for(let n of t.pts){if(ii(new Co(o,n),e))return!0;o=n}return na(e,t.pts[0])?!0:In(t,e.center)}function ql(e,t){for(let o=0;o<e.pts.length;o++)if(Ar(new Co(e.pts[o],e.pts[(o+1)%e.pts.length]),t))return!0;return!!(e.pts.some(o=>In(t,o))||t.pts.some(o=>In(e,o)))}function In(e,t){let o=!1,n=e.pts;for(let s=0,a=n.length-1;s<n.length;a=s++)n[s].y>t.y!=n[a].y>t.y&&t.x<(n[a].x-n[s].x)*(t.y-n[s].y)/(n[a].y-n[s].y)+n[s].x&&(o=!o);return o}function Sr(e,t){t=t.sub(e.center);let o=to(e.angle),n=Math.cos(o),s=Math.sin(o),a=t.x*n+t.y*s,r=-t.x*s+t.y*n;return a*a/(e.radiusX*e.radiusX)+r*r/(e.radiusY*e.radiusY)<1}function Hi(e,t){let o=t.center.sub(e.center),n=to(e.angle),s=Math.cos(n),a=Math.sin(n),r=o.x*s+o.y*a,l=-o.x*a+o.y*s;return Sr(new gn($(),e.radiusX+t.radius,e.radiusY+t.radius,0),$(r,l))}function Gl(e,t){let o=e.toMat2().inverse;return t=new Co(o.transform(t.p1.sub(e.center)),o.transform(t.p2.sub(e.center))),ii(t,new Do($(),1))}function yu(e,t){if(e.radiusX===e.radiusY)return Hi(t,new Do(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Hi(e,new Do(t.center,t.radiusX));let o=new zs(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),n=new zs(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),s=e.center.x,a=e.center.y,r=t.center.x,l=t.center.y,c=to(e.angle),d=to(t.angle),i=new zs(Math.cos(c),-Math.sin(c),s,Math.sin(c),Math.cos(c),a,0,0,1),h=new zs(Math.cos(d),-Math.sin(d),r,Math.sin(d),Math.cos(d),l,0,0,1),u=i.inverse,g=h.inverse,p=u.transpose.mul(o).mul(u),T=g.transpose.mul(n).mul(g),m=p.m11,M=p.m12,P=p.m13,f=p.m21,_=p.m22,B=p.m23,b=p.m31,S=p.m32,E=p.m33,C=T.m11,A=T.m12,z=T.m13,R=T.m21,Y=T.m22,U=T.m23,N=T.m31,H=T.m32,I=T.m33,F=m*_*E-m*B*S-M*f*E+M*B*b+P*f*S-P*_*b,V=(m*_*I-m*B*H-m*S*U+m*E*Y-M*f*I+M*B*N+M*b*U-M*E*R+P*f*H-P*_*N-P*b*Y+P*S*R+f*S*z-f*E*A-_*b*z+_*E*C+B*b*A-B*S*C)/F,j=(m*Y*I-m*U*H-M*R*I+M*U*N+P*R*H-P*Y*N-f*A*I+f*z*H+_*C*I-_*z*N-B*C*H+B*A*N+b*A*U-b*z*Y-S*C*U+S*z*R+E*C*Y-E*A*R)/F,ce=(C*Y*I-C*U*H-A*R*I+A*U*N+z*R*H-z*Y*N)/F;if(V>=0){let ie=-3*j+V**2,ne=3*V*ce+j*V**2-4*j**2,se=-27*ce**2+18*ce*V*j+V**2*j**2-4*V**3*ce-4*j**3;return!(ie>0&&ne<0&&se>0)}else{let ie=-3*j+V**2,ne=-27*ce**2+18*ce*V*j+V**2*j**2-4*V**3*ce-4*j**3;return!(ie>0&&ne>0)}}function Kl(e,t){return Mr(e,new xo(t.points()))}function Mr(e,t){let o=e.toMat2().inverse;return t=new xo(t.pts.map(n=>o.transform(n.sub(e.center)))),sa(new Do($(),1),t)}function xu(e,t){return e.x===t.x&&e.y===t.y}function wu(e,t){return t instanceof oe?xu(t,e.pt):t instanceof Do?na(t,e.pt):t instanceof Co?Er(t,e.pt):t instanceof Yt?oa(t,e.pt):t instanceof xo?In(t,e.pt):t instanceof gn?Sr(t,e.pt):!1}function bu(e,t){return t instanceof oe?Er(e,t):t instanceof Do?ii(e,t):t instanceof Co?br(e,t)!=null:t instanceof Yt?vr(t,e):t instanceof xo?Ar(e,t):t instanceof gn?Gl(t,e):!1}function vu(e,t){return t instanceof oe?na(e,t):t instanceof Do?mu(e,t):t instanceof Co?ii(t,e):t instanceof Yt?Fl(t,e):t instanceof xo?sa(e,t):t instanceof gn?Hi(t,e):!1}function Eu(e,t){return t instanceof oe?oa(e,t):t instanceof Do?Fl(e,t):t instanceof Co?vr(e,t):t instanceof Yt?Xl(e,t):t instanceof xo?Yl(e,t):t instanceof gn?Kl(t,e):!1}function Au(e,t){return t instanceof oe?In(e,t):t instanceof Do?sa(t,e):t instanceof Co?Ar(t,e):t instanceof Yt?Yl(t,e):t instanceof xo?ql(t,e):t instanceof gn?Mr(t,e):!1}function Su(e,t){return t instanceof oe?Sr(e,t):t instanceof Do?Hi(e,t):t instanceof Co?Gl(e,t):t instanceof Yt?Kl(e,t):t instanceof xo?Mr(e,t):t instanceof gn?yu(t,e):!1}function Vl(e,t,o){let n=e,s=o.p1,a=o.p2,r=t,l=a.sub(s),c=r.cross(l);if(Math.abs(c)<Number.EPSILON)return null;let d=s.sub(n),i=d.cross(l)/c;if(i<=0||i>=1)return null;let h=d.cross(r)/c;if(h<=0||h>=1)return null;let u=l.normal().unit();return t.dot(u)>0&&(u.x*=-1,u.y*=-1),{point:n.add(r.scale(i)),normal:u,fraction:i}}function Mu(e,t,o){let n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,a;if(e.x!=0){let r=(o.pos.x-e.x)/t.x,l=(o.pos.x+o.width-e.x)/t.x;a=$(-Math.sign(t.x),0),n=Math.max(n,Math.min(r,l)),s=Math.min(s,Math.max(r,l))}if(e.y!=0){let r=(o.pos.y-e.y)/t.y,l=(o.pos.y+o.height-e.y)/t.y;Math.min(r,l)>n&&(a=$(0,-Math.sign(t.y))),n=Math.max(n,Math.min(r,l)),s=Math.min(s,Math.max(r,l))}return s>=n&&n>=0&&n<=1?{point:e.add(t.scale(n)),normal:a,fraction:n}:null}function Wl(e,t,o){let n=e,s=o.center,a=t,r=a.dot(a),l=n.sub(s),c=2*a.dot(l),d=l.dot(l)-o.radius*o.radius,i=c*c-4*r*d;if(r<=Number.EPSILON||i<0)return null;if(i==0){let h=-c/(2*r);if(h>=0&&h<=1){let u=n.add(a.scale(h));return{point:u,normal:u.sub(s),fraction:h}}}else{let h=(-c+Math.sqrt(i))/(2*r),u=(-c-Math.sqrt(i))/(2*r),g=null;if(h>=0&&h<=1&&(g=h),u>=0&&u<=1&&(g=Math.min(u,g??u)),g!=null){let p=n.add(a.scale(g));return{point:p,normal:p.sub(s).unit(),fraction:g}}}return null}function Tu(e,t,o){let n=o.pts,s=null,a=n[n.length-1];for(let r=0;r<n.length;r++){let l=n[r],c=Vl(e,t,new Co(a,l));c&&(!s||s.fraction>c.fraction)&&(s=c),a=l}return s}function Du(e,t,o){let n=o.toMat2(),s=n.inverse,a=s.transform(e.sub(o.center)),r=s.transform(t),l=Wl(a,r,new Do($(),1));if(l){let c=Oi.rotation(to(-o.angle)),d=Oi.scale(o.radiusX,o.radiusY).transform(l.point),i=n.transform(l.point).add(o.center),h=i.dist(e)/t.len();return{point:i,normal:c.transform($(o.radiusY**2*d.x,o.radiusX**2*d.y)).unit(),fraction:h}}return l}function Cu(e,t,o,n=64){let s=e,a=t.len(),r=t.scale(1/a),l=0,c=$(Math.floor(e.x),Math.floor(e.y)),d=$(r.x>0?1:-1,r.y>0?1:-1),i=$(Math.abs(1/r.x),Math.abs(1/r.y)),h=$(d.x>0?c.x+1-e.x:e.x-c.x,d.y>0?c.y+1-e.y:e.y-c.y),u=$(i.x<1/0?i.x*h.x:1/0,i.y<1/0?i.y*h.y:1/0),g=-1;for(;l<=n;){let p=o(c);if(p===!0)return{point:s.add(r.scale(l)),normal:$(g===0?-d.x:0,g===1?-d.y:0),fraction:l/a,gridPos:c};if(p)return p;u.x<u.y?(c.x+=d.x,l=u.x,u.x+=i.x,g=0):(c.y+=d.y,l=u.y,u.y+=i.y,g=1)}return null}var Ru=class Xa{pt;constructor(t){this.pt=t.clone()}transform(t){return new Xa(t.multVec2(this.pt))}bbox(){return new Yt(this.pt,0,0)}area(){return 0}clone(){return new Xa(this.pt)}collides(t){return wu(this,t)}contains(t){return this.pt.eq(t)}raycast(t,o){return null}random(){return this.pt.clone()}},Co=class Fa{p1;p2;constructor(t,o){this.p1=t.clone(),this.p2=o.clone()}transform(t){return new Fa(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Yt.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new Fa(this.p1,this.p2)}collides(t){return bu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Vl(t,o,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(so(1)))}},Yt=class Ya{pos;width;height;constructor(t,o,n){this.pos=t.clone(),this.width=o,this.height=n}static fromPoints(t,o){return new Ya(t.clone(),o.x-t.x,o.y-t.y)}center(){return new oe(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new xo(this.points().map(o=>t.multVec2(o)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Ya(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let o=this.pos,n=this.pos.add(this.width,this.height),s=Math.max(o.x-t.x,0,t.x-n.x),a=Math.max(o.y-t.y,0,t.y-n.y);return s*s+a*a}collides(t){return Eu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Mu(t,o,this)}random(){return this.pos.add(so(this.width),so(this.height))}},Do=class $l{center;radius;constructor(t,o){this.center=t.clone(),this.radius=o}transform(t){return new gn(this.center,this.radius,this.radius).transform(t)}bbox(){return Yt.fromPoints(this.center.sub($(this.radius)),this.center.add($(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new $l(this.center,this.radius)}collides(t){return vu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Wl(t,o,this)}random(){return this.center.add(oe.fromAngle(so(360)).scale(so(this.radius)))}},gn=class as{center;radiusX;radiusY;angle;constructor(t,o,n,s=0){this.center=t.clone(),this.radiusX=o,this.radiusY=n,this.angle=s}static fromMat2(t){let o=t.inverse,n=o.transpose.mul(o),[s,a]=n.eigenvalues,[r,l]=n.eigenvectors(s,a),[c,d]=[1/Math.sqrt(s),1/Math.sqrt(a)];return c>d?new as($(),c,d,qn(Math.atan2(-r[1],r[0]))):new as($(),d,c,qn(Math.atan2(-l[1],l[0])))}toMat2(){let t=to(this.angle),o=Math.cos(t),n=Math.sin(t);return new Oi(o*this.radiusX,-n*this.radiusY,n*this.radiusX,o*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new as(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let o=this.toMat2(),n=t.getRotation(),s=t.getScale();o=zs.fromMat2(o).scale(s.x,s.y).rotate(n).toMat2();let a=as.fromMat2(o);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return Yt.fromPoints(this.center.sub($(this.radiusX,this.radiusY)),this.center.add($(this.radiusX,this.radiusY)));{let t=to(this.angle),o=Math.cos(t),n=Math.sin(t),s=this.radiusX*o,a=this.radiusX*n,r=this.radiusY*n,l=this.radiusY*o,c=Math.sqrt(s*s+r*r),d=Math.sqrt(a*a+l*l);return Yt.fromPoints(this.center.sub($(c,d)),this.center.add($(c,d)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new as(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return Su(this,t)}contains(t){t=t.sub(this.center);let o=to(this.angle),n=Math.cos(o),s=Math.sin(o),a=t.x*n+t.y*s,r=-t.x*s+t.y*n;return a*a/(this.radiusX*this.radiusX)+r*r/(this.radiusY*this.radiusY)<1}raycast(t,o){return Du(t,o,this)}random(){return this.center}};function Iu(e,t,o,n){let s=t.sub(e),a=n.sub(o),r=s.cross(a);return r<1e-5&&r>-1e-5||(r=o.sub(e).cross(a)/r,r<0||r>1)?null:e.add(s.scale(r))}var xo=class Hs{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new Hs(this.pts.map(o=>t.multVec2(o)))}bbox(){let t=$(Number.MAX_VALUE),o=$(-Number.MAX_VALUE);for(let n of this.pts)t.x=Math.min(t.x,n.x),o.x=Math.max(o.x,n.x),t.y=Math.min(t.y,n.y),o.y=Math.max(o.y,n.y);return Yt.fromPoints(t,o)}area(){let t=0,o=this.pts.length;for(let n=0;n<o;n++){let s=this.pts[n],a=this.pts[(n+1)%o];t+=s.x*a.y*.5,t-=a.x*s.y*.5}return Math.abs(t)}clone(){return new Hs(this.pts.map(t=>t.clone()))}collides(t){return Au(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Tu(t,o,this)}random(){return $()}cut(t,o){new Co(t,o);let n=[],s=[],a=o.sub(t),r=this.pts[this.pts.length-1],l=r.sub(t),c=a.cross(l)>0;return this.pts.forEach(d=>{l=d.sub(t);let i=a.cross(l)>0;if(c!=i){let h=Iu(r,d,t,o);n.push(h),s.push(h),c=i}(i?n:s).push(d),r=d}),[n.length?new Hs(n):null,s.length?new Hs(s):null]}};function Pu(e,t,o,n){let s=n*n,a=1-n,r=a*a;return e.scale(r).add(t.scale(2*a*n)).add(o.scale(s))}function Bu(e,t,o,n){let s=1-n;return t.sub(e).scale(2*s).add(o.sub(t).scale(2*n))}function Lu(e,t,o,n){return o.sub(t.scale(2)).add(e).scale(2)}function Tr(e,t,o,n,s){let a=s*s,r=a*s,l=1-s,c=l*l,d=c*l;return e.scale(d).add(t.scale(3*c*s)).add(o.scale(3*l*a)).add(n.scale(r))}function zu(e,t,o,n,s){let a=s*s,r=1-s,l=r*r;return t.sub(e).scale(3*l).add(o.sub(t).scale(6*r*s)).add(n.sub(o).scale(3*a))}function Ou(e,t,o,n,s){let a=1-s;return o.sub(t.scale(2)).add(e).scale(6*a).add(n.sub(o.scale(2)).add(t).scale(6*s))}function Hu(e,t,o,n,s){let a=.5*(((-s+2)*s-1)*s),r=.5*((3*s-5)*s*s+2),l=.5*(((-3*s+4)*s+1)*s),c=.5*((s-1)*s*s);return e.scale(a).add(t.scale(r)).add(o.scale(l)).add(n.scale(c))}function Uu(e,t,o,n,s){let a=.5*((-3*s+4)*s-1),r=.5*((9*s-10)*s),l=.5*((-9*s+8)*s+1),c=.5*((3*s-2)*s);return e.scale(a).add(t.scale(r)).add(o.scale(l)).add(n.scale(c))}function Nu(e){let t=Jl(e),o=t(1);return n=>{let s=n*o,a=t(s,!0);return e(a)}}function Jl(e,t=10,o=10){let n=[0],s=[0],a=1/(t-1)/o,r=0,l=e(0),c=0;for(let d=1;d<t;d++){for(let i=0;i<o;i++){c+=a;let h=e(c),u=h.dist(l);r+=u,l=h}n[d]=r,s[d]=c}return s[t-1]=1,(d,i=!1)=>{if(i){let h=d;if(h<=0)return 0;if(h>=r)return 1;let u=0;for(;n[u+1]<h;)u++;let g=s[u],p=s[u+1],T=n[u],m=n[u+1],M=(h-T)/(m-T);return g+(p-g)*M}else{if(d<=0)return 0;if(d>=1)return n[t-1];let h=0;for(;s[h+1]<d;)h++;let u=s[h],g=s[h+1],p=n[h],T=n[h+1],m=(d-u)/(g-u);return p+(T-p)*m}}}function ai(e,t,o,n){let s=2*e+t-2*n+o,a=-3*e+3*n-2*t-o,r=t,l=e;return c=>{let d=c*c,i=d*c;return s*i+a*d+r*c+l}}function jl(e,t,o,n,s,a=ai){let r=a(t.x,(1-s)*(o.x-e.x),(1-s)*(n.x-t.x),o.x),l=a(t.y,(1-s)*(o.y-e.y),(1-s)*(n.y-t.y),o.y);return c=>new oe(r(c),l(c))}function Ui(e,t,o,n,s=ai){return jl(e,t,o,n,.5,s)}function _u(e,t,o,n,s=ai){return Ui(n.add(e.sub(t).scale(6)),e,n,e.add(n.sub(o).scale(6)),s)}function Xu(e,t,o,n,s,a,r,l=ai){let c=l(t.x,.5*(1-s)*(1+r)*(1+a)*(t.x-e.x)+.5*(1-s)*(1-r)*(1-a)*(o.x-t.x),.5*(1-s)*(1+r)*(1-a)*(o.x-t.x)+.5*(1-s)*(1-r)*(1+a)*(n.x-o.x),o.x),d=l(t.y,.5*(1-s)*(1+r)*(1+a)*(t.y-e.y)+.5*(1-s)*(1-r)*(1-a)*(o.y-t.y),.5*(1-s)*(1+r)*(1-a)*(o.y-t.y)+.5*(1-s)*(1-r)*(1+a)*(n.y-o.y),o.y);return i=>new oe(c(i),d(i))}function Fu(e,t,o,n){let s=2*e+t-2*n+o,a=-3*e+3*n-2*t+o,r=t;return l=>{let c=l*l;return 3*s*c+2*a*l+r}}function Ds(e){return 0<=e&&e<=1}function xa(e,t){return Math.abs(e-t)<=Number.EPSILON}function Cs(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Yu(e,t,o,n){let s=3*e-6*t+3*o,a=-3*e+3*t,r=e,l=-e+3*t-3*o+n;if(xa(l,0)){if(xa(s,0))return xa(a,0)?[]:[-r/a].filter(Ds);let m=Math.sqrt(a*a-4*s*r),M=2*s;return[(m-a)/M,(-a-m)/M].filter(Ds)}s/=l,a/=l,r/=l;let c=(3*a-s*s)/3,d=c/3,i=(2*s*s*s-9*s*a+27*r)/27,h=i/2,u=h*h+d*d*d;if(u<0){let m=-c/3,M=m*m*m,P=Math.sqrt(M),f=-i/(2*P),_=f<-1?-1:f>1?1:f,B=Math.acos(_),b=2*Cs(P),S=b*Math.cos(B/3)-s/3,E=b*Math.cos((B+2*Math.PI)/3)-s/3,C=b*Math.cos((B+4*Math.PI)/3)-s/3;return[S,E,C].filter(Ds)}if(u===0){let m=h<0?Cs(-h):-Cs(h),M=2*m-s/3,P=-m-s/3;return[M,P].filter(Ds)}let g=Math.sqrt(u),p=Cs(g-h),T=Cs(g+h);return[p-T-s/3].filter(Ds)}function qu(e,t,o,n,s){let a=Yu(e.x-s,t.x-s,o.x-s,n.x-s);return a.length>0?Tr(e,t,o,n,a[0]).y:NaN}function Gu(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return o=>{if(o<=0||e.length==1||o<=e[0].x)return e[0].y;for(let n=0;n<t;n++)if(e[n].x>=o)return en(o,e[n-1].x,e[n].x,e[n-1].y,e[n].y);return e[e.length-1].y}}function Ku(e,t){return o=>qu($(0,0),e,t,$(1,1),o)}function Vu(e,t="jump-end"){let o=1/e,n=t=="jump-start"||t=="jump-both",s=t=="jump-end"||t=="jump-both",a=1/(e+(s?1:0)),r=n?a:0;return l=>{let c=Math.floor(l/o);return r+c*a}}function Wu(e,t){let o=Number.MAX_VALUE,n={normal:$(0),distance:0};for(let s of[e,t])for(let a=0;a<s.pts.length;a++){let r=s.pts[a],l=s.pts[(a+1)%s.pts.length].sub(r).normal().unit(),c=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let g=0;g<e.pts.length;g++){let p=e.pts[g].dot(l);c=Math.min(c,p),d=Math.max(d,p)}let i=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let g=0;g<t.pts.length;g++){let p=t.pts[g].dot(l);i=Math.min(i,p),h=Math.max(h,p)}let u=Math.min(d,h)-Math.max(c,i);if(u<0)return null;if(u<Math.abs(o)){let g=h-c,p=i-d;o=Math.abs(g)<Math.abs(p)?g:p,n.normal=l,n.distance=o}}return n}function Zl(e,t,o){return(t.x-e.x)*(o.y-e.y)-(t.y-e.y)*(o.x-e.x)>=0}function $u(e){let t=0,o=e[e.length-1];for(let n=0;n<e.length;n++)t+=(e[n].x-o.x)*(e[n].y+o.y),o=e[n];return t<0}function wa(e,t,o,n){let s=n.x-o.x,a=n.y-o.y,r=s*(e.y-o.y)-a*(e.x-o.x),l=s*(t.y-o.y)-a*(t.x-o.x);return r*l>=0}function Ju(e,t,o,n){return wa(e,t,o,n)&&wa(e,o,t,n)&&wa(e,n,t,o)}function ju(e,t,o,n){for(let s of e)if(s!==t&&s!==o&&s!==n&&Ju(s,t,o,n))return!0;return!1}function Zu(e,t,o,n){return Zl(e,t,o)&&!ju(n,e,t,o)}function Ql(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],o=[],n=0;for(let h=0;h<e.length;h++){let u=e[n],g=e[h];(g.x<u.x||g.x==u.x&&g.y<u.y)&&(n=n),t[h]=h+1,o[h]=h-1}t[t.length-1]=0,o[0]=o.length-1,$u(e)||([t,o]=[o,t]);let s=[];for(let h=0;h<e.length;++h)Zl(e[o[h]],e[h],e[t[h]])||s.push(e[h]);let a=[],r=e.length,l=1,c=0,d,i;for(;r>3;){d=t[l],i=o[l];let h=e[i],u=e[l],g=e[d];if(Zu(h,u,g,s))a.push([h,u,g]),t[i]=d,o[d]=i,s.splice(s.indexOf(u),1),--r,c=0;else if(++c>r)return[];l=d}return d=t[l],i=o[l],a.push([e[i],e[l],e[d]]),a}function Qu(e){if(e.length<3)return!1;let t=e.length-2,o=e.length-1,n=0,s=e[o].sub(e[t]),a=e[n].sub(e[o]),r=s.cross(a);for(;n+1<e.length;)if(t=o,o=n,n++,s=e[o].sub(e[t]),a=e[n].sub(e[o]),s.cross(a)*r<0)return!1;return!0}var kl=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ia="topleft",ku="monospace",Ni="monospace",qa="linear",Dr=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],e0=Dr.reduce((e,t)=>e+t.size,0),ed=2048,t0=ed*4*e0,o0=ed*6,n0=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,s0=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Ga=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Ka=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,i0=new Set(["id","require"]),a0=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),xc=200,r0=640,c0=65536,td=Symbol.for("kaplay.cancel"),od=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Qn=class nd{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let o=new nd(()=>t.forEach(n=>n.cancel()));return Object.defineProperty(o,"paused",{get:()=>t[0].paused,set:n=>t.forEach(s=>s.paused=n)}),o.paused=!1,o}static replace(t,o){return t.cancel=()=>o.cancel(),o.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>o.paused,set:n=>o.paused=n}),t}},yo=class{cancellers=new WeakMap;handlers=new od;add(e){function t(...s){if(!n.paused)return e(...s)}let o=this.handlers.pushd(t),n=new Qn(o);return this.cancellers.set(t,o),n}addOnce(e){let t=this.add((...o)=>{t.cancel(),e(...o)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let o=t(...e),n;o===td&&(n=this.cancellers.get(t))&&n()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},js=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new yo),this.handlers[e].add(t)}onOnce(e,t){let o=this.on(e,(...n)=>{o.cancel(),t(...n)});return o}next(e){return new Promise(t=>{this.onOnce(e,(...o)=>t(o[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},l0=e=>e[0]instanceof vt,d0=e=>e[0]instanceof oe,h0=e=>typeof e[0]=="number",sd=class{_items;_compareFn;constructor(e=(t,o)=>t<o){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function u0(e){let t=window.atob(e),o=t.length,n=new Uint8Array(o);for(let s=0;s<o;s++)n[s]=t.charCodeAt(s);return n.buffer}function f0(e){return u0(e.split(",")[1])}function Cr(e,t){let o=document.createElement("a");o.href=t,o.download=e,o.click()}function id(e,t){Cr(e,"data:text/plain;charset=utf-8,"+t)}function p0(e,t){id(e,JSON.stringify(t))}function wc(e,t){let o=URL.createObjectURL(t);Cr(e,o),URL.revokeObjectURL(o)}var ad=e=>e.match(/^data:\w+\/\w+;base64,.+/),g0=e=>e.split(".").slice(0,-1).join(".");function Rr(e,t){if(e===t)return!0;let o=typeof e,n=typeof t;if(o!==n)return!1;if(o==="object"&&n==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let s=Object.keys(e),a=Object.keys(t);if(s.length!==a.length)return!1;for(let r of s){let l=e[r],c=t[r];if(!Rr(l,c))return!1}return!0}return!1}var bc=new Set,m0=e=>e instanceof Error?e.message:String(e);function y0(e){bc.has(e)||(bc.add(e),console.warn(e))}function xs(e,t){y0(`${e} is deprecated. Use ${t} instead.`)}function Va(e,t){return Number(e.toFixed(t))}function Kt(e,t){return(...o)=>{let n=o.length;if(n===e.length)return e(...o);if(n===t.length)return t(...o)}}var x0=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function w0(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],o=0,n=0;for(;o<e.length;){if(n+=b0(o+n,e),D0(e[o+n])&&n++,S0(e[o+n])&&n++,M0(e[o+n])&&n++,C0(e[o+n])){n++;continue}t.push(e.substring(o,o+n)),o+=n,n=0}return t}function b0(e,t){let o=t[e];if(!v0(o)||e===t.length-1)return 1;let n=o+t[e+1],s=t.substring(e+2,e+5);return vc(n)&&vc(s)?4:E0(n)&&T0(s)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:A0(s)?4:2}function v0(e){return e&&kn(e[0].charCodeAt(0),55296,56319)}function vc(e){return kn(Ir(e),127462,127487)}function E0(e){return kn(Ir(e),127988,127988)}function A0(e){return kn(Ir(e),127995,127999)}function S0(e){return typeof e=="string"&&kn(e.charCodeAt(0),65024,65039)}function M0(e){return typeof e=="string"&&kn(e.charCodeAt(0),8400,8447)}function T0(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&kn(t,917504,917631)}function D0(e){return typeof e=="string"&&x0.includes(e.charCodeAt(0))}function C0(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Ir(e){let t=e.charCodeAt(0)-55296,o=e.charCodeAt(1)-56320;return(t<<10)+o+65536}function kn(e,t,o){return e>=t&&e<=o}var Po=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,Jo=(e,t)=>Array.isArray(t)?t.some(o=>e.has(o)):e.has(t),mi=(e,t,o)=>{e.has(t)?e.get(t)?.push(o):e.set(t,[o])},R0=(()=>{let e=0;return()=>e++})(),I0={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function rd(){let e=x.globalOpt.pixelDensity??1,t=x.globalOpt.width,o=x.globalOpt.height,n=x.gfx.ggl.gl.drawingBufferWidth,s=x.gfx.ggl.gl.drawingBufferHeight,a=n/e,r=s/e,l=0,c=0,d=a,i=r;if(x.globalOpt.letterbox){if(!t||!o)throw new Error("Letterboxing requires width and height defined.");let h=a/r,u=t/o;if(h>u){let g=r*u;l=(a-g)/2,d=g}else{let g=a/u;i=g,c=(r-g)/2}}if(x.globalOpt.stretch&&(!x.globalOpt.width||!x.globalOpt.height))throw new Error("Stretching requires width and height defined.");x.gfx.viewport={x:l,y:c,width:d,height:i,scale:(x.gfx.viewport.width+x.gfx.viewport.height)/(x.gfx.width+x.gfx.height)}}function P0(e){return new oe(e.x*x.gfx.viewport.width/x.gfx.width,e.y*x.gfx.viewport.height/x.gfx.height)}function cn(e){return new oe((e.x-x.gfx.viewport.x)*x.gfx.width/x.gfx.viewport.width,(e.y-x.gfx.viewport.y)*x.gfx.height/x.gfx.viewport.height)}var B0=()=>Un.lastInputDevice,L0=()=>{let e=Un.buttons;for(let t in e){let o=e[t].keyboard&&[e[t].keyboard].flat(),n=e[t].keyboardCode&&[e[t].keyboardCode].flat(),s=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();o&&o.forEach(r=>{mi(Un.buttonsByKey,r,t)}),n&&n.forEach(r=>{mi(Un.buttonsByKeyCode,r,t)}),s&&s.forEach(r=>{mi(Un.buttonsByGamepad,r,t)}),a&&a.forEach(r=>{mi(Un.buttonsByMouse,r,t)})}},Gs=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},z0=class{buttonState=new Gs;stickState=new Map},O0=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,o)=>t+o)/this.dts.length)),this.dts=[])}},Un,Ec=I0,H0=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new O0,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new oe(0),mouseDeltaPos:new oe(0),keyState:new Gs,mouseState:new Gs,mergedGamepadState:new z0,gamepadStates:new Map,lastInputDevice:null,buttonState:new Gs,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new js}},U0=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=H0(e);Un=t,L0();function o(){return t.dt*t.timeScale}function n(){return t.fixedDt*t.timeScale}function s(){return t.restDt*t.timeScale}function a(){return t.isHidden}function r(){return t.time}function l(){return t.fpsCounter.fps}function c(){return t.numFrames}function d(){return t.canvas.toDataURL()}function i(L){t.canvas.style.cursor=L}function h(){return t.canvas.style.cursor}function u(L){if(L)try{let K=t.canvas.requestPointerLock();K?.catch&&K.catch(ee=>console.error(ee))}catch(K){console.error(K)}else document.exitPointerLock()}function g(){return!!document.pointerLockElement}function p(L){L.requestFullscreen?L.requestFullscreen():L.webkitRequestFullscreen&&L.webkitRequestFullscreen()}function T(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function m(L=!0){L?p(t.canvas):T()}function M(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function P(){t.stopped=!0;let L=Object.entries(Ge),K=Object.entries(Dt),ee=Object.entries(xe);for(let[ue,nt]of L)t.canvas.removeEventListener(ue,nt);for(let[ue,nt]of K)document.removeEventListener(ue,nt);for(let[ue,nt]of ee)window.removeEventListener(ue,nt);ot.disconnect()}function f(L,K){t.loopID!==null&&cancelAnimationFrame(t.loopID);let ee=0,ue=0,nt=st=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(nt);return}let Lt=st/1e3,ct=Math.min(Lt-t.realTime,.25),bt=e.maxFPS?1/e.maxFPS:0;if(t.realTime=Lt,ue+=ct,ue>bt){if(!t.skipTime){for(ee+=ue,t.dt=t.fixedDt,t.restDt=0;ee>t.fixedDt;)ee-=t.fixedDt,ee<t.fixedDt&&(t.restDt=ee),L();t.restDt=ee,t.dt=ue,t.time+=o(),t.fpsCounter.tick(t.dt)}ue=0,t.skipTime=!1,t.numFrames++,K(ht,Bt)}t.loopID=requestAnimationFrame(nt)};nt(0)}function _(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function B(){return t.mousePos.clone()}function b(){return t.mouseDeltaPos.clone()}function S(L="left"){return t.mouseState.pressed.has(L)}function E(L="left"){return t.mouseState.down.has(L)}function C(L="left"){return t.mouseState.released.has(L)}function A(){return t.isMouseMoved}function z(L){return L===void 0?t.keyState.pressed.size>0:Jo(t.keyState.pressed,L)}function R(L){return L===void 0?t.keyState.pressedRepeat.size>0:Jo(t.keyState.pressedRepeat,L)}function Y(L){return L===void 0?t.keyState.down.size>0:Jo(t.keyState.down,L)}function U(L){return L===void 0?t.keyState.released.size>0:Jo(t.keyState.released,L)}function N(L){return L===void 0?t.mergedGamepadState.buttonState.pressed.size>0:Jo(t.mergedGamepadState.buttonState.pressed,L)}function H(L){return L===void 0?t.mergedGamepadState.buttonState.down.size>0:Jo(t.mergedGamepadState.buttonState.down,L)}function I(L){return L===void 0?t.mergedGamepadState.buttonState.released.size>0:Jo(t.mergedGamepadState.buttonState.released,L)}function F(L){return L===void 0?t.buttonState.pressed.size>0:Jo(t.buttonState.pressed,L)}function V(L){return L===void 0?t.buttonState.down.size>0:Jo(t.buttonState.down,L)}function j(L){return L===void 0?t.buttonState.released.size>0:Jo(t.buttonState.released,L)}function ce(L){return t.buttons?.[L]}function ie(L,K){t.buttons[L]={...t.buttons[L],...K}}function ne(L){t.buttonState.press(L),t.events.trigger("buttonPress",L)}function se(L){t.buttonState.release(L),t.events.trigger("buttonRelease",L)}function ge(L){return t.events.on("resize",L)}let ve=Kt(L=>t.events.on("keyDown",L),(L,K)=>t.events.on("keyDown",ee=>Po(L,ee)&&K(ee))),Oe=Kt(L=>t.events.on("keyPress",K=>L(K)),(L,K)=>t.events.on("keyPress",ee=>Po(L,ee)&&K(ee))),Ee=Kt(L=>t.events.on("keyPressRepeat",L),(L,K)=>t.events.on("keyPressRepeat",ee=>Po(L,ee)&&K(ee))),Ne=Kt(L=>t.events.on("keyRelease",L),(L,K)=>t.events.on("keyRelease",ee=>Po(L,ee)&&K(ee))),et=Kt(L=>t.events.on("mouseDown",K=>L(K)),(L,K)=>t.events.on("mouseDown",ee=>Po(L,ee)&&K(ee))),Te=Kt(L=>t.events.on("mousePress",K=>L(K)),(L,K)=>t.events.on("mousePress",ee=>Po(L,ee)&&K(ee))),Mt=Kt(L=>t.events.on("mouseRelease",K=>L(K)),(L,K)=>t.events.on("mouseRelease",ee=>ee===L&&K(ee)));function fe(L){return t.events.on("mouseMove",()=>L(B(),b()))}function Ce(L){return t.events.on("charInput",L)}function le(L){return t.events.on("touchStart",L)}function Re(L){return t.events.on("touchMove",L)}function Xe(L){return t.events.on("touchEnd",L)}function Se(L){return t.events.on("scroll",L)}function it(L){return t.events.on("hide",L)}function We(L){return t.events.on("show",L)}let Et=Kt(L=>t.events.on("gamepadButtonPress",(K,ee)=>L(K,ee)),(L,K)=>t.events.on("gamepadButtonPress",(ee,ue)=>Po(L,ee)&&K(ee,ue))),Ct=Kt(L=>t.events.on("gamepadButtonDown",(K,ee)=>L(K,ee)),(L,K)=>t.events.on("gamepadButtonDown",(ee,ue)=>Po(L,ee)&&K(ee,ue))),Pe=Kt(L=>t.events.on("gamepadButtonRelease",(K,ee)=>L(K,ee)),(L,K)=>t.events.on("gamepadButtonRelease",(ee,ue)=>Po(L,ee)&&K(ee,ue)));function Fe(L,K){return t.events.on("gamepadStick",(ee,ue,nt)=>ee===L&&K(ue,nt))}function Ae(L){t.events.on("gamepadConnect",L)}function Ie(L){t.events.on("gamepadDisconnect",L)}function Ye(L){return t.mergedGamepadState.stickState.get(L)||new oe(0)}function je(){return[...t.charInputted]}function lt(){return[...t.gamepads]}let dt=Kt(L=>t.events.on("buttonPress",K=>L(K)),(L,K)=>t.events.on("buttonPress",ee=>Po(L,ee)&&K(ee))),rt=Kt(L=>t.events.on("buttonDown",K=>L(K)),(L,K)=>t.events.on("buttonDown",ee=>Po(L,ee)&&K(ee))),gt=Kt(L=>t.events.on("buttonRelease",K=>L(K)),(L,K)=>t.events.on("buttonRelease",ee=>Po(L,ee)&&K(ee)));function ht(){t.events.trigger("input"),t.keyState.down.forEach(L=>t.events.trigger("keyDown",L)),t.mouseState.down.forEach(L=>t.events.trigger("mouseDown",L)),t.buttonState.down.forEach(L=>{t.events.trigger("buttonDown",L)}),Rt()}function Bt(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((L,K)=>{t.mergedGamepadState.stickState.set(K,new oe(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new oe(0),t.gamepadStates.forEach(L=>{L.buttonState.update(),L.stickState.forEach((K,ee)=>{L.stickState.set(ee,new oe(0))})})}function Tt(L){let K={index:L.index,isPressed:ee=>t.gamepadStates.get(L.index)?.buttonState.pressed.has(ee)||!1,isDown:ee=>t.gamepadStates.get(L.index)?.buttonState.down.has(ee)||!1,isReleased:ee=>t.gamepadStates.get(L.index)?.buttonState.released.has(ee)||!1,getStick:ee=>t.gamepadStates.get(L.index)?.stickState.get(ee)||$()};return t.gamepads.push(K),t.gamepadStates.set(L.index,{buttonState:new Gs,stickState:new Map([["left",new oe(0)],["right",new oe(0)]])}),K}function yt(L){t.gamepads=t.gamepads.filter(K=>K.index!==L.index),t.gamepadStates.delete(L.index)}function Rt(){for(let L of navigator.getGamepads())L&&!t.gamepadStates.has(L.index)&&Tt(L);for(let L of t.gamepads){let K=navigator.getGamepads()[L.index];if(!K)continue;let ee=(e.gamepads??{})[K.id]||Ec[K.id]||Ec.default,ue=t.gamepadStates.get(L.index);if(ue){for(let nt=0;nt<K.buttons.length;nt++){let st=ee.buttons[nt],Lt=K.buttons[nt],ct=t.buttonsByGamepad.has(st);if(Lt.pressed){if(ue.buttonState.down.has(st)){t.events.trigger("gamepadButtonDown",st,L);continue}t.lastInputDevice="gamepad",ct&&t.buttonsByGamepad.get(st)?.forEach(bt=>{t.buttonState.press(bt),t.events.trigger("buttonPress",bt)}),t.mergedGamepadState.buttonState.press(st),ue.buttonState.press(st),t.events.trigger("gamepadButtonPress",st,L)}else ue.buttonState.down.has(st)&&(ct&&t.buttonsByGamepad.get(st)?.forEach(bt=>{t.buttonState.release(bt),t.events.trigger("buttonRelease",bt)}),t.mergedGamepadState.buttonState.release(st),ue.buttonState.release(st),t.events.trigger("gamepadButtonRelease",st,L))}for(let nt in ee.sticks){let st=ee.sticks[nt];if(!st)continue;let Lt=new oe(K.axes[st.x],K.axes[st.y]);ue.stickState.set(nt,Lt),t.mergedGamepadState.stickState.set(nt,Lt),t.events.trigger("gamepadStick",nt,Lt,L)}}}}let Ge={},Dt={},xe={},at=e.pixelDensity||1;Ge.mousemove=L=>{let K=cn(new oe(L.offsetX,L.offsetY)),ee=new oe(L.movementX,L.movementY);if(M()){let ue=t.canvas.width/at,nt=t.canvas.height/at,st=window.innerWidth,Lt=window.innerHeight,ct=st/Lt,bt=ue/nt;if(ct>bt){let ye=Lt/nt,we=(st-ue*ye)/2;K.x=en(L.offsetX-we,0,ue*ye,0,ue),K.y=en(L.offsetY,0,nt*ye,0,nt)}else{let ye=st/ue,we=(Lt-nt*ye)/2;K.x=en(L.offsetX,0,ue*ye,0,ue),K.y=en(L.offsetY-we,0,nt*ye,0,nt)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=K,t.mouseDeltaPos=ee,t.events.trigger("mouseMove")})};let ae=["left","middle","right","back","forward"];Ge.mousedown=L=>{t.events.onOnce("input",()=>{let K=ae[L.button];K&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(K)&&t.buttonsByMouse.get(K)?.forEach(ee=>{t.buttonState.press(ee),t.events.trigger("buttonPress",ee)}),t.mouseState.press(K),t.events.trigger("mousePress",K))})},Ge.mouseup=L=>{t.events.onOnce("input",()=>{let K=ae[L.button];K&&(t.buttonsByMouse.has(K)&&t.buttonsByMouse.get(K)?.forEach(ee=>{t.buttonState.release(ee),t.events.trigger("buttonRelease",ee)}),t.mouseState.release(K),t.events.trigger("mouseRelease",K))})};let Be=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),tt={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};Ge.keydown=L=>{Be.has(L.key)&&L.preventDefault(),t.events.onOnce("input",()=>{let K=tt[L.key]||L.key.toLowerCase(),ee=L.code;if(K===void 0)throw new Error(`Unknown key: ${L.key}`);K.length===1?(t.events.trigger("charInput",K),t.charInputted.push(K)):K==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),L.repeat?(t.keyState.pressRepeat(K),t.events.trigger("keyPressRepeat",K)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(K)&&t.buttonsByKey.get(K)?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.buttonsByKeyCode.has(ee)&&t.buttonsByKeyCode.get(ee)?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.keyState.press(K),t.events.trigger("keyPressRepeat",K),t.events.trigger("keyPress",K))})},Ge.keyup=L=>{t.events.onOnce("input",()=>{let K=tt[L.key]||L.key.toLowerCase(),ee=L.code;t.buttonsByKey.has(K)&&t.buttonsByKey.get(K)?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.buttonsByKeyCode.has(ee)&&t.buttonsByKeyCode.get(ee)?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.keyState.release(K),t.events.trigger("keyRelease",K)})},Ge.touchstart=L=>{L.preventDefault(),t.events.onOnce("input",()=>{let K=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=cn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),K.forEach(ue=>{t.events.trigger("touchStart",cn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},Ge.touchmove=L=>{L.preventDefault(),t.events.onOnce("input",()=>{let K=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let ue=t.mousePos;t.mousePos=cn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.mouseDeltaPos=t.mousePos.sub(ue),t.events.trigger("mouseMove")}K.forEach(ue=>{t.events.trigger("touchMove",cn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},Ge.touchend=L=>{t.events.onOnce("input",()=>{let K=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=cn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.mouseDeltaPos=new oe(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),K.forEach(ue=>{t.events.trigger("touchEnd",cn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},Ge.touchcancel=L=>{t.events.onOnce("input",()=>{let K=[...L.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=cn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),K.forEach(ue=>{t.events.trigger("touchEnd",cn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},Ge.wheel=L=>{L.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new oe(L.deltaX,L.deltaY))})},Ge.contextmenu=L=>L.preventDefault(),Dt.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},xe.gamepadconnected=L=>{let K=Tt(L.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",K)})},xe.gamepaddisconnected=L=>{let K=lt().filter(ee=>ee.index===L.gamepad.index)[0];yt(L.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",K)})};for(let[L,K]of Object.entries(Ge))t.canvas.addEventListener(L,K);for(let[L,K]of Object.entries(Dt))document.addEventListener(L,K);for(let[L,K]of Object.entries(xe))window.addEventListener(L,K);let ot=new ResizeObserver(L=>{for(let K of L)if(K.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return ot.observe(t.canvas),{state:t,dt:o,fixedDt:n,restDt:s,time:r,run:f,canvas:t.canvas,fps:l,numFrames:c,quit:P,isHidden:a,setFullscreen:m,isFullscreen:M,setCursor:i,screenshot:d,getGamepads:lt,getCursor:h,setCursorLocked:u,isCursorLocked:g,isTouchscreen:_,mousePos:B,mouseDeltaPos:b,isKeyDown:Y,isKeyPressed:z,isKeyPressedRepeat:R,isKeyReleased:U,isMouseDown:E,isMousePressed:S,isMouseReleased:C,isMouseMoved:A,isGamepadButtonPressed:N,isGamepadButtonDown:H,isGamepadButtonReleased:I,getGamepadStick:Ye,isButtonPressed:F,isButtonDown:V,isButtonReleased:j,setButton:ie,getButton:ce,pressButton:ne,releaseButton:se,charInputted:je,onResize:ge,onKeyDown:ve,onKeyPress:Oe,onKeyPressRepeat:Ee,onKeyRelease:Ne,onMouseDown:et,onMousePress:Te,onMouseRelease:Mt,onMouseMove:fe,onCharInput:Ce,onTouchStart:le,onTouchMove:Re,onTouchEnd:Xe,onScroll:Se,onHide:it,onShow:We,onGamepadButtonDown:Ct,onGamepadButtonPress:Et,onGamepadButtonRelease:Pe,onGamepadStick:Fe,onGamepadConnect:Ae,onGamepadDisconnect:Ie,onButtonPress:dt,onButtonDown:rt,onButtonRelease:gt,getLastInputDeviceType:B0,events:t.events}};function io(){return x.app.dt()}function Wa(){return x.app.fixedDt()}function $a(){return x.app.restDt()}var N0=new oe(-1,-1),_0=new oe(0,-1),X0=new oe(1,-1),F0=new oe(-1,0),Y0=new oe(0,0),q0=new oe(1,0),G0=new oe(-1,1),K0=new oe(0,1),V0=new oe(1,1);function ws(e){switch(e){case"topleft":return N0;case"top":return _0;case"topright":return X0;case"left":return F0;case"center":return Y0;case"right":return q0;case"botleft":return G0;case"bot":return K0;case"botright":return V0;default:return e}}function W0(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function $0(e){return e.createBuffer(1,1,44100)}var yi=2.5949095,Ac=1.70158+1,Sc=2*Math.PI/3,Mc=2*Math.PI/4.5,Ci={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>Ac*e*e*e-1.70158*e*e,easeOutBack:e=>1+Ac*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((yi+1)*2*e-yi)/2:(Math.pow(2*e-2,2)*((yi+1)*(e*2-2)+yi)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*Sc),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*Sc)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Mc))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Mc)/2+1,easeInBounce:e=>1-Ci.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Ci.easeOutBounce(1-2*e))/2:(1+Ci.easeOutBounce(2*e-1))/2},Zs=Ci;function J0(e,t,o){let n=[],s=t;for(n.push(s);s!==e;){if(s=o.get(s),s==null)return null;n.push(s)}return n.reverse()}function j0(e,t,o){let n=new sd((r,l)=>r.cost<l.cost);n.insert({cost:0,node:t});let s=new Map;s.set(t,t);let a=new Map;for(a.set(t,0);n.length!==0;){let r=n.remove()?.node;if(r===o)break;let l=e.getNeighbours(r);for(let c of l){let d=(a.get(r)||0)+e.getCost(r,c)+e.getHeuristic(c,o);(!a.has(c)||d<a.get(c))&&(a.set(c,d),n.insert({cost:d,node:c}),s.set(c,r))}}return J0(t,o,s)}var Z0=class{a;b;polygon;constructor(e,t,o){this.a=e,this.b=t,this.polygon=new WeakRef(o)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},Q0=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,o=0,n=0;for(let s of this._edges){s.polygon=new WeakRef(this);let a=s.a.x*s.b.y-s.a.y*s.b.x;t+=(s.a.x+s.b.x)*a,o+=(s.a.y+s.b.y)*a,n+=a}n/=2,this._centroid=$(t/(6*n),o/(6*n))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let o of this.edges)o.b.y>e.y!=o.a.y>e.y&&e.x<(o.a.x-o.b.x)*(e.y-o.b.y)/(o.a.y-o.b.y)+o.b.x&&(t=!t);return t}},k0=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let o=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[o]}_findCommonEdge(e,t){for(let o of e.edges){let n=this._findEdge(o.b,o.a);if(n&&n.polygon.deref().id===t.id)return n}return null}addPolygon(e){let t=new Q0(this._polygons.length),o=e.map((n,s)=>new Z0(n,e[(s+1)%e.length],t));t.edges=o,this._polygons.push(t);for(let n of t.edges)this._addEdge(n);return t}addRect(e,t){let o=this._addPoint(e),n=this._addPoint(e.add(t.x,0)),s=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([o,n,s,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let o of this._polygons[e].edges){let n=this._findEdge(o.b,o.a);if(n){let s=n.polygon.deref();s&&t.push(s.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let o=this._polygons[e],n=this._polygons[t],s=o.centroid.x-n.centroid.x,a=o.centroid.y-n.centroid.y;return Math.sqrt(s*s+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:j0(this,e,t)}getWaypointPath(e,t,o){let n=o?.type||"centroids",s=this._getLocation(e),a=this._getLocation(t);if(s===void 0||a===void 0)return[];let r=this.getPath(s.id,a.id);if(!r)return[];if(n==="edges"){let l=[];for(let c=1;c<r.length;c++){let d=this._polygons[r[c-1]],i=this._polygons[r[c]],h=this._findCommonEdge(d,i);l.push(h.middle.add(i.centroid.sub(h.middle).unit().scale(4)))}return[e,...l,t]}else return[e,...r.slice(1,-1).map(l=>this._polygons[l].centroid),t]}};function Ks(e){let t=new sn;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function ef(e){return new oe(e.x/co()*2-1,-e.y/uo()*2+1)}function Us(e,t,o,n,s,a=1){n=to(n%360),s=to(s%360),s<=n&&(s+=Math.PI*2);let r=[],l=Math.ceil((s-n)/to(8)*a),c=(s-n)/l,d=$(Math.cos(n),Math.sin(n)),i=$(Math.cos(c),Math.sin(c));for(let h=0;h<=l;h++)r.push(e.add(t*d.x,o*d.y)),d=$(d.x*i.x-d.y*i.y,d.x*i.y+d.y*i.x);return r}function tf(...e){let t=Ht(...e),o=e[3]??1;x.gfx.bgColor=t,x.gfx.bgAlpha=o,x.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,o)}function of(){return x.gfx.bgColor?.clone?.()??null}function jt(...e){if(e[0]===void 0)return;let t=$(...e);t.x===0&&t.y===0||x.gfx.transform.translate(t)}function Bo(){x.gfx.transformStack.push(x.gfx.transform.clone())}function nf(e){x.gfx.transform=e.clone()}function Qs(...e){if(e[0]===void 0)return;let t=$(...e);t.x===1&&t.y===1||x.gfx.transform.scale(t)}function hs(e){e&&x.gfx.transform.rotate(e)}function Eo(){x.gfx.transformStack.length>0&&(x.gfx.transform=x.gfx.transformStack.pop())}function Lo(){x.gfx.renderer.flush()}function co(){return x.gfx.width}function uo(){return x.gfx.height}function cd(){return(x.gfx.viewport.width+x.gfx.viewport.height)/(x.gfx.width+x.gfx.height)}function _i(){return $(co()/2,uo()/2)}var sf=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,o,n){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.textures=[Cn.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=n;let s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get 2d context");this.c2d=s}addSingle(e){let t=Cn.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new Jt(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,o=e.height+this.padding*2;if(t>this.canvas.width||o>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+o>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(Cn.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let n=this.textures[this.textures.length-1],s=new oe(this.x+this.padding,this.y+this.padding);return this.x+=t,o>this.curHeight&&(this.curHeight=o),e instanceof ImageData?this.c2d.putImageData(e,s.x,s.y):this.c2d.drawImage(e,s.x,s.y),n.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:s,size:new oe(e.width,e.height),texture:n}),this.lastTextureId++,[n,new Jt(s.x/this.canvas.width,s.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function Ho(e){return typeof e!="string"||ad(e)?e:x.assets.urlPrefix+e}var Uo=class ld{loaded=!1;data=null;error=null;onLoadEvents=new yo;onErrorEvents=new yo;onFinishEvents=new yo;constructor(t){t.then(o=>{this.loaded=!0,this.data=o,this.onLoadEvents.trigger(o)}).catch(o=>{if(this.error=o,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(o);else throw o}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let o=new ld(Promise.resolve(t));return o.data=t,o.loaded=!0,o}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},ts=class{assets=new Map;lastUID=0;add(e,t){let o=e??this.lastUID+++"",n=new Uo(t);return this.assets.set(o,n),n}addLoaded(e,t){let o=e??this.lastUID+++"",n=Uo.loaded(t);return this.assets.set(o,n),n}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function Pr(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function aa(e){return Pr(e).then(t=>t.json())}function af(e){return Pr(e).then(t=>t.text())}function rf(e){return Pr(e).then(t=>t.arrayBuffer())}function cf(e){return e!==void 0&&(x.assets.urlPrefix=e),x.assets.urlPrefix}function lf(e,t){return x.assets.custom.add(e,aa(Ho(t)))}function ra(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((o,n)=>{t.onload=()=>o(t),t.onerror=()=>n(new Error(`Failed to load image from "${e}"`))})}function Gn(){let e=[x.assets.sprites,x.assets.sounds,x.assets.shaders,x.assets.fonts,x.assets.bitmapFonts,x.assets.custom];return e.reduce((t,o)=>t+o.progress(),0)/e.length}function dd(){return[x.assets.sprites,x.assets.sounds,x.assets.shaders,x.assets.fonts,x.assets.bitmapFonts,x.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function df(e){return x.assets.custom.get(e)??null}function Ja(e){return x.assets.custom.add(null,e)}var hf=(e,t)=>({urlPrefix:"",sprites:new ts,fonts:new ts,bitmapFonts:new ts,sounds:new ts,shaders:new ts,custom:new ts,music:{},packer:new sf(e,2048,2048,t),loaded:!1}),uf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Pn=class Ns{tex;frames=[new Jt(0,0,1,1)];anims={};slice9=null;constructor(t,o,n={},s=null){this.tex=t,o&&(this.frames=o),this.anims=n,this.slice9=s}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,o={}){return typeof t=="string"?Ns.fromURL(t,o):Promise.resolve(Ns.fromImage(t,o))}static fromImage(t,o={}){let[n,s]=o.singular?x.assets.packer.addSingle(t):x.assets.packer.add(t),a=o.frames?o.frames.map(r=>new Jt(s.x+r.x*s.w,s.y+r.y*s.h,r.w*s.w,r.h*s.h)):ud(o.sliceX||1,o.sliceY||1,s.x,s.y,s.w,s.h);return new Ns(n,a,o.anims,o.slice9)}static fromURL(t,o={}){return ra(t).then(n=>Ns.fromImage(n,o))}};function Ri(e){if(typeof e=="string"){let t=hd(e);if(t)return t;if(Gn()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Pn)return Uo.loaded(e);if(e instanceof Uo)return e;throw new Error(`Invalid sprite: ${e}`)}}function hd(e){return x.assets.sprites.get(e)??null}function Vs(e,t,o={sliceX:1,sliceY:1,anims:{}}){return t=Ho(t),Array.isArray(t)?t.some(n=>typeof n=="string")?x.assets.sprites.add(e,Promise.all(t.map(n=>typeof n=="string"?ra(n):Promise.resolve(n))).then(n=>Tc(n,o))):x.assets.sprites.addLoaded(e,Tc(t,o)):typeof t=="string"?x.assets.sprites.add(e,Pn.from(t,o)):x.assets.sprites.addLoaded(e,Pn.fromImage(t,o))}function ud(e=1,t=1,o=0,n=0,s=1,a=1){let r=[],l=s/e,c=a/t;for(let d=0;d<t;d++)for(let i=0;i<e;i++)r.push(new Jt(o+i*l,n+d*c,l,c));return r}function Tc(e,t={}){let o=document.createElement("canvas"),n=e[0].width,s=e[0].height;o.width=n*e.length,o.height=s;let a=o.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((l,c)=>{l instanceof ImageData?a.putImageData(l,c*n,0):a.drawImage(l,c*n,0)});let r=a.getImageData(0,0,e.length*n,s);return Pn.fromImage(r,{...t,sliceX:e.length,sliceY:1})}function ff(e="bean"){return Vs(e,uf)}function pf(e,t,o){t=Ho(t),o=Ho(o),typeof t=="string"&&!o&&(o=g0(t)+".json");let n=typeof o=="string"?aa(o):Promise.resolve(o);return x.assets.sprites.add(e,n.then(s=>{let a=s.meta.size,r=s.frames.map(c=>new Jt(c.frame.x/a.w,c.frame.y/a.h,c.frame.w/a.w,c.frame.h/a.h)),l={};for(let c of s.meta.frameTags)c.from===c.to?l[c.name]=c.from:l[c.name]={from:c.from,to:c.to,speed:10,loop:!0,pingpong:c.direction==="pingpong"};return Pn.from(t,{frames:r,anims:l})}))}var Ii=class{fontface;filter=qa;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??qa,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Ht(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function fd(e){if(!e)return fd(x.globalOpt.font??ku);if(typeof e=="string"){let t=gd(e),o=pd(e);if(t)return t.data??t;if(o)return o.data??o;if(document.fonts.check(`64px ${e}`))return e;if(Gn()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof Uo)return e.data?e.data:e;return e}function pd(e){return x.assets.fonts.get(e)??null}function gf(e,t,o={}){let n=Ho(t),s=new FontFace(e,typeof t=="string"?`url(${n})`:n);return document.fonts.add(s),x.assets.fonts.add(e,s.load().catch(a=>{throw new Error(`Failed to load font from "${n}": ${a}`)}).then(a=>new Ii(a,o)))}function mf(e,t,o,n){let s=e.width/t,a={},r=n.split("").entries();for(let[l,c]of r)a[c]=new Jt(l%s*t,Math.floor(l/s)*o,t,o);return{tex:e,map:a,size:o}}function gd(e){return x.assets.bitmapFonts.get(e)??null}function yf(e,t,o,n,s={}){let a=Ho(t);return x.assets.bitmapFonts.add(e,ra(a).then(r=>mf(Cn.fromImage(x.gfx.ggl,r,s),o,n,s.chars??kl)))}function xf(e,t){return t=Ho(t),x.assets.sprites.add(e,new Promise(async o=>{let n=typeof t=="string"?await aa(t):t,s=await Promise.all(n.frames.map(ra)),a=document.createElement("canvas");a.width=n.width,a.height=n.height*n.frames.length;let r=a.getContext("2d");if(!r)throw new Error("Failed to create canvas context");s.forEach((c,d)=>{r.drawImage(c,0,d*n.height)});let l=await Vs(null,a,{sliceY:n.frames.length,anims:n.anims});o(l)}))}var wf=class{ctx;glProgram;constructor(e,t,o,n){this.ctx=e,e.onDestroy(()=>this.free());let s=e.gl,a=s.createShader(s.VERTEX_SHADER),r=s.createShader(s.FRAGMENT_SHADER);if(!a||!r)throw new Error("Failed to create shader");s.shaderSource(a,t),s.shaderSource(r,o),s.compileShader(a),s.compileShader(r);let l=s.createProgram();if(this.glProgram=l,s.attachShader(l,a),s.attachShader(l,r),n.forEach((c,d)=>s.bindAttribLocation(l,d,c)),s.linkProgram(l),!s.getProgramParameter(l,s.LINK_STATUS)){let c=s.getShaderInfoLog(a);if(c)throw new Error("VERTEX SHADER "+c);let d=s.getShaderInfoLog(r);if(d)throw new Error("FRAGMENT SHADER "+d)}s.deleteShader(a),s.deleteShader(r)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let o in e){let n=e[o],s=t.getUniformLocation(this.glProgram,o);if(typeof n=="number")t.uniform1f(s,n);else if(n instanceof sn)t.uniformMatrix4fv(s,!1,new Float32Array(n.m));else if(n instanceof vt)t.uniform3f(s,n.r,n.g,n.b);else if(n instanceof oe)t.uniform2f(s,n.x,n.y);else if(Array.isArray(n))n[0],h0(n)?t.uniform1fv(s,n):d0(n)?t.uniform2fv(s,n.map(a=>[a.x,a.y]).flat()):l0(n)&&t.uniform3fv(s,n.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function Br(e,t=Ga,o=Ka){let n=n0.replace("{{user}}",t??Ga),s=s0.replace("{{user}}",o??Ka);try{return new wf(e,n,s,Dr.map(a=>a.name))}catch(a){let r=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,l=m0(a).match(r);if(!l?.groups)throw a;let c=Number(l.groups.line)-14,d=l.groups.msg.trim(),i=l.groups.type.toLowerCase();throw new Error(`${i} shader line ${c}: ${d}`)}}function bf(e){if(!e)return x.gfx.defShader;if(typeof e=="string"){let t=md(e);if(t)return t.data??t;if(Gn()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof Uo)return e.data?e.data:e;return e}function md(e){return x.assets.shaders.get(e)??null}function vf(e,t,o){return x.assets.shaders.addLoaded(e,Br(x.gfx.ggl,t,o))}function Ef(e,t,o){t=Ho(t),o=Ho(o);let n=a=>a?af(a):Promise.resolve(null),s=Promise.all([n(t),n(o)]).then(([a,r])=>Br(x.gfx.ggl,a,r));return x.assets.shaders.add(e,s)}var ks=class Pi{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((o,n)=>x.audio.ctx.decodeAudioData(t,o,n)).then(o=>new Pi(o))}static fromURL(t){return ad(t)?Pi.fromArrayBuffer(f0(t)):rf(t).then(o=>Pi.fromArrayBuffer(o))}};function Af(e){if(typeof e=="string"){let t=yd(e);if(t)return t;if(Gn()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof ks)return Uo.loaded(e);if(e instanceof Uo)return e;throw new Error(`Invalid sound: ${e}`)}}function yd(e){return x.assets.sounds.get(e)??null}function Sf(e,t){return t=Ho(t),x.assets.sounds.add(e,typeof t=="string"?ks.fromURL(t):ks.fromArrayBuffer(t))}function Mf(e,t){let o=Ho(t),n=new Audio(o);return n.preload="auto",x.assets.music[e]=o}function xd(e,t){return e=Ho(e),Ja(typeof t=="string"?new Promise((o,n)=>{aa(t).then(s=>{xd(e,s).then(o).catch(n)})}):Pn.from(e).then(o=>{let n={};for(let s in t){let a=t[s],r=o.frames[0],l=2048*r.w,c=2048*r.h,d=a.frames?a.frames.map(h=>new Jt(r.x+(a.x+h.x)/l*r.w,r.y+(a.y+h.y)/c*r.h,h.w/l*r.w,h.h/c*r.h)):ud(a.sliceX||1,a.sliceY||1,r.x+a.x/l*r.w,r.y+a.y/c*r.h,a.width/l*r.w,a.height/c*r.h),i=new Pn(o.tex,d,a.anims);x.assets.sprites.addLoaded(s,i),n[s]=i}return n}))}function Ln(e,t,o=!1,n,s,a={}){let r=n??x.gfx.defTex,l=s??x.gfx.defShader,c=bf(l);if(!c||c instanceof Uo)return;let d=x.gfx.fixed||o?x.gfx.transform:x.game.cam.transform.mult(x.gfx.transform),i=[];for(let h of e){let u=ef(d.multVec2(h.pos));i.push(u.x,u.y,h.uv.x,h.uv.y,h.color.r/255,h.color.g/255,h.color.b/255,h.opacity)}x.gfx.renderer.push(x.gfx.ggl.gl.TRIANGLES,i,t,c,r,a)}function Dn(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(Bo(),jt(e.pos),Qs(e.scale),hs(e.angle),jt(e.offset),e.fill!==!1){let o=e.color??vt.WHITE,n=e.pts.map((a,r)=>({pos:new oe(a.x,a.y),uv:e.uv?e.uv[r]:new oe(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(o):o,opacity:e.opacity??1})),s;e.triangulate?s=Ql(e.pts).map(a=>a.map(r=>e.pts.indexOf(r))).flat():s=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),Ln(n,e.indices??s,e.fixed,e.uv?e.tex:x.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&Lr({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),Eo()}}function wd(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,o=e.end??360,n=ws(e.anchor??"center").scale(new oe(-e.radiusX,-e.radiusY)),s=Us(n,e.radiusX,e.radiusY,t,o,e.resolution);s.unshift(n);let a=Object.assign({},e,{pts:s,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(s.length-1).fill(e.gradient[1])]}:{}});if(o-t>=360&&e.outline){e.fill!==!1&&Dn(Object.assign({},a,{outline:null})),Dn(Object.assign({},a,{pts:s.slice(1),fill:!1}));return}Dn(a)}function bs(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&wd(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function _s(e){let{p1:t,p2:o}=e;if(!t||!o)throw new Error('drawLine() requires properties "p1" and "p2".');let n=e.width||1,s=o.sub(t).unit().normal().scale(n*.5),a=[t.sub(s),t.add(s),o.add(s),o.sub(s)].map(r=>({pos:new oe(r.x,r.y),uv:new oe(0),color:e.color??vt.WHITE,opacity:e.opacity??1}));Ln(a,[0,1,3,1,2,3],e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Tf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||$(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let p=r.scale(-n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),T=Math.PI/p,m=c.scale(-1),M=Math.cos(T),P=Math.sin(T);for(let f=0;f<p;f++)o.push(i),o.push(i.sub(m)),m=$(m.x*M-m.y*P,m.x*P+m.y*M)}}for(let p=1;p<t.length;p++){if(i===t[p]||i.eq(t[p]))continue;d=i,i=t[p];let T=i.sub(d),m=T.len(),M=T.normal().scale(-n/m),P=r.cross(T);if(Math.abs(P)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(T)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=T,l=m,c=M;continue}let f=M.sub(c).cross(T)/P,_=c.add(r.scale(f));P>0?(o.push(d.add(_)),o.push(d.sub(c)),o.push(d.add(_)),o.push(d.sub(M))):(o.push(d.add(c)),o.push(d.sub(_)),o.push(d.add(M)),o.push(d.sub(_))),r=T,l=m,c=M}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let p=r.scale(n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),T=Math.PI/p,m=c.scale(1),M=Math.cos(T),P=Math.sin(T);for(let f=0;f<p;f++)m=$(m.x*M-m.y*P,m.x*P+m.y*M),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(p=>({pos:a.add(p),uv:$(),color:e.color||vt.WHITE,opacity:e.opacity??1})),u=[],g=0;for(let p=0;p<o.length-2;p+=2)u[g++]=p+1,u[g++]=p,u[g++]=p+2,u[g++]=p+2,u[g++]=p+3,u[g++]=p+1;s&&(u[g++]=o.length-1,u[g++]=o.length-2,u[g++]=0,u[g++]=0,u[g++]=1,u[g++]=o.length-1),Ln(h,u,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Df(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||$(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let p=r.scale(-n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),T=Math.PI/p,m=c.scale(-1),M=Math.cos(T),P=Math.sin(T);for(let f=0;f<p;f++)o.push(i),o.push(i.sub(m)),m=$(m.x*M-m.y*P,m.x*P+m.y*M)}}for(let p=1;p<t.length;p++){if(i===t[p]||i.eq(t[p]))continue;d=i,i=t[p];let T=i.sub(d),m=T.len(),M=T.normal().scale(-n/m),P=r.cross(T);if(Math.abs(P)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(T)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=T,l=m,c=M;continue}let f=M.sub(c).cross(T)/P,_=c.add(r.scale(f));if(P>0){let B=d.add(_),b=Math.max(n,10),S=to(c.angleBetween(M)/b),E=c,C=Math.cos(S),A=Math.sin(S);for(let z=0;z<b;z++)o.push(B),o.push(d.sub(E)),E=$(E.x*C-E.y*A,E.x*A+E.y*C)}else{let B=d.sub(_),b=Math.max(n,10),S=to(c.angleBetween(M)/b),E=c,C=Math.cos(S),A=Math.sin(S);for(let z=0;z<b;z++)o.push(d.add(E)),o.push(B),E=$(E.x*C-E.y*A,E.x*A+E.y*C)}r=T,l=m,c=M}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let p=r.scale(n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),T=Math.PI/p,m=c.scale(1),M=Math.cos(T),P=Math.sin(T);for(let f=0;f<p;f++)m=$(m.x*M-m.y*P,m.x*P+m.y*M),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(p=>({pos:a.add(p),uv:$(),color:e.color||vt.WHITE,opacity:e.opacity??1})),u=[],g=0;for(let p=0;p<o.length-2;p+=2)u[g++]=p+1,u[g++]=p,u[g++]=p+2,u[g++]=p+2,u[g++]=p+3,u[g++]=p+1;s&&(u[g++]=o.length-1,u[g++]=o.length-2,u[g++]=0,u[g++]=0,u[g++]=1,u[g++]=o.length-1),Ln(h,u,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Cf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||$(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let p=r.scale(-n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),T=Math.PI/p,m=c.scale(-1),M=Math.cos(T),P=Math.sin(T);for(let f=0;f<p;f++)o.push(i),o.push(i.sub(m)),m=$(m.x*M-m.y*P,m.x*P+m.y*M)}}for(let p=1;p<t.length;p++){if(i===t[p]||i.eq(t[p]))continue;d=i,i=t[p];let T=i.sub(d),m=T.len(),M=T.normal().scale(-n/m),P=r.cross(T);if(Math.abs(P)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(T)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=T,l=m,c=M;continue}let f=M.sub(c).cross(T)/P,_=c.add(r.scale(f));o.push(d.add(_)),o.push(d.sub(_)),r=T,l=m,c=M}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let p=r.scale(n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),T=Math.PI/p,m=c.scale(1),M=Math.cos(T),P=Math.sin(T);for(let f=0;f<p;f++)m=$(m.x*M-m.y*P,m.x*P+m.y*M),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(p=>({pos:a.add(p),uv:$(),color:e.color||vt.WHITE,opacity:e.opacity??1})),u=[],g=0;for(let p=0;p<o.length-2;p+=2)u[g++]=p+1,u[g++]=p,u[g++]=p+2,u[g++]=p+2,u[g++]=p+3,u[g++]=p+1;s&&(u[g++]=o.length-1,u[g++]=o.length-2,u[g++]=0,u[g++]=0,u[g++]=1,u[g++]=o.length-1),Ln(h,u,e.fixed,x.gfx.defTex,e.shader,e.uniform??void 0)}function Lr(e){let t=e.pts,o=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return Tf(e);case"round":return Df(e);case"miter":return Cf(e)}if(e.radius&&t.length>=3){_s(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let s=t[n],a=t[n+1];_s(Object.assign({},e,{p1:s,p2:a}))}_s(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let n=0;n<t.length-1;n++)_s(Object.assign({},e,{p1:t[n],p2:t[n+1]})),e.join!=="none"&&bs(Object.assign({},e,{pos:t[n],radius:o/2}))}}function bd(e,t){let o=t.segments??16,n=[];for(let s=0;s<=o;s++)n.push(e(s/o));Lr({pts:n,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function Rf(e){bd(t=>Tr(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var Cn=class vd{ctx;src=null;glTex;width;height;constructor(t,o,n,s={}){this.ctx=t;let a=t.gl,r=t.gl.createTexture();if(!r)throw new Error("Failed to create texture");this.glTex=r,t.onDestroy(()=>this.free()),this.width=o,this.height=n;let l={linear:a.LINEAR,nearest:a.NEAREST}[s.filter??t.opts.texFilter??"nearest"],c={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[s.wrap??"clampToEdge"];this.bind(),o&&n&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,o,n,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,c),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,o,n={}){let s=new vd(t,o.width,o.height,n);return s.update(o),s.src=o,s}update(t,o=0,n=0){let s=this.ctx.gl;this.bind(),s.texSubImage2D(s.TEXTURE_2D,0,o,n,s.RGBA,s.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Xi=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,o,n={}){this.ctx=e;let s=e.gl;e.onDestroy(()=>this.free()),this.tex=new Cn(e,t,o,n);let a=s.createFramebuffer(),r=s.createRenderbuffer();if(!a||!r)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=r,this.bind(),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t,o),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tex.glTex,0),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let o=this.width*4,n=new Uint8Array(o);for(let s=0;s<(this.height/2|0);s++){let a=s*o,r=(this.height-s-1)*o;n.set(t.subarray(a,a+o)),t.copyWithin(a,r,r+o),t.set(n,r)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},If=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,o,n){let s=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((r,l)=>r+l.size,0),this.maxVertices=o,this.maxIndices=n;let a=s.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),s.bufferData(s.ARRAY_BUFFER,o*4,s.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=s.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),s.bufferData(s.ELEMENT_ARRAY_BUFFER,n*4,s.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,o,n,s=null,a={}){(e!==this.curPrimitive||s!==this.curTex||n!==this.curShader||!Rr(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+o.length>this.maxIndices)&&this.flush();let r=this.vqueue.length/this.stride;for(let l of t)this.vqueue.push(l);for(let l of o)this.iqueue.push(l+r);this.curPrimitive=e,this.curShader=n,this.curTex=s,this.curUniform=a}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function On(e){let t=[],o=a=>{t.push(a),e(a)},n=()=>{t.pop(),e(s()??null)},s=()=>t[t.length-1];return[o,n,s]}function Pf(e,t={}){let o=[];function n(B){o.push(B)}function s(){o.forEach(b=>b());let B=e.getExtension("WEBGL_lose_context");B&&B.loseContext()}let a=null;function r(B){if(Rr(B,a))return;a=B;let b=B.reduce((S,E)=>S+E.size,0);B.reduce((S,E,C)=>(e.vertexAttribPointer(C,E.size,e.FLOAT,!1,b*4,S),e.enableVertexAttribArray(C),S+E.size*4),0)}let[l,c]=On(B=>e.bindTexture(e.TEXTURE_2D,B)),[d,i]=On(B=>e.bindBuffer(e.ARRAY_BUFFER,B)),[h,u]=On(B=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,B)),[g,p]=On(B=>e.bindFramebuffer(e.FRAMEBUFFER,B)),[T,m]=On(B=>e.bindRenderbuffer(e.RENDERBUFFER,B)),[M,P]=On(B=>{if(!B)return;let{x:b,y:S,w:E,h:C}=B;e.viewport(b,S,E,C)}),[f,_]=On(B=>e.useProgram(B));return M({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:n,destroy:s,pushTexture2D:l,popTexture2D:c,pushArrayBuffer:d,popArrayBuffer:i,pushElementArrayBuffer:h,popElementArrayBuffer:u,pushFramebuffer:g,popFramebuffer:p,pushRenderbuffer:T,popRenderbuffer:m,pushViewport:M,popViewport:P,pushProgram:f,popProgram:_,setVertexFormat:r}}var ba={};function Dc(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale($(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function ja(e){let t={},o="",n=[],s=String(e),a=r=>{n.length>0&&(t[o.length]=n.slice()),o+=r};for(;s!=="";){if(s[0]==="\\"){if(s.length===1)throw new Error("Styled text error: \\ at end of string");a(s[1]),s=s.slice(2);continue}if(s[0]==="["){let r=/^\[(\/)?(\w+?)\]/.exec(s);if(!r){a(s[0]),s=s.slice(1);continue}let[l,c,d]=r;if(c!==void 0){let i=n.pop();if(i!==d)throw i!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${i}], got [/${d}]`):new Error(`Styled text error: stray end tag [/${d}]`)}else n.push(d);s=s.slice(l.length);continue}a(s[0]),s=s.slice(1)}if(n.length>0)throw new Error(`Styled text error: unclosed tags ${n}`);return{charStyleMap:t,text:o}}function Kn(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=fd(e.font);if(!e.text||e.text===""||t instanceof Uo||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:o,text:n}=ja(e.text+""),s=w0(n);if(t instanceof Ii||typeof t=="string"){let f=t instanceof Ii?t.fontface.family:t,_=t instanceof Ii?{outline:t.outline,filter:t.filter}:{outline:null,filter:qa},B=ba[f]??{font:{tex:new Cn(x.gfx.ggl,2048,2048,{filter:_.filter}),map:{},size:64},cursor:new oe(0),maxHeight:0,outline:_.outline};ba[f]||(ba[f]=B),t=B.font;for(let b of s)if(!B.font.map[b]){let S=x.fontCacheC2d;if(!S)throw new Error("fontCacheC2d is not defined.");if(!x.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");S.clearRect(0,0,x.fontCacheCanvas.width,x.fontCacheCanvas.height),S.font=`${t.size}px ${f}`,S.textBaseline="top",S.textAlign="left",S.fillStyle="#ffffff";let E=S.measureText(b),C=Math.ceil(E.width);if(!C)continue;let A=Math.ceil(Math.abs(E.actualBoundingBoxAscent))+Math.ceil(Math.abs(E.actualBoundingBoxDescent));B.outline&&B.outline.width&&B.outline.color&&(S.lineJoin="round",S.lineWidth=B.outline.width*2,S.strokeStyle=B.outline.color.toHex(),S.strokeText(b,B.outline.width,B.outline.width),C+=B.outline.width*2,A+=B.outline.width*3),S.fillText(b,B.outline?.width??0,B.outline?.width??0);let z=S.getImageData(0,0,C,A);if(B.cursor.x+C>2048&&(B.cursor.x=0,B.cursor.y+=B.maxHeight,B.maxHeight=0,B.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(z,B.cursor.x,B.cursor.y),t.map[b]=new Jt(B.cursor.x,B.cursor.y,C,A),B.cursor.x+=C+1,B.maxHeight=Math.max(B.maxHeight,A)}}let a=e.size||t.size,r=$(e.scale??1).scale(a/t.size),l=e.lineSpacing??0,c=e.letterSpacing??0,d=0,i=0,h=0,u=[],g=[],p=0,T=null,m=0,M;for(;p<s.length;){let f=s[p];if(f===`
`)h+=a+l,u.push({width:d-c,chars:g}),T=null,m=0,d=0,g=[],M=void 0;else{let _=t.map[f];if(_){let B=_.w*r.x;e.width&&d+B>e.width&&(h+=a+l,T!=null&&(p-=g.length-T,f=s[p],_=t.map[f],B=_.w*r.x,g=g.slice(0,T-1),d=m),T=null,m=0,u.push({width:d-c,chars:g}),d=M??0,g=[]),g.push({tex:t.tex,width:_.w,height:_.h,quad:new Jt(_.x/t.tex.width,_.y/t.tex.height,_.w/t.tex.width,_.h/t.tex.height),ch:f,pos:new oe(d,h),opacity:e.opacity??1,color:e.color??vt.WHITE,scale:$(r),angle:0}),f===" "&&(T=g.length,m=d),e.indentAll&&M===void 0&&/\S/.test(f)&&(M=d),d+=B,i=Math.max(i,d),d+=c}}p++}u.push({width:d-c,chars:g}),h+=a,e.width&&(i=e.width);let P=[];for(let f=0;f<u.length;f++){let _=(i-u[f].width)*W0(e.align??"left");for(let B of u[f].chars){let b=t.map[B.ch],S=P.length+f;if(B.pos=B.pos.add(_,0).add(b.w*r.x*.5,b.h*r.y*.5),e.transform){let E=typeof e.transform=="function"?e.transform(S,B.ch):e.transform;E&&Dc(B,E)}if(o[S]){let E=o[S];for(let C of E){let A=e.styles?.[C],z=typeof A=="function"?A(S,B.ch):A;z&&Dc(B,z)}}P.push(B)}}return{width:i,height:h,chars:P,opt:e,renderedText:n}}function ei(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,n=ws(e.anchor||ia).scale(new oe(t,o).scale(-.5)),s=e.quad||new Jt(0,0,1,1),a=e.color||Ht(255,255,255),r=e.opacity??1,l=e.tex?.1/e.tex.width:0,c=e.tex?.1/e.tex.height:0,d=s.x+l,i=s.y+c,h=s.w-l*2,u=s.h-c*2;Bo(),jt(e.pos),hs(e.angle),Qs(e.scale),jt(n),Ln([{pos:new oe(-t/2,o/2),uv:new oe(e.flipX?d+h:d,e.flipY?i:i+u),color:a,opacity:r},{pos:new oe(-t/2,-o/2),uv:new oe(e.flipX?d+h:d,e.flipY?i+u:i),color:a,opacity:r},{pos:new oe(t/2,-o/2),uv:new oe(e.flipX?d:d+h,e.flipY?i+u:i),color:a,opacity:r},{pos:new oe(t/2,o/2),uv:new oe(e.flipX?d:d+h,e.flipY?i:i+u),color:a,opacity:r}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),Eo()}function Vn(e){Bo(),jt(e.opt.pos),hs(e.opt.angle),jt(ws(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{ei({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),Eo()}function zo(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,n=ws(e.anchor||ia).add(1,1).scale(new oe(t,o).scale(-.5)),s=[new oe(0,0),new oe(t,0),new oe(t,o),new oe(0,o)];if(e.radius){let a=Math.min(t,o)/2,r=Array.isArray(e.radius)?e.radius.map(l=>Math.min(a,l)):new Array(4).fill(Math.min(a,e.radius));s=[new oe(r[0],0),...r[1]?Us(new oe(t-r[1],r[1]),r[1],r[1],270,360):[$(t,0)],...r[2]?Us(new oe(t-r[2],o-r[2]),r[2],r[2],0,90):[$(t,o)],...r[3]?Us(new oe(r[3],o-r[3]),r[3],r[3],90,180):[$(0,o)],...r[0]?Us(new oe(r[0],r[0]),r[0],r[0],180,270):[]]}Dn(Object.assign({},e,{offset:n,pts:s,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function Sn(e){Lo();let t=x.gfx.width,o=x.gfx.height;x.gfx.width=x.gfx.viewport.width,x.gfx.height=x.gfx.viewport.height,e(),Lo(),x.gfx.width=t,x.gfx.height=o}function Cc(e,t){Sn(()=>{let o=$(8);Bo(),jt(e);let n=Kn({text:t,font:Ni,size:16,pos:o,color:Ht(255,255,255),fixed:!0}),s=n.width+o.x*2,a=n.height+o.x*2;e.x+s>=co()&&jt($(-s,0)),e.y+a>=uo()&&jt($(0,-a)),zo({width:s,height:a,color:Ht(0,0,0),radius:4,opacity:.8,fixed:!0}),Vn(n),Eo()})}function Ed(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return Dn(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Bf(){if(x.debug.inspect){let e=null;for(let t of x.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(x.game.root.drawInspect(),e){let t=[],o=e.inspect();for(let n in o)o[n]?t.push(`${o[n]}`):t.push(`${n}`);Cc(P0(x.k.mousePos()),t.join(`
`))}Cc($(8),`FPS: ${x.debug.fps()}`)}x.debug.paused&&Sn(()=>{Bo(),jt(co(),0),jt(-8,8);let e=32;zo({width:e,height:e,anchor:"topright",color:Ht(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)zo({width:4,height:e*.6,anchor:"center",pos:$(-e/3*t,e*.5),color:Ht(255,255,255),radius:2,fixed:!0});Eo()}),x.debug.timeScale!==1&&Sn(()=>{Bo(),jt(co(),uo()),jt(-8,-8);let e=8,t=Kn({text:x.debug.timeScale.toFixed(1),font:Ni,size:16,color:Ht(255,255,255),pos:$(-e),anchor:"botright",fixed:!0});zo({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Ht(0,0,0),opacity:.8,radius:4,fixed:!0});for(let o=0;o<2;o++){let n=x.debug.timeScale<1;Ed({p1:$(-t.width-e*(n?2:3.5),-e),p2:$(-t.width-e*(n?2:3.5),-e-t.height),p3:$(-t.width-e*(n?3.5:2),-e-t.height/2),pos:$(-o*e*1+(n?-e*.5:0),0),color:Ht(255,255,255),fixed:!0})}Vn(t),Eo()}),x.debug.curRecording&&Sn(()=>{Bo(),jt(0,uo()),jt(24,-24),bs({radius:12,color:Ht(255,0,0),opacity:Hl(0,1,x.app.time()*4),fixed:!0}),Eo()}),x.debug.showLog&&x.game.logs.length>0&&Sn(()=>{Bo(),jt(0,uo()),jt(8,-8);let e=8,t=[];for(let n of x.game.logs){let s="",a=n.msg instanceof Error?"error":"info";s+=`[time]${n.time.toFixed(2)}[/time]`,s+=" ",s+=`[${a}]${Za(n.msg)}[/${a}]`,t.push(s)}x.game.logs=x.game.logs.filter(n=>x.app.time()-n.time<(x.globalOpt.logTime||4));let o=Kn({text:t.join(`
`),font:Ni,pos:$(e,-e),anchor:"botleft",size:16,width:co()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Ht(127,127,127)},info:{color:Ht(255,255,255)},error:{color:Ht(255,0,127)}}});zo({width:o.width+e*2,height:o.height+e*2,anchor:"botleft",color:Ht(0,0,0),radius:4,opacity:.8,fixed:!0}),Vn(o),Eo()})}function Za(e,t=!1,o=new Set){if(o.has(e))return"<recursive>";var n="",s;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(n=["[",e.map(a=>Za(a,!0,o.union(new Set([e])))).join(", "),"]"].join(""),e=n),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(n+=e.constructor.name+" "),n+=["{",(s=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${Za(e[a],!0,o.union(new Set([e])))}`).join(", "))?` ${s} `:"","}"].join(""),e=n),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function Lf(){let e=x.game.cam,t=oe.fromAngle(so(0,360)).scale(e.shake);e.shake=So(e.shake,0,5*io()),e.transform=new sn().translate(_i()).scale(e.scale).rotate(e.angle).translate((e.pos??_i()).scale(-1).add(t)),x.game.root.draw(),Lo()}function zf(){let e=Gn();x.game.events.numListeners("loading")>0?x.game.events.trigger("loading",e):Sn(()=>{let t=co()/2,o=24,n=$(co()/2,uo()/2).sub($(t/2,o/2));zo({pos:$(0),width:co(),height:uo(),color:Ht(0,0,0)}),zo({pos:n,width:t,height:o,fill:!1,outline:{width:4}}),zo({pos:n,width:t*e,height:o})})}function Ad(e,t,o){let n=x.gfx.ggl.gl;Lo(),n.clear(n.STENCIL_BUFFER_BIT),n.enable(n.STENCIL_TEST),n.stencilFunc(n.NEVER,1,255),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),t(),Lo(),n.stencilFunc(o,1,255),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),e(),Lo(),n.disable(n.STENCIL_TEST)}function Of(e,t){let o=x.gfx.ggl.gl;Ad(e,t,o.EQUAL)}function Fi(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new Jt(0,0,1,1),o=e.tex.width*t.w,n=e.tex.height*t.h,s=new oe(1);if(e.tiled){let a=ws(e.anchor||ia);(e.pos?.x||0)-(a.x+1)*.5*(e.width||o),(e.pos?.y||0)-(a.y+1)*.5*(e.height||n);let r=(e.width||o)/o,l=(e.height||n)/n,c=Math.floor(r),d=Math.floor(l),i=r-c,h=l-d,u=(c+i?1:0)*(d+h?1:0),g=new Array(u*6),p=new Array(u*4),T=0,m=(M,P,f,_,B)=>{g[T*6+0]=T*4+0,g[T*6+1]=T*4+1,g[T*6+2]=T*4+3,g[T*6+3]=T*4+1,g[T*6+4]=T*4+2,g[T*6+5]=T*4+3,p[T*4+0]={pos:new oe(M-a.x,P-a.y),uv:new oe(B.x,B.y),color:e.color||vt.WHITE,opacity:e.opacity||1},p[T*4+1]={pos:new oe(M+f-a.x,P-a.y),uv:new oe(B.x+B.w,B.y),color:e.color||vt.WHITE,opacity:e.opacity||1},p[T*4+2]={pos:new oe(M+f-a.x,P+_-a.y),uv:new oe(B.x+B.w,B.y+B.h),color:e.color||vt.WHITE,opacity:e.opacity||1},p[T*4+3]={pos:new oe(M-a.x,P+_-a.y),uv:new oe(B.x,B.y+B.h),color:e.color||vt.WHITE,opacity:e.opacity||1},T++};for(let M=0;M<d;M++){for(let P=0;P<c;P++)m(P*o,M*n,o,n,t);i&&m(c*o,M*n,o*i,n,new Jt(t.x,t.y,t.w*i,t.h))}if(h){for(let M=0;M<c;M++)m(M*o,d*n,o,n*h,new Jt(t.x,t.y,t.w,t.h*h));i&&m(c*o,d*n,o*i,n*h,new Jt(t.x,t.y,t.w*i,t.h*h))}Ln(p,g,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(s.x=e.width/o,s.y=e.height/n):e.width?(s.x=e.width/o,s.y=s.x):e.height&&(s.y=e.height/n,s.x=s.y),ei(Object.assign({},e,{scale:s.scale(e.scale||new oe(1)),tex:e.tex,quad:t,width:o,height:n}))}function Hf(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Ri(e.sprite);if(!t||!t.data)return;let o=t.data.frames[e.frame??0];if(!o)throw new Error(`Frame not found: ${e.frame??0}`);Fi(Object.assign({},e,{tex:t.data.tex,quad:o.scale(e.quad??new Jt(0,0,1,1))}))}function Uf(e,t){let o=x.gfx.ggl.gl;Ad(e,t,o.NOTEQUAL)}function Rc(e){Vn(Kn(e))}var Nf=(e,t)=>{let o=Br(t,Ga,Ka),n=e.pixelDensity??1,s=e.scale??1,{gl:a}=t,r=Cn.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new Xi(t,e.width*n*s,e.height*n*s):new Xi(t,a.drawingBufferWidth,a.drawingBufferHeight),c=null,d=1;e.background&&(typeof e.background=="string"?c=Ht(e.background):(c=Ht(...e.background),d=e.background[3]??1),a.clearColor(c.r/255,c.g/255,c.b/255,d??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let i=new If(t,Dr,t0,o0),h=Cn.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:o,defTex:r,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:i,transform:new sn,transformStack:[],bgTex:h,bgColor:c,bgAlpha:d,width:e.width??a.drawingBufferWidth/n/s,height:e.height??a.drawingBufferHeight/n/s,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function Xn(e){return e.fixed?!0:e.parent?Xn(e.parent):!1}function Wn(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function _f(e,t={}){return{id:"circle",radius:e,draw(){bs(Object.assign(Wn(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Yt(new oe(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Sd(...e){return{id:"color",color:Ht(...e),inspect(){return`color: ${this.color.toString()}`}}}function Xf(e){return{add(){this.canvas=e}}}function Ff(e=1){let t,o=0,n=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){n||(o+=io(),this.opacity=en(o,0,e,0,t),o>=e&&(this.opacity=t,n=!0))}}}function Yf(e="intersect"){return{id:"mask",mask:e}}function Md(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,o=x.k.easings.linear){return x.game.root.tween(0,this.opacity,t,n=>this.opacity=n,o)},fadeOut(t=1,o=x.k.easings.linear){return x.game.root.tween(this.opacity,0,t,n=>this.opacity=n,o)},inspect(){return`opacity: ${Va(this.opacity,1)}`}}}function qf(e=1,t=Ht(0,0,0),o=1,n="miter",s=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:o,join:n,miterLimit:s,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var Gf=class{pos=$(0);vel=$(0);acc=$(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function Kf(e,t){let o=t.lifetime,n=[],s=e.colors||[vt.WHITE],a=e.opacities||[1],r=e.quads||[new Jt(0,0,1,1)],l=e.scales||[1],c=e.lifeTime,d=t.direction,i=t.spread,h=e.speed||[0,0],u=e.angle||[0,0],g=e.angularVelocity||[0,0],p=e.acceleration||[$(0),$(0)],T=e.damping||[0,0],m=[],M=new Array(e.max),P=0,f=0;for(let b=0;b<e.max;b++){m[b*6+0]=b*4+0,m[b*6+1]=b*4+1,m[b*6+2]=b*4+3,m[b*6+3]=b*4+1,m[b*6+4]=b*4+2,m[b*6+5]=b*4+3;for(let S=0;S<4;S++)M[b*4+S]={pos:new oe(0,0),uv:new oe(0,0),color:Ht(255,255,255),opacity:1};n[b]=new Gf}let _=new yo;function B(b=0){for(;b<e.max;){if(n[b].gc)return b;b++}return null}return{id:"particles",emit(b){let S=0;for(let E=0;E<b;E++){if(S=B(S),S==null)return;let C=so(d-i,d+i),A=oe.fromAngle(C).scale(so(h[0],h[1])),z=so(u[0],u[1]),R=so(g[0],g[1]),Y=$(so(p[0].x,p[1].x),so(p[0].y,p[1].y)),U=so(T[0],T[1]),N=c?so(c[0],c[1]):null,H=t.shape?t.shape.random():$(),I=n[S];I.lt=N,I.pos=H,I.vel=A,I.acc=Y,I.angle=z,I.angularVelocity=R,I.damping=U,I.angularVelocity=R,I.gc=!1}P+=b},update(){if(o!==void 0&&o<=0)return;let b=io();for(let S of n)if(!S.gc){if(S.t+=b,S.lt&&S.t>=S.lt){S.gc=!0,P--;continue}S.vel=S.vel.add(S.acc.scale(b)).scale(1-S.damping*b),S.pos=S.pos.add(S.vel.scale(b)),S.angle+=S.angularVelocity*b}for(o!==void 0&&(o-=b,o<=0&&_.trigger()),f+=b;P<e.max&&t.rate&&f>t.rate;)this.emit(1),P++,f-=t.rate},draw(){if(!(o!==void 0&&o<=0)){for(let b=0;b<n.length;b++){let S=n[b];if(S.gc)continue;let E=S.progress,C=Math.floor(S.progress*s.length),A=C<s.length-1?So(s[C],s[C+1],en(E,C/s.length,(C+1)/s.length,0,1)):s[C],z=Math.floor(S.progress*a.length),R=z<a.length-1?So(a[z],a[z+1],en(E,z/a.length,(z+1)/a.length,0,1)):a[z],Y=Math.floor(S.progress*r.length),U=r[Y],N=Math.floor(S.progress*l.length),H=l[N],I=Math.cos(S.angle*Math.PI/180),F=Math.sin(S.angle*Math.PI/180),V=(e.texture?e.texture.width:10)*U.w/2,j=(e.texture?e.texture.height:10)*U.h/2,ce=b*4,ie=M[ce];ie.pos.x=S.pos.x+-V*H*I- -j*H*F,ie.pos.y=S.pos.y+-V*H*F+-j*H*I,ie.uv.x=U.x,ie.uv.y=U.y,ie.color.r=A.r,ie.color.g=A.g,ie.color.b=A.b,ie.opacity=R,ie=M[ce+1],ie.pos.x=S.pos.x+V*H*I- -j*H*F,ie.pos.y=S.pos.y+V*H*F+-j*H*I,ie.uv.x=U.x+U.w,ie.uv.y=U.y,ie.color.r=A.r,ie.color.g=A.g,ie.color.b=A.b,ie.opacity=R,ie=M[ce+2],ie.pos.x=S.pos.x+V*H*I-j*H*F,ie.pos.y=S.pos.y+V*H*F+j*H*I,ie.uv.x=U.x+U.w,ie.uv.y=U.y+U.h,ie.color.r=A.r,ie.color.g=A.g,ie.color.b=A.b,ie.opacity=R,ie=M[ce+3],ie.pos.x=S.pos.x+-V*H*I-j*H*F,ie.pos.y=S.pos.y+-V*H*F+j*H*I,ie.uv.x=U.x,ie.uv.y=U.y+U.h,ie.color.r=A.r,ie.color.g=A.g,ie.color.b=A.b,ie.opacity=R}Ln(M,m,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(b){return _.add(b)},inspect(){return`count: ${P}/${e.max}`}}}function Vf(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){Dn(Object.assign(Wn(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new xo(this.pts)},inspect(){return`polygon: ${this.pts.map(o=>`[${o.x},${o.y}]`).join(",")}`}}}function Td(e,t,o){let n;return x.game.root.get("area").forEach(s=>{if(o&&o.some(r=>s.is(r)))return;let a=s.worldArea().raycast(e,t);a&&(n?a.fraction<n.fraction&&(n=a,n.object=s):(n=a,n.object=s))}),n}function Dd(e,t,o={}){return{id:"rect",width:e,height:t,radius:o.radius||0,draw(){zo(Object.assign(Wn(this),{width:this.width,height:this.height,radius:this.radius,fill:o.fill}))},renderArea(){return new Yt($(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Wf(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function $f(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let o=x.game.root.add([Yi(t.pos??$(0))]),n=e.length,s=0,a=null,r=null,l=null,c=null,d=b=>b.x+b.y*s,i=b=>$(Math.floor(b%s),Math.floor(b/s)),h=()=>{a=[];for(let b of o.children)u(b)},u=b=>{let S=d(b.tilePos);a[S]?a[S].push(b):a[S]=[b]},g=b=>{let S=d(b.tilePos);if(a[S]){let E=a[S].indexOf(b);E>=0&&a[S].splice(E,1)}},p=()=>{let b=!1;for(let S of o.children){let E=o.pos2Tile(S.pos);(S.tilePos.x!=E.x||S.tilePos.y!=E.y)&&(b=!0,g(S),S.tilePos.x=E.x,S.tilePos.y=E.y,u(S))}b&&o.trigger("spatialMapChanged")},T=()=>{let b=o.getSpatialMap(),S=o.numRows()*o.numColumns();r?r.length=S:r=new Array(S),r.fill(1,0,S);for(let E=0;E<b.length;E++){let C=b[E];if(C){let A=0;for(let z of C)if(z.isObstacle){A=1/0;break}else A+=z.cost;r[E]=A||1}}},m=()=>{let b=o.getSpatialMap(),S=o.numRows()*o.numColumns();l?l.length=S:l=new Array(S),l.fill(15,0,S);for(let E=0;E<b.length;E++){let C=b[E];if(C){let A=C.length,z=15;for(let R=0;R<A;R++)z|=C[R].edgeMask;l[E]=z}}},M=()=>{let b=o.numRows()*o.numColumns(),S=(C,A)=>{let z=[];for(z.push(C);z.length>0;){let R=z.pop();_(R).forEach(Y=>{c[Y]<0&&(c[Y]=A,z.push(Y))})}};c?c.length=b:c=new Array(b),c.fill(-1,0,b);let E=0;for(let C=0;C<r.length;C++){if(c[C]>=0){E++;continue}S(C,E),E++}},P=(b,S)=>r[S],f=(b,S)=>{let E=i(b),C=i(S);return E.dist(C)},_=(b,S)=>{let E=[],C=Math.floor(b%s),A=C>0&&l[b]&1&&r[b-1]!==1/0,z=b>=s&&l[b]&2&&r[b-s]!==1/0,R=C<s-1&&l[b]&4&&r[b+1]!==1/0,Y=b<s*n-s-1&&l[b]&8&&r[b+s]!==1/0;return S?(A&&(z&&E.push(b-s-1),E.push(b-1),Y&&E.push(b+s-1)),z&&E.push(b-s),R&&(z&&E.push(b-s+1),E.push(b+1),Y&&E.push(b+s+1)),Y&&E.push(b+s)):(A&&E.push(b-1),z&&E.push(b-s),R&&E.push(b+1),Y&&E.push(b+s)),E},B={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(b,...S){let E=$(...S),C=(()=>{if(typeof b=="string"){if(t.tiles[b]){if(typeof t.tiles[b]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[b](E)}else if(t.wildcardTile)return t.wildcardTile(b,E)}else{if(Array.isArray(b))return b;throw new Error("Expected a symbol or a component list")}})();if(!C)return null;let A=!1,z=!1;for(let Y of C)Y.id==="tile"&&(z=!0),Y.id==="pos"&&(A=!0);A||C.push(Yi(this.tile2Pos(E))),z||C.push(Kd());let R=o.add(C);return A&&(R.tilePosOffset=R.pos.clone()),R.tilePos=E,R.transform=Ks(R),a&&(u(R),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),R},numColumns(){return s},numRows(){return n},levelWidth(){return s*this.tileWidth()},levelHeight(){return n*this.tileHeight()},tile2Pos(...b){return $(...b).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...b){let S=$(...b);return $(Math.floor(S.x/this.tileWidth()),Math.floor(S.y/this.tileHeight()))},getSpatialMap(){return a||h(),a},removeFromSpatialMap:g,insertIntoSpatialMap:u,onSpatialMapChanged(b){return this.on("spatialMapChanged",b)},onNavigationMapInvalid(b){return this.on("navigationMapInvalid",b)},getAt(b){a||h();let S=d(b);return a[S]||[]},raycast(b,S){let E=this.toWorld(b),C=this.toWorld(b.add(S)).sub(E),A=1/this.tileWidth(),z=b.scale(A),R=Cu(z,S,Y=>{let U=this.getAt(Y);if(U.some(H=>H.isObstacle))return!0;let N=null;for(let H of U)if(H.has("area")){let I=H.worldArea().raycast(E,C);I&&(N?I.fraction<N.fraction&&(N=I,N.object=H):(N=I,N.object=H))}return N&&(N.point=this.fromWorld(N.point).scale(A)),N||!1},64);return R&&(R.point=R.point.scale(this.tileWidth())),R},update(){a&&p()},invalidateNavigationMap(){r=null,l=null,c=null},onNavigationMapChanged(b){return this.on("navigationMapChanged",b)},getTilePath(b,S,E={}){if(r||T(),l||m(),c||M(),b.x<0||b.x>=s||b.y<0||b.y>=n||S.x<0||S.x>=s||S.y<0||S.y>=n)return null;let C=d(b),A=d(S);if(r[A]===1/0)return null;if(C===A)return[];if(c[C]!=-1&&c[C]!==c[A])return null;let z=new sd((I,F)=>I.cost<F.cost);z.insert({cost:0,node:C});let R=new Map;R.set(C,C);let Y=new Map;for(Y.set(C,0);z.length!==0;){let I=z.remove()?.node;if(I===A)break;let F=_(I,E.allowDiagonals);for(let V of F){let j=(Y.get(I)||0)+P(I,V)+f(V,A);(!Y.has(V)||j<Y.get(V))&&(Y.set(V,j),z.insert({cost:j,node:V}),R.set(V,I))}}let U=[],N=A,H=i(N);for(U.push(H);N!==C;){let I=R.get(N);if(I===void 0)throw new Error("Bug in pathfinding algorithm");N=I;let F=i(N);U.push(F)}return U.reverse()},getPath(b,S,E={}){let C=this.tileWidth(),A=this.tileHeight(),z=this.getTilePath(this.pos2Tile(b),this.pos2Tile(S),E);return z?[b,...z.slice(1,-1).map(R=>R.scale(C,A).add(C/2,A/2)),S]:null}};return o.use(B),o.onNavigationMapInvalid(()=>{o.invalidateNavigationMap(),o.trigger("navigationMapChanged")}),e.forEach((b,S)=>{let E=b.split("");s=Math.max(E.length,s),E.forEach((C,A)=>{o.spawn(C,$(A,S))})}),o}function Ro(e,t,o){return x.game.objEvents.registers[e]||(x.game.objEvents.registers[e]=new od),x.game.objEvents.on(e,(n,...s)=>{n.is(t)&&o(n,...s)})}var Jf=(e,t,...o)=>{for(let n of x.game.root.children)n.is(t)&&n.trigger(e,o)},jf=Kt(e=>{let t=x.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ro("fixedUpdate",e,t)),Cd=Kt(e=>{let t=x.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Ro("update",e,t)),Zf=Kt(e=>{let t=x.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(o){t.hidden=o},cancel:()=>t.destroy()}},(e,t)=>Ro("draw",e,t)),Rd=Kt(e=>x.game.events.on("add",e),(e,t)=>Ro("add",e,t)),Qf=Kt(e=>x.game.events.on("destroy",e),(e,t)=>Ro("destroy",e,t)),kf=Kt(e=>x.game.events.on("use",e),(e,t)=>Ro("use",e,t)),ep=Kt(e=>x.game.events.on("unuse",e),(e,t)=>Ro("unuse",e,t)),Id=Kt(e=>x.game.events.on("tag",e),(e,t)=>Ro("tag",e,t)),tp=Kt(e=>x.game.events.on("untag",e),(e,t)=>Ro("untag",e,t));function op(e,t,o){return Ro("collide",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function np(e,t,o){return Ro("collideUpdate",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function sp(e,t,o){return Ro("collideEnd",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function ca(e,t){x.game.root.get(e,{recursive:!0}).forEach(t),Rd(e,t),Id((o,n)=>{n===e&&t(o)})}var ip=Kt(e=>x.app.onMousePress(e),(e,t)=>{let o=[];return ca(e,n=>{if(!n.area)throw new Error("onClick() requires the object to have area() component");o.push(n.onClick(()=>t(n)))}),Qn.join(o)});function ap(e,t){let o=[];return ca(e,n=>{if(!n.area)throw new Error("onHover() requires the object to have area() component");o.push(n.onHover(()=>t(n)))}),Qn.join(o)}function rp(e,t){let o=[];return ca(e,n=>{if(!n.area)throw new Error("onHoverUpdate() requires the object to have area() component");o.push(n.onHoverUpdate(()=>t(n)))}),Qn.join(o)}function cp(e,t){let o=[];return ca(e,n=>{if(!n.area)throw new Error("onHoverEnd() requires the object to have area() component");o.push(n.onHoverEnd(()=>t(n)))}),Qn.join(o)}function lp(e){x.game.events.on("loading",e)}function dp(e){x.app.onResize(e)}function hp(e){x.game.events.on("error",e)}function zr(e){x.assets.loaded?e():x.game.events.on("load",e)}function up(e){if(x.assets.loaded)dd().forEach(t=>e(...t));else return x.game.events.on("loadError",e)}function Pd(...e){x.game.cam.pos=$(...e)}function Bd(){return x.game.cam.pos?x.game.cam.pos.clone():_i()}function Ld(...e){x.game.cam.scale=$(...e)}function zd(){return x.game.cam.scale.clone()}function Od(e){x.game.cam.angle=e}function Hd(){return x.game.cam.angle}function fp(){return x.game.cam.transform.clone()}function Ud(e=Ht(255,255,255),t=1){let o=x.game.root.add([Dd(co(),uo()),Sd(e),Md(1),$d()]),n=o.fadeOut(t);return n.onEnd(()=>Gd(o)),n}function pp(){return x.game.cam.transform.clone()}function gp(e=12){x.game.cam.shake+=e}function Qa(e){return x.game.cam.transform.multVec2(e)}function Nd(e){return x.game.cam.transform.invert().multVec2(e)}function mp(...e){return xs("camPos","setCamPos / getCamPos"),e.length>0&&Pd(...e),Bd()}function yp(...e){return xs("camScale","setCamScale / getCamScale"),e.length>0&&Ld(...e),zd()}function xp(e){return xs("camRot","setCamRot / getCamRot"),e!==void 0&&Od(e),Hd()}function wp(e=Ht(255,255,255),t=1){return xs("camFlash","flash"),Ud(e,t)}function Or(e=[]){let t=new Map,o=[],n={},s=new js,a=[],r=new Set("*"),l=x.globalOpt.tagsAsComponents,c=null,d=!1,i={id:R0(),hidden:!1,transform:new sn,children:[],parent:null,set paused(u){if(u!==d){d=u;for(let g of a)g.paused=u}},get paused(){return d},get tags(){return Array.from(r)},add(u){let g=Array.isArray(u)?Or(u):u;if(g.parent)throw new Error("Cannot add a game obj that already has a parent.");return g.parent=this,g.transform=Ks(g),this.children.push(g),g.trigger("add",g),x.game.events.trigger("add",g),g},readd(u){let g=this.children.indexOf(u);return g!==-1&&(this.children.splice(g,1),this.children.push(u)),u},remove(u){let g=this.children.indexOf(u);if(g!==-1){u.parent=null,this.children.splice(g,1);let p=T=>{T.trigger("destroy"),x.game.events.trigger("destroy",T),T.children.forEach(m=>p(m))};p(u)}},removeAll(u){if(u)this.get(u).forEach(g=>this.remove(g));else for(let g of[...this.children])this.remove(g)},fixedUpdate(){this.paused||(this.children.forEach(u=>u.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(u=>u.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Lo(),this.canvas.bind());let u=x.gfx.fixed;this.fixed&&(x.gfx.fixed=!0),Bo(),jt(this.pos),Qs(this.scale),hs(this.angle);let g=this.children.sort((p,T)=>{let m=p.layerIndex??x.game.defaultLayerIndex,M=T.layerIndex??x.game.defaultLayerIndex;return m-M||(p.z??0)-(T.z??0)});if(this.mask){let p={intersect:x.k.drawMasked,subtract:x.k.drawSubtracted}[this.mask];if(!p)throw new Error(`Invalid mask func: "${this.mask}"`);p(()=>{g.forEach(T=>T.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),g.forEach(p=>p.draw());Eo(),x.gfx.fixed=u,this.canvas&&(Lo(),this.canvas.unbind())},drawInspect(){this.hidden||(Bo(),jt(this.pos),Qs(this.scale),hs(this.angle),this.children.forEach(u=>u.drawInspect()),this.trigger("drawInspect"),Eo())},use(u){if(typeof u=="string")return r.add(u);if(!u||typeof u!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof u}"`);let g=[];u.id?(this.unuse(u.id),n[u.id]=[],g=n[u.id],t.set(u.id,u),l&&r.add(u.id)):o.push(u);for(let T in u){if(i0.has(T))continue;let m=Object.getOwnPropertyDescriptor(u,T);if(m)if(typeof m.value=="function"&&(u[T]=u[T].bind(this)),m.set&&Object.defineProperty(u,T,{set:m.set.bind(this)}),m.get&&Object.defineProperty(u,T,{get:m.get.bind(this)}),a0.has(T)){let M=T==="add"?()=>{c=P=>g.push(P),u[T]?.(),c=null}:u[T];g.push(this.on(T,M).cancel)}else if(this[T]===void 0)Object.defineProperty(this,T,{get:()=>u[T],set:M=>u[T]=M,configurable:!0,enumerable:!0}),g.push(()=>delete this[T]);else{let M=t.values().find(P=>P[T]!==void 0)?.id;throw new Error(`Duplicate component property: "${T}" while adding component "${u.id}"`+(M?` (originally added by "${M}")`:""))}}let p=()=>{if(u.require){for(let T of u.require)if(!this.c(T))throw new Error(`Component "${u.id}" requires component "${T}"`)}};u.destroy&&g.push(u.destroy.bind(this)),this.exists()?(p(),u.add&&(c=T=>g.push(T),u.add.call(this),c=null),u.id&&(this.trigger("use",u.id),x.game.events.trigger("use",this,u.id))):u.require&&g.push(this.on("add",p).cancel)},unuse(u){if(t.has(u)){for(let g of t.values())if(g.require&&g.require.includes(u))throw new Error(`Can't unuse. Component "${g.id}" requires component "${u}"`);t.delete(u),this.trigger("unuse",u),x.game.events.trigger("unuse",this,u)}else l&&r.has(u)&&r.delete(u);n[u]&&(n[u].forEach(g=>g()),delete n[u])},c(u){return t.get(u)??null},get(u,g={}){let p=(m,M)=>g.only==="comps"?m.has(M):g.only==="tags"?m.is(M):m.is(M)||m.has(M),T=g.recursive?this.children.flatMap(function m(M){return[M,...M.children.flatMap(m)]}):this.children;if(T=T.filter(m=>u?p(m,u):!0),g.liveUpdate){let m=P=>g.recursive?this.isAncestorOf(P):P.parent===this,M=[];M.push(x.k.onAdd(P=>{m(P)&&p(P,u)&&T.push(P)})),M.push(x.k.onDestroy(P=>{if(m(P)&&p(P,u)){let f=T.findIndex(_=>_.id===P.id);f!==-1&&T.splice(f,1)}})),this.onDestroy(()=>{for(let P of M)P.cancel()})}return T},query(u){let g=u.hierarchy||"children",p=u.include,T=u.exclude,m=[];switch(g){case"children":m=this.children;break;case"siblings":m=this.parent?this.parent.children.filter(P=>P!==this):[];break;case"ancestors":let M=this.parent;for(;M;)m.push(M),M=M.parent;break;case"descendants":m=this.children.flatMap(function P(f){return[f,...f.children.flatMap(P)]});break}if(p&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(M=>M.is(p)):m=m.filter(M=>u.include.some(P=>M.is(P)))),T&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(M=>!M.is(T)):m=m.filter(M=>!u.exclude.some(P=>M.is(P)))),u.visible===!0&&(m=m.filter(M=>M.visible)),u.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let M=u.distanceOp||"near",P=u.distance*u.distance;M==="near"?m=m.filter(f=>f.pos&&this.pos.sdist(f.pos)<=P):m=m.filter(f=>f.pos&&this.pos.sdist(f.pos)>P)}return u.name&&(m=m.filter(M=>M.name===u.name)),m},isAncestorOf(u){return u.parent?u.parent===this||this.isAncestorOf(u.parent):!1},exists(){return x.game.root.isAncestorOf(this)},is(u,g="and"){return Array.isArray(u)?g==="and"?u.every(p=>r.has(p)):u.some(p=>r.has(p)):r.has(u)},tag(u){if(Array.isArray(u))for(let g of u)r.add(g),this.trigger("tag",g),x.game.events.trigger("tag",this,g);else r.add(u),this.trigger("tag",u),x.game.events.trigger("tag",this,u)},untag(u){if(Array.isArray(u))for(let g of u)r.delete(g),this.trigger("untag",g),x.game.events.trigger("untag",this,g);else r.delete(u),this.trigger("untag",u),x.game.events.trigger("untag",this,u)},has(u,g="and"){return Array.isArray(u)?g==="and"?u.every(p=>t.has(p)):u.some(p=>t.has(p)):t.has(u)},on(u,g){let p=s.on(u,g.bind(this));return c&&c(()=>p.cancel()),p},trigger(u,...g){s.trigger(u,...g),x.game.objEvents.trigger(u,this,...g)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let u={};for(let[g,p]of t)u[g]=p.inspect?.()??null;for(let[g,p]of o.entries()){if(p.inspect){u[g]=p.inspect();continue}for(let[T,m]of Object.entries(p))typeof m!="function"&&(u[T]=`${T}: ${m}`)}return u},onAdd(u){return this.on("add",u)},onFixedUpdate(u){return this.on("fixedUpdate",u)},onUpdate(u){return this.on("update",u)},onDraw(u){return this.on("draw",u)},onDestroy(u){return this.on("destroy",u)},onUse(u){return this.on("use",u)},onUnuse(u){return this.on("unuse",u)},clearEvents(){s.clear()}},h=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let u of h)i[u]=(...g)=>{let p=x.app[u]?.(...g);return a.push(p),i.onDestroy(()=>p.cancel()),i.on("sceneEnter",()=>{a.splice(a.indexOf(p),1);let T=x.app[u]?.(...g);Qn.replace(p,T),a.push(p)}),p};for(let u of e)i.use(u);return i}var bp=()=>({events:new js,objEvents:new js,root:Or([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new oe(1),angle:0,shake:0,transform:new sn}});function vp(e){x.game.gravity=e?(x.game.gravity||$(0,1)).unit().scale(e):null}function Ep(){return x.game.gravity?x.game.gravity.len():0}function Ap(e){x.game.gravity=e.unit().scale(x.game.gravity?x.game.gravity.len():1)}function Ws(){return x.game.gravity?x.game.gravity.unit():$(0,1)}var Sp=iu("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Mp=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let o=new ks($0(e));return e.decodeAudioData(Sp.buffer.slice(0)).then(n=>{o.buf=n}).catch(n=>{console.error("Failed to load burp: ",n)}),{ctx:e,masterNode:t,burpSnd:o}})();function Tp(e,t={}){let o=new yo,n=new Audio(e);n.crossOrigin="anonymous",n.loop=!!t.loop,x.audio.ctx.createMediaElementSource(n).connect(x.audio.masterNode);function s(){x.debug.paused||x.app.isHidden()&&!x.globalOpt.backgroundAudio||x.audio.ctx.resume()}function a(){s(),n.play()}return t.paused||a(),n.onended=()=>o.trigger(),{play(){a()},seek(r){n.currentTime=r},stop(){n.pause(),this.seek(0)},set loop(r){n.loop=r},get loop(){return n.loop},set paused(r){r?n.pause():a()},get paused(){return n.paused},time(){return n.currentTime},duration(){return n.duration},set volume(r){n.volume=nn(r,0,1)},get volume(){return n.volume},set speed(r){n.playbackRate=Math.max(r,0)},get speed(){return n.playbackRate},set detune(r){},get detune(){return 0},onEnd(r){return o.add(r)},then(r){return this.onEnd(r)}}}function Dp(e,t={}){if(typeof e=="string"&&x.assets.music[e])return Tp(x.assets.music[e],t);let o=x.audio.ctx,n=t.paused??!1,s=o.createBufferSource(),a=new yo,r=o.createGain(),l=o.createStereoPanner(),c=t.seek??0,d=0,i=0,h=!1;s.loop=!!t.loop,s.detune.value=t.detune??0,s.playbackRate.value=t.speed??1,s.connect(l),s.onended=()=>{p()>=(s.buffer?.duration??Number.POSITIVE_INFINITY)&&a.trigger()},l.pan.value=t.pan??0,l.connect(r),r.connect(x.audio.masterNode),r.gain.value=t.volume??1;let u=m=>{s.buffer=m.buf,n||(d=o.currentTime,s.start(0,c),h=!0)},g=Af(e);g instanceof Uo&&g.onLoad(u);let p=()=>{if(!s.buffer)return 0;let m=n?i-d:o.currentTime-d,M=s.buffer.duration;return s.loop?m%M:Math.min(m,M)},T=m=>{let M=o.createBufferSource();return M.buffer=m.buffer,M.loop=m.loop,M.playbackRate.value=m.playbackRate.value,M.detune.value=m.detune.value,M.onended=m.onended,M.connect(l),M};return{stop(){this.paused=!0,this.seek(0)},set paused(m){if(n!==m)if(n=m,m)h&&(s.stop(),h=!1),i=o.currentTime;else{s=T(s);let M=i-d;s.start(0,M),h=!0,d=o.currentTime-M,i=0}},get paused(){return n},play(m=0){this.seek(m),this.paused=!1},seek(m){s.buffer?.duration&&(m>s.buffer.duration||(n?(s=T(s),d=i-m):(s.stop(),s=T(s),d=o.currentTime-m,s.start(0,m),h=!0,i=0)))},set speed(m){s.playbackRate.value=m},get speed(){return s.playbackRate.value},set detune(m){s.detune.value=m},get detune(){return s.detune.value},set volume(m){r.gain.value=Math.max(m,0)},get volume(){return r.gain.value},set pan(m){l.pan.value=m},get pan(){return l.pan.value},set loop(m){s.loop=m},get loop(){return s.loop},duration(){return s.buffer?.duration??0},time(){return p()%this.duration()},onEnd(m){return a.add(m)},then(m){return this.onEnd(m)}}}function _d(e){return x.k.play(x.audio.burpSnd,e)}function Xd(e){x.audio.masterNode.gain.value=e}function Fd(){return x.audio.masterNode.gain.value}function Cp(e){return xs("volume","setVolume / getVolume"),e!==void 0&&Xd(e),Fd()}function Yd(){x.app.onHide(()=>{x.globalOpt.backgroundAudio||x.audio.ctx.suspend()}),x.app.onShow(()=>{!x.globalOpt.backgroundAudio&&!x.debug.paused&&x.audio.ctx.resume()}),x.app.onResize(()=>{if(x.app.isFullscreen())return;let e=x.globalOpt.width&&x.globalOpt.height;e&&!x.globalOpt.stretch&&!x.globalOpt.letterbox||(x.canvas.width=x.canvas.offsetWidth*x.pixelDensity,x.canvas.height=x.canvas.offsetHeight*x.pixelDensity,rd(),e||(x.gfx.frameBuffer.free(),x.gfx.frameBuffer=new Xi(x.gfx.ggl,x.gfx.ggl.gl.drawingBufferWidth,x.gfx.ggl.gl.drawingBufferHeight),x.gfx.width=x.gfx.ggl.gl.drawingBufferWidth/x.pixelDensity/x.gscale,x.gfx.height=x.gfx.ggl.gl.drawingBufferHeight/x.pixelDensity/x.gscale))}),x.globalOpt.debug!==!1&&(x.app.onKeyPress(x.globalOpt.debugKey??"f1",()=>x.debug.inspect=!x.debug.inspect),x.app.onKeyPress("f2",()=>x.debug.clearLog()),x.app.onKeyPress("f8",()=>x.debug.paused=!x.debug.paused),x.app.onKeyPress("f7",()=>{x.debug.timeScale=Va(nn(x.debug.timeScale-.2,0,2),1)}),x.app.onKeyPress("f9",()=>{x.debug.timeScale=Va(nn(x.debug.timeScale+.2,0,2),1)}),x.app.onKeyPress("f10",()=>x.debug.stepFrame())),x.globalOpt.burp&&x.app.onKeyPress("b",()=>_d())}function Rp(e,t={}){let o=x.game.root.add([Yi(e),Wd()]),n=(t.speed||1)*5,s=t.scale||1;o.add([ka(x.boomSprite),qi(0),or("center"),Pc(n,s),...t.comps??[]]);let a=o.add([ka(x.kaSprite),qi(0),or("center"),er(),...t.comps??[]]);return a.wait(.4/n,()=>a.use(Pc(n,s))),a.onDestroy(()=>o.destroy()),o}function qd(e,t){if(x.game.layers)throw Error("Layers can only be assigned once.");let o=e.indexOf(t);if(o==-1)throw Error("The default layer name should be present in the layers list.");x.game.layers=e,x.game.defaultLayerIndex=o}function Ip(){return x.game.layers}function Pp(){return x.game.layers?.[x.game.defaultLayerIndex]??null}function Bp(e,t){xs("layers","setLayers"),qd(e,t)}function Gd(e){e.destroy()}function Lp(){return x.game.root}function zp(e,t){x.game.scenes[e]=t}function Op(e,...t){if(!x.game.scenes[e])throw new Error(`Scene not found: ${e}`);x.game.events.onOnce("frameEnd",()=>{x.game.events.trigger("sceneLeave",e),x.app.events.clear(),x.game.events.clear(),x.game.objEvents.clear(),[...x.game.root.children].forEach(o=>{!o.stay||o.scenesToStay&&!o.scenesToStay.includes(e)?x.game.root.remove(o):o.trigger("sceneEnter",e)}),x.game.root.clearEvents(),Yd(),x.game.cam={pos:null,scale:$(1),angle:0,shake:0,transform:new sn},x.game.scenes[e](...t)}),x.game.currentScene=e}function Hp(e){return x.game.events.on("sceneLeave",e)}function Up(){return x.game.currentScene}function ka(e,t={}){let o=null,n=null,s=null,a=new yo;if(!e)throw new Error("Please pass the resource name or data to sprite()");let r=(d,i,h,u)=>{let g=$(1,1);return h&&u?(g.x=h/(d.width*i.w),g.y=u/(d.height*i.h)):h?(g.x=h/(d.width*i.w),g.y=g.x):u&&(g.y=u/(d.height*i.h),g.x=g.y),g},l=(d,i)=>{if(!i)return;let h=i.frames[0].clone();t.quad&&(h=h.scale(t.quad));let u=r(i.tex,h,t.width,t.height);if(d.width=i.tex.width*h.w*u.x,d.height=i.tex.height*h.h*u.y,i.anims)for(let g in i.anims){let p=i.anims[g];typeof p!="number"&&(p.frames=c(p))}o=i,a.trigger(o),t.anim&&d.play(t.anim)},c=d=>{if(d.frames)return d.frames;let i=[];if(d.from===void 0||d.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let h=Math.abs(d.to-d.from)+1;for(let u=0;u<h;u++)i.push(d.from+u*Math.sign(d.to-d.from));if(d.pingpong)for(let u=h-2;u>0;u--)i.push(i[u]);return i};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new Jt(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(d){let i=Ri(d);i&&i.onLoad(h=>l(this,h))},get animFrame(){if(!o||!n||s===null)return this.frame;let d=o.anims[n.name];return typeof d=="number"?d:d.from===void 0||d.to===void 0?n.frameIndex:this.frame-Math.min(d.from,d.to)},draw(){if(!o)return;let d=o.frames[this.frame??0];if(!d)throw new Error(`Frame not found: ${this.frame??0}`);if(o.slice9){let{left:i,right:h,top:u,bottom:g}=o.slice9,p=o.tex.width*d.w,T=o.tex.height*d.h,m=this.width-i-h,M=this.height-u-g,P=i/p,f=h/p,_=1-P-f,B=u/T,b=g/T,S=1-B-b,E=[eo(0,0,P,B),eo(P,0,_,B),eo(P+_,0,f,B),eo(0,B,P,S),eo(P,B,_,S),eo(P+_,B,f,S),eo(0,B+S,P,b),eo(P,B+S,_,b),eo(P+_,B+S,f,b),eo(0,0,i,u),eo(i,0,m,u),eo(i+m,0,h,u),eo(0,u,i,M),eo(i,u,m,M),eo(i+m,u,h,M),eo(0,u+M,i,g),eo(i,u+M,m,g),eo(i+m,u+M,h,g)];for(let C=0;C<9;C++){let A=E[C],z=E[C+9];Fi(Object.assign(Wn(this),{pos:z.pos(),tex:o.tex,quad:d.scale(A),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:z.w,height:z.h}))}}else Fi(Object.assign(Wn(this),{tex:o.tex,quad:d.scale(this.quad??new Jt(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let d=Ri(e);d?d.onLoad(i=>l(this,i)):zr(()=>l(this,Ri(e).data))},update(){if(!o||!n||s===null)return;let d=o.anims[n.name];if(typeof d=="number"){this.frame=d;return}if(d.speed===0)throw new Error("Sprite anim speed cannot be 0");if(n.timer+=io()*this.animSpeed,n.timer>=1/n.speed){n.timer=0,n.frameIndex+=s;let i=d.frames;if(n.frameIndex>=i.length)if(n.pingpong&&!d.pingpong)s=-1,n.frameIndex=i.length-2;else if(n.loop)n.frameIndex=0;else{this.frame=i.at(-1),n.onEnd(),this.stop();return}else if(n.frameIndex<0)if(n.pingpong&&n.loop)s=1,n.frameIndex=1;else if(n.loop)n.frameIndex=i.length-1;else{this.frame=i[0],n.onEnd(),this.stop();return}this.frame=i[n.frameIndex]}},play(d,i={}){if(!o){a.add(()=>this.play(d,i));return}let h=o.anims[d];if(h===void 0)throw new Error(`Anim not found: ${d}`);n&&this.stop(),n=typeof h=="number"?{name:d,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:d,timer:0,loop:i.loop??h.loop??!1,pingpong:i.pingpong??h.pingpong??!1,speed:i.speed??h.speed??10,frameIndex:0,onEnd:i.onEnd??(()=>{})},s=typeof h=="number"?null:1,this.frame=typeof h=="number"?h:h.frames[0],this.trigger("animStart",d)},stop(){if(!n)return;let d=n.name;n=null,this.trigger("animEnd",d)},numFrames(){return o?.frames.length??0},getCurAnim(){return n},curAnim(){return n?.name},getAnim(d){return o?.anims[d]??null},hasAnim(d){return!!this.getAnim(d)},onAnimEnd(d){return this.on("animEnd",d)},onAnimStart(d){return this.on("animStart",d)},renderArea(){return new Yt($(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function Np(e,t={}){function o(s){let a=Kn(Object.assign(Wn(s),{text:s.text+"",size:s.textSize,font:s.font,width:t.width&&s.width,align:s.align,letterSpacing:s.letterSpacing,lineSpacing:s.lineSpacing,transform:s.textTransform,styles:s.textStyles,indentAll:t.indentAll}));return t.width||(s.width=a.width/(s.scale?.x||1)),s.height=a.height/(s.scale?.y||1),a}let n={id:"text",set text(s){e=s,o(this),this.renderedText=ja(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?ja(e).text:"",add(){zr(()=>o(this))},draw(){Vn(o(this))},renderArea(){return new Yt($(0),this.width,this.height)}};return o(n),n}function _p(e,t){return{id:"rect",width:e,height:t,draw(){ei(Object.assign(Wn(this),{width:this.width,height:this.height}))},renderArea(){return new Yt($(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function Xp(e={}){let t=null,o=null,n=null,s=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return o&&n?o[n]:null},getPath(){return o?o.slice():null},getTarget(){return t},isNavigationFinished(){return o?n===null:!0},isTargetReachable(){return o!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n=o?0:null,o&&n!==null?(s||(s=this.getLevel().onNavigationMapChanged(()=>{t&&o&&n!==null&&(o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o?(n=0,this.trigger("navigationNext",this,o[n])):(n=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>s?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,o[n])):this.trigger("navigationEnded",this)},update(){if(t&&o&&n!==null){if(this.pos.sdist(o[n])<2)if(n===o.length-1){this.pos=t.clone(),n=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else n++,this.trigger("navigationNext",this,o[n]);this.moveTo(o[n],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(o)})}}}function Fp(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(o){return this.graph?.getWaypointPath(this.pos,o,e.navigationOpt)},get graph(){if(t)return t;let o=this.parent;for(;o;){if(o.has("pathfinderMap"))return o.graph;o=o.parent}},set graph(o){t=o}}}function Yp(e={}){let t=e.waypoints,o=e.speed||100,n=e.endBehavior||"stop",s=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return o},set patrolSpeed(r){o=r},get waypoints(){return t},set waypoints(r){t=r,s=0,a=!1},get nextLocation(){return t?t[s]:void 0},update(){let r=this.nextLocation;if(!(!t||!r||a)&&(this.moveTo(r,o),this.pos.sdist(r)<9))switch(n){case"loop":s=(s+1)%t.length;break;case"ping-pong":s=s+1,s==t.length&&(t.reverse(),s=0);break;case"stop":s<t.length-1?s+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(r){return this.on("patrolFinished",r)}}}function qp(e,t={}){let o=typeof e=="function"?e:()=>x.game.root.query(e),n=t.checkFrequency||1,s=typeof t.direction=="number"?oe.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?oe.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(r){this.direction=r!==void 0?oe.fromAngle(r):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(r,l,c){let d=(typeof l=="number"?oe.fromAngle(l):l)||s,i=c||t.fieldOfView;if(!d||!i||i>=360)return!0;let h=i/2;return r.pos&&d.angleBetween(r.pos.sub(this.pos))<=h},hasLineOfSight(r){let l=Td(this.pos,r.pos.sub(this.pos),t.raycastExclude);return l!=null&&l.object===r},update(){if(a+=io(),a>n){a-=n;let r=o();if(r.length&&s&&this.fieldOfView&&this.fieldOfView<360){let l=this.fieldOfView/2;r=r.filter(c=>c.pos&&s.angleBetween(c.pos.sub(this.pos))<=l)}r.length&&t.lineOfSight&&(r=r.filter(l=>l.pos&&this.hasLineOfSight(l))),r.length>0&&(this.spotted=r,this.trigger("objectSpotted",r))}},onObjectsSpotted(r){return this.on("objectSpotted",r)}}}function Kd(e={}){let t=$(0),o=e.isObstacle??!1,n=e.cost??0,s=e.edges??[],a=()=>{let l={left:1,top:2,right:4,bottom:8};return s.map(c=>l[c]||0).reduce((c,d)=>c|d,0)},r=a();return{id:"tile",tilePosOffset:e.offset??$(0),set tilePos(l){let c=this.getLevel();t=l.clone(),this.pos=$(this.tilePos.x*c.tileWidth(),this.tilePos.y*c.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(l){o!==l&&(o=l,this.getLevel().invalidateNavigationMap())},get isObstacle(){return o},set cost(l){n!==l&&(n=l,this.getLevel().invalidateNavigationMap())},get cost(){return n},set edges(l){s=l,r=a(),this.getLevel().invalidateNavigationMap()},get edges(){return s},get edgeMask(){return r},getLevel(){return this.parent},tileMove(l){let c=this.getLevel();c.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(l),c.insertIntoSpatialMap(this),c.trigger("spatialMapChanged")},moveLeft(){this.tileMove($(-1,0))},moveRight(){this.tileMove($(1,0))},moveUp(){this.tileMove($(0,-1))},moveDown(){this.tileMove($(0,1))}}}var Hr=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,o){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||Zs.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=o}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,o){let n=t-1,s=e/this.duration;if(this.loops!==0&&s>=this.loops)return[n,0,!0];let a=Math.trunc(s);if(s-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(s=1-s),o){let r=0;for(;o[r+1]!==void 0&&o[r+1]<s;)r++;return r>=n?[n,0,!0]:[r,(s-o[r])/(o[r+1]-o[r]),!1]}else{let r=Math.floor((t-1)*s);return[r,(s-r/n)*n,!1]}}setValue(e,t,o){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(o);break;case"angle":e.angle=e.base.angle+o;break;case"scale":e.scale=e.base.scale.scale(o);break;case"opacity":e.opacity=e.base.opacity*o;break;default:e[t]=o}else e[t]=o}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=Zs.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Ic(e,t){return t.add(t.sub(e))}var Gp=class extends Hr{keys;constructor(e,t,o,n){super(e,o,n),this.keys=t}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;this.setValue(e,this.name,So(this.keys[o],this.keys[o+1],a(n)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},Kp=class extends Hr{keys;curves;dcurves;constructor(e,t,o,n,s){if(super(e,o,n),this.keys=t,this.interpolation==="spline"){this.curves=[],s&&(this.dcurves=[]);for(let a=0;a<this.keys.length-1;a++){let r=this.keys[a],l=a+1,c=this.keys[l],d=a>0?this.keys[a-1]:Ic(c,r),i=l<this.keys.length-1?this.keys[l+1]:Ic(r,c);this.curves.push(Ui(d,r,c,i)),s&&this.dcurves?.push(Ui(d,r,c,i,Fu))}}}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[o].lerp(this.keys[o+1],a(n)));break;case"slerp":this.setValue(e,this.name,this.keys[o].slerp(this.keys[o+1],a(n)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[o](a(n))),this.dcurves&&this.setValue(e,"angle",this.dcurves[o](a(n)).angle());break}}}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},Vp=class extends Hr{keys;constructor(e,t,o,n){super(e,o,n),this.keys=t}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;this.setValue(e,this.name,this.keys[o].lerp(this.keys[o+1],a(n)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function Wp(e={}){let t=[],o=0,n=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:$(0,0),angle:0,scale:$(1,1),opacity:1},animation:{paused:!1,seek(s){o=nn(s,0,this.duration),t.forEach(a=>{a.isFinished=!1}),n=!1},get duration(){return t.reduce((s,a)=>Math.max(a.duration,s),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let s=!0,a;o+=io();for(let r of t)a=r.update(this,o),a&&!r.isFinished&&(r.isFinished=!0,this.trigger("animateChannelFinished",r.name)),s&&=a;s&&!n&&(n=!0,this.trigger("animateFinished"))},animate(s,a,r){n=!1,this.unanimate(s),typeof a[0]=="number"?t.push(new Gp(s,a,r,e.relative||!1)):a[0]instanceof oe?t.push(new Kp(s,a,r,e.relative||!1,s==="pos"&&(e.followMotion||!1))):a[0]instanceof vt&&t.push(new Vp(s,a,r,e.relative||!1))},unanimate(s){let a=t.findIndex(r=>r.name===s);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(s){return this.on("animateFinished",s)},onAnimateChannelFinished(s){return this.on("animateChannelFinished",s)},serializeAnimationChannels(){return t.reduce((s,a)=>(s[a.name]=a.serialize(),s),{})},serializeAnimationOptions(){let s={};return e.followMotion&&(s.followMotion=!0),e.relative&&(s.relative=!0),s}}}function Vd(e,t){let o={name:e.name};return e.has("animate")&&(o.channels=e.serializeAnimationChannels(),Object.assign(o,e.serializeAnimationOptions())),e.children.length>0&&(o.children=e.children.filter(n=>n.has("named")).map(n=>Vd(n,n.name))),o}function Pc(e=2,t=1){let o=0;return{require:["scale"],update(){let n=Math.sin(o*e)*t;n<0&&this.destroy(),this.scale=$(n),o+=io()}}}function $p(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(o=1){this.setHP(e-o),this.trigger("hurt",o)},heal(o=1){let n=e;this.setHP(e+o),this.trigger("heal",e-n)},hp(){return e},maxHP(){return t??null},setMaxHP(o){t=o},setHP(o){e=t?Math.min(t,o):o,e<=0&&this.trigger("death")},onHurt(o){return this.on("hurt",o)},onHeal(o){return this.on("heal",o)},onDeath(o){return this.on("death",o)},inspect(){return`health: ${e}`}}}function Jp(e,t={}){if(e==null)throw new Error("lifespan() requires time");let o=t.fade??0;return{id:"lifespan",require:["opacity"],add(){x.game.root.wait(e,()=>{this.opacity=this.opacity??1,o>0?x.game.root.tween(this.opacity,0,o,n=>this.opacity=n,Zs.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function jp(e){return{id:"named",name:e}}function Zp(e,t,o){if(!e)throw new Error("state() requires an initial state");let n={};function s(c){n[c]||(n[c]={enter:new yo,end:new yo,update:new yo,draw:new yo})}function a(c,d,i){return s(d),n[d][c].add(i)}function r(c,d,...i){s(d),n[d][c].trigger(...i)}let l=!1;return{id:"state",state:e,enterState(c,...d){if(l=!0,t&&!t.includes(c))throw new Error(`State not found: ${c}`);let i=this.state;if(o){if(!o?.[i])return;let h=typeof o[i]=="string"?[o[i]]:o[i];if(!h.includes(c))throw new Error(`Cannot transition state from "${i}" to "${c}". Available transitions: ${h.map(u=>`"${u}"`).join(", ")}`)}r("end",i,...d),this.state=c,r("enter",c,...d),r("enter",`${i} -> ${c}`,...d)},onStateTransition(c,d,i){return a("enter",`${c} -> ${d}`,i)},onStateEnter(c,d){return a("enter",c,d)},onStateUpdate(c,d){return a("update",c,d)},onStateDraw(c,d){return a("draw",c,d)},onStateEnd(c,d){return a("end",c,d)},update(){l||(r("enter",e),l=!0),r("update",this.state)},draw(){r("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Wd(e){return{id:"stay",stay:!0,scenesToStay:e}}function Qp(e=!0,t){let o,n;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let s=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};o=x.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(x.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,s())}),n=x.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),s())})},destroy(){o.cancel(),n.cancel()}}}function er(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,o,n=1/0,s=!1){let a=s?0:t,r=new yo,l=this.onUpdate(()=>{a+=x.app.state.dt;for(let c=0;a>=t&&c<this.maxLoopsPerFrame;c++)if(n--,o(),a-=t,n<=0){l.cancel(),r.trigger();return}});return{get paused(){return l.paused},set paused(c){l.paused=c},cancel:l.cancel,onEnd(c){r.add(c)},then(c){return r.add(c),this}}},wait(t,o){return this.loop(t,o??(()=>{}),1,!0)},tween(t,o,n,s,a=Zs.linear){let r=0,l=[],c=this.onUpdate(()=>{r+=x.app.state.dt;let d=Math.min(r/n,1);s(So(t,o,a(d))),d===1&&(c.cancel(),s(o),l.forEach(i=>i()))});return{get paused(){return c.paused},set paused(d){c.paused=d},onEnd(d){l.push(d)},then(d){return this.onEnd(d),this},cancel(){c.cancel()},finish(){c.cancel(),s(o),l.forEach(d=>d())}}}}}var tr=0;function kp(){return tr>0}function eg(e={}){let t={},o=new Set,n=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){tr++,this.area.cursor&&n.push(this.onHover(()=>x.app.setCursor(this.area.cursor))),n.push(this.onCollideUpdate((s,a)=>{if(!s.id)throw new Error("area() requires the object to have an id");t[s.id]||this.trigger("collide",s,a),a&&(t[s.id]=a,o.add(s.id))}))},destroy(){tr--;for(let s of n)s.cancel()},fixedUpdate(){for(let s in t)o.has(Number(s))||(this.trigger("collideEnd",t[s].target),delete t[s]);o.clear()},drawInspect(){let s=this.localArea();Bo(),jt(this.area.offset);let a={outline:{width:4/cd(),color:Ht(0,0,255)},anchor:this.anchor,fill:!1,fixed:Xn(this)};s instanceof Yt?zo({...a,pos:s.pos,width:s.width*this.area.scale.x,height:s.height*this.area.scale.y}):s instanceof xo?Dn({...a,pts:s.pts,scale:this.area.scale}):s instanceof Do&&bs({...a,pos:s.center,radius:s.radius}),Eo()},area:{shape:e.shape??null,scale:e.scale?$(e.scale):$(1),offset:e.offset??$(0),cursor:e.cursor??null},isClicked(){return x.app.isMousePressed()&&this.isHovering()},isHovering(){let s=Xn(this)?x.k.mousePos():x.k.toWorld(x.k.mousePos());return this.hasPoint(s)},checkCollision(s){if(!s.id)throw new Error("checkCollision() requires the object to have an id");return t[s.id]??null},getCollisions(){return Object.values(t)},isColliding(s){if(!s.id)throw new Error("isColliding() requires the object to have an id");return!!t[s.id]},isOverlapping(s){if(!s.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[s.id];return a&&a.hasOverlap()},onClick(s,a="left"){let r=this.onMousePress(a,()=>{this.isHovering()&&s()});return n.push(r),r},onHover(s){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,s())})},onHoverUpdate(s){return this.onUpdate(()=>{this.isHovering()&&s()})},onHoverEnd(s){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,s()):a=this.isHovering()})},onCollide(s,a){if(typeof s=="function"&&a===void 0)return this.on("collide",s);if(typeof s=="string")return this.onCollide((r,l)=>{r.is(s)&&a?.(r,l)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(s,a){if(typeof s=="function"&&a===void 0)return this.on("collideUpdate",s);if(typeof s=="string")return this.on("collideUpdate",(r,l)=>r.is(s)&&a?.(r,l));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(s,a){if(typeof s=="function"&&a===void 0)return this.on("collideEnd",s);if(typeof s=="string")return this.on("collideEnd",r=>r.is(s)&&a?.(r));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(s){return In(this.worldArea(),s)},resolveCollision(s){let a=this.checkCollision(s);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let s=this.localArea();if(!(s instanceof xo||s instanceof Yt))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale($(this.area.scale??1));if(s instanceof Yt){let r=ws(this.anchor||ia).add(1,1).scale(-.5).scale(s.width,s.height);a.translate(r)}return s.transform(a)},screenArea(){let s=this.worldArea();return Xn(this)?s:s.transform(x.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function tg(e={}){let t=null,o=null,n=!1,s=$(0),a=null,r=null,l;return{id:"body",require:["pos"],vel:$(0),drag:e.drag??0,jumpForce:e.jumpForce??r0,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),r=this.pos.clone(),l=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((c,d)=>{if(!d||!c.has("body")||d.resolved)return;this.trigger("beforePhysicsResolve",d);let i=d.reverse();if(c.trigger("beforePhysicsResolve",i),!(d.resolved||i.resolved)&&!(this.isStatic&&c.isStatic)){if(!this.isStatic&&!c.isStatic){let h=this.mass+c.mass;this.pos=this.pos.add(d.displacement.scale(c.mass/h)),c.pos=c.pos.add(d.displacement.scale(-this.mass/h)),this.transform=Ks(this),c.transform=Ks(c)}else{let h=!this.isStatic&&c.isStatic?d:d.reverse();h.source.pos=h.source.pos.add(h.displacement),h.source.transform=Ks(h.source)}d.resolved=!0,this.trigger("physicsResolve",d),c.trigger("physicsResolve",d.reverse())}}),this.onPhysicsResolve(c=>{if(x.game.gravity)if(c.isBottom()&&this.isFalling()){this.vel=this.vel.reject(x.game.gravity.unit());let d=t;t=c.target,d!=t&&(o=c.target.pos),n?n=!1:d||(this.trigger("ground",t),c.target.trigger("land",this))}else c.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(x.game.gravity.unit()),this.trigger("headbutt",c.target),c.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(o&&!t.pos.eq(o)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(o)),o=t.pos);let c=$a();c&&(this.pos.x==l.x&&(this.pos.x=So(a.x,r.x,c/Wa()),l.x=this.pos.x),this.pos.y==l.y&&(this.pos.y=So(a.y,r.y,c/Wa()),l.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==l.x&&(this.pos.x=a.x),this.pos.y==l.y&&(this.pos.y=a.y),a=null),x.game.gravity&&!this.isStatic){n&&(t=null,o=null,this.trigger("fallOff"),n=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(n=!0);let c=this.vel.clone();this.vel=this.vel.add(x.game.gravity.scale(this.gravityScale*io()));let d=e.maxVelocity??c0;this.vel.slen()>d*d&&(this.vel=this.vel.unit().scale(d)),c.dot(x.game.gravity)<0&&this.vel.dot(x.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=s.x*io(),this.vel.y+=s.y*io(),this.vel.x*=1-this.drag*io(),this.vel.y*=1-this.drag*io(),this.move(this.vel),$a()){a=this.pos.clone();let c=this.vel.add(s.scale(io()));r=this.pos.add(c.scale(io())),l=this.pos.clone()}s.x=0,s.y=0},onPhysicsResolve(c){return this.on("physicsResolve",c)},onBeforePhysicsResolve(c){return this.on("beforePhysicsResolve",c)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(Ws())>0},isJumping(){return this.vel.dot(Ws())<0},applyImpulse(c){this.isStatic||(this.vel=this.vel.add(c))},addForce(c){this.isStatic||(s.x+=c.x/this.mass,s.y+=c.y/this.mass)},jump(c){this.isStatic||(t=null,o=null,this.vel=Ws().scale(-c||-this.jumpForce))},onGround(c){return this.on("ground",c)},onFall(c){return this.on("fall",c)},onFallOff(c){return this.on("fallOff",c)},onHeadbutt(c){return this.on("headbutt",c)},onLand(c){return this.on("land",c)},onHeadbutted(c){return this.on("headbutted",c)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function og(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(o){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(o))},onDoubleJump(o){return this.on("doubleJump",o)},inspect(){return`jumpsLeft: ${t}`}}}function ng(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,o)=>{let n=o?.normal.normal(),s=t.vel.project(n),a=n?.scale(this.speed)?.sub(s);t.addForce(a?.scale(t.mass*this.forceScale))})}}}function sg(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{if(!t.has("body"))return;let n=oe.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(n),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function ig(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{let n=this.pos.sub(t.pos),s=n.len(),a=s*this.distanceScale/10,r=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,l=n.scale(this.forceMagnitude*r/s);t.addForce(l),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function ag(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function rg(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let o=t.target.vel,n=Ws().scale(-1).angleBetween(o);Math.abs(n)>this.surfaceArc/2&&t.preventResolution()})}}}function cg(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,o)=>{let n=t,s=n.worldArea(),[a,r]=s.cut($(-100,this.surfaceLevel),$(100,this.surfaceLevel));a&&(this.applyBuoyancy(n,a),this.applyDrag(n,a)),this.flowMagnitude&&n.addForce(oe.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,o){let n=this.density*o.area(),s=$(0,1).scale(-n);t.addForce(s)},applyDrag(t,o){let n=t.vel,s=this.density*this.linearDrag,a=n.scale(-s);t.addForce(a)}}}function or(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function $d(){return{id:"fixed",fixed:!0}}function lg(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??$(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function dg(e){let t=x.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?x.game.layers?.[t]??null:null},set layer(o){if(t=x.game.layers?.indexOf(o),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function hg(e,t){let o=typeof e=="number"?oe.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(o.scale(t))}}}function ug(e={}){let t=!1,o=new Yt($(0),co(),uo()),n=new Yt($(0),0,0),s=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??xc,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(o.width=co(),o.height=uo(),!this.offscreenDistance&&this.width&&this.height)return n.width=this.width,n.height=this.height,n.pos=this.pos,n.collides(o);let r=this.offscreenDistance?this.offscreenDistance:xc;return!oa(o,a)&&o.sdistToPoint(a)>r*r},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?Cd(()=>s(this)):this.onUpdate(()=>s(this))}}}function Yi(...e){return{id:"pos",pos:$(...e),moveBy(...t){this.pos=this.pos.add($(...t))},move(...t){this.moveBy($(...t).scale(io()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo($(t[0],t[1]),t[2]);let o=t[0],n=t[1];if(n===void 0){this.pos=$(o);return}let s=o.sub(this.pos);if(s.len()<=n*io()){this.pos=$(o);return}this.move(s.unit().scale(n))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let o=this.worldPos();return o?Xn(this)?o:Qa(o):null}},toScreen(t){let o=this.toWorld(t);return Xn(this)?o:Qa(o)},fromScreen(t){return Xn(this)?this.fromWorld(t):this.fromWorld(Nd(t))},toOther(t,o){return t.fromWorld(this.toWorld(o))},fromOther(t,o){return t.toOther(this,o)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){bs({color:Ht(255,0,0),radius:4/cd()})}}}function fg(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function qi(...e){if(e.length===0)return qi(1);let t=$(...e);return{id:"scale",set scale(o){if(!(o instanceof oe))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=$(o)},get scale(){return t},scaleTo(...o){t=$(...o)},scaleBy(...o){t=t.scale($(...o))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function pg(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var gg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",mg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",yg=au.version,x={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},xg=(e={tagsAsComponents:!0})=>{x.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),x.k.quit()),x.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let o=e.canvas??t.appendChild(document.createElement("canvas"));x.canvas=o;let n=e.scale??1;x.gscale=n;let s=e.width&&e.height&&!e.stretch&&!e.letterbox;s?(o.width=e.width*n,o.height=e.height*n):(o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(s){let fe=o.width,Ce=o.height;a.push(`width: ${fe}px`),a.push(`height: ${Ce}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),o.style.cssText=a.join(";");let r=e.pixelDensity||1;x.pixelDensity=r,o.width*=r,o.height*=r,o.tabIndex=0;let l=document.createElement("canvas");l.width=256,l.height=256,x.fontCacheCanvas=l;let c=l.getContext("2d",{willReadFrequently:!0});x.fontCacheC2d=c;let d=U0({canvas:o,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});x.app=d;let i=[],h=d.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!h)throw new Error("WebGL not supported");let u=h,g=Pf(u,{texFilter:e.texFilter}),p=Nf(e,g);x.gfx=p;let T=Mp();x.audio=T;let m=hf(g,e.spriteAtlasPadding??0);x.assets=m;let M=bp();x.game=M,M.root.use(er());function P(fe,Ce){let le=new Xi(g,fe,Ce);return{clear:()=>le.clear(),free:()=>le.free(),toDataURL:()=>le.toDataURL(),toImageData:()=>le.toImageData(),width:le.width,height:le.height,draw:Re=>{Lo(),le.bind(),Re(),Lo(),le.unbind()},get fb(){return le}}}function f(){u.clear(u.COLOR_BUFFER_BIT),p.frameBuffer.bind(),u.clear(u.COLOR_BUFFER_BIT),p.bgColor||Sn(()=>{ei({width:co(),height:uo(),quad:new Jt(0,0,co()/64,uo()/64),tex:p.bgTex,fixed:!0})}),p.renderer.numDraws=0,p.fixed=!1,p.transformStack.length=0,p.transform=new sn}function _(fe,Ce){p.postShader=fe,p.postShaderUniform=Ce??null}function B(){Lo(),p.lastDrawCalls=p.renderer.numDraws,p.frameBuffer.unbind(),u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight);let fe=p.width,Ce=p.height;p.width=u.drawingBufferWidth/r,p.height=u.drawingBufferHeight/r,Fi({flipY:!0,tex:p.frameBuffer.tex,pos:new oe(p.viewport.x,p.viewport.y),width:p.viewport.width,height:p.viewport.height,shader:p.postShader,uniform:typeof p.postShaderUniform=="function"?p.postShaderUniform():p.postShaderUniform,fixed:!0}),Lo(),p.width=fe,p.height=Ce}let b=!1,S={inspect:!1,set timeScale(fe){x.app.state.timeScale=fe},get timeScale(){return x.app.state.timeScale},showLog:!0,fps:()=>d.fps(),numFrames:()=>d.numFrames(),stepFrame:se,drawCalls:()=>p.lastDrawCalls,clearLog:()=>M.logs=[],log:(...fe)=>{let Ce=e.logMax??8,le=fe.length>1?fe.concat(" ").join(" "):fe[0];M.logs.unshift({msg:le,time:d.time()}),M.logs.length>Ce&&(M.logs=M.logs.slice(0,Ce))},error:fe=>S.log(new Error(fe.toString?fe.toString():fe)),curRecording:null,numObjects:()=>H("*",{recursive:!0}).length,get paused(){return b},set paused(fe){b=fe,fe?T.ctx.suspend():T.ctx.resume()}};x.debug=S;function E(fe,Ce){try{return JSON.parse(window.localStorage[fe])}catch{return Ce?(C(fe,Ce),Ce):null}}function C(fe,Ce){window.localStorage[fe]=JSON.stringify(Ce)}function A(fe,...Ce){let le=fe(Te),Re;typeof le=="function"?Re=le(...Ce)(Te):Re=le;for(let Xe in Re)Te[Xe]=Re[Xe],e.global!==!1&&(window[Xe]=Re[Xe]);return Te}function z(fe){let Ce=d.canvas.captureStream(fe),le=T.ctx.createMediaStreamDestination();T.masterNode.connect(le);let Re=new MediaRecorder(Ce),Xe=[];return Re.ondataavailable=Se=>{Se.data.size>0&&Xe.push(Se.data)},Re.onerror=()=>{T.masterNode.disconnect(le),Ce.getTracks().forEach(Se=>Se.stop())},Re.start(),{resume(){Re.resume()},pause(){Re.pause()},stop(){return Re.stop(),T.masterNode.disconnect(le),Ce.getTracks().forEach(Se=>Se.stop()),new Promise(Se=>{Re.onstop=()=>{Se(new Blob(Xe,{type:"video/mp4"}))}})},download(Se="kaboom.mp4"){this.stop().then(it=>wc(Se,it))}}}function R(){return document.activeElement===d.canvas}let Y=M.root.add.bind(M.root),U=M.root.readd.bind(M.root),N=M.root.removeAll.bind(M.root),H=M.root.get.bind(M.root),I=M.root.wait.bind(M.root),F=M.root.loop.bind(M.root),V=M.root.query.bind(M.root),j=M.root.tween.bind(M.root),ce=Vs(null,mg),ie=Vs(null,gg);x.kaSprite=ce,x.boomSprite=ie;function ne(){M.root.fixedUpdate()}function se(){M.root.update()}class ge{source;target;normal;distance;resolved=!1;constructor(Ce,le,Re,Xe,Se=!1){this.source=Ce,this.target=le,this.normal=Re,this.distance=Xe,this.resolved=Se}get displacement(){return this.normal.scale(this.distance)}reverse(){return new ge(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(M.gravity||$(0,1))>0}isRight(){return this.displacement.cross(M.gravity||$(0,1))<0}isTop(){return this.displacement.dot(M.gravity||$(0,1))>0}isBottom(){return this.displacement.dot(M.gravity||$(0,1))<0}preventResolution(){this.resolved=!0}}function ve(){if(!kp())return;let fe={},Ce=e.hashGridSize||64,le=new sn,Re=[];function Xe(Se){if(Re.push(le.clone()),Se.pos&&le.translate(Se.pos),Se.scale&&le.scale(Se.scale),Se.angle&&le.rotate(Se.angle),Se.transform=le.clone(),Se.c("area")&&!Se.paused){let it=Se,We=it.worldArea().bbox(),Et=Math.floor(We.pos.x/Ce),Ct=Math.floor(We.pos.y/Ce),Pe=Math.ceil((We.pos.x+We.width)/Ce),Fe=Math.ceil((We.pos.y+We.height)/Ce),Ae=new Set;for(let Ie=Et;Ie<=Pe;Ie++)for(let Ye=Ct;Ye<=Fe;Ye++)if(!fe[Ie])fe[Ie]={},fe[Ie][Ye]=[it];else if(!fe[Ie][Ye])fe[Ie][Ye]=[it];else{let je=fe[Ie][Ye];e:for(let lt of je){if(lt.paused||!lt.exists()||Ae.has(lt.id))continue;for(let rt of it.collisionIgnore)if(lt.is(rt))continue e;for(let rt of lt.collisionIgnore)if(it.is(rt))continue e;let dt=Wu(it.worldArea(),lt.worldArea());if(dt){let rt=new ge(it,lt,dt.normal,dt.distance);it.trigger("collideUpdate",lt,rt);let gt=rt.reverse();gt.resolved=rt.resolved,lt.trigger("collideUpdate",it,gt)}Ae.add(lt.id)}je.push(it)}}Se.children.forEach(Xe),le=Re.pop()}Xe(M.root)}function Oe(fe){console.error(fe),T.ctx.suspend();let Ce=fe.message??String(fe)??"Unknown error, check console for more info";d.run(()=>{},()=>{f(),Sn(()=>{let le=co(),Re=uo(),Xe={size:36,width:le-64,letterSpacing:4,lineSpacing:4,font:Ni,fixed:!0};zo({width:le,height:Re,color:Ht(0,0,255),fixed:!0});let Se=Kn({...Xe,text:"Error",pos:$(32),color:Ht(255,128,0),fixed:!0});Vn(Se),Rc({...Xe,text:Ce,pos:$(32,32+Se.height+16),fixed:!0}),Eo(),M.events.trigger("error",fe)}),B()})}function Ee(fe){i.push(fe)}function Ne(){M.events.onOnce("frameEnd",()=>{d.quit(),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);let fe=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(let Ce=0;Ce<fe;Ce++)u.activeTexture(u.TEXTURE0+Ce),u.bindTexture(u.TEXTURE_2D,null),u.bindTexture(u.TEXTURE_CUBE_MAP,null);u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),g.destroy(),i.forEach(Ce=>Ce())})}let et=!0;d.run(()=>{try{m.loaded&&(S.paused||ne(),ve())}catch(fe){Oe(fe)}},(fe,Ce)=>{try{fe(),m.loaded||Gn()===1&&!et&&(m.loaded=!0,dd().forEach(le=>M.events.trigger("loadError",...le)),M.events.trigger("load")),!m.loaded&&e.loadingScreen!==!1||et?(f(),zf(),B()):(S.paused||se(),ve(),f(),Lf(),e.debug!==!1&&Bf(),B()),et&&(et=!1),M.events.trigger("frameEnd"),Ce()}catch(le){Oe(le)}}),rd(),Yd();let Te={_k:x,VERSION:yg,loadRoot:cf,loadProgress:Gn,loadSprite:Vs,loadSpriteAtlas:xd,loadSound:Sf,loadMusic:Mf,loadBitmapFont:yf,loadFont:gf,loadShader:vf,loadShaderURL:Ef,loadAseprite:pf,loadPedit:xf,loadBean:ff,loadJSON:lf,load:Ja,getSound:yd,getFont:pd,getBitmapFont:gd,getSprite:hd,getShader:md,getAsset:df,Asset:Uo,SpriteData:Pn,SoundData:ks,width:co,height:uo,center:_i,dt:io,fixedDt:Wa,restDt:$a,time:d.time,screenshot:d.screenshot,record:z,isFocused:R,setCursor:d.setCursor,getCursor:d.getCursor,setCursorLocked:d.setCursorLocked,isCursorLocked:d.isCursorLocked,setFullscreen:d.setFullscreen,isFullscreen:d.isFullscreen,isTouchscreen:d.isTouchscreen,onLoad:zr,onLoadError:up,onLoading:lp,onResize:dp,onGamepadConnect:d.onGamepadConnect,onGamepadDisconnect:d.onGamepadDisconnect,onError:hp,onCleanup:Ee,flash:Ud,setCamPos:Pd,getCamPos:Bd,setCamRot:Od,getCamRot:Hd,setCamScale:Ld,getCamScale:zd,getCamTransform:fp,camPos:mp,camScale:yp,camFlash:wp,camRot:xp,camTransform:pp,shake:gp,toScreen:Qa,toWorld:Nd,setGravity:vp,getGravity:Ep,setGravityDirection:Ap,getGravityDirection:Ws,setBackground:tf,getBackground:of,getGamepads:d.getGamepads,getTreeRoot:Lp,add:Y,make:Or,destroy:Gd,destroyAll:N,get:H,query:V,readd:U,pos:Yi,scale:qi,rotate:fg,color:Sd,opacity:Md,anchor:or,area:eg,sprite:ka,text:Np,polygon:Vf,rect:Dd,circle:_f,uvquad:_p,outline:qf,particles:Kf,body:tg,platformEffector:rg,surfaceEffector:ng,areaEffector:sg,pointEffector:ig,buoyancyEffector:cg,constantForce:ag,doubleJump:og,shader:Wf,textInput:Qp,timer:er,fixed:$d,stay:Wd,health:$p,lifespan:Jp,named:jp,state:Zp,z:pg,layer:dg,move:hg,offscreen:ug,follow:lg,fadeIn:Ff,mask:Yf,drawon:Xf,raycast:Td,tile:Kd,animate:Wp,serializeAnimation:Vd,agent:Xp,sentry:qp,patrol:Yp,pathfinder:Fp,trigger:Jf,on:Ro,onFixedUpdate:jf,onUpdate:Cd,onDraw:Zf,onAdd:Rd,onDestroy:Qf,onTag:Id,onUntag:tp,onUse:kf,onUnuse:ep,onClick:ip,onCollide:op,onCollideUpdate:np,onCollideEnd:sp,onHover:ap,onHoverUpdate:rp,onHoverEnd:cp,onKeyDown:d.onKeyDown,onKeyPress:d.onKeyPress,onKeyPressRepeat:d.onKeyPressRepeat,onKeyRelease:d.onKeyRelease,onMouseDown:d.onMouseDown,onMousePress:d.onMousePress,onMouseRelease:d.onMouseRelease,onMouseMove:d.onMouseMove,onCharInput:d.onCharInput,onTouchStart:d.onTouchStart,onTouchMove:d.onTouchMove,onTouchEnd:d.onTouchEnd,onScroll:d.onScroll,onHide:d.onHide,onShow:d.onShow,onGamepadButtonDown:d.onGamepadButtonDown,onGamepadButtonPress:d.onGamepadButtonPress,onGamepadButtonRelease:d.onGamepadButtonRelease,onGamepadStick:d.onGamepadStick,onButtonPress:d.onButtonPress,onButtonDown:d.onButtonDown,onButtonRelease:d.onButtonRelease,mousePos:d.mousePos,mouseDeltaPos:d.mouseDeltaPos,isKeyDown:d.isKeyDown,isKeyPressed:d.isKeyPressed,isKeyPressedRepeat:d.isKeyPressedRepeat,isKeyReleased:d.isKeyReleased,isMouseDown:d.isMouseDown,isMousePressed:d.isMousePressed,isMouseReleased:d.isMouseReleased,isMouseMoved:d.isMouseMoved,isGamepadButtonPressed:d.isGamepadButtonPressed,isGamepadButtonDown:d.isGamepadButtonDown,isGamepadButtonReleased:d.isGamepadButtonReleased,getGamepadStick:d.getGamepadStick,isButtonPressed:d.isButtonPressed,isButtonDown:d.isButtonDown,isButtonReleased:d.isButtonReleased,setButton:d.setButton,getButton:d.getButton,pressButton:d.pressButton,releaseButton:d.releaseButton,getLastInputDeviceType:d.getLastInputDeviceType,charInputted:d.charInputted,loop:F,wait:I,play:Dp,setVolume:Xd,getVolume:Fd,volume:Cp,burp:_d,audioCtx:T.ctx,Line:Co,Rect:Yt,Circle:Do,Ellipse:gn,Point:Ru,Polygon:xo,Vec2:oe,Color:vt,Mat4:sn,Quad:Jt,RNG:Ul,rand:so,randi:Nl,randSeed:hu,vec2:$,rgb:Ht,hsl2rgb:ru,quad:eo,choose:pu,chooseMultiple:fu,shuffle:_l,chance:uu,lerp:So,tween:j,easings:Zs,map:en,mapc:cu,wave:Hl,deg2rad:to,rad2deg:qn,clamp:nn,evaluateQuadratic:Pu,evaluateQuadraticFirstDerivative:Bu,evaluateQuadraticSecondDerivative:Lu,evaluateBezier:Tr,evaluateBezierFirstDerivative:zu,evaluateBezierSecondDerivative:Ou,evaluateCatmullRom:Hu,evaluateCatmullRomFirstDerivative:Uu,curveLengthApproximation:Jl,normalizedCurve:Nu,hermite:ai,cardinal:jl,catmullRom:Ui,bezier:_u,kochanekBartels:Xu,easingSteps:Vu,easingLinear:Gu,easingCubicBezier:Ku,testLineLine:br,testRectRect:Xl,testRectLine:vr,testRectPoint:oa,testCirclePolygon:sa,testLinePoint:Er,testLineCircle:ii,isConvex:Qu,triangulate:Ql,NavMesh:k0,drawSprite:Hf,drawText:Rc,formatText:Kn,drawRect:zo,drawLine:_s,drawLines:Lr,drawTriangle:Ed,drawCircle:bs,drawEllipse:wd,drawUVQuad:ei,drawPolygon:Dn,drawCurve:bd,drawBezier:Rf,drawFormattedText:Vn,drawMasked:Of,drawSubtracted:Uf,pushTransform:Bo,popTransform:Eo,pushTranslate:jt,pushScale:Qs,pushRotate:hs,pushMatrix:nf,usePostEffect:_,makeCanvas:P,debug:S,scene:zp,getSceneName:Up,go:Op,onSceneLeave:Hp,layers:Bp,getLayers:Ip,setLayers:qd,getDefaultLayer:Pp,addLevel:$f,getData:E,setData:C,download:Cr,downloadJSON:p0,downloadText:id,downloadBlob:wc,plug:A,ASCII_CHARS:kl,canvas:d.canvas,addKaboom:Rp,LEFT:oe.LEFT,RIGHT:oe.RIGHT,UP:oe.UP,DOWN:oe.DOWN,RED:vt.RED,GREEN:vt.GREEN,BLUE:vt.BLUE,YELLOW:vt.YELLOW,MAGENTA:vt.MAGENTA,CYAN:vt.CYAN,WHITE:vt.WHITE,BLACK:vt.BLACK,quit:Ne,KEvent:yo,KEventHandler:js,KEventController:Qn,cancel:()=>td};x.k=Te;let Mt=e.plugins;if(Mt&&Mt.forEach(A),e.global!==!1)for(let fe in Te)window[fe]=Te[fe];return e.focus!==!1&&d.canvas.focus(),Te},wg=xg;const Bc=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Royal","Noble","Rogue","Savage","Reigning","Rising","Rookie","Veteran","Seasoned","Underdog","Favored","Viral","Trending","Famous","Infamous","Ultimate","Supreme","Grand","Major","Premier","Star","Main","Top","Peak","Apex","Brutal","Ruthless","Vicious","Crushing","Raging","Furious","Frenzied","Berserk","Mad","Crazy","Lethal","Deadly","Fatal","Killer","Murder","Immortal","Eternal","Heavy","Hard","Tough","Gritty","Scrappy","Mean","Nasty","Dirty","Raw","Primal","Amazing","Awesome","Dazzling","Stunning","Shocking","Dynamic","Radical","Extreme","Intense","Hyper","Ultra","Mega","Super","Power","Atomic","Nuclear","Chaos","Havoc","Mayhem","Rampage","Carnage","Cocky","Sneaky","Tricky","Sly","Cunning","Wicked","Evil","Sinister","Twisted","Crooked","Lucky","Unlucky","Cursed","Blessed","Chosen","Lone","Solo","Outlaw","Rebel","Bandit"],Lc=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter","Finalist","Victor","Winner","Champ","Hopeful","Prospect","Wildcard","Underdog","Favorite","Prodigy","Rookie","Veteran","Pro","Amateur","Phenom","Showman","Icon","Brawler","Bruiser","Slugger","Puncher","Boxer","Fighter","Scrapper","Battler","Duelist","Crusher","Smasher","Basher","Masher","Thrasher","Pummeler","Pounder","Hammer","Mauler","Mangler","Knockout","Haymaker","Uppercut","Jab","Hook","Spartan","Viking","Wrecking","Rampage","Havoc","Mayhem","Chaos","Carnage","Fury","Menace","Terror","Horror","Dread","Fist","Knuckle","Claw","Talon","Spike","Axe","Hammer","Mace","Flail","Club","Cannon","Mortar","Missile","Bomb","Grenade","Shiv","Machete","Cleaver","Hatchet","Gorilla","Rhino","Bull","Boar","Pitbull","Doberman","Mastiff","Bulldog","Scorpion","Mantis","Hornet","Wasp","Spider","Croc","Gator","Piranha","Orca","Hyena","Jackal","Badger","Warthog","Mongoose","Outlaw","Bandit","Thug","Goon","Hooligan","Punk","Rebel","Maverick","Renegade","Assassin","Bounty","Hitman","Enforcer","Boss","Kingpin","Warlord","Overlord","Tyrant"];function nr(){const e=Bc[Math.floor(Math.random()*Bc.length)],t=Lc[Math.floor(Math.random()*Lc.length)];return`${e}${t}`}function sr(){return Math.floor(1e5+Math.random()*9e5).toString()}function bg(e){return/^\d{6}$/.test(e)}const an={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:2},hint:"Progress further into the facility"},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:3},hint:"Keep pushing deeper"},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:5},hint:"The halfway point awaits",unlocks:["trailIce"]},floor10:{id:"floor10",name:"Double Digits",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:10},unlocks:["plasmaRifle"]},firstSynergy:{id:"firstSynergy",name:"Combo Starter",description:"Activate your first synergy",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect upgrades that work together",unlocks:["trailShadow"]},allCharacters:{id:"allCharacters",name:"Full Roster",description:"Unlock all characters",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Progress through floors to unlock characters"},maxUpgrade:{id:"maxUpgrade",name:"Maxed Out",description:"Max out a permanent upgrade",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Purchase the same upgrade multiple times"},firstDoor:{id:"firstDoor",name:"Door Explorer",description:"Enter a special door",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Find and enter a special door in a room"},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1},hint:"Defeat any enemy"},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:100},hint:"Keep fighting!",unlocks:["trailFire"]},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:500},hint:"The carnage continues",unlocks:["trailPoison"]},kill1000:{id:"kill1000",name:"Rampage",description:"Kill 1000 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1e3},hint:"A true warrior emerges"},killStreak10:{id:"killStreak10",name:"On Fire",description:"Kill 10 enemies in 5 seconds",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Defeat enemies rapidly",unlocks:["deathVaporize"]},multikill:{id:"multikill",name:"Multi-Kill",description:"Kill 5 enemies with one attack",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Use piercing or explosive attacks",unlocks:["deathPixelate"]},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:1},hint:"Clear Floor 1 to face a boss",unlocks:["deathExplosion"]},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:5},hint:"Keep defeating floor bosses",unlocks:["deathDisintegrate"]},boss10:{id:"boss10",name:"Boss Veteran",description:"Defeat 10 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:10},hint:"Experience makes perfect"},boss25:{id:"boss25",name:"Boss Crusher",description:"Defeat 25 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:25},unlocks:["railgun"],hint:"Become a boss-hunting expert"},boss50:{id:"boss50",name:"Boss Destroyer",description:"Defeat 50 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:50},hint:"The ultimate boss hunter"},minibossSlayer:{id:"minibossSlayer",name:"Miniboss Hunter",description:"Defeat 10 minibosses",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalMinibossesKilled",value:10},hint:"Minibosses appear in later rooms"},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:1},hint:"Play until you die (or win!)"},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:10},hint:"Practice makes progress"},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:50},hint:"A true fan of the show"},run100:{id:"run100",name:"Century",description:"Complete 100 runs",category:"run",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRuns",value:100},hint:"The ultimate dedication"},quickDeath:{id:"quickDeath",name:"Speedrun Fail",description:"Die within 30 seconds",category:"run",icon:"",unlocked:!1,difficulty:"normal",hint:"Sometimes things go wrong fast"},longRun:{id:"longRun",name:"Marathon",description:"Survive for 30 minutes",category:"run",icon:"",unlocked:!1,difficulty:"challenge",hint:"Keep surviving as long as possible"},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:10},hint:"Collect XP and level up"},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:20},hint:"Keep grinding for XP"},level30:{id:"level30",name:"Powerhouse",description:"Reach level 30 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:30},hint:"Build becomes unstoppable"},level50:{id:"level50",name:"Unstoppable",description:"Reach level 50 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:50},hint:"Ultimate power achieved"},upgradeCollector:{id:"upgradeCollector",name:"Collector",description:"Have 15 upgrades at once",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect many different upgrades"},synergyMaster:{id:"synergyMaster",name:"Synergy Master",description:"Activate 3 synergies in one run",category:"upgrade",icon:"",unlocked:!1,difficulty:"challenge",hint:"Build for multiple synergy combos",unlocks:["trailRainbow"]},earn100:{id:"earn100",name:"Pocket Change",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:100},hint:"Play runs to earn credits"},earn500:{id:"earn500",name:"Savings Account",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:500},hint:"Keep earning and saving",unlocks:["glowGold"]},earn1000:{id:"earn1000",name:"Money Bags",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:1e3},hint:"A fortune awaits"},earn5000:{id:"earn5000",name:"Fortune",description:"Earn 5000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:5e3},hint:"Building an empire"},earn10000:{id:"earn10000",name:"Tycoon",description:"Earn 10000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:1e4},hint:"The ultimate collector"},bigSpender:{id:"bigSpender",name:"Big Spender",description:"Spend 1000 credits in the shop",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencySpent",value:1e3},hint:"Buy upgrades from the shop"},perfectFloor:{id:"perfectFloor",name:"Untouchable",description:"Clear a floor without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Dodge everything on an entire floor",unlocks:["glowVoid"]},speedRunner:{id:"speedRunner",name:"Speed Demon",description:"Clear Floor 3 in under 5 minutes",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Rush through the first 3 floors",unlocks:["glowElectric"]},bossRush:{id:"bossRush",name:"Boss Rush",description:"Defeat 3 bosses in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Reach and defeat multiple floor bosses"},noHitBoss:{id:"noHitBoss",name:"Flawless Victory",description:"Defeat a boss without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Perfect boss fight execution"},glassCannonWin:{id:"glassCannonWin",name:"Living Dangerously",description:"Defeat a boss while below 25% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Living dangerously pays off"},closeCall:{id:"closeCall",name:"Close Call",description:"Survive with 1 HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Get very close to death but survive",unlocks:["glowCrimson"]},pacifist:{id:"pacifist",name:"Pacifist Start",description:"Clear Room 1 without attacking",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Just dodge everything"},noDamageRoom:{id:"noDamageRoom",name:"Perfect Room",description:"Clear 5 rooms without damage in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Master your dodging skills"},kill5000:{id:"kill5000",name:"Exterminator",description:"Kill 5,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:5e3},hint:"A lifetime of combat"},kill10000:{id:"kill10000",name:"Annihilator",description:"Kill 10,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:1e4},hint:"The ultimate destroyer"},floor15:{id:"floor15",name:"Deep Delver",description:"Reach Floor 15",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:15},hint:"Go deeper than ever before"},floor20:{id:"floor20",name:"Abyssal",description:"Reach Floor 20",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:20},hint:"The final frontier"},rooms100:{id:"rooms100",name:"Room Master",description:"Clear 100 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRoomsCleared",value:100},hint:"Clear many rooms across all runs"},rooms500:{id:"rooms500",name:"Hall Walker",description:"Clear 500 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRoomsCleared",value:500},hint:"Keep exploring"},firstPickup:{id:"firstPickup",name:"Loot Goblin",description:"Collect your first pickup",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Pick up health, XP, or other items"},healingAddict:{id:"healingAddict",name:"Healing Addict",description:"Collect 50 health pickups",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalHealthPickups",value:50},hint:"Stay alive by healing"},xpHoarder:{id:"xpHoarder",name:"XP Hoarder",description:"Collect 1000 XP orbs",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalXpOrbs",value:1e3},hint:"Collect all those green orbs"},comeback:{id:"comeback",name:"Comeback King",description:"Win a room after being below 10% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Never give up!"}},Oo={normal:[200,200,200],challenge:[255,200,100],benchmark:[200,150,255]},zc={normal:25,challenge:50,benchmark:100};function Jd(e){return!e||e.unlocks&&e.unlocks.length>0?0:e.reward!==void 0?e.reward:zc[e.difficulty]||zc.normal}function vg(e){return Object.values(an).filter(t=>t.category===e)}function Eg(){const e=new Set;return Object.values(an).forEach(t=>e.add(t.category)),Array.from(e)}function jd(e){return an[e]||null}function Gi(e,t){const o=an[e];if(!o||!o.threshold)return null;const n=t[o.threshold.stat]||0,s=o.threshold.value,a=Math.min(n/s,1);return{current:n,target:s,progress:a,percentage:Math.round(a*100)}}const $t={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"},bomber:{name:"The Bomber",description:"Explosive specialist, +50% blast radius, projectiles explode on hit",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"boss10"},char:"",color:[255,100,100],stats:{health:85,speed:130,damage:15},weapon:"launcher",ability:"explosiveShots"},engineer:{name:"The Engineer",description:"Support class, +2 orbital drones that auto-attack nearby enemies",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"level20"},char:"",color:[100,200,255],stats:{health:80,speed:140,damage:8},weapon:"pistol",ability:"orbitalDrones"},vampire:{name:"The Vampire",description:"Lifesteal specialist, +15% lifesteal, -20% max health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"kill1000"},char:"",color:[180,50,180],stats:{health:70,speed:160,damage:14},weapon:"smg",ability:"vampiric"},berserker:{name:"The Berserker",description:"Rage mode, +100% damage below 30% HP, takes +25% more damage",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"glassCannonWin"},char:"",color:[255,50,50],stats:{health:120,speed:140,damage:18},weapon:"shotgun",ability:"rage"},ghost:{name:"The Ghost",description:"Evasion master, +25% dodge chance, +15% crit, lower health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"perfectFloor"},char:"",color:[200,200,255],stats:{health:60,speed:180,damage:11},weapon:"smg",ability:"ethereal"}},Zd={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0},spreadShot:{name:"Spread Shot",description:"Fires 3 projectiles in a cone, lower damage each",cost:250,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2}},boomerang:{name:"Boomerang Blaster",description:"Projectiles return, hitting enemies twice",cost:400,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},chainLightning:{name:"Chain Lightning",description:"Bounces to 3 nearby enemies, -20% per bounce",cost:500,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},railgun:{name:"Railgun",description:"Pierces ALL enemies in a line, 3s cooldown",cost:600,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4},requiredAchievement:"boss25"},homingMissiles:{name:"Homing Missiles",description:"Slower projectiles that track enemies",cost:700,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4}},plasmaRifle:{name:"Plasma Rifle",description:"High damage, penetrates 2 enemies",cost:800,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:5},requiredAchievement:"floor10"}},ls={trailNone:{name:"No Trail",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"trail"},trailFire:{name:"Fire Trail",description:"Leave a blazing trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[255,100,50],requiredAchievement:"kill100"},trailIce:{name:"Ice Trail",description:"Leave a frosty trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,200,255],requiredAchievement:"floor5"},trailPoison:{name:"Toxic Trail",description:"Leave a poisonous trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,255,100],requiredAchievement:"kill500"},trailShadow:{name:"Shadow Trail",description:"Leave a dark trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[80,50,120],requiredAchievement:"firstSynergy"},trailRainbow:{name:"Rainbow Trail",description:"Leave a colorful trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:"rainbow",requiredAchievement:"synergyMaster"},deathNone:{name:"Standard Death",description:"Default enemy death effect",cost:0,unlockedByDefault:!0,category:"death"},deathExplosion:{name:"Explosive Death",description:"Enemies explode dramatically",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"firstBoss"},deathDisintegrate:{name:"Disintegration",description:"Enemies crumble into particles",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"boss5"},deathVaporize:{name:"Vaporize",description:"Enemies vanish in a puff of smoke",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"killStreak10"},deathPixelate:{name:"Pixelate",description:"Enemies break into pixels",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"multikill"},deathFireworks:{name:"Fireworks",description:"Enemies burst like fireworks",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"floor10"},glowNone:{name:"No Glow",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"glow"},glowGold:{name:"Golden Aura",description:"Radiate a golden glow",cost:0,unlockedByDefault:!1,category:"glow",color:[255,200,50],requiredAchievement:"earn500"},glowCrimson:{name:"Crimson Aura",description:"Radiate a blood-red glow",cost:0,unlockedByDefault:!1,category:"glow",color:[200,50,50],requiredAchievement:"closeCall"},glowElectric:{name:"Electric Aura",description:"Crackle with electricity",cost:0,unlockedByDefault:!1,category:"glow",color:[100,150,255],requiredAchievement:"speedRunner"},glowVoid:{name:"Void Aura",description:"Emanate dark energy",cost:0,unlockedByDefault:!1,category:"glow",color:[50,0,80],requiredAchievement:"perfectFloor"}},Qd={healthPack:{name:"Health Pack",description:"Start next run with +30 bonus HP",cost:30,consumable:!0,effect:{type:"startingHealth",value:30}},damageAmp:{name:"Damage Amp",description:"+25% damage for first floor",cost:35,consumable:!0,effect:{type:"tempDamage",value:.25,duration:"floor"}},speedSerum:{name:"Speed Serum",description:"+30% speed for first floor",cost:25,consumable:!0,effect:{type:"tempSpeed",value:.3,duration:"floor"}},wealthCharm:{name:"Wealth Charm",description:"+30% credits earned this run",cost:50,consumable:!0,effect:{type:"creditMultiplier",value:.3,duration:"run"}},luckyCoin:{name:"Lucky Coin",description:"+15% crit chance for first floor",cost:40,consumable:!0,effect:{type:"tempCrit",value:.15,duration:"floor"}},armorPlating:{name:"Armor Plating",description:"+20% damage reduction for first floor",cost:45,consumable:!0,effect:{type:"tempDefense",value:.2,duration:"floor"}},xpBooster:{name:"XP Booster",description:"+50% XP gained for first floor",cost:40,consumable:!0,effect:{type:"tempXP",value:.5,duration:"floor"}},emergencyRevive:{name:"Emergency Revive",description:"Auto-revive once at 25% HP",cost:75,consumable:!0,effect:{type:"autoRevive",value:.25,uses:1}}},Ag={startingHealth:{name:"Starting Health +10",description:"Start the show with +10 max health",cost:50,maxLevel:5,tier:1},startingDamage:{name:"Starting Damage +1",description:"Start the show with +1 damage",cost:75,maxLevel:5,tier:1},startingSpeed:{name:"Starting Speed +10",description:"Start the show with +10 speed",cost:60,maxLevel:5,tier:1},xpMagnet:{name:"XP Magnet",description:"+15% XP pickup radius per level",cost:60,maxLevel:5,tier:2},propDurability:{name:"Prop Durability",description:"Props last +2 seconds per level",cost:80,maxLevel:5,tier:2},propDropChance:{name:"Prop Drop Chance",description:"+5% prop drop chance per level",cost:100,maxLevel:5,tier:2},creditBonus:{name:"Credit Bonus",description:"+8% credits earned per level",cost:120,maxLevel:5,tier:2},luckyStart:{name:"Lucky Start",description:"+5% starting crit chance per level",cost:100,maxLevel:4,tier:3},thickSkin:{name:"Thick Skin",description:"+3% damage reduction per level",cost:100,maxLevel:5,tier:3},secondWind:{name:"Second Wind",description:"+5% revive health per level (up to 25%)",cost:150,maxLevel:4,tier:3},bossBounty:{name:"Boss Bounty",description:"+15 bonus credits per boss kill",cost:150,maxLevel:3,tier:3},mulligan:{name:"Mulligan",description:"+1 reroll per run for upgrade drafts",cost:300,maxLevel:3,tier:4},comfortZone:{name:"Comfort Zone",description:"+0.1s invulnerability after hit",cost:200,maxLevel:3,tier:4},toughChoices:{name:"Tough Choices",description:"+1 upgrade option in drafts (4 total)",cost:500,maxLevel:1,tier:4},headStart:{name:"Head Start",description:"Begin each run at level 2",cost:750,maxLevel:1,tier:4}};function Sg(e){switch(e){case"characters":return $t;case"weapons":return Zd;case"permanentUpgrades":return Ag;case"cosmetics":return ls;case"boosters":return Qd;default:return{}}}const kd="superSmashTexty_save",Mg="$",ir={version:1,currency:0,playerName:null,inviteCode:null,totalXP:0,playerLevel:1,selectedPortrait:"default",unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[],portraits:["default"]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0,totalPlayTime:0,fastestRunTime:0},achievements:[],runHistory:[]},Oc=20;function mt(){try{const t=localStorage.getItem(kd);if(t){const o=JSON.parse(t),n={...ir,...o};return n.playerName||(n.playerName=nr(),Qt(n)),n.inviteCode||(n.inviteCode=sr(),Qt(n)),n}}catch(t){console.error("Error loading save:",t)}const e={...ir};return e.playerName=nr(),e.inviteCode=sr(),Qt(e),e}function Qt(e){try{return localStorage.setItem(kd,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function Tg(){return mt()}function ds(e){const t=mt();return t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+e),Qt(t),t.currency}function $n(){return mt().currency}function Yo(e,t){const o=mt();return o.unlocks[e]&&o.unlocks[e].includes(t)}function eh(e,t){const o=mt();return o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)?!1:(o.unlocks[e].push(t),Qt(o),!0)}function Hc(e){mt();let t=!1;for(const[o,n]of Object.entries($t))n.unlockRequirement&&n.unlockRequirement.type==="floor"&&e>=n.unlockRequirement.value&&(Yo("characters",o)||(eh("characters",o),t=!0));return t}function Dg(e){let t=[];for(const[o,n]of Object.entries($t))n.unlockRequirement&&n.unlockRequirement.type==="achievement"&&n.unlockRequirement.value===e&&(Yo("characters",o)||(eh("characters",o),t.push({type:"character",key:o,name:n.name})));return t}function mn(){return mt().selectedCharacter||"survivor"}function Uc(e){const t=mt();t.selectedCharacter=e,Qt(t)}function Pt(e){const t=mt();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function Cg(e,t,o){const n=mt();return n.currency>=o?(n.currency-=o,n.unlocks[e]||(n.unlocks[e]=[]),n.unlocks[e].includes(t)||n.unlocks[e].push(t),Qt(n),!0):!1}function th(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function Rg(e,t,o){const n=mt(),s=Pt(e);return o&&s>=o?{success:!1,reason:"maxLevel"}:n.currency<t?{success:!1,reason:"insufficientCurrency"}:(n.currency-=t,n.permanentUpgradeLevels||(n.permanentUpgradeLevels={}),n.permanentUpgradeLevels[e]=(s||0)+1,n.permanentUpgradePurchaseHistory||(n.permanentUpgradePurchaseHistory={}),n.permanentUpgradePurchaseHistory[e]||(n.permanentUpgradePurchaseHistory[e]=[]),n.permanentUpgradePurchaseHistory[e].push(t),n.unlocks.permanentUpgrades||(n.unlocks.permanentUpgrades=[]),n.unlocks.permanentUpgrades.includes(e)||n.unlocks.permanentUpgrades.push(e),Qt(n),{success:!0,newLevel:n.permanentUpgradeLevels[e]})}function Ig(e,t){const o=mt();return o.currency<t?{success:!1,reason:"insufficientCurrency"}:(o.activeBoosters||(o.activeBoosters=[]),o.currency-=t,o.stats&&(o.stats.totalCurrencySpent=(o.stats.totalCurrencySpent||0)+t),o.activeBoosters.push({key:e,purchasedAt:Date.now()}),Qt(o),{success:!0,boosterKey:e})}function Pg(){return(mt().activeBoosters||[]).length}function Bg(){const e=mt(),t=e.activeBoosters||[];return e.activeBoosters=[],Qt(e),t}function oh(){const e=mt();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(o=>{const n=e.permanentUpgradePurchaseHistory[o];n&&Array.isArray(n)&&n.forEach(s=>{t+=s})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(o=>{const n=e.permanentUpgradeLevels[o]||0;for(let s=0;s<n;s++)t+=th(s)}),t}return 0}function Lg(e){const t=mt(),o=Pt(e);if(o===0)return{success:!1,reason:"noLevels"};let n=0;if(t.permanentUpgradePurchaseHistory&&t.permanentUpgradePurchaseHistory[e]&&t.permanentUpgradePurchaseHistory[e].length>0){const s=t.permanentUpgradePurchaseHistory[e];n=s[s.length-1],s.pop(),s.length===0&&delete t.permanentUpgradePurchaseHistory[e]}else n=th(o-1);if(t.currency+=n,t.permanentUpgradeLevels[e]=o-1,t.permanentUpgradeLevels[e]===0&&(delete t.permanentUpgradeLevels[e],t.unlocks.permanentUpgrades)){const s=t.unlocks.permanentUpgrades.indexOf(e);s>-1&&t.unlocks.permanentUpgrades.splice(s,1)}return Qt(t),{success:!0,refundAmount:n,newLevel:t.permanentUpgradeLevels[e]||0}}function zg(){const e=mt(),t=oh();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),Qt(e),{success:!0,refundAmount:t})}function va(e){const t=mt();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),Qt(t)}function Ur(e){const t=mt();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function Og(e){const t=mt();if(t.achievements||(t.achievements=[]),!t.achievements.includes(e)){t.achievements.push(e);const o=jd(e),n=Jd(o);return n>0&&(t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+n),console.log(`[MetaProgression] Achievement "${e}" awarded ${n} credits`)),Qt(t),Dg(e).then(s=>{s.length>0&&console.log("[MetaProgression] Achievement unlocked characters:",s)}),!0}return!1}function nh(){return mt().achievements||[]}function vs(){return mt().stats||ir.stats}function Ea(e){let t=0;t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30);const o=Pt("bossBounty");o>0&&e.bossesKilled>0&&(t+=e.bossesKilled*o*15);const n=Pt("creditBonus");return n>0&&(t=Math.floor(t*(1+n*.08))),Math.floor(t)}function la(){return Mg}function Mo(){return mt().playerName||"Player"}function Nc(e){const t=mt();return t.playerName=e,Qt(t),t.playerName}function Jn(){return mt().inviteCode||"000000"}function Hg(e){const t=mt();return t.inviteCode=e,Qt(t),t.inviteCode}function Ug(e){const t=mt();t.runHistory||(t.runHistory=[]);const o={timestamp:Date.now(),character:e.character||"survivor",weapon:e.weapon||"pistol",floorsReached:e.floorsReached||1,roomsCleared:e.roomsCleared||0,enemiesKilled:e.enemiesKilled||0,bossesKilled:e.bossesKilled||0,level:e.level||1,currencyEarned:e.currencyEarned||0,duration:e.duration||0,deathCause:e.deathCause||"Unknown",upgrades:e.upgrades||[],synergies:e.synergies||[]};return t.runHistory.unshift(o),t.runHistory.length>Oc&&(t.runHistory=t.runHistory.slice(0,Oc)),Qt(t),o}function Ng(){return mt().runHistory||[]}function _g(e){const t=mt();return t.equippedCosmetics&&t.equippedCosmetics[e]||(e==="trail"?"trailNone":e==="death"?"deathNone":"glowNone")}function _c(e,t){const o=mt();return o.equippedCosmetics||(o.equippedCosmetics={trail:"trailNone",death:"deathNone",glow:"glowNone"}),!t.includes("None")&&!Yo("cosmetics",t)?!1:(o.equippedCosmetics[e]=t,Qt(o),!0)}function Xg(){return mt().equippedCosmetics||{trail:"trailNone",death:"deathNone",glow:"glowNone"}}function Ki(e){return Math.floor(Math.sqrt(e/100))+1}function ar(e){return e<=1?0:Math.pow(e-1,2)*100}function ri(){const e=mt();return Ki(e.totalXP||0)}function da(){return mt().totalXP||0}function sh(){const e=ri();return ar(e+1)}function Nr(){const e=da(),t=Ki(e),o=ar(t),n=ar(t+1);return n===o?1:(e-o)/(n-o)}function Fg(e){const t=mt(),o=Ki(t.totalXP||0);t.totalXP=(t.totalXP||0)+e;const n=Ki(t.totalXP);return t.playerLevel=n,Qt(t),{newXP:t.totalXP,newLevel:n,levelsGained:n-o,oldLevel:o}}function Yg(e){let t=0;return t+=e.floorsReached*50,t+=(e.enemiesKilled||0)*2,t+=(e.bossesKilled||0)*100,e.floorsReached>=5&&(t+=200),e.isDailyRun&&(t+=500),t}function ci(){return mt().selectedPortrait||"default"}function qg(e){const t=mt();return t.selectedPortrait=e,Qt(t),!0}function ih(){return mt().unlocks?.portraits||["default"]}const Gg=.15,Vi=120,Xc=50,Mn=.5,xi=.7,te={systemInitialized:!1,touchInitialized:!1,gamepadConnected:!1,gamepadIndex:null,moveX:0,moveY:0,aimX:0,aimY:0,aimActive:!1,touchEnabled:!1,leftTouch:null,rightTouch:null,leftJoystickCenter:null,rightJoystickCenter:null,leftJoystickBase:null,leftJoystickKnob:null,rightJoystickBase:null,rightJoystickKnob:null,k:null};function wi(e,t=Gg){return Math.abs(e)<t?0:(e>0?1:-1)*(Math.abs(e)-t)/(1-t)}function Kg(e){if(te.k=e,te.systemInitialized)return;te.systemInitialized=!0,window.addEventListener("gamepadconnected",o=>{console.log("[InputSystem] Gamepad connected:",o.gamepad.id),te.gamepadConnected=!0,te.gamepadIndex=o.gamepad.index}),window.addEventListener("gamepaddisconnected",o=>{console.log("[InputSystem] Gamepad disconnected:",o.gamepad.id),o.gamepad.index===te.gamepadIndex&&(te.gamepadConnected=!1,te.gamepadIndex=null)});const t=navigator.getGamepads();for(let o=0;o<t.length;o++)if(t[o]){console.log("[InputSystem] Found existing gamepad:",t[o].id),te.gamepadConnected=!0,te.gamepadIndex=t[o].index;break}te.touchEnabled="ontouchstart"in window||navigator.maxTouchPoints>0,console.log("[InputSystem] Initialized. Gamepad:",te.gamepadConnected,"Touch:",te.touchEnabled)}function Vg(){if(!te.gamepadConnected||te.gamepadIndex===null)return;const t=navigator.getGamepads()[te.gamepadIndex];if(!t){te.gamepadConnected=!1,te.gamepadIndex=null;return}te.moveX=wi(t.axes[0]||0),te.moveY=wi(t.axes[1]||0);const o=wi(t.axes[2]||0),n=wi(t.axes[3]||0);te.aimX=o,te.aimY=n,te.aimActive=Math.abs(o)>0||Math.abs(n)>0}function Wg(e){if(!te.touchEnabled)return;if(Zg(),te.touchInitialized){Fc(e);return}te.touchInitialized=!0,Fc(e);const t=e.canvas;t.addEventListener("touchstart",$g,{passive:!1}),t.addEventListener("touchmove",Jg,{passive:!1}),t.addEventListener("touchend",Yc,{passive:!1}),t.addEventListener("touchcancel",Yc,{passive:!1}),console.log("[InputSystem] Touch controls initialized")}function Fc(e){const t=e.width(),o=e.height(),n=t*.15,s=o*.75,a=t*.85,r=o*.75;te.leftJoystickBase=e.add([e.circle(Vi/2),e.pos(n,s),e.anchor("center"),e.color(100,100,100),e.opacity(Mn),e.fixed(),e.z(1e3),"touchJoystick"]),te.leftJoystickKnob=e.add([e.circle(Xc/2),e.pos(n,s),e.anchor("center"),e.color(200,200,200),e.opacity(Mn),e.fixed(),e.z(1001),"touchJoystick"]),te.rightJoystickBase=e.add([e.circle(Vi/2),e.pos(a,r),e.anchor("center"),e.color(100,100,100),e.opacity(Mn),e.fixed(),e.z(1e3),"touchJoystick"]),te.rightJoystickKnob=e.add([e.circle(Xc/2),e.pos(a,r),e.anchor("center"),e.color(255,100,100),e.opacity(Mn),e.fixed(),e.z(1001),"touchJoystick"]),te.leftJoystickCenter={x:n,y:s},te.rightJoystickCenter={x:a,y:r}}function $g(e){e.preventDefault();const t=te.k,o=t.canvas.getBoundingClientRect(),n=t.width()/o.width,s=t.height()/o.height;for(const a of e.changedTouches){const r=(a.clientX-o.left)*n,l=(a.clientY-o.top)*s;r<t.width()/2&&te.leftTouch===null?(te.leftTouch=a.identifier,te.leftJoystickCenter={x:r,y:l},te.leftJoystickBase&&(te.leftJoystickBase.pos.x=r,te.leftJoystickBase.pos.y=l,te.leftJoystickBase.opacity=xi),te.leftJoystickKnob&&(te.leftJoystickKnob.pos.x=r,te.leftJoystickKnob.pos.y=l,te.leftJoystickKnob.opacity=xi)):r>=t.width()/2&&te.rightTouch===null&&(te.rightTouch=a.identifier,te.rightJoystickCenter={x:r,y:l},te.rightJoystickBase&&(te.rightJoystickBase.pos.x=r,te.rightJoystickBase.pos.y=l,te.rightJoystickBase.opacity=xi),te.rightJoystickKnob&&(te.rightJoystickKnob.pos.x=r,te.rightJoystickKnob.pos.y=l,te.rightJoystickKnob.opacity=xi),te.aimActive=!0)}}function Jg(e){e.preventDefault();const t=te.k,o=t.canvas.getBoundingClientRect(),n=t.width()/o.width,s=t.height()/o.height;for(const a of e.changedTouches){const r=(a.clientX-o.left)*n,l=(a.clientY-o.top)*s;if(a.identifier===te.leftTouch&&te.leftJoystickCenter){const c=r-te.leftJoystickCenter.x,d=l-te.leftJoystickCenter.y,i=Math.sqrt(c*c+d*d),h=Vi/2,u=Math.min(i,h),g=Math.atan2(d,c);te.leftJoystickKnob&&(te.leftJoystickKnob.pos.x=te.leftJoystickCenter.x+Math.cos(g)*u,te.leftJoystickKnob.pos.y=te.leftJoystickCenter.y+Math.sin(g)*u);const p=u/h;te.moveX=Math.cos(g)*p,te.moveY=Math.sin(g)*p}if(a.identifier===te.rightTouch&&te.rightJoystickCenter){const c=r-te.rightJoystickCenter.x,d=l-te.rightJoystickCenter.y,i=Math.sqrt(c*c+d*d),h=Vi/2,u=Math.min(i,h),g=Math.atan2(d,c);te.rightJoystickKnob&&(te.rightJoystickKnob.pos.x=te.rightJoystickCenter.x+Math.cos(g)*u,te.rightJoystickKnob.pos.y=te.rightJoystickCenter.y+Math.sin(g)*u);const p=u/h;te.aimX=Math.cos(g)*p,te.aimY=Math.sin(g)*p,te.aimActive=p>.1}}}function Yc(e){e.preventDefault();for(const t of e.changedTouches)t.identifier===te.leftTouch&&(te.leftTouch=null,te.moveX=0,te.moveY=0,te.leftJoystickKnob&&te.leftJoystickCenter&&(te.leftJoystickKnob.pos.x=te.leftJoystickCenter.x,te.leftJoystickKnob.pos.y=te.leftJoystickCenter.y),te.leftJoystickBase&&(te.leftJoystickBase.opacity=Mn),te.leftJoystickKnob&&(te.leftJoystickKnob.opacity=Mn)),t.identifier===te.rightTouch&&(te.rightTouch=null,te.aimX=0,te.aimY=0,te.aimActive=!1,te.rightJoystickKnob&&te.rightJoystickCenter&&(te.rightJoystickKnob.pos.x=te.rightJoystickCenter.x,te.rightJoystickKnob.pos.y=te.rightJoystickCenter.y),te.rightJoystickBase&&(te.rightJoystickBase.opacity=Mn),te.rightJoystickKnob&&(te.rightJoystickKnob.opacity=Mn))}function jg(){return{x:te.moveX,y:te.moveY}}function qc(){return{x:te.aimX,y:te.aimY,active:te.aimActive}}function Zg(){const e=te.k;if(e){try{e.get("touchJoystick").forEach(t=>{t&&t.exists()&&e.destroy(t)})}catch{}te.leftJoystickBase=null,te.leftJoystickKnob=null,te.rightJoystickBase=null,te.rightJoystickKnob=null,te.leftTouch=null,te.rightTouch=null,te.moveX=0,te.moveY=0,te.aimX=0,te.aimY=0,te.aimActive=!1}}const rr={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]},boomerang:{name:"Boomerang Blaster",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:250,baseDamage:14,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,returnsToPlayer:!0,returnSpeedMultiplier:1.2,category:"multiTarget",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},railgun:{name:"Railgun",icon:"",char:"",color:[150,200,255],fireRate:.33,projectileSpeed:800,baseDamage:50,projectileCount:1,spreadAngle:0,piercing:999,obstaclePiercing:1,critChance:.1,critDamage:3,range:1e3,infinitePierce:!0,category:"precision",upgradeCategories:["damage","crit","critDamage","fireRate","obstaclePiercing"]},spreadShot:{name:"Spread Shot",icon:"",char:"",color:[255,180,100],fireRate:2.5,projectileSpeed:280,baseDamage:6,projectileCount:3,spreadAngle:25,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:450,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},homingMissiles:{name:"Homing Missiles",icon:"",char:"",color:[255,100,150],fireRate:1.5,projectileSpeed:180,baseDamage:18,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,homing:!0,homingStrength:3,category:"precision",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},plasmaRifle:{name:"Plasma Rifle",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:350,baseDamage:16,projectileCount:1,spreadAngle:0,piercing:2,obstaclePiercing:0,critChance:.08,critDamage:2.2,range:650,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]}};function ah(e){return rr[e]||rr.pistol}function Qg(e,t){return ah(e).upgradeCategories.includes(t)}const Rs={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},jo={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},fn={BASE_XP_TO_NEXT_LEVEL:15,XP_SCALING_FACTOR:1.25,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},bn={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},ro={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},us={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},Vt={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:800,MAGNETIZE_ACCELERATION:600,COLLECTION_RADIUS:20};function Aa(e,t=0,o=0){const n=e*(1-o);return Math.max(ro.MIN_DAMAGE,n-t)}function kg(e,t=null){return(t?t.next():Math.random())<e}function em(e,t=2){return Math.floor(e*t)}function Sa(e,t,o,n=null){const s=n||mn(),a=$t[s]||$t.survivor,r=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.rotate(0),e.z(-1),"playerOutline"]),l=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...a.color),e.rotate(0),e.area(),e.health(a.stats.health),"player"]);l.outline=r,l.characterKey=s,l.characterData=a,l.speed=a.stats.speed,l.originalSpeed=a.stats.speed,l.slowed=!1,l.maxHealth=a.stats.health;const c=Pt("headStart");l.level=c>0?2:fn.STARTING_LEVEL,l.xp=fn.STARTING_XP,l.xpToNext=fn.BASE_XP_TO_NEXT_LEVEL,l.pickupRadius=jo.BASE_PICKUP_RADIUS,l.invulnerable=!1,l.invulnerableTime=0,l.invulnerableDuration=jo.INVULNERABILITY_DURATION,l.setHP(l.maxHealth);const d=a.weapon||"pistol",i=ah(d);l.weaponKey=d,l.weaponDef=i,l.baseFireRate=i.fireRate,l.baseProjectileSpeed=i.projectileSpeed,l.baseProjectileDamage=i.baseDamage;const h=a.stats.damage||10,u=i.baseDamage,g=h/10;if(l.fireRate=i.fireRate,l.projectileSpeed=i.projectileSpeed,l.projectileDamage=Math.floor(u*g),l.lastFireTime=0,l.projectileCount=i.projectileCount,l.piercing=i.piercing,l.obstaclePiercing=i.obstaclePiercing,l.critChance=i.critChance,l.critDamage=i.critDamage,l.spreadAngle=i.spreadAngle,l.defense=0,l.weaponRange=i.range,l.weaponCategory=i.category,i.orbitRadius&&(l.orbitRadius=i.orbitRadius,l.rotationSpeed=i.rotationSpeed,l.orbitalOrbs=[],l.orbitalAngles=[]),i.explosionRadius&&(l.explosionRadius=i.explosionRadius,l.explosionDamage=i.explosionDamage),i.chainRange&&(l.chainRange=i.chainRange,l.maxJumps=i.maxJumps,l.chainDamageReduction=i.chainDamageReduction),l.xpMultiplier=1,l.dodgeChance=0,l.damageReduction=0,l.weapons=[d],l.passiveUpgrades=[],l.upgradeStacks={},a.ability==="xpBoost"?l.xpMultiplier=bn.SURVIVOR_XP_BOOST:a.ability==="speedBoost"?(l.speed=l.speed*bn.SCOUT_SPEED_BOOST,l.originalSpeed=l.speed,l.dodgeChance=bn.SCOUT_DODGE_CHANCE):a.ability==="tankStats"?(l.maxHealth=Math.floor(l.maxHealth*bn.TANK_HEALTH_BOOST),l.setHP(l.maxHealth),l.damageReduction=bn.TANK_DAMAGE_REDUCTION):a.ability==="critBoost"?(l.critChance=(l.critChance||0)*bn.SNIPER_CRIT_CHANCE_MULTIPLIER,l.critDamage=(l.critDamage||2)*bn.SNIPER_CRIT_DAMAGE_MULTIPLIER):a.ability==="fireDot"&&(l.fireDotMultiplier=bn.PYRO_FIRE_DOT_MULTIPLIER),!a.skipPermanentUpgrades){const f=Pt("luckyStart");f>0&&(l.critChance=(l.critChance||0)+f*.05);const _=Pt("thickSkin");_>0&&(l.damageReduction=(l.damageReduction||0)+_*.03);const B=Pt("xpMagnet");B>0&&(l.pickupRadius=Math.floor(l.pickupRadius*(1+B*.15)));const b=Pt("comfortZone");b>0&&(l.invulnerableDuration=l.invulnerableDuration+b*.1)}l.canMove=!0,l.canShoot=!0,l.isDead=!1;let p=e.vec2(0,0),T=document.hasFocus(),m={w:!1,s:!1,a:!1,d:!1,up:!1,down:!1,left:!1,right:!1};l.moveDir=p,e.onKeyDown(["w","up"],()=>{l.isRemote||!T||m.w||m.up||(p.y=-1,l.moveDir=p)}),e.onKeyDown(["s","down"],()=>{l.isRemote||!T||m.s||m.down||(p.y=1,l.moveDir=p)}),e.onKeyDown(["a","left"],()=>{l.isRemote||!T||m.a||m.left||(p.x=-1,l.moveDir=p)}),e.onKeyDown(["d","right"],()=>{l.isRemote||!T||m.d||m.right||(p.x=1,l.moveDir=p)}),e.onKeyRelease(["w","up"],()=>{l.isRemote||(m.w=!1,m.up=!1,!e.isKeyDown("s")&&!e.isKeyDown("down")&&(p.y=0,l.moveDir=p))}),e.onKeyRelease(["s","down"],()=>{l.isRemote||(m.s=!1,m.down=!1,!e.isKeyDown("w")&&!e.isKeyDown("up")&&(p.y=0,l.moveDir=p))}),e.onKeyRelease(["a","left"],()=>{l.isRemote||(m.a=!1,m.left=!1,!e.isKeyDown("d")&&!e.isKeyDown("right")&&(p.x=0,l.moveDir=p))}),e.onKeyRelease(["d","right"],()=>{l.isRemote||(m.d=!1,m.right=!1,!e.isKeyDown("a")&&!e.isKeyDown("left")&&(p.x=0,l.moveDir=p))});const M=()=>{l.isRemote||(T=!1,p.x=0,p.y=0,l.moveDir=p,l.isShooting=!1,m={w:e.isKeyDown("w"),s:e.isKeyDown("s"),a:e.isKeyDown("a"),d:e.isKeyDown("d"),up:e.isKeyDown("up"),down:e.isKeyDown("down"),left:e.isKeyDown("left"),right:e.isKeyDown("right")})},P=()=>{T=!0};return window.addEventListener("blur",M),window.addEventListener("focus",P),l.onDestroy(()=>{window.removeEventListener("blur",M),window.removeEventListener("focus",P)}),l.onUpdate(()=>{if(l.outline&&l.outline.exists()&&(l.outline.pos=l.pos.clone()),e.paused)return;if(l.invulnerable)if(l.invulnerableTime-=e.dt(),l.invulnerableTime<=0)l.invulnerable=!1,l.color=e.rgb(...jo.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1);else{const S=jo.IMMUNITY_FLASH_RATE;Math.floor(l.invulnerableTime*S)%2===0?(l.color=e.rgb(...jo.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1)):(l.color=e.rgb(...jo.NORMAL_COLOR,jo.IMMUNITY_ALPHA),l.outline&&l.outline.exists()&&(l.outline.opacity=jo.IMMUNITY_ALPHA))}if(l.canMove===!1)return;Vg();let f=p;if(l.isRemote&&l.move)f=e.vec2(l.move.x,l.move.y);else if(!l.isRemote){const S=jg();(S.x!==0||S.y!==0)&&(f=e.vec2(S.x,S.y))}if(f.len()>0){const S=f.len(),C=f.scale(1/S).scale(l.speed*e.dt()),A=l.pos.x+C.x,z=l.pos.y+C.y;let R=!0,Y=!0;const U=e.get("obstacle"),N=jo.COLLISION_SIZE;for(const H of U){if(!H.exists())continue;const I=H.pos.x-H.width/2,F=H.pos.x+H.width/2,V=H.pos.y-H.height/2,j=H.pos.y+H.height/2,ce=A-N,ie=A+N,ne=l.pos.y-N,se=l.pos.y+N;ie>I&&ce<F&&se>V&&ne<j&&(R=!1);const ge=l.pos.x-N,ve=l.pos.x+N,Oe=z-N,Ee=z+N;ve>I&&ge<F&&Ee>V&&Oe<j&&(Y=!1)}R&&(l.pos.x=A),Y&&(l.pos.y=z)}const _=e.width(),B=e.height(),b=jo.ROOM_MARGIN;l.pos.x=e.clamp(l.pos.x,b,_-b),l.pos.y=e.clamp(l.pos.y,b,B-b)}),l}const ze={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function _r(e,t=!0){return new Promise((o,n)=>{if(ze.isInitialized){console.warn("Network already initialized"),o(e);return}if(window.addEventListener("beforeunload",()=>{Xr()}),typeof Peer>"u"){console.error("PeerJS library not loaded"),n(new Error("PeerJS library not available"));return}ze.isHost=t;const s=t?`smash-${e}`:void 0,a=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";let r;a?r={debug:3,host:"localhost",port:9e3,path:"/",secure:!1,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}}:r={debug:2,secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}};try{ze.peer=new Peer(s,r),ze.peer.on("open",l=>{ze.peerId=l,ze.isInitialized=!0;const c=t&&l.startsWith("smash-")?l.substring(6):l;o(c)}),ze.peer.on("error",l=>{if(console.error("Peer error:",l),l.type==="unavailable-id"&&t){if(console.warn("Peer ID already taken - generating new code and retrying..."),ze.peer){try{ze.peer.destroy()}catch(c){console.warn("Error destroying peer:",c)}ze.peer=null,ze.peerId=null,ze.isInitialized=!1}setTimeout(()=>{const c=sr();_r(c,t).then(o).catch(n)},2e3);return}l.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):l.type==="peer-unavailable"?console.warn("Host not found - check invite code"):l.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),ze.isInitialized||n(new Error(`Multiplayer unavailable: ${l.type||"connection failed"}`))}),t&&ze.peer.on("connection",l=>{tm(l)})}catch(l){console.error("Failed to create peer:",l),n(l)}})}function tm(e){ze.isHost&&(e.on("open",()=>{ze.connections.set(e.peer,e),ze.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{rh(t,e.peer)}),e.on("close",()=>{ze.connections.delete(e.peer),ze.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function om(e){return new Promise((t,o)=>{if(ze.isHost){o(new Error("Host cannot connect to another host"));return}if(!ze.isInitialized){o(new Error("Network not initialized"));return}const n=`smash-${e}`;let s,a=!1;const r=ze.peer.connect(n,{reliable:!0});s=setTimeout(()=>{a||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),r.close(),o(new Error("Connection timeout - could not reach host")))},3e4),r.on("open",()=>{a=!0,clearTimeout(s),s=null,ze.hostConnection=r,ze.hostId=n,t()}),r.on("data",l=>{rh(l,n)}),r.on("close",()=>{s&&(clearTimeout(s),s=null),ze.hostConnection=null,ze.hostId=null,ze.connectionCallbacks.forEach(l=>l("host_disconnect"))}),r.on("error",l=>{a=!0,clearTimeout(s),s=null,console.error("[NetworkSystem] Connection error:",l),console.error("[NetworkSystem] Error type:",l.type||"unknown"),o(l)})})}function rh(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const o=ze.messageHandlers.get(e.type);o?o(e.payload,t):console.warn("No handler for message type:",e.type)}function He(e,t){ze.messageHandlers.set(e,t)}function Ot(e){ze.messageHandlers.delete(e)}function ch(e){ze.connectionCallbacks.includes(e)||ze.connectionCallbacks.push(e)}function lo(e,t){if(ze.isHost){console.warn("Host cannot send to itself");return}if(!ze.hostConnection){console.warn("Not connected to host");return}ze.hostConnection.send({type:e,payload:t})}function qo(e,t,o){if(!ze.isHost){console.warn("Only host can send to specific peers");return}const n=ze.connections.get(e);n?n.send({type:t,payload:o}):console.warn("No connection to peer:",e)}function Ke(e,t,o=[]){if(!ze.isHost){console.warn("Only host can broadcast");return}ze.connections.forEach((n,s)=>{o.includes(s)||n.send({type:e,payload:t})})}function Xr(){ze.isHost?(ze.connections.forEach(e=>e.close()),ze.connections.clear()):ze.hostConnection&&(ze.hostConnection.close(),ze.hostConnection=null,ze.hostId=null),ze.peer&&(ze.peer.destroy(),ze.peer=null),ze.messageHandlers.clear(),ze.connectionCallbacks=[],ze.isInitialized=!1,ze.peerId=null}function nm(){const e=ze.peerId&&ze.peerId.startsWith("smash-")?ze.peerId.substring(6):ze.peerId;return{isInitialized:ze.isInitialized,isHost:ze.isHost,peerId:e,hostId:ze.hostId,connectedPeers:Array.from(ze.connections.keys()),peerCount:ze.connections.size}}const k={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!0,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null,hostInviteCode:null,disconnectedPlayers:new Map,reconnectWindow:15e3,countdownActive:!1,countdownStartTime:0,countdownDuration:3e3,activeEmotes:new Map,emoteCallbacks:[]};let ti=!1,oi=!1;async function lh(e=null){if(e&&(k.kaplayInstance=e),k.isHost){const t=Mo(),o=Jn(),n=mn(),s=ci();k.slots[0].playerId="local",k.slots[0].playerName=t,k.slots[0].inviteCode=o,k.slots[0].selectedCharacter=n,k.slots[0].selectedPortrait=s,k.slots[0].isLocal=!0,k.slots[0].permanentUpgradeLevels={startingHealth:Pt("startingHealth"),startingDamage:Pt("startingDamage"),startingSpeed:Pt("startingSpeed"),propDurability:Pt("propDurability"),propDropChance:Pt("propDropChance")},console.log("[PartySystem] Host player initialized in slot 0:",{name:k.slots[0].playerName,code:k.slots[0].inviteCode,character:k.slots[0].selectedCharacter})}else console.log("[PartySystem] Client mode - preserving existing slot assignments");if(!k.networkInitialized)try{console.log("[PartySystem] Initializing network as host...");const t=Jn(),o=await _r(t,!0);o!==t&&(console.log(`[PartySystem] Invite code changed: ${t} -> ${o}`),Hg(o),k.slots[0].inviteCode=o),k.networkInitialized=!0,k.isHost=!0,sm(),console.log("[PartySystem] Network initialized as host - ready to accept connections")}catch(t){console.error("[PartySystem] Failed to initialize network as host:",t),console.log("[PartySystem] Multiplayer disabled - running in single-player mode")}}function sm(){ti||(ti=!0,He("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const o=im(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",e.selectedPortrait||"default",t,e.permanentUpgradeLevels||null);if(o!==null){const n={slots:k.slots.map(s=>({playerId:s.playerId,playerName:s.playerName,inviteCode:s.inviteCode,selectedCharacter:s.selectedCharacter,selectedPortrait:s.selectedPortrait,permanentUpgradeLevels:s.permanentUpgradeLevels,isLocal:!1})),yourSlotIndex:o};console.log("[PartySystem] Sending party_sync to new player:",{hostName:n.slots[0].playerName,hostCharacter:n.slots[0].selectedCharacter,newPlayerSlot:o}),qo(t,"party_sync",n),setTimeout(()=>{Wm(t)},250),_n()}else qo(t,"join_rejected",{reason:"Party full"})}),He("player_info",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.playerName&&(k.slots[o].playerName=e.playerName),_n())}),He("character_change",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} changed character to:`,e.selectedCharacter),k.slots[o].selectedCharacter=e.selectedCharacter,_n())}),He("ready_change",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} ready state:`,e.isReady),k.slots[o].isReady=e.isReady,_n(),dh())}),He("party_emote",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.slotIndex=o,Fr(e),Ke("party_emote",e))}),He("profile_request",(e,t)=>{const o=e.targetSlot;if(o===0)uh(e,t);else{const n=k.slots[o]?.peerId;n&&qo(n,"profile_request",{requestingSlot:k.peerIdToSlot.get(t),forwardTo:t})}}),He("profile_response",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.slotIndex=o,e.forwardTo?qo(e.forwardTo,"profile_response",e):fh(e))}),ch((e,t)=>{e==="leave"&&cm(t)}))}function fs(){return k}function Hn(){return k.slots.filter(e=>e.playerId!==null).length}function Gc(){return!k.isHost&&k.hostInviteCode?k.hostInviteCode:Jn()}function im(e,t,o,n,s,a=null){for(let r=1;r<k.slots.length;r++)if(k.slots[r].playerId===null)return k.slots[r].playerId=`player_${Date.now()}_${r}`,k.slots[r].playerName=e,k.slots[r].inviteCode=t,k.slots[r].selectedCharacter=o,k.slots[r].selectedPortrait=n,k.slots[r].peerId=s,k.slots[r].permanentUpgradeLevels=a,k.peerIdToSlot.set(s,r),r;return null}async function am(e){const t={playerName:Mo(),inviteCode:Jn(),selectedCharacter:mn()};try{console.log("[PartySystem] Joining as client - clearing all party slots");for(let o=0;o<k.slots.length;o++)k.slots[o]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null};return k.networkInitialized&&k.isHost&&(console.log("[PartySystem] Switching from host to client - disconnecting current peer..."),Xr(),k.networkInitialized=!1,k.isHost=!1,ti=!1,oi=!1),k.networkInitialized||(await _r("client",!1),k.networkInitialized=!0,k.isHost=!1),k.hostInviteCode=e,rm(),await om(e),lo("join_request",{playerName:t.playerName,inviteCode:t.inviteCode,selectedCharacter:t.selectedCharacter,selectedPortrait:ci()||"default",permanentUpgradeLevels:{startingHealth:Pt("startingHealth"),startingDamage:Pt("startingDamage"),startingSpeed:Pt("startingSpeed"),propDurability:Pt("propDurability"),propDropChance:Pt("propDropChance")}}),!0}catch(o){return console.error("Failed to join party:",o),console.log("[PartySystem] Restoring local player after join failure"),Wi(t),!1}}function Wi(e){k.networkInitialized&&!k.isHost&&Xr(),k.isHost=!0,k.hostInviteCode=null,k.networkInitialized=!1,ti=!1,oi=!1;for(let t=0;t<k.slots.length;t++)k.slots[t]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null};k.slots[0]={playerId:"local",playerName:e.playerName||Mo(),inviteCode:e.inviteCode||Jn(),selectedCharacter:e.selectedCharacter||mn(),isLocal:!0,peerId:null},lh(k.kaplayInstance).catch(t=>{console.warn("[PartySystem] Failed to re-initialize as host:",t)})}function rm(){oi||(oi=!0,He("party_sync",e=>{console.log("[PartySystem] Received party sync:",{hostName:e.slots[0].playerName,hostCharacter:e.slots[0].selectedCharacter,yourSlot:e.yourSlotIndex,totalSlots:e.slots.filter(o=>o.playerId!==null).length}),k.slots=e.slots,e.yourSlotIndex!==void 0&&(k.slots[e.yourSlotIndex].isLocal=!0,console.log(`[PartySystem] Marked slot ${e.yourSlotIndex} as local`)),k.slots[0].isLocal=!1;const t=k.slots.filter(o=>o.playerId!==null).length;console.log("[PartySystem] Party synced successfully:",{partySize:t,hostInSlot0:k.slots[0].playerName,localSlot:e.yourSlotIndex})}),He("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),He("game_start",e=>{console.log("Host started game - joining..."),k.kaplayInstance?k.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),He("countdown_start",e=>{console.log("[PartySystem] Countdown started by host:",e.duration),k.countdownActive=!0,k.countdownStartTime=Date.now(),k.countdownDuration=e.duration||3e3}),He("countdown_cancel",()=>{console.log("[PartySystem] Countdown cancelled by host"),k.countdownActive=!1,k.countdownStartTime=0}),He("party_update",e=>{const t=k.slots.findIndex(o=>o.isLocal);k.slots=e.slots,t!==-1&&(k.slots[t].isLocal=!0)}),He("party_emote",e=>{Fr(e)}),He("profile_request",e=>{uh()}),He("profile_response",e=>{fh(e)}),ch(e=>{if(e==="host_disconnect"){console.log("[PartySystem] Host disconnected - returning to solo party"),alert("Host disconnected - returning to main menu");const t={playerName:Mo(),inviteCode:Jn(),selectedCharacter:mn()};Wi(t),k.kaplayInstance&&k.kaplayInstance.go("menu")}}))}function _n(){k.isHost&&Ke("party_update",{slots:k.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,selectedPortrait:e.selectedPortrait,permanentUpgradeLevels:e.permanentUpgradeLevels,isLocal:!1,isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))})}function Kc(){k.isHost&&(console.log("Broadcasting game start to all clients"),Ke("game_start",{}))}function cm(e){const t=k.peerIdToSlot.get(e);if(t!==void 0){console.log("[PartySystem] Player disconnected from slot",t,"- starting reconnection window");const o={...k.slots[t]};k.disconnectedPlayers.set(t,{disconnectTime:Date.now(),playerData:o,peerId:e}),k.slots[t].isDisconnected=!0,Ke("player_disconnected",{slotIndex:t,reconnectWindow:k.reconnectWindow}),k.peerIdToSlot.delete(e),setTimeout(()=>{lm(t)},k.reconnectWindow)}}function lm(e){k.disconnectedPlayers.get(e)&&(console.log("[PartySystem] Reconnection window expired for slot",e,"- removing player"),qm(e),dm(e),k.disconnectedPlayers.delete(e),Ke("player_removed",{slotIndex:e}),_n())}function dm(e){if(e>0&&e<k.slots.length){const t=k.slots[e].peerId;return t&&k.peerIdToSlot.delete(t),k.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null,isReady:!1},!0}return!1}function hm(){return k.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter||"survivor",selectedPortrait:e.selectedPortrait||"default",isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))}function Vc(e){k.slots[0].selectedCharacter=e,k.networkInitialized&&(k.isHost?_n():lo("character_change",{selectedCharacter:e}))}function um(){const e=ps();return e===null?!1:(k.slots[e].isReady=!k.slots[e].isReady,k.networkInitialized&&(k.isHost?(_n(),dh()):lo("ready_change",{isReady:k.slots[e].isReady})),k.slots[e].isReady)}function ps(){const e=k.slots.findIndex(t=>t.isLocal);return e>=0?e:null}function fm(){const e=ps();return e!==null&&k.slots[e].isReady}function Wc(){const e=k.slots.filter(t=>t.playerId!==null);return e.length<2?!1:e.every(t=>t.isReady)}function dh(){k.isHost&&(Wc()&&!k.countdownActive?pm():!Wc()&&k.countdownActive&&gm())}function pm(){k.isHost&&(k.countdownActive=!0,k.countdownStartTime=Date.now(),Ke("countdown_start",{duration:k.countdownDuration}),console.log("[PartySystem] Countdown started"))}function gm(){k.isHost&&(k.countdownActive=!1,k.countdownStartTime=0,Ke("countdown_cancel",{}),console.log("[PartySystem] Countdown cancelled"))}function $c(){if(!k.countdownActive)return{active:!1,timeRemaining:0};const e=Date.now()-k.countdownStartTime;return{active:!0,timeRemaining:Math.max(0,k.countdownDuration-e)}}function Fr(e){const{slotIndex:t,emoteType:o}=e;k.activeEmotes.set(t,{emoteType:o,startTime:Date.now()}),k.emoteCallbacks.forEach(n=>{try{n(t,o)}catch(s){console.error("[PartySystem] Emote callback error:",s)}})}function Jc(e){const t=ps();if(t===null)return;const o={slotIndex:t,emoteType:e};Fr(o),k.networkInitialized&&(k.isHost?Ke("party_emote",o):lo("party_emote",o))}function mm(e){k.emoteCallbacks.push(e)}function ym(e){const t=k.emoteCallbacks.indexOf(e);t!==-1&&k.emoteCallbacks.splice(t,1)}function xm(e,t=2e3){const o=k.activeEmotes.get(e);return o?Date.now()-o.startTime>t?(k.activeEmotes.delete(e),null):o.emoteType:null}function wm(){k.emoteCallbacks=[],k.activeEmotes.clear(),ti=!1,oi=!1}const Nn=new Map;function hh(){return{playerName:Mo(),selectedPortrait:ci(),playerLevel:ri(),totalXP:da(),stats:vs(),achievements:nh(),unlockedPortraits:ih()}}function bm(e,t){const o=k.slots[e];if(!o||o.playerId===null){console.warn("[PartySystem] Cannot request profile for empty slot:",e),t(null);return}if(o.isLocal){t(hh());return}if(Nn.set(e,t),k.isHost){const n=o.peerId;n?qo(n,"profile_request",{requestingSlot:ps()}):(console.warn("[PartySystem] No peerId for slot:",e),t(null),Nn.delete(e))}else lo("profile_request",{targetSlot:e});setTimeout(()=>{if(Nn.has(e)){console.warn("[PartySystem] Profile request timed out for slot:",e);const n=Nn.get(e);Nn.delete(e),n(null)}},5e3)}function uh(e,t=null){const o=hh();k.isHost&&t?qo(t,"profile_response",{slotIndex:ps(),profileData:o}):lo("profile_response",{slotIndex:ps(),profileData:o})}function fh(e){const{slotIndex:t,profileData:o}=e,n=Nn.get(t);n&&(Nn.delete(t),n(o))}const tn={gatekeeper:{name:"Studio Head",coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{name:"Showrunner",coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{name:"Co-Host (Melee)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{name:"Co-Host (Ranged)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function vm(e){return tn[e]||tn.gatekeeper}function $i(e,t,o,n="gatekeeper",s=1,a=null){const r=vm(n),l=1+(s-1)*.2,c={coreChar:r.coreChar,armorChar:r.armorChar||"()",shieldChar:r.shieldChar||"{}",color:r.color,armorColor:r.armorColor||[200,200,200],shieldColor:r.shieldColor||[100,200,255],health:Math.floor(r.baseHealth*l),armorHealth:Math.floor((r.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((r.baseArmorHealth||0)*l),shieldHealth:Math.floor((r.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((r.baseShieldHealth||0)*l),speed:Math.floor(r.baseSpeed*(1+(s-1)*.05)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),damageReduction:r.damageReduction||0,shieldRegenRate:(r.shieldRegenRate||0)*l};function d(){const h=c.armorHealth>c.maxArmorHealth*.5?"(":"",u=c.armorHealth>0?")":"";return`${h}${c.coreChar}${u}`}const i=e.add([e.text(d(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"boss"]);return i.maxHealth=c.health,i.speed=c.speed,i.xpValue=c.xpValue,i.type=n,i.floor=s,i.textSize=c.size,i.rng=a,r.meleeDamage&&(i.meleeDamage=r.meleeDamage),r.projectileDamage&&(i.projectileDamage=r.projectileDamage),r.projectileSpeed&&(i.projectileSpeed=r.projectileSpeed),r.fireRate&&(i.fireRate=r.fireRate),(n==="twinGuardianMelee"||n==="twinGuardianRanged")&&(i.enraged=!1,i.enrage=function(){this.enraged||(this.enraged=!0,this.speed=Math.floor(this.speed*1.5),this.type==="twinGuardianMelee"?(this.chargeCooldownTimer=0,this.meleeDamage=Math.floor(this.meleeDamage*1.25)):(this.fireRate=this.fireRate*1.5,this.projectileDamage=Math.floor(this.projectileDamage*1.25)),this.color=e.rgb(255,200,0))}),i.armorHealth=c.armorHealth,i.maxArmorHealth=c.maxArmorHealth,i.damageReduction=c.damageReduction,i.coreChar=c.coreChar,i.armorChar=c.armorChar,i.armorColor=c.armorColor,i.shieldHealth=c.shieldHealth,i.maxShieldHealth=c.maxShieldHealth,i.shieldRegenRate=c.shieldRegenRate,i.shieldChar=c.shieldChar,i.shieldColor=c.shieldColor,i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.updateVisual=function(){let h="",u="",g="",p="";if(i.shieldHealth>0){const m=i.shieldHealth/i.maxShieldHealth;m>.66?(h="",u=""):m>.33?(h="",u=""):(h="",u="")}if(i.armorHealth>0){const m=i.armorHealth/i.maxArmorHealth;m>.66?(g="",p=""):m>.33?(g="",p=""):(g="",p="")}const T=`${h}${g}${i.coreChar}${p}${u}`;i.text=T,i.shieldHealth>0?i.color=e.rgb(...c.shieldColor):i.color=e.rgb(...c.color)},i.takeDamage=function(h){let u=!1,g=!1;const p=i.shieldHealth,T=i.armorHealth;i.lastDamageTime=e.time();const m=3;if(i.shieldRegenCooldown=m,i.shieldHealth>0){const M=Math.min(h,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-M),u=i.shieldHealth!==p;const P=h-M;P>0&&i.takeDamageInternal(P)}else i.takeDamageInternal(h);g=i.armorHealth!==T,(u||g)&&i.updateVisual()},i.takeDamageInternal=function(h){if(i.armorHealth>0){const u=Math.floor(h*(1-i.damageReduction)),g=Math.min(u,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-g);const p=h-u;if(p>0){const T=i.armorHealth>0?1-i.damageReduction:1,m=Math.floor(p*T);i.hurt(m)}}else i.hurt(h)},i.attackTimer=0,i.minionSpawnTimer=0,i.chargeCooldownTimer=0,i.chargeDurationTimer=0,i.radialBurstTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeSpeed=0,i.spawnedMinions=[],i.enraged=!1,i.twinPartner=null,i.getPhase=function(){const h=i.hp()/i.maxHealth;return h>.75?1:h>.5?2:3},i.spawnMinions=function(){if(!i.exists())return;const h=i.getPhase(),u=h===1?2:3;for(let g=0;g<u;g++){const p=i.rng?i.rng.next()*.5:Math.random()*.5,T=Math.PI*2/u*g+p,M=40+(i.rng?i.rng.next()*20:Math.random()*20),P=i.pos.x+Math.cos(T)*M,f=i.pos.y+Math.sin(T)*M,B=(i.rng?i.rng.next():Math.random())<.5?"rusher":"basic",b=Rn(e,P,f,B,s);b.isBossMinion=!0,i.spawnedMinions.push(b),de()&&me()&&Xo(b,{type:B,floor:s,isBossMinion:!0})}},i.radialBurst=function(){if(!i.exists())return;const h=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];i.getPhase();const u=200,g=12;h.forEach(p=>{const T=To(e,i.pos.x,i.pos.y,p,u,g,0,0,!1);T.isBossProjectile=!0,T.color=e.rgb(255,100,100)})},i.startCharge=function(h){if(!i.exists())return;i.isCharging=!0;const u=e.vec2(h.x-i.pos.x,h.y-i.pos.y);if(u.len()>0&&(i.chargeDirection=u.unit(),!i.chargeSpeed||i.chargeSpeed===0)){const g=i.getPhase?i.getPhase():1;i.chargeSpeed=i.speed*(g===1?2.5:g===2?3:3.5)}},i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const M=1;if(i.shieldRegenTimer>=M){const P=i.shieldRegenRate*M;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+P),i.shieldRegenTimer=0,i.shieldHealth>0&&i.updateVisual()}}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!de()||me())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color,i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&i.updateVisual()}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const h=e.get("player")[0];if(!h||!h.exists())return;const u=i.getPhase();if(i.type==="gatekeeper"){i.attackTimer+=e.dt(),i.minionSpawnTimer+=e.dt(),i.radialBurstTimer+=e.dt();const M=u===1?8:u===2?6:5,P=10,f=u===1?8:u===2?6:5;if(i.isCharging){const _=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=_.x,i.pos.y+=_.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{i.chargeCooldownTimer+=e.dt();const _=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y);if(_.len()>0){const b=_.unit(),S=i.speed*(u===1?1:u===2?1.2:1.5),E=b.scale(S*e.dt()),C=i.pos.x+E.x,A=i.pos.y+E.y;let z=!0,R=!0;const Y=e.get("obstacle"),U=i.size||14;for(const N of Y){if(!N.exists())continue;const H=N.pos.x-N.width/2,I=N.pos.x+N.width/2,F=N.pos.y-N.height/2,V=N.pos.y+N.height/2,j=C-U,ce=C+U,ie=i.pos.y-U,ne=i.pos.y+U;ce>H&&j<I&&ne>F&&ie<V&&(z=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0));const se=i.pos.x-U,ge=i.pos.x+U,ve=A-U,Oe=A+U;ge>H&&se<I&&Oe>F&&ve<V&&(R=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0))}z&&(i.pos.x=C),R&&(i.pos.y=A)}i.minionSpawnTimer>=M&&(i.spawnMinions(),i.minionSpawnTimer=0),i.chargeCooldownTimer>=P&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{i.exists()&&(i.color=e.rgb(...c.color),i.startCharge(h.pos))}),i.chargeCooldownTimer=0),i.radialBurstTimer>=f&&(i.radialBurst(),i.radialBurstTimer=0)}}else if(i.type==="twinGuardianMelee"){i.attackTimer+=e.dt(),i.chargeCooldownTimer+=e.dt();const M=8,P=150,f=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),_=f.len();if(i.isCharging){const B=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=B.x,i.pos.y+=B.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1.2&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{if(_>0){const B=f.unit(),b=i.speed*(i.enraged?1.5:1),S=B.scale(b*e.dt()),E=i.pos.x+S.x,C=i.pos.y+S.y;let A=!0,z=!0;const R=e.get("obstacle"),Y=i.size||14;for(const U of R){if(!U.exists())continue;const N=U.pos.x-U.width/2,H=U.pos.x+U.width/2,I=U.pos.y-U.height/2,F=U.pos.y+U.height/2,V=E-Y,j=E+Y,ce=i.pos.y-Y,ie=i.pos.y+Y;j>N&&V<H&&ie>I&&ce<F&&(A=!1);const ne=i.pos.x-Y,se=i.pos.x+Y,ge=C-Y,ve=C+Y;se>N&&ne<H&&ve>I&&ge<F&&(z=!1)}A&&(i.pos.x=E),z&&(i.pos.y=C)}i.chargeCooldownTimer>=M&&_<P&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{if(i.exists()){i.color=e.rgb(...c.color);const B=i.enraged?3.5:2.5;i.chargeSpeed=i.speed*B,i.startCharge(h.pos)}}),i.chargeCooldownTimer=0)}}else if(i.type==="twinGuardianRanged"){i.attackTimer+=e.dt();const M=200,P=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),f=P.len();if(f>0){const B=P.unit();let b=i.speed*(i.enraged?1.5:1);if(f<M){const S=B.scale(-b*e.dt()),E=i.pos.x+S.x,C=i.pos.y+S.y;let A=!0,z=!0;const R=e.get("obstacle"),Y=i.size||14;for(const U of R){if(!U.exists())continue;const N=U.pos.x-U.width/2,H=U.pos.x+U.width/2,I=U.pos.y-U.height/2,F=U.pos.y+U.height/2,V=E-Y,j=E+Y,ce=i.pos.y-Y,ie=i.pos.y+Y;j>N&&V<H&&ie>I&&ce<F&&(A=!1);const ne=i.pos.x-Y,se=i.pos.x+Y,ge=C-Y,ve=C+Y;se>N&&ne<H&&ve>I&&ge<F&&(z=!1)}A&&(i.pos.x=E),z&&(i.pos.y=C)}else if(f>M*1.5){const S=B.scale(b*e.dt()),E=i.pos.x+S.x,C=i.pos.y+S.y;let A=!0,z=!0;const R=e.get("obstacle"),Y=i.size||14;for(const U of R){if(!U.exists())continue;const N=U.pos.x-U.width/2,H=U.pos.x+U.width/2,I=U.pos.y-U.height/2,F=U.pos.y+U.height/2,V=E-Y,j=E+Y,ce=i.pos.y-Y,ie=i.pos.y+Y;j>N&&V<H&&ie>I&&ce<F&&(A=!1);const ne=i.pos.x-Y,se=i.pos.x+Y,ge=C-Y,ve=C+Y;se>N&&ne<H&&ve>I&&ge<F&&(z=!1)}A&&(i.pos.x=E),z&&(i.pos.y=C)}}const _=1/(i.fireRate*(i.enraged?1.5:1));if(i.attackTimer>=_){if(f>0){const B=P.unit(),b=To(e,i.pos.x,i.pos.y,B,i.projectileSpeed,i.projectileDamage*(i.enraged?1.25:1),0,0,!1);b.isBossProjectile=!0,b.color=e.rgb(100,150,255)}i.attackTimer=0}}else if(i.type==="swarmQueen"){i.minionSpawnTimer+=e.dt();const M=i.hp()/i.maxHealth;let P;M>.66?P=5:M>.33?P=3:P=2;const f=i.spawnedMinions.filter(R=>R.exists()&&R.hp()>0);if(i.minionSpawnTimer>=P&&f.length<8){const R=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",Y=(i.rng?i.rng.next():Math.random())*Math.PI*2,U=50+(i.rng?i.rng.next():Math.random())*30,N=i.pos.x+Math.cos(Y)*U,H=i.pos.y+Math.sin(Y)*U,I=Rn(e,N,H,R,s);I.isBossMinion=!0,i.spawnedMinions.push(I),i.spawnedMinions=i.spawnedMinions.filter(F=>F.exists()),i.minionSpawnTimer=0}const B=e.width()/2,b=e.height()/2,S=150,E=e.vec2(B-i.pos.x,b-i.pos.y),C=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),A=C.len();let z=e.vec2(0,0);if(E.len()>30&&(z=z.add(E.unit().scale(.5))),A<S&&(z=z.add(C.unit().scale(-1))),z.len()>0){const Y=z.unit().scale(i.speed*e.dt()),U=i.pos.x+Y.x,N=i.pos.y+Y.y;let H=!0,I=!0;const F=e.get("obstacle"),V=i.size||14;for(const j of F){if(!j.exists())continue;const ce=j.pos.x-j.width/2,ie=j.pos.x+j.width/2,ne=j.pos.y-j.height/2,se=j.pos.y+j.height/2,ge=U-V,ve=U+V,Oe=i.pos.y-V,Ee=i.pos.y+V;ve>ce&&ge<ie&&Ee>ne&&Oe<se&&(H=!1);const Ne=i.pos.x-V,et=i.pos.x+V,Te=N-V,Mt=N+V;et>ce&&Ne<ie&&Mt>ne&&Te<se&&(I=!1)}H&&(i.pos.x=U),I&&(i.pos.y=N)}}else{const M=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y);if(M.len()>0){const _=M.unit().scale(i.speed*e.dt()),B=i.pos.x+_.x,b=i.pos.y+_.y;let S=!0,E=!0;const C=e.get("obstacle"),A=i.size||14;for(const z of C){if(!z.exists())continue;const R=z.pos.x-z.width/2,Y=z.pos.x+z.width/2,U=z.pos.y-z.height/2,N=z.pos.y+z.height/2,H=B-A,I=B+A,F=i.pos.y-A,V=i.pos.y+A;I>R&&H<Y&&V>U&&F<N&&(S=!1);const j=i.pos.x-A,ce=i.pos.x+A,ie=b-A,ne=b+A;ce>R&&j<Y&&ne>U&&ie<N&&(E=!1)}S&&(i.pos.x=B),E&&(i.pos.y=b)}}const g=e.width(),p=e.height(),T=20,m=i.size||14;i.pos.x=e.clamp(i.pos.x,T+m,g-T-m),i.pos.y=e.clamp(i.pos.y,T+m,p-T-m)}),i.isDead=!1,i.onDeath(()=>{de()&&me()&&i.mpEntityId&&Jr({entityId:i.mpEntityId,entityType:"boss",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue})}),n==="swarmQueen"&&i.onDeath(()=>{const h=8+Math.floor((i.rng?i.rng.next():Math.random())*5);for(let u=0;u<h;u++){const g=Math.PI*2/h*u+(i.rng?i.rng.next():Math.random())*.3,p=40+(i.rng?i.rng.next():Math.random())*20,T=i.pos.x+Math.cos(g)*p,m=i.pos.y+Math.sin(g)*p,M=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",P=Rn(e,T,m,M,s);P.isBossMinion=!0}}),i.updateVisual(),de()&&me()&&(Xo(i,{type:n,floor:s,isBoss:!0}),i.enemyType=n),i}function Em(e,t,o,n=1,s=null){const a=$i(e,t.pos.x,t.pos.y,"twinGuardianMelee",n,s),r=$i(e,o.pos.x,o.pos.y,"twinGuardianRanged",n,s);return a.twinPartner=r,r.twinPartner=a,a.onDeath(()=>{r&&r.exists()&&!r.enraged&&(r.enrage(),de()&&me()&&ol(r.networkId))}),r.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enrage(),de()&&me()&&ol(a.networkId))}),[a,r]}const Bn={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function Am(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const n=1+(t-1)*.1,a=Pt("propDropChance")*.05;for(const[r,l]of Object.entries(Bn)){const c=l.dropChance*n+a,d=Math.min(c,1);if(Math.random()<d)return r}return null}function Ma(e,t){const o=Bn[t];if(!o)return;const n=rr[o.weaponKey];if(n){if(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=o.weaponKey,e.weaponDef=n,e.fireRate=n.fireRate,e.projectileSpeed=n.projectileSpeed,e.projectileDamage=n.baseDamage,e.projectileCount=n.projectileCount,e.piercing=n.piercing,e.obstaclePiercing=n.obstaclePiercing,e.critChance=n.critChance,e.critDamage=n.critDamage,e.spreadAngle=n.spreadAngle,e.weaponRange=n.range,e.weaponCategory=n.category,n.orbitRadius&&(e.orbitRadius=n.orbitRadius,e.rotationSpeed=n.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),n.explosionRadius&&(e.explosionRadius=n.explosionRadius,e.explosionDamage=n.explosionDamage),n.chainRange&&(e.chainRange=n.chainRange,e.maxJumps=n.maxJumps,e.chainDamageReduction=n.chainDamageReduction),o.isAmmoBased)e.powerupAmmo=o.ammo,e.powerupDuration=null;else if(o.isTimeBased){const a=Pt("propDurability")*2;e.powerupDuration=o.duration+a,e.powerupAmmo=null}}}function cr(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function Sm(e,t=0){if(!e.powerupWeapon)return!1;const o=Bn[e.powerupWeapon];return o&&(o.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||o.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(de()&&me()&&e.slotIndex!==void 0&&sl(e.slotIndex,e.powerupWeapon),cr(e),!0):!1}function Mm(e){if(!e.powerupWeapon)return;const t=Bn[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function Tm(e){if(!e.powerupWeapon)return null;const t=Bn[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function Xs(e,t,o,n){const s=e.add([e.text("+",{size:16}),e.pos(t,o),e.anchor("center"),e.color(...Vt.XP_COLOR),e.area(),e.scale(1),"xpPickup"]);return s.value=n,s.lifetime=Vt.XP_LIFETIME,s.age=0,s.collected=!1,s.magnetizing=!1,s.magnetizeSpeed=0,s.targetPlayer=null,s.isFlyingToUI=!1,s.velocityY=-150-Math.random()*100,s.gravity=600,s.groundY=o,s.bounceDamping=.5,s.bouncing=!0,s.onUpdate(()=>{if(s.isFlyingToUI){const l=e.vec2(e.width()/2,e.height()-18).sub(s.pos);l.len()<10?e.destroy(s):s.pos=s.pos.add(l.unit().scale(1e3*e.dt()));return}if(e.paused){const r=Math.sin(s.age*Vt.XP_PULSE_SPEED)*Vt.XP_PULSE_AMOUNT;s.scale=e.vec2(1+r);return}s.age+=e.dt();const a=Math.sin(s.age*Vt.XP_PULSE_SPEED)*Vt.XP_PULSE_AMOUNT;if(s.scale=e.vec2(1+a),!s.magnetizing&&s.bouncing&&(s.velocityY+=s.gravity*e.dt(),s.pos.y+=s.velocityY*e.dt(),s.pos.y>=s.groundY&&(s.pos.y=s.groundY,s.velocityY=-s.velocityY*s.bounceDamping,Math.abs(s.velocityY)<20&&(s.bouncing=!1,s.velocityY=0))),s.magnetizing&&s.targetPlayer&&s.targetPlayer.exists()){s.bouncing=!1;const r=e.vec2(s.targetPlayer.pos.x-s.pos.x,s.targetPlayer.pos.y-s.pos.y),l=r.len();if(l>0){const c=r.scale(1/l);s.magnetizeSpeed=Math.min(s.magnetizeSpeed+Vt.MAGNETIZE_ACCELERATION*e.dt(),Vt.MAGNETIZE_SPEED),s.pos=s.pos.add(c.scale(s.magnetizeSpeed*e.dt()))}}s.age>=s.lifetime&&e.destroy(s)}),s.pickupType="xp",de()&&me()&&Wr(s,{type:"xpPickup",value:n}),de()&&s.onDestroy(()=>{$r(s)}),s}const jc=["$","","","","","","",""];function Bi(){return jc[Math.floor(Math.random()*jc.length)]}function Fs(e,t,o,n,s=null){const a=s||Bi(),r=e.add([e.text(a,{size:9}),e.pos(t,o),e.anchor("center"),e.color(...Vt.CURRENCY_COLOR),e.area(),e.scale(1),e.opacity(1),"currencyPickup"]);return r.value=n,r.lifetime=Vt.CURRENCY_LIFETIME,r.age=0,r.collected=!1,r.magnetizing=!1,r.magnetizeSpeed=0,r.targetPlayer=null,r.isFlyingToUI=!1,r.velocityY=-150-Math.random()*100,r.gravity=600,r.groundY=o,r.bounceDamping=.5,r.bouncing=!0,r.onUpdate(()=>{if(r.isFlyingToUI){const i=e.vec2(e.width()-20,20).sub(r.pos);i.len()<10?e.destroy(r):r.pos=r.pos.add(i.unit().scale(1e3*e.dt()));return}if(e.paused){const d=Math.sin(r.age*Vt.CURRENCY_PULSE_SPEED)*Vt.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+d);return}r.age+=e.dt();const l=Math.sin(r.age*Vt.CURRENCY_PULSE_SPEED)*Vt.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+l);const c=r.lifetime-r.age;if(c<=4&&c>0){const d=4+(4-c)*2,i=Math.sin(r.age*d*Math.PI*2);r.opacity=.65+i*.35,i>0?r.color=e.rgb(255,255,200):r.color=e.rgb(...Vt.CURRENCY_COLOR)}else r.opacity=1;if(!r.magnetizing&&r.bouncing&&(r.velocityY+=r.gravity*e.dt(),r.pos.y+=r.velocityY*e.dt(),r.pos.y>=r.groundY&&(r.pos.y=r.groundY,r.velocityY=-r.velocityY*r.bounceDamping,Math.abs(r.velocityY)<20&&(r.bouncing=!1,r.velocityY=0))),r.magnetizing&&r.targetPlayer&&r.targetPlayer.exists()){r.bouncing=!1;const d=e.vec2(r.targetPlayer.pos.x-r.pos.x,r.targetPlayer.pos.y-r.pos.y),i=d.len();if(i>0){const h=d.scale(1/i);r.magnetizeSpeed=Math.min(r.magnetizeSpeed+Vt.MAGNETIZE_ACCELERATION*e.dt(),Vt.MAGNETIZE_SPEED),r.pos=r.pos.add(h.scale(r.magnetizeSpeed*e.dt()))}}r.age>=r.lifetime&&e.destroy(r)}),r.pickupType="currency",de()&&me()&&Wr(r,{type:"currencyPickup",value:n,icon:a}),de()&&r.onDestroy(()=>{$r(r)}),r}function Zc(e,t,o,n){const s=Bn[n];if(!s)return null;const a=e.add([e.text(s.icon,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...s.color),e.area(),e.scale(1),"powerupWeaponPickup"]);return a.powerupKey=n,a.lifetime=Vt.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.velocityY=-150-Math.random()*100,a.gravity=600,a.groundY=o,a.bounceDamping=.5,a.bouncing=!0,a.onUpdate(()=>{if(e.paused){const l=Math.sin(a.age*4)*.15;a.scale=e.vec2(1+l),a.angle=Math.sin(a.age*2)*10;return}a.age+=e.dt();const r=Math.sin(a.age*4)*.15;if(a.scale=e.vec2(1+r),a.angle=Math.sin(a.age*2)*10,!a.magnetizing&&a.bouncing&&(a.velocityY+=a.gravity*e.dt(),a.pos.y+=a.velocityY*e.dt(),a.pos.y>=a.groundY&&(a.pos.y=a.groundY,a.velocityY=-a.velocityY*a.bounceDamping,Math.abs(a.velocityY)<20&&(a.bouncing=!1,a.velocityY=0))),a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){a.bouncing=!1;const l=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),c=l.len();if(c>0){const d=l.scale(1/c);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+Vt.MAGNETIZE_ACCELERATION*e.dt(),Vt.MAGNETIZE_SPEED),a.pos=a.pos.add(d.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="powerup",de()&&me()&&Wr(a),de()&&a.onDestroy(()=>{$r(a)}),a}class pn{constructor(t){this.seed=t>>>0,this.originalSeed=this.seed}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}range(t,o){return o<=t?(console.warn(`SeededRandom.range: Invalid range [${t}, ${o}). Returning min.`),t):Math.floor(t+this.next()*(o-t))}rangeFloat(t,o){return t+this.next()*(o-t)}choose(t){if(!(!t||t.length===0))return t[this.range(0,t.length)]}shuffle(t){const o=[...t];for(let n=o.length-1;n>0;n--){const s=this.range(0,n+1);[o[n],o[s]]=[o[s],o[n]]}return o}probability(t){return this.next()<t}reset(){this.seed=this.originalSeed}getState(){return this.seed}setState(t){this.seed=t>>>0}}function Yr(...e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e[o]|0;return t>>>0}function Dm(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)|0;return t>>>0}const os={peers:new Map,localLatency:0,lastPingId:0,lastPingSentTime:0,handlersRegistered:!1};function Cm(){os.handlersRegistered||(os.handlersRegistered=!0,He("ping",(e,t)=>{me()?qo(t,"pong",{pingId:e.pingId,serverTime:Date.now()}):lo("pong",{pingId:e.pingId,serverTime:Date.now()})}),He("pong",(e,t)=>{const o=Date.now(),n=e.pingId;if(me()){const s=os.peers.get(t);if(s&&s.pingId===n){const a=o-s.lastPingTime;s.latency=a}}else os.lastPingId===n&&(os.localLatency=o-os.lastPingSentTime)}))}const wt={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10,lifesteal:5,dodgeChance:5,thorns:5,aoeSize:10,knockback:5,magnetRange:10,invulnTime:5,moveDamage:5,lowHealthDmg:5,killSpeed:5},gs={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${wt.damage})`:""}`,apply:e=>{const t=e.upgradeStacks?.damage||0,o=e.baseProjectileDamage||e.weaponDef?.baseDamage||10,n=Math.pow(1.25,t);e.projectileDamage=Math.floor(o*n)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${wt.fireRate})`:""}`,apply:e=>{const t=e.upgradeStacks?.fireRate||0,o=e.baseFireRate||e.weaponDef?.fireRate||1.5,n=Math.pow(1.2,t);e.fireRate=o*n}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${wt.speed})`:""}`,apply:e=>{const t=e.upgradeStacks?.speed||0,o=e.characterData?.stats?.speed||150,n=Math.pow(1.15,t);e.speed=Math.floor(o*n),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${wt.health})`:""}`,apply:e=>{const t=e.upgradeStacks?.health||0,o=e.characterData?.stats?.health||100,n=t*20,s=e.maxHealth;e.maxHealth=o+n;const a=e.maxHealth-s;a>0&&e.setHP(e.hp()+a)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${wt.projectileSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.projectileSpeed||0,o=e.baseProjectileSpeed||e.weaponDef?.projectileSpeed||300,n=Math.pow(1.25,t);e.projectileSpeed=Math.floor(o*n)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${wt.xpGain})`:""}`,apply:e=>{const t=e.upgradeStacks?.xpGain||0,o=e.characterData?.ability==="xpBoost"?1.1:1;e.xpMultiplier=o+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${wt.pickupRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.pickupRadius||0,o=30,n=Math.pow(1.5,t);e.pickupRadius=Math.floor(o*n)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${wt.multiShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.multiShot||0,o=e.weaponDef?.projectileCount||1;e.projectileCount=o+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${wt.piercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.piercing||0,o=e.weaponDef?.piercing||0;e.piercing=o+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${wt.obstaclePiercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.obstaclePiercing||0,o=e.weaponDef?.obstaclePiercing||0;e.obstaclePiercing=o+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${wt.critChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.critChance||0;let n=(e.weaponDef?.critChance||.05)+t*.1;e.characterData?.ability==="critBoost"&&(n*=1.5),e.critChance=n}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${wt.critDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.critDamage||0;let n=(e.weaponDef?.critDamage||2)+t*.5;e.characterData?.ability==="critBoost"&&(n*=1.25),e.critDamage=n}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${wt.spreadShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.spreadShot||0,o=e.weaponDef?.spreadAngle||0;e.spreadAngle=o+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${wt.pelletCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.pelletCount||0,o=e.weaponDef?.projectileCount||3;e.projectileCount=o+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${wt.range})`:""}`,apply:e=>{const t=e.upgradeStacks?.range||0,o=e.weaponDef?.range||600,n=Math.pow(1.25,t);e.weaponRange=Math.floor(o*n)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${wt.dot})`:""}`,apply:e=>{const t=e.upgradeStacks?.dot||0,o=e.characterData?.ability==="fireDot"?1.25:1;e.fireDotMultiplier=o+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${wt.orbitalCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalCount||0,o=e.weaponDef?.projectileCount||1;e.projectileCount=o+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${wt.orbitalSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalSpeed||0,o=e.weaponDef?.rotationSpeed||180,n=Math.pow(1.5,t);e.rotationSpeed=o*n}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${wt.orbitalRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalRadius||0,o=e.weaponDef?.orbitRadius||45,n=Math.pow(1.2,t);e.orbitRadius=Math.floor(o*n)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${wt.explosionRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionRadius||0,o=e.weaponDef?.explosionRadius||50,n=Math.pow(1.25,t);e.explosionRadius=Math.floor(o*n)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${wt.explosionDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionDamage||0,o=e.weaponDef?.explosionDamage||15,n=Math.pow(1.25,t);e.explosionDamage=Math.floor(o*n)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${wt.chainJumps})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainJumps||0,o=e.weaponDef?.maxJumps||3;e.maxJumps=o+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${wt.chainRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainRange||0,o=e.weaponDef?.chainRange||70,n=Math.pow(1.25,t);e.chainRange=Math.floor(o*n)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${wt.chainDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainDamage||0,o=e.weaponDef?.chainDamageReduction||.15;e.chainDamageReduction=Math.max(.05,o-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${wt.defense})`:""}`,apply:e=>{const t=e.upgradeStacks?.defense||0,o=e.characterData?.ability==="tankStats"?.15:0;e.defense=o+t*2}},lifesteal:{name:"Life Drain",icon:"",description:"Heal 2% of damage dealt",category:"passive",maxStacks:5,getDescription:e=>`Heal ${(e||1)*2}% of damage dealt${e>0?` (${e}/${wt.lifesteal})`:""}`,apply:e=>{const t=e.upgradeStacks?.lifesteal||0;e.lifestealPercent=t*.02}},dodgeChance:{name:"Evasion",icon:"",description:"+5% dodge chance",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% dodge chance${e>0?` (${e}/${wt.dodgeChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.dodgeChance||0,o=e.characterData?.ability==="dodgeChance"?.1:0;e.dodgeChance=o+t*.05}},thorns:{name:"Thorns",icon:"",description:"Reflect 15% damage to attackers",category:"passive",maxStacks:5,getDescription:e=>`Reflect ${(e||1)*15}% damage${e>0?` (${e}/${wt.thorns})`:""}`,apply:e=>{const t=e.upgradeStacks?.thorns||0;e.thornsPercent=t*.15}},aoeSize:{name:"Blast Radius",icon:"",description:"+15% explosion/area size",category:"weapon",upgradeCategory:"explosionRadius",maxStacks:10,getDescription:e=>`+${(e||1)*15}% AoE size${e>0?` (${e}/${wt.aoeSize})`:""}`,apply:e=>{const t=e.upgradeStacks?.aoeSize||0;if(e.aoeSizeMultiplier=1+t*.15,e.explosionRadius){const o=e.weaponDef?.explosionRadius||50;e.explosionRadius=Math.floor(o*e.aoeSizeMultiplier)}}},knockback:{name:"Impact Force",icon:"",description:"+20% knockback",category:"weapon",maxStacks:5,getDescription:e=>`+${(e||1)*20}% knockback${e>0?` (${e}/${wt.knockback})`:""}`,apply:e=>{const t=e.upgradeStacks?.knockback||0;e.knockbackMultiplier=1+t*.2}},magnetRange:{name:"Treasure Hunter",icon:"",description:"+25% pickup radius",category:"passive",maxStacks:10,getDescription:e=>`+${(e||1)*25}% pickup radius${e>0?` (${e}/${wt.magnetRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.magnetRange||0,o=30,n=e.upgradeStacks?.pickupRadius||0,s=Math.pow(1.5,n);e.pickupRadius=Math.floor(o*s*(1+t*.25))}},invulnTime:{name:"Iron Skin",icon:"",description:"+0.15s invulnerability frames",category:"passive",maxStacks:5,getDescription:e=>`+${((e||1)*.15).toFixed(2)}s invuln${e>0?` (${e}/${wt.invulnTime})`:""}`,apply:e=>{const t=e.upgradeStacks?.invulnTime||0,o=1;e.invulnerableDuration=o+t*.15}},moveDamage:{name:"Momentum",icon:"",description:"+2% damage per speed stack",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*2}% damage per speed stack${e>0?` (${e}/${wt.moveDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.moveDamage||0;e.moveDamageBonus=t*.02}},lowHealthDmg:{name:"Desperation",icon:"",description:"+5% damage per 10% missing HP",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% damage per 10% missing HP${e>0?` (${e}/${wt.lowHealthDmg})`:""}`,apply:e=>{const t=e.upgradeStacks?.lowHealthDmg||0;e.lowHealthDmgBonus=t*.05}},killSpeed:{name:"Bloodlust",icon:"",description:"+3% speed for 3s on kill",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*3}% speed for 3s on kill${e>0?` (${e}/${wt.killSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.killSpeed||0;e.killSpeedBonus=t*.03,e.killSpeedDuration=3,e.killSpeedStacks=0,e.killSpeedTimer=0}}};function Rm(e,t){if(e.category==="passive"){const o=t.upgradeStacks?.[e.key]||0,n=e.maxStacks||wt[e.key]||10;return!(o>=n)}if(e.category==="weapon"){const o=t.upgradeStacks?.[e.key]||0,n=e.maxStacks||wt[e.key]||10;if(o>=n)return!1;const s=t.characterData?.weapon||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(s):e.upgradeCategory?Qg(s,e.upgradeCategory):!0}return!0}function Im(e=3,t=null,o=null){let s=Object.keys(gs).map(c=>({key:c,...gs[c],type:"upgrade"})),a=s;t&&(a=s.filter(c=>Rm(c,t))),a.length<e&&(a=s);const r=[],l=new Set;for(;r.length<e&&r.length<a.length;){const c=o?o.range(0,a.length):Math.floor(Math.random()*a.length),d=a[c];l.has(d.key)||(l.add(d.key),r.push(d))}return r}function qr(e,t){const o=gs[t];o&&(o.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,Ji(e))}function Ji(e){Object.keys(gs).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&gs[t].apply(e)})}function Pm(e,t){if(!e)return"";if(e.getDescription){const o=t?.upgradeStacks?.[e.key]||0;return e.getDescription(o)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const zn={BUTTON:{SM:{width:120,height:30},MD:{width:160,height:36},LG:{width:280,height:45},XL:{width:320,height:50}}},Q={H1:24,H2:18,BODY:16,SMALL:14,TINY:12,MICRO:11,TITLE:36,HEADER:24,LABEL:18,BUTTON:20,HUD:16},y={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},ns={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},Li={HEALTH:"HP",FLOOR:"Floor",DAMAGE:"Damage",SPEED:"Speed"};function ni(e){return e.toUpperCase()}function Qc(e,t){return`${e}/${t}`}const w={BACKGROUND:0,GAME_ENTITIES:10,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1500,TOOLTIP:2e3,PAUSE_MENU:2001,DEBUG:9999},Is=["$","","","","","","",""];function li(e,t={}){const{patternCount:o=12,particleCount:n=20,includeCursorFollowers:s=!1}=t,a=["","","","","","","",""];for(let r=0;r<o;r++){const l=e.add([e.text(a[Math.floor(Math.random()*a.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.15),e.scale(1),e.z(w.PARTICLES)]);l.pulseTime=Math.random()*Math.PI*2,l.pulseSpeed=1+Math.random()*2,l.onUpdate(()=>{l.pulseTime+=e.dt()*l.pulseSpeed;const c=.8+Math.sin(l.pulseTime)*.3;l.scale=e.vec2(c,c),l.opacity=.1+Math.abs(Math.sin(l.pulseTime))*.15})}for(let r=0;r<n;r++){const l=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(w.PARTICLES)]);l.speed=10+Math.random()*20,l.onUpdate(()=>{l.pos.y+=l.speed*e.dt(),l.pos.y>e.height()&&(l.pos.y=0,l.pos.x=Math.random()*e.width())})}if(s){const r=[];e.loop(5,()=>{if(r.length<3&&Math.random()<.3){const l=["","","","","","",""],c=e.add([e.text(l[Math.floor(Math.random()*l.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(w.PARTICLES)]);c.followSpeed=20+Math.random()*30,c.rotationSpeed=50+Math.random()*100,c.lifetime=15+Math.random()*10,c.onUpdate(()=>{const i=e.mousePos().sub(c.pos),h=i.len();if(h>5){const u=i.scale(1/h);c.pos=c.pos.add(u.scale(c.followSpeed*e.dt()))}if(c.angle+=c.rotationSpeed*e.dt(),c.lifetime-=e.dt(),c.lifetime<=0){e.destroy(c);const u=r.indexOf(c);u>-1&&r.splice(u,1)}}),r.push(c)}})}}const Bm={CONTESTANTS:["           ","    ","                              ","                            ","                      ","                           "],MERCH:["       ","   ","       ","       ","      ","          "],OPTIONS:["        ","  ","             ","             ","            ","                 "],"RATINGS AND RECORDS":["                           ","            ","                               ","                              ","                         ","                                  "],PROFILE:["         ","     ","            ","             ","            ","              "]};function di(e,t,o,n,s=8){function a(u,g,p){g/=100,p/=100;const T=(1-Math.abs(2*p-1))*g,m=T*(1-Math.abs(u/60%2-1)),M=p-T/2;let P=0,f=0,_=0;return u>=0&&u<60?(P=T,f=m,_=0):u>=60&&u<120?(P=m,f=T,_=0):u>=120&&u<180?(P=0,f=T,_=m):u>=180&&u<240?(P=0,f=m,_=T):u>=240&&u<300?(P=m,f=0,_=T):u>=300&&u<360&&(P=T,f=0,_=m),[Math.round((P+M)*255),Math.round((f+M)*255),Math.round((_+M)*255)]}const r=ni(t),l=Bm[r];if(!l){console.warn(`ASCII art not found for "${r}", using plain text`);const u=e.add([e.text(r,{size:s*2,font:"monospace"}),e.pos(o,n),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"animatedTitle"]);let g=0;return u.onUpdate(()=>{g+=e.dt();const p=g*50%360,T=a(p,80,60);u.color=e.rgb(...T);const m=Math.sin(g*2)*2;u.pos.y=n+m}),[u]}const c=[],d=10,i=n-l.length*d/2;l.forEach((u,g)=>{const p=e.add([e.text(u,{size:s,font:"monospace"}),e.pos(o,i+g*d),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"animatedTitle"]);c.push(p)});let h=0;return e.onUpdate(()=>{h+=e.dt(),c.forEach((u,g)=>{const p=(h*50+g*20)%360,T=a(p,80,60);u.color=e.rgb(...T);const m=Math.sin(h*2+g*.3)*2;u.pos.y=i+g*d+m,Math.random()<.001&&(u.pos.x=o+(Math.random()-.5)*10,e.wait(.1,()=>{u.exists()&&(u.pos.x=o)}))})}),c}function Gr(e,t,o){const n=()=>2+Math.random()*3,s=e.add([e.text(`${Is[0]}: ${t}`,{size:Q.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),a=s.width+30,r=40;e.destroy(s);const l=e.add([e.rect(a,r),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(w.UI_BACKGROUND)]),c=e.add([e.text(`${Is[0]}: ${t}`,{size:Q.LABEL}),e.pos(e.width()-20-a/2,40),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);c.symbolIndex=0,c.timeSinceLastChange=0,c.currentCurrency=t,c.symbolChangeInterval=n();const d=i=>{c.currentCurrency=i,c.text=`${Is[c.symbolIndex]}: ${i}`;const h=c.width+30;Math.abs(h-a)>10&&(l.width=h,c.pos.x=e.width()-20-h/2)};return c.onUpdate(()=>{c.timeSinceLastChange+=e.dt(),c.timeSinceLastChange>=c.symbolChangeInterval&&(c.timeSinceLastChange=0,c.symbolIndex=(c.symbolIndex+1)%Is.length,c.text=`${Is[c.symbolIndex]}: ${c.currentCurrency}`,c.symbolChangeInterval=n())}),{panel:l,text:c,updateCurrency:d}}const ft={queue:[],activeToasts:[],k:null,maxActiveToasts:3,toastWidth:300,toastHeight:80,toastMargin:10,animationDuration:.3,displayDuration:3};function Kr(e){ft.k=e,ft.queue=[],ft.activeToasts=[]}function ph(e){if(!ft.k){console.warn("Toast system not initialized");return}const o={title:e.title||"Notification",message:e.message||"",icon:e.icon||"!",iconColor:e.iconColor||y.TEXT_PRIMARY,type:e.type||"info",duration:e.duration||ft.displayDuration};ft.queue.push(o),gh()}function Lm(e){const t=Oo[e.difficulty]||Oo.normal;let o=" Achievement Unlocked!";e.difficulty==="challenge"?o=" Challenge Complete!":e.difficulty==="benchmark"&&(o=" Milestone Reached!"),ph({title:o,message:`${e.name}
${e.description}`,icon:e.icon,iconColor:t,type:"achievement",duration:5,difficulty:e.difficulty})}function zm(e,t){const o=Oo[t.difficulty]||Oo.normal;ph({title:`${e} unlocked:`,message:t.name,icon:t.icon,iconColor:o,type:"achievement",duration:3})}function gh(){if(ft.k)for(;ft.queue.length>0&&ft.activeToasts.length<ft.maxActiveToasts;){const t=ft.queue.shift();Om(t)}}function Om(e){const t=ft.k;if(!t)return;const o=t.width()+ft.toastWidth,n=t.width()-ft.toastMargin-ft.toastWidth/2,s=ft.activeToasts.length,a=ft.toastMargin+s*(ft.toastHeight+ft.toastMargin)+ft.toastHeight/2+20;let r=y.BORDER,l=[...y.BG_MEDIUM],c=2;e.type==="achievement"?(r=e.iconColor,l=[35,30,45],c=3):e.type==="success"?r=y.SUCCESS:e.type==="error"&&(r=y.ERROR);const d=t.add([t.rect(ft.toastWidth,ft.toastHeight),t.pos(o,a),t.anchor("center"),t.color(...l),t.outline(c,t.rgb(...r)),t.opacity(.95),t.fixed(),t.z(w.TOOLTIP),"toast"]);if(e.type==="achievement"){let P=0;d.onUpdate(()=>{P+=t.dt();const f=Math.sin(P*4)*.2+.8,_=Math.min(255,r[0]*f),B=Math.min(255,r[1]*f),b=Math.min(255,r[2]*f);d.outline.color=t.rgb(_,B,b)})}const i=t.add([t.rect(50,ft.toastHeight-10),t.pos(o-ft.toastWidth/2+30,a),t.anchor("center"),t.color(...l),t.opacity(.5),t.fixed(),t.z(w.TOOLTIP+1),"toast"]),h=e.type==="achievement"?32:28,u=t.add([t.text(e.icon,{size:h}),t.pos(o-ft.toastWidth/2+30,a),t.anchor("center"),t.color(...e.iconColor),t.fixed(),t.z(w.TOOLTIP+2),"toast"]);if(e.type==="achievement"){let P=0;const f=a;u.onUpdate(()=>{P+=t.dt();const _=Math.abs(Math.sin(P*3))*3;u.pos.y=f-_})}const g=t.add([t.text(e.title,{size:14}),t.pos(o-ft.toastWidth/2+65,a-20),t.anchor("left"),t.color(...e.type==="achievement"?[255,220,100]:y.TEXT_PRIMARY),t.fixed(),t.z(w.TOOLTIP+2),"toast"]),p=e.message.split(`
`),T=[];p.forEach((P,f)=>{const _=t.add([t.text(P,{size:12,width:ft.toastWidth-80}),t.pos(o-ft.toastWidth/2+65,a-5+f*16),t.anchor("left"),t.color(...y.TEXT_SECONDARY),t.fixed(),t.z(w.TOOLTIP+2),"toast"]);T.push(_)});const m={container:d,iconBg:i,icon:u,title:g,messages:T,startX:o,targetX:n,y:a,state:"entering",timer:0,data:e};ft.activeToasts.push(m);const M=t.onUpdate(()=>{if(m.state==="done"){M.cancel();return}if(m.timer+=t.dt(),m.state==="entering"){const P=Math.min(m.timer/ft.animationDuration,1),f=Nm(P),_=el(m.startX,m.targetX,f);kc(m,_),P>=1&&(m.state="visible",m.timer=0)}else if(m.state==="visible")m.timer>=m.data.duration&&(m.state="exiting",m.timer=0);else if(m.state==="exiting"){const P=Math.min(m.timer/ft.animationDuration,1),f=_m(P),_=t.width()+ft.toastWidth,B=el(m.targetX,_,f);kc(m,B);const b=1-P;m.container.opacity=b*.95,m.iconBg.opacity=b*.5,m.icon.opacity=b,m.title.opacity=b,m.messages.forEach(S=>S.opacity=b),P>=1&&(m.state="done",Hm(m))}});m.updateHandler=M}function kc(e,t){const o=t-e.container.pos.x;e.container.pos.x=t,e.iconBg.pos.x+=o,e.icon.pos.x+=o,e.title.pos.x+=o,e.messages.forEach(n=>n.pos.x+=o)}function Hm(e){const t=ft.k;if(!t)return;e.updateHandler&&e.updateHandler.cancel(),e.container.exists()&&t.destroy(e.container),e.iconBg.exists()&&t.destroy(e.iconBg),e.icon.exists()&&t.destroy(e.icon),e.title.exists()&&t.destroy(e.title),e.messages.forEach(n=>{n.exists()&&t.destroy(n)});const o=ft.activeToasts.indexOf(e);o>-1&&ft.activeToasts.splice(o,1),Um(),gh()}function Um(){ft.activeToasts.forEach((e,t)=>{if(e.state==="visible"||e.state==="entering"){const o=ft.toastMargin+t*(ft.toastHeight+ft.toastMargin)+ft.toastHeight/2+20,n=e.container.pos.y,s=o-n;e.container.pos.y=o,e.iconBg.pos.y+=s,e.icon.pos.y+=s,e.title.pos.y+=s,e.messages.forEach((a,r)=>{a.pos.y+=s}),e.y=o}})}function Nm(e){return 1-Math.pow(1-e,3)}function _m(e){return e*e*e}function el(e,t,o){return e+(t-e)*o}const O={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/15,lastResyncTime:0,resyncInterval:5,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null,gameSeed:0,floorRng:null,roomRng:null,currentFloor:1,currentRoom:{x:0,y:0},pendingXP:0,onGameSeedCallback:null};function Xm(e,t=0,o=null,n=null){O.isActive=!0,O.isHost=e,O.localPlayerSlot=t,O.players.clear(),O.inputBuffer=[],O.lastSyncTime=0,O.k=o,Cm(),O.enemies.clear(),O.projectiles.clear(),O.pickups.clear(),O.nextEntityId=1,n!==null?O.gameSeed=n:e&&(O.gameSeed=Math.floor(Math.random()*4294967295)),O.floorRng=new pn(O.gameSeed),O.currentFloor=1,O.currentRoom={x:0,y:0},e?Fm():(ji=!1,Ym())}function Fm(){lr||(lr=!0,He("player_input",(e,t)=>{if(!e||typeof e!="object")return;const o=fs(),n=o.slots.findIndex(s=>s.peerId===t);if(n!==-1&&O.players.has(n)){const s=O.players.get(n);if(!s||!s.exists())return;if(e.move&&typeof e.move=="object"){const a=Math.max(-1,Math.min(1,Number(e.move.x)||0)),r=Math.max(-1,Math.min(1,Number(e.move.y)||0));s.move={x:a,y:r}}if(e.shoot!==void 0&&(s.isShooting=!!e.shoot),e.aimAngle!==void 0){const a=Number(e.aimAngle)||0;s.aimAngle=Math.max(-360,Math.min(360,a))}}else console.warn("[Multiplayer] Could not find player for peer:",t,"slot:",n),console.warn("[Multiplayer] Party slots:",o.slots),console.warn("[Multiplayer] Registered players:",Array.from(O.players.keys()))}),He("pause_request",(e,t)=>{O.k&&(O.k.paused=e.paused,O.k.gameData&&O.k.gameData.updatePauseUI&&O.k.gameData.updatePauseUI(e.paused),Ke("pause_state",{paused:e.paused}))}),He("player_death",(e,t)=>{const o=O.players.get(e.slotIndex);o&&o.exists()&&(o.isDead=!0,o.canMove=!1,o.canShoot=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5),Ke("player_death",{slotIndex:e.slotIndex},[t]))}),He("enemy_death",(e,t)=>{Ke("entity_destroyed",{entityId:e.entityId,entityType:e.entityType,x:e.x,y:e.y})}),He("resync_request",(e,t)=>{qo(t,"game_state",Vr())}),He("level_up_queued",(e,t)=>{Ke("level_up_queued",{slotIndex:e.slotIndex,level:e.level,timestamp:Date.now()})}),He("player_emote",(e,t)=>{Ke("player_emote",e)}),He("upgrade_selected",(e,t)=>{const o=O.players.get(e.slotIndex);o&&o.exists()&&(qr(o,e.upgradeKey),o.upgradeStacks||(o.upgradeStacks={}),o.upgradeStacks[e.upgradeKey]=(o.upgradeStacks[e.upgradeKey]||0)+1,o.selectedUpgrades||(o.selectedUpgrades=new Set),o.selectedUpgrades.add(e.upgradeKey),Ji(o)),Ke("upgrade_selected",{slotIndex:e.slotIndex,upgradeKey:e.upgradeKey,timestamp:Date.now()})}),He("synergy_activated",(e,t)=>{Ke("synergy_activated",{slotIndex:e.slotIndex,synergies:e.synergies,timestamp:Date.now()})}),He("achievement_unlocked",(e,t)=>{Ke("achievement_unlocked",{achievementId:e.achievementId,playerSlotIndex:e.playerSlotIndex,playerName:e.playerName})}))}let ji=!1,lr=!1;function Ym(){ji||(ji=!0,He("game_state",e=>{if(O.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==O.localPlayerSlot){const o=O.players.get(t.slotIndex);o&&o.exists()&&(o.netTarget?(o.netTarget.x=t.x,o.netTarget.y=t.y):o.netTarget={x:t.x,y:t.y},o.angle=t.angle||0,o.outline&&o.outline.exists()&&(o.outline.angle=o.angle),t.maxHealth!==void 0&&(o.maxHealth=t.maxHealth),t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.invulnerable!==void 0&&(o.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(o.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(o.isDead=t.isDead,o.isDead?(o.canShoot=!1,o.canMove=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5)):(o.canShoot=!0,o.canMove=!0,o.opacity=1,o.outline&&o.outline.exists()&&(o.outline.opacity=1))),t.weapons&&(o.weapons=t.weapons),t.passiveUpgrades&&(o.passiveUpgrades=t.passiveUpgrades),t.upgradeStacks&&(o.upgradeStacks=t.upgradeStacks),t.speed!==void 0&&(o.speed=t.speed),t.damage!==void 0&&(o.damage=t.damage),t.pickupRadius!==void 0&&(o.pickupRadius=t.pickupRadius),t.runStats&&(o.runStats||(o.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),o.runStats.kills=t.runStats.kills,o.runStats.creditsPickedUp=t.runStats.creditsPickedUp,o.runStats.bossesKilled=t.runStats.bossesKilled))}else{const o=O.players.get(O.localPlayerSlot);o&&o.exists()&&(t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.maxHealth!==void 0&&(o.maxHealth=t.maxHealth),t.invulnerable!==void 0&&(o.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(o.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(o.isDead=t.isDead,o.isDead?(o.canShoot=!1,o.canMove=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5)):(o.canShoot=!0,o.canMove=!0,o.opacity=1,o.outline&&o.outline.exists()&&(o.outline.opacity=1))),t.runStats&&(o.runStats||(o.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),o.runStats.kills=t.runStats.kills,o.runStats.creditsPickedUp=t.runStats.creditsPickedUp,o.runStats.bossesKilled=t.runStats.bossesKilled))}}),e.enemies){const t=new Set;e.enemies.forEach(o=>{t.add(o.id);const n=O.enemies.get(o.id);n&&n.exists()&&(n.netTarget?(n.netTarget.x=o.x,n.netTarget.y=o.y):n.netTarget={x:o.x,y:o.y},o.maxHealth!==void 0&&(n.maxHealth=o.maxHealth),n.setHP&&o.hp!==void 0&&n.setHP(o.hp),o.shieldHealth!==void 0&&(n.shieldHealth=o.shieldHealth),o.armorHealth!==void 0&&(n.armorHealth=o.armorHealth),n.updateVisual&&n.updateVisual())}),O.enemies.forEach((o,n)=>{!t.has(n)&&o.exists()&&(o.cleanupHealthBars&&typeof o.cleanupHealthBars=="function"&&o.cleanupHealthBars(),O.k.destroy(o),O.enemies.delete(n))})}if(e.pickups){const t=new Set;e.pickups.forEach(o=>{t.add(o.id);const n=O.pickups.get(o.id);if(n&&n.exists()){if(n.pos.x=o.x,n.pos.y=o.y,o.magnetizing!==void 0)if(n.magnetizing=o.magnetizing,o.magnetizing&&o.targetPlayerSlot!==void 0){const s=O.players.get(o.targetPlayerSlot);s&&s.exists()?n.targetPlayer=s:(n.magnetizing=!1,n.targetPlayer=null)}else o.magnetizing||(n.targetPlayer=null);o.isFlyingToUI!==void 0&&(n.isFlyingToUI=o.isFlyingToUI)}}),O.pickups.forEach((o,n)=>{!t.has(n)&&o.exists()&&(O.k.destroy(o),O.pickups.delete(n))})}}}),He("spawn_entity",e=>{if(O.k){if(e.entityType==="enemy"){let t;e.isBoss?t=$i(O.k,e.x,e.y,e.type,e.floor):t=Rn(O.k,e.x,e.y,e.type,e.floor),t.mpEntityId=e.id,e.isBossMinion&&(t.isBossMinion=!0),O.enemies.set(e.id,t)}else if(e.entityType==="xpPickup"){const t=Xs(O.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",O.pickups.set(e.id,t)}else if(e.entityType==="currencyPickup"){const t=Fs(O.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",O.pickups.set(e.id,t)}}}),He("spawn_projectile",e=>{if(!O.k)return;const t=O.k.vec2(e.directionX,e.directionY),o=To(O.k,e.x,e.y,t,e.speed,e.damage,e.piercing,e.obstaclePiercing,e.isCrit,e.maxRange);(e.char||e.color)&&(o.text=e.char,e.color&&(o.color=O.k.rgb(...e.color))),o.mpEntityId=e.id,O.projectiles.set(e.id,o)}),He("damage_dealt",e=>{if(!O.k)return;const t=O.k.add([O.k.text(e.damage.toString(),{size:e.isCrit?24:18}),O.k.pos(e.x,e.y),O.k.anchor("center"),O.k.color((e.isCrit,255),e.isCrit?200:255,e.isCrit?0:255),O.k.opacity(1),O.k.lifespan(.8),O.k.z(1e3)]);t.onUpdate(()=>{t.exists()&&(t.pos.y-=50*O.k.dt(),t.opacity-=1.25*O.k.dt())});const o=O.enemies.get(e.targetId);if(o&&o.exists()){const n=o.color;o.color=O.k.rgb(255,255,255),O.k.wait(.1,()=>{o.exists()&&(o.color=n)})}}),He("entity_destroyed",e=>{if(!O.k)return;const t=O.enemies.get(e.entityId)||O.pickups.get(e.entityId);t&&t.exists()&&(t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),O.k.destroy(t),(e.entityType==="pickup"||e.entityType==="xpPickup"||e.entityType==="currencyPickup")&&O.pickups.delete(e.entityId)),O.enemies.delete(e.entityId),O.projectiles.delete(e.entityId),O.pickups.delete(e.entityId)}),He("boss_enrage",e=>{if(!O.k)return;const t=O.enemies.get(e.networkId);t&&t.exists()&&t.enrage&&t.enrage()}),He("players_revived",e=>{if(!O.k)return;const o=.05+Pt("secondWind")*.05;O.players.forEach((n,s)=>{if(n&&n.exists()&&(n.hp()<=0||n.isDead)){const a=Math.max(1,Math.floor(n.maxHealth*o));n.setHP(a),n.isDead=!1,s===O.localPlayerSlot&&(n.canMove=!0,n.canShoot=!0);const r=Math.round(o*100),l=O.k.add([O.k.text(` REVIVED (${r}% HP) `,{size:16}),O.k.pos(n.pos.x,n.pos.y-40),O.k.anchor("center"),O.k.color(100,255,100),O.k.opacity(1),O.k.lifespan(2),O.k.z(1e3)]);l.onUpdate(()=>{l.exists()&&(l.pos.y-=30*O.k.dt(),l.opacity-=.5*O.k.dt())}),n.opacity=1,n.characterData&&(n.color=O.k.rgb(...n.characterData.color)),n.outline&&n.outline.exists()&&(n.outline.opacity=1)}})}),He("game_seed",e=>{O.gameSeed=e.seed,O.floorRng=new pn(O.gameSeed),e.roomTemplateKey&&(O.firstRoomTemplateKey=e.roomTemplateKey,console.log("[Multiplayer] Client received first room template:",e.roomTemplateKey)),O.onGameSeedCallback&&(O.onGameSeedCallback(),O.onGameSeedCallback=null)}),He("pause_state",e=>{O.k&&(O.k.paused=e.paused,O.k.gameData&&O.k.gameData.updatePauseUI&&O.k.gameData.updatePauseUI(e.paused))}),He("xp_gain",e=>{const t=O.players.get(O.localPlayerSlot);t&&t.exists()&&!t.isDead&&t.addXP?t.addXP(e.value):O.pendingXP+=e.value}),He("currency_gain",e=>{ds(e.value)}),He("enemy_split",e=>{O.k&&O.k.gameData&&O.k.gameData.incrementSplitEnemies&&O.k.gameData.incrementSplitEnemies(e.count)}),He("player_death",e=>{const t=O.players.get(e.slotIndex);t&&t.exists()&&(t.isDead=!0,t.canMove=!1,t.canShoot=!1,t.isShooting=!1,t.opacity=.5,t.outline&&t.outline.exists()&&(t.outline.opacity=.5))}),He("player_disconnected",e=>{const t=O.players.get(e.slotIndex);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),O.k.destroy(t),O.players.delete(e.slotIndex))}),He("host_quit",e=>{rs(),O.k&&O.k.go("menu")}),He("achievement_unlocked",e=>{if(e.playerSlotIndex!==O.localPlayerSlot){const t=an[e.achievementId];t&&O.k&&(Kr(O.k),zm(e.playerName,t))}}))}function tl(e,t){O.players.set(e,t),t.mpSlotIndex=e}function qm(e){const t=O.players.get(e);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),O.k&&O.k.destroy(t),O.players.delete(e),O.isHost&&Gm(e))}function Gm(e){O.isHost&&Ke("player_disconnected",{slotIndex:e})}function Km(e){if(O.isActive)if(O.lastSyncTime+=e,O.lastResyncTime+=e,O.isHost)O.lastSyncTime>=O.syncInterval&&(Vm(),O.lastSyncTime=0),O.lastResyncTime>=O.resyncInterval&&(O.players.forEach((t,o)=>{t&&t.exists()&&(t.isDead&&t.hp()>0&&(console.warn("[Multiplayer] Desync detected: Player",o,"is marked dead but has HP. Correcting..."),t.setHP(0)),!t.isDead&&t.hp()<=0&&(console.warn("[Multiplayer] Desync detected: Player",o,"has no HP but not marked dead. Correcting..."),t.isDead=!0,t.canMove=!1,t.canShoot=!1))}),O.lastResyncTime=0);else{if(O.lastSyncTime>=O.syncInterval&&(Jm(),O.lastSyncTime=0),O.lastResyncTime>=O.resyncInterval){let o=!1;O.players.forEach((n,s)=>{n&&n.exists()&&(n.isDead&&n.hp()>0&&(console.warn("[Multiplayer] Client desync: Player",s,"is dead but has HP"),o=!0),!n.isDead&&n.hp()<=0&&(console.warn("[Multiplayer] Client desync: Player",s,"has no HP but not dead"),o=!0))}),o&&Ey(),O.lastResyncTime=0}const t=Math.min(e*10,1);O.players.forEach(o=>{o.exists()&&o.isRemote&&o.netTarget&&(o.pos.x+=(o.netTarget.x-o.pos.x)*t,o.pos.y+=(o.netTarget.y-o.pos.y)*t)}),O.enemies.forEach(o=>{o.exists()&&o.netTarget&&(o.pos.x+=(o.netTarget.x-o.pos.x)*t,o.pos.y+=(o.netTarget.y-o.pos.y)*t)})}}function Vr(){const e=[],t=[],o=[],n=[];return O.players.forEach((s,a)=>{if(s.exists()){let r=[],l=[],c={};try{s.weapons&&(r=JSON.parse(JSON.stringify(s.weapons))),s.passiveUpgrades&&(l=JSON.parse(JSON.stringify(s.passiveUpgrades))),s.upgradeStacks&&(c=JSON.parse(JSON.stringify(s.upgradeStacks)))}catch(i){console.warn("Failed to serialize player upgrades:",i)}let d=s.maxHealth;s.hp&&typeof s.hp=="function"?d=s.hp():typeof s.hp=="number"&&(d=s.hp),e.push({slotIndex:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),angle:Number(s.angle||0),hp:Number(d),maxHealth:Number(s.maxHealth||100),level:Number(s.level||1),xp:Number(s.xp||0),isDead:!!s.isDead,weapons:r,passiveUpgrades:l,upgradeStacks:c,speed:Number(s.speed||0),damage:Number(s.damage||0),pickupRadius:Number(s.pickupRadius||0),invulnerable:!!s.invulnerable,invulnerableTime:Number(s.invulnerableTime||0),runStats:s.runStats?{kills:Number(s.runStats.kills||0),creditsPickedUp:Number(s.runStats.creditsPickedUp||0),bossesKilled:Number(s.runStats.bossesKilled||0)}:null})}}),O.enemies.forEach((s,a)=>{if(s.exists()){let r=0;s.hp&&typeof s.hp=="function"?r=s.hp():typeof s.hp=="number"&&(r=s.hp),t.push({id:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),hp:Number(r),maxHealth:Number(s.maxHealth||0),type:String(s.enemyType||"basic"),shieldHealth:Number(s.shieldHealth||0),armorHealth:Number(s.armorHealth||0)})}else O.enemies.delete(a)}),O.projectiles.forEach((s,a)=>{s.exists()||O.projectiles.delete(a)}),O.pickups.forEach((s,a)=>{if(s.exists()){const r={id:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),type:String(s.pickupType||"xp"),magnetizing:!!s.magnetizing,isFlyingToUI:!!s.isFlyingToUI};s.magnetizing&&s.targetPlayer&&s.targetPlayer.slotIndex!==void 0&&(r.targetPlayerSlot=Number(s.targetPlayer.slotIndex)),n.push(r)}else O.pickups.delete(a)}),{players:e,enemies:t,projectiles:o,pickups:n}}function Vm(){O.isHost&&Ke("game_state",Vr())}function Wm(e){!O.isHost||!O.isActive||(console.log("Sending initial game state to new joiner:",e),qo(e,"game_state",Vr()),$m(e))}function $m(e){!O.isHost||!O.isActive||!O.k||(O.k,console.log("[Multiplayer] Sending existing entities to new joiner:",e),O.enemies.forEach((t,o)=>{if(t&&t.exists()){const n={entityId:o,entityType:"enemy",x:t.pos.x,y:t.pos.y,enemyType:t.type||"basic",floor:t.floor||1,isBoss:t.is("boss")||!1,isMiniboss:t.is("miniboss")||!1,health:t.hp(),maxHealth:t.maxHealth,armorHealth:t.armorHealth||0,shieldHealth:t.shieldHealth||0};qo(e,"spawn_entity",n)}}),O.pickups.forEach((t,o)=>{if(t&&t.exists()){const n={entityId:o,entityType:"pickup",x:t.pos.x,y:t.pos.y,pickupType:t.pickupType||(t.is("xpPickup")?"xp":t.is("currencyPickup")?"currency":"powerup"),xpValue:t.xpValue||0,currencyValue:t.currencyValue||0};qo(e,"spawn_entity",n)}}),console.log("[Multiplayer] Sent",O.enemies.size,"enemies and",O.pickups.size,"pickups to new joiner"))}function Jm(){if(O.isHost)return;const e=O.players.get(O.localPlayerSlot);if(!e||!e.exists())return;const t=e.moveDir?{x:Number(e.moveDir.x||0),y:Number(e.moveDir.y||0)}:{x:0,y:0};lo("player_input",{slotIndex:Number(O.localPlayerSlot),move:t,shoot:!!e.isShooting,aimAngle:Number(e.aimAngle||0)})}function de(){return O.isActive}function jm(){return O.players.size}function rs(){O.isActive=!1,O.players.clear(),O.inputBuffer=[],O.enemies.clear(),O.projectiles.clear(),O.pickups.clear(),O.nextEntityId=1,Ot("player_input"),Ot("pause_request"),Ot("player_death"),Ot("enemy_death"),Ot("resync_request"),Ot("level_up_queued"),Ot("player_emote"),Ot("upgrade_selected"),Ot("synergy_activated"),Ot("achievement_unlocked"),Ot("game_state"),Ot("spawn_entity"),Ot("spawn_projectile"),Ot("damage_dealt"),Ot("entity_destroyed"),Ot("boss_enrage"),Ot("players_revived"),Ot("game_seed"),Ot("pause_state"),Ot("xp_gain"),Ot("currency_gain"),Ot("enemy_split"),Ot("player_disconnected"),Ot("host_quit"),wm(),ji=!1,lr=!1}function Xo(e,t={}){if(!O.isHost)return null;const o=O.nextEntityId++;return e.mpEntityId=o,O.enemies.set(o,e),Ke("spawn_entity",{id:o,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1,isBoss:t.isBoss||!1,isBossMinion:t.isBossMinion||!1}),o}function cs(e,t={}){if(!O.isHost)return null;const o=O.nextEntityId++;e.mpEntityId=o,O.projectiles.set(o,e);let n=[255,255,100];return e.color&&e.color.r!==void 0&&(n=[Math.round(e.color.r),Math.round(e.color.g),Math.round(e.color.b)]),Ke("spawn_projectile",{id:Number(o),x:Number(e.pos.x),y:Number(e.pos.y),directionX:Number(e.direction.x),directionY:Number(e.direction.y),speed:Number(e.speed),damage:Number(e.damage),piercing:Number(e.piercing||0),obstaclePiercing:Number(e.obstaclePiercing||0),isCrit:!!e.isCrit,maxRange:Number(e.maxRange),angle:Number(e.angle||0),char:e.text||t.char||"*",color:n}),o}function Zm(e){O.isActive&&e.mpEntityId!==void 0&&O.projectiles.delete(e.mpEntityId)}function Wr(e,t={}){if(!O.isHost)return null;const o=O.nextEntityId++;e.mpEntityId=o,O.pickups.set(o,e);const n={id:o,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(n.icon=t.icon),Ke("spawn_entity",n),o}function $r(e){O.isActive&&e.mpEntityId!==void 0&&O.pickups.delete(e.mpEntityId)}function me(){return O.isHost}function Qm(e){!O.isHost||!O.isActive||Ke("damage_dealt",{targetId:Number(e.targetId),targetType:String(e.targetType),damage:Number(e.damage),isCrit:!!e.isCrit,attackerId:e.attackerId!==void 0?Number(e.attackerId):null,x:Number(e.x),y:Number(e.y)})}function mh(e){!O.isHost||!O.isActive||Ke("player_healed",{slotIndex:Number(e.slotIndex),healAmount:Number(e.healAmount),newHP:Number(e.newHP),source:String(e.source||"unknown")})}function Ta(e){!O.isHost||!O.isActive||Ke("player_dodged",{slotIndex:Number(e.slotIndex),x:Number(e.x),y:Number(e.y)})}function Jr(e){!O.isHost||!O.isActive||Ke("entity_destroyed",{entityId:Number(e.entityId),entityType:String(e.entityType),x:Number(e.x),y:Number(e.y),xpDropped:e.xpDropped!==void 0?Number(e.xpDropped):0,currencyDropped:e.currencyDropped!==void 0?Number(e.currencyDropped):0})}function ol(e){!O.isHost||!O.isActive||Ke("boss_enrage",{networkId:e})}function km(){!O.isHost||!O.isActive||Ke("players_revived",{timestamp:Date.now()})}function nl(e,t,o=[]){!O.isHost||!O.isActive||Ke("game_over",{runStats:e,currencyEarned:t,partyStats:o,timestamp:Date.now()})}function ey(){!O.isHost||!O.isActive||Ke("host_quit",{timestamp:Date.now()})}function ty(e){!O.isHost||!O.isActive||Ke("powerup_weapon_applied",{powerupKey:e,timestamp:Date.now()})}function oy(e,t){O.isActive&&(O.isHost?Ke("upgrade_selected",{slotIndex:e,upgradeKey:t,timestamp:Date.now()}):lo("upgrade_selected",{slotIndex:e,upgradeKey:t}))}function ny(e,t){O.isActive&&(O.isHost?Ke("level_up_queued",{slotIndex:e,level:t,timestamp:Date.now()}):lo("level_up_queued",{slotIndex:e,level:t}))}function sy(e,t){O.isActive&&(O.isHost?Ke("synergy_activated",{slotIndex:e,synergies:t,timestamp:Date.now()}):lo("synergy_activated",{slotIndex:e,synergies:t}))}function sl(e,t){!O.isHost||!O.isActive||Ke("powerup_expired",{slotIndex:e,powerupKey:t,timestamp:Date.now()})}function il(){return O.gameSeed!==0}function iy(e){O.onGameSeedCallback=e}function ay(e){O.currentFloor=e;const t=Yr(O.gameSeed,e);O.floorRng=new pn(t)}function bi(){const e=Yr(O.gameSeed,O.currentFloor,O.currentRoom.x,O.currentRoom.y);return new pn(e)}function ry(){const e=O.firstRoomTemplateKey;return O.firstRoomTemplateKey=null,e}function cy(){return O.floorRng}function ly(e,t){const o=Yr(O.gameSeed,e,t);return new pn(o)}function dy(e=null){O.isHost&&Ke("game_seed",{seed:O.gameSeed,roomTemplateKey:e})}function hy(e){O.isHost&&Ke("pause_state",{paused:e})}function uy(e){O.isHost||lo("pause_request",{paused:e})}function fy(e){O.isHost||lo("enemy_death",e)}function py(e,t=null){O.isHost&&Ke("obstacle_data",{obstacles:e,doorStates:t})}function gy(){O.isHost&&Ke("room_completed",{})}function my(e){O.isHost&&Ke("xp_gain",{value:e})}function yy(e){O.isHost&&Ke("currency_gain",{value:e})}function xy(){const e=O.pendingXP;return O.pendingXP=0,e}function al(e,t){O.isHost?Ke("player_emote",{slotIndex:e,emoteType:t}):lo("player_emote",{slotIndex:e,emoteType:t})}function wy(e,t=null,o=null,n=null,s=null){O.isHost&&Ke("room_transition",{entryDirection:e,allPlayerStats:t,gridDirection:o,currentFloor:n,roomTemplateKey:s})}function by(e){O.isHost&&Ke("enemy_split",{count:e})}function vy(e){O.isActive&&(O.isHost?Ke("player_death",{slotIndex:e}):lo("player_death",{slotIndex:e}))}function Ey(){O.isHost||lo("resync_request",{timestamp:Date.now()})}function Ay(){return O.localPlayerSlot}function Sy(e,t){if(!O.isActive)return;const s=fs().slots[t]?.name||`Player ${t+1}`;Ke("achievement_unlocked",{achievementId:e,playerSlotIndex:t,playerName:s})}class rl{constructor(t,o,n,s=0){this.k=t,this.createFn=o,this.resetFn=n,this.pool=[],this.active=new Set;for(let a=0;a<s;a++){const r=this.createFn(t);r.hidden=!0,r.paused!==void 0&&(r.paused=!0),this.pool.push(r)}}acquire(...t){let o;return this.pool.length>0?(o=this.pool.pop(),o.hidden=!1,o.paused!==void 0&&(o.paused=!1)):o=this.createFn(this.k),this.resetFn&&this.resetFn(o,...t),this.active.add(o),o._pooled=!0,o}release(t){if(!(!t||!t._pooled)){if(!t.exists||!t.exists()){this.active.delete(t);return}t.hidden=!0,t.paused!==void 0&&(t.paused=!0),t.pos&&(t.pos.x=-9999,t.pos.y=-9999),this.active.delete(t),this.pool.push(t)}}clear(){for(const t of this.pool)t.exists&&t.exists()&&this.k.destroy(t);this.pool=[];for(const t of this.active)t.exists&&t.exists()&&this.k.destroy(t);this.active.clear()}getPoolSize(){return this.pool.length}getActiveCount(){return this.active.size}prewarm(t){for(let o=0;o<t;o++){const n=this.createFn(this.k);n.hidden=!0,n.paused!==void 0&&(n.paused=!0),n._pooled=!0,n.pos&&(n.pos.x=-9999,n.pos.y=-9999),this.pool.push(n)}}}const un={projectiles:null,particles:null};function My(e){un.projectiles=new rl(e,t=>{const o=t.add([t.text("*",{size:16}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,100),t.rotate(0),t.area(),"projectile"]);return o.hidden=!0,o},(t,o,n,s,a,r,l,c,d,i)=>{t.pos.x=o,t.pos.y=n,t.damage=r,t.piercing=l||0,t.obstaclePiercing=c||0,t.piercedEnemies=new Set,t.piercedObstacles=new Set,t.isCrit=d||!1,t.maxRange=i||750,t.distanceTraveled=0,t.direction=s,t.speed=a,t.isBoomerang=!1,t.isReturning=!1,t.ownerPlayer=null,t.returnSpeedMultiplier=1.2,t.isExplosive=!1,t.isChainLightning=!1,t.isEnemyProjectile=!1,t.isBossProjectile=!1,t.isReflected=!1,t.reflectionCount=0,t.chainedEnemies=null,t.chainJumps=0,t.ownerSlotIndex=void 0,t.burnDamage=null,t.burnDuration=null,t.text="*",t.color=d?e.rgb(255,200,0):e.rgb(255,255,100);const h=Math.atan2(s.y,s.x)*(180/Math.PI)+90;t.angle=h},50),un.particles=new rl(e,t=>{const o=t.add([t.text("*",{size:12}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,255),t.z(100),"particle"]);return o.hidden=!0,o},(t,o,n,s={})=>{const{char:a="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:i=1,fadeStart:h=.3,friction:u=.95,zIndex:g=100}=s;t.pos.x=o,t.pos.y=n,t.text=a,t.color=e.rgb(...l),t.z=g,t.opacity=1,t.velocity={x:c.x,y:c.y},t.gravity=d,t.friction=u,t.lifetime=i,t.fadeStart=h,t.age=0,t.initialOpacity=1},100)}function yh(){return un.particles}function Ty(){un.projectiles&&(un.projectiles.clear(),un.projectiles=null),un.particles&&(un.particles.clear(),un.particles=null)}function To(e,t,o,n,s,a,r=0,l=0,c=!1,d=null){const i=Math.atan2(n.y,n.x)*(180/Math.PI)+90,h=e.add([e.text("*",{size:16}),e.pos(t,o),e.anchor("center"),e.color(255,c?200:255,c?0:100),e.rotate(i),e.area(),"projectile"]);return h.damage=a,h.piercing=r,h.obstaclePiercing=l,h.piercedEnemies=new Set,h.piercedObstacles=new Set,h.isCrit=c,h.maxRange=d||us.DEFAULT_WEAPON_RANGE,h.distanceTraveled=0,h.direction=n,h.speed=s,h.isBoomerang=!1,h.isReturning=!1,h.ownerPlayer=null,h.returnSpeedMultiplier=1.2,h.useWeaponVisual=function(u){u&&u.char&&(h.text=u.char),u&&u.color&&(h.isCrit||(h.color=e.rgb(...u.color))),u&&u.range&&(h.maxRange=u.range)},h.onUpdate(()=>{if(e.paused)return;if(h.isBoomerang){if(h.isReturning)if(h.ownerPlayer&&h.ownerPlayer.exists()&&!h.ownerPlayer.isDead){const T=e.vec2(h.ownerPlayer.pos.x-h.pos.x,h.ownerPlayer.pos.y-h.pos.y),m=T.len();if(m>0){const M=T.unit(),P=h.speed*h.returnSpeedMultiplier,f=M.scale(P*e.dt());if(h.pos.x+=f.x,h.pos.y+=f.y,h.direction=M,m<30){e.destroy(h);return}}}else{e.destroy(h);return}else{const T=h.direction.scale(h.speed*e.dt());h.distanceTraveled+=T.len(),h.pos.x+=T.x,h.pos.y+=T.y,h.distanceTraveled>=h.maxRange&&(h.isReturning=!0,h.piercedEnemies.clear(),h.distanceTraveled=0)}const p=Math.atan2(h.direction.y,h.direction.x)*(180/Math.PI)+90;h.angle=p;return}const u=h.direction.scale(h.speed*e.dt()),g=u.len();if(h.distanceTraveled+=g,h.pos.x+=u.x,h.pos.y+=u.y,h.distanceTraveled>=h.maxRange){e.destroy(h);return}(h.pos.x<0||h.pos.x>e.width()||h.pos.y<0||h.pos.y>e.height())&&e.destroy(h)}),de()&&me()&&cs(h),de()&&h.onDestroy(()=>{Zm(h)}),h}const ms={rusher:{name:"Security Guard",char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{name:"Camera Operator",char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.53,projectileSpeed:200,projectileDamage:7},zombie:{name:"Audience Member",char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{name:"Fan",char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{name:"Stagehand",char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{name:"Head of Security",char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{name:"Camera Director",char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{name:"Bouncer",char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{name:"Runner",char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{name:"Pyrotechnics Tech",char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{name:"Floor Manager",char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},splitter:{name:"Intern",char:"",color:[200,255,200],baseHealth:40,baseSpeed:75,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,splits:!0,splitCount:2},mage:{name:"Lighting Director",char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{name:"Stage Manager",char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{name:"Set Designer",char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{name:"Editor",char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{name:"Casting Director",char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{name:"Assistant Director",char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},phaser:{name:"Ghost Writer",char:"",color:[180,180,255],baseHealth:25,baseSpeed:100,size:18,baseXPValue:3,behavior:"phase",pathfindingMode:"none",damage:10,phaseOpacity:.5,phaseThroughObstacles:!0},mimic:{name:"Stunt Double",char:"@",color:[255,100,100],baseHealth:35,baseSpeed:150,size:18,baseXPValue:4,behavior:"mimic",pathfindingMode:"none",damage:12,mimicDuration:2,mimicCooldown:4},healer:{name:"Producer",char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{name:"Executive Producer",char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{name:"Network Executive",char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{name:"Talent Agent",char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},reflector:{name:"Mirror Master",char:"",color:[200,200,255],baseHealth:80,baseSpeed:45,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:12,reflectsProjectiles:!0,reflectChance:.4},bomber:{name:"Demolitions Expert",char:"",color:[255,150,100],baseHealth:70,baseSpeed:0,size:22,baseXPValue:5,behavior:"bomber",fireRate:.4,projectileSpeed:100,projectileDamage:20,homingStrength:.5,bombExplosionRadius:50},basic:{name:"Crew Member",char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{name:"Camera Operator",char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{name:"Runner",char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function Dy(e){return ms[e]||ms.basic}const on=32,Cy=100;class Ry{constructor(){this.elements=[]}enqueue(t,o){this.elements.push({element:t,priority:o}),this.elements.sort((n,s)=>n.priority-s.priority)}dequeue(){return this.elements.shift()?.element}isEmpty(){return this.elements.length===0}}function cl(e,t){return{gx:Math.floor(e/on),gy:Math.floor(t/on)}}function xh(e,t){return{x:e*on+on/2,y:t*on+on/2}}function Da(e,t,o,n,s){if(t<0||o<0||t>=n||o>=s)return!1;const a=xh(t,o),r=e.get("obstacle");for(const l of r){if(!l.exists())continue;const c=on/2,d=a.x-c,i=a.x+c,h=a.y-c,u=a.y+c,g=l.pos.x-l.width/2,p=l.pos.x+l.width/2,T=l.pos.y-l.height/2,m=l.pos.y+l.height/2;if(i>g&&d<p&&u>T&&h<m)return!1}return!0}function Iy(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function Py(e,t,o,n,s){const a=e.width(),r=e.height(),l=Math.ceil(a/on),c=Math.ceil(r/on),d=cl(t,o),i=cl(n,s);if(!Da(e,d.gx,d.gy,l,c)||!Da(e,i.gx,i.gy,l,c))return[];const h=new Ry;h.enqueue(d,0);const u=new Map,g=new Map,p=f=>`${f.gx},${f.gy}`;u.set(p(d),null),g.set(p(d),0);let T=0;const m=l*c;for(;!h.isEmpty()&&T<m;){T++;const f=h.dequeue();if(f.gx===i.gx&&f.gy===i.gy)break;const _=[{gx:f.gx+1,gy:f.gy},{gx:f.gx-1,gy:f.gy},{gx:f.gx,gy:f.gy+1},{gx:f.gx,gy:f.gy-1},{gx:f.gx+1,gy:f.gy+1},{gx:f.gx+1,gy:f.gy-1},{gx:f.gx-1,gy:f.gy+1},{gx:f.gx-1,gy:f.gy-1}];for(const B of _){if(!Da(e,B.gx,B.gy,l,c))continue;const S=B.gx!==f.gx&&B.gy!==f.gy?1.4:1,E=g.get(p(f))+S,C=p(B);if(!g.has(C)||E<g.get(C)){g.set(C,E);const A=E+Iy(B,i);h.enqueue(B,A),u.set(C,f)}}}const M=[];let P=i;for(;P&&u.has(p(P));){const f=xh(P.gx,P.gy);if(M.unshift(f),P=u.get(p(P)),M.length>Cy)break}return M}function By(e,t,o,n){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=Py(e,t.pos.x,t.pos.y,o,n),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const r=t.pathfindingPath[t.pathfindingWaypointIndex];if(r){const l=e.vec2(r.x-t.pos.x,r.y-t.pos.y),c=l.len();if(c<on/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),c>0)return l.unit()}}const s=e.vec2(o-t.pos.x,n-t.pos.y);return s.len()>0?s.unit():e.vec2(0,0)}function Ly(e,t){const o=e.width(),n=e.height(),s=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:s});const a=t.perimeterMode;t.speed*e.dt();const r=20,l=e.vec2(a.targetX-t.pos.x,a.targetY-t.pos.y),c=l.len();if(c<r)switch(a.side){case"top":a.side="right",a.targetX=o-s,a.targetY=s;break;case"right":a.side="bottom",a.targetX=o-s,a.targetY=n-s;break;case"bottom":a.side="left",a.targetX=s,a.targetY=n-s;break;case"left":a.side="top",a.targetX=s,a.targetY=s;break}return c>0?l.unit():e.vec2(0,0)}function Rn(e,t,o,n="basic",s=1,a=null){const r=Dy(n),l=1+(s-1)*.3,c={char:r.char,color:r.color,health:Math.floor(r.baseHealth*l),speed:Math.floor(r.baseSpeed*(1+(s-1)*.1)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),behavior:r.behavior};function d(){return c.char}const i=e.add([e.text(d(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"enemy"]);i.originalColor=c.color,i.maxHealth=c.health,i.speed=c.speed,i.xpValue=c.xpValue,i.type=n,i.behavior=c.behavior,i.floor=s,i.pathfindingMode=r.pathfindingMode||"none",r.damage&&(i.damage=r.damage),r.fireRate&&(i.fireRate=r.fireRate),r.projectileSpeed&&(i.projectileSpeed=r.projectileSpeed),r.projectileDamage&&(i.projectileDamage=r.projectileDamage),r.chargeCooldown&&(i.chargeCooldown=r.chargeCooldown),r.splits&&(i.splits=!0,i.splitCount=r.splitCount||2,i.splitType=r.splitType||n),r.explodes&&(i.explodes=!0,i.explosionDamage=r.explosionDamage,i.explosionRadius=r.explosionRadius,r.shrapnel&&(i.shrapnel=!0,i.shrapnelCount=r.shrapnelCount||8));let h=0,u=0,g=0;if(s>=2){const S=a?a.next():Math.random();s>=2&&(n==="zombie"||n==="turret"||n==="heavyTank"||S<.3)&&(h=Math.floor(15+(s-2)*5))}if(s>=3){const S=a?a.next():Math.random();(n==="shooter"||n==="turret"||n==="wraith"||S<.2)&&(u=Math.floor(10+(s-3)*5),g=1+(s-3)*.5)}if(s>=4){const S=a?a.next():Math.random();(n==="heavyTank"||n==="spawner"||S<.1)&&(h===0&&(h=Math.floor(20+(s-4)*5)),u===0&&(u=Math.floor(15+(s-4)*5),g=1.5+(s-4)*.5))}const p=(r.baseArmorHealth||0)+h;i.armorHealth=Math.floor(p*l),i.maxArmorHealth=Math.floor(p*l),i.damageReduction=r.damageReduction||(p>0?.2:0),i.armorChar=r.armorChar||"[]",i.armorColor=r.armorColor||[200,200,200];const T=(r.baseShieldHealth||0)+u;i.shieldHealth=Math.floor(T*l),i.maxShieldHealth=Math.floor(T*l),i.shieldRegenRate=((r.shieldRegenRate||0)+g)*l,i.shieldChar=r.shieldChar||"{}",i.shieldColor=r.shieldColor||[100,200,255],i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.originalColor=c.color,i.coreChar=c.char,i.updateVisual=function(){let S="",E="",C="",A="";if(i.shieldHealth>0){const R=i.shieldHealth/i.maxShieldHealth;R>.66?(S="",E=""):R>.33?(S="",E=""):(S="",E="")}if(i.armorHealth>0){const R=i.armorHealth/i.maxArmorHealth;R>.66?(C="",A=""):R>.33?(C="",A=""):(C="",A="")}const z=`${S}${C}${i.coreChar}${A}${E}`;i.text=z,i.shieldHealth>0?i.color=e.rgb(...i.shieldColor):i.color=e.rgb(...i.originalColor)},i.takeDamage=function(S){let E=!1,C=!1;const A=i.shieldHealth,z=i.armorHealth;i.lastDamageTime=e.time();const R=3;if(i.shieldRegenCooldown=R,i.shieldHealth>0){const Y=Math.min(S,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-Y),E=i.shieldHealth!==A;const U=S-Y;U>0&&i.takeDamageInternal(U)}else i.takeDamageInternal(S);C=i.armorHealth!==z,(E||C)&&i.updateVisual()},i.takeDamageInternal=function(S){if(i.armorHealth>0){const E=Math.floor(S*(1-i.damageReduction)),C=Math.min(E,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-C);const A=S-E;if(A>0){const z=i.armorHealth>0?1-i.damageReduction:1,R=Math.floor(A*z);i.hurt(R)}}else i.hurt(S)},r.blocksProjectiles&&(i.blocksProjectiles=!0),r.teleportCooldown&&(i.teleportCooldown=r.teleportCooldown),r.teleportRange&&(i.teleportRange=r.teleportRange),r.spawnInterval&&(i.spawnInterval=r.spawnInterval),r.spawnType&&(i.spawnType=r.spawnType),r.buffRadius&&(i.buffRadius=r.buffRadius),r.buffAmount&&(i.buffAmount=r.buffAmount),r.healRadius&&(i.healRadius=r.healRadius),r.healAmount&&(i.healAmount=r.healAmount),r.healInterval&&(i.healInterval=r.healInterval),r.slowRadius&&(i.slowRadius=r.slowRadius),r.slowAmount&&(i.slowAmount=r.slowAmount),r.lifesteal&&(i.lifesteal=r.lifesteal),r.phaseOpacity&&(i.phaseOpacity=r.phaseOpacity),r.phaseThroughObstacles&&(i.phaseThroughObstacles=r.phaseThroughObstacles),r.mimicDuration&&(i.mimicDuration=r.mimicDuration),r.mimicCooldown&&(i.mimicCooldown=r.mimicCooldown),r.reflectsProjectiles&&(i.reflectsProjectiles=r.reflectsProjectiles),r.reflectChance&&(i.reflectChance=r.reflectChance),r.homingStrength&&(i.homingStrength=r.homingStrength),r.bombExplosionRadius&&(i.bombExplosionRadius=r.bombExplosionRadius),i.updateVisual(),i.attackTimer=0,i.chargeTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeDuration=0,i.chargePauseTimer=0,i.teleportTimer=0,i.spawnTimer=0,i.healTimer=0,i.buffedEnemies=new Set,i.mimicTimer=0,i.mimicMovementHistory=[],i.isMimicking=!1,i.mimicMoveIndex=0,i.phaseOpacity&&(i.opacity=i.phaseOpacity),i.stuckTimer=0,i.stuckThreshold=1,i.lastPosition={x:t,y:o},i.lastPositionUpdateTime=0,i.avoidanceDirection=null,i.avoidanceTimer=0;const m=30,M=3,P=-20,f=e.add([e.rect(m,M),e.pos(t,o+P),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),_=e.add([e.rect(m,M),e.pos(t,o+P),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);i.healthBarBg=f,i.healthBar=_,i.showHealthThreshold=.5,f.hidden=!0,_.hidden=!0,i.onUpdate(()=>{if(i.exists()&&i.healthBar&&i.healthBarBg){const S=i.hp()/i.maxHealth;if(S<i.showHealthThreshold&&S>0){i.healthBarBg.hidden=!1,i.healthBar.hidden=!1,i.healthBarBg.pos.x=i.pos.x,i.healthBarBg.pos.y=i.pos.y+P,i.healthBar.pos.x=i.pos.x,i.healthBar.pos.y=i.pos.y+P;const C=m*S;i.healthBar.width=Math.max(1,C),i.healthBar.pos.x=i.pos.x-(m-C)/2}else i.healthBarBg.hidden=!0,i.healthBar.hidden=!0}}),i.cleanupHealthBars=function(){i.healthBarBg&&i.healthBarBg.exists()&&e.destroy(i.healthBarBg),i.healthBar&&i.healthBar.exists()&&e.destroy(i.healthBar)};const B=(S,E)=>{const C=e.get("obstacle"),A=i.size||12;for(const z of C){if(!z.exists())continue;const R=z.pos.x-z.width/2,Y=z.pos.x+z.width/2,U=z.pos.y-z.height/2,N=z.pos.y+z.height/2,H=S-A,I=S+A,F=E-A,V=E+A;if(I>R&&H<Y&&V>U&&F<N)return!1}return!0},b=S=>{const E=S.len(),C=E>0?S.unit():e.vec2(0,0);i.lastPositionUpdateTime+=e.dt(),i.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(i.pos.x-i.lastPosition.x,2)+Math.pow(i.pos.y-i.lastPosition.y,2))<5?i.stuckTimer+=i.lastPositionUpdateTime:i.stuckTimer=0,i.lastPosition={x:i.pos.x,y:i.pos.y},i.lastPositionUpdateTime=0);const A=i.pos.x+S.x,z=i.pos.y+S.y;if(B(A,z))return i.avoidanceDirection=null,i.avoidanceTimer=0,S;if(i.avoidanceTimer-=e.dt(),i.stuckTimer>=i.stuckThreshold||i.avoidanceTimer<=0){const R=e.vec2(-C.y,C.x),Y=e.vec2(C.y,-C.x),U=[R.scale(E),Y.scale(E),e.vec2(R.x*.7+C.x*.3,R.y*.7+C.y*.3).unit().scale(E),e.vec2(Y.x*.7+C.x*.3,Y.y*.7+C.y*.3).unit().scale(E),e.vec2(R.x*.5+C.x*.5,R.y*.5+C.y*.5).unit().scale(E),e.vec2(Y.x*.5+C.x*.5,Y.y*.5+C.y*.5).unit().scale(E)];for(const N of U){const H=i.pos.x+N.x,I=i.pos.y+N.y;if(B(H,I))return i.avoidanceDirection=e.vec2(N.x,N.y).unit(),i.avoidanceTimer=.8,N}if(i.avoidanceDirection){const N=i.avoidanceDirection.scale(E),H=i.pos.x+N.x,I=i.pos.y+N.y;if(B(H,I))return N}return B(A,i.pos.y)?e.vec2(S.x,0):B(i.pos.x,z)?e.vec2(0,S.y):e.vec2(0,0)}else if(i.avoidanceDirection){const R=i.avoidanceDirection.scale(E),Y=i.pos.x+R.x,U=i.pos.y+R.y;if(B(Y,U))return R;i.avoidanceDirection=null,i.avoidanceTimer=0}return B(A,i.pos.y)?e.vec2(S.x,0):B(i.pos.x,z)?e.vec2(0,S.y):e.vec2(0,0)};return i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead){if((!de()||me())&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const H=1;if(i.shieldRegenTimer>=H){const I=i.shieldRegenRate*H;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+I),i.shieldRegenTimer=0}}i.shieldHealth>0&&i.updateVisual&&i.updateVisual()}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!de()||me())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const S=e.gameData?.alivePlayers||e.get("player").filter(H=>H.exists()&&!H.isDead&&H.hp()>0);if(S.length===0)return;let E=S[0],C=Math.sqrt(Math.pow(E.pos.x-i.pos.x,2)+Math.pow(E.pos.y-i.pos.y,2));for(let H=1;H<S.length;H++){const I=S[H],F=Math.sqrt(Math.pow(I.pos.x-i.pos.x,2)+Math.pow(I.pos.y-i.pos.y,2));F<C&&(C=F,E=I)}const A=e.vec2(E.pos.x-i.pos.x,E.pos.y-i.pos.y),z=A.len();if(i.behavior==="turret"){if(i.attackTimer+=e.dt(),z>0&&i.attackTimer>=1/i.fireRate){const H=A.unit(),I=To(e,i.pos.x,i.pos.y,H,i.projectileSpeed,i.projectileDamage,0,0,!1);I.isEnemyProjectile=!0,I.color=e.rgb(...i.originalColor),i.attackTimer=0}return}if(i.behavior==="shoot"){i.attackTimer+=e.dt();const H=150;let I=e.vec2(0,0);if(z>H*1.2?I=A.unit().scale(i.speed*e.dt()):z<H*.8&&(I=A.unit().scale(-i.speed*e.dt())),z>0&&i.attackTimer>=1/i.fireRate){const F=A.unit(),V=To(e,i.pos.x,i.pos.y,F,i.projectileSpeed,i.projectileDamage,0,0,!1);V.isEnemyProjectile=!0,V.color=e.rgb(...i.originalColor),i.attackTimer=0}if(I.len()>0){const F=b(I);i.pos.x+=F.x,i.pos.y+=F.y;const V=20,j=i.size||12;i.pos.x=e.clamp(i.pos.x,V+j,e.width()-V-j),i.pos.y=e.clamp(i.pos.y,V+j,e.height()-V-j)}return}if(i.behavior==="charge"){if(i.chargeTimer+=e.dt(),i.isCharging)if(i.chargeDuration+=e.dt(),i.chargeDuration>=.8)i.isCharging=!1,i.chargeDuration=0,i.chargePauseTimer=0;else{const I=i.chargeDirection.scale(i.speed*e.dt()),F=b(I);F.len()<I.len()*.3?(i.isCharging=!1,i.chargePauseTimer=.1):(i.pos.x+=F.x,i.pos.y+=F.y)}else if(i.chargePauseTimer>0)i.chargePauseTimer+=e.dt(),i.chargePauseTimer>=1&&(i.chargePauseTimer=0,i.chargeTimer=0);else if(i.chargeTimer>=i.chargeCooldown)i.color=e.rgb(255,255,0),e.wait(.2,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor),z>0&&(i.isCharging=!0,i.chargeDirection=A.unit(),i.chargeDuration=0))}),i.chargeTimer=0;else{const I=A.unit().scale(i.speed*.5*e.dt()),F=b(I);F.len()<I.len()*.5&&i.isCharging&&(i.isCharging=!1,i.chargePauseTimer=.1),i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="erratic"){if(z>0){const H=A.unit(),I=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),V=e.vec2(H.x+I.x,H.y+I.y).unit().scale(i.speed*e.dt()),j=b(V);i.pos.x+=j.x,i.pos.y+=j.y}return}if(i.behavior==="shield"){if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="teleport"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&z>0){const H=A.unit(),I=e.vec2(i.pos.x+H.x*i.teleportRange,i.pos.y+H.y*i.teleportRange);B(I.x,I.y)&&(i.pos.x=I.x,i.pos.y=I.y,i.teleportTimer=0,i.color=e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}))}else if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="spawner"){if(i.spawnTimer+=e.dt(),i.spawnTimer>=i.spawnInterval){const H=Math.random()*Math.PI*2,I=30,F=i.pos.x+Math.cos(H)*I,V=i.pos.y+Math.sin(H)*I;if(B(F,V)){const j=Rn(e,F,V,i.spawnType||"rusher",i.floor);j.isBossMinion=!0,i.spawnTimer=0}}if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="buffer"){if(i.attackTimer+=e.dt(),i.attackTimer>=1){const H=e.get("enemy");for(const I of H){if(!I.exists()||I===i)continue;e.vec2(I.pos.x-i.pos.x,I.pos.y-i.pos.y).len()<=i.buffRadius?(I.buffed||(I.buffed=!0,I.originalSpeed=I.speed,I.originalDamage=I.damage||10),I.speed=I.originalSpeed*(1+i.buffAmount),I.damage=I.originalDamage*(1+i.buffAmount),i.buffedEnemies.add(I)):i.buffedEnemies.has(I)&&(I.buffed&&(I.speed=I.originalSpeed,I.damage=I.originalDamage,I.buffed=!1),i.buffedEnemies.delete(I))}i.attackTimer=0}if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="healer"){if(i.healTimer+=e.dt(),i.healTimer>=i.healInterval){const H=e.get("enemy");for(const I of H){if(!I.exists()||I===i)continue;if(e.vec2(I.pos.x-i.pos.x,I.pos.y-i.pos.y).len()<=i.healRadius){const j=I.hp(),ce=I.maxHealth;if(j<ce){const ie=Math.min(ce,j+i.healAmount);I.setHP(ie);const ne=e.add([e.text("+",{size:16}),e.pos(I.pos.x,I.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{ne.exists()&&e.destroy(ne)})}}}i.healTimer=0}if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="teleportPlayer"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&z<=80){const H=Math.random()*Math.PI*2,I=E.pos.x+Math.cos(H)*i.teleportRange,F=E.pos.y+Math.sin(H)*i.teleportRange,V=Math.max(50,Math.min(e.width()-50,I)),j=Math.max(50,Math.min(e.height()-50,F));E.pos.x=V,E.pos.y=j,i.teleportTimer=0;const ce=e.add([e.text("!",{size:24}),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{ce.exists()&&e.destroy(ce)})}if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="freeze"){if(z<=i.slowRadius?(E.slowed||(E.slowed=!0,E.originalSpeed=E.speed),E.speed=E.originalSpeed*(1-i.slowAmount)):E.slowed&&(E.speed=E.originalSpeed,E.slowed=!1),z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="phase"){if(z>0){const H=A.unit();i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt();const I=e.width(),F=e.height(),V=20,j=i.size||12;i.pos.x=e.clamp(i.pos.x,V+j,I-V-j),i.pos.y=e.clamp(i.pos.y,V+j,F-V-j)}return}if(i.behavior==="mimic"){if(i.mimicTimer+=e.dt(),i.isMimicking)if(i.mimicMoveIndex<i.mimicMovementHistory.length){const H=i.mimicMovementHistory[i.mimicMoveIndex],I=e.vec2(H.x*e.dt()*60,H.y*e.dt()*60),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y,i.mimicMoveIndex++}else i.isMimicking=!1,i.mimicTimer=0,i.mimicMovementHistory=[],i.mimicMoveIndex=0;else if(i.mimicTimer<i.mimicDuration){if(E.move&&(E.move.x!==0||E.move.y!==0)&&i.mimicMovementHistory.push({x:E.move.x,y:E.move.y}),z>0){const I=A.unit().scale(i.speed*.5*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}}else if(i.mimicTimer>=i.mimicCooldown)if(i.mimicMovementHistory.length>0)i.isMimicking=!0,i.mimicMoveIndex=0,i.color=e.rgb(255,255,255),e.wait(.15,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))});else{if(z>0){const I=A.unit().scale(i.speed*1.5*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}i.mimicTimer=0}else if(z>0){const I=A.unit().scale(i.speed*e.dt()),F=b(I);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="bomber"){if(i.attackTimer+=e.dt(),z>0&&i.attackTimer>=1/i.fireRate){const H=A.unit(),I=To(e,i.pos.x,i.pos.y,H,i.projectileSpeed,i.projectileDamage,0,0,!1);I.isEnemyProjectile=!0,I.isBomb=!0,I.homingStrength=i.homingStrength,I.bombExplosionRadius=i.bombExplosionRadius,I.targetPlayer=E,I.color=e.rgb(255,100,0),I.text="",I.onUpdate(()=>{if(I.targetPlayer&&I.targetPlayer.exists()&&!I.targetPlayer.isDead){const F=e.vec2(I.targetPlayer.pos.x-I.pos.x,I.targetPlayer.pos.y-I.pos.y),V=F.len()>0?F.unit():e.vec2(0,0);I.direction=e.vec2(I.direction.x+(V.x-I.direction.x)*I.homingStrength*e.dt(),I.direction.y+(V.y-I.direction.y)*I.homingStrength*e.dt()).unit()}}),i.attackTimer=0}return}if(i.behavior==="rush"&&z>0){let H;if(i.pathfindingMode==="smart")H=By(e,i,E.pos.x,E.pos.y);else{const F=A.unit().scale(i.speed*e.dt());H=b(F).unit()}i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt()}if(i.behavior==="perimeter"){const H=Ly(e,i);i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt()}const R=e.width(),Y=e.height(),U=20,N=i.size||12;i.pos.x=e.clamp(i.pos.x,U+N,R-U-N),i.pos.y=e.clamp(i.pos.y,U+N,Y-U-N)}),i.isDead=!1,i.onDeath(()=>{if(i.behavior==="buffer"&&i.buffedEnemies)for(const S of i.buffedEnemies)S.exists()&&S.buffed&&(S.speed=S.originalSpeed,S.damage=S.originalDamage,S.buffed=!1)}),i.onDeath(()=>{if(de()&&me()&&i.mpEntityId&&Jr({entityId:i.mpEntityId,entityType:"enemy",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue}),i.splits&&i.hp()<=0){if(de()&&!me())return;const S=i.splitCount||2,E=i.splitType||"slime";for(let C=0;C<S;C++){const A=Math.PI*2/S*C,z=20,R=i.pos.x+Math.cos(A)*z,Y=i.pos.y+Math.sin(A)*z,U=Rn(e,R,Y,E,i.floor);U.maxHealth=Math.max(10,Math.floor(U.maxHealth/2)),U.setHP(U.maxHealth),U.size=Math.max(8,Math.floor(U.size*.8)),U.splits=!1,U.isSplitEnemy=!0,de()&&me()&&Xo&&Xo(U,{maxHealth:U.maxHealth,floor:i.floor})}e.gameData&&e.gameData.incrementSplitEnemies&&e.gameData.incrementSplitEnemies(S),de()&&me()&&by(S)}if(i.explodes&&i.hp()<=0){(!de()||me())&&e.get("player").forEach(C=>{if(C&&C.exists()&&!C.isDead&&e.vec2(C.pos.x-i.pos.x,C.pos.y-i.pos.y).len()<=i.explosionRadius&&!C.invulnerable){const R=Math.max(1,i.explosionDamage-(C.defense||0));C.hurt(R),C.invulnerable=!0,C.invulnerableTime=C.invulnerableDuration,C.color=e.rgb(255,100,100)}});const S=e.add([e.text("*",{size:24}),e.pos(i.pos.x,i.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{S.exists()&&e.destroy(S)})}}),de()&&me()&&(Xo(i,{type:n,floor:s}),i.enemyType=n),i}const jn={brute:{name:"Security Chief",coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{name:"Technical Director",coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{name:"Stunt Coordinator",coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{name:"Studio Manager",coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{name:"Creative Director",coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function zy(e){return jn[e]||jn.brute}function Oy(e,t,o,n="brute",s=1){const a=zy(n),r=1+(s-1)*.2,l={coreChar:a.coreChar,armorChar:a.armorChar||"[]",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*r),armorHealth:Math.floor((a.baseArmorHealth||0)*r),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*r),shieldHealth:Math.floor((a.baseShieldHealth||0)*r),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*r),speed:Math.floor(a.baseSpeed*(1+(s-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*r),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*r},c=e.add([e.text(l.coreChar,{size:l.size}),e.pos(t,o),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"miniboss"]);return c.maxHealth=l.health,c.speed=l.speed,c.xpValue=l.xpValue,c.type=n,c.floor=s,a.meleeDamage&&(c.meleeDamage=a.meleeDamage),a.projectileDamage&&(c.projectileDamage=a.projectileDamage),a.projectileSpeed&&(c.projectileSpeed=a.projectileSpeed),a.fireRate&&(c.fireRate=a.fireRate),c.armorHealth=l.armorHealth,c.maxArmorHealth=l.maxArmorHealth,c.damageReduction=l.damageReduction,c.coreChar=l.coreChar,c.armorChar=l.armorChar,c.armorColor=l.armorColor,c.shieldHealth=l.shieldHealth,c.maxShieldHealth=l.maxShieldHealth,c.shieldRegenRate=l.shieldRegenRate,c.shieldChar=l.shieldChar,c.shieldColor=l.shieldColor,c.shieldRegenTimer=0,c.shieldRegenCooldown=0,c.lastDamageTime=0,c.attackTimer=0,c.chargeCooldownTimer=0,c.chargeDurationTimer=0,c.isCharging=!1,c.chargeDirection=null,c.chargeSpeed=0,c.updateVisual=function(){let d="",i="",h="",u="";if(c.shieldHealth>0){const p=c.shieldHealth/c.maxShieldHealth;p>.66?(d="",i=""):p>.33?(d="",i=""):(d="",i="")}if(c.armorHealth>0){const p=c.armorHealth/c.maxArmorHealth;p>.66?(h="",u=""):p>.33?(h="",u=""):(h="",u="")}const g=`${d}${h}${c.coreChar}${u}${i}`;c.text=g,c.shieldHealth>0?c.color=e.rgb(...l.shieldColor):c.color=e.rgb(...l.color)},c.takeDamage=function(d){let i=!1,h=!1;const u=c.shieldHealth,g=c.armorHealth;c.lastDamageTime=e.time();const p=3;if(c.shieldRegenCooldown=p,c.shieldHealth>0){const T=Math.min(d,c.shieldHealth);c.shieldHealth=Math.max(0,c.shieldHealth-T),i=c.shieldHealth!==u;const m=d-T;m>0&&c.takeDamageInternal(m)}else c.takeDamageInternal(d);h=c.armorHealth!==g,(i||h)&&c.updateVisual()},c.takeDamageInternal=function(d){if(c.armorHealth>0){const i=Math.floor(d*(1-c.damageReduction)),h=Math.min(i,c.armorHealth);c.armorHealth=Math.max(0,c.armorHealth-h);const u=d-i;if(u>0){const g=c.armorHealth>0?1-c.damageReduction:1,p=Math.floor(u*g);c.hurt(p)}}else c.hurt(d)},c.startCharge=function(d){if(!c.exists())return;c.isCharging=!0;const i=e.vec2(d.x-c.pos.x,d.y-c.pos.y);i.len()>0&&(c.chargeDirection=i.unit(),c.chargeSpeed=c.speed*2.5)},c.onUpdate(()=>{if(e.paused)return;if(c.shieldRegenRate>0&&c.shieldHealth<c.maxShieldHealth&&c.hp()>0&&!c.isDead&&(c.shieldRegenCooldown>0&&(c.shieldRegenCooldown-=e.dt()),c.shieldRegenCooldown<=0)){c.shieldRegenTimer+=e.dt();const m=1;if(c.shieldRegenTimer>=m){const M=c.shieldRegenRate*m;c.shieldHealth=Math.min(c.maxShieldHealth,c.shieldHealth+M),c.shieldRegenTimer=0,c.shieldHealth>0&&c.updateVisual()}}c.burnDuration>0&&c.hp()>0&&!c.isDead&&(c.burnTimer=(c.burnTimer||0)+e.dt(),c.burnTimer>=.5&&((!de()||me())&&(c.takeDamage?c.takeDamage(c.burnDamage):c.hurt(c.burnDamage)),c.color,c.color=e.rgb(255,150,50),e.wait(.1,()=>{c.exists()&&c.updateVisual()}),c.burnTimer=0),c.burnDuration-=e.dt(),c.burnDuration<=0&&(c.burnDamage=0,c.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const i=e.vec2(d.pos.x-c.pos.x,d.pos.y-c.pos.y),h=i.len();if(a.behavior==="charge"){c.attackTimer+=e.dt(),c.chargeCooldownTimer+=e.dt();const m=6,M=200;if(c.isCharging){const P=c.chargeDirection.scale(c.chargeSpeed*e.dt());c.pos.x+=P.x,c.pos.y+=P.y,c.chargeDurationTimer+=e.dt(),c.chargeDurationTimer>=1&&(c.isCharging=!1,c.chargeDurationTimer=0,c.chargeCooldownTimer=0)}else{if(h>0){const f=i.unit().scale(c.speed*e.dt());c.pos.x+=f.x,c.pos.y+=f.y}c.chargeCooldownTimer>=m&&h<M&&(c.color=e.rgb(255,255,0),e.wait(.3,()=>{c.exists()&&(c.color=e.rgb(...l.color),c.startCharge(d.pos))}),c.chargeCooldownTimer=0)}}else if(a.behavior==="shoot"){c.attackTimer+=e.dt();const m=180;if(h>0){const P=i.unit();let f=c.speed;if(h<m){const _=P.scale(-f*e.dt());c.pos.x+=_.x,c.pos.y+=_.y}else if(h>m*1.5){const _=P.scale(f*e.dt());c.pos.x+=_.x,c.pos.y+=_.y}}const M=1/c.fireRate;if(c.attackTimer>=M){if(h>0){const P=i.unit(),f=To(e,c.pos.x,c.pos.y,P,c.projectileSpeed,c.projectileDamage,0,0,!1);f.isBossProjectile=!0,f.color=e.rgb(...l.color)}c.attackTimer=0}}else if(a.behavior==="rush"&&h>0){const M=i.unit().scale(c.speed*e.dt());c.pos.x+=M.x,c.pos.y+=M.y}const u=e.width(),g=e.height(),p=20,T=c.size||24;c.pos.x=e.clamp(c.pos.x,p+T,u-p-T),c.pos.y=e.clamp(c.pos.y,p+T,g-p-T)}),c.isDead=!1,c.updateVisual(),c}function Hy(e,t,o,n){const s=e.add([e.rect(40,40),e.pos(t,o),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return s.direction=n,s.open=!1,s.isSpawnDoor=!1,s.blocked=!1,s.gridDirection=null,s.parts=[],s.updateVisual=()=>{s.parts.forEach(r=>{r.exists()&&e.destroy(r)}),s.parts=[];let a;if(s.blocked?a=e.rgb(80,80,80):s.open?a=e.rgb(100,255,100):s.isSpawnDoor?a=e.rgb(200,50,50):a=e.rgb(200,200,100),n==="north"||n==="south"){const r=s.blocked?"":s.open?"":"",l=e.add([e.text(r,{size:24}),e.pos(t,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(l);const c=e.add([e.text(s.open?"":"",{size:20}),e.pos(t-35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(c);const d=e.add([e.text(s.open?"":"",{size:20}),e.pos(t+35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(d)}else{const r=s.blocked?["","",""]:s.open?["","",""]:["","",""],l=16;for(let i=0;i<r.length;i++){const h=(i-1)*l,u=e.add([e.text(r[i],{size:24}),e.pos(t,o+h),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(u)}const c=e.add([e.text(s.open?"":"",{size:20}),e.pos(t,o-l*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(c);const d=e.add([e.text(s.open?"":"",{size:20}),e.pos(t,o+l*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(d)}if(s.blocked){const r=e.add([e.text("X",{size:28}),e.pos(t,o),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);s.parts.push(r)}},Object.defineProperty(s,"color",{get:()=>s._color,set:a=>{s._color=a,s.parts.forEach(r=>{r.exists()&&(r.color=a)})}}),Object.defineProperty(s,"text",{get:()=>s._text||"=",set:a=>{s._text=a}}),s.onDestroy(()=>{s.parts.forEach(a=>{a.exists()&&e.destroy(a)}),s.parts=[]}),s.updateVisual(),s}function ll(e,t,o,n,s,a="wall",r="#",l=null){const c=a==="wall",d=c?e.rgb(100,100,100):e.rgb(140,140,140),i=c?e.rgb(80,80,80):e.rgb(120,120,120),h=e.add([e.rect(n,s),e.pos(t,o),e.anchor("center"),e.color(l||d),e.outline(2,l||i),e.area({width:n,height:s}),e.fixed(),"obstacle",a==="wall"?"wall":"cover"]);return h.type=a,h.width=n,h.height=s,h}const Uy={CHAR:"",SIZE:20,COLOR:[180,80,40],DAMAGED_COLOR:[220,100,30],CRITICAL_COLOR:[255,60,20],MAX_HEALTH:3,EXPLOSION_RADIUS:80,EXPLOSION_DAMAGE:25,CHAIN_DELAY:.15,KNOCKBACK_FORCE:200,SHAKE_INTENSITY:.5,EXPLOSION_DURATION:.3};let Fn=[];function Ny(e,t,o,n={}){const s={...Uy,...n},a=e.add([e.text(s.CHAR,{size:s.SIZE}),e.pos(t,o),e.anchor("center"),e.area({width:s.SIZE,height:s.SIZE}),e.color(...s.COLOR),e.z(50),e.opacity(1),"barrel","obstacle",{maxHealth:s.MAX_HEALTH,currentHealth:s.MAX_HEALTH,explosionRadius:s.EXPLOSION_RADIUS,explosionDamage:s.EXPLOSION_DAMAGE,chainDelay:s.CHAIN_DELAY,knockbackForce:s.KNOCKBACK_FORCE,isExploding:!1,barrelId:Math.random().toString(36).substr(2,9)}]),r=e.add([e.rect(24,4),e.pos(t,o-18),e.anchor("center"),e.color(40,40,40),e.z(51),"barrelHealthBar"]),l=e.add([e.rect(22,2),e.pos(t-11,o-18),e.anchor("left"),e.color(255,100,50),e.z(52),"barrelHealthBar"]);return a.healthBarBg=r,a.healthBarFill=l,a.updateHealthBar=()=>{if(!a.exists())return;const c=a.currentHealth/a.maxHealth;r.exists()&&(r.pos.x=a.pos.x,r.pos.y=a.pos.y-18),l.exists()&&(l.pos.x=a.pos.x-11,l.pos.y=a.pos.y-18,l.width=22*c,c<=.33?l.color=e.rgb(255,50,50):c<=.66&&(l.color=e.rgb(255,150,50))),c<=.33?(a.color=e.rgb(...s.CRITICAL_COLOR),a.pos.x+=(Math.random()-.5)*2,a.pos.y+=(Math.random()-.5)*2):c<=.66&&(a.color=e.rgb(...s.DAMAGED_COLOR))},a.takeDamage=(c=1,d=null,i=!1)=>{a.isExploding||!a.exists()||(a.currentHealth-=c,a.updateHealthBar(),!i&&de()&&me()&&Ke("barrel_damage",{x:a.pos.x,y:a.pos.y,damage:c,currentHealth:a.currentHealth}),a.color,a.color=e.rgb(255,255,255),e.wait(.05,()=>{a.exists()&&a.updateHealthBar()}),a.currentHealth<=0&&a.explode(d))},a.explode=(c=null)=>{if(a.isExploding||!a.exists())return;a.isExploding=!0;const d=a.pos.x,i=a.pos.y;de()&&me()&&Ke("barrel_explode",{barrelId:a.barrelId,x:d,y:i,radius:a.explosionRadius,damage:a.explosionDamage}),_y(e,d,i,a.explosionRadius),Xy(e,d,i,a.explosionRadius,a.explosionDamage,a.knockbackForce),e.wait(a.chainDelay,()=>{Fy(e,d,i,a.explosionRadius,a.barrelId)}),r.exists()&&e.destroy(r),l.exists()&&e.destroy(l),Fn=Fn.filter(h=>h!==a),e.destroy(a)},Fn.push(a),a}function _y(e,t,o,n){const s=e.add([e.circle(n),e.pos(t,o),e.anchor("center"),e.color(255,150,50),e.opacity(.8),e.scale(1),e.z(100),"explosionEffect"]),a=e.add([e.circle(n*.6),e.pos(t,o),e.anchor("center"),e.color(255,255,150),e.opacity(.9),e.scale(1),e.z(101),"explosionEffect"]),r=e.add([e.text("*",{size:40}),e.pos(t,o),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.scale(1),e.z(102),"explosionEffect"]);e.tween(s.scale,e.vec2(1.5,1.5),.2,l=>s.scale=l),e.tween(s.opacity,0,.3,l=>s.opacity=l,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)}),e.tween(a.scale,e.vec2(1.3,1.3),.15,l=>a.scale=l),e.tween(a.opacity,0,.25,l=>a.opacity=l,e.easings.easeOutQuad).onEnd(()=>{a.exists()&&e.destroy(a)}),e.tween(r.scale,e.vec2(2,2),.1,l=>r.scale=l),e.tween(r.opacity,0,.2,l=>r.opacity=l).onEnd(()=>{r.exists()&&e.destroy(r)});for(let l=0;l<8;l++){const c=Math.PI*2*l/8,d=100+Math.random()*100,i=e.add([e.text(["#","*","+","~"][Math.floor(Math.random()*4)],{size:12}),e.pos(t,o),e.anchor("center"),e.color(255,150+Math.random()*100,50),e.opacity(1),e.z(99),"explosionDebris"]),h=t+Math.cos(c)*d,u=o+Math.sin(c)*d;e.tween(i.pos,e.vec2(h,u),.4,g=>i.pos=g,e.easings.easeOutQuad),e.tween(i.opacity,0,.4,g=>i.opacity=g).onEnd(()=>{i.exists()&&e.destroy(i)})}}function Xy(e,t,o,n,s,a,r){e.get("enemy").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);if(l.takeDamage?l.takeDamage(i):l.hp&&l.hurt(i),c>0){const h=e.vec2(l.pos.x-t,l.pos.y-o).unit(),u=a*d;l.pos.x+=h.x*u*.1,l.pos.y+=h.y*u*.1}}}),e.get("miniboss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);l.takeDamage&&l.takeDamage(i,null)}}),e.get("boss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);l.takeDamage&&l.takeDamage(i,null)}}),e.get("player").forEach(l=>{if(!l.exists()||l.isDead)return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d*.5);if(!l.invulnerable&&(l.hurt(i),c>0)){const h=e.vec2(l.pos.x-t,l.pos.y-o).unit(),u=a*d;l.pos.x+=h.x*u*.05,l.pos.y+=h.y*u*.05}}})}function Fy(e,t,o,n,s){const a=n*1.2;Fn.forEach(r=>{if(!r.exists()||r.isExploding||r.barrelId===s)return;e.vec2(r.pos.x-t,r.pos.y-o).len()<=a&&r.takeDamage(r.maxHealth,s)})}function dl(e,t,o=5){return Fn.find(n=>{if(!n.exists()||n.isExploding)return!1;const s=Math.abs(n.pos.x-e),a=Math.abs(n.pos.y-t);return s<=o&&a<=o})||null}function Yy(){Fn.forEach(e=>{e.exists()&&(e.healthBarBg&&e.healthBarBg.exists()&&e.healthBarBg.destroy(),e.healthBarFill&&e.healthBarFill.exists()&&e.healthBarFill.destroy(),e.destroy())}),Fn=[]}class Ca{constructor(t=128){this.cellSize=t,this.cells=new Map,this.entityToCell=new Map}getCellKey(t,o){const n=Math.floor(t/this.cellSize),s=Math.floor(o/this.cellSize);return`${n},${s}`}insert(t){if(!t||!t.pos)return;const o=this.getCellKey(t.pos.x,t.pos.y);this.cells.has(o)||this.cells.set(o,new Set),this.cells.get(o).add(t),this.entityToCell.set(t,o)}remove(t){if(!t)return;const o=this.entityToCell.get(t);if(!o)return;const n=this.cells.get(o);n&&(n.delete(t),n.size===0&&this.cells.delete(o)),this.entityToCell.delete(t)}update(t){if(!t||!t.pos)return;const o=this.entityToCell.get(t),n=this.getCellKey(t.pos.x,t.pos.y);o!==n&&(this.remove(t),this.insert(t))}getNearby(t,o,n){const s=[],a=Math.ceil(n/this.cellSize),r=this.getCellKey(t,o),[l,c]=r.split(",").map(Number);for(let d=-a;d<=a;d++)for(let i=-a;i<=a;i++){const h=`${l+d},${c+i}`,u=this.cells.get(h);u&&s.push(...u)}return s}getInBounds(t,o,n,s){const a=[],r=Math.floor(t/this.cellSize),l=Math.floor(o/this.cellSize),c=Math.floor(n/this.cellSize),d=Math.floor(s/this.cellSize);for(let i=r;i<=c;i++)for(let h=l;h<=d;h++){const u=`${i},${h}`,g=this.cells.get(u);g&&a.push(...g)}return a}getAt(t,o){const n=this.getCellKey(t,o),s=this.cells.get(n);return s?[...s]:[]}clear(){this.cells.clear(),this.entityToCell.clear()}getStats(){let t=0,o=0,n=1/0;return this.cells.forEach(s=>{const a=s.size;t+=a,o=Math.max(o,a),n=Math.min(n,a)}),{cellCount:this.cells.size,totalEntities:t,averageEntitiesPerCell:this.cells.size>0?(t/this.cells.size).toFixed(2):0,maxEntitiesInCell:o,minEntitiesInCell:n===1/0?0:n,cellSize:this.cellSize}}}let Fo=null,ys=1,Zi=1,jr=1,wh=!0,Zr=!0,mo=null,dr=null;const qy={menu:"./audio/menu-theme.mp3",combat:"./audio/combat-theme.mp3",defeat:"./audio/defeat-theme.mp3"},Ra={};function bh(){return Fo||(Fo=new(window.AudioContext||window.webkitAudioContext)),Fo}function Gy(){Fo&&Fo.state==="suspended"&&Fo.resume().then(()=>{console.log("[Audio] AudioContext resumed")}).catch(e=>{console.warn("[Audio] Failed to resume AudioContext:",e)})}function Qr(){return Fo||bh(),Fo&&Fo.state==="suspended"&&Fo.resume(),Fo}function vh(e){ys=Math.max(0,Math.min(1,e)),mo&&(mo.volume=Zi*ys)}function Eh(e){jr=Math.max(0,Math.min(1,e))}function Ah(e){wh=e}function Sh(e){Zr=e}function Ve(e,t,o="square",n=.3,s={}){if(s.isUI&&!wh||s.isCombat&&!Zr)return;const a=Qr(),r=a.currentTime,l=a.createOscillator();l.type=o,l.frequency.setValueAtTime(e,r),s.pitchBend&&l.frequency.exponentialRampToValueAtTime(e*s.pitchBend,r+t);const c=a.createGain(),d=n*jr*ys,i=s.attack||.01;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(d,r+i);const h=s.decay||.1;c.gain.setValueAtTime(d,r+t-h),c.gain.exponentialRampToValueAtTime(.01,r+t),l.connect(c),c.connect(a.destination),l.start(r),l.stop(r+t)}function Es(e,t=.3,o={}){if(o.isCombat&&!Zr)return;const n=Qr(),s=n.currentTime,a=n.sampleRate*e,r=n.createBuffer(1,a,n.sampleRate),l=r.getChannelData(0);for(let p=0;p<a;p++)l[p]=Math.random()*2-1;const c=n.createBufferSource();c.buffer=r;const d=n.createBiquadFilter();d.type=o.filterType||"lowpass",d.frequency.setValueAtTime(o.filterFreq||2e3,s);const i=n.createGain(),h=t*jr*ys,u=o.attack||.01,g=o.decay||.1;i.gain.setValueAtTime(0,s),i.gain.linearRampToValueAtTime(h,s+u),i.gain.setValueAtTime(h,s+e-g),i.gain.exponentialRampToValueAtTime(.01,s+e),c.connect(d),d.connect(i),i.connect(n.destination),c.start(s),c.stop(s+e)}function Ue(e,t=.1){return e*(1+(Math.random()-.5)*t)}function Mh(){const e=Math.random();e<.33?Ve(Ue(280,.15),.08,"triangle",.14,{attack:.002,decay:.05,pitchBend:.65}):e<.66?Ve(Ue(320,.15),.09,"sine",.13,{attack:.003,decay:.06,pitchBend:.7}):Ve(Ue(300,.15),.07,"triangle",.14,{attack:.002,decay:.04,pitchBend:.6})}function Ky(){const e=Math.random();e<.33?Ve(Ue(220,.3),.04,"triangle",.08,{attack:.001,decay:.025,pitchBend:.5}):e<.66?Ve(Ue(240,.3),.035,"sine",.09,{attack:.001,decay:.02,pitchBend:.6}):Ve(Ue(200,.3),.045,"triangle",.08,{attack:.001,decay:.03,pitchBend:.4})}function Vy(){const e=Ue(60,.15);Ve(e,.1,"sine",.12,{attack:.002,decay:.08,pitchBend:.4}),Es(Ue(.04,.2),Ue(.12,.2),{attack:.002,decay:.06,filterType:"lowpass",filterFreq:Ue(800,.3)})}function Wy(){Ve(Ue(350,.2),.05,"triangle",.12,{attack:.001,decay:.03,pitchBend:.3}),Ve(Ue(50,.15),.1,"sine",.1,{attack:.001,decay:.07,pitchBend:.5})}function $y(){Es(.08,Ue(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:Ue(800,.5)})}function Jy(){Ve(Ue(55,.2),.15,"sine",.1,{attack:.002,decay:.12,pitchBend:.4}),Ve(Ue(100,.2),.12,"triangle",.08,{attack:.005,decay:.08,pitchBend:.5})}function jy(){Ve(Ue(250,.3),.08,"triangle",.1,{attack:.001,decay:.06,pitchBend:1.6}),Es(Ue(.03,.3),.08,{attack:.001,decay:.04,filterType:"bandpass",filterFreq:Ue(2e3,.4)})}function Zy(){Ve(Ue(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function Qy(){Mh()}function hl(){const e=Math.random();e<.25?Ve(Ue(280,.2),.06,"sine",.12,{attack:.002,decay:.04,pitchBend:.2}):e<.5?Ve(Ue(320,.2),.05,"triangle",.12,{attack:.002,decay:.035,pitchBend:.15}):e<.75?Ve(Ue(240,.2),.07,"sine",.14,{attack:.003,decay:.05,pitchBend:.25}):Ve(Ue(360,.2),.05,"triangle",.1,{attack:.002,decay:.03,pitchBend:.1})}function vn(){const e=Math.random();e<.33?(Ve(Ue(180,.2),.1,"triangle",.18,{attack:.003,decay:.07,pitchBend:.2}),Ve(Ue(400,.2),.06,"sine",.1,{attack:.005,decay:.04,pitchBend:.1})):e<.66?(Ve(Ue(160,.2),.12,"triangle",.18,{attack:.003,decay:.08,pitchBend:.25}),Ve(Ue(320,.2),.07,"sine",.12,{attack:.005,decay:.05,pitchBend:.15})):(Ve(Ue(200,.2),.11,"triangle",.18,{attack:.003,decay:.08,pitchBend:.3}),Ve(Ue(440,.2),.05,"sine",.08,{attack:.005,decay:.03,pitchBend:.1}))}function ul(){const e=Math.random();e<.33?Ve(Ue(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(Ve(Ue(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),Es(.15,.12,{attack:.05,decay:.1,filterFreq:Ue(1500,.4)})):Ve(Ue(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function Th(){Ve(Ue(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),Ve(Ue(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),Es(Ue(.3,.2),Ue(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:Ue(1200,.5)})}function ky(){const e=Math.random();e<.33?Ve(Ue(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?Ve(Ue(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):Ve(Ue(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function fl(){const e=Math.random();e<.33?(Ve(Ue(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{Ve(Ue(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(Ve(Ue(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),Ve(Ue(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(Ve(Ue(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{Ve(Ue(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function ex(){Qr().currentTime;const t=400;[1,1.25,1.5,2].forEach((n,s)=>{setTimeout(()=>{Ve(t*n,.15,"square",.2,{attack:.01,decay:.1})},s*80)})}function Ia(){Ve(Ue(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Ut(){Ve(Ue(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function ke(){Ve(Ue(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function tx(){Ve(Ue(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{Ve(Ue(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function pl(){Ve(Ue(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{Ve(Ue(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function ox(){for(let t=0;t<8;t++)setTimeout(()=>{Ve(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{Th()},480)}function nx(){[400,500,600,800].forEach((t,o)=>{setTimeout(()=>{Ve(t,.2,"square",.18,{attack:.01,decay:.15})},o*100)})}function vi(){Ve(Ue(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{Ve(Ue(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function Pa(){Ve(Ue(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),Es(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:Ue(500,.3)})}function sx(){Ve(Ue(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function gl(){Ve(Ue(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function ix(e){const t=e?.toLowerCase()||"";t.includes("pistol")?Mh():t.includes("smg")||t.includes("submachine")?Ky():t.includes("shotgun")?Vy():t.includes("sniper")||t.includes("rifle")?Wy():t.includes("flame")||t.includes("thrower")?$y():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?Jy():t.includes("chain")||t.includes("lightning")?jy():t.includes("orbital")?Zy():Qy()}function Dh(e){Zi=Math.max(0,Math.min(1,e)),mo&&(mo.volume=Zi*ys)}function Ch(){mo&&(mo.pause(),mo.currentTime=0,mo=null,dr=null)}function kr(e,t=!0){if(dr===e&&mo&&!mo.paused)return;Ch();const o=qy[e];if(!o){console.warn(`[Music] Unknown track: ${e}`);return}try{Ra[e]||(Ra[e]=new Audio(o)),mo=Ra[e],mo.loop=t,mo.volume=Zi*ys,dr=e;const n=mo.play();n!==void 0&&n.catch(s=>{console.warn(`[Music] Playback failed for ${e}:`,s.message)})}catch(n){console.warn(`[Music] Failed to play ${e}:`,n.message)}}function ml(){kr("menu")}function ax(){kr("combat")}function rx(){kr("defeat")}function Go(e,t,o,n={}){const s=yh();if(s)return s.acquire(t,o,n);const{char:a="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:i=1,fadeStart:h=.3,friction:u=.95,zIndex:g=100}=n,p=e.add([e.text(a,{size:r}),e.pos(t,o),e.anchor("center"),e.color(...l),e.z(g),"particle"]);return p.velocity={x:c.x,y:c.y},p.gravity=d,p.friction=u,p.lifetime=i,p.fadeStart=h,p.age=0,p.initialOpacity=1,p}function cx(e,t){const o=yh();o&&t._pooled?o.release(t):e.destroy(t)}function lx(e){e.get("particle").forEach(o=>{if(!o.exists()||o.hidden)return;if(o.age+=e.dt(),o.age>=o.lifetime){cx(e,o);return}o.pos.x+=o.velocity.x*e.dt()*60,o.pos.y+=o.velocity.y*e.dt()*60,o.velocity.y+=o.gravity*e.dt()*60,o.velocity.x*=o.friction,o.velocity.y*=o.friction;const n=o.age/o.lifetime;if(n>=o.fadeStart){const s=(n-o.fadeStart)/(1-o.fadeStart);o.opacity=o.initialOpacity*(1-s)}})}function go(e,t,o,n={}){const{count:s=8,color:a=[255,50,50],speed:r=2,isCrit:l=!1}=n,c=[".",",","'","`","*"],d=l?s*1.5:s,i=l?r*1.5:r,h=l?[255,200,0]:a;for(let u=0;u<d;u++){const g=Math.PI*2*u/d+(Math.random()-.5)*.5,p=.5+Math.random()*.5,T={x:Math.cos(g)*i*p,y:Math.sin(g)*i*p};Go(e,t,o,{char:c[Math.floor(Math.random()*c.length)],size:8+Math.random()*6,color:h,velocity:T,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function Ys(e,t,o,n={}){const{count:s=8,color:a=[255,100,100],speed:r=2.5,isBoss:l=!1,isMiniboss:c=!1}=n,d=["*","+",""],i=l?s*2:c?s*1.5:s,h=l?r*1.5:c?r*1.2:r;for(let u=0;u<i;u++){const g=Math.PI*2*u/i+(Math.random()-.5)*.3,p=.6+Math.random()*.4,T={x:Math.cos(g)*h*p,y:Math.sin(g)*h*p};Go(e,t,o,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*6,color:a,velocity:T,gravity:.1,lifetime:.5+Math.random()*.3,fadeStart:.2,friction:.92})}}function Ps(e,t,o,n,s={}){const{count:a=5,color:r=[255,255,100],speed:l=2.5,isCrit:c=!1}=s,d=["","","",""],i=c?a*2:a,h=c?[255,200,0]:r,u=Math.sqrt(n.x*n.x+n.y*n.y),g=u>0?{x:n.x/u,y:n.y/u}:{x:1,y:0};for(let p=0;p<i;p++){const T=(Math.random()-.5)*Math.PI*.6,m=Math.atan2(g.y,g.x)+T,M=.6+Math.random()*.8,P={x:Math.cos(m)*l*M,y:Math.sin(m)*l*M};Go(e,t,o,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*4,color:h,velocity:P,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function dx(e,t,o,n,s){const r={trailFire:["","","",""],trailIce:["*","","",""],trailPoison:["~","","",""],trailShadow:["","","",""],trailRainbow:["","","",""]}[n]||["","","*"],l=r[Math.floor(Math.random()*r.length)];let c=s;if(s==="rainbow"){const h=Date.now()*.1%360;c=hx(h,100,60)}const d=(Math.random()-.5)*8,i=(Math.random()-.5)*8;Go(e,t+d,o+i,{char:l,size:10+Math.random()*6,color:c,velocity:{x:(Math.random()-.5)*.3,y:(Math.random()-.5)*.3},gravity:n==="trailFire"?-.02:.01,lifetime:.4+Math.random()*.2,fadeStart:.2,friction:.98,zIndex:-10})}function hx(e,t,o){t/=100,o/=100;const n=t*Math.min(o,1-o),s=a=>{const r=(a+e/30)%12;return o-n*Math.max(Math.min(r-3,9-r,1),-1)};return[Math.round(s(0)*255),Math.round(s(8)*255),Math.round(s(4)*255)]}function yl(e,t,o,n){const s=e.add([e.text("",{size:48}),e.pos(t.pos.x,t.pos.y),e.anchor("center"),e.color(...n),e.opacity(.3),e.z(-5),"playerGlow"]);return s.target=t,s.glowType=o,s.pulseTime=0,s.baseOpacity=.25,s}function ux(e,t){if(!t||!t.exists()||!t.target||!t.target.exists()){t&&t.exists()&&e.destroy(t);return}t.pos=t.target.pos.clone(),t.pulseTime+=e.dt()*3;const o=Math.sin(t.pulseTime)*.1;t.opacity=t.baseOpacity+o,t.glowType==="glowElectric"&&Math.random()<.05&&(t.opacity=t.baseOpacity+.3)}function fx(e,t,o,n,s=[255,100,100]){switch(n){case"deathExplosion":px(e,t,o,s);break;case"deathDisintegrate":gx(e,t,o,s);break;case"deathVaporize":mx(e,t,o,s);break;case"deathPixelate":yx(e,t,o,s);break;case"deathFireworks":xx(e,t,o,s);break;default:Ys(e,t,o,{color:s})}}function px(e,t,o,n){const s=["*","#","@","X","+",""],r=e.add([e.text("",{size:40}),e.pos(t,o),e.anchor("center"),e.color(255,255,200),e.opacity(1),e.z(200),"particle"]);r.age=0,r.lifetime=.2,r.fadeStart=0,r.velocity={x:0,y:0},r.gravity=0,r.friction=1;for(let l=0;l<20;l++){const c=Math.PI*2*l/20,d=4+Math.random()*2;Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:14+Math.random()*10,color:[255,200,100],velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.92})}for(let l=0;l<20/2;l++){const c=Math.random()*Math.PI*2,d=2+Math.random()*2;Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:10+Math.random()*6,color:n,velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}}function gx(e,t,o,n){const s=["","","","","",""];for(let r=0;r<25;r++){const l=(Math.random()-.5)*20,c=(Math.random()-.5)*20,d=Math.random()*Math.PI*2,i=.5+Math.random()*1.5;Go(e,t+l,o+c,{char:s[Math.floor(Math.random()*s.length)],size:8+Math.random()*8,color:[n[0]*(.6+Math.random()*.4),n[1]*(.6+Math.random()*.4),n[2]*(.6+Math.random()*.4)],velocity:{x:Math.cos(d)*i,y:Math.sin(d)*i},gravity:.2,lifetime:1+Math.random()*.5,fadeStart:.5,friction:.96})}}function mx(e,t,o,n){const s=["~","","","",""];for(let r=0;r<20;r++){const l=(Math.random()-.5)*15,c=Math.random()*Math.PI*2,d=.3+Math.random()*.5;Go(e,t+l,o,{char:s[Math.floor(Math.random()*s.length)],size:10+Math.random()*10,color:[Math.min(255,n[0]+100),Math.min(255,n[1]+100),Math.min(255,n[2]+100)],velocity:{x:Math.cos(c)*d,y:-1.5-Math.random()*1.5},gravity:-.05,lifetime:1.2+Math.random()*.5,fadeStart:.3,friction:.98})}}function yx(e,t,o,n){const s=["","","","","",""];for(let l=-5/2;l<=5/2;l++)for(let c=-5/2;c<=5/2;c++){const d=l*6,i=c*6,h=Math.sqrt(l*l+c*c),u=Math.atan2(c,l),g=1+h*.3+Math.random()*.5;Go(e,t+d,o+i,{char:s[Math.floor(Math.random()*s.length)],size:8+Math.random()*4,color:n,velocity:{x:Math.cos(u)*g,y:Math.sin(u)*g},gravity:.08,lifetime:.6+Math.random()*.4,fadeStart:.4,friction:.94})}}function xx(e,t,o,n){const s=["*","+","x","X","#"];for(let c=0;c<12;c++){const d=Math.PI*2*c/12,i=.7+Math.random()*.6,h={x:Math.cos(d)*3*i,y:Math.sin(d)*3*i};Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:12+Math.random()*8,color:n,velocity:h,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const l=Math.floor(12/2);for(let c=0;c<l;c++){const d=Math.random()*Math.PI*2,i=.3+Math.random()*.4,h={x:Math.cos(d)*3*i*.5,y:Math.sin(d)*3*i*.5};Go(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:16+Math.random()*8,color:[255,200,100],velocity:h,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}const Rh="superSmashTexty_settings",si={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:.35,uiSounds:!0,combatSounds:!0},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showHitFreeze:!0,showDamageNumbers:!0,compactHUD:!1,showFPS:!1,showTimer:!0},gameplay:{autoPause:!1,autoPickupCurrency:!1,autoPickupXP:!1,confirmBeforeQuit:!0,skipIntroAnimation:!1},accessibility:{colorblindMode:"off",reducedMotion:!1,largeText:!1,highContrast:!1}};function ec(){try{const e=localStorage.getItem(Rh);if(e){const t=JSON.parse(e);return Ih(si,t)}}catch(e){console.error("Error loading settings:",e)}return{...si}}function Ih(e,t){const o={...e};return Ba(e)&&Ba(t)&&Object.keys(t).forEach(n=>{Ba(t[n])?n in e?o[n]=Ih(e[n],t[n]):Object.assign(o,{[n]:t[n]}):Object.assign(o,{[n]:t[n]})}),o}function Ba(e){return e&&typeof e=="object"&&!Array.isArray(e)}function Ph(e){try{return localStorage.setItem(Rh,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function hr(){return ec()}function Gt(e,t,o){const n=ec();return n[e]||(n[e]={}),n[e][t]=o,Ph(n),n}function Bh(e,t){return ec()[e]?.[t]??si[e]?.[t]}function wx(){return Ph({...si}),{...si}}let Ao=null,Qo=null,ko=0,Tn=0,$s=!1,ur=0;const bx=.05;let fr=0;const vx=100;function Ex(e){Ao=e}function En(e=5,t=.1){if(!Ao||!Bh("visual","showScreenShake"))return;const o=Ao.time();if(o-ur<bx){ko>0&&(Tn=Math.max(Tn,e),ko=Math.max(ko,t));return}ur=o,ko<=0&&(Qo=Ao.camPos()),Tn=Math.max(Tn,e),ko=Math.max(ko,t)}function Ax(e){if(!(!Ao||ko<=0))if(ko-=e,ko>0){const t=(Math.random()-.5)*2*Tn,o=(Math.random()-.5)*2*Tn;Qo&&Ao.camPos(Qo.x+t,Qo.y+o)}else Qo&&Ao.camPos(Qo),Tn=0,Qo=null}function Bs(e=50){if(!Ao||!Bh("visual","showHitFreeze")||Ao.paused||$s)return;const t=Date.now();t-fr<vx||(fr=t,Ao.paused=!0,$s=!0,setTimeout(()=>{Ao.paused=!1,$s=!1},e))}function Sx(){return $s}const hn={playerHit:()=>{En(6,.1),Bs(30)},criticalHit:()=>{En(4,.08),Bs(40)},bossHit:()=>{En(3,.05)},bossDeath:()=>{En(15,.3),Bs(100)},explosion:()=>{En(10,.2),Bs(60)},playerDeath:()=>{En(12,.25),Bs(150)},levelUp:()=>{En(5,.15)},smallImpact:()=>{En(2,.05)}};function Mx(){ko=0,Tn=0,Ao&&Qo&&Ao.camPos(Qo),Qo=null,ur=0,fr=0,$s=!1}function Ls(e,t,o,n){if(!t||!t.exists())return;const s=20,a=e.width()-s,r=e.height()-s,l=s,c=s,d=t.pos.x+o.x*n,i=t.pos.y+o.y*n,h=Math.max(l,Math.min(a,d)),u=Math.max(c,Math.min(r,i)),g=t.pos.x,p=t.pos.y;t.pos.x=h,t.pos.y=u;const T=e.get("wall"),m=e.get("obstacle"),M=[...T,...m];let P=!1;for(const f of M)if(f.exists()&&t.isColliding&&t.isColliding(f)){P=!0;break}P&&(t.pos.x=g,t.pos.y=p)}function xl(e,t){let o=0;t.weaponKey==="orbital"&&pr(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.isRemote)t.aimAngle!==void 0&&(t.angle=t.aimAngle,t.outline&&t.outline.exists()&&(t.outline.angle=t.aimAngle));else{const i=qc();let h,u;if(i.active&&(i.x!==0||i.y!==0))h=e.vec2(i.x,i.y),u=1;else{const g=e.mousePos();h=e.vec2(g.x-t.pos.x,g.y-t.pos.y),u=h.len()}if(u>0){const g=Math.atan2(h.y,h.x)*(180/Math.PI);t.angle=g,t.outline&&t.outline.exists()&&(t.outline.angle=g)}}if(t.canShoot===!1){t.isShooting=!1;return}const n=e.get("enemy"),s=e.get("boss"),a=e.get("miniboss");if(!(n.length>0||s.length>0||a.length>0)&&t.weaponKey!=="orbital"){t.isShooting=!1;return}if(t.weaponKey==="orbital"){Tx(e,t),t.isShooting=!1;return}const l=e.time();let c,d=!1;if(t.isRemote){if(de()&&!me()){t.isShooting=!1;return}if(t.aimAngle!==void 0&&t.isShooting){const i=t.aimAngle*(Math.PI/180);c=e.vec2(Math.cos(i),Math.sin(i)),d=!0}else{t.isShooting=!1;return}}else{const i=qc();let h,u;if(i.active&&(i.x!==0||i.y!==0))h=e.vec2(i.x,i.y),u=1;else{const g=e.mousePos();h=e.vec2(g.x-t.pos.x,g.y-t.pos.y),u=h.len()}if(u>0){if(t.aimAngle=Math.atan2(h.y,h.x)*(180/Math.PI),c=h.unit(),de()&&!me()){t.isShooting=u>0&&t.canShoot;return}d=!0}else{t.aimAngle=0,t.isShooting=!1;return}t.isShooting=u>0&&t.canShoot}if(d&&c){let i=t.fireRate;if(t.bulletTimeEnabled&&t.bulletTimeBonus&&t.move&&(t.move.x!==0||t.move.y!==0)&&(i=t.fireRate*(1+t.bulletTimeBonus)),t.speedDemonEnabled&&t.speedDemonFireRatePerStack){const h=t.upgradeStacks?.speed||0;h>0&&(i=i*(1+h*t.speedDemonFireRatePerStack))}if(l-o>=1/i){const h=t.projectileCount||1,u=t.spreadAngle||0,g=[];if(h===1)g.push(c);else if(u>0){const p=h>1?u/(h-1):0,T=-u/2;for(let m=0;m<h;m++){const P=(T+p*m)*(Math.PI/180),f=Math.cos(P),_=Math.sin(P),B=e.vec2(c.x*f-c.y*_,c.x*_+c.y*f);g.push(B.unit())}}else for(let p=0;p<h;p++)g.push(c);g.forEach((p,T)=>{const m=u===0&&h>1?T*ro.MULTISHOT_STAGGER_DELAY:0;e.wait(m,()=>{const M=kg(t.critChance||0);let P=M?em(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(P=Math.floor(P*t.piercingDamageBonus));let f=t.weaponRange||us.DEFAULT_WEAPON_RANGE;if(M&&t.deadeyeEnabled&&t.deadeyeRangeBonus&&(f=f*(1+t.deadeyeRangeBonus)),ix(t.weaponKey),t.weaponKey==="flamethrower"){const _=To(e,t.pos.x,t.pos.y,p,t.projectileSpeed,P,t.piercing||0,t.obstaclePiercing||0,M,f);t.weaponDef&&_.useWeaponVisual(t.weaponDef),_.ownerSlotIndex=t.slotIndex;const B=Math.floor(P*.3),b=2,S=t.fireDotMultiplier||1;_.burnDamage=Math.floor(B*S),_.burnDuration=b,de()&&me()&&cs(_,{weaponKey:t.weaponKey,burnDamage:_.burnDamage,burnDuration:_.burnDuration})}else if(t.weaponKey==="explosive"){const _=Dx(e,t.pos.x,t.pos.y,p,t.projectileSpeed,P,t.explosionRadius,t.explosionDamage,f,M);t.weaponDef&&_.useWeaponVisual(t.weaponDef),_.ownerSlotIndex=t.slotIndex,de()&&me()&&cs(_,{weaponKey:t.weaponKey,explosionRadius:_.explosionRadius,explosionDamage:_.explosionDamage})}else if(t.weaponKey==="chainLightning"){const _=Cx(e,t.pos.x,t.pos.y,p,t.projectileSpeed,P,t.chainRange,t.maxJumps,t.chainDamageReduction,f,M);t.weaponDef&&_.useWeaponVisual(t.weaponDef),_.ownerSlotIndex=t.slotIndex,de()&&me()&&cs(_,{weaponKey:t.weaponKey,chainRange:_.chainRange,maxJumps:_.maxJumps,chainDamageReduction:_.chainDamageReduction})}else if(t.weaponKey==="boomerang"){const _=To(e,t.pos.x,t.pos.y,p,t.projectileSpeed,P,t.piercing||0,t.obstaclePiercing||0,M,f);_.isBoomerang=!0,_.ownerPlayer=t,_.returnSpeedMultiplier=t.weaponDef?.returnSpeedMultiplier||1.2,t.weaponDef&&_.useWeaponVisual(t.weaponDef),_.ownerSlotIndex=t.slotIndex,de()&&me()&&cs(_,{weaponKey:t.weaponKey})}else{const _=To(e,t.pos.x,t.pos.y,p,t.projectileSpeed,P,t.piercing||0,t.obstaclePiercing||0,M,f);t.weaponDef&&_.useWeaponVisual(t.weaponDef),_.ownerSlotIndex=t.slotIndex,de()&&me()&&cs(_,{weaponKey:t.weaponKey||"pistol"})}})}),o=l,Mm(t)}}}),e.onCollide("projectile","wall",(n,s)=>{if(!e.paused){if(n.isExplosive){La(e,n,n.pos.x,n.pos.y);return}n.piercedObstacles&&n.piercedObstacles.has(s)||(n.obstaclePiercing>0?(n.piercedObstacles&&n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)):e.destroy(n))}}),e.onCollide("projectile","cover",(n,s)=>{if(!e.paused&&n.obstaclePiercing>0&&n.piercedObstacles){if(n.piercedObstacles.has(s))return;n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)}}),e.onCollide("projectile","obstacle",(n,s)=>{e.paused||n.isExplosive||n.piercedObstacles&&n.piercedObstacles.has(s)||(n.obstaclePiercing>0?(n.piercedObstacles&&n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)):e.destroy(n))}),e.onCollide("projectile","barrel",(n,s)=>{e.paused||!s.exists()||s.isExploding||n.isEnemyProjectile||n.isBossProjectile||(s.takeDamage&&s.takeDamage(1),n.piercing>0||n.obstaclePiercing>0?n.piercedObstacles&&n.piercedObstacles.add(s):n.isExplosive||n.exists()&&e.destroy(n))}),e.onCollide("projectile","enemy",(n,s)=>{if(e.paused||n.isEnemyProjectile||n.isBossProjectile)return;const a=2,r=n.reflectionCount||0;if(s.reflectsProjectiles&&!n.isReflected&&r<a&&Math.random()<(s.reflectChance||.4)){n.isReflected=!0,n.reflectionCount=r+1,n.isEnemyProjectile=!0,n.direction=e.vec2(-n.direction.x,-n.direction.y),n.color=e.rgb(255,100,100),n.damage=Math.floor(n.damage*.7),e.add([e.text("*",{size:20}),e.pos(s.pos.x,s.pos.y),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.lifespan(.3),e.z(500)]);return}if(n.isExplosive){La(e,n,s.pos.x,s.pos.y);return}if(n.isChainLightning){if(n.chainedEnemies&&n.chainedEnemies.has(s))return;if(!de()||me()){const i=n.chainJumps||0,h=1-(n.chainDamageReduction||.15)*i,u=Math.floor(n.damage*Math.max(.1,h));s.takeDamage?s.takeDamage(u):s.hurt(u)}n.chainedEnemies&&n.chainedEnemies.add(s),n.chainJumps<n.maxJumps?wl(e,n,s):e.destroy(n);return}if(n.piercedEnemies&&n.piercedEnemies.has(s))return;if(de()&&!me()){hl(),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}hl();let l=n.damage;if(n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);h&&h.executionerEnabled&&h.executionerThreshold&&s.hp()/(s.maxHealth||s.hp())<h.executionerThreshold&&(l=Math.floor(l*(1+(h.executionerDamageBonus||1))))}if(s.takeDamage?s.takeDamage(l):s.hurt(l),n.isCrit&&n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);if(h&&h.vampiricCrits&&h.vampiricHealPercent){const u=Math.floor(l*h.vampiricHealPercent);if(u>0&&h.hp()<h.maxHealth){const g=Math.min(h.maxHealth,h.hp()+u);h.setHP(g)}}}if(n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);if(h&&h.lifestealPercent&&h.lifestealPercent>0){let u=h.lifestealPercent;n.isCrit&&h.vampireLordEnabled&&h.vampireLordMultiplier&&(u*=h.vampireLordMultiplier);const g=Math.floor(l*u);if(g>0&&h.hp()<h.maxHealth){const p=Math.min(h.maxHealth,h.hp()+g);h.setHP(p),de()&&me()&&mh({slotIndex:h.slotIndex,healAmount:g,newHP:p,source:"lifesteal"})}}}if(n.ownerSlotIndex!==void 0){s.lastHitBySlot=n.ownerSlotIndex;const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);h&&h.survivalistEnabled&&(h.survivalistLastCombatTime=e.time())}de()&&me()&&Qm({targetId:s.mpEntityId,targetType:"enemy",damage:l,isCrit:n.isCrit||!1,x:s.pos.x,y:s.pos.y}),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);const c=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);if(c.len()>0){const i=c.unit(),h=ro.KNOCKBACK_ENEMY_FROM_PROJECTILE;Ls(e,s,i,h)}Ps(e,s.pos.x,s.pos.y,c,{isCrit:n.isCrit}),n.isCrit&&hn.criticalHit(),s.color=n.isCrit?e.rgb(...ro.CRIT_COLOR):e.rgb(...ro.HIT_COLOR),e.wait(ro.HIT_FLASH_DURATION,()=>{s.exists()&&(s.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(n,s)=>{if(e.paused)return;if(n.isExplosive){La(e,n,s.pos.x,s.pos.y);return}if(n.isChainLightning){if(n.chainedEnemies&&n.chainedEnemies.has(s))return;if(!de()||me()){const r=n.chainJumps||0,l=1-(n.chainDamageReduction||.15)*r,c=Math.floor(n.damage*Math.max(.1,l));s.takeDamage?s.takeDamage(c):s.hurt(c)}n.chainedEnemies&&n.chainedEnemies.add(s),e.wait(.01,()=>{n.exists()&&(n.chainJumps<n.maxJumps?wl(e,n,s):e.destroy(n))});return}if(n.piercedEnemies&&n.piercedEnemies.has(s))return;if(de()&&!me()){go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const r=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Ps(e,s.pos.x,s.pos.y,r,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}s.takeDamage?s.takeDamage(n.damage):s.hurt(n.damage),n.ownerSlotIndex!==void 0&&(s.lastHitBySlot=n.ownerSlotIndex),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);const a=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);a.len()>0&&Ls(e,s,a.unit(),ro.KNOCKBACK_BOSS_FROM_PROJECTILE),Ps(e,s.pos.x,s.pos.y,a,{isCrit:n.isCrit}),n.isCrit?hn.criticalHit():hn.bossHit(),s.color=n.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{s.exists()&&s.updateVisual()})}),e.onCollide("projectile","miniboss",(n,s)=>{if(e.paused||n.isEnemyProjectile||n.isBossProjectile||n.piercedEnemies&&n.piercedEnemies.has(s))return;if(de()&&!me()){go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const l=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Ps(e,s.pos.x,s.pos.y,l,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}let a=n.damage;n.isCrit&&(a=Math.floor(a*1.5)),s.takeDamage?s.takeDamage(a):s.hurt(a),n.ownerSlotIndex!==void 0&&(s.lastHitBySlot=n.ownerSlotIndex),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),go(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const r=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Ps(e,s.pos.x,s.pos.y,r,{isCrit:n.isCrit}),n.isCrit&&hn.criticalHit(),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n),s.color=n.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{s.exists()&&s.updateVisual()})}),e.onCollide("enemy","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(de()&&!me()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(...ro.HIT_COLOR);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){de()&&me()&&Ta({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}vn(),hn.playerHit();const a=n.damage||ro.BASE_ENEMY_DAMAGE,r=Aa(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),n.lifesteal&&n.exists()){const d=n.hp(),i=n.maxHealth;if(d<i){const h=Math.min(i,d+n.lifesteal);n.setHP(h)}}if(n.isVampiric&&n.vampiricHealAmount&&n.exists()){const d=n.hp(),i=n.maxHealth;if(d<i){const h=Math.min(i,d+n.vampiricHealAmount);n.setHP(h)}}if(s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=ro.KNOCKBACK_ENEMY;Ls(e,n,d,i)}s.color=e.rgb(...ro.HIT_COLOR)}),e.onCollide("miniboss","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(de()&&!me()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){de()&&me()&&Ta({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}vn(),hn.playerHit();let a=ro.BASE_MINIBOSS_DAMAGE;(n.type==="brute"||n.type==="berserker"||n.type==="guardian")&&n.meleeDamage&&(a=n.meleeDamage);const r=Aa(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.takeDamage?n.takeDamage(d):n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.takeDamage?n.takeDamage(i):n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=ro.KNOCKBACK_MINIBOSS;Ls(e,n,d,i)}s.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(de()&&!me()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){de()&&me()&&Ta({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}vn(),hn.playerHit();let a=ro.BASE_BOSS_DAMAGE;if(n.type==="twinGuardianMelee"&&n.meleeDamage){const d=n.enraged?ro.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;a=n.meleeDamage*d}const r=Aa(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.takeDamage?n.takeDamage(d):n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.takeDamage?n.takeDamage(i):n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=ro.KNOCKBACK_BOSS;Ls(e,n,d,i)}s.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(n,s)=>{if(e.paused||!n.isBossProjectile&&!n.isEnemyProjectile||s.isDead||s.hp()<=0||s.invulnerable)return;if(de()&&!me()){vn(),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100),e.destroy(n);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){e.destroy(n);return}vn(),hn.playerHit();const a=n.damage*(1-(s.damageReduction||0)),r=Math.max(1,a-(s.defense||0));s.hurt(r),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),go(e,s.pos.x,s.pos.y,{color:[255,100,100]}),e.destroy(n),s.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(n,s)=>{if(!e.paused&&s.exists()&&!(n.contactCooldown>0)){if(de()&&!me()){n.contactCooldown=n.contactCooldownDuration||.2;return}s.hurt(n.damage),n.contactCooldown=n.contactCooldownDuration||.2}}),e.onCollide("orbital","boss",(n,s)=>{if(!e.paused&&s.exists()&&!(n.contactCooldown>0)){if(de()&&!me()){n.contactCooldown=n.contactCooldownDuration||.2;return}s.takeDamage?s.takeDamage(n.damage):s.hurt(n.damage),n.contactCooldown=n.contactCooldownDuration||.2}})}function pr(e,t){t.orbitalOrbs&&t.orbitalOrbs.length>0&&t.orbitalOrbs.forEach(s=>{s&&s.exists()&&e.destroy(s)}),t.orbitalOrbs=[],t.orbitalAngles=[];const o=t.projectileCount||1,n=t.orbitRadius||us.BASE_ORBIT_RADIUS;for(let s=0;s<o;s++){const a=360/o*s,r=a*Math.PI/180,l=t.pos.x+Math.cos(r)*n,c=t.pos.y+Math.sin(r)*n,d=e.add([e.text(t.weaponDef?.char||"",{size:16}),e.pos(l,c),e.anchor("center"),e.color(...t.weaponDef?.color||[100,200,255]),e.area(),"orbital","playerProjectile"]);d.damage=t.projectileDamage||12,d.contactCooldown=0,d.contactCooldownDuration=us.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(d),t.orbitalAngles.push(a)}}function Tx(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(a=>{a.exists()&&a.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],pr(e,t),t.orbitalNeedsReinit=!1);const o=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==o)&&pr(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const n=t.rotationSpeed||us.BASE_ROTATION_SPEED,s=t.orbitRadius||us.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((a,r)=>{if(!a.exists())return;t.orbitalAngles[r]=(t.orbitalAngles[r]+n*e.dt())%360;const l=t.orbitalAngles[r]*Math.PI/180;a.pos.x=t.pos.x+Math.cos(l)*s,a.pos.y=t.pos.y+Math.sin(l)*s,a.contactCooldown>0&&(a.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(a=>a.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function Dx(e,t,o,n,s,a,r,l,c,d=!1){const i=To(e,t,o,n,s,a,0,0,d,c);return i.isExplosive=!0,i.explosionRadius=r||50,i.explosionDamage=l||15,i}function Cx(e,t,o,n,s,a,r,l,c,d,i=!1){const h=To(e,t,o,n,s,a,0,0,i,d);return h.isChainLightning=!0,h.chainRange=r||70,h.maxJumps=l||3,h.chainDamageReduction=c||.15,h.chainJumps=0,h.chainedEnemies=new Set,h}function La(e,t,o,n){if(!t.exists())return;Th(),hn.explosion();const s=t.explosionRadius||50,a=t.explosionDamage||15;if(!de()||me()){const l=e.get("enemy"),c=e.get("boss"),d=[...l,...c];for(const i of d){if(!i.exists())continue;e.vec2(i.pos.x-o,i.pos.y-n).len()<=s&&(i.takeDamage?i.takeDamage(a):i.hurt(a))}}const r=e.add([e.text("*",{size:24}),e.pos(o,n),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{r.exists()&&e.destroy(r)}),e.destroy(t)}function wl(e,t,o){if(!t.exists())return;const n=t.chainRange||70,s=e.get("enemy"),a=e.get("boss"),r=[...s,...a];let l=null,c=n;for(const d of r){if(!d.exists()||d===o||t.chainedEnemies&&t.chainedEnemies.has(d))continue;const i=e.vec2(d.pos.x-o.pos.x,d.pos.y-o.pos.y).len();i<=n&&i<c&&(l=d,c=i)}if(l){t.chainJumps=(t.chainJumps||0)+1;const d=o.pos,i=l.pos,h=e.vec2(i.x-d.x,i.y-d.y).len(),u=Math.atan2(i.y-d.y,i.x-d.x),g=(d.x+i.x)/2,p=(d.y+i.y)/2,T=e.add([e.rect(h,2),e.pos(g,p),e.anchor("center"),e.rotate(u),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{T.exists()&&e.destroy(T)}),t.pos.x=l.pos.x,t.pos.y=l.pos.y}else e.destroy(t)}const Rx={movement:{id:"movement",message:"Use WASD to move",duration:3,trigger:"firstMove"},shooting:{id:"shooting",message:"Aim with mouse - autofire!",duration:3,trigger:"firstShoot"},levelUp:{id:"levelUp",message:"Choose upgrade with 1-3 or click",duration:4,trigger:"firstLevelUp"},synergy:{id:"synergy",message:"Combine upgrades for bonuses!",duration:4,trigger:"firstSynergy"},shop:{id:"shop",message:"Spend credits on permanent upgrades",duration:4,trigger:"firstShopVisit"}},Lh="superSmashTexty_tutorialProgress";let za=null;function zh(){try{const e=localStorage.getItem(Lh);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load tutorial progress:",e)}return{hintsShown:[]}}function Ix(e){try{localStorage.setItem(Lh,JSON.stringify(e))}catch(t){console.warn("Failed to save tutorial progress:",t)}}function Px(e){return zh().hintsShown.includes(e)}function Bx(e){const t=zh();t.hintsShown.includes(e)||(t.hintsShown.push(e),Ix(t))}function Oh(e,t){if(za||Px(t))return!1;const o=Rx[t];if(!o)return!1;Bx(t);const n=e.add([e.rect(300,40),e.pos(e.width()/2,50),e.anchor("center"),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(700),"tutorialHint"]),s=e.add([e.text(o.message,{size:16}),e.pos(e.width()/2,50),e.anchor("center"),e.color(255,255,200),e.fixed(),e.z(701),"tutorialHint"]);return za={bg:n,text:s},e.wait(o.duration,()=>{n.exists()&&e.destroy(n),s.exists()&&e.destroy(s),za=null}),!0}function Lx(e){Oh(e,"movement")}function zx(e){Oh(e,"synergy")}const Hh={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}},glassCannon:{name:"Glass Cannon",description:"Damage x3 + Health: -25% max HP, +100% damage",required:["damage","damage","damage","health"],requiredCounts:{damage:3,health:1},apply:e=>{if((e.upgradeStacks?.damage||0)>=3){const o=Math.floor(e.maxHealth*.75);e.maxHealth=o;const n=Math.max(1,Math.floor(o*.25)),s=Math.max(n,Math.min(e.hp(),o));e.setHP(s),e.projectileDamage=Math.floor(e.projectileDamage*2)}}},vampiricRounds:{name:"Vampiric Rounds",description:"Crit Chance + Crit Damage + Health: Heal 5% of crit damage",required:["critChance","critDamage","health"],apply:e=>{e.vampiricCrits=!0,e.vampiricHealPercent=.05}},bulletTime:{name:"Bullet Time",description:"Speed + Fire Rate: +20% fire rate while moving",required:["speed","fireRate"],apply:e=>{e.bulletTimeEnabled=!0,e.bulletTimeBonus=.2}},berserker:{name:"Berserker",description:"Damage x3 + Speed x2: +50% damage/speed below 30% HP",requiredCounts:{damage:3,speed:2},apply:e=>{e.berserkerEnabled=!0,e.berserkerThreshold=.3,e.berserkerDamageBonus=.5,e.berserkerSpeedBonus=.5}},deadeye:{name:"Deadeye",description:"Crit x2 + Range x2: Crits have +50% range",requiredCounts:{critChance:2,range:2},apply:e=>{e.deadeyeEnabled=!0,e.deadeyeRangeBonus=.5}},survivor:{name:"Survivalist",description:"Health x2 + Defense x2: Regen 1% HP/sec out of combat",requiredCounts:{health:2,defense:2},apply:e=>{e.survivalistEnabled=!0,e.survivalistRegenPercent=.01,e.survivalistCombatCooldown=3,e.survivalistLastCombatTime=0}},thornMaster:{name:"Retribution",description:"Thorns x3 + Defense x2: Thorns ignore enemy armor",requiredCounts:{thorns:3,defense:2},apply:e=>{e.thornsIgnoreArmor=!0,e.thornsPercent=(e.thornsPercent||0)*1.5}},vampireLord:{name:"Vampire Lord",description:"Lifesteal x3 + Crit Dmg x2: Crits heal 3x lifesteal",requiredCounts:{lifesteal:3,critDamage:2},apply:e=>{e.vampireLordEnabled=!0,e.vampireLordMultiplier=3}},executioner:{name:"Executioner",description:"Damage x2 + Piercing x2: +100% damage to enemies <25% HP",requiredCounts:{damage:2,piercing:2},apply:e=>{e.executionerEnabled=!0,e.executionerThreshold=.25,e.executionerDamageBonus=1}},speedDemon:{name:"Speed Demon",description:"Speed x3 + Fire Rate x2: +1% fire rate per speed stack",requiredCounts:{speed:3,fireRate:2},apply:e=>{e.speedDemonEnabled=!0,e.speedDemonFireRatePerStack=.01}},fortress:{name:"Fortress",description:"Health x3 + Invuln x2: Immunity blocks all damage sources",requiredCounts:{health:3,invulnTime:2},apply:e=>{e.fortressEnabled=!0,e.invulnerableDuration=(e.invulnerableDuration||1)*1.5}}};function Uh(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function zi(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const o=[];for(const[n,s]of Object.entries(Hh)){let a=!1;if(s.requiredCounts){a=!0;for(const[r,l]of Object.entries(s.requiredCounts))if((t.upgradeStacks?.[r]||0)<l){a=!1;break}}else a=s.required.every(r=>t.selectedUpgrades.has(r));a&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(n)||(s.apply(t),t.activeSynergies.add(n),o.push(s),zx(e),Ox(e,s)))}return o}function Ox(e,t){const o=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),n=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{o.exists()&&(e.destroy(o),e.destroy(n))})}function bl(e){if(!(!e.activeSynergies||e.activeSynergies.size===0))for(const t of e.activeSynergies){const o=Hh[t];o&&o.apply&&o.apply(e)}}let oo=!1;function Hx(e,t,o,n=null,s=null,a=null){if(oo)return;oo=!0;const r=de();r||(e.paused=!0),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip());let l=!1;e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(l=!0));const c=Pt("toughChoices"),d=Pt("mulligan"),i=3+c;let h=a!==null?a:d,u=0;function g(){let B=null;if(de()){const b=t.playerIndex!==void 0?t.playerIndex:0,S=s||t.level||1;B=ly(b,S+u*100)}return Im(i,t,B)}let p=g();const T=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.opacity(1),e.fixed(),e.z(w.MODAL),"upgradeOverlay"]);l&&e.gameData&&e.gameData.minimap&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()),e.wait(.05,()=>{T.exists()&&(T.opacity=.9)});const m=r&&n?`${n} - Level Up! Choose an Upgrade`:"Level Up! Choose an Upgrade";e.add([e.text(m,{size:Q.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.MODAL+1),"upgradeUI"]);function M(){e.get("upgradeCard").forEach(U=>e.destroy(U));const B=200,b=150,S=e.width()-40;let E,C,A;if(p.length<=3)E=B,C=b,A=250;else if(p.length<=5)E=160,C=130,A=180;else{const U=S/p.length;E=Math.min(140,U-10),C=120,A=E+10}const z=e.width()/2-A*(p.length-1)/2,R=e.height()/2,Y=[];return p.forEach((U,N)=>{const H=z+N*A,I=e.add([e.rect(E,C),e.pos(H,R),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.MODAL+1),e.area(),"upgradeUI","upgradeCard"]),F=E<=140?32:48;if(U.icon){const ne=U.category==="passive"?y.SUCCESS:U.weaponKey?y.WARNING:y.INFO;e.add([e.text(U.icon,{size:F}),e.pos(H,R-C/3),e.anchor("center"),e.color(...ne),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"])}const V=E<=140?12:Q.BUTTON;e.add([e.text(U.name,{size:V,width:E-10}),e.pos(H,R-5),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"]);const j=E<=140?10:Q.BODY,ce=Pm(U,t);e.add([e.text(ce,{size:j,width:E-10}),e.pos(H,R+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"]);const ie=E<=140?14:Q.HEADER;e.add([e.text(`${N+1}`,{size:ie}),e.pos(H+E/2-15,R-C/2+12),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.MODAL+2),"upgradeUI","upgradeCard"]),Y.push({card:I,upgrade:U,index:N}),I.onClick(()=>{oo&&_(N)})}),Y}M();let P=null;if(d>0){const B=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.WARNING)),e.fixed(),e.z(w.MODAL+1),e.area(),"upgradeUI"]);P=e.add([e.text(`(R) Reroll (${h})`,{size:14}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.MODAL+2),"upgradeUI"]),B.onClick(()=>{oo&&h>0&&f()})}function f(){h<=0||(h--,u++,p=g(),M(),P&&P.exists()&&(P.text=`(R) Reroll (${h})`,h===0&&(P.color=e.rgb(...y.TEXT_SECONDARY))))}function _(B){if(!oo)return;const b=p[B];tx(),oo=!1,qr(t,b.key),Uh(t,b.key);const S=zi(e,t);if(de()&&t.slotIndex!==void 0&&(oy(t.slotIndex,b.key),S&&S.length>0)){const E=S.map(C=>C.name);sy(t.slotIndex,E)}e.get("upgradeUI").forEach(E=>e.destroy(E)),e.get("upgradeOverlay").forEach(E=>e.destroy(E)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),r||(e.paused=!1),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{o&&o(b,h)})}e.onKeyPress("1",()=>{oo&&p.length>=1&&_(0)}),e.onKeyPress("2",()=>{oo&&p.length>=2&&_(1)}),e.onKeyPress("3",()=>{oo&&p.length>=3&&_(2)}),e.onKeyPress("4",()=>{oo&&p.length>=4&&_(3)}),e.onKeyPress("5",()=>{oo&&p.length>=5&&_(4)}),e.onKeyPress("6",()=>{oo&&p.length>=6&&_(5)}),e.onKeyPress("7",()=>{oo&&p.length>=7&&_(6)}),e.onKeyPress("8",()=>{oo&&p.length>=8&&_(7)}),e.onKeyPress("9",()=>{oo&&p.length>=9&&_(8)}),e.onKeyPress("0",()=>{oo&&p.length>=10&&_(9)}),e.onKeyPress("r",()=>{oo&&h>0&&f()})}function Ei(){return oo}function vl(e,t,o=null,n=!1){let s=!1;t.pendingLevelUps=t.pendingLevelUps||[],t.addXP=function(r){if(e.paused||s)return;const l=t.xpMultiplier||1,c=Math.floor(r*l);for(t.xp+=c;t.xp>=t.xpToNext&&!s&&t.xpToNext>0;){s=!0,t.xp-=t.xpToNext,t.level++;const d=t.level;t.xpToNext=Math.max(1,Math.floor(t.xpToNext*fn.XP_SCALING_FACTOR)),a(e,t,d)}};function a(r,l,c){if(r.paused&&!n){s=!1;return}ex();const d=r.add([r.text(`Level ${c}!`,{size:24}),r.pos(r.width()/2,fn.LEVEL_UP_NOTIFICATION_Y),r.anchor("center"),r.color(255,255,100),r.fixed(),r.z(1e3)]);n&&l.slotIndex!==void 0&&ny(l.slotIndex,c),l.pendingLevelUps.push(c),r.wait(fn.LEVEL_UP_NOTIFICATION_DURATION,()=>{d.exists()&&r.destroy(d),s=!1})}return{processPendingLevelUp:()=>{if(t.pendingLevelUps.length>0&&!s){s=!0;const r=t.pendingLevelUps.shift(),l=t.playerName||(t.isRemote?`Player ${t.slotIndex+1}`:"You");Hx(e,t,()=>{s=!1},n?l:null,r)}}}}const Ux={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:18,turret:12,heavyTank:18,zippy:18,exploder:20,splitter:14},3:{mage:15,shieldBearer:12,golem:12,wraith:12,spawner:12,buffer:15,orbiter:7,phaser:8,mimic:7},4:{healer:18,teleporter:15,freezer:18,leech:20,reflector:14,bomber:15}};function Nx(){return{basic:15,rusher:25,tank:30,fast:30}}function _x(e,t=null){const o=Object.values(e).reduce((s,a)=>s+a,0);let n=(t?t.next():Math.random())*o;for(const[s,a]of Object.entries(e))if(n-=a,n<=0)return s;return Object.keys(e)[0]}function gr(e=1,t=null){const o=Ux[e]||Nx();return _x(o,t)}const Nh={swift:{name:"Swift",prefix:"",color:[255,255,100],apply:e=>{e.speed=Math.floor(e.speed*1.5)}},armored:{name:"Armored",prefix:"",color:[100,150,255],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*2),e.setHP(e.maxHealth),e.damageReduction=(e.damageReduction||0)+.25}},vampiric:{name:"Vampiric",prefix:"",color:[255,100,100],apply:e=>{e.isVampiric=!0,e.vampiricHealAmount=10}}},El={2:{spawnChance:.1},3:{spawnChance:.12},4:{spawnChance:.15}};function Xx(e,t=null){if(e<2)return!1;const o=El[e]||El[4];return(t?t.next():Math.random())<o.spawnChance}function Fx(e=null){const t=Object.keys(Nh),o=e?e.next():Math.random(),n=Math.floor(o*t.length);return t[n]}function Yx(e,t,o){const n=Nh[o];if(!n)return;t.isElite=!0,t.eliteModifier=o,n.apply(t);const s=`${n.prefix}${t.coreChar}`;t.coreChar=s,t.text=s,t.originalColor=n.color,t.color=e.rgb(...n.color),t.xpValue=Math.floor(t.xpValue*1.5),t.updateVisual&&t.updateVisual()}function Al(e,t,o,n=null){if(t.isBoss||t.isBossEnemy||!Xx(o,n))return!1;const s=Fx(n);return Yx(e,t,s),!0}const qx=800,Gx=600,Ai=20;let Js=null;const Yn={empty:{name:"Empty Room",obstacles:[],barrels:[],spawnDoors:null,floorAffinity:[1]},streetCorners:{name:"Street Corners",obstacles:[{x:150,y:150,width:50,height:50,type:"cover",char:""},{x:650,y:150,width:50,height:50,type:"cover",char:""},{x:150,y:450,width:50,height:50,type:"cover",char:""},{x:650,y:450,width:50,height:50,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:400}],spawnDoors:null,floorAffinity:[1]},alleyway:{name:"Alleyway",obstacles:[{x:200,y:200,width:30,height:200,type:"wall",char:""},{x:600,y:200,width:30,height:200,type:"wall",char:""}],barrels:[{x:250,y:250},{x:550,y:350}],spawnDoors:null,floorAffinity:[1]},factoryFloor:{name:"Factory Floor",obstacles:[{x:200,y:180,width:80,height:40,type:"wall",char:""},{x:600,y:180,width:80,height:40,type:"wall",char:""},{x:200,y:420,width:80,height:40,type:"wall",char:""},{x:600,y:420,width:80,height:40,type:"wall",char:""},{x:400,y:300,width:60,height:60,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:[2]},assemblyLine:{name:"Assembly Line",obstacles:[{x:250,y:250,width:300,height:25,type:"wall",char:""},{x:250,y:350,width:300,height:25,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[2]},storageYard:{name:"Storage Yard",obstacles:[{x:180,y:180,width:50,height:50,type:"cover",char:""},{x:620,y:180,width:50,height:50,type:"cover",char:""},{x:180,y:420,width:50,height:50,type:"cover",char:""},{x:620,y:420,width:50,height:50,type:"cover",char:""},{x:320,y:300,width:40,height:40,type:"cover",char:""},{x:480,y:300,width:40,height:40,type:"cover",char:""}],barrels:[{x:250,y:250},{x:550,y:250},{x:250,y:350},{x:550,y:350},{x:400,y:200}],spawnDoors:null,floorAffinity:[2]},serverRoom:{name:"Server Room",obstacles:[{x:200,y:150,width:30,height:300,type:"wall",char:""},{x:350,y:150,width:30,height:300,type:"wall",char:""},{x:500,y:150,width:30,height:300,type:"wall",char:""},{x:650,y:150,width:30,height:300,type:"wall",char:""}],barrels:[{x:275,y:200},{x:425,y:400},{x:575,y:250}],spawnDoors:null,floorAffinity:[3]},controlCenter:{name:"Control Center",obstacles:[{x:400,y:200,width:120,height:80,type:"wall",char:""},{x:200,y:350,width:60,height:60,type:"cover",char:""},{x:600,y:350,width:60,height:60,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:200},{x:400,y:450}],spawnDoors:null,floorAffinity:[3]},dataVault:{name:"Data Vault",obstacles:[{x:250,y:200,width:40,height:40,type:"wall",char:""},{x:550,y:200,width:40,height:40,type:"wall",char:""},{x:250,y:400,width:40,height:40,type:"wall",char:""},{x:550,y:400,width:40,height:40,type:"wall",char:""},{x:400,y:300,width:100,height:100,type:"wall",char:""}],barrels:[{x:180,y:300},{x:620,y:300}],spawnDoors:null,floorAffinity:[3]},hiveCluster:{name:"Hive Cluster",obstacles:[{x:300,y:180,width:50,height:50,type:"cover",char:""},{x:500,y:180,width:50,height:50,type:"cover",char:""},{x:200,y:300,width:50,height:50,type:"cover",char:""},{x:600,y:300,width:50,height:50,type:"cover",char:""},{x:300,y:420,width:50,height:50,type:"cover",char:""},{x:500,y:420,width:50,height:50,type:"cover",char:""}],barrels:[{x:400,y:180},{x:400,y:420},{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:[4]},bioLab:{name:"Bio Lab",obstacles:[{x:300,y:250,width:200,height:30,type:"wall",char:""},{x:300,y:350,width:200,height:30,type:"wall",char:""},{x:400,y:300,width:30,height:130,type:"wall",char:""}],barrels:[{x:200,y:200},{x:600,y:200},{x:200,y:400},{x:600,y:400},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[4]},xenoNest:{name:"Xeno Nest",obstacles:[{x:400,y:300,width:80,height:80,type:"wall",char:""},{x:250,y:200,width:35,height:35,type:"cover",char:""},{x:550,y:200,width:35,height:35,type:"cover",char:""},{x:250,y:400,width:35,height:35,type:"cover",char:""},{x:550,y:400,width:35,height:35,type:"cover",char:""}],barrels:[{x:180,y:150},{x:620,y:150},{x:180,y:450},{x:620,y:450}],spawnDoors:null,floorAffinity:[4]},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],barrels:[{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],barrels:[{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],barrels:[{x:150,y:290},{x:650,y:290}],spawnDoors:null,floorAffinity:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],barrels:[{x:250,y:200},{x:550,y:200},{x:250,y:400},{x:550,y:400}],spawnDoors:null,floorAffinity:null},barrelRoom:{name:"Barrel Room",obstacles:[{x:400,y:300,width:50,height:50,type:"cover",char:""}],barrels:[{x:250,y:200},{x:300,y:200},{x:275,y:250},{x:500,y:400},{x:550,y:400},{x:525,y:350},{x:150,y:150},{x:650,y:450}],spawnDoors:null,floorAffinity:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],barrels:[{x:450,y:200},{x:250,y:400},{x:600,y:350}],spawnDoors:null,floorAffinity:null}};function Kx(e,t,o,n){const s=o/2,a=n/2,r=Ai+s,l=qx-Ai-s,c=Ai+a,d=Gx-Ai-a,i=Math.max(r,Math.min(l,e)),h=Math.max(c,Math.min(d,t));return{x:i,y:h}}function Vx(e,t){const o={1:{wall:[55,55,65],obstacle:[70,70,80],cover:[85,85,95]},2:{wall:[75,60,50],obstacle:[90,70,55],cover:[100,80,65]},3:{wall:[45,55,75],obstacle:[55,70,95],cover:[65,85,115]},4:{wall:[60,45,70],obstacle:[75,55,85],cover:[90,65,100]},5:{wall:[35,30,45],obstacle:[45,38,55],cover:[55,45,65]}},n=o[Math.min(t,5)]||o[5];return{wallColor:e.rgb(...n.wall),obstacleColor:e.rgb(...n.obstacle),coverColor:e.rgb(...n.cover)}}function qs(e,t=null){const o=Object.keys(Yn),n=Js?o.filter(h=>h!==Js):o,s=[],a=[];n.forEach(h=>{const u=Yn[h];u.floorAffinity===null?a.push(h):u.floorAffinity.includes(e)&&s.push(h)});const l=s.length>0&&(t?t.next():Math.random())<.7?s:a.length>0?a:n,c=l.length>0?l:o,d=t?t.range(0,c.length):Math.floor(Math.random()*c.length),i=c[d];return Js=i,{key:i,...Yn[i]}}function Wx(e,t=null,o=1){const n=Yn[e];if(!n||!n.barrels||n.barrels.length===0)return[];let s=[...n.barrels];if(o>=2&&(t?t.next():Math.random())<.3+o*.1){const r=100+(t?t.next():Math.random())*600,l=100+(t?t.next():Math.random())*400;s.push({x:r,y:l})}return o===1&&(t?t.next():Math.random())<.5&&s.length>1&&(s=s.slice(0,Math.ceil(s.length/2))),s}function $x(){Js=null}function Sl(e){return Yn[e]?(Js=e,{key:e,...Yn[e]}):(console.warn(`Unknown room template key: ${e}, falling back to empty`),{key:"empty",...Yn.empty})}let tc=[],oc=null;function Jx(e){if(Ur(e))return!1;if(Og(e)){if(tc.push(e),oc){const t=an[e];t&&(nx(),Lm(t),de()&&Sy(e,Ay()))}return!0}return!1}function jx(e){tc=[],oc=e,e&&Kr(e)}function Zx(){return[...tc]}function Si(e,t=null){e&&(oc=e,Kr(e));const o=vs(),n={bestFloor:Math.max(o.bestFloor||0,t?.floor||0),totalEnemiesKilled:(o.totalEnemiesKilled||0)+(t?.enemiesKilled||0),totalBossesKilled:(o.totalBossesKilled||0)+(t?.bossesKilled||0),totalRuns:o.totalRuns||0,bestLevel:Math.max(o.bestLevel||0,t?.level||0),totalCurrencyEarned:(o.totalCurrencyEarned||0)+(t?.currencyEarned||0)},s=[],a=(r,l)=>{r&&Jx(l)&&s.push(l)};return a(n.bestFloor>=2,"floor2"),a(n.bestFloor>=3,"floor3"),a(n.bestFloor>=5,"floor5"),a(n.bestFloor>=10,"floor10"),a(n.bestFloor>=15,"floor15"),a(n.bestFloor>=20,"floor20"),a(n.totalEnemiesKilled>=1,"firstKill"),a(n.totalEnemiesKilled>=100,"kill100"),a(n.totalEnemiesKilled>=500,"kill500"),a(n.totalEnemiesKilled>=1e3,"kill1000"),a(n.totalEnemiesKilled>=5e3,"kill5000"),a(n.totalEnemiesKilled>=1e4,"kill10000"),a(n.totalBossesKilled>=1,"firstBoss"),a(n.totalBossesKilled>=5,"boss5"),a(n.totalBossesKilled>=10,"boss10"),a(n.totalBossesKilled>=25,"boss25"),a(n.totalBossesKilled>=50,"boss50"),a(n.totalRuns>=1,"firstRun"),a(n.totalRuns>=10,"run10"),a(n.totalRuns>=50,"run50"),a(n.totalRuns>=100,"run100"),a(n.bestLevel>=10,"level10"),a(n.bestLevel>=20,"level20"),a(n.bestLevel>=30,"level30"),a(n.bestLevel>=50,"level50"),a(n.totalCurrencyEarned>=100,"earn100"),a(n.totalCurrencyEarned>=500,"earn500"),a(n.totalCurrencyEarned>=1e3,"earn1000"),a(n.totalCurrencyEarned>=5e3,"earn5000"),a(n.totalCurrencyEarned>=1e4,"earn10000"),s}class Mi{constructor(t,o,n="combat"){this.position={x:t,y:o},this.type=n,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=n==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:o,y:n}=this.position;switch(t){case"up":return{x:o,y:n-1};case"down":return{x:o,y:n+1};case"right":return{x:o+1,y:n};default:return null}}}class Qx{constructor(t,o=6,n=3,s=null){this.floor=t,this.width=o,this.height=n,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.rng=s,this.generate()}random(){return this.rng?this.rng.next():Math.random()}randomRange(t,o){return this.rng?this.rng.range(t,o):Math.floor(Math.random()*(o-t))+t}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const o=this.height===1?0:this.randomRange(0,this.height);this.bossPosition={x:this.width-1,y:o};const n=new Mi(0,t,"start");this.setRoom(0,t,n);const s=new Mi(this.width-1,o,"boss");this.setRoom(this.width-1,o,s),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const o of t)if(!this.getRoom(o.x,o.y)){const n=new Mi(o.x,o.y,"combat");this.setRoom(o.x,o.y,n)}}findPath(t,o){const n=[];let s={...t};for(;s.x<o.x||s.y!==o.y;)n.push({...s}),s.x<o.x?s.y!==o.y&&this.random()<.3?s.y+=s.y<o.y?1:-1:s.x+=1:s.y+=s.y<o.y?1:-1;return n.push({...o}),n}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let o=0;for(let n=1;n<this.width-1;n++)for(let s=0;s<this.height&&!(o>=t);s++){if(this.getRoom(n,s))continue;if(n>0&&this.getRoom(n-1,s)&&this.random()<.5){const r=new Mi(n,s,"combat");this.setRoom(n,s,r),o++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const n=this.getRoom(t,o);n&&(t<this.width-1&&this.getRoom(t+1,o)&&(n.connections.right=!0),o>0&&this.getRoom(t,o-1)&&(n.connections.up=!0),o<this.height-1&&this.getRoom(t,o+1)&&(n.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const n=this.getRoom(t,o);if(n&&(n.type!=="boss"&&(n.template=qs(this.floor,this.rng)),n.type==="combat")){const s=this.randomRange(3,6);n.enemyTypes=[];for(let a=0;a<s;a++)n.enemyTypes.push(gr(this.floor,this.rng))}}}validate(){const t=new Set,o=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);o.length>0;){const n=o.shift(),s=this.getRoom(n.x,n.y);if(!s)continue;if(s.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const a=["up","down","right"];for(const r of a)if(s.connections[r]){const l=s.getAdjacentPosition(r),c=`${l.x},${l.y}`;t.has(c)||(t.add(c),o.push(l))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,o){return t<0||t>=this.width||o<0||o>=this.height?null:this.grid[o][t]}setRoom(t,o,n){t<0||t>=this.width||o<0||o>=this.height||(this.grid[o][t]=n,this.rooms.set(n.getKey(),n))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const o=[],n=["up","down","right"];for(const s of n)if(t.connections[s]){const a=t.getAdjacentPosition(s),r=this.getRoom(a.x,a.y);r&&!r.visited&&o.push({direction:s,position:a,room:r})}return o}markRoomVisited(t,o){const n=this.getRoom(t,o);n&&(n.visited=!0,this.visitedRooms.add(n.getKey()))}markRoomCleared(t,o){const n=this.getRoom(t,o);n&&(n.cleared=!0)}moveToRoom(t){const o=this.getCurrentRoom();if(!o||!o.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const n=o.getAdjacentPosition(t);return this.getRoom(n.x,n.y)?(this.currentPosition=n,this.markRoomVisited(n.x,n.y),console.log(`[FloorMap] Moved to room (${n.x}, ${n.y})`),!0):(console.warn(`[FloorMap] No room found at ${n.x}, ${n.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let o=0;o<this.height;o++){const n=[];for(let s=0;s<this.width;s++){const a=this.getRoom(s,o);a?s===this.currentPosition.x&&o===this.currentPosition.y?n.push({type:"current",room:a}):a.visited?n.push({type:"visited",room:a}):this.isRoomRevealed(s,o)?n.push({type:"revealed",room:a}):n.push({type:"hidden"}):n.push({type:"empty"})}t.push(n)}return t}isRoomRevealed(t,o){if(!this.getRoom(t,o))return!1;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:a,dy:r}of s){const l=this.getRoom(t+a,o+r);if(l&&l.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let o="";for(let n=0;n<this.width;n++){const s=this.getRoom(n,t);s?s.type==="start"?o+="[S]":s.type==="boss"?o+="[B]":n===this.currentPosition.x&&t===this.currentPosition.y?o+="[]":s.visited?o+="[]":o+="[R]":o+="[ ]",o+=" "}console.log(o)}console.log(`
Connections:`);for(const[t,o]of this.rooms){const n=[];o.connections.up&&n.push(""),o.connections.down&&n.push(""),o.connections.right&&n.push(""),console.log(`  (${o.position.x}, ${o.position.y}): ${n.join(", ")||"none"}`)}}}function kx(e,t=null){const o=Math.min(3+e,10),n=Math.min(2+Math.floor(e/2),6),s=new Qx(e,o,n,t);return s.debugPrint(),s}const An={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"},Wt={MARGIN_RIGHT:12,MARGIN_TOP:32,BUTTON_SIZE:38,OPEN_WIDTH:130,OPEN_HEIGHT:85,MAX_MIN_WIDTH:200,MAX_MIN_HEIGHT:160,CELL_SIZE_SMALL:11,CELL_SIZE_LARGE:16,Z_BASE:900,Z_TEXT:901,Z_ICON:902},Ft={BG_PANEL:[25,25,40],BG_HEADER:[35,35,55],BORDER:[80,120,180],BORDER_HOVER:[120,160,220],TEXT_TITLE:[200,210,255],TEXT_MUTED:[140,140,160],ICON_MAP:[130,160,220],BADGE_FLOOR:[255,220,80],CURRENT:[255,255,100],VISITED:[80,220,100],AVAILABLE:[120,120,140],BOSS:[255,90,90],HIDDEN:[50,50,70],CELL_BG:[30,30,45],CELL_BORDER:[45,45,60]};class e1{constructor(t,o){this.k=t,this.floorMap=o,this.mode=An.MINIMIZED,this.elements=[],this.isHovered=!1,this.destroyed=!1,this.floorMap&&typeof this.floorMap.getGridForMinimap=="function"&&this.render()}getRightX(){return this.k.width()-Wt.MARGIN_RIGHT}getTopY(){return Wt.MARGIN_TOP}toggle(){if(!this.destroyed){try{ke()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===An.MINIMIZED?this.mode=An.OPEN:this.mode===An.OPEN?this.mode=An.MAXIMIZED:this.mode=An.MINIMIZED,this.update()}}update(){this.destroyed||(this.clear(),this.render())}clear(){this.elements.forEach(t=>{try{t&&t.exists()&&this.k.destroy(t)}catch{}}),this.elements=[]}render(){this.destroyed||(this.mode===An.MINIMIZED?this.renderMinimized():this.mode===An.OPEN?this.renderOpen():this.renderMaximized())}createPanel(t,o,n,s){const a=this.k.add([this.k.rect(t,o),this.k.pos(n,s),this.k.anchor("topright"),this.k.color(...Ft.BG_PANEL),this.k.outline(2,this.k.rgb(...Ft.BORDER)),this.k.fixed(),this.k.z(Wt.Z_BASE),this.k.area(),this.k.opacity(.95),"minimap"]);return a.onHover(()=>{a.outline.color=this.k.rgb(...Ft.BORDER_HOVER),a.outline.width=3}),a.onHoverEnd(()=>{a.outline.color=this.k.rgb(...Ft.BORDER),a.outline.width=2}),a.onClick(()=>this.toggle()),this.elements.push(a),a}renderMinimized(){const t=this.getRightX(),o=this.getTopY(),n=Wt.BUTTON_SIZE;this.createPanel(n,n,t,o);const s=t-n/2,a=o+n/2,r=this.k.add([this.k.text("",{size:22}),this.k.pos(s,a),this.k.anchor("center"),this.k.color(...Ft.ICON_MAP),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(r);const l=this.k.add([this.k.text(`F${this.floorMap.floor}`,{size:9}),this.k.pos(t-n+4,o+4),this.k.anchor("topleft"),this.k.color(...Ft.BADGE_FLOOR),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(l)}renderOpen(){const t=this.getRightX(),o=this.getTopY(),n=Wt.OPEN_WIDTH,s=Wt.OPEN_HEIGHT,a=Wt.CELL_SIZE_SMALL,r=this.floorMap.getGridForMinimap();if(!r||r.length===0||!r[0]){this.renderMinimized();return}this.createPanel(n,s,t,o);const l=18,c=this.k.add([this.k.rect(n-4,l),this.k.pos(t-2,o+2),this.k.anchor("topright"),this.k.color(...Ft.BG_HEADER),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(c);const d=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t-n/2,o+2+l/2),this.k.anchor("center"),this.k.color(...Ft.TEXT_TITLE),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(d);const i=r[0].length*a;r.length*a;const h=t-n/2-i/2,u=o+l+8;this.renderGrid(r,h,u,a,!1);const g=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()} rooms`,{size:8}),this.k.pos(t-n/2,o+s-8),this.k.anchor("center"),this.k.color(...Ft.TEXT_MUTED),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(g)}renderMaximized(){const t=this.getRightX(),o=this.getTopY(),n=Wt.CELL_SIZE_LARGE,s=this.floorMap.getGridForMinimap();if(!s||s.length===0||!s[0]){this.renderMinimized();return}const a=s[0].length*n,r=s.length*n,l=70,c=26,d=16,i=Math.max(Wt.MAX_MIN_WIDTH,a+d*2),h=Math.max(Wt.MAX_MIN_HEIGHT,r+c+l+d),u=Math.min(i,this.k.width()-Wt.MARGIN_RIGHT-10);this.createPanel(u,h,t,o);const g=this.k.add([this.k.rect(u-4,c),this.k.pos(t-2,o+2),this.k.anchor("topright"),this.k.color(...Ft.BG_HEADER),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(g);const p=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor}    ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:11}),this.k.pos(t-u/2,o+2+c/2),this.k.anchor("center"),this.k.color(...Ft.TEXT_TITLE),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(p);const T=Math.min(a,u-d*2),m=t-u/2-T/2,M=o+c+12;this.renderGrid(s,m,M,n,!0);const P=M+r+12;this.renderLegend(t-u+d,P)}renderGrid(t,o,n,s,a){for(let r=0;r<t.length;r++)for(let l=0;l<t[r].length;l++){const c=t[r][l],d=o+l*s,i=n+r*s;if(c.type==="empty")continue;if(a){const g=this.k.add([this.k.rect(s-2,s-2),this.k.pos(d,i),this.k.anchor("topleft"),this.k.color(...Ft.CELL_BG),this.k.outline(1,this.k.rgb(...Ft.CELL_BORDER)),this.k.fixed(),this.k.z(Wt.Z_TEXT),"minimap"]);this.elements.push(g)}const{char:h,color:u}=this.getCellDisplay(c);if(h){const g=a?12:9,p=this.k.add([this.k.text(h,{size:g}),this.k.pos(d+s/2-1,i+s/2-1),this.k.anchor("center"),this.k.color(...u),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(p)}}}getCellDisplay(t){switch(t.type){case"current":return{char:"",color:Ft.CURRENT};case"visited":return t.room.isBossRoom?{char:"B",color:Ft.BOSS}:{char:"",color:Ft.VISITED};case"revealed":return t.room.isBossRoom?{char:"B",color:[...Ft.BOSS.map(o=>Math.min(255,o+50))]}:{char:"",color:Ft.AVAILABLE};case"hidden":return{char:"",color:Ft.HIDDEN};default:return{char:"",color:[100,100,100]}}}renderLegend(t,o){const n=[{char:"",label:"Current",color:Ft.CURRENT},{char:"",label:"Cleared",color:Ft.VISITED},{char:"",label:"Available",color:Ft.AVAILABLE},{char:"B",label:"Boss",color:Ft.BOSS}],s=80,a=14;n.forEach((r,l)=>{const c=l%2,d=Math.floor(l/2),i=t+c*s,h=o+d*a,u=this.k.add([this.k.text(r.char,{size:10}),this.k.pos(i,h),this.k.anchor("topleft"),this.k.color(...r.color),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(u);const g=this.k.add([this.k.text(r.label,{size:8}),this.k.pos(i+14,h+1),this.k.anchor("topleft"),this.k.color(...Ft.TEXT_MUTED),this.k.fixed(),this.k.z(Wt.Z_ICON),"minimap"]);this.elements.push(g)})}destroy(){this.destroyed=!0,this.clear()}}function t1(e,t){return new e1(e,t)}const Ml={city:{name:"Urban Streets",description:"Abandoned city blocks overrun by chaos",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.18},{char:"",pattern:"vertical_lines",density:"low",opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.22},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:6,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08}],baseColor:[55,55,65],ambientColor:[70,70,80]},mechanical:{name:"Industrial Complex",description:"Rusted factories and hazardous machinery",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.15},{char:"",pattern:"grid",spacing:70,opacity:.18},{char:"",pattern:"scattered",count:5,opacity:.22},{char:"",pattern:"scattered",count:4,opacity:.2},{char:"",pattern:"edges",count:16,opacity:.16},{char:"",pattern:"corners",opacity:.24},{char:"",pattern:"random",count:10,opacity:.1},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"horizontal_lines",density:"low",opacity:.12}],baseColor:[75,60,50],ambientColor:[90,75,60]},futuristic:{name:"Cyber Station",description:"High-tech facility with malfunctioning systems",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.16},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.16},{char:"",pattern:"grid",spacing:90,opacity:.14},{char:"",pattern:"scattered",count:6,opacity:.18},{char:"",pattern:"corners",opacity:.22},{char:"",pattern:"scattered",count:8,opacity:.16},{char:"",pattern:"grid",spacing:150,opacity:.1},{char:"",pattern:"random",count:5,opacity:.12},{char:"",pattern:"edges",count:20,opacity:.15}],baseColor:[45,55,75],ambientColor:[60,80,120]},alien:{name:"Alien Vessel",description:"Otherworldly organic ship interior",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.15},{char:"~",pattern:"random",count:20,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.2},{char:"",pattern:"grid",spacing:110,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:6,opacity:.16},{char:"",pattern:"random",count:12,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08},{char:"",pattern:"random",count:8,opacity:.12},{char:"",pattern:"random",count:8,opacity:.12}],baseColor:[60,45,70],ambientColor:[80,60,100]},void:{name:"The Void",description:"Reality breaks down at the edge of existence",floors:[5,6,7,8],decorations:[{char:"",pattern:"random",count:25,opacity:.15},{char:"",pattern:"random",count:15,opacity:.12},{char:"",pattern:"scattered",count:8,opacity:.18},{char:"",pattern:"grid",spacing:120,opacity:.14},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:10,opacity:.16},{char:"",pattern:"random",count:20,opacity:.1},{char:"",pattern:"random",count:20,opacity:.1}],baseColor:[35,30,45],ambientColor:[50,40,70]}};function o1(e){for(const[t,o]of Object.entries(Ml))if(o.floors.includes(e))return{key:t,...o};return{key:"city",...Ml.city}}function n1(e,t,o=800,n=600){const s=o1(t),a=[],r=30;return s.decorations.forEach(l=>{const c=s.baseColor,d=e.rgb(c[0]+(Math.random()-.5)*20,c[1]+(Math.random()-.5)*20,c[2]+(Math.random()-.5)*20);switch(l.pattern){case"horizontal_lines":{const i=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<n-r;h+=i)a.push({char:l.char,x:o/2,y:h+(Math.random()-.5)*20,color:d,opacity:l.opacity,size:12});break}case"vertical_lines":{const i=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<o-r;h+=i)a.push({char:l.char,x:h+(Math.random()-.5)*20,y:n/2,color:d,opacity:l.opacity,size:12});break}case"wavy_lines":{for(let h=r;h<n-r;h+=60)for(let u=r;u<o-r;u+=40)a.push({char:l.char,x:u+Math.sin(h*.05)*15,y:h,color:d,opacity:l.opacity,size:10});break}case"grid":{const i=l.spacing||80;for(let h=r;h<n-r;h+=i)for(let u=r;u<o-r;u+=i)a.push({char:l.char,x:u+(Math.random()-.5)*10,y:h+(Math.random()-.5)*10,color:d,opacity:l.opacity,size:14});break}case"scattered":{const i=l.count||5;for(let h=0;h<i;h++)a.push({char:l.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(n-r*2),color:d,opacity:l.opacity,size:16});break}case"random":{const i=l.count||10;for(let h=0;h<i;h++)a.push({char:l.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(n-r*2),color:d,opacity:l.opacity,size:10+Math.random()*6});break}case"corners":{[{x:r+40,y:r+40},{x:o-r-40,y:r+40},{x:r+40,y:n-r-40},{x:o-r-40,y:n-r-40}].forEach(h=>{a.push({char:l.char,x:h.x,y:h.y,color:d,opacity:l.opacity,size:18})});break}case"edges":{const i=l.count||8,h=Math.floor(i/4);for(let u=0;u<h;u++)a.push({char:l.char,x:o/h*u+o/(h*2),y:r+20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:o/h*u+o/(h*2),y:n-r-20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:r+20,y:n/h*u+n/(h*2),color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:o-r-20,y:n/h*u+n/(h*2),color:d,opacity:l.opacity,size:12});break}}}),a}function s1(e,t,o=800,n=600){n1(e,t,o,n).forEach(a=>{e.add([e.text(a.char,{size:a.size}),e.pos(a.x,a.y),e.color(a.color),e.opacity(a.opacity),e.z(0),"floorDecoration"])})}class Qi{constructor(t,o){this.playerId=t,this.characterKey=o,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=fn.STARTING_LEVEL,this.xp=fn.STARTING_XP,this.xpToNext=fn.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,velocityX:this.velocityX,velocityY:this.velocityY,health:this.health,maxHealth:this.maxHealth,speed:this.speed,level:this.level,xp:this.xp,xpToNext:this.xpToNext,xpMultiplier:this.xpMultiplier,weaponKey:this.weaponKey,fireRate:this.fireRate,projectileSpeed:this.projectileSpeed,projectileDamage:this.projectileDamage,projectileCount:this.projectileCount,piercing:this.piercing,obstaclePiercing:this.obstaclePiercing,critChance:this.critChance,critDamage:this.critDamage,spreadAngle:this.spreadAngle,weaponRange:this.weaponRange,pickupRadius:this.pickupRadius,defense:this.defense,damageReduction:this.damageReduction,dodgeChance:this.dodgeChance,invulnerable:this.invulnerable,invulnerableTime:this.invulnerableTime,slowed:this.slowed,isDead:this.isDead,weapons:this.weapons,passiveUpgrades:this.passiveUpgrades,upgradeStacks:this.upgradeStacks}}static fromJSON(t){const o=new Qi(t.playerId,t.characterKey);return Object.assign(o,t),o}}class ki{constructor(t,o,n,s,a={}){this.id=t,this.type=o,this.x=n,this.y=s,this.data=a,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new ki(t.id,t.type,t.x,t.y,t.data)}}class ea{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,o){const n=new Qi(t,o);return this.players.set(t,n),this.localPlayerId===null&&(this.localPlayerId=t),n}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,o,n,s={}){const a=this.generateEntityId(),r=new ki(a,t,o,n,s);return this.entities.set(a,r),r}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(o=>o.type===t&&!o.removed)}removeEntity(t){const o=this.entities.get(t);o&&(o.removed=!0)}cleanupRemovedEntities(){for(const[t,o]of this.entities.entries())o.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,o])=>[t,o.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,o])=>[t,o.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const o=new ea;return o.sessionId=t.sessionId,o.gameMode=t.gameMode,o.isPaused=t.isPaused,o.currentFloor=t.currentFloor,o.currentRoom=t.currentRoom,o.roomCleared=t.roomCleared,o.gameTime=t.gameTime,o.localPlayerId=t.localPlayerId,o.nextEntityId=t.nextEntityId,o.players=new Map(t.players.map(([n,s])=>[n,Qi.fromJSON(s)])),o.entities=new Map(t.entities.map(([n,s])=>[n,ki.fromJSON(s)])),o.doors=t.doors,o.obstacles=t.obstacles,o}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class i1{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new ea,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=ea.fromJSON(t),this.gameState}clear(){this.gameState=null}}const Tl=new i1;class nc{constructor(t,o,n){this.playerId=t,this.frameNumber=o,this.timestamp=n,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const o=new nc(t.playerId,t.frameNumber,t.timestamp);return Object.assign(o,t),o}}class a1{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1,this.eventHandlers=[]}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(n=>{this.eventHandlers.push(t.onKeyPress(n,()=>{this.keysPressed.add(n)})),this.eventHandlers.push(t.onKeyRelease(n,()=>{this.keysPressed.delete(n)}))}),this.eventHandlers.push(t.onKeyPress("escape",()=>{this.onPausePressed()})),this.eventHandlers.push(t.onKeyPress("space",()=>{this.onInteractPressed()})),this.eventHandlers.push(t.onKeyPress("e",()=>{this.onInteractPressed()}))}setupMouseListeners(){const t=this.k;this.eventHandlers.push(t.onMouseMove(o=>{this.mouseX=o.x,this.mouseY=o.y})),this.eventHandlers.push(t.onMousePress(()=>{this.mousePressed=!0})),this.eventHandlers.push(t.onMouseRelease(()=>{this.mousePressed=!1}))}collectLocalInput(t){const o=new nc(t,this.frameNumber,Date.now());return o.moveX=this.getMoveX(),o.moveY=this.getMoveY(),o.aimX=this.mouseX,o.aimY=this.mouseY,o.firing=!0,o}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const o=new Map;for(const n of t){const s=this.inputQueues.get(n);let a;s&&s.length>0?a=s.shift():a=this.collectLocalInput(n),o.set(n,a)}return this.currentInputs=o,this.inputHistory.push(new Map(o)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,o}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.eventHandlers.forEach(t=>{t&&t.cancel&&t.cancel()}),this.eventHandlers=[],this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class r1{constructor(){this.inputManager=null}init(t){return this.inputManager=new a1,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const Dl=new r1,Cl={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class ta{constructor(t,o,n=null){this.type=t,this.data=o,this.senderId=n,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const o=new ta(t.type,t.data,t.senderId);return o.timestamp=t.timestamp,o}}class c1{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,o){const n=new ta(t,o,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",n),this.messageQueue.push(n))}broadcast(t,o){this.send(t,o)}sendTo(t,o,n){const s=new ta(o,n,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,s)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const o of t)this.handleMessage(o);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Cl.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Cl.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,o){this.players.set(t,{id:t,...o,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:o})}removePlayer(t){const o=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:o})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,o){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(o)}off(t,o){if(this.eventHandlers.has(t)){const n=this.eventHandlers.get(t),s=n.indexOf(o);s>-1&&n.splice(s,1)}}emit(t,o,n=null){if(this.eventHandlers.has(t)){const s=this.eventHandlers.get(t);for(const a of s)a(o,n)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class l1{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new c1,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const d1=new l1;let Z={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null,rerollsRemaining:0,playersRevivedThisRun:new Set,isDailyRun:!1,dailyCharacter:null,dailySeed:null,dailyRNG:null},At={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},Ti=!1;function Rl(e,t,o=null){const n=o===null,s=n?Pt("startingHealth"):o?.startingHealth||0;s>0&&(t.maxHealth+=s*10,t.setHP(t.maxHealth));const a=n?Pt("startingDamage"):o?.startingDamage||0;a>0&&(t.projectileDamage+=a);const r=n?Pt("startingSpeed"):o?.startingSpeed||0;r>0&&(t.speed+=r*10)}function h1(e,t,o){const n=Bg();if(n.length!==0&&(o.activeBoosters=[],o.creditMultiplier=1,n.forEach(s=>{const a=Qd[s.key];if(!a||!a.effect)return;const r=a.effect;switch(r.type){case"startingHealth":t.maxHealth+=r.value,t.setHP(t.hp()+r.value);break;case"tempDamage":t.projectileDamage=Math.floor(t.projectileDamage*(1+r.value)),o.activeBoosters.push({type:"tempDamage",value:r.value,duration:r.duration});break;case"tempSpeed":t.speed=Math.floor(t.speed*(1+r.value)),t.originalSpeed=t.speed,o.activeBoosters.push({type:"tempSpeed",value:r.value,duration:r.duration});break;case"creditMultiplier":o.creditMultiplier=(o.creditMultiplier||1)+r.value;break;case"tempCrit":t.critChance=(t.critChance||0)+r.value,o.activeBoosters.push({type:"tempCrit",value:r.value,duration:r.duration});break;case"tempDefense":t.damageReduction=(t.damageReduction||0)+r.value,o.activeBoosters.push({type:"tempDefense",value:r.value,duration:r.duration});break;case"tempXP":t.xpMultiplier=(t.xpMultiplier||1)*(1+r.value),o.activeBoosters.push({type:"tempXP",value:r.value,duration:r.duration});break;case"autoRevive":t.autoRevive={health:r.value,uses:r.uses};break}}),n.length>0)){const s=e.add([e.text(`${n.length} Booster${n.length>1?"s":""} Active!`,{size:18}),e.pos(e.width()/2,100),e.anchor("center"),e.color(100,255,150),e.fixed(),e.z(2e3),e.opacity(1)]);e.wait(2,()=>{s.exists()&&e.tween(s.opacity,0,.5,a=>s.opacity=a,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)})})}}function u1(e){e.scene("game",t=>{if(ax(),t?.resetState){const v=d1.init("local");Dl.init(e),Tl.init("singleplayer").addPlayer(v,"survivor")}const o=Tl.getState();if(Kg(e),Wg(e),Yy(),e.paused=!1,t?.resetState){Z.currentFloor=1,Z.currentRoom=1,Z.playerStats=null,Z.allPlayerStats=null,Z.entryDirection=null,Z.floorMap=null,Z.playersRevivedThisRun=new Set,$x(),Z.isDailyRun=t?.isDailyRun||!1,Z.dailyCharacter=t?.dailyCharacter||null,Z.dailySeed=t?.dailySeed||null,Z.dailyRNG=Z.isDailyRun&&Z.dailySeed?new pn(Z.dailySeed):null,Z.isDailyRun&&console.log("[DailyRun] Starting daily run with character:",Z.dailyCharacter,"seed:",Z.dailySeed),At={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{},startTime:Date.now()},jx(e);const v=Pt("mulligan");Z.rerollsRemaining=v,Ti=!1,e.wait(1,()=>Lx(e)),e.gameData&&(e.gameData.weaponDetailSavedState=void 0)}let n=Z.currentFloor,s=Z.currentRoom;const a={updates:[],keyPresses:[]};let r=!1,l=!1;const c=[];let d=null;const i={enemies:new Ca(128),obstacles:new Ca(128),pickups:new Ca(128)};Ex(e),Mx();const h=Hn();function u(){if(Z.isDailyRun&&Z.dailySeed){const v=Z.dailySeed+n*1e4+s*100;return new pn(v)}else if(h>1)return bi();return null}const g=()=>{h>1&&(ay(n),console.log("[Multiplayer] Generating floor map with seed:",il()?"valid":"invalid (0)"));const v=h>1?cy():null;Z.floorMap=kx(n,v),Z.minimap&&Z.minimap.destroy(),Z.minimap=t1(e,Z.floorMap),e.gameData&&(e.gameData.minimap=Z.minimap)};!Z.floorMap||Z.floorMap.floor!==n?g():Z.minimap&&Z.minimap.update(),n>At.floorsReached&&(At.floorsReached=n);const p={1:"Public Access",2:"Local Affiliate",3:"Cable Network",4:"Premium Channel",5:"Streaming Giant",6:"Global Broadcast",7:"Galactic Signal"},T=v=>p[v]||`Network ${v}`;if(s===1){const v=e.add([e.text(`Floor ${n}`,{size:32}),e.pos(e.width()/2,e.height()/3),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.fixed(),e.z(3e3)]),W=e.add([e.text(T(n),{size:20}),e.pos(e.width()/2,e.height()/3+40),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.fixed(),e.z(3e3)]);e.wait(2,()=>{v.exists()&&v.onUpdate(()=>{v.opacity-=.02,v.opacity<=0&&e.destroy(v)}),W.exists()&&W.onUpdate(()=>{W.opacity-=.02,W.opacity<=0&&e.destroy(W)})})}const m=30;let M=e.width()/2,P=e.height()/2;if(Z.entryDirection)switch(Z.entryDirection){case"north":M=e.width()/2,P=m;break;case"south":M=e.width()/2,P=e.height()-m;break;case"west":M=m,P=e.height()/2;break;case"east":M=e.width()-m,P=e.height()/2;break}let f;const _=Z.isDailyRun?Z.dailyCharacter:null;if(Z.playerStats){f=Sa(e,M,P,_),Object.assign(f,Z.playerStats);const v=f.isRemote;if(f.isRemote=!1,v&&console.log("[Room Transition] Fixed isRemote flag - local player was incorrectly marked as remote"),f.setHP(Z.playerStats.currentHP||f.maxHealth),Z.playerStats.selectedUpgrades&&(f.selectedUpgrades=new Set(Z.playerStats.selectedUpgrades)),Z.playerStats.activeSynergies&&(f.activeSynergies=new Set(Z.playerStats.activeSynergies)),Z.playerStats.pendingLevelUps&&(f.pendingLevelUps=[...Z.playerStats.pendingLevelUps]),f.upgradeStacks&&Object.keys(f.upgradeStacks).length>0&&Ji(f),f.activeSynergies&&f.activeSynergies.size>0){bl(f);const W=Z.playerStats.currentHP||f.maxHealth;f.setHP(Math.min(W,f.maxHealth))}if((f.powerupWeapon==="orbital"||f.weaponKey==="orbital")&&(f.orbitalOrbs=[],f.orbitalAngles=[],f.orbitalNeedsReinit=!0),f.slowed=!1,f.isDead?(f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5)):(f.canMove=!0,f.canShoot=!0,f.opacity=1,f.outline&&f.outline.exists()&&(f.outline.opacity=1)),Z.equippedCosmetics){if(Z.equippedCosmetics.glow&&Z.equippedCosmetics.glow!=="glowNone"&&!f.isDead){const W=ls[Z.equippedCosmetics.glow];W&&W.color&&(f.glowEffect=yl(e,f,Z.equippedCosmetics.glow,W.color))}if(Z.equippedCosmetics.trail&&Z.equippedCosmetics.trail!=="trailNone"){const W=ls[Z.equippedCosmetics.trail];W&&(f.trailType=Z.equippedCosmetics.trail,f.trailColor=W.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}}}else{const v=Z.isDailyRun?Z.dailyCharacter:null;f=Sa(e,M,P,v),Rl(e,f),h1(e,f,Z);const W=Xg();if(Z.equippedCosmetics=W,W.glow&&W.glow!=="glowNone"){const q=ls[W.glow];q&&q.color&&(f.glowEffect=yl(e,f,W.glow,q.color))}if(W.trail&&W.trail!=="trailNone"){const q=ls[W.trail];q&&(f.trailType=W.trail,f.trailColor=q.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}f.runStats={kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}const B=fs(),b=nm();let S=new Array(B.maxSlots).fill(null);if(h>1&&b.isInitialized){const v=B.slots.findIndex(q=>q.isLocal);if(Xm(B.isHost,v,e),B.isHost){const q=bi(),X=qs(n,q);Z.roomTemplateKey=X.key,console.log("[Multiplayer] Host selected first room template:",X.key),dy(X.key)}B.isHost?g():iy(()=>{console.log("[Multiplayer] Client received seed, regenerating floor map"),g()}),f.slotIndex=v,f.playerName=B.slots[v].playerName;const W=v*30;f.pos.x=M+W,tl(v,f),S[v]=f,B.slots.forEach((q,X)=>{if(X!==v&&q.playerId!==null){const G=X*30,D=Sa(e,M+G,P,q.selectedCharacter);if(D.isRemote=!0,D.slotIndex=X,D.playerName=q.playerName,Z.allPlayerStats&&Z.allPlayerStats.length>0){const qe=Z.allPlayerStats.find(Le=>Le.slotIndex===X);if(qe){if(Object.assign(D,qe),D.isRemote=!0,D.setHP(qe.currentHP||D.maxHealth),qe.selectedUpgrades&&(D.selectedUpgrades=new Set(qe.selectedUpgrades)),qe.activeSynergies&&(D.activeSynergies=new Set(qe.activeSynergies)),qe.pendingLevelUps&&(D.pendingLevelUps=[...qe.pendingLevelUps]),D.upgradeStacks&&Object.keys(D.upgradeStacks).length>0&&Ji(D),D.activeSynergies&&D.activeSynergies.size>0){bl(D);const Le=qe.currentHP||D.maxHealth;D.setHP(Math.min(Le,D.maxHealth))}(D.powerupWeapon==="orbital"||D.weaponKey==="orbital")&&(D.orbitalOrbs=[],D.orbitalAngles=[],D.orbitalNeedsReinit=!0),D.slowed=!1,D.isDead?(D.canMove=!1,D.canShoot=!1,D.opacity=.5,D.outline&&D.outline.exists()&&(D.outline.opacity=.5)):(D.canMove=!0,D.canShoot=!0,D.opacity=1,D.outline&&D.outline.exists()&&(D.outline.opacity=1))}}else Rl(e,D,q.permanentUpgradeLevels);xl(e,D),vl(e,D,null,!0),tl(X,D),S[X]=D,B.isHost&&D.onDeath(()=>{if(D.isDead=!0,D.canMove=!1,D.canShoot=!1,D.opacity=.5,D.outline&&D.outline.exists()&&(D.outline.opacity=.5),!S.some(Le=>Le&&Le.exists()&&Le.hp()>0&&!Le.isDead)){const Le=Ea(At),xt={...At,level:f.level,currencyEarned:Le};va(xt),ds(Le),Si(e);const Xt=S.filter(qt=>qt&&qt.exists()).map(qt=>({name:qt.playerName||"Player",level:qt.level||1,characterData:qt.characterData,kills:qt.runStats?.kills||0,deaths:qt.runStats?.deaths||0,revives:qt.runStats?.revives||0,damageTaken:qt.runStats?.damageTaken||0,damageDealt:qt.runStats?.damageDealt||0,xpCollected:qt.runStats?.xpPickedUp||0,creditsPickedUp:qt.runStats?.creditsPickedUp||0,bossesKilled:qt.runStats?.bossesKilled||0}));de()&&(nl(At,Le,Xt),rs()),e.go("gameOver",{runStats:{...At},currencyEarned:Le,partyStats:Xt,isDailyRun:Z.isDailyRun,dailyCharacter:Z.dailyCharacter})}});const J=e.add([e.text(q.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]),pe=40,Je=4,Me=-40,_e=e.add([e.rect(pe,Je),e.pos(D.pos.x,D.pos.y+Me),e.anchor("center"),e.color(50,50,50),e.z(100),"playerHealthBar"]),De=e.add([e.rect(pe,Je),e.pos(D.pos.x,D.pos.y+Me),e.anchor("center"),e.color(100,255,100),e.z(101),"playerHealthBar"]);D.healthBarBg=_e,D.healthBar=De,_e.hidden=!0,De.hidden=!0,J.onUpdate(()=>{if(D.exists()){J.pos=e.vec2(D.pos.x,D.pos.y-30);const qe=D.hp()/D.maxHealth;if(qe<1&&qe>0){_e.hidden=!1,De.hidden=!1,_e.pos.x=D.pos.x,_e.pos.y=D.pos.y+Me,De.pos.x=D.pos.x,De.pos.y=D.pos.y+Me;const xt=Math.max(1,pe*qe);De.use(e.rect(xt,Je)),De.pos.x=D.pos.x-(pe-xt)/2}else _e.hidden=!0,De.hidden=!0}else J.destroy(),_e.exists()&&_e.destroy(),De.exists()&&De.destroy()})}}),me()||Ti||(Ti=!0,He("room_transition",q=>{if(Z.entryDirection=q.entryDirection,q.allPlayerStats){Z.allPlayerStats=q.allPlayerStats;const G=fs().slots.findIndex(J=>J.isLocal),D=q.allPlayerStats.find(J=>J&&J.slotIndex===G);D?(Z.playerStats=D,console.log("[Multiplayer] Client restored stats for slot",G,"level:",D.level)):console.warn("[Multiplayer] Client could not find stats for local slot",G,"in",q.allPlayerStats)}q.roomTemplateKey&&(Z.roomTemplateKey=q.roomTemplateKey,console.log("[Multiplayer] Client received room template:",q.roomTemplateKey)),q.currentFloor&&q.currentFloor!==Z.currentFloor?(console.log(`[Multiplayer] Floor advancement: ${Z.currentFloor} -> ${q.currentFloor}`),Z.currentFloor=q.currentFloor,Z.floorMap=null,Z.entryDirection=null):q.gridDirection&&Z.floorMap&&Z.floorMap.moveToRoom(q.gridDirection),!r&&(r=!0,Ia(),e.go("game"))}),He("room_completed",()=>{if(l=!0,d(),c.forEach(G=>{G.exists()&&!G.blocked&&(G.open=!0,G.isSpawnDoor=!1,G.updateVisual())}),N){const G=c.find(D=>D.direction==="north");G&&G.exists()&&(G.blocked=!1,G.open=!0,G.isSpawnDoor=!1,G.isFloorExit=!0,G.updateVisual())}Z.minimap&&Z.minimap.update();const q=N?`BOSS DEFEATED! Floor ${n} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",X=e.add([e.text(q,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{X.exists()&&e.destroy(X)})}),He("obstacle_data",q=>{console.log("[Multiplayer] Client received obstacle data:",q.obstacles.length,"obstacles"),e.get("obstacle").forEach(X=>e.destroy(X)),q.obstacles.forEach(X=>{const G=Array.isArray(X.color)?e.rgb(X.color[0],X.color[1],X.color[2]):X.color;ll(e,X.x,X.y,X.width,X.height,X.type,X.char,G)})}),He("door_states",q=>{console.log("[Multiplayer] Client received door states:",q),typeof c<"u"&&c.length>0&&c.forEach(X=>{q.hasOwnProperty(X.direction)&&(X.blocked=q[X.direction],X.updateVisual())})}),He("game_over",q=>{const X=q.currencyEarned||Ea(q.runStats||At),G={...q.runStats||At,level:f.level,currencyEarned:X};va(G),ds(X),Si(e),rs(),e.go("gameOver",{runStats:{...q.runStats||At},currencyEarned:X,partyStats:q.partyStats||[],isDailyRun:Z.isDailyRun,dailyCharacter:Z.dailyCharacter})}),He("powerup_weapon_applied",q=>{S.forEach(X=>{!X||!X.exists()||Ma(X,q.powerupKey)})}),He("upgrade_selected",q=>{if(q.slotIndex===v)return;const X=S.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&(qr(X,q.upgradeKey),Uh(X,q.upgradeKey),zi(e,X))}),He("level_up_queued",q=>{if(q.slotIndex===v)return;const X=S.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&(X.level=q.level,X.pendingLevelUps||(X.pendingLevelUps=[]),X.pendingLevelUps.includes(q.level)||X.pendingLevelUps.push(q.level))}),He("synergy_activated",q=>{if(q.slotIndex===v)return;const X=S.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&zi(e,X)}),He("powerup_expired",q=>{const X=S.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&cr(X)}),He("player_healed",q=>{const X=S.find(G=>G.slotIndex===q.slotIndex);X&&X.exists()&&X.setHP(q.newHP)}),He("player_dodged",q=>{const X=S.find(G=>G.slotIndex===q.slotIndex);if(X&&X.exists()){const G=e.add([e.text("DODGE!",{size:14}),e.pos(q.x,q.y-30),e.anchor("center"),e.color(100,200,255),e.opacity(1),e.z(500)]);let D=0;G.onUpdate(()=>{D+=e.dt(),G.pos.y-=30*e.dt(),G.opacity=Math.max(0,1-D/.8),D>=.8&&e.destroy(G)})}}))}else f.slotIndex=0,S[0]=f;S.filter(v=>v!==null);function E(v,W){if(!v||!v.exists())return;const q=W==="exclamation"?"!":"",X=W==="exclamation"?[255,255,0]:[255,100,150],G=e.add([e.text(q,{size:24}),e.pos(v.pos.x,v.pos.y-50),e.anchor("center"),e.color(...X),e.opacity(1),e.scale(1),e.z(1e3),"emote"]);let D=0;const J=1.5;G.onUpdate(()=>{D+=e.dt(),G.pos.x=v.pos.x,G.pos.y=v.pos.y-50-D*30,D<.2?G.scale=e.vec2(1+D*2):G.scale=e.vec2(1.4-(D-.2)*.3),D>J*.6&&(G.opacity=1-(D-J*.6)/(J*.4)),D>=J&&e.destroy(G)})}let C=0;const A=.1;e.onKeyPress("q",()=>{if(f.isDead)return;const v=e.time();v-C<A||(C=v,E(f,"exclamation"),de()&&al(f.slotIndex,"exclamation"))}),e.onKeyPress("e",()=>{if(f.isDead)return;const v=e.time();v-C<A||(C=v,E(f,"heart"),de()&&al(f.slotIndex,"heart"))}),h>1&&He("player_emote",v=>{const W=S[v.slotIndex];W&&W.exists()&&E(W,v.emoteType)});const z=o.localPlayerId,R=o.getPlayer(z);R&&(R.x=f.pos.x,R.y=f.pos.y,R.health=f.hp(),R.maxHealth=f.maxHealth,R.speed=f.speed,R.level=f.level,R.xp=f.xp,R.xpToNext=f.xpToNext,R.xpMultiplier=f.xpMultiplier||1,R.weaponKey="pistol",R.fireRate=f.fireRate,R.projectileSpeed=f.projectileSpeed,R.projectileDamage=f.projectileDamage,R.projectileCount=f.projectileCount||1,R.piercing=f.piercing||0,R.obstaclePiercing=f.obstaclePiercing||0,R.critChance=f.critChance||.05,R.critDamage=f.critDamage||2,R.spreadAngle=f.spreadAngle||0,R.weaponRange=f.weaponRange||600,R.pickupRadius=f.pickupRadius,R.defense=f.defense||0,R.damageReduction=f.damageReduction||0,R.dodgeChance=f.dodgeChance||0),d=()=>{if(h<=1)return;const v=Pt("secondWind");if(v<=0)return;let W=0;S.forEach((q,X)=>{if(q&&(q.exists()&&q.hp()<=0||q.exists()&&q.isDead)){const G=`player_${X}`;if(Z.playersRevivedThisRun.has(G))return;Z.playersRevivedThisRun.add(G);const D=.05+v*.05,J=Math.max(1,Math.floor(q.maxHealth*D));q.setHP(J),q.isDead=!1,q.canMove=!0,q.canShoot=!0;const pe=Math.round(D*100),Je=e.add([e.text(` REVIVED (${pe}% HP) `,{size:16}),e.pos(q.pos.x,q.pos.y-40),e.anchor("center"),e.color(100,255,100),e.opacity(1),e.lifespan(2),e.z(1e3)]);Je.onUpdate(()=>{Je.pos.y-=30*e.dt(),Je.opacity-=.5*e.dt()}),q.opacity=1,q.characterData&&q.characterData.color&&(q.color=e.rgb(...q.characterData.color)),q.outline&&q.outline.exists()&&(q.outline.opacity=1),W++}}),W>0&&e.get("projectile").forEach(q=>{(q.isEnemyProjectile||q.isBossProjectile)&&e.destroy(q)}),W>0&&de()&&me()&&km()},xl(e,f);const Y=vl(e,f,d,h>1);if(f.isDead||(f.canMove=!0,f.canShoot=!0),h>1){const v=xy();v>0&&f.addXP&&(console.log("[Multiplayer] Applying pending XP:",v),f.addXP(v))}Z.playerStats&&Z.playerStats.selectedUpgrades&&e.wait(.1,()=>{zi(e,f)});const U=Z.floorMap.getCurrentRoom(),N=U?U.isBossRoom:s===3;let H;if(h>1&&Z.roomTemplateKey)H=Sl(Z.roomTemplateKey),console.log("[Multiplayer] Using synced template:",Z.roomTemplateKey),Z.roomTemplateKey=null;else if(h>1&&!il()){const v=ry();if(v)H=Sl(v),console.log("[Multiplayer] Client using first room template:",v);else{console.warn("[Multiplayer] No seed or template key available, using fallback");const W=bi();H=qs(n,W)}}else U&&U.template?H=U.template:H=qs(n,u());const I=Vx(e,n),F=20;s1(e,n,e.width(),e.height()),e.add([e.rect(e.width()-F*2,2),e.pos(e.width()/2,F),e.anchor("center"),e.color(I.wallColor),e.fixed()]),e.add([e.rect(e.width()-F*2,2),e.pos(e.width()/2,e.height()-F),e.anchor("center"),e.color(I.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-F*2),e.pos(F,e.height()/2),e.anchor("center"),e.color(I.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-F*2),e.pos(e.width()-F,e.height()/2),e.anchor("center"),e.color(I.wallColor),e.fixed()]);const V=s===1&&n===1,j=80;let ce=e.width()/2,ie=e.height()/2;if(Z.entryDirection)switch(Z.entryDirection){case"north":ce=e.width()/2,ie=m;break;case"south":ce=e.width()/2,ie=e.height()-m;break;case"west":ce=m,ie=e.height()/2;break;case"east":ce=e.width()-m,ie=e.height()/2;break}const ne=[],se=[],ge=h<=1||me();!V&&ge&&(H.obstacles.forEach(v=>{const W=Math.sqrt(Math.pow(v.x-M,2)+Math.pow(v.y-P,2)),q=Math.sqrt(Math.pow(v.x-ce,2)+Math.pow(v.y-ie,2)),X=Math.max(v.width,v.height)/2;if(W<j+X||q<j+X)return;const G=Kx(v.x,v.y,v.width,v.height),D=v.type==="wall"?I.obstacleColor:I.coverColor,J=ll(e,G.x,G.y,v.width,v.height,v.type,v.char||"#",D);if(ne.push(J),h>1&&me()){let pe=null;D&&(Array.isArray(D)?pe=D:D.r!==void 0&&(pe=[D.r,D.g,D.b])),se.push({x:G.x,y:G.y,width:v.width,height:v.height,type:v.type,char:v.char||"#",color:pe})}}),h>1&&me()&&e.wait(.1,()=>{py(se)})),!V&&!N&&ge&&Wx(H.key,u(),n).forEach(W=>{const q=Math.sqrt(Math.pow(W.x-M,2)+Math.pow(W.y-P,2)),X=Math.sqrt(Math.pow(W.x-ce,2)+Math.pow(W.y-ie,2));if(q<j+25||X<j+25)return;let G=!1;ne.forEach(D=>{if(!D.exists())return;Math.sqrt(Math.pow(W.x-D.pos.x,2)+Math.pow(W.y-D.pos.y,2))<50&&(G=!0)}),G||Ny(e,W.x,W.y)}),e.add([e.rect(82,22),e.pos(8,2),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(w.UI_BG)]);const ve=e.add([e.text("",{size:Q.HUD}),e.pos(20,6),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT)]),Oe=e.add([e.text("0/0",{size:Q.HUD}),e.pos(40,6),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT)]);e.add([e.rect(85,22),e.pos(e.width()-10,2),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(w.UI_BG-1)]),e.add([e.text("$",{size:Q.LABEL}),e.pos(e.width()-20,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);const Ee=e.add([e.text("0",{size:Q.HUD}),e.pos(e.width()-40,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);if(de()){const v=jm(),W=b.isHost?[100,255,100]:[100,200,255],q=b.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...W),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(`${q} (${v}P)`,{size:Q.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...W),e.fixed(),e.z(w.UI_TEXT)])}const Ne=e.width()-40,et=15,Te=e.height()-18;e.add([e.rect(Ne,et),e.pos(20,Te),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.UI_BG)]);const Mt=f.xpToNext>0?f.xp/f.xpToNext:0,fe=Math.max(0,(Ne-34)*Mt),Ce=e.add([e.rect(fe,et-4),e.pos(58,Te+2),e.color(100,200,255),e.fixed(),e.z(w.UI_BG+1)]),le=e.add([e.text(Qc(f.xp||0,f.xpToNext||10),{size:Q.SMALL-2}),e.pos(e.width()/2,Te+et/2),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),Re=36,Xe=20+Re/2,Se=Te+et/2;e.add([e.circle(Re/2),e.pos(Xe,Se),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(w.UI_BG+2)]);const it=e.add([e.text(`${f.level||1}`,{size:Q.BODY}),e.pos(Xe,Se),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_BG+3)]),We=40,Et=8,Ct=25,Pe=e.add([e.rect(We,Et),e.pos(0,0),e.anchor("center"),e.color(...y.BG_DARK),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.z(w.OVERLAY)]),Fe=e.add([e.rect(We-2,Et-2),e.pos(0,0),e.anchor("center"),e.color(100,255,100),e.z(w.OVERLAY+1)]);Pe.hidden=!0,Fe.hidden=!0;const Ae=48,Ie=25,Ye=e.height()-85,je=e.add([e.rect(Ae,Ae),e.pos(Ie,Ye),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(w.UI_BG)]),lt=e.add([e.text("",{size:32}),e.pos(Ie+Ae/2,Ye+Ae/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),dt=220,rt=90,gt=e.add([e.rect(dt,rt),e.pos(Ie,Ye-rt-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(w.OVERLAY+5)]),ht=e.add([e.text("",{size:24}),e.pos(Ie+15,Ye-rt-10+15),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+6)]),Bt=e.add([e.text("Basic Pistol",{size:Q.SMALL,width:160}),e.pos(Ie+50,Ye-rt-10+10),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+6)]),Tt=e.add([e.text("DMG: 10",{size:Q.SMALL-2}),e.pos(Ie+50,Ye-rt-10+30),e.color(255,150,150),e.fixed(),e.z(w.OVERLAY+6)]),yt=e.add([e.text("RATE: 3.75/s",{size:Q.SMALL-2}),e.pos(Ie+50,Ye-rt-10+47),e.color(150,200,255),e.fixed(),e.z(w.OVERLAY+6)]),Rt=e.add([e.text("DPS: 37.5",{size:Q.SMALL-2}),e.pos(Ie+50,Ye-rt-10+64),e.color(255,255,150),e.fixed(),e.z(w.OVERLAY+6)]);gt.hidden=!0,ht.hidden=!0,Bt.hidden=!0,Tt.hidden=!0,yt.hidden=!0,Rt.hidden=!0;let Ge=!1;t?.resetState&&(Ge=!1),je.onClick(()=>{Ge=!Ge,gt.hidden=!gt.hidden,ht.hidden=!ht.hidden,Bt.hidden=!Bt.hidden,Tt.hidden=!Tt.hidden,yt.hidden=!yt.hidden,Rt.hidden=!Rt.hidden});const Dt=40,xe=Ie,at=Ye-Dt-10,ae=e.add([e.rect(Dt,Dt),e.pos(xe,at),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(w.UI_BG)]),Be=e.add([e.text("",{size:28}),e.pos(xe+Dt/2,at+Dt/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),tt=e.add([e.text("20",{size:14}),e.pos(xe+Dt+5,at+Dt/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(w.UI_TEXT)]);ae.hidden=!0,Be.hidden=!0,tt.hidden=!0;const ot=Ie+Ae+10,L=Ye,K=32,ee=40,ue=[];function nt(){if(ue.forEach(W=>{W.exists()&&e.destroy(W)}),ue.length=0,!f.exists())return;const v=[];f.upgradeStacks&&Object.entries(f.upgradeStacks).forEach(([W,q])=>{q>0&&v.push({key:W,stacks:q})}),v.forEach((W,q)=>{const X=ot+q*ee,G=gs[W.key];if(!G)return;const D=e.add([e.rect(K,K),e.pos(X,L),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(w.UI_BG)]),J=e.add([e.text(G.icon,{size:20}),e.pos(X+K/2,L+K/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),pe=e.add([e.text(W.stacks.toString(),{size:10}),e.pos(X+K-4,L+K-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(w.UI_TEXT+1)]);ue.push(D,J,pe)})}const st=50,Lt=e.width()-st-25,ct=e.height()-st-25,bt=e.add([e.rect(st,st),e.pos(Lt,ct),e.color(100,200,255),e.opacity(.9),e.outline(3,e.rgb(255,255,255)),e.area(),e.fixed(),e.z(w.OVERLAY+5)]),ye=e.add([e.text("+",{size:36}),e.pos(Lt+st/2,ct+st/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+6)]),we=20,re=Lt+st-we/2,he=ct-we/2,be=e.add([e.circle(we/2),e.pos(re,he),e.anchor("center"),e.color(255,50,50),e.outline(2,e.rgb(255,255,255)),e.fixed(),e.z(w.OVERLAY+7)]),Ze=e.add([e.text("2",{size:12}),e.pos(re,he),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+8)]);bt.hidden=!0,ye.hidden=!0,be.hidden=!0,Ze.hidden=!0,bt.onClick(()=>{Y&&f.pendingLevelUps&&f.pendingLevelUps.length>0&&Y.processPendingLevelUp()});let ut=0;bt.onUpdate(()=>{if(bt.hidden)return;ut+=e.dt()*4;const v=(Math.sin(ut)+1)/2,W=3+v*3,q=200+v*55;bt.outline.width=W,bt.outline.color=e.rgb(q,q,100+v*155);const X=1+v*.05;bt.scale=e.vec2(X,X),ye.scale=e.vec2(X,X)});const $e=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(w.OVERLAY+10)]),Qe=e.add([e.text("",{size:Q.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(w.OVERLAY+11)]);$e.hidden=!0,Qe.hidden=!0;const ho={level:()=>`Level ${f.level}
XP: ${f.xp}/${f.xpToNext}
Progress: ${Math.floor(f.xp/f.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${At.enemiesKilled}`),currency:()=>`Total Credits: ${$n()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const v=f.weaponDef;return v?`${v.name}
Damage: ${f.projectileDamage}
Fire Rate: ${f.fireRate.toFixed(2)}/s
DPS: ${(f.projectileDamage*f.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(f.hp())}/${f.maxHealth}
Damage Reduction: ${Math.floor(f.damageReduction*100)}%`};function It(v,W,q){const X=ho[v];if(!X)return;const G=X();Qe.text=G,$e.pos.x=Math.min(W+10,e.width()-210),$e.pos.y=Math.min(q+10,e.height()-70),Qe.pos.x=$e.pos.x+5,Qe.pos.y=$e.pos.y+5,$e.hidden=!1,Qe.hidden=!1}function Zt(){$e.hidden=!0,Qe.hidden=!0}function Io(){return{hidden:$e.hidden,text:Qe.text,tooltipX:$e.pos.x,tooltipY:$e.pos.y,textX:Qe.pos.x,textY:Qe.pos.y}}function wo(v){v&&($e.hidden=v.hidden,Qe.hidden=v.hidden,Qe.text=v.text,$e.pos.x=v.tooltipX,$e.pos.y=v.tooltipY,Qe.pos.x=v.textX,Qe.pos.y=v.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=Zt,e.gameData.saveTooltipState=Io,e.gameData.restoreTooltipState=wo,e.gameData.minimap=Z.minimap,My(e),e.gameData.spatialGrids=i,e.gameData.alivePlayers=[],e.gameData.additionalEnemiesFromSplits=0,e.gameData.incrementSplitEnemies=v=>{hi+=v,e.gameData.additionalEnemiesFromSplits=hi},e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,a.updates.push(e.onUpdate(()=>{e.gameData.alivePlayers=e.get("player").filter(v=>!v.isDead&&v.exists()),i.enemies.clear(),e.get("enemy").forEach(v=>i.enemies.insert(v)),e.get("boss").forEach(v=>i.enemies.insert(v)),e.get("miniboss").forEach(v=>i.enemies.insert(v)),i.pickups.clear(),e.get("xpPickup").forEach(v=>i.pickups.insert(v)),e.get("currencyPickup").forEach(v=>i.pickups.insert(v)),e.get("powerupWeaponPickup").forEach(v=>i.pickups.insert(v))})),a.updates.push(e.onUpdate(()=>{Ax(e.dt())})),a.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const v=e.dt();if(f.berserkerEnabled){const q=f.hp()/f.maxHealth<(f.berserkerThreshold||.3),X=1+(f.berserkerSpeedBonus||.5),G=1+(f.berserkerDamageBonus||.5);q&&!f.berserkerActive?(f.berserkerActive=!0,f.speed=Math.floor(f.speed*X),f.projectileDamage=Math.floor(f.projectileDamage*G)):!q&&f.berserkerActive&&(f.berserkerActive=!1,f.speed=Math.floor(f.speed/X),f.projectileDamage=Math.floor(f.projectileDamage/G))}if(f.survivalistEnabled){const W=e.time()-(f.survivalistLastCombatTime||0),q=f.survivalistCombatCooldown||3;if(W>=q&&f.hp()<f.maxHealth){const X=f.survivalistRegenPercent||.01,G=f.maxHealth*X*v;if(f.survivalistRegenAccum=(f.survivalistRegenAccum||0)+G,f.survivalistRegenAccum>=1){const D=Math.floor(f.survivalistRegenAccum);f.survivalistRegenAccum-=D;const J=Math.min(f.maxHealth,f.hp()+D);f.setHP(J),de()&&me()&&mh({slotIndex:f.slotIndex,healAmount:D,newHP:J,source:"survivalist"})}}}})),a.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const v=e.dt();if(f.glowEffect&&ux(e,f.glowEffect),f.trailType&&f.trailColor){f.trailTimer=(f.trailTimer||0)+v;const W=.05,q=f.pos.x-(f.lastTrailPos?.x||f.pos.x),X=f.pos.y-(f.lastTrailPos?.y||f.pos.y),G=Math.sqrt(q*q+X*X);f.trailTimer>=W&&G>2&&(dx(e,f.pos.x,f.pos.y,f.trailType,f.trailColor),f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}})),a.updates.push(e.onUpdate(()=>{if(e.paused||Ei())return;const v=e.mousePos();let W=!1;v.x>=20&&v.x<=180&&v.y>=20&&v.y<=35?(It("level",v.x,v.y),W=!0):v.x>=20&&v.x<=180&&v.y>=40&&v.y<=55&&!Oe.hidden?(It("enemies",v.x,v.y),W=!0):v.x>=e.width()-130&&v.x<=e.width()-10&&v.y>=10&&v.y<=50?(It("currency",v.x,v.y),W=!0):v.x>=Ie&&v.x<=Ie+Ae&&v.y>=Ye&&v.y<=Ye+Ae&&(It("weapon",v.x,v.y),W=!0),W||Zt()}));const fo=e.add([e.text("",{size:Q.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...y.BOSS_NAME),e.fixed(),e.z(w.OVERLAY)]),Wo=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.OVERLAY)]),Nt=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.HEALTH_LOW),e.fixed(),e.z(w.OVERLAY+1)]),$o=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.OVERLAY)]),ao=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.OVERLAY+1)]),rn=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]),bo=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]),yn=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.OVERLAY)]),po=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.XP_BAR),e.fixed(),e.z(w.OVERLAY+1)]),No=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]);fo.hidden=!0,Wo.hidden=!0,Nt.hidden=!0,$o.hidden=!0,ao.hidden=!0,rn.hidden=!0,bo.hidden=!0,yn.hidden=!0,po.hidden=!0,No.hidden=!0,a.updates.push(e.onUpdate(()=>{e.paused||lx(e)})),a.updates.push(e.onUpdate(()=>{e.paused||de()&&Km(e.dt())})),a.updates.push(e.onUpdate(()=>{const v=f.exists()?f.hp():0,W=f.maxHealth>0?v/f.maxHealth:1;it.text=`${f.level||1}`;const q=f.xpToNext>0?f.xp/f.xpToNext:0;if(Ce.width=Math.max(0,(Ne-34)*q),le.text=Qc(f.xp,f.xpToNext),Ee.text=$n().toString(),W<1&&f.exists()){Pe.hidden=!1,Fe.hidden=!1;const D=f.pos.x,J=f.pos.y+Ct;Pe.pos=e.vec2(D,J);const pe=Math.max(1,(We-2)*W);Fe.use(e.rect(pe,Et-2));const Je=D-We/2+1+pe/2;Fe.pos=e.vec2(Je,J),W>.6?Fe.color=e.rgb(100,255,100):W>.3?Fe.color=e.rgb(255,200,0):Fe.color=e.rgb(255,50,50)}else Pe.hidden=!0,Fe.hidden=!0;if(!N&&!l){const D=e.get("enemy").length,J=As+hi+(Ss?1:0),pe=e.get("miniboss").length,Je=D+pe+Math.max(0,J-es-hi-(Ss&&fa?1:0));Oe.text=`${Je}/${J}`,Oe.hidden=!1,ve.hidden=!1}else Oe.hidden=!0,ve.hidden=!0;if(f.exists()&&f.weaponDef){const D=f.weaponDef,J=(f.projectileDamage*f.fireRate).toFixed(1);lt.text=D.icon||"",lt.color=e.rgb(...D.color),ht.text=D.icon||"",ht.color=e.rgb(...D.color),Bt.text=D.name,Bt.color=e.rgb(...y.TEXT_PRIMARY),Tt.text=`DMG: ${f.projectileDamage}`,yt.text=`RATE: ${f.fireRate.toFixed(2)}/s`,Rt.text=`DPS: ${J}`,e.paused&&!Sx()?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Ge),gt.hidden=!1,ht.hidden=!1,Bt.hidden=!1,Tt.hidden=!1,yt.hidden=!1,Rt.hidden=!1):(gt.hidden=!Ge,ht.hidden=!Ge,Bt.hidden=!Ge,Tt.hidden=!Ge,yt.hidden=!Ge,Rt.hidden=!Ge)}if(f.exists()){Sm(f,e.dt());const D=Tm(f);D?(ae.hidden=!1,Be.hidden=!1,tt.hidden=!1,Be.text=D.icon,Be.color=e.rgb(...D.color),ae.outline.color=e.rgb(...D.color),D.isAmmoBased?tt.text=`${D.ammo}`:D.isTimeBased&&(tt.text=`${Math.ceil(D.duration)}s`)):(ae.hidden=!0,Be.hidden=!0,tt.hidden=!0)}if(e.time()%.5<e.dt()&&nt(),f.exists()&&f.pendingLevelUps&&f.pendingLevelUps.length>0){bt.hidden=!1,ye.hidden=!1;const D=f.pendingLevelUps.length;D>1?(be.hidden=!1,Ze.hidden=!1,Ze.text=D.toString()):(be.hidden=!0,Ze.hidden=!0)}else bt.hidden=!0,ye.hidden=!0,be.hidden=!0,Ze.hidden=!0;const X=e.get("boss"),G=X.filter(D=>D.type==="twinGuardianMelee"||D.type==="twinGuardianRanged");if(G.length>0){const D=G.find(pe=>pe.type==="twinGuardianMelee"),J=G.find(pe=>pe.type==="twinGuardianRanged");if(D&&J&&(D.exists()||J.exists())){fo.hidden=!1,fo.text="THE CO-HOSTS";const pe=D.exists()?D.hp():0,Je=J.exists()?J.hp():0,Me=pe+Je,_e=(D.maxHealth||0)+(J.maxHealth||0),De=_e>0?Math.max(0,Math.min(1,Me/_e)):0;Nt.width=296*De,Nt.pos.x=e.width()/2-296*(1-De)/2,rn.text=`${Math.max(0,Math.floor(Me))}/${_e}`,Wo.hidden=!1,Nt.hidden=!1,rn.hidden=!1;const qe=D.exists()&&D.shieldHealth||0,Le=J.exists()&&J.shieldHealth||0,xt=qe+Le,Xt=(D.maxShieldHealth||0)+(J.maxShieldHealth||0);if(Xt>0){const Ts=Math.max(0,Math.min(1,xt/Xt));po.width=296*Ts,po.pos.x=e.width()/2-296*(1-Ts)/2,No.text=`Shield: ${Math.max(0,Math.floor(xt))}/${Xt}`,yn.hidden=!1,po.hidden=!1,No.hidden=!1}else yn.hidden=!0,po.hidden=!0,No.hidden=!0;const qt=D.exists()&&D.armorHealth||0,wn=J.exists()&&J.armorHealth||0,gi=qt+wn,ya=(D.maxArmorHealth||0)+(J.maxArmorHealth||0);if(ya>0){const Ts=Math.max(0,Math.min(1,gi/ya));ao.width=296*Ts,ao.pos.x=e.width()/2-296*(1-Ts)/2,bo.text=`Armor: ${Math.max(0,Math.floor(gi))}/${ya}`,$o.hidden=!1,ao.hidden=!1,bo.hidden=!1}else $o.hidden=!0,ao.hidden=!0,bo.hidden=!0;De>.6?Nt.color=e.rgb(255,50,50):De>.3?Nt.color=e.rgb(255,150,50):Nt.color=e.rgb(255,200,0)}else{const pe=D?.exists()?D:J;if(pe){const Je=pe.hp(),Me=pe.maxHealth,_e=pe.shieldHealth||0,De=pe.maxShieldHealth||0,qe=pe.armorHealth||0,Le=pe.maxArmorHealth||0;fo.hidden=!1,fo.text=pe.enraged?"THE CO-HOSTS (ENRAGED)":"THE CO-HOSTS";const xt=Math.max(0,Math.min(1,Je/Me));if(Nt.width=296*xt,Nt.pos.x=e.width()/2-296*(1-xt)/2,rn.text=`${Math.max(0,Math.floor(Je))}/${Me}`,Wo.hidden=!1,Nt.hidden=!1,rn.hidden=!1,De>0){const Xt=Math.max(0,Math.min(1,_e/De));po.width=296*Xt,po.pos.x=e.width()/2-296*(1-Xt)/2,No.text=`Shield: ${Math.max(0,Math.floor(_e))}/${De}`,yn.hidden=!1,po.hidden=!1,No.hidden=!1}else yn.hidden=!0,po.hidden=!0,No.hidden=!0;if(Le>0){const Xt=Math.max(0,Math.min(1,qe/Le));ao.width=296*Xt,ao.pos.x=e.width()/2-296*(1-Xt)/2,bo.text=`Armor: ${Math.max(0,Math.floor(qe))}/${Le}`,$o.hidden=!1,ao.hidden=!1,bo.hidden=!1}else $o.hidden=!0,ao.hidden=!0,bo.hidden=!0;xt>.6?Nt.color=e.rgb(255,50,50):xt>.3?Nt.color=e.rgb(255,150,50):Nt.color=e.rgb(255,200,0)}else fo.hidden=!0,Wo.hidden=!0,Nt.hidden=!0,$o.hidden=!0,ao.hidden=!0,rn.hidden=!0,bo.hidden=!0}}else if(X.length>0&&X[0].exists()){const D=X[0],J=D.hp(),pe=D.maxHealth,Je=D.shieldHealth||0,Me=D.maxShieldHealth||0,_e=D.armorHealth||0,De=D.maxArmorHealth||0;let qe="BOSS";D.type==="twinGuardianMelee"||D.type==="twinGuardianRanged"?qe="THE CO-HOSTS":tn[D.type]?.name&&(qe=`THE ${tn[D.type].name.toUpperCase()}`),fo.hidden=!1,Wo.hidden=!1,Nt.hidden=!1,$o.hidden=!1,ao.hidden=!1,rn.hidden=!1,bo.hidden=!1,fo.text=qe;const Le=Math.max(0,Math.min(1,J/pe));if(Nt.width=296*Le,Nt.pos.x=e.width()/2-296*(1-Le)/2,rn.text=`${Math.max(0,Math.floor(J))}/${pe}`,Me>0){const xt=Math.max(0,Math.min(1,Je/Me));po.width=296*xt,po.pos.x=e.width()/2-296*(1-xt)/2,No.text=`Shield: ${Math.max(0,Math.floor(Je))}/${Me}`,yn.hidden=!1,po.hidden=!1,No.hidden=!1}else yn.hidden=!0,po.hidden=!0,No.hidden=!0;if(De>0){const xt=Math.max(0,Math.min(1,_e/De));ao.width=296*xt,ao.pos.x=e.width()/2-296*(1-xt)/2,bo.text=`Armor: ${Math.max(0,Math.floor(_e))}/${De}`,$o.hidden=!1,ao.hidden=!1,bo.hidden=!1}else $o.hidden=!0,ao.hidden=!0,bo.hidden=!0;Le>.6?Nt.color=e.rgb(255,50,50):Le>.3?Nt.color=e.rgb(255,150,50):Nt.color=e.rgb(255,200,0)}else fo.hidden=!0,Wo.hidden=!0,Nt.hidden=!0,$o.hidden=!0,ao.hidden=!0,rn.hidden=!0,bo.hidden=!0,yn.hidden=!0,po.hidden=!0,No.hidden=!0})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const v=o.getPlayer(z);v&&(v.x=f.pos.x,v.y=f.pos.y,v.velocityX=0,v.velocityY=0,v.health=f.hp(),v.maxHealth=f.maxHealth,v.level=f.level,v.xp=f.xp,v.xpToNext=f.xpToNext,v.projectileDamage=f.projectileDamage,v.fireRate=f.fireRate,v.projectileSpeed=f.projectileSpeed,v.projectileCount=f.projectileCount||1,v.piercing=f.piercing||0,v.critChance=f.critChance||.05,v.critDamage=f.critDamage||2,v.pickupRadius=f.pickupRadius,v.defense=f.defense||0,v.isDead=f.isDead||!f.exists()||f.hp()<=0,v.invulnerable=f.invulnerable||!1,o.updateTime(e.dt()))})),o.currentFloor=n,o.currentRoom=s,o.roomCleared=!1,a.updates.push(e.onUpdate(()=>{if(e.paused)return;Dl.getManager().getInputsForFrame([z]).get(z)}));let As=N?0:24+(n-1)*6,es=0,Jh=2,ac=!1,fa=!1,Ss=!1,jh=4,pa=0,hi=0;const rc=u()||new pn(Date.now());if(!N&&s!==1){const v=.15+(n-1)*.05;Ss=rc.next()<v}Ss&&(As=Math.floor(As*.5));function Zh(v,W){const q=["brute","sentinel","berserker","guardian","warlock"];if(v>=3)return q[W.range(0,q.length)];{const X=["brute","berserker","guardian"];return X[W.range(0,X.length)]}}function Qh(v){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[v]||"gatekeeper"}const kh=[{x:e.width()/2,y:m,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-m,direction:"south",gridDir:"down"},{x:m,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-m,y:e.height()/2,direction:"east",gridDir:"right"}],eu=Z.floorMap?Z.floorMap.getAvailableExits():[],tu=new Set(eu.map(v=>v.direction));kh.forEach(v=>{const W=Hy(e,v.x,v.y,v.direction);W.open=!1,W.isSpawnDoor=!0,W.gridDirection=v.gridDir,(v.gridDir===null||!tu.has(v.gridDir))&&(W.blocked=!0),W.updateVisual(),c.push(W)}),h>1&&me()&&e.wait(.1,()=>{const v={};c.forEach(W=>{v[W.direction]=W.blocked}),Ke("door_states",v)});let ui=0;const ou=.33;let cc=!1;a.updates.push(e.onUpdate(()=>{if(e.paused||l)return;if(cc||(pa=e.time(),cc=!0),N){if(!ac&&(!de()||me())){ac=!0;const G=Qh(n),D=u();if(G==="twinGuardian"){const J=c.filter(De=>De.direction!==Z.entryDirection);let pe,Je;if(J.length>=2){const De=[...J];for(let Le=De.length-1;Le>0;Le--){const xt=D?D.range(0,Le+1):Math.floor(Math.random()*(Le+1));[De[Le],De[xt]]=[De[xt],De[Le]]}pe=De[0];const qe={north:"south",south:"north",east:"west",west:"east"};Je=J.find(Le=>Le.direction===qe[pe.direction])||De[1]}else pe=c[0],Je=c[c.length>1?1:0];const Me=Em(e,pe,Je,n,D);de()&&me()&&(Array.isArray(Me)?Me.forEach(De=>{Xo(De,{type:"twinGuardian",floor:n})}):Me&&Xo(Me,{type:"twinGuardian",floor:n})),pl();const _e=e.add([e.text("THE CO-HOSTS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{_e.exists()&&e.destroy(_e)})}else{let J=c.find(qe=>qe.direction==="north");if(!J||Z.entryDirection==="north"&&c.length>1){const qe=c.filter(Le=>Le.direction!==Z.entryDirection);if(qe.length>0){const Le=D?D.range(0,qe.length):Math.floor(Math.random()*qe.length);J=qe[Le]}else{const Le=D?D.range(0,c.length):Math.floor(Math.random()*c.length);J=c[Le]}}const pe=J?J.pos.x:e.width()/2,Je=J?J.pos.y:e.height()/2,Me=$i(e,pe,Je,G,n,D);de()&&me()&&Xo(Me,{type:G,floor:n,isBoss:!0}),pl();let _e="BOSS";G==="twinGuardian"?_e="THE CO-HOSTS":tn[G]?.name&&(_e=`THE ${tn[G].name.toUpperCase()}`);const De=e.add([e.text(_e,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{De.exists()&&e.destroy(De)})}}if(!de()||me()){const G=e.get("boss"),D=e.get("enemy").filter(J=>J.isBossMinion);G.length===0&&D.length===0&&!l&&(l=!0,dc())}return}if(Ss&&!fa&&(!de()||me())&&e.time()-pa>=1){fa=!0;const G=Zh(n,rc),D=u(),J=c.filter(Xt=>Xt.direction!==Z.entryDirection),pe=J.length>0?J:c,Je=D?D.range(0,pe.length):Math.floor(Math.random()*pe.length),Me=pe[Je],_e=Me.pos.x,De=Me.pos.y,qe=Oy(e,_e,De,G,n);de()&&me()&&Xo(qe,{type:G,floor:n});const Le=jn[G]?.name||"MINIBOSS",xt=e.add([e.text(`MINIBOSS: ${Le.toUpperCase()}`,{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{xt.exists()&&e.destroy(xt)})}const v=e.get("enemy").length,W=e.get("miniboss").length;if(es>=As&&v===0&&W===0&&!l&&(!de()||me())&&(l=!0,dc()),es<As&&(!de()||me())){if(ui+=e.dt(),es===0&&ui<Jh)return;if(ui>=ou){ui=0,es++;const G=u();if(G)for(let D=0;D<es-1;D++)G.next();if(c.length>0){const D=e.time()-pa,pe=Z.entryDirection&&D<jh?c.filter(gi=>gi.direction!==Z.entryDirection):c,Je=pe.length>0?pe:c,Me=G?G.range(0,Je.length):Math.floor(Math.random()*Je.length),_e=Je[Me],De=_e.pos.x,qe=_e.pos.y,Le=15,xt=De+(G?G.next()-.5:Math.random()-.5)*Le,Xt=qe+(G?G.next()-.5:Math.random()-.5)*Le,qt=gr(n,G),wn=Rn(e,xt,Xt,qt,n,G);Al(e,wn,n,G),de()&&me()&&Xo(wn,{type:qt,floor:n,isElite:wn.isElite,eliteModifier:wn.eliteModifier})}else{const D=G?G.range(0,4):Math.floor(e.rand(0,4));let J,pe;switch(D){case 0:J=G?G.rangeFloat(F,e.width()-F):e.rand(F,e.width()-F),pe=F;break;case 1:J=e.width()-F,pe=G?G.rangeFloat(F,e.height()-F):e.rand(F,e.height()-F);break;case 2:J=G?G.rangeFloat(F,e.width()-F):e.rand(F,e.width()-F),pe=e.height()-F;break;case 3:J=F,pe=G?G.rangeFloat(F,e.height()-F):e.rand(F,e.height()-F);break}const Je=gr(n,G),Me=Rn(e,J,pe,Je,n,G);Al(e,Me,n,G),de()&&me()&&Xo(Me,{type:Je,floor:n,isElite:Me.isElite,eliteModifier:Me.eliteModifier})}}}})),a.updates.push(e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(v=>{if(v.hp()<=0&&!v.isDead){v.isDead=!0;const W=v.xpValue,q=v.pos.x,X=v.pos.y;if(v.cleanupHealthBars&&v.cleanupHealthBars(),v.explodes&&v.explosionRadius){const J=v.explosionRadius,pe=v.explosionDamage||15;f.exists()&&Math.sqrt(Math.pow(f.pos.x-q,2)+Math.pow(f.pos.y-X,2))<=J&&f.takeDamage(pe),i.enemies.getNearby(q,X,J).forEach(Me=>{if(Me===v||!Me.exists())return;const _e=Me.pos.x-q,De=Me.pos.y-X;_e*_e+De*De<=J*J&&Me.hurt(pe)}),Ys(e,q,X,{color:[255,150,50]})}else{const J=Z.equippedCosmetics?.death,pe=v.originalColor||[255,100,100];J&&J!=="deathNone"?fx(e,q,X,J,pe):Ys(e,q,X,{color:pe})}if(v.shrapnel&&v.shrapnelCount){const J=v.shrapnelCount,pe=Math.PI*2/J,Je=250,Me=Math.floor((v.explosionDamage||15)*.6);for(let _e=0;_e<J;_e++){const De=pe*_e,qe=e.vec2(Math.cos(De),Math.sin(De)),Le=To(e,q,X,qe,Je,Me,0,0,!1);Le.isEnemyProjectile=!0,Le.color=e.rgb(...v.originalColor)}}v.cleanupHealthBars&&typeof v.cleanupHealthBars=="function"&&v.cleanupHealthBars(),de()&&v.mpEntityId&&(me()?Jr({entityId:v.mpEntityId,entityType:"enemy",x:q,y:X}):fy({entityId:v.mpEntityId,entityType:"enemy",x:q,y:X})),e.destroy(v),ul(),At.enemiesKilled++;const G=v.type||v.enemyType||"basic";At.killsByType[G]=(At.killsByType[G]||0)+1;const D=v.lastHitBySlot;if(D!==void 0&&S[D]&&S[D].runStats?S[D].runStats.kills++:f.runStats&&f.runStats.kills++,!de()||me()){const J=u();Xs(e,q,X,W);const pe=J?J.range(1,4):Math.floor(Math.random()*3)+1,Je=1;for(let _e=0;_e<pe;_e++){const De=J?(J.next()-.5)*20:(Math.random()-.5)*20,qe=J?(J.next()-.5)*20:(Math.random()-.5)*20,Le=Bi();Fs(e,q+De,X+qe,Je,Le)}const Me=Am(v.type,n);if(Me){const _e=J?(J.next()-.5)*30:(Math.random()-.5)*30,De=J?(J.next()-.5)*30:(Math.random()-.5)*30;Zc(e,q+_e,X+De,Me)}}}}),e.get("miniboss").forEach(v=>{if(v.hp()<=0&&!v.isDead){v.isDead=!0;const W=v.xpValue,q=v.pos.x,X=v.pos.y;Ys(e,q,X,{color:[255,150,100],isMiniboss:!0}),e.destroy(v),ul(),At.enemiesKilled++;const G=v.type||"miniboss";At.killsByType[G]=(At.killsByType[G]||0)+1;const D=v.lastHitBySlot;if(D!==void 0&&S[D]&&S[D].runStats?S[D].runStats.kills++:f.runStats&&f.runStats.kills++,!de()||me()){const pe=u();Xs(e,q,X,W);const Je=pe?pe.range(10,16):Math.floor(Math.random()*6)+10,Me=1;for(let _e=0;_e<Je;_e++){const De=Math.PI*2/Je*_e,qe=pe?30+pe.next()*20:30+Math.random()*20,Le=Math.cos(De)*qe,xt=Math.sin(De)*qe;Fs(e,q+Le,X+xt,Me)}}const J=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(q,X-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{J.exists()&&e.destroy(J)})}}),e.get("boss").forEach(v=>{if(v.hp()<=0&&!v.isDead){v.isDead=!0;const W=v.xpValue,q=v.pos.x,X=v.pos.y;Ys(e,q,X,{color:[255,200,100],isBoss:!0}),e.destroy(v),ox(),At.enemiesKilled++,At.bossesKilled++;const G=v.type||"boss";At.killsByType[G]=(At.killsByType[G]||0)+1;const D=v.lastHitBySlot;if(D!==void 0&&S[D]&&S[D].runStats?(S[D].runStats.kills++,S[D].runStats.bossesKilled++):f.runStats&&(f.runStats.kills++,f.runStats.bossesKilled++),!de()||me()){const pe=u();Xs(e,q,X,W);const Je=pe?pe.range(20,31):Math.floor(Math.random()*11)+20,Me=1,_e=Bi();for(let De=0;De<Je;De++){const qe=Math.PI*2/Je*De,Le=pe?40+pe.next()*30:40+Math.random()*30,xt=Math.cos(qe)*Le,Xt=Math.sin(qe)*Le;Fs(e,q+xt,X+Xt,Me,_e)}}const J=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(q,X-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{J.exists()&&e.destroy(J)})}}))})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const v=f.pickupRadius*1.5,W=new Set;h===1?i.pickups.getNearby(f.pos.x,f.pos.y,v).forEach(q=>{q.is&&q.is("xpPickup")&&W.add(q)}):S.forEach(q=>{!q||!q.exists()||q.isDead||i.pickups.getNearby(q.pos.x,q.pos.y,v).forEach(X=>{X.is&&X.is("xpPickup")&&W.add(X)})}),W.forEach(q=>{if(q.collected)return;let X=f,G=e.vec2(f.pos.x-q.pos.x,f.pos.y-q.pos.y).len();if(h>1&&S.forEach(D=>{if(!D||!D.exists()||D.isDead)return;const J=e.vec2(D.pos.x-q.pos.x,D.pos.y-q.pos.y).len();J<G&&(G=J,X=D)}),!q.magnetizing&&G<=X.pickupRadius&&(q.magnetizing=!0,q.targetPlayer=X),G<=Vt.COLLECTION_RADIUS&&!q.collected){if(de()&&!me())return;q.collected=!0,ky(),h>1?me()&&(f.exists()&&!f.isDead&&f.addXP&&f.addXP(q.value),my(q.value)):f.addXP(q.value),q.isFlyingToUI=!0}})})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const v=f.pickupRadius*1.5,W=new Set;h===1?i.pickups.getNearby(f.pos.x,f.pos.y,v).forEach(X=>{X.is&&X.is("currencyPickup")&&W.add(X)}):S.forEach(X=>{!X||!X.exists()||X.isDead||i.pickups.getNearby(X.pos.x,X.pos.y,v).forEach(G=>{G.is&&G.is("currencyPickup")&&W.add(G)})}),W.forEach(X=>{if(X.collected)return;let G=f,D=e.vec2(f.pos.x-X.pos.x,f.pos.y-X.pos.y).len();if(h>1&&S.forEach(J=>{if(!J||!J.exists()||J.isDead)return;const pe=e.vec2(J.pos.x-X.pos.x,J.pos.y-X.pos.y).len();pe<D&&(D=pe,G=J)}),!X.magnetizing&&D<=G.pickupRadius&&(X.magnetizing=!0,X.targetPlayer=G),D<=Vt.COLLECTION_RADIUS&&!X.collected){if(de()&&!me())return;X.collected=!0,fl(),ds(X.value),G&&G.runStats&&(G.runStats.creditsPickedUp+=X.value),de()&&yy(X.value),X.isFlyingToUI=!0}}),i.pickups.getNearby(f.pos.x,f.pos.y,f.pickupRadius*1.5).forEach(X=>{if(!X.is||!X.is("powerupWeaponPickup")||X.collected)return;const G=e.vec2(f.pos.x-X.pos.x,f.pos.y-X.pos.y).len();if(!X.magnetizing&&G<=f.pickupRadius&&(X.magnetizing=!0,X.targetPlayer=f),G<=Vt.COLLECTION_RADIUS&&!X.collected){if(de()&&!me())return;X.collected=!0,fl(),de()&&me()?(e.get("player").forEach(Me=>{Ma(Me,X.powerupKey)}),ty(X.powerupKey)):Ma(f,X.powerupKey);const D=Bn[X.powerupKey],J=e.add([e.text(D.icon,{size:32}),e.pos(f.pos.x,f.pos.y-30),e.color(...D.color),e.anchor("center"),e.z(w.UI_TEXT+1),e.opacity(1)]);let pe=0;J.onUpdate(()=>{pe+=e.dt(),J.pos.y-=50*e.dt(),J.opacity=Math.max(0,1-pe/.8),pe>=.8&&e.destroy(J)}),e.destroy(X)}})}));let pt=null,zt=null,xn=0,_o=null,Ms=!1;const lc=.5,nu=10;de()&&!me()&&(He("door_progress",v=>{if(v.clear){zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt),zt=null,pt=null;return}(!zt||!zt.exists())&&(zt=e.add([e.circle(20),e.pos(v.doorX,v.doorY),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),pt=e.add([e.circle(18),e.pos(v.doorX,v.doorY),e.anchor("center"),e.color(v.isForced?255:100,v.isForced?200:255,v.isForced?0:100),e.opacity(0),e.z(201),"doorProgress"])),pt&&pt.exists()&&(pt.opacity=v.progress,pt.scale=e.vec2(v.progress,v.progress),pt.color=e.rgb(v.isForced?255:100,v.isForced?200:255,v.isForced?0:100))}),He("barrel_damage",v=>{const W=dl(v.x,v.y);W&&W.exists()&&!W.isExploding&&(W.currentHealth=v.currentHealth,W.updateHealthBar())}),He("barrel_explode",v=>{const W=dl(v.x,v.y);W&&W.exists()&&!W.isExploding&&W.explode()})),a.updates.push(e.onUpdate(()=>{!f.exists()||e.paused||r||Ei()||de()&&!me()||(e.get("door").forEach(v=>{if(!(!v.open||r||v.isSpawnDoor||v.blocked))if(h>1){let W=!1,q=!0;S.forEach((J,pe)=>{if(!J||!J.exists()||J.isDead||J.hp()<=0)return;const Me=e.vec2(J.pos.x-v.pos.x,J.pos.y-v.pos.y).len()<=40;pe===0&&(W=Me),Me||(q=!1)});const X=q||W,G=W&&!q,D=G?nu:lc;if(X){(_o!==v||Ms!==G)&&(xn=0,_o=v,Ms=G,zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt),zt=e.add([e.circle(20),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),pt=e.add([e.circle(18),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(G?255:100,G?200:255,G?0:100),e.opacity(0),e.z(201),"doorProgress"])),xn+=e.dt();const J=Math.min(xn/D,1);pt&&pt.exists()&&(pt.opacity=J,pt.scale=e.vec2(J,J)),de()&&Ke("door_progress",{doorX:v.pos.x,doorY:v.pos.y,progress:J,isForced:G}),J>=1&&(r=!0,Ia(),zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt),_o=null,de()&&Ke("door_progress",{progress:0,clear:!0}),hc(v.direction))}else _o===v&&(xn=0,_o=null,Ms=!1,zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt),de()&&Ke("door_progress",{progress:0,clear:!0}))}else{if(f.isDead||f.hp()<=0)return;if(e.vec2(f.pos.x-v.pos.x,f.pos.y-v.pos.y).len()<=40){_o!==v&&(xn=0,_o=v,Ms=!1,zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt),zt=e.add([e.circle(20),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),pt=e.add([e.circle(18),e.pos(v.pos.x,v.pos.y),e.anchor("center"),e.color(100,255,100),e.opacity(0),e.z(201),"doorProgress"])),xn+=e.dt();const X=Math.min(xn/lc,1);pt&&pt.exists()&&(pt.opacity=X,pt.scale=e.vec2(X,X)),X>=1&&(r=!0,Ia(),zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt),_o=null,hc(v.direction))}else _o===v&&(xn=0,_o=null,Ms=!1,zt&&zt.exists()&&e.destroy(zt),pt&&pt.exists()&&e.destroy(pt))}}),!_o&&zt&&zt.exists()&&(e.destroy(zt),e.destroy(pt)))}));function su(){if(!f.exists())return;const v=e.width()/2,W=e.height()/2,q=5,X=3,G=N?3:1,D=N?4:1,J=n*.5,pe=Math.floor((q+J)*G),Je=Math.floor((X+J)*D),Me=u();for(let _e=0;_e<pe;_e++){const De=Math.PI*2*_e/pe+(Me?Me.next():Math.random())*.3,qe=40+(Me?Me.next():Math.random())*60,Le=v+Math.cos(De)*qe,xt=W+Math.sin(De)*qe,Xt=Math.floor(1+n*.5);Xs(e,Le,xt,Xt)}for(let _e=0;_e<Je;_e++){const De=Math.PI*2*_e/Je+(Me?Me.next():Math.random())*.3+.5,qe=50+(Me?Me.next():Math.random())*70,Le=v+Math.cos(De)*qe,xt=W+Math.sin(De)*qe,Xt=Math.floor(1+n*.3),qt=Bi();Fs(e,Le,xt,Xt,qt)}if(N){const _e=Object.keys(Bn),De=1+Math.floor((Me?Me.next():Math.random())*2);for(let qe=0;qe<De;qe++){const Le=(Me?Me.next():Math.random())*Math.PI*2,xt=80+(Me?Me.next():Math.random())*40,Xt=v+Math.cos(Le)*xt,qt=W+Math.sin(Le)*xt,wn=_e[Math.floor((Me?Me.next():Math.random())*_e.length)];Zc(e,Xt,qt,wn)}}}function dc(){o.roomCleared=!0,o.clearRoom(),de()&&me()&&gy(),h>1&&d(),At.roomsCleared++;const v=f.exists()?f.level:1;if(Si(e,{floor:Z.currentFloor,enemiesKilled:At.enemiesKilled,bossesKilled:At.bossesKilled,level:v,currencyEarned:0}),Z.floorMap&&U&&Z.floorMap.markRoomCleared(U.position.x,U.position.y),c.forEach(X=>{X.exists()&&!X.blocked&&(X.open=!0,X.isSpawnDoor=!1,X.updateVisual())}),N){const X=c.find(G=>G.direction==="north");X&&X.exists()&&(X.blocked=!1,X.open=!0,X.isSpawnDoor=!1,X.isFloorExit=!0,X.updateVisual())}Z.minimap&&Z.minimap.update(),(!de()||me())&&su();const W=N?`BOSS DEFEATED! Floor ${n} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",q=e.add([e.text(W,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{q.exists()&&e.destroy(q)})}function hc(v){Z.allPlayerStats=S.map((D,J)=>!D||!D.exists()?null:{slotIndex:D.slotIndex!==void 0?D.slotIndex:J,playerName:D.playerName,isRemote:D.isRemote||!1,isDead:D.isDead||!1,level:D.level,xp:D.xp,xpToNext:D.xpToNext,maxHealth:D.maxHealth,currentHP:D.hp(),speed:D.slowed?D.originalSpeed:D.speed,originalSpeed:D.originalSpeed||D.speed,slowed:!1,fireRate:D.fireRate,projectileSpeed:D.projectileSpeed,projectileDamage:D.projectileDamage,pickupRadius:D.pickupRadius,xpMultiplier:D.xpMultiplier||1,characterKey:D.characterKey,dodgeChance:D.dodgeChance||0,damageReduction:D.damageReduction||0,fireDotMultiplier:D.fireDotMultiplier||1,invulnerableDuration:D.invulnerableDuration||1,projectileCount:D.projectileCount||1,piercing:D.piercing||0,obstaclePiercing:D.obstaclePiercing||0,critChance:D.critChance||0,critDamage:D.critDamage||2,spreadAngle:D.spreadAngle||0,defense:D.defense||0,weaponRange:D.weaponRange||600,weapons:D.weapons||[],passiveUpgrades:D.passiveUpgrades||[],upgradeStacks:D.upgradeStacks||{},selectedUpgrades:D.selectedUpgrades?Array.from(D.selectedUpgrades):[],activeSynergies:D.activeSynergies?Array.from(D.activeSynergies):[],piercingDamageBonus:D.piercingDamageBonus||1,characterData:D.characterData,weaponDef:D.weaponDef,baseProjectileDamage:D.baseProjectileDamage,baseFireRate:D.baseFireRate,baseProjectileSpeed:D.baseProjectileSpeed,pendingLevelUps:D.pendingLevelUps||[],powerupWeapon:D.powerupWeapon||null,powerupAmmo:D.powerupAmmo!==void 0?D.powerupAmmo:null,powerupDuration:D.powerupDuration!==void 0?D.powerupDuration:null,originalWeapon:D.originalWeapon||null,weaponKey:D.weaponKey,weaponCategory:D.weaponCategory,orbitRadius:D.orbitRadius,rotationSpeed:D.rotationSpeed,explosionRadius:D.explosionRadius,explosionDamage:D.explosionDamage,chainRange:D.chainRange,maxJumps:D.maxJumps,chainDamageReduction:D.chainDamageReduction,thornsPercent:D.thornsPercent||0,thornsIgnoreArmor:D.thornsIgnoreArmor||!1,runStats:D.runStats||{kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}).filter(D=>D!==null);const W=Z.allPlayerStats.find(D=>!D.isRemote);W&&(Z.playerStats=W);const q={north:"south",south:"north",west:"east",east:"west"};Z.entryDirection=q[v]||null;const G={north:"up",south:"down",east:"right"}[v];if(Z.floorMap)if(U&&U.isBossRoom&&U.cleared){if(n++,Hc(n-1)){const pe=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{pe.exists()&&e.destroy(pe)})}Z.floorMap=null,Z.entryDirection=null,s=1,o.nextFloor()}else G?Z.floorMap.moveToRoom(G)?s=Z.floorMap.getVisitedCount():(console.error("[Game] Failed to move in floor map - should not happen!"),s++):(console.warn("[Game] Invalid door direction:",v),s++),o.nextRoom();else if(s++,s>3){if(n++,Hc(n-1)){const J=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{J.exists()&&e.destroy(J)})}s=1,Z.entryDirection=null,o.nextFloor()}else o.nextRoom();if(Z.currentFloor=n,Z.currentRoom=s,de()&&me()){const D=bi(),J=qs(n,D);Z.roomTemplateKey=J.key,console.log("[Multiplayer] Host selected next room template:",J.key),wy(Z.entryDirection,Z.allPlayerStats,G,n,Z.roomTemplateKey)}e.go("game")}f.onDeath(()=>{if(f.orbitalOrbs&&(f.orbitalOrbs.forEach(G=>{G.exists()&&e.destroy(G)}),f.orbitalOrbs=[]),f.glowEffect&&f.glowEffect.exists()&&(e.destroy(f.glowEffect),f.glowEffect=null),h>1&&(de()&&f.slotIndex!==void 0&&vy(f.slotIndex),f.isDead=!0,f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5),!me()||S.some(D=>D&&D.exists()&&D.hp()>0&&!D.isDead)))return;const v=Ea(At),W={...At,level:f.level,currencyEarned:v};va(W),ds(v);const q=At.startTime?Math.floor((Date.now()-At.startTime)/1e3):0;Ug({character:f.characterData?.key||"survivor",weapon:f.weaponKey||"pistol",floorsReached:At.floorsReached,roomsCleared:At.roomsCleared,enemiesKilled:At.enemiesKilled,bossesKilled:At.bossesKilled,level:f.level||1,currencyEarned:v,duration:q,deathCause:"Enemy",upgrades:f.selectedUpgrades?Array.from(f.selectedUpgrades):[],synergies:f.activeSynergies?Array.from(f.activeSynergies):[]}),Si(e);const X=S.filter(G=>G&&G.exists()).map(G=>({name:G.playerName||"Player",level:G.level||1,characterData:G.characterData,kills:G.runStats?.kills||0,deaths:G.runStats?.deaths||0,revives:G.runStats?.revives||0,damageTaken:G.runStats?.damageTaken||0,damageDealt:G.runStats?.damageDealt||0,xpCollected:G.runStats?.xpPickedUp||0,creditsPickedUp:G.runStats?.creditsPickedUp||0,bossesKilled:G.runStats?.bossesKilled||0}));de()&&me()&&nl(At,v,X),de()&&rs(),e.go("gameOver",{runStats:{...At},currencyEarned:v,partyStats:X,isDailyRun:Z.isDailyRun,dailyCharacter:Z.dailyCharacter})});const ga=e.add([e.rect(300,260),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_DARK),e.opacity(.95),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(2e3),"pauseOverlay"]),ma=e.add([e.text("PAUSED",{size:Q.H1*2}),e.pos(e.width()/2,e.height()/2-95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2001),"pauseText"]),fi=e.height()/2,{LG:uc,SM:fc}=zn.BUTTON,pc=e.add([e.rect(uc.width,uc.height),e.pos(e.width()/2,fi-20),e.anchor("center"),e.color(...y.SUCCESS),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("RESUME",{size:Q.H2}),e.pos(e.width()/2,fi-20),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]);const gc=e.add([e.rect(fc.width,fc.height),e.pos(e.width()/2,fi+45),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("QUIT",{size:Q.SMALL}),e.pos(e.width()/2,fi+45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]),ga.hidden=!0,ma.hidden=!0,e.get("pauseButton").forEach(v=>v.hidden=!0);const pi=v=>{v?(sx(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=Ge)):(gl(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Ge=e.gameData.weaponDetailSavedState,gt.hidden=!Ge,ht.hidden=!Ge,Bt.hidden=!Ge,Tt.hidden=!Ge,yt.hidden=!Ge,Rt.hidden=!Ge,e.gameData.weaponDetailSavedState=void 0)),ga.hidden=!v,ma.hidden=!v,e.get("pauseButton").forEach(W=>W.hidden=!v)};e.gameData.updatePauseUI=pi,pc.onClick(()=>{!e.paused||pc.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(Ge=e.gameData.weaponDetailSavedState,gt.hidden=!Ge,ht.hidden=!Ge,Bt.hidden=!Ge,Tt.hidden=!Ge,yt.hidden=!Ge,Rt.hidden=!Ge,e.gameData.weaponDetailSavedState=void 0),gl(),ga.hidden=!0,ma.hidden=!0,e.get("pauseButton").forEach(v=>v.hidden=!0))}),gc.onClick(()=>{if(!(!e.paused||gc.hidden))if(de())if(me())ey(),rs(),Z.currentFloor=1,Z.currentRoom=1,Z.playerStats=null,e.go("menu");else{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Leave party and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const v=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const W=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]),v.onClick(()=>{e.get("confirmDialog").forEach(q=>e.destroy(q)),rs(),Z.currentFloor=1,Z.currentRoom=1,Z.playerStats=null,e.go("menu")}),W.onClick(()=>{e.get("confirmDialog").forEach(q=>e.destroy(q))})}else Z.currentFloor=1,Z.currentRoom=1,Z.playerStats=null,e.go("menu")}),a.keyPresses.push(e.onKeyPress("m",()=>{Z.minimap&&!e.paused&&Z.minimap.toggle()})),a.keyPresses.push(e.onKeyPress("escape",()=>{Ei()||(de()?me()?(e.paused=!e.paused,hy(e.paused),pi(e.paused)):uy(!e.paused):(e.paused=!e.paused,pi(e.paused)))}));const mc=()=>{de()||e.paused||Ei()||(e.paused=!0,pi(!0))};window.addEventListener("blur",mc),e.onSceneLeave(()=>{window.removeEventListener("blur",mc)}),e.onSceneLeave(()=>{if(a.updates.forEach(v=>{try{v&&v.cancel&&v.cancel()}catch(W){console.warn("[Game] Error canceling update handler:",W)}}),a.keyPresses.forEach(v=>{try{v&&v.cancel&&v.cancel()}catch(W){console.warn("[Game] Error canceling keypress handler:",W)}}),!me()&&de()){try{Ot("room_transition"),Ot("room_completed"),Ot("game_over")}catch(v){console.warn("[Game] Error unregistering message handlers:",v)}Ti=!1}Z.minimap&&(Z.minimap.destroy(),Z.minimap=null),Ty()})})}const _t={LEVEL:"level",CHARACTER:"character",ACHIEVEMENT:"achievement"},Zn={default:{id:"default",name:"Rookie",icon:"",color:[200,200,200],category:_t.LEVEL,unlockCondition:{type:"default"},description:"Everyone starts somewhere."},veteran:{id:"veteran",name:"Veteran",icon:"",color:[100,200,255],category:_t.LEVEL,unlockCondition:{type:"level",value:10},description:"A seasoned competitor with many battles under their belt."},elite:{id:"elite",name:"Elite",icon:"",color:[255,200,100],category:_t.LEVEL,unlockCondition:{type:"level",value:25},description:"Among the top performers in the arena."},legend:{id:"legend",name:"Legend",icon:"",color:[255,100,255],category:_t.LEVEL,unlockCondition:{type:"level",value:50},description:"A living legend whose name echoes through the halls."},champion:{id:"champion",name:"Champion",icon:"",color:[255,215,0],category:_t.LEVEL,unlockCondition:{type:"level",value:75},description:"A true champion who has conquered all challenges."},immortal:{id:"immortal",name:"Immortal",icon:"",color:[200,255,255],category:_t.LEVEL,unlockCondition:{type:"level",value:100},description:"Transcended mortality. A god among players."},survivor:{id:"survivor",name:"Survivor",icon:"",color:[100,200,100],category:_t.CHARACTER,unlockCondition:{type:"character",value:"survivor"},description:"The default hero. Never gives up."},berserker:{id:"berserker",name:"Berserker",icon:"",color:[255,100,100],category:_t.CHARACTER,unlockCondition:{type:"character",value:"berserker"},description:"Rage incarnate. Pain is just fuel."},ranger:{id:"ranger",name:"Ranger",icon:"",color:[100,255,150],category:_t.CHARACTER,unlockCondition:{type:"character",value:"ranger"},description:"Swift and precise. Death from a distance."},mage:{id:"mage",name:"Mage",icon:"",color:[200,100,255],category:_t.CHARACTER,unlockCondition:{type:"character",value:"mage"},description:"Master of the arcane arts."},tank:{id:"tank",name:"Tank",icon:"",color:[150,150,200],category:_t.CHARACTER,unlockCondition:{type:"character",value:"tank"},description:"An immovable wall. Nothing gets through."},assassin:{id:"assassin",name:"Assassin",icon:"",color:[150,100,150],category:_t.CHARACTER,unlockCondition:{type:"character",value:"assassin"},description:"Silent. Deadly. Gone before you know it."},boss_slayer:{id:"boss_slayer",name:"Boss Slayer",icon:"",color:[255,180,50],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:100},description:"Has ended the reign of 100 bosses."},speedrunner:{id:"speedrunner",name:"Speedrunner",icon:"",color:[255,255,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"fastestRunTime",value:600,comparison:"lessThan"},description:"Completed a run in under 10 minutes."},perfectionist:{id:"perfectionist",name:"Perfectionist",icon:"",color:[255,255,255],category:_t.ACHIEVEMENT,unlockCondition:{type:"achievement",value:"flawless_run"},description:"Completed a run without taking damage."},grinder:{id:"grinder",name:"Grinder",icon:"",color:[200,150,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:100},description:"Has completed 100 runs. Dedication personified."},collector:{id:"collector",name:"Collector",icon:"",color:[255,215,0],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:1e4},description:"Has earned 10,000 credits total."},exterminator:{id:"exterminator",name:"Exterminator",icon:"",color:[200,50,50],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e4},description:"Has eliminated 10,000 enemies."},explorer:{id:"explorer",name:"Explorer",icon:"",color:[100,180,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:5},description:"Reached floor 5. The journey begins."},delver:{id:"delver",name:"Delver",icon:"",color:[180,140,100],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:10},description:"Reached floor 10. Deep into the unknown."},abyssal:{id:"abyssal",name:"Abyssal",icon:"",color:[80,50,150],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:20},description:"Reached floor 20. Touched the abyss."},slayer:{id:"slayer",name:"Slayer",icon:"",color:[200,80,80],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:25},description:"Has slain 25 bosses."},warrior:{id:"warrior",name:"Warrior",icon:"",color:[150,150,200],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e3},description:"Has defeated 1,000 enemies."},rich:{id:"rich",name:"Wealthy",icon:"",color:[100,200,255],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:5e4},description:"Has earned 50,000 credits. Living large."},dedicated:{id:"dedicated",name:"Dedicated",icon:"",color:[150,100,200],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:50},description:"Has completed 50 runs. Committed to the grind."},marathoner:{id:"marathoner",name:"Marathoner",icon:"",color:[100,200,150],category:_t.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRoomsCleared",value:500},description:"Has cleared 500 rooms. Endurance personified."}};function mr(e){return Zn[e]||null}function f1(){return Object.values(Zn)}function p1(e,t){const o=Zn[e];if(!o)return!1;const n=o.unlockCondition;switch(n.type){case"default":return!0;case"level":return Math.floor(Math.sqrt((t.totalXP||0)/100))+1>=n.value;case"character":return t.unlocks?.characters?.includes(n.value)||!1;case"achievement":return t.achievements?.includes(n.value)||!1;case"stat":const a=t.stats?.[n.stat]||0;return n.comparison==="lessThan"?a>0&&a<n.value:a>=n.value;default:return!1}}function g1(e){const t=Zn[e];if(!t)return"Unknown";const o=t.unlockCondition;switch(o.type){case"default":return"Unlocked by default";case"level":return`Reach Level ${o.value}`;case"character":return`Unlock the ${o.value.charAt(0).toUpperCase()+o.value.slice(1)} character`;case"achievement":return`Complete the "${o.value}" achievement`;case"stat":const s={totalBossesKilled:"bosses killed",totalRuns:"runs completed",totalCurrencyEarned:"credits earned",totalEnemiesKilled:"enemies killed",fastestRunTime:"second run"}[o.stat]||o.stat;return o.comparison==="lessThan"?`Complete a run in under ${Math.floor(o.value/60)} minutes`:`${o.value.toLocaleString()} ${s}`;default:return"Unknown condition"}}const _h="superSmashTextyDailyRuns",m1=["survivor","scout","tank","sniper","pyro","bomber","engineer","vampire","berserker","ghost"];function Ko(){return new Date().toISOString().split("T")[0]}function Xh(e=null){const t=e||Ko();return Dm(t+"SuperSmashTexty")}function sc(e=null){const t=Xh(e);return new pn(t).choose(m1)}function y1(){return sc(Ko())}function ha(){try{const e=localStorage.getItem(_h);return e?JSON.parse(e):{completedDays:{},attempts:{}}}catch(e){return console.warn("[DailyRuns] Failed to parse daily run data:",e),{completedDays:{},attempts:{}}}}function x1(e){try{localStorage.setItem(_h,JSON.stringify(e))}catch(t){console.warn("[DailyRuns] Failed to save daily run data:",t)}}function w1(){const e=ha(),t=Ko();return!!e.completedDays[t]}function b1(e){return ha().completedDays[e]||null}function v1(){return b1(Ko())}function E1(e){const t=ha(),o=Ko(),n={date:o,score:e.score||0,floor:e.floor||1,character:e.character||y1(),duration:e.duration||0,completedAt:Date.now()};return t.completedDays[o]=n,x1(t),console.log("[DailyRuns] Marked daily completed:",n),n}function A1(){const e=ha(),t=Ko();return e.attempts[t]||0}function S1(){const e=Ko(),t=Xh(e),o=sc(e),n=w1(),s=v1(),a=A1();return{date:e,seed:t,character:o,completed:n,completion:s,attempts:a}}const vo={LEFT_COLUMN_X:20,LEFT_COLUMN_WIDTH:200,RIGHT_COLUMN_WIDTH:200,TOP_MARGIN:20};function ss(e,t,o,n,s=ns.WIDTH,a=ns.HEIGHT,r=Q.BUTTON){const l=y.SECONDARY,c=y.SECONDARY_HOVER,d=y.TEXT_PRIMARY,i=y.BORDER,h=e.add([e.rect(s,a),e.pos(o,n),e.anchor("center"),e.color(...l),e.outline(2,e.rgb(...i)),e.area(),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS),"menuButton"]),u=ni(t),g=e.add([e.text(u,{size:r}),e.pos(o,n),e.anchor("center"),e.color(...d),e.fixed(),e.scale(1),e.z(w.UI_TEXT),"menuButtonText"]);return h.originalColor=[...l],h.hoverColor=[...c],h.borderColor=[...i],h.isHovered=!1,h.disabled=!1,h.label=g,h.labels=[g],h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,ke()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...y.BORDER_HOVER),h.scale=e.vec2(ns.HOVER_SCALE,ns.HOVER_SCALE),g.scale=e.vec2(ns.HOVER_SCALE,ns.HOVER_SCALE))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),g.scale=e.vec2(1,1))}),h.setDisabled=p=>{h.disabled=p,p?(h.color=e.rgb(...y.BG_DISABLED),g.color=e.rgb(...y.TEXT_DISABLED)):(h.color=e.rgb(...h.originalColor),g.color=e.rgb(...d))},h}function yr(e,t,o){t/=100,o/=100;const n=(1-Math.abs(2*o-1))*t,s=n*(1-Math.abs(e/60%2-1)),a=o-n/2;let r=0,l=0,c=0;return e>=0&&e<60?(r=n,l=s,c=0):e>=60&&e<120?(r=s,l=n,c=0):e>=120&&e<180?(r=0,l=n,c=s):e>=180&&e<240?(r=0,l=s,c=n):e>=240&&e<300?(r=s,l=0,c=n):e>=300&&e<360&&(r=n,l=0,c=s),[Math.round((r+a)*255),Math.round((l+a)*255),Math.round((c+a)*255)]}function M1(e){return yr(e,80,15)}function T1(e){e.scene("menu",()=>{bh();const t=hr();vh(t.audio.masterVolume),Dh(t.audio.musicVolume),Eh(t.audio.sfxVolume),t.audio.uiSounds!==void 0&&Ah(t.audio.uiSounds),t.audio.combatSounds!==void 0&&Sh(t.audio.combatSounds);let o=!1;const n=()=>{o||(o=!0,Gy(),ml())};e.onClick(n),e.onKeyPress(n),ml();const s=$n(),a=e.width()-vo.RIGHT_COLUMN_WIDTH-vo.LEFT_COLUMN_X,r=e.width()/2;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(w.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...y.BORDER),e.fixed(),e.z(w.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...y.BORDER),e.fixed(),e.z(w.UI_BACKGROUND)]);const l=vo.LEFT_COLUMN_X,c=vo.TOP_MARGIN+50,d=vo.LEFT_COLUMN_WIDTH,i=75,h=e.add([e.rect(d,i),e.pos(l,c),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_BACKGROUND),"profileCard"]),u=mr(ci())||Zn.default,g=45,p=l+32,T=c+i/2;e.add([e.rect(g,g),e.pos(p,T),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...u.color||[200,200,200])),e.fixed(),e.z(w.UI_BACKGROUND+1)]),e.add([e.text(u.icon,{size:24}),e.pos(p,T),e.anchor("center"),e.color(...u.color||[200,200,200]),e.fixed(),e.z(w.UI_TEXT)]);const m=Mo(),M=m.length>16?m.substring(0,16)+"..":m,P=p+g/2+10;e.add([e.text(M,{size:Q.SMALL}),e.pos(P,c+15),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);const f=ri();e.add([e.text(`Lv.${f}`,{size:Q.SMALL-2}),e.pos(P,c+32),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);const _=Nr(),B=d-75,b=8,S=P,E=c+50;e.add([e.rect(B,b),e.pos(S,E),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(w.UI_BACKGROUND+1)]);const C=Math.max(2,B*_);e.add([e.rect(C,b-2),e.pos(S+1,E),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(w.UI_ELEMENTS)]),e.add([e.text(`${Math.round(_*100)}%`,{size:9}),e.pos(S+B/2,E),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]),h.onClick(()=>{Ut(),e.go("profile")}),h.onHoverUpdate(()=>{h.color=e.rgb(...y.BG_LIGHT)}),h.onHoverEnd(()=>{h.color=e.rgb(...y.BG_MEDIUM)}),lh(e);const A=vo.LEFT_COLUMN_X,z=c+i+10,R=vo.LEFT_COLUMN_WIDTH,Y=24,U=3,N=8,H=N+Y*4+U*3+55;e.add([e.rect(R,H),e.pos(A,z),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const I=z+N,F=[];function V(){F.forEach(we=>{we.forEach(re=>{re.exists()&&e.destroy(re)})}),F.length=0,hm().forEach((we,re)=>{const he=I+re*(Y+U),be=[],Ze=!we.isEmpty&&!we.isLocal,ut=e.add([e.rect(R-16,Y),e.pos(A+8,he),e.color(we.isEmpty?y.BG_DARK:y.BG_LIGHT),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(w.UI_BACKGROUND+1),Ze?e.area():null,"partySlotUI"].filter(Boolean));be.push(ut),Ze&&(ut.onClick(()=>{Ut(),bm(re,It=>{It?e.go("profile",{externalProfile:It}):console.warn("Failed to load profile for slot",re)})}),ut.onHoverUpdate(()=>{ut.color=e.rgb(80,90,110)}),ut.onHoverEnd(()=>{ut.color=e.rgb(...y.BG_LIGHT)}));let $e=`${we.slotNumber}`;we.isEmpty||($e=(mr(we.selectedPortrait)||Zn.default).icon);const Qe=e.add([e.text($e,{size:we.isEmpty?Q.SMALL:Q.SMALL+2}),e.pos(A+18,he+Y/2),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);if(be.push(Qe),!we.isEmpty){const It=$t[we.selectedCharacter]||$t.survivor,Zt=e.add([e.text(It.char,{size:Q.SMALL}),e.pos(A+38,he+Y/2),e.anchor("left"),e.color(...It.color),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);be.push(Zt)}const ho=e.add([e.text(we.playerName.substring(0,16),{size:Q.SMALL-2}),e.pos(A+(we.isEmpty?32:55),he+Y/2),e.anchor("left"),e.color(we.isEmpty?y.TEXT_DISABLED:we.isLocal?y.GOLD:y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);if(be.push(ho),!we.isEmpty){const It=we.isReady?"":"",Zt=we.isReady?y.SUCCESS:y.TEXT_DISABLED,Io=e.add([e.text(It,{size:Q.SMALL-2}),e.pos(A+R-14,he+Y/2),e.anchor("center"),e.color(...Zt),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);be.push(Io);const wo=xm(re);if(wo){const fo=wo==="exclamation"?"!":"",Wo=wo==="exclamation"?[255,255,0]:[255,100,150],Nt=e.add([e.text(fo,{size:Q.SMALL+2}),e.pos(A+R-28,he+Y/2),e.anchor("center"),e.color(...Wo),e.fixed(),e.z(w.UI_TEXT+1),"partySlotUI"]);be.push(Nt)}}if(we.isDisconnected){const It=e.add([e.text("",{size:Q.SMALL-2}),e.pos(A+R-28,he+Y/2),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT),"partySlotUI"]);be.push(It)}F.push(be)})}V();let j=0;e.onUpdate(()=>{j+=e.dt(),j>=1&&(j=0,V(),typeof Tt=="function"&&Tt())});const ce=I+4*(Y+U)+6;e.add([e.text("Code:",{size:Q.SMALL-2}),e.pos(A+8,ce),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const ie=Gc(),ne=e.add([e.text(ie,{size:Q.SMALL-2}),e.pos(A+R-8,ce),e.anchor("right"),e.color(ie==="OFFLINE"?[...y.TEXT_DISABLED]:[...y.GOLD]),e.fixed(),e.z(w.UI_TEXT)]);let se=ie!=="OFFLINE";ne.onUpdate(()=>{if(!se){const ye=Gc();ye&&ye!=="OFFLINE"&&(ne.text=ye,ne.color=e.rgb(...y.GOLD),se=!0)}});const ge=ce+22;ss(e,"JOIN PARTY",A+R/2,ge,R-20,28,Q.SMALL).onClick(()=>{Ut(),e.go("joinParty")});const Oe=ge+30;let Ee=[],Ne=null,et={partySize:0,isReady:!1,countdownActive:!1,countdownSeconds:0};function Te(ye=!1){const we=Hn(),re=$c(),he=fm(),be=re.active?Math.ceil(re.timeRemaining/1e3):0;if(!(!ye&&et.partySize===we&&et.isReady===he&&et.countdownActive===re.active&&et.countdownSeconds===be)&&(et={partySize:we,isReady:he,countdownActive:re.active,countdownSeconds:be},Ee.forEach(Ze=>{Ze.exists()&&e.destroy(Ze)}),Ee=[],Ne&&Ne.exists()&&(e.destroy(Ne),Ne=null),we>=2)){const Ze=e.add([e.rect(R-20,24),e.pos(A+R/2,Oe),e.anchor("center"),e.color(he?100:60,he?150:80,he?100:120),e.outline(2,e.rgb(he?100:80,he?200:120,he?100:180)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS),"readyButtonUI"]);Ee.push(Ze);const ut=e.add([e.text(he?" READY":"READY UP",{size:Q.SMALL-2}),e.pos(A+R/2,Oe),e.anchor("center"),e.color(he?150:100,he?255:150,he?150:200),e.fixed(),e.z(w.UI_TEXT),"readyButtonUI"]);Ee.push(ut),Ze.onClick(()=>{Ut(),um(),Te(!0),V()}),re.active&&(Ne=e.add([e.text(`Starting in ${be}...`,{size:Q.SMALL-2}),e.pos(A+R/2,Oe+20),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT),"countdownUI"]))}}Te(!0);let Mt=0;e.onUpdate(()=>{if(Mt+=e.dt(),Mt<.1)return;Mt=0;const ye=$c();Hn()>=2&&Te(),ye.active&&ye.timeRemaining<=0&&fs().isHost&&(Ut(),Kc(),e.go("game",{resetState:!0}))});const fe=vo.RIGHT_COLUMN_WIDTH,Ce=120,le=a,Re=vo.TOP_MARGIN+50,Xe=S1(),Se=$t[Xe.character]||$t.survivor;e.add([e.rect(fe,Ce),e.pos(le,Re),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]),e.add([e.text("DAILY RUN",{size:Q.SMALL}),e.pos(le+fe/2,Re+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(Se.char,{size:28}),e.pos(le+fe/2,Re+45),e.anchor("center"),e.color(...Se.color),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(Se.name,{size:Q.SMALL-2}),e.pos(le+fe/2,Re+68),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const We=Hn()>1;if(Xe.completed)e.add([e.text("COMPLETED",{size:Q.SMALL-2}),e.pos(le+fe/2,Re+95),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT)]);else if(We)e.add([e.text("SOLO ONLY",{size:Q.SMALL-2}),e.pos(le+fe/2,Re+95),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);else{const ye=e.add([e.rect(fe-40,28),e.pos(le+fe/2,Re+95),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("PLAY",{size:Q.SMALL}),e.pos(le+fe/2,Re+95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),ye.onClick(()=>{Hn()>1||(Ut(),e.go("game",{resetState:!0,isDailyRun:!0,dailyCharacter:Xe.character,dailySeed:Xe.seed,dailyDate:Xe.date}))}),ye.onHoverUpdate(()=>{ye.color=e.rgb(...y.SECONDARY_HOVER)}),ye.onHoverEnd(()=>{ye.color=e.rgb(...y.SECONDARY)})}Gr(e,s);const Et=Re+Ce+15;e.add([e.rect(vo.RIGHT_COLUMN_WIDTH,100),e.pos(a,Et),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_BACKGROUND),"leaderboardsPanel"]),e.add([e.text("LEADERBOARDS",{size:Q.SMALL}),e.pos(a+vo.RIGHT_COLUMN_WIDTH/2,Et+15),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text("",{size:32}),e.pos(a+vo.RIGHT_COLUMN_WIDTH/2,Et+50),e.anchor("center"),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text("VIEW",{size:Q.SMALL-2}),e.pos(a+vo.RIGHT_COLUMN_WIDTH/2,Et+80),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const Pe=e.get("leaderboardsPanel")[0];Pe&&(Pe.onClick(()=>{Ut(),e.go("leaderboards")}),Pe.onHoverUpdate(()=>{Pe.color=e.rgb(...y.BG_LIGHT)}),Pe.onHoverEnd(()=>{Pe.color=e.rgb(...y.BG_MEDIUM)}));const Fe=160,Ae=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],Ie=[],Ye=12,je=Fe-Ae.length*Ye/2;Ae.forEach((ye,we)=>{const re=e.add([e.text(ye,{size:10,font:"monospace"}),e.pos(r,je+we*Ye),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.z(w.UI_TEXT),"titleLine"]);Ie.push(re)});let lt=0;e.onUpdate(()=>{lt+=e.dt(),Ie.forEach((ye,we)=>{const re=(lt*50+we*20)%360,he=yr(re,80,60);ye.color=e.rgb(...he);const be=Math.sin(lt*2+we*.3)*2;ye.pos.y=je+we*Ye+be,Math.random()<.001&&(ye.pos.x=r+(Math.random()-.5)*10,e.wait(.1,()=>{ye.exists()&&(ye.pos.x=r)}))})});const dt=310,rt=55,{XL:gt,LG:ht}=zn.BUTTON,Bt=ss(e,"ACTION!",r,dt,gt.width,gt.height,Q.H1);Bt.onClick(()=>{if(Bt.disabled)return;Ut(),Hn()>1&&Kc(),e.go("game",{resetState:!0})});function Tt(){const ye=fs(),re=Hn()>1&&!ye.isHost;Bt.setDisabled(re)}Tt();const yt=ss(e,"CONTESTANTS",r,dt+rt,ht.width,ht.height,Q.H2);yt.onClick(()=>{Ut(),e.go("characterSelect")});const Rt=mn(),Ge=$t[Rt];if(Ge){const ye=Yo("characters",Rt)||Ge.unlockedByDefault,we=r+ht.width/2+35,re=dt+rt,he=45,be=e.add([e.rect(he,he),e.pos(we,re),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_BACKGROUND)]),Ze=e.add([e.text(Ge.char,{size:28}),e.pos(we,re),e.anchor("center"),e.color(...ye?Ge.color:y.BG_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);be.onClick(()=>{Ut(),e.go("characterSelect")}),be.onHoverUpdate(()=>{be.color=e.rgb(...y.BG_LIGHT),Ze.scale=e.vec2(1.1)}),be.onHoverEnd(()=>{be.color=e.rgb(...y.BG_MEDIUM),Ze.scale=e.vec2(1)})}const Dt=ss(e,"MERCH",r,dt+rt*2,ht.width,ht.height,Q.H2);Dt.onClick(()=>{Ut(),e.go("shop")});const xe=ss(e,"RATINGS",r,dt+rt*3,ht.width,ht.height,Q.H2);xe.onClick(()=>{Ut(),e.go("statistics")});const at=ss(e,"OPTIONS",r,dt+rt*4,ht.width,ht.height,Q.H2);at.onClick(()=>{Ut(),e.go("settings")});const ae=[Bt,yt,Dt,xe,at];let Be=0;e.onUpdate(()=>{Be+=e.dt(),ae.forEach((ye,we)=>{if(!ye.exists()||ye.isHovered)return;const re=(Be*60+we*50)%360,he=yr(re,70,50),be=M1(re);try{ye.color=e.rgb(he[0],he[1],he[2]),ye.originalColor=he,ye.label&&ye.label.exists()&&(ye.label.color=e.rgb(be[0],be[1],be[2]))}catch{}})});const tt=e.onKeyPress("space",()=>{Bt.disabled||(Ut(),e.go("game",{resetState:!0}))}),ot=e.onKeyPress("c",()=>{ke(),e.go("characterSelect")}),L=e.onKeyPress("s",()=>{ke(),e.go("shop")}),K=e.onKeyPress("o",()=>{ke(),e.go("settings")}),ee=e.onKeyPress("t",()=>{ke(),e.go("statistics")});let ue=0;const nt=.5,st=e.onKeyPress("q",()=>{const ye=e.time();ye-ue<nt||(ue=ye,Jc("exclamation"),V())}),Lt=e.onKeyPress("e",()=>{const ye=e.time();ye-ue<nt||(ue=ye,Jc("heart"),V())}),ct=(ye,we)=>{V()};mm(ct),e.onSceneLeave(()=>{tt.cancel(),ot.cancel(),L.cancel(),K.cancel(),ee.cancel(),st.cancel(),Lt.cancel(),ym(ct)});for(let ye=0;ye<12;ye++){const we=e.add([e.text(["*","+",""][Math.floor(Math.random()*3)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(w.PARTICLES)]);we.speed=15+Math.random()*25,we.onUpdate(()=>{we.pos.y+=we.speed*e.dt(),we.pos.y>e.height()&&(we.pos.y=0,we.pos.x=Math.random()*e.width())})}const bt=["","","",""];for(let ye=0;ye<8;ye++){const we=e.add([e.text(bt[Math.floor(Math.random()*bt.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.1),e.scale(1),e.z(w.PARTICLES)]);we.pulseTime=Math.random()*Math.PI*2,we.pulseSpeed=1+Math.random()*1.5,we.onUpdate(()=>{we.pulseTime+=e.dt()*we.pulseSpeed;const re=.8+Math.sin(we.pulseTime)*.2;we.scale=e.vec2(re,re),we.opacity=.08+Math.abs(Math.sin(we.pulseTime))*.1})}e.add([e.text("v0.1.1",{size:Q.MICRO}),e.pos(e.width()-10,e.height()-10),e.anchor("botright"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]),e.loop(12,()=>{if(Math.random()<.12){const ye=100+Math.random()*(e.height()-200),we=Math.random()<.5?1:-1,re=we>0?-50:e.width()+50,he=e.add([e.text("$",{size:24}),e.pos(re,ye),e.color(...y.GOLD),e.area({scale:2.5}),e.anchor("center"),e.scale(1),e.z(w.PARTICLES+1),"goldenEnemy"]);he.speed=150+Math.random()*100,he.direction=we,he.pulseTime=0,he.onClick(()=>{if(!he.exists())return;ds(1);for(let Ze=0;Ze<8;Ze++){const ut=Math.PI*2*Ze/8,$e=e.add([e.text(["$",""][Math.floor(Math.random()*2)],{size:12}),e.pos(he.pos.x,he.pos.y),e.color(...y.GOLD),e.opacity(1),e.z(w.PARTICLES+2)]),Qe=80+Math.random()*60;$e.velocity=e.vec2(Math.cos(ut)*Qe,Math.sin(ut)*Qe),$e.life=.8,$e.onUpdate(()=>{$e.pos=$e.pos.add($e.velocity.scale(e.dt())),$e.life-=e.dt(),$e.opacity=$e.life/.8,$e.life<=0&&e.destroy($e)})}const be=e.add([e.text("+$1",{size:18}),e.pos(he.pos.x,he.pos.y),e.anchor("center"),e.color(...y.SUCCESS),e.opacity(1),e.z(w.UI_TEXT)]);be.life=1.2,be.onUpdate(()=>{be.pos.y-=40*e.dt(),be.life-=e.dt(),be.opacity=be.life/1.2,be.life<=0&&e.destroy(be)}),e.destroy(he),e.wait(.1,()=>e.go("menu"))}),he.onUpdate(()=>{he.pos.x+=he.speed*he.direction*e.dt(),he.pulseTime+=e.dt();const be=Math.sin(he.pulseTime*8)*.15;he.scale=e.vec2(1+be,1+be),(he.direction>0&&he.pos.x>e.width()+100||he.direction<0&&he.pos.x<-100)&&e.destroy(he)})}})})}function D1(e){const t=[];for(const[o,n]of Object.entries($t))n.unlockRequirement?.type==="achievement"&&n.unlockRequirement?.value===e&&t.push({key:o,...n});return t}let St={isOpen:!1,elements:[],k:null,onClose:null};function Fh(e,t,o=null){St.isOpen&&Di(),St.k=e,St.isOpen=!0,St.onClose=o,St.elements=[];const n=vs(),s=Ur(t.id),a=Gi(t.id,n),r=Oo[t.difficulty]||Oo.normal,l=420,c=400,d=e.width()/2,i=e.height()/2,h=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(w.MODAL-1),e.area(),"achievementModalOverlay"]);St.elements.push(h),h.onClick(()=>{Di()});const u=e.add([e.rect(l,c),e.pos(d,i),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...r)),e.fixed(),e.z(w.MODAL),"achievementModal"]);St.elements.push(u);const g=e.add([e.text(t.name,{size:Q.HEADER}),e.pos(d,i-130),e.anchor("center"),e.color(...s?r:y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(g);const p=e.add([e.rect(64,64),e.pos(d,i-70),e.anchor("center"),e.color(s?50:30,s?50:30,s?60:30),e.outline(2,e.rgb(...s?r:y.TEXT_DISABLED)),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(p);const T=e.add([e.text(t.icon,{size:36}),e.pos(d,i-70),e.anchor("center"),e.color(...s?[255,255,255]:[80,80,80]),e.fixed(),e.z(w.MODAL+2),"achievementModal"]);St.elements.push(T);const m=e.add([e.text(t.description,{size:Q.BODY,width:l-40}),e.pos(d,i-25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(m);const M=D1(t.id),P=t.unlocks&&t.unlocks.length>0,f=M.length>0;if(f||P){const R=[];if(M.forEach(Y=>{R.push(`${Y.char} ${Y.name}`)}),P&&t.unlocks.forEach(Y=>{const U=Zd[Y],N=ls[Y];U?R.push(U.name):N&&R.push(N.name)}),R.length>0){const Y=e.add([e.text(`Unlocks: ${R.join(", ")}`,{size:Q.SMALL,width:l-40}),e.pos(d,i+5),e.anchor("center"),e.color(...s?y.SUCCESS:y.GOLD),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(Y)}}const B=f||P?i+35:i+25;if(a&&!s){const U=B,N=e.add([e.rect(280,20),e.pos(d,U),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(80,80,100)),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(N);const H=Math.max(4,280*a.progress),I=e.add([e.rect(H,16),e.pos(d-280/2+H/2,U),e.anchor("center"),e.color(...r),e.opacity(.8),e.fixed(),e.z(w.MODAL+2),"achievementModal"]);St.elements.push(I);const F=e.add([e.text(`${a.current}/${a.target} (${a.percentage}%)`,{size:Q.SMALL}),e.pos(d,U+25),e.anchor("center"),e.color(...y.TEXT_TERTIARY),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(F)}else if(s){const R=e.add([e.text("UNLOCKED",{size:Q.LABEL}),e.pos(d,B),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(R)}const b=Jd(t);if(b>0){const R=B+(s?35:a?55:35),Y=e.add([e.text("-- REWARD --",{size:Q.SMALL}),e.pos(d,R),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(Y);const U=la(),N=e.add([e.text(`${U}${b}`,{size:Q.H2}),e.pos(d,R+25),e.anchor("center"),e.color(...s?y.SUCCESS:y.GOLD),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(N)}const S=t.difficulty.charAt(0).toUpperCase()+t.difficulty.slice(1),E=e.add([e.text(`${S}`,{size:Q.SMALL}),e.pos(d,i+c/2-60),e.anchor("center"),e.color(...r),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(E);const C=e.add([e.rect(80,30),e.pos(d,i+c/2-30),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.MODAL+1),"achievementModal"]);St.elements.push(C);const A=e.add([e.text("CLOSE",{size:Q.SMALL}),e.pos(d,i+c/2-30),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+2),"achievementModal"]);St.elements.push(A),C.onClick(()=>{ke(),Di()});const z=e.onKeyPress("escape",()=>{Di()});St.escHandler=z}function Di(){if(!St.isOpen)return;const e=St.k;e&&(St.elements.forEach(t=>{t&&t.exists&&t.exists()&&e.destroy(t)}),St.elements=[],St.escHandler&&(St.escHandler.cancel(),St.escHandler=null),St.isOpen=!1,St.onClose&&(St.onClose(),St.onClose=null))}function Yh(){return St.isOpen}const qh={allTime:{publicKey:"696eba6f8f40bb1184b6c60f",privateKey:"YRU5IdY0w0uJvRF8cb9S1A21WwOAek3kyr3RcOYHbdYA"},daily:{publicKey:"696ff2ee8f40bb1184b8cc92",privateKey:"SgdqIaI_fkWUlRVwoWLQlA1yEXBc-33UKZYWPWJcOX6Q"}},C1="https://corsproxy.io/?",R1="http://dreamlo.com/lb";function Gh(e){return`${C1}${encodeURIComponent(R1+e)}`}const I1=6e4,xr={allTime:{data:null,timestamp:0},daily:{data:null,timestamp:0}},P1=5e3;function Kh(e){return e&&e.replace(/[^a-zA-Z0-9_-]/g,"").substring(0,20)||"Anonymous"}function B1(e){return typeof e=="number"&&e>0&&e<=2e5}async function Vh(e,t=P1){const o=new AbortController,n=setTimeout(()=>o.abort(),t);try{const s=await fetch(e,{signal:o.signal});return clearTimeout(n),s}catch(s){throw clearTimeout(n),s}}async function ic(e,t="allTime"){try{if(!B1(e.score))return console.warn("[OnlineLeaderboards] Invalid score, skipping submission:",e.score),!1;const o=qh[t];if(!o)return console.warn("[OnlineLeaderboards] Unknown board type:",t),!1;const n=Kh(e.name),s=Math.floor(e.score),a=Math.floor(e.time||0),r=`${e.floor||1}|${e.character||"unknown"}|${e.date||""}`,l=`/${o.privateKey}/add/${encodeURIComponent(n)}/${s}/${a}/${encodeURIComponent(r)}`,c=Gh(l);console.log(`[OnlineLeaderboards] Submitting score to ${t}:`,{name:n,score:s,floor:e.floor});const d=await Vh(c);return d.ok?(console.log(`[OnlineLeaderboards] Score submitted to ${t} successfully`),xr[t].data=null,xr[t].timestamp=0,!0):(console.warn("[OnlineLeaderboards] Submission failed with status:",d.status),!1)}catch(o){return o.name==="AbortError"?console.warn("[OnlineLeaderboards] Submission timed out"):console.warn("[OnlineLeaderboards] Submission error:",o.message),!1}}async function L1(e){return ic(e,"daily")}function Il(e){const t=(e.text||"").split("|");return{name:e.name||"Anonymous",score:parseInt(e.score,10)||0,time:parseInt(e.seconds,10)||0,floor:parseInt(t[0],10)||1,character:t[1]||"survivor",date:t[2]||""}}async function Wh(e=10,t="allTime"){try{const o=qh[t];if(!o)return console.warn("[OnlineLeaderboards] Unknown board type:",t),{entries:[],totalCount:0,error:"Unknown board type"};const n=xr[t],s=Date.now();if(n.data&&s-n.timestamp<I1)return console.log(`[OnlineLeaderboards] Using cached ${t} leaderboard`),{entries:n.data.slice(0,e),totalCount:n.data.length,error:null};const a=Gh(`/${o.publicKey}/json`);console.log(`[OnlineLeaderboards] Fetching ${t} leaderboard...`);const r=await Vh(a);if(!r.ok)throw new Error(`HTTP ${r.status}`);const l=await r.json();let c=[];if(l?.dreamlo?.leaderboard?.entry){const d=l.dreamlo.leaderboard.entry;Array.isArray(d)?c=d.map(Il):c=[Il(d)]}return n.data=c,n.timestamp=s,console.log(`[OnlineLeaderboards] Fetched ${c.length} entries from ${t}`),{entries:c.slice(0,e),totalCount:c.length,error:null}}catch(o){return o.name==="AbortError"?(console.warn("[OnlineLeaderboards] Fetch timed out"),{entries:[],totalCount:0,error:"Connection timed out"}):(console.warn("[OnlineLeaderboards] Fetch error:",o.message),{entries:[],totalCount:0,error:"Could not connect to server"})}}async function z1(e,t){try{const o=await Wh(1e3);if(o.error)return{rank:null,total:0,error:o.error};const n=Kh(e),s=o.entries.findIndex(r=>r.name.toLowerCase()===n.toLowerCase());return s>=0?{rank:s+1,total:o.totalCount,error:null}:{rank:o.entries.filter(r=>r.score>t).length+1,total:o.totalCount+1,error:null}}catch(o){return console.warn("[OnlineLeaderboards] Error getting rank:",o.message),{rank:null,total:0,error:"Could not determine rank"}}}const $h="superSmashTextyLeaderboards",Oa=100,Ha=100;function ua(){try{const e=localStorage.getItem($h),t=e?JSON.parse(e):null;return{daily:t?.daily||{},allTime:t?.allTime||[],personal:t?.personal||{}}}catch(e){return console.warn("[Leaderboards] Failed to load leaderboards:",e),{daily:{},allTime:[],personal:{}}}}function O1(e){try{localStorage.setItem($h,JSON.stringify(e))}catch(t){console.warn("[Leaderboards] Failed to save leaderboards:",t)}}function H1(e){const t=e.floorsReached*1e3,o=(e.enemiesKilled||0)*10,n=(e.bossesKilled||0)*500,s=e.duration||0,a=Math.max(0,3e4-Math.floor(s*50));return t+o+n+a}function U1(e){const t=ua(),o=Mo(),n=e.date||Ko(),s={name:o,score:e.score||0,floor:e.floor||1,character:e.character||"survivor",time:e.time||0,date:n,timestamp:Date.now()};let a={rank:null,isNewBest:!1,dailyRank:null,isNewPersonalBest:!1};e.isDaily&&(t.daily[n]||(t.daily[n]=[]),t.daily[n].push(s),t.daily[n].sort((c,d)=>d.score-c.score),t.daily[n].length>Oa&&(t.daily[n]=t.daily[n].slice(0,Oa)),a.dailyRank=t.daily[n].findIndex(c=>c.timestamp===s.timestamp&&c.name===s.name)+1,(a.dailyRank===0||a.dailyRank>Oa)&&(a.dailyRank=null)),t.allTime.push(s),t.allTime.sort((c,d)=>d.score-c.score),t.allTime.length>Ha&&(t.allTime=t.allTime.slice(0,Ha)),a.rank=t.allTime.findIndex(c=>c.timestamp===s.timestamp&&c.name===s.name)+1,(a.rank===0||a.rank>Ha)&&(a.rank=null);const r=s.character;t.personal[r]||(t.personal[r]={bestScore:0,bestFloor:0,bestTime:1/0});const l=t.personal[r];return s.score>l.bestScore&&(l.bestScore=s.score,a.isNewBest=!0,a.isNewPersonalBest=!0),s.floor>l.bestFloor&&(l.bestFloor=s.floor,a.isNewPersonalBest=!0),s.floor>=3&&s.time<l.bestTime&&(l.bestTime=s.time,a.isNewPersonalBest=!0),O1(t),console.log("[Leaderboards] Score submitted:",s,"Result:",a),ic(s).catch(c=>{console.warn("[Leaderboards] Online submission failed:",c)}),a}function N1(e=null,t=10){const o=ua(),n=e||Ko();return(o.daily[n]||[]).slice(0,t)}function _1(e=10){return ua().allTime.slice(0,e)}function X1(){return ua().personal}function Pl(e){if(e===1/0||e===void 0||e===null)return"--:--";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t}:${o.toString().padStart(2,"0")}`}function wr(e){return(e||0).toLocaleString()}function Bl(e){if(e=Math.max(0,Math.min(1,e)),e<.5){const t=e*2;return[255,Math.round(200*t),50]}else{const t=(e-.5)*2;return[Math.round(255*(1-t)),200+Math.round(55*t),50+Math.round(100*t)]}}function Ua(e,t={}){const{label:o="",value:n=0,maxValue:s=100,x:a=0,y:r=0,width:l=80,color:c=y.PRIMARY,usePercentageColor:d=!1}=t,i=[],h=6,u=n/s,g=d?Bl(u):c,p=e.add([e.text(o,{size:Q.TINY}),e.pos(a,r),e.anchor("topleft"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);i.push(p);const T=e.add([e.rect(l,h),e.pos(a,r+14),e.anchor("topleft"),e.color(...y.BG_DARK),e.outline(1,e.rgb(50,50,60)),e.fixed(),e.z(w.UI_ELEMENTS)]);i.push(T);const m=Math.max(0,(l-2)*u),M=e.add([e.rect(m,h-2),e.pos(a+1,r+15),e.anchor("topleft"),e.color(...g),e.fixed(),e.z(w.UI_ELEMENTS+1)]);i.push(M);const P=e.add([e.text(`${n}`,{size:Q.MICRO}),e.pos(a+l+4,r+10),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);return i.push(P),{elements:i,updateValue:B=>{const b=Math.max(0,Math.min(s,B)),S=b/s;if(M.width=Math.max(0,(l-2)*S),P.text=`${b}`,d){const E=Bl(S);M.color=e.rgb(...E)}},destroy:()=>{i.forEach(B=>{B.exists()&&e.destroy(B)})}}}function F1(e){return ms[e]?.name?ms[e].name:jn[e]?.name?jn[e].name:tn[e]?.name?tn[e].name:e}function Y1(e){return ms[e]?.char||jn[e]?.char||tn[e]?.char||"E"}function q1(e){return ms[e]?.color||jn[e]?.color||tn[e]?.color||[255,100,100]}const Ll=["$","","","",""],zl=[{id:"slayer",title:"Slayer",icon:"",desc:"Most enemy kills",check:e=>e.kills||0,color:[255,100,100]},{id:"collector",title:"Hoarder",icon:"",desc:"Most credits collected",check:e=>e.creditsPickedUp||0,color:[255,215,0]},{id:"bossBuster",title:"Boss Buster",icon:"",desc:"Most bosses defeated",check:e=>e.bossesKilled||0,color:[255,150,50]}];function G1(e){e.scene("gameOver",t=>{Ch(),rx();const o=t?.runStats||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{}},n=t?.currencyEarned||0;$n(),Tg();const s=la(),a=t?.partyStats||[],r=t?.isDailyRun||!1,l=t?.dailyCharacter||null,c=t?.dailyDate||Ko(),d=o.startTime?(Date.now()-o.startTime)/1e3:0,i=H1({floorsReached:o.floorsReached||1,enemiesKilled:o.enemiesKilled||0,bossesKilled:o.bossesKilled||0,duration:d}),h=l||mn(),u=U1({score:i,floor:o.floorsReached||1,character:h,time:d,isDaily:r,date:c}),g=Mo(),p=de(),T={name:g,score:i,floor:o.floorsReached||1,character:h,time:d,date:c};ic(T,"allTime"),r&&L1(T),r&&E1({score:i,floor:o.floorsReached||1,character:h,duration:d});const m=a.length>0?a.reduce((re,he)=>re+(he.creditsPickedUp||0),0):n,M=Zx(),P=Yg({floorsReached:o.floorsReached||1,enemiesKilled:o.enemiesKilled||0,bossesKilled:o.bossesKilled||0,isDailyRun:r}),_=Fg(P).levelsGained>0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(20,15,25),e.opacity(.98),e.fixed(),e.z(w.OVERLAY)]);const B=25;e.add([e.text("BROADCAST TERMINATED",{size:28}),e.pos(e.width()/2,B),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.MODAL)]),e.add([e.text(`SCORE: ${wr(i)}`,{size:22}),e.pos(e.width()/2,B+32),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL)]),e.add([e.text(`Floor ${o.floorsReached} | ${o.roomsCleared} Rooms | ${o.enemiesKilled} Kills | ${Math.floor(d)}s`,{size:12}),e.pos(e.width()/2,B+54),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL)]);const b=B+75;let S="";r&&u.dailyRank?(S=`Daily #${u.dailyRank}`,u.dailyRank===1&&(S+=" NEW RECORD!")):u.rank&&(S=`All-Time #${u.rank}`,u.isNewBest&&(S+=" PERSONAL BEST!")),S&&e.add([e.text(S,{size:14}),e.pos(e.width()/2-120,b),e.anchor("center"),e.color(...u.isNewBest?y.SUCCESS:y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL)]);const E=e.add([e.text("Global: ...",{size:14}),e.pos(e.width()/2+120,b),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL)]);z1(g,i).then(re=>{E.exists()&&(re.error?E.text="Global: offline":re.rank?(E.text=`Global #${re.rank} of ${re.total}`,E.color=e.rgb(...y.GOLD)):E.text="Global: unranked")});const C=b+30,A=Math.max(a.length,1),z=a.length>0?a:[{name:g,characterData:{char:"@",color:[255,255,255]},kills:o.enemiesKilled,creditsPickedUp:n,bossesKilled:o.bossesKilled,achievements:M}],R={};if(z.length===1){const re=z[0];zl.forEach(he=>{he.check(re)>0&&(R[re.name]||(R[re.name]=[]),R[re.name].push(he))})}else zl.forEach(re=>{let he=null,be=0;z.forEach(Ze=>{const ut=re.check(Ze);ut>be&&(be=ut,he=Ze)}),he&&be>0&&(R[he.name]||(R[he.name]=[]),R[he.name].push(re))});const U=Math.min(e.width()-210-30,500),N=20,H=(U-80)/A,I=28,F=80,V=I*7+10;e.add([e.rect(U,V),e.pos(N,C),e.color(30,25,35),e.outline(2,e.rgb(60,50,80)),e.fixed(),e.z(w.MODAL)]);let j=C+8;z.forEach((re,he)=>{const be=N+F+he*H+H/2,Ze=re.characterData?.char||"@",ut=re.characterData?.color||[255,255,255];e.add([e.text(Ze,{size:20}),e.pos(be,j+3),e.anchor("center"),e.color(...ut),e.fixed(),e.z(w.MODAL+1)]);const $e=A<=2?16:A===3?12:10,Qe=(re.name||`P${he+1}`).substring(0,$e);e.add([e.text(Qe,{size:11}),e.pos(be,j+20),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL+1)])}),j+=I+8,[{label:"Kills",getValue:re=>re.kills||0,color:y.DANGER},{label:"Credits",getValue:re=>re.creditsPickedUp||0,color:y.GOLD},{label:"Bosses",getValue:re=>re.bossesKilled||0,color:[255,150,50]}].forEach(re=>{e.add([e.text(re.label,{size:12}),e.pos(N+10,j),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]),z.forEach((he,be)=>{const Ze=N+F+be*H+H/2,ut=re.getValue(he);e.add([e.text(String(ut),{size:14}),e.pos(Ze,j),e.anchor("center"),e.color(...re.color),e.fixed(),e.z(w.MODAL+1)])}),j+=I}),e.add([e.text("Awards",{size:12}),e.pos(N+10,j),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]);let ie=null;function ne(re,he){ie&&ie.forEach(It=>{It.exists()&&e.destroy(It)});const be=220,Ze=100,ut=e.width()/2,$e=e.height()/2,Qe=[];Qe.push(e.add([e.rect(be,Ze),e.pos(ut,$e),e.anchor("center"),e.color(30,25,40),e.outline(3,e.rgb(...re.color)),e.fixed(),e.z(w.MODAL+100)])),Qe.push(e.add([e.text(re.icon,{size:28}),e.pos(ut,$e-28),e.anchor("center"),e.color(...re.color),e.fixed(),e.z(w.MODAL+101)])),Qe.push(e.add([e.text(re.title,{size:16}),e.pos(ut,$e),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.MODAL+101)])),Qe.push(e.add([e.text(re.desc,{size:11}),e.pos(ut,$e+18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+101)]));const ho=A>1?`Earned by ${he.name}`:"Earned this run";Qe.push(e.add([e.text(ho,{size:10}),e.pos(ut,$e+34),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(w.MODAL+101)])),ie=Qe,e.wait(.1,()=>{const It=e.onClick(()=>{It.cancel(),ie&&(ie.forEach(Zt=>{Zt.exists()&&e.destroy(Zt)}),ie=null)})})}z.forEach((re,he)=>{const be=N+F+he*H+H/2,Ze=R[re.name]||[];if(Ze.length>0){const Qe=Ze.length*22+(Ze.length-1)*4,ho=be-Qe/2+22/2;Ze.forEach((It,Zt)=>{const Io=ho+Zt*26,wo=e.add([e.rect(22,22),e.pos(Io,j),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...It.color)),e.area(),e.fixed(),e.z(w.MODAL+1)]);e.add([e.text(It.icon,{size:12}),e.pos(Io,j),e.anchor("center"),e.color(255,220,100),e.fixed(),e.z(w.MODAL+2)]),wo.onClick(()=>{ke(),ne(It,re)}),wo.cursor="pointer"})}else e.add([e.text("-",{size:14}),e.pos(be,j),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)])}),j+=I,e.add([e.text("Unlocks",{size:12}),e.pos(N+10,j),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]),z.forEach((re,he)=>{const be=N+F+he*H+H/2,Ze=re.achievements||(he===0?M:[]);if(Ze.length>0){const ut=Math.min(Ze.length,3),$e=22,Qe=4,ho=ut*$e+(ut-1)*Qe,It=be-ho/2+$e/2;if(Ze.slice(0,ut).forEach((Zt,Io)=>{const wo=an[Zt];if(!wo)return;const fo=It+Io*($e+Qe),Wo=Oo[wo.difficulty]||Oo.normal,Nt=e.add([e.rect($e,$e),e.pos(fo,j),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...Wo)),e.area(),e.fixed(),e.z(w.MODAL+1)]);e.add([e.text(wo.icon,{size:12}),e.pos(fo,j),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.MODAL+2)]),Nt.onClick(()=>{ke(),Fh(e,wo)}),Nt.cursor="pointer"}),Ze.length>ut){const Zt=Ze.length-ut,Io=It+ut*($e+Qe);e.add([e.text(`+${Zt}`,{size:10}),e.pos(Io,j),e.anchor("left"),e.color(200,180,100),e.fixed(),e.z(w.MODAL+1)])}}else e.add([e.text("-",{size:14}),e.pos(be,j),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)])});const se=C+V+15,ge=A===1?240:A===2?180:A===3?140:110,ve=10,Ee=(U-20-(A-1)*ve)/A,Ne=Math.min(ge,Ee),et=A===1?100:80,Te=A*Ne+(A-1)*ve,Mt=N+(U-Te)/2+Ne/2,fe=[];z.forEach((re,he)=>{const be=Mt+he*(Ne+ve),Ze=re.creditsPickedUp||0;e.add([e.rect(Ne-10,et),e.pos(be,se+et/2),e.anchor("center"),e.outline(3,e.rgb(...y.TEXT_DISABLED)),e.color(0,0,0),e.opacity(.5),e.fixed(),e.z(w.MODAL)]);const ut=A===1?20:16,$e=e.add([e.text(`0 ${s}`,{size:ut}),e.pos(be,se+et+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL+10)]);fe.push({x:be,y:se,width:Ne-10,height:et,credits:Ze,label:$e,particles:[],spawnedCount:0,displayedCount:0})});const Ce=A===1?50:35,le=.06,Re=280;let Xe=0;const Se=.5;e.onUpdate(()=>{Xe+=e.dt(),!(Xe<Se)&&fe.forEach((re,he)=>{if(re.credits<=0)return;const be=Math.min(re.credits,Ce),Ze=re.credits/be,ut=Xe-Se-he*.12,$e=Math.floor(ut/le);for(;re.spawnedCount<be&&re.spawnedCount<$e;){const Qe=re.x+(Math.random()-.5)*(re.width-16),ho=re.y-30-Math.random()*25,It=Ll[Math.floor(Math.random()*Ll.length)],Zt=e.add([e.text(It,{size:14}),e.pos(Qe,ho),e.anchor("center"),e.color(255,215,0),e.opacity(1),e.fixed(),e.z(w.MODAL+5),"currencyParticle",{velocity:Re+Math.random()*60,landed:!1,value:Ze}]);re.particles.push(Zt),re.spawnedCount++}re.particles.forEach(Qe=>{if(!Qe.exists()||Qe.landed)return;Qe.pos.y+=Qe.velocity*e.dt();const ho=re.y+re.height-6,It=re.particles.filter(Io=>Io.landed).length*1.5,Zt=ho-It;Qe.pos.y>=Zt&&(Qe.pos.y=Zt,Qe.landed=!0,re.displayedCount+=Qe.value,re.label.text=`${Math.floor(re.displayedCount)} ${s}`,Qe.opacity=.85)})})});const it=e.width()-110,We=C,Et=180,Ct=V+et+30;e.add([e.rect(Et,Ct),e.pos(it-Et/2,We),e.color(25,20,30),e.outline(2,e.rgb(50,40,60)),e.fixed(),e.z(w.MODAL)]),e.add([e.text("STAFF",{size:14}),e.pos(it,We+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text("TERMINATED",{size:14}),e.pos(it,We+26),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL+1)]);const Pe=o.killsByType||{},Fe=Object.entries(Pe).filter(([re,he])=>he>0).sort((re,he)=>he[1]-re[1]);let Ae=We+48;const Ie=20,Ye=Math.floor((Ct-60)/Ie);if(Fe.length===0)e.add([e.text("No staff",{size:12}),e.pos(it,Ae+10),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text("harmed",{size:12}),e.pos(it,Ae+24),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)]);else{const re=Math.min(Fe.length,Ye);for(let he=0;he<re;he++){const[be,Ze]=Fe[he],ut=Y1(be),$e=q1(be);e.add([e.text(ut,{size:14}),e.pos(it-70,Ae),e.anchor("center"),e.color(...$e),e.fixed(),e.z(w.MODAL+1)]);const Qe=F1(be),ho=Qe.length>14?Qe.substring(0,12)+"..":Qe;e.add([e.text(ho,{size:10}),e.pos(it-50,Ae),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text(`x${Ze}`,{size:11}),e.pos(it+70,Ae),e.anchor("right"),e.color(...y.DANGER),e.fixed(),e.z(w.MODAL+1)]),Ae+=Ie}if(Fe.length>re){const he=Fe.slice(re).reduce((be,[Ze,ut])=>be+ut,0);e.add([e.text(`+${he} more`,{size:10}),e.pos(it,Ae),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.MODAL+1)])}}const je=e.height()-90;e.add([e.text(`+${m} ${s}`,{size:16}),e.pos(e.width()/2-100,je),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.MODAL)]);const lt=_?y.SUCCESS:[150,200,255],dt=_?`+${P} XP (LEVEL UP!)`:`+${P} XP`;e.add([e.text(dt,{size:16}),e.pos(e.width()/2+100,je),e.anchor("center"),e.color(...lt),e.fixed(),e.z(w.MODAL)]);const rt=ri(),gt=Nr(),ht=da(),Bt=sh();e.add([e.text(`Level ${rt}`,{size:12}),e.pos(e.width()/2,je+18),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.MODAL)]);const Tt=200,yt=8,Rt=e.width()/2,Ge=je+32;e.add([e.rect(Tt,yt),e.pos(Rt,Ge),e.anchor("center"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(w.MODAL)]);const Dt=Math.max(2,Tt*gt);e.add([e.rect(Dt,yt-2),e.pos(Rt-Tt/2+Dt/2+1,Ge),e.anchor("center"),e.color(100,180,255),e.fixed(),e.z(w.MODAL+1)]),e.add([e.text(`${ht} / ${Bt} XP`,{size:10}),e.pos(e.width()/2,Ge+12),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.MODAL)]);const xe=me(),at=e.height()-30,{MD:ae,SM:Be}=zn.BUTTON,tt=20,ot=!p||xe,L=p&&!xe?"Waiting...":"PLAY AGAIN",K=ae.width,ee=ae.height,ue=Be.width,nt=Be.height,st=K+tt+ue,Lt=e.width()/2-st/2,ct=e.add([e.rect(K,ee),e.pos(Lt+K/2,at),e.anchor("center"),e.color(...ot?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(...ot?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(w.MODAL)]),bt=e.add([e.text(L,{size:Q.H2}),e.pos(Lt+K/2,at),e.anchor("center"),e.color(...ot?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(w.MODAL+1)]),ye=e.add([e.rect(ue,nt),e.pos(Lt+K+tt+ue/2,at),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.scale(1),e.z(w.MODAL)]),we=e.add([e.text("MENU",{size:Q.SMALL}),e.pos(Lt+K+tt+ue/2,at),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.scale(1),e.z(w.MODAL+1)]);ot&&(ct.onHoverUpdate(()=>{ct.color=e.rgb(...y.SUCCESS_HOVER||[80,180,80]),ct.scale=e.vec2(1.02,1.02),bt.scale=e.vec2(1.02,1.02)}),ct.onHoverEnd(()=>{ct.color=e.rgb(...y.SUCCESS),ct.scale=e.vec2(1,1),bt.scale=e.vec2(1,1)})),ye.onHoverUpdate(()=>{ye.color=e.rgb(...y.NEUTRAL_HOVER),ye.scale=e.vec2(1.02,1.02),we.scale=e.vec2(1.02,1.02)}),ye.onHoverEnd(()=>{ye.color=e.rgb(...y.NEUTRAL),ye.scale=e.vec2(1,1),we.scale=e.vec2(1,1)}),ot&&ct.onClick(()=>{Ut(),p&&xe&&Ke("game_restart",{}),e.go("game",{resetState:!0})}),ye.onClick(()=>{ke(),p&&!xe&&Ot("game_restart"),e.go("menu")}),p&&!xe&&He("game_restart",()=>{Ut(),Ot("game_restart"),e.go("game",{resetState:!0})}),e.onKeyPress("space",()=>{p&&!xe||(Ut(),p&&xe&&Ke("game_restart",{}),e.go("game",{resetState:!0}))}),e.onKeyPress("escape",()=>{Yh()||(ke(),p&&!xe&&Ot("game_restart"),e.go("menu"))})})}function K1(e){e.scene("shop",()=>{const t=A=>(A.preventDefault(),!1);document.addEventListener("contextmenu",t),e.onSceneLeave(()=>{document.removeEventListener("contextmenu",t)});const o=$n(),n=la();let s="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),di(e,"MERCH",e.width()/2,35,8);const a=Gr(e,o),r=80,l=95,c=85,d=30,i=[{key:"permanentUpgrades",label:"Upgrades"},{key:"boosters",label:"Boosters"},{key:"cosmetics",label:"Cosmetics"},{key:"weapons",label:"Weapons"},{key:"characters",label:"Chars"}],h=(i.length-1)*l,u=e.width()/2-h/2,g=[];i.forEach((A,z)=>{const R=u+z*l,Y=s===A.key,U=e.add([e.rect(c,d),e.pos(R,r),e.anchor("center"),e.color(...Y?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),N=e.add([e.text(A.label,{size:Q.BODY}),e.pos(R,r),e.anchor("center"),e.color(...Y?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(w.UI_TEXT)]);U.onClick(()=>{ke(),s=A.key,m=0,B()}),g.push({bg:U,label:N,category:A.key})});const p=130;e.height()-p-100;let T=[],m=0;const M=6;let P=[],f=!1,_=!1;function B(){const A=$n();a.updateCurrency(A),g.forEach(ne=>{const se=s===ne.category;ne.bg.color=e.rgb(se?100:50,se?100:50,se?150:80),ne.label.color=e.rgb(se?255:150,se?255:150,se?255:150)}),E(),T.forEach(ne=>{ne.exists()&&e.destroy(ne)}),T=[],P.forEach(ne=>{ne.exists()&&e.destroy(ne)}),P=[];const z=Sg(s),Y=Object.keys(z).filter(ne=>{const se=z[ne];return s==="permanentUpgrades"||s==="boosters"?!0:!se.unlockedByDefault});if(Y.length===0){const ne=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,p+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);T.push(ne);return}const U=Math.ceil(Y.length/M);m>=U&&(m=Math.max(0,U-1));const N=m*M,H=Y.slice(N,N+M),I=340,F=105,V=F+8,j=p+5,ce=3,ie=ne=>{if(!ne)return null;const se=ne.toLowerCase();return se.includes("hp")||se.includes("health")?{icon:"",color:[255,100,100]}:se.includes("damage")||se.includes("dmg")?{icon:"",color:[255,200,100]}:se.includes("speed")?{icon:"",color:[100,200,255]}:se.includes("crit")?{icon:"",color:[255,255,100]}:se.includes("xp")||se.includes("pickup")?{icon:"",color:[100,255,200]}:se.includes("defense")||se.includes("reduction")?{icon:"",color:[150,150,255]}:se.includes("credit")||se.includes("silver")?{icon:"$",color:[200,150,50]}:se.includes("level")?{icon:"",color:[200,100,255]}:se.includes("invuln")||se.includes("immunity")?{icon:"",color:[100,255,255]}:se.includes("trail")||se.includes("glow")||se.includes("effect")?{icon:"",color:[200,150,255]}:null};if(H.forEach((ne,se)=>{const ge=z[ne],ve=Math.floor(se/ce),Oe=se%ce,Ee=45+ve*(I+15),Ne=j+Oe*V,et=ge.requiredAchievement||(ge.unlockRequirement?.type==="achievement"?ge.unlockRequirement.value:null),Te=et?!Ur(et):!1,Mt=et?jd(et):null,fe=s==="characters"&&Yo("characters",ne),Ce=s==="weapons"&&Yo("weapons",ne),le=s==="permanentUpgrades"&&Pt(ne)>=(ge.maxLevel||1),Re=s==="cosmetics"&&ge.requiredAchievement&&!Te,Xe=s==="cosmetics"&&(Yo("cosmetics",ne)||ge.unlockedByDefault||Re),Se=s==="cosmetics"&&_g(ge.category)===ne;let it,We;Te?(it=e.rgb(60,50,50),We=[30,25,25]):Se?(it=e.rgb(100,200,255),We=[35,45,55]):le||fe||Ce||Xe?(it=e.rgb(80,150,80),We=[35,45,35]):(it=e.rgb(80,80,120),We=[35,35,45]);const Et=e.add([e.rect(I,F),e.pos(Ee,Ne),e.anchor("topleft"),e.color(...We),e.outline(2,it),e.area(),e.fixed(),e.z(1e3)]);let Ct=Ee+10;if((s==="characters"||s==="weapons")&&ge.char){const ae=e.add([e.rect(40,40),e.pos(Ee+8,Ne+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),Be=e.add([e.text(ge.char,{size:28}),e.pos(Ee+28,Ne+28),e.anchor("center"),e.color(...Te?[60,60,60]:ge.color||[200,200,200]),e.fixed(),e.z(1002)]);T.push(ae,Be),Ct=Ee+55}if(s==="cosmetics"){const ae=ge.category==="trail"?"~":ge.category==="death"?"":"";let Be;ge.color==="rainbow"?Be=[255,100,200]:Array.isArray(ge.color)?Be=ge.color:Be=[150,150,200];const tt=Te?[60,60,70]:Be,ot=Te?[50,50,60]:Be,L=e.add([e.rect(36,36),e.pos(Ee+8,Ne+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(...ot)),e.fixed(),e.z(1001)]),K=e.add([e.text(ae,{size:22}),e.pos(Ee+26,Ne+26),e.anchor("center"),e.color(...tt),e.fixed(),e.z(1002)]);T.push(L,K),Ct=Ee+50}const Pe=e.add([e.text(ge.name,{size:16}),e.pos(Ct,Ne+10),e.anchor("topleft"),e.color(Te?100:255,Te?100:255,Te?100:255),e.fixed(),e.z(1001)]),Fe=ie(ge.description);if(Fe&&!Te){const ae=e.add([e.text(Fe.icon,{size:18}),e.pos(Ee+I-12,Ne+12),e.anchor("topright"),e.color(...Fe.color),e.fixed(),e.z(1001)]);T.push(ae)}if(Te){const ae=e.add([e.text("(X)",{size:14}),e.pos(Ee+I-10,Ne+10),e.anchor("topright"),e.color(150,80,80),e.fixed(),e.z(1002)]);T.push(ae)}const Ae=I-Ct+Ee-90,Ie=Ne+30;let Ye=ge.description,je=null;if(Te&&Mt){const ae=vs();ae&&(je=Gi(Mt.id,ae)),je?Ye=`${Mt.name} (${je.current}/${je.target})`:Ye=`Requires: ${Mt.name}`}const lt=e.add([e.text(Ye,{size:12,width:Ae}),e.pos(Ct,Ie),e.anchor("topleft"),e.color(Te?140:180,Te?110:180,Te?110:180),e.fixed(),e.z(1001)]);if(Te&&je&&je.target>1){const ae=Math.min(Ae,120),Be=4,tt=Ct,ot=Ie+18,L=e.add([e.rect(ae,Be),e.pos(tt,ot),e.anchor("topleft"),e.color(40,35,45),e.fixed(),e.z(1001)]);T.push(L);const K=Math.max(0,je.progress*ae);if(K>0){const ee=e.add([e.rect(K,Be),e.pos(tt,ot),e.anchor("topleft"),e.color(100,80,130),e.fixed(),e.z(1002)]);T.push(ee)}}const dt=Ne+F-28,rt=Ee+I-85,gt=75,ht=24;function Bt(ae){const Be=[50,65,90,115,160];return ae<Be.length?Be[ae]:160+(ae-4)*50}let Tt="",yt=!1,Rt=ge.cost,Ge=!1,Dt=0,xe=1;if(s==="permanentUpgrades"){const ae=Pt(ne),Be=ge.maxLevel||1;Dt=ae,xe=Be,Ge=!0,ae>=Be?Tt="MAXED":(Rt=Bt(ae),yt=o>=Rt)}else if(s==="boosters"){const ae=Pg();Tt=ae>0?`Ready (${ae})`:"Consumable",yt=o>=Rt}else s==="cosmetics"?(ge.category,Se?Tt="EQUIPPED":Xe?Tt=Re?"UNLOCKED":"OWNED":Te||(yt=o>=Rt)):s==="characters"?fe||(yt=o>=Rt):s==="weapons"&&(Ce||(yt=o>=Rt));if(Ge){const tt=Ct,ot=dt+8,L=e.add([e.rect(100,8),e.pos(tt,ot),e.anchor("topleft"),e.color(30,30,40),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),K=Math.max(0,Dt/xe*98);if(K>0){const ue=e.add([e.rect(K,6),e.pos(tt+1,ot+1),e.anchor("topleft"),e.color(Dt>=xe?100:80,Dt>=xe?200:150,Dt>=xe?100:80),e.fixed(),e.z(1002)]);T.push(ue)}const ee=e.add([e.text(`${Dt}/${xe}`,{size:10}),e.pos(tt+100+8,ot+4),e.anchor("left"),e.color(Dt>=xe?100:150,Dt>=xe?255:200,Dt>=xe?100:150),e.fixed(),e.z(1001)]);T.push(L,ee)}let at=null;if(Tt&&!Ge){let ae;switch(Tt){case"EQUIPPED":ae=[100,200,255];break;case"UNLOCKED":ae=[180,140,255];break;case"MAXED":case"OWNED":ae=[100,200,100];break;default:ae=[180,180,180]}at=e.add([e.text(Tt,{size:11}),e.pos(Ct,dt+7),e.anchor("topleft"),e.color(...ae),e.fixed(),e.z(1001)])}if(Te&&Mt){const ae=e.add([e.rect(gt,ht),e.pos(rt,dt),e.anchor("topleft"),e.color(50,40,60),e.outline(1,e.rgb(100,80,130)),e.area({width:gt,height:ht}),e.fixed(),e.z(1010)]),Be=e.add([e.text("VIEW",{size:11}),e.pos(rt+gt/2,dt+ht/2),e.anchor("center"),e.color(160,130,200),e.fixed(),e.z(1011)]);ae.onHover(()=>{ae.color=e.rgb(70,55,85),ae.outline.color=e.rgb(140,110,180),Be.color=e.rgb(200,170,255)}),ae.onHoverEnd(()=>{ae.color=e.rgb(50,40,60),ae.outline.color=e.rgb(100,80,130),Be.color=e.rgb(160,130,200)});const tt=Mt;ae.onClick(()=>{ke(),Fh(e,tt)}),ae.cursor="pointer",T.push(ae,Be)}else if(Te){const ae=e.add([e.text("LOCKED",{size:11}),e.pos(rt+gt/2,dt+ht/2),e.anchor("center"),e.color(100,80,80),e.fixed(),e.z(1001)]);T.push(ae)}else if(yt||s==="permanentUpgrades"&&Dt<xe){const ae=e.add([e.rect(gt,ht),e.pos(rt,dt),e.anchor("topleft"),e.color(yt?40:30,yt?120:40,yt?40:30),e.outline(1,e.rgb(yt?80:50,yt?180:60,yt?80:50)),e.area(),e.fixed(),e.z(1001)]),Be=e.add([e.text(`$${Rt}`,{size:12}),e.pos(rt+gt/2,dt+ht/2),e.anchor("center"),e.color(yt?255:120,yt?255:120,yt?255:120),e.fixed(),e.z(1002)]);if(s==="permanentUpgrades"&&Dt>0){let tt=null;tt=e.onMouseRelease("right",()=>{const ot=e.mousePos();if(ot.x>=rt&&ot.x<=rt+gt&&ot.y>=dt&&ot.y<=dt+ht){if(f)return;f=!0;const L=Lg(ne);if(L&&L.success){vi();const K=e.add([e.text(`Refunded $${L.refundAmount}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{K.exists()&&e.destroy(K)}),B(),e.wait(.2,()=>{f=!1})}else f=!1}}),ae.onDestroy(()=>{tt&&tt.cancel()})}yt&&ae.onClick(()=>{if(f)return;f=!0;let tt;if(s==="permanentUpgrades"?tt=Rg(ne,Rt,ge.maxLevel):s==="boosters"?tt=Ig(ne,Rt):tt=Cg(s,ne,Rt),s==="permanentUpgrades"||s==="boosters")if(tt&&tt.success){vi();const ot=s==="boosters"?"Booster Ready!":"Purchased!",L=e.add([e.text(ot,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{L.exists()&&e.destroy(L)}),B(),e.wait(.2,()=>{f=!1})}else if(tt&&tt.reason==="insufficientCurrency"){Pa();const ot=e.add([e.text(`Not enough ${n}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ot.exists()&&e.destroy(ot)}),f=!1}else f=!1;else if(tt){vi();const ot=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ot.exists()&&e.destroy(ot)}),B(),e.wait(.2,()=>{f=!1})}else{Pa();const ot=e.add([e.text(`Not enough ${n}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ot.exists()&&e.destroy(ot)}),f=!1}}),T.push(ae,Be)}else if(s==="cosmetics"&&Xe&&!Se){const ae=e.add([e.rect(gt,ht),e.pos(rt,dt),e.anchor("topleft"),e.color(40,80,120),e.outline(1,e.rgb(80,140,200)),e.area(),e.fixed(),e.z(1001)]),Be=e.add([e.text("EQUIP",{size:11}),e.pos(rt+gt/2,dt+ht/2),e.anchor("center"),e.color(200,230,255),e.fixed(),e.z(1002)]);ae.onHover(()=>{ae.color=e.rgb(50,100,150),ae.outline.color=e.rgb(100,170,240),Be.color=e.rgb(230,245,255)}),ae.onHoverEnd(()=>{ae.color=e.rgb(40,80,120),ae.outline.color=e.rgb(80,140,200),Be.color=e.rgb(200,230,255)}),ae.onClick(()=>{f||(f=!0,ke(),_c(ge.category,ne),f=!1,B())}),ae.cursor="pointer",T.push(ae,Be)}else if(s==="cosmetics"&&Se&&!ne.includes("None")){const ae=e.add([e.rect(gt,ht),e.pos(rt,dt),e.anchor("topleft"),e.color(80,50,50),e.outline(1,e.rgb(160,100,100)),e.area(),e.fixed(),e.z(1001)]),Be=e.add([e.text("UNEQUIP",{size:11}),e.pos(rt+gt/2,dt+ht/2),e.anchor("center"),e.color(255,180,180),e.fixed(),e.z(1002)]);ae.onHover(()=>{ae.color=e.rgb(100,60,60),ae.outline.color=e.rgb(200,120,120),Be.color=e.rgb(255,210,210)}),ae.onHoverEnd(()=>{ae.color=e.rgb(80,50,50),ae.outline.color=e.rgb(160,100,100),Be.color=e.rgb(255,180,180)}),ae.onClick(()=>{if(f)return;f=!0,ke();const tt=ge.category+"None";_c(ge.category,tt),f=!1,B()}),ae.cursor="pointer",T.push(ae,Be)}T.push(Et,Pe,lt),at&&T.push(at)}),U>1){const ne=e.height()-115,se=e.width()/2,ge=20,ve=se-(U-1)*ge/2,Oe=se+(U-1)*ge/2,Ee=35,Ne=ve-Ee,et=Oe+Ee,Te=e.add([e.rect(30,30),e.pos(Ne,ne),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+10)]),Mt=e.add([e.text("<",{size:24}),e.pos(Ne,ne),e.anchor("center"),e.color(m>0?255:80,m>0?255:80,m>0?255:80),e.fixed(),e.z(w.UI_TEXT+10)]);m>0&&(Te.onClick(()=>{_||(_=!0,e.wait(0,()=>{_=!1}),ke(),m--,B())}),Te.cursor="pointer"),P.push(Te,Mt);const fe=e.add([e.rect(30,30),e.pos(et,ne),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+10)]),Ce=e.add([e.text(">",{size:24}),e.pos(et,ne),e.anchor("center"),e.color(m<U-1?255:80,m<U-1?255:80,m<U-1?255:80),e.fixed(),e.z(w.UI_TEXT+10)]);m<U-1&&(fe.onClick(()=>{_||(_=!0,e.wait(0,()=>{_=!1}),ke(),m++,B())}),fe.cursor="pointer"),P.push(fe,Ce);for(let le=0;le<U;le++){const Re=le===m,Xe=ve+le*ge,Se=e.add([e.rect(16,16),e.pos(Xe,ne),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),it=e.add([e.text(Re?"":"",{size:14}),e.pos(Xe,ne),e.anchor("center"),e.color(Re?255:120,Re?255:120,Re?255:120),e.fixed(),e.z(w.UI_TEXT)]),We=le;Se.onClick(()=>{_||(_=!0,e.wait(0,()=>{_=!1}),We!==m&&(ke(),m=We,B()))}),Se.cursor="pointer",P.push(Se,it)}}}let b=null,S=null;function E(){const A=oh();s==="permanentUpgrades"&&A>0?b?(S.text=`REFUND: $${A}`,b.hidden=!1,S.hidden=!1):(b=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),S=e.add([e.text(`REFUND: $${A}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(w.UI_TEXT)]),b.onClick(()=>{zg().success?(vi(),B()):Pa()})):b&&(b.hidden=!0,S&&(S.hidden=!0))}B();const C=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text(ni("Back"),{size:Q.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),C.onClick(()=>{ke(),e.go("menu")}),e.onKeyPress("escape",()=>{Yh()||e.go("menu")})})}function Ol(e,t){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(w.OVERLAY)]),a=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(w.OVERLAY+1)]),r=[];function l(){r.forEach(T=>{T&&T.exists&&T.exists()&&e.destroy(T)})}const c=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),d=e.add([e.text("Cancel",{size:Q.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+3)]);c.onClick(()=>{l()}),r.push(o,a,c,d);const i=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),h=e.add([e.text("Reset",{size:Q.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(w.OVERLAY+3)]);i.onClick(()=>{l(),t()}),r.push(i,h);const u=e.add([e.text("Reset to Defaults?",{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]);r.push(u);const g=e.add([e.text("This will reset all settings to their default values.",{size:Q.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.OVERLAY+2)]);r.push(g);const p=e.onKeyPress("escape",()=>{l(),p.cancel()})}function V1(e){e.scene("settings",t=>{const o=t?.fromGame||!1;let n=hr(),s="audio";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),di(e,"OPTIONS",e.width()/2,35,8);const a=80,r=100,l=90,c=30,d=[{key:"audio",label:"Audio"},{key:"video",label:"Video"},{key:"gameplay",label:"Gameplay"},{key:"controls",label:"Controls"},{key:"access",label:"Access."},{key:"data",label:"Data"}],i=(d.length-1)*r,h=e.width()/2-i/2,u=[];d.forEach((E,C)=>{const A=h+C*r,z=s===E.key,R=e.add([e.rect(l,c),e.pos(A,a),e.anchor("center"),e.color(z?100:50,z?100:50,z?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),Y=e.add([e.text(E.label,{size:16}),e.pos(A,a),e.anchor("center"),e.color(z?255:150,z?255:150,z?255:150),e.fixed(),e.z(w.UI_TEXT)]);R.onClick(()=>{s=E.key,M()}),u.push({bg:R,label:Y,key:E.key})});const g=120,p=50,T=150;let m=[];function M(){u.forEach(A=>{const z=s===A.key;A.bg.color=e.rgb(z?100:50,z?100:50,z?150:80),A.label.color=e.rgb(z?255:150,z?255:150,z?255:150)}),m.forEach(A=>{A.exists()&&e.destroy(A)}),m=[],n=hr();const E=g+20;let C=E;if(s==="audio")C=P(e,"Master Volume",n.audio?.masterVolume??1,C,A=>{Gt("audio","masterVolume",A),vh(A)}),C=P(e,"Music Volume",n.audio?.musicVolume??.35,C,A=>{Gt("audio","musicVolume",A),Dh(A)}),C=P(e,"SFX Volume",n.audio?.sfxVolume??1,C,A=>{Gt("audio","sfxVolume",A),Eh(A),ke()}),C=f(e,"UI Sounds",n.audio?.uiSounds!==!1,C,A=>{Gt("audio","uiSounds",A),Ah(A)}),C=f(e,"Combat Sounds",n.audio?.combatSounds!==!1,C,A=>{Gt("audio","combatSounds",A),Sh(A)});else if(s==="video")C=f(e,"Show Particles",n.visual?.showParticles!==!1,C,A=>{Gt("visual","showParticles",A)}),C=f(e,"Screen Shake",n.visual?.showScreenShake!==!1,C,A=>{Gt("visual","showScreenShake",A)}),C=f(e,"Hit Freeze",n.visual?.showHitFreeze!==!1,C,A=>{Gt("visual","showHitFreeze",A)}),C=f(e,"Damage Numbers",n.visual?.showDamageNumbers!==!1,C,A=>{Gt("visual","showDamageNumbers",A)}),C=f(e,"Compact HUD",n.visual?.compactHUD||!1,C,A=>{Gt("visual","compactHUD",A)}),C=f(e,"FPS Counter",n.visual?.showFPS||!1,C,A=>{Gt("visual","showFPS",A)}),C=f(e,"Show Timer",n.visual?.showTimer!==!1,C,A=>{Gt("visual","showTimer",A)});else if(s==="controls"){const A=n.controls||{},z=[{label:"Move Up",key:"moveUp",value:A.moveUp||"w"},{label:"Move Down",key:"moveDown",value:A.moveDown||"s"},{label:"Move Left",key:"moveLeft",value:A.moveLeft||"a"},{label:"Move Right",key:"moveRight",value:A.moveRight||"d"},{label:"Pause",key:"pause",value:A.pause||"escape"},{label:"Interact",key:"interact",value:A.interact||"space"}];z.forEach((Y,U)=>{const N=E+U*p,H=e.add([e.text(Y.label+":",{size:16}),e.pos(150,N),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(w.UI_ELEMENTS)]),I=e.add([e.rect(100,30),e.pos(500,N),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(w.UI_ELEMENTS)]),F=e.add([e.text(Y.value.toUpperCase(),{size:16}),e.pos(500,N),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT)]);m.push(H,I,F)});const R=E+z.length*p;if(R<e.height()-T){const Y=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,R+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(w.UI_ELEMENTS)]);m.push(Y)}}else if(s==="gameplay")C=f(e,"Auto-pause on Level Up",n.gameplay?.autoPause||!1,C,A=>{Gt("gameplay","autoPause",A)}),C=f(e,"Auto-pickup Currency",n.gameplay?.autoPickupCurrency||!1,C,A=>{Gt("gameplay","autoPickupCurrency",A)}),C=f(e,"Auto-pickup XP",n.gameplay?.autoPickupXP||!1,C,A=>{Gt("gameplay","autoPickupXP",A)}),C=f(e,"Confirm Before Quit",n.gameplay?.confirmBeforeQuit!==!1,C,A=>{Gt("gameplay","confirmBeforeQuit",A)}),C=f(e,"Skip Intro Animation",n.gameplay?.skipIntroAnimation||!1,C,A=>{Gt("gameplay","skipIntroAnimation",A)});else if(s==="access")C=f(e,"Colorblind Mode",n.accessibility?.colorblindMode!=="off",C,A=>{Gt("accessibility","colorblindMode",A?"deuteranopia":"off")}),C=f(e,"Reduced Motion",n.accessibility?.reducedMotion||!1,C,A=>{Gt("accessibility","reducedMotion",A),A&&(Gt("visual","showParticles",!1),Gt("visual","showScreenShake",!1))}),C=f(e,"Large Text",n.accessibility?.largeText||!1,C,A=>{Gt("accessibility","largeText",A)}),C=f(e,"High Contrast",n.accessibility?.highContrast||!1,C,A=>{Gt("accessibility","highContrast",A)});else if(s==="data"){const A=e.add([e.rect(200,35),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),z=e.add([e.text("Export Save Data",{size:Q.SMALL}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);let R=null;A.onClick(()=>{try{const F=localStorage.getItem("superSmashTexty_save")||"{}";navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(F).then(()=>{R&&R.exists()&&(R.text="Copied to clipboard!",R.color=e.rgb(...y.SUCCESS))}).catch(()=>{R&&R.exists()&&(R.text="Failed to copy",R.color=e.rgb(...y.DANGER))}):(console.log("Save data:",F),R&&R.exists()&&(R.text="Check browser console (F12)",R.color=e.rgb(...y.TEXT_SECONDARY)))}catch(F){console.error("Export failed:",F)}}),m.push(A,z),C+=50,R=e.add([e.text("",{size:Q.SMALL-2}),e.pos(e.width()/2,C-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),m.push(R),C+=30;const Y=e.add([e.rect(200,35),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),U=e.add([e.text("Import Save Data",{size:Q.SMALL}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);Y.onClick(()=>{if(!navigator.clipboard||!navigator.clipboard.readText){R&&R.exists()&&(R.text="Clipboard not available",R.color=e.rgb(...y.DANGER));return}navigator.clipboard.readText().then(F=>{try{const V=JSON.parse(F);V&&typeof V=="object"&&(localStorage.setItem("superSmashTexty_save",F),R&&R.exists()&&(R.text="Import successful! Refresh to apply.",R.color=e.rgb(...y.SUCCESS)))}catch{R&&R.exists()&&(R.text="Invalid save data",R.color=e.rgb(...y.DANGER))}}).catch(()=>{R&&R.exists()&&(R.text="Failed to read clipboard",R.color=e.rgb(...y.DANGER))})}),m.push(Y,U),C+=60;const N=e.add([e.rect(200,35),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),H=e.add([e.text("Reset All Progress",{size:Q.SMALL}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);N.onClick(()=>{Ol(e,()=>{localStorage.removeItem("superSmashTexty_save"),R&&R.exists()&&(R.text="Progress reset! Refresh to apply.",R.color=e.rgb(...y.SUCCESS))})}),m.push(N,H),C+=50;const I=e.add([e.text("Warning: Reset cannot be undone!",{size:10}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.UI_ELEMENTS)]);m.push(I)}}function P(E,C,A,z,R){const Y=E.add([E.text(C+":",{size:16}),E.pos(150,z),E.anchor("left"),E.color(200,200,200),E.fixed(),E.z(w.UI_ELEMENTS)]),U=300,N=20,H=E.add([E.rect(U,N),E.pos(500,z),E.anchor("center"),E.color(50,50,70),E.outline(2,E.rgb(100,100,120)),E.area(),E.fixed(),E.z(w.UI_ELEMENTS)]);function I(ve){if(ve<.5){const Oe=ve*2;return{r:255,g:Math.round(255*Oe),b:0}}else{const Oe=(ve-.5)*2;return{r:Math.round(255*(1-Oe)),g:255,b:0}}}const F=U*A,V=I(A),j=E.add([E.rect(F,N-4),E.pos(500-(U-F)/2,z),E.anchor("center"),E.color(V.r,V.g,V.b),E.fixed(),E.z(w.UI_TEXT)]),ce=500-U/2+F,ie=E.add([E.rect(20,N+4),E.pos(ce,z),E.anchor("center"),E.color(200,200,255),E.outline(2,E.rgb(150,150,200)),E.area(),E.fixed(),E.z(1002)]),ne=E.add([E.text(Math.round(A*100)+"%",{size:14}),E.pos(680,z),E.anchor("left"),E.color(255,255,255),E.fixed(),E.z(w.UI_ELEMENTS)]);let se=!1;H.onClick(()=>{const ve=E.mousePos().x,Oe=500-U/2,Ee=ve-Oe,Ne=Math.max(0,Math.min(1,Ee/U));ge(Ne)}),ie.onClick(()=>{se=!0}),E.onMouseMove(()=>{if(se&&E.isMouseDown()){const ve=E.mousePos().x,Oe=500-U/2,Ee=ve-Oe,Ne=Math.max(0,Math.min(1,Ee/U));ge(Ne)}else se=!1}),E.onMouseRelease(()=>{se=!1});function ge(ve){const Oe=U*ve;j.width=Oe,j.pos.x=500-(U-Oe)/2,ie.pos.x=500-U/2+Oe,ne.text=Math.round(ve*100)+"%";const Ee=I(ve);j.color=E.rgb(Ee.r,Ee.g,Ee.b),R(ve)}return m.push(Y,H,j,ie,ne),z+p}function f(E,C,A,z,R){const Y=E.add([E.text(C+":",{size:16,width:280}),E.pos(150,z),E.anchor("left"),E.color(200,200,200),E.fixed(),E.z(w.UI_ELEMENTS)]),U=80,N=30,H=550,I=E.add([E.rect(U,N),E.pos(H,z),E.anchor("center"),E.color(A?50:70,A?150:50,A?50:70),E.outline(2,E.rgb(100,100,120)),E.area(),E.fixed(),E.z(w.UI_ELEMENTS)]),F=24,V=A?H+U/2-F/2-4:H-U/2+F/2+4,j=E.add([E.rect(F,F),E.pos(V,z),E.anchor("center"),E.color(255,255,255),E.outline(1,E.rgb(200,200,200)),E.fixed(),E.z(w.UI_TEXT)]),ce=A?H-12:H+8,ie=E.add([E.text(A?"ON":"OFF",{size:12}),E.pos(ce,z),E.anchor("center"),E.color(A?100:150,A?255:150,A?100:150),E.fixed(),E.z(1002)]);return I.onClick(()=>{const ne=!A;A=ne,I.color=E.rgb(ne?50:70,ne?150:50,ne?50:70),j.pos.x=ne?H+U/2-F/2-4:H-U/2+F/2+4,ie.text=ne?"ON":"OFF",ie.pos.x=ne?H-12:H+8,ie.color=E.rgb(ne?100:150,ne?255:150,ne?100:150),R(ne)}),m.push(Y,I,j,ie),z+p}const{MD:_,SM:B}=zn.BUTTON,b=e.add([e.rect(_.width,_.height),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("RESET",{size:Q.SMALL}),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),b.onClick(()=>{Ol(e,()=>{wx(),M()})}),M();const S=e.add([e.rect(B.width,B.height),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),S.onClick(()=>{o?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{o?e.go("game"):e.go("menu")})})}function W1(e,t,o){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),o=Math.max(0,Math.min(1,o));let n,s,a;if(t===0)n=s=a=o;else{const r=(d,i,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?d+(i-d)*6*h:h<.5?i:h<.6666666666666666?d+(i-d)*(.6666666666666666-h)*6:d),l=o<.5?o*(1+t):o+t-o*t,c=2*o-l;n=r(c,l,e+1/3),s=r(c,l,e),a=r(c,l,e-1/3)}return[Math.max(0,Math.min(255,Math.round(n*255))),Math.max(0,Math.min(255,Math.round(s*255))),Math.max(0,Math.min(255,Math.round(a*255)))]}function $1(e){e.scene("statistics",()=>{const t=vs(),o=nh(),n=la();let s="achievements",a="all",r=0;const l=15,c=8;let d=!1,i=null;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),di(e,"RATINGS AND RECORDS",e.width()/2,35,8);const h=80,u=160,g=150,p=30,T=[{key:"achievements",label:"Achievements"},{key:"history",label:"History"}],m=(T.length-1)*u,M=e.width()/2-m/2,P=[];T.forEach((R,Y)=>{const U=M+Y*u,N=s===R.key,H=e.add([e.rect(g,p),e.pos(U,h),e.anchor("center"),e.color(...N?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),I=e.add([e.text(R.label,{size:Q.BODY}),e.pos(U,h),e.anchor("center"),e.color(...N?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(w.UI_TEXT)]);H.onClick(()=>{d||(d=!0,ke(),s=R.key,r=0,a="all",e.wait(0,()=>{C(),e.wait(.1,()=>{d=!1})}))}),P.push({bg:H,label:I,key:R.key})});const f=140,B=e.height()-80;let b=[],S=[];const E=["all",...Eg()];function C(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(P.forEach(R=>{const Y=s===R.key;R.bg.color=e.rgb(Y?100:50,Y?100:50,Y?150:80),R.label.color=e.rgb(Y?255:150,Y?255:150,Y?255:150)}),b.forEach(R=>{if(R&&typeof R.exists=="function"&&R.exists())try{e.destroy(R)}catch(Y){console.warn("Error destroying content item:",Y)}}),b=[],S.forEach(R=>{if(R&&typeof R.exists=="function"&&R.exists())try{e.destroy(R)}catch(Y){console.warn("Error destroying category tab item:",Y)}}),S=[],s==="achievements")try{const H=(e.width()-640)/2,I=f+5,F=B-I-80,V=I,j=70,ce=22,ie=75,ne=E.slice(0,7),se=(ne.length-1)*ie,ge=e.width()/2-se/2;ne.forEach((xe,at)=>{const ae=ge+at*ie,Be=a===xe,tt=xe==="all"?"All":xe.charAt(0).toUpperCase()+xe.slice(1),ot=e.add([e.rect(j,ce),e.pos(ae,V),e.anchor("center"),e.color(Be?80:40,Be?80:40,Be?120:60),e.outline(1,e.rgb(100,100,150)),e.area(),e.fixed(),e.z(1e3)]),L=e.add([e.text(tt,{size:11}),e.pos(ae,V),e.anchor("center"),e.color(Be?255:150,Be?255:150,Be?255:150),e.fixed(),e.z(1001)]);ot.onClick(()=>{d||(d=!0,ke(),a=xe,r=0,i=null,e.wait(0,()=>{C(),e.wait(.1,()=>{d=!1})}))}),S.push(ot,L)});let ve;a==="all"?ve=Object.values(an):ve=vg(a);const Oe=Math.ceil(ve.length/l);r>=Oe&&(r=Math.max(0,Oe-1));const Ee=r*l,Ne=ve.slice(Ee,Ee+l),et=I+35,Te=50,Mt=8,fe=5,Ce=Te+22,le=H,Re=e.add([e.rect(320,F-35),e.pos(H,et),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(999)]);b.push(Re);const Xe=15;Ne.forEach((xe,at)=>{const ae=o.includes(xe.id),Be=i&&i.id===xe.id,tt=Math.floor(at/fe),ot=at%fe,L=le+Xe+ot*(Te+Mt),K=et+Xe+tt*Ce,ee=Oo[xe.difficulty]||Oo.normal,ue=Be?[100,100,180]:ae?[50,50,65]:[30,30,40],nt=Be?[150,150,255]:ae?ee:[50,50,60],st=e.add([e.rect(Te,Te),e.pos(L,K),e.anchor("topleft"),e.color(...ue),e.outline(Be?3:2,e.rgb(...nt)),e.area({width:Te,height:Te}),e.fixed(),e.z(1e3)]),Lt=e.add([e.text(xe.icon,{size:24}),e.pos(L+Te/2,K+Te/2),e.anchor("center"),e.color(ae?255:80,ae?255:80,ae?255:80),e.fixed(),e.z(1001)]);if(!ae){const ct=Gi(xe.id,t);if(ct&&ct.percentage>0){const bt=Te-4,ye=bt*ct.progress,we=e.add([e.rect(bt,4),e.pos(L+2,K+Te-6),e.anchor("topleft"),e.color(20,20,30),e.fixed(),e.z(1001)]);if(b.push(we),ye>0){const re=e.add([e.rect(ye,4),e.pos(L+2,K+Te-6),e.anchor("topleft"),e.color(...ee),e.opacity(.8),e.fixed(),e.z(1002)]);b.push(re)}}}st.onClick(()=>{d||(ke(),i=xe,d=!0,e.wait(0,()=>{C(),e.wait(.1,()=>{d=!1})}))}),b.push(st,Lt)});const Se=H+320+20,it=e.add([e.rect(300,F-35),e.pos(Se,et),e.anchor("topleft"),e.color(30,28,40),e.outline(2,e.rgb(70,70,100)),e.fixed(),e.z(999)]);b.push(it);const We=Se+300/2,Et=et+20;if(i){const xe=i,at=o.includes(xe.id),ae=Gi(xe.id,t),Be=Oo[xe.difficulty]||Oo.normal,tt=e.add([e.rect(70,70),e.pos(We,Et+35),e.anchor("center"),e.color(at?45:25,at?45:25,at?55:30),e.outline(3,e.rgb(...at?Be:[60,60,70])),e.fixed(),e.z(1e3)]);b.push(tt);const ot=e.add([e.text(xe.icon,{size:40}),e.pos(We,Et+35),e.anchor("center"),e.color(at?255:100,at?255:100,at?255:100),e.fixed(),e.z(1001)]);b.push(ot);const L=e.add([e.text(xe.name,{size:16}),e.pos(We,Et+85),e.anchor("center"),e.color(...at?[255,255,255]:[180,180,180]),e.fixed(),e.z(1e3)]);b.push(L);const K=xe.difficulty.charAt(0).toUpperCase()+xe.difficulty.slice(1),ee=e.add([e.text(K,{size:11}),e.pos(We,Et+105),e.anchor("center"),e.color(...Be),e.fixed(),e.z(1e3)]);b.push(ee);const ue=e.add([e.text(xe.description,{size:12}),e.pos(We,Et+130),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1e3)]);b.push(ue);let nt=Et+160;if(at){const st=e.add([e.text("UNLOCKED",{size:14}),e.pos(We,nt),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(1e3)]);b.push(st)}else if(ae){const ct=e.add([e.rect(200,16),e.pos(We,nt),e.anchor("center"),e.color(30,30,45),e.outline(1,e.rgb(70,70,90)),e.fixed(),e.z(1e3)]);b.push(ct);const bt=Math.max(2,200*ae.progress),ye=e.add([e.rect(bt,12),e.pos(We-200/2+bt/2,nt),e.anchor("center"),e.color(...Be),e.opacity(.9),e.fixed(),e.z(1001)]);b.push(ye);const we=e.add([e.text(`${ae.current} / ${ae.target}`,{size:11}),e.pos(We,nt+20),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);b.push(we),nt+=35}if(!at&&xe.hint){const st=nt+15,Lt=e.add([e.text("Hint:",{size:10}),e.pos(We,st),e.anchor("center"),e.color(120,120,140),e.fixed(),e.z(1e3)]);b.push(Lt);const ct=e.add([e.text(xe.hint,{size:11}),e.pos(We,st+18),e.anchor("center"),e.color(160,160,180),e.fixed(),e.z(1e3)]);b.push(ct)}}else{const xe=e.add([e.text("",{size:32}),e.pos(We,Et+60),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);b.push(xe);const at=e.add([e.text("Select an achievement",{size:14}),e.pos(We,Et+100),e.anchor("center"),e.color(120,120,150),e.fixed(),e.z(1e3)]);b.push(at);const ae=e.add([e.text("to view details",{size:12}),e.pos(We,Et+120),e.anchor("center"),e.color(100,100,130),e.fixed(),e.z(1e3)]);b.push(ae)}if(Oe>1){const xe=B-55,at=e.width()/2,ae=20,Be=at-(Oe-1)*ae/2,tt=at+(Oe-1)*ae/2,ot=25,L=Be-ot,K=tt+ot,ee=ct=>{d||ct===r||ct<0||ct>=Oe||(d=!0,ke(),r=ct,e.wait(0,()=>{C(),e.wait(.15,()=>{d=!1})}))};for(let ct=0;ct<Oe;ct++){const bt=ct===r,ye=Be+ct*ae,we=e.add([e.rect(16,16),e.pos(ye,xe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),re=e.add([e.text(bt?"":"",{size:14}),e.pos(ye,xe),e.anchor("center"),e.color(bt?255:120,bt?255:120,bt?255:120),e.fixed(),e.z(w.UI_TEXT)]),he=ct;we.onClick(()=>ee(he)),we.cursor="pointer",b.push(we,re)}const ue=e.add([e.rect(30,30),e.pos(L,xe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),nt=e.add([e.text("<",{size:24}),e.pos(L,xe),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);if(r>0){const ct=r-1;ue.onClick(()=>ee(ct)),ue.cursor="pointer"}b.push(ue,nt);const st=e.add([e.rect(30,30),e.pos(K,xe),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Lt=e.add([e.text(">",{size:24}),e.pos(K,xe),e.anchor("center"),e.color(r<Oe-1?255:80,r<Oe-1?255:80,r<Oe-1?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);if(r<Oe-1){const ct=r+1;st.onClick(()=>ee(ct)),st.cursor="pointer"}b.push(st,Lt)}const Ct=Object.keys(an).length,Pe=o.length,Fe=Pe/Ct,Ae=Fe>=1,Ie=B-20,Ye=e.width()/2,je=e.add([e.text("",{size:24}),e.pos(Ye-220,Ie),e.anchor("center"),e.color(Ae?255:150,Ae?215:150,Ae?0:150),e.fixed(),e.scale(1),e.z(1002)]);if(b.push(je),Ae){let xe=0;je.onUpdate(()=>{xe+=e.dt();const at=1+Math.sin(xe*3)*.1;je.scale=e.vec2(at,at)})}const lt=20,dt=Math.floor(Fe*lt),rt=lt-dt;let gt="";for(let xe=0;xe<dt;xe++)gt+="";for(let xe=0;xe<rt;xe++)gt+="";const ht=e.add([e.text("|"+"".repeat(lt)+"|",{size:16}),e.pos(Ye,Ie),e.anchor("center"),e.color(60,60,80),e.fixed(),e.z(1e3)]);b.push(ht);let Bt;Ae?Bt=[255,215,0]:Fe>=.75?Bt=[100,255,100]:Fe>=.5?Bt=[255,255,100]:Fe>=.25?Bt=[255,180,100]:Bt=[200,200,200];const Tt=e.add([e.text("|"+gt+"|",{size:16}),e.pos(Ye,Ie),e.anchor("center"),e.color(...Bt),e.fixed(),e.z(1001)]);if(b.push(Tt),Ae){let xe=0;Tt.onUpdate(()=>{xe+=e.dt();const at=xe*60%360,ae=W1(at/360,1,.6);Tt.color=e.rgb(ae[0],ae[1],ae[2])})}const yt=Math.round(Fe*100),Rt=Ae?"COMPLETE!":`${yt}%`,Ge=e.add([e.text(`${Pe}/${Ct}`,{size:14}),e.pos(Ye+180,Ie-8),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1002)]);b.push(Ge);const Dt=e.add([e.text(Rt,{size:12}),e.pos(Ye+180,Ie+8),e.anchor("center"),e.color(...Ae?[255,215,0]:[150,150,180]),e.fixed(),e.opacity(1),e.z(1002)]);if(b.push(Dt),Ae){let xe=0;Dt.onUpdate(()=>{xe+=e.dt();const at=Math.sin(xe*4)*.3+.7;Dt.opacity=at})}}catch(R){console.error("Error rendering achievements:",R);const Y=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,f+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);b.push(Y)}else if(s==="history"){const R=Ng(),Y=f+10,U=35;if(R.length===0){const N=e.add([e.text("No run history yet. Complete a run to see it here!",{size:16}),e.pos(e.width()/2,Y+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);b.push(N)}else{const N=Math.ceil(R.length/c);r>=N&&(r=Math.max(0,N-1));const H=r*c,I=Math.min(H+c,R.length),F=R.slice(H,I),V=["#","Floor","Rooms","Kills","Level","Credits","Time"],j=[60,120,200,280,360,450,550];if(V.forEach((se,ge)=>{const ve=e.add([e.text(se,{size:14}),e.pos(j[ge],Y),e.anchor("left"),e.color(255,200,100),e.fixed(),e.z(1e3)]);b.push(ve)}),F.forEach((se,ge)=>{const ve=Y+(ge+1)*U,Oe=H+ge+1,Ee=Math.floor(se.duration/60),Ne=se.duration%60,et=`${Ee}:${Ne.toString().padStart(2,"0")}`;[`${Oe}`,`${se.floorsReached}`,`${se.roomsCleared}`,`${se.enemiesKilled}`,`${se.level}`,`${n}${se.currencyEarned}`,et].forEach((Mt,fe)=>{const Ce=e.add([e.text(Mt,{size:14}),e.pos(j[fe],ve),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]);b.push(Ce)})}),N>1){const se=B-55,ge=e.width()/2,ve=20,Oe=ge-(N-1)*ve/2;for(let fe=0;fe<N;fe++){const Ce=fe===r,le=Oe+fe*ve,Re=e.add([e.rect(16,16),e.pos(le,se),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(1e3)]),Xe=e.add([e.text(Ce?"":"",{size:14}),e.pos(le,se),e.anchor("center"),e.color(Ce?255:120,Ce?255:120,Ce?255:120),e.fixed(),e.z(1001)]),Se=fe;Re.onClick(()=>{d||Se===r||(d=!0,ke(),r=Se,C(),e.wait(.1,()=>{d=!1}))}),Re.cursor="pointer",b.push(Re,Xe)}const Ee=Math.max(30,N*ve/2+25),Ne=e.add([e.rect(30,30),e.pos(ge-Ee,se),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),et=e.add([e.text("<",{size:24}),e.pos(ge-Ee,se),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(1003)]);r>0&&(Ne.onClick(()=>{d||(d=!0,ke(),r--,C(),e.wait(.1,()=>{d=!1}))}),Ne.cursor="pointer"),b.push(Ne,et);const Te=e.add([e.rect(30,30),e.pos(ge+Ee,se),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),Mt=e.add([e.text(">",{size:24}),e.pos(ge+Ee,se),e.anchor("center"),e.color(r<N-1?255:80,r<N-1?255:80,r<N-1?255:80),e.fixed(),e.z(1003)]);r<N-1&&(Te.onClick(()=>{d||(d=!0,ke(),r++,C(),e.wait(.1,()=>{d=!1}))}),Te.cursor="pointer"),b.push(Te,Mt)}const ce=H+1,ie=I,ne=e.add([e.text(`Showing ${ce}-${ie} of ${R.length} runs`,{size:12}),e.pos(e.width()/2,B-20),e.anchor("center"),e.color(100,100,150),e.fixed(),e.z(1e3)]);b.push(ne)}}}C();const{SM:A}=zn.BUTTON,z=e.add([e.rect(A.width,A.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),z.onClick(()=>{ke(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const ln={BREATHE_SPEED:1.5,BREATHE_AMOUNT:.04,BOB_SPEED:2,BOB_AMOUNT:3,GLOW_PULSE_SPEED:2,GLOW_MIN:.3,GLOW_MAX:.7};function J1(e){if(!e.unlockRequirement)return null;if(e.unlockRequirement.type==="floor")return`Unlock: Complete ${Li.FLOOR} ${e.unlockRequirement.value}`;if(e.unlockRequirement.type==="achievement"){const t=an[e.unlockRequirement.value];return t?`Unlock: ${t.name}`:"Unlock: Achievement required"}return null}function j1(e){e.scene("characterSelect",()=>{const t=$n(),o=mn();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),li(e,{patternCount:10,particleCount:15}),Gr(e,t),di(e,"CONTESTANTS",e.width()/2,60,8);const n=Object.keys($t),s=360,a=s+20,r=e.width()-a-20,l=110,c=165,d=70,i=8,h=2,u=5,g=h*u,p=H=>H.replace(/^The\s+/i,""),T=(H,I,F,V)=>{const j=[],ce=/([+-]?\d+%?\s*(?:XP|health|HP|speed|damage|crit|dodge|reduction|lifesteal|blast radius|drones?|orbital))/gi,ie=H.split(ce),ne=H.match(ce)||[];ie.forEach((ge,ve)=>{});const se=e.add([e.text(H,{size:Q.SMALL,width:V}),e.pos(I,F),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);if(j.push(se),ne.length>0){const ge=ne.join(" | "),ve=e.add([e.text(ge,{size:Q.TINY}),e.pos(I,F+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT+1)]);j.push(ve)}return j},m=Math.ceil(n.length/g);let M=0;const P=n.indexOf(o);P>=0&&(M=Math.floor(P/g));const f=[],_=o;let B=_,b=[],S=[],E=!1;function C(){if(E)return;E=!0,f.forEach(le=>{le&&le.exists&&le.exists()&&e.destroy(le)}),f.length=0,b.forEach(le=>{le&&le.exists&&le.exists()&&e.destroy(le)}),b=[],S.forEach(le=>{le&&le.exists&&le.exists()&&e.destroy(le)}),S=[];const H=M*g,I=Math.min(H+g,n.length);if(n.slice(H,I).forEach((le,Re)=>{const Xe=$t[le],Se=Yo("characters",le)||Xe.unlockedByDefault,it=B===le,We=_===le,Et=Math.floor(Re/h),Pe=20+Re%h*(c+i),Fe=l+Et*(d+i),Ae=e.add([e.rect(c,d),e.pos(Pe,Fe),e.anchor("topleft"),e.color(...it?y.BG_MEDIUM:y.BG_DARK),e.outline(2,it?e.rgb(...y.BORDER_ACTIVE):Se?e.rgb(...y.TEXT_DISABLED):e.rgb(...y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS),{baseX:Pe,baseY:Fe,isHovered:!1}]),Ie=e.add([e.text(Xe.char,{size:Q.HEADER}),e.pos(Pe+28,Fe+d/2),e.anchor("center"),e.color(...Se?Xe.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(w.UI_TEXT),{baseX:Pe+28,baseY:Fe+d/2}]),Ye=e.add([e.text(p(Xe.name),{size:Q.SMALL}),e.pos(Pe+60,Fe+d/2),e.anchor("left"),e.color(...Se?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(w.UI_TEXT),{baseX:Pe+60,baseY:Fe+d/2}]);if(Ae.onHoverUpdate(()=>{if(!Ae.isHovered&&!it&&(Ae.isHovered=!0,ke()),!it){Ae.scale=e.vec2(1.05,1.05),Ie.scale=e.vec2(1.15,1.15),Ye.scale=e.vec2(1.05,1.05),Ae.color=e.rgb(50,50,65);const je=Math.sin(e.time()*8)*2;Ie.pos.y=Ie.baseY+je}}),Ae.onHoverEnd(()=>{Ae.isHovered=!1,Ae.scale=e.vec2(1,1),Ie.scale=e.vec2(1,1),Ye.scale=e.vec2(1,1),Ae.color=e.rgb(...it?y.BG_MEDIUM:y.BG_DARK),Ie.pos.y=Ie.baseY}),!Se){const je=e.add([e.text("",{size:Q.SMALL}),e.pos(Pe+c-18,Fe+d/2),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.OVERLAY)]);f.push(je)}if(We){const je=e.add([e.circle(8),e.pos(Pe+c-10,Fe+12),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT+1)]),lt=e.add([e.text("",{size:10}),e.pos(Pe+c-10,Fe+12),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(w.UI_TEXT+2)]);f.push(je,lt)}Ae.onClick(()=>{B!==le&&(Ut(),B=le,C())}),Ae.cursor="pointer",f.push(Ae,Ie,Ye)}),m>1){const le=l+u*(d+i)+15,Re=s/2,Xe=20,Se=Re-(m-1)*Xe/2,it=Re+(m-1)*Xe/2,We=25,Et=Se-We,Ct=it+We;for(let Ye=0;Ye<m;Ye++){const je=Ye===M,lt=Se+Ye*Xe,dt=e.add([e.rect(16,16),e.pos(lt,le),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),rt=e.add([e.text(je?"":"",{size:14}),e.pos(lt,le),e.anchor("center"),e.color(je?255:120,je?255:120,je?255:120),e.fixed(),e.z(w.UI_TEXT)]),gt=Ye;dt.onClick(()=>{gt!==M&&(ke(),M=gt,C())}),dt.cursor="pointer",S.push(dt,rt)}const Pe=e.add([e.rect(30,30),e.pos(Et,le),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Fe=e.add([e.text("<",{size:24}),e.pos(Et,le),e.anchor("center"),e.color(M>0?255:80,M>0?255:80,M>0?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);M>0&&(Pe.onClick(()=>{ke(),M--,C()}),Pe.cursor="pointer"),S.push(Pe,Fe);const Ae=e.add([e.rect(30,30),e.pos(Ct,le),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),Ie=e.add([e.text(">",{size:24}),e.pos(Ct,le),e.anchor("center"),e.color(M<m-1?255:80,M<m-1?255:80,M<m-1?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);M<m-1&&(Ae.onClick(()=>{ke(),M++,C()}),Ae.cursor="pointer"),S.push(Ae,Ie)}const V=$t[B],j=Yo("characters",B)||V.unlockedByDefault;let ce=l;const ie=e.add([e.rect(r-10,380),e.pos(a+5,l-10),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(w.UI_ELEMENTS-1)]);b.push(ie);const ne=e.add([e.circle(50),e.pos(a+r/2,ce+45),e.anchor("center"),e.color(...j?V.color:[80,80,80]),e.opacity(ln.GLOW_MIN),e.scale(1),e.fixed(),e.z(w.UI_ELEMENTS)]);b.push(ne);const se=e.add([e.text(V.char,{size:72}),e.pos(a+r/2,ce+45),e.anchor("center"),e.color(...j?V.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(w.UI_ELEMENTS+1),{baseY:ce+45,baseScale:1,animTime:Math.random()*Math.PI*2}]);b.push(se);const ge=e.onUpdate(()=>{if(!se.exists())return;se.animTime+=e.dt();const le=1+Math.sin(se.animTime*ln.BREATHE_SPEED)*ln.BREATHE_AMOUNT;se.scale=e.vec2(le,le);const Re=Math.sin(se.animTime*ln.BOB_SPEED)*ln.BOB_AMOUNT;if(se.pos.y=se.baseY+Re,ne.exists()){const Xe=ln.GLOW_MIN+(Math.sin(se.animTime*ln.GLOW_PULSE_SPEED)*.5+.5)*(ln.GLOW_MAX-ln.GLOW_MIN);ne.opacity=Xe,ne.scale=e.vec2(1+Xe*.3,1+Xe*.3)}});b.push({exists:()=>!0,destroy:()=>ge.cancel()}),ce+=110;const ve=e.add([e.text(p(V.name),{size:Q.HEADER}),e.pos(a+r/2,ce),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);b.push(ve),ce+=35;const Oe=T(V.description,a+r/2,ce,r-40);b.push(...Oe),ce+=55;const Ee=e.add([e.text("Stats:",{size:Q.LABEL}),e.pos(a+20,ce),e.anchor("left"),e.color(...y.WARNING),e.fixed(),e.z(w.UI_TEXT)]);b.push(Ee),ce+=28;const Ne=100,et=a+40,Te=24,Mt=Ua(e,{label:Li.HEALTH,value:V.stats.health,maxValue:175,x:et,y:ce,width:Ne,usePercentageColor:!0});b.push(...Mt.elements),ce+=Te;const fe=Ua(e,{label:Li.SPEED,value:V.stats.speed,maxValue:225,x:et,y:ce,width:Ne,usePercentageColor:!0});b.push(...fe.elements),ce+=Te;const Ce=Ua(e,{label:Li.DAMAGE,value:V.stats.damage,maxValue:25,x:et,y:ce,width:Ne,usePercentageColor:!0});if(b.push(...Ce.elements),ce+=30,B===_){const le=e.add([e.text(" CURRENT SELECTION",{size:Q.LABEL}),e.pos(a+r/2,ce),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(w.UI_TEXT)]);b.push(le)}if(!j){const le=J1(V);if(le){const Re=e.add([e.text(le,{size:Q.SMALL,width:r-40}),e.pos(a+r/2,ce+30),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);b.push(Re)}}E=!1}C(),e.onKeyPress("arrowleft",()=>{M>0&&(ke(),M--,C())}),e.onKeyPress("arrowright",()=>{M<m-1&&(ke(),M++,C())});const A=e.add([e.rect(120,35),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text(ni("Cancel"),{size:Q.BODY}),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),A.onClick(()=>{ke(),e.go("menu")});let z=null,R=null,Y=[];function U(){Y.forEach(F=>{F&&F.exists&&F.exists()&&e.destroy(F)}),Y=[];const H=$t[B],I=Yo("characters",B)||H.unlockedByDefault;z=e.add([e.rect(120,35),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(...I?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(...I?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]),Y.push(z),R=e.add([e.text(ni("Confirm"),{size:Q.BODY}),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(...I?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]),Y.push(R),I&&(z.onClick(()=>{Ut(),Uc(B),Vc(B),e.go("menu")}),z.cursor="pointer")}U();const N=C;C=function(){N(),U()},e.onKeyPress("escape",()=>{ke(),e.go("menu")}),e.onKeyPress("enter",()=>{const H=$t[B];(Yo("characters",B)||H.unlockedByDefault)&&(Ut(),Uc(B),Vc(B),e.go("menu"))})})}function Z1(e){e.scene("joinParty",()=>{const t={name:Mo(),inviteCode:Jn(),character:mn()};let o=!1;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:Q.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:Q.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(10)]);let n="";const s=e.add([e.text("______",{size:Q.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(10)]),a=e.add([e.text("",{size:Q.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:Q.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(10)]);let r=!1;function l(){let h="";for(let u=0;u<6;u++)u<n.length?h+=n[u]:h+="_";s.text=h}e.onCharInput(h=>{r||/[a-zA-Z0-9]/.test(h)&&n.length<6&&(ke(),n+=h.toUpperCase(),l(),a.text="",n.length===6&&e.wait(.2,c))}),e.onKeyPress("backspace",()=>{r||n.length>0&&(ke(),n=n.slice(0,-1),l(),a.text="")}),e.onKeyPress("escape",()=>{ke(),o=!0,r=!1,Wi(t),e.go("menu")}),e.onKeyPress("enter",()=>{r||n.length===6&&c()});async function c(){if(r)return;const h=n.trim();if(!bg(h)){a.text="Invalid invite code format",a.color=e.rgb(255,100,100);return}r=!0,a.text="Joining party...",a.color=e.rgb(...y.GOLD);try{if(await am(h)){if(o)return;Ut(),a.text="Successfully joined party!",a.color=e.rgb(...y.SUCCESS),e.wait(1,()=>{o||e.go("menu")})}else r=!1,a.text="Failed to join party. Check the code and try again.",a.color=e.rgb(255,100,100),n="",l()}catch(u){r=!1,console.error("[JoinParty] Error joining party:",u),a.text="Connection error. Please try again.",a.color=e.rgb(255,100,100),n="",l()}}const{MD:d}=zn.BUTTON,i=e.add([e.rect(d.width,d.height),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("CANCEL",{size:Q.BODY}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(11)]),i.onClick(()=>{ke(),o=!0,r=!1,Wi(t),e.go("menu")}),i.onHoverUpdate(()=>{r||(i.color=e.rgb(...y.NEUTRAL_HOVER))}),i.onHoverEnd(()=>{i.color=e.rgb(...y.NEUTRAL)})})}const Zo={DAILY:"daily",ALL_TIME:"allTime",PERSONAL:"personal",GLOBAL:"global"};function Q1(e){e.scene("leaderboards",(t={})=>{let n=t.tab||Zo.DAILY;const s=10,a=5;let r=0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(w.BACKGROUND)]),e.add([e.text("LEADERBOARDS",{size:Q.TITLE}),e.pos(e.width()/2,50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);const l=100,c=115,d=8,i=c*4+d*3,h=(e.width()-i)/2,u=160;let g=[];function p(A,z,R){const Y=n===z,U=e.add([e.rect(c,40),e.pos(R,l),e.anchor("center"),e.color(...Y?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...Y?y.BORDER_HOVER:y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS),"tab"]),N=e.add([e.text(A,{size:Q.BODY}),e.pos(R,l),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT),"tab"]);return U.onClick(()=>{n!==z&&(ke(),n=z,r=0,T(),m())}),U.onHoverUpdate(()=>{n!==z&&(U.color=e.rgb(...y.BG_LIGHT))}),U.onHoverEnd(()=>{n!==z&&(U.color=e.rgb(...y.BG_MEDIUM))}),{bg:U,label:N,tabType:z}}function T(){e.get("tab").forEach(A=>e.destroy(A)),p("DAILY",Zo.DAILY,h+c/2),p("ALL-TIME",Zo.ALL_TIME,h+c+d+c/2),p("PERSONAL",Zo.PERSONAL,h+(c+d)*2+c/2),p("GLOBAL",Zo.GLOBAL,h+(c+d)*3+c/2)}function m(){switch(g.forEach(A=>{A.exists()&&e.destroy(A)}),g=[],n){case Zo.DAILY:M();break;case Zo.ALL_TIME:P();break;case Zo.PERSONAL:f();break;case Zo.GLOBAL:_();break}}function M(){const A=Ko(),z=sc(A),R=$t[z]||$t.survivor,Y=N1(A,100),U=Mo(),N=Math.ceil(Y.length/s);r>=N&&N>0&&(r=N-1);const H=r*s,I=Y.slice(H,H+s),F=e.add([e.text(`Date: ${A}`,{size:Q.BODY}),e.pos(e.width()/2-100,u),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(F);const V=e.add([e.text(`Character: ${R.char} ${R.name}`,{size:Q.BODY}),e.pos(e.width()/2+50,u),e.anchor("left"),e.color(...R.color),e.fixed(),e.z(w.UI_TEXT)]);g.push(V);const j=u+40;if(b(j),Y.length===0){const ce=e.add([e.text("No entries yet. Be the first!",{size:Q.BODY}),e.pos(e.width()/2,j+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);g.push(ce)}else I.forEach((ce,ie)=>{const ne=j+40+ie*35,se=ce.name.toLowerCase()===U.toLowerCase(),ge=H+ie+1;S(ge,ce,ne,se)}),N>1&&B(j+40+s*35+10,N)}function P(){const A=_1(100),z=Mo(),R=Math.ceil(A.length/s);r>=R&&R>0&&(r=R-1);const Y=r*s,U=A.slice(Y,Y+s),N=u+10;if(b(N),A.length===0){const H=e.add([e.text("No entries yet. Play a game!",{size:Q.BODY}),e.pos(e.width()/2,N+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);g.push(H)}else U.forEach((H,I)=>{const F=N+40+I*35,V=H.name.toLowerCase()===z.toLowerCase(),j=Y+I+1;S(j,H,F,V)}),R>1&&B(N+40+s*35+10,R)}function f(){const A=X1(),z=Object.keys($t),R=Math.ceil(z.length/a);r>=R&&(r=Math.max(0,R-1));const Y=r*a,U=z.slice(Y,Y+a),N=u+10,H=["Character","Best Score","Best Floor","Best Time"],I=[120,280,420,540];H.forEach((V,j)=>{const ce=e.add([e.text(V,{size:Q.SMALL}),e.pos(I[j],N),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(ce)});const F=e.add([e.rect(500,2),e.pos(e.width()/2,N+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(w.UI_ELEMENTS)]);if(g.push(F),U.forEach((V,j)=>{const ce=$t[V],ie=A[V],ne=N+45+j*40,se=e.add([e.text(`${ce.char} ${ce.name}`,{size:Q.BODY}),e.pos(I[0],ne),e.anchor("left"),e.color(...ce.color),e.fixed(),e.z(w.UI_TEXT)]);if(g.push(se),ie){const ge=e.add([e.text(wr(ie.bestScore),{size:Q.BODY}),e.pos(I[1],ne),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(ge);const ve=e.add([e.text(`Floor ${ie.bestFloor}`,{size:Q.BODY}),e.pos(I[2],ne),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(ve);const Oe=e.add([e.text(Pl(ie.bestTime),{size:Q.BODY}),e.pos(I[3],ne),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(Oe)}else{const ge=e.add([e.text("-- no data --",{size:Q.SMALL}),e.pos(I[1],ne),e.anchor("left"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);g.push(ge)}}),R>1){const V=N+45+a*40+20;B(V,R)}}function _(){const A=Mo(),z=u+10,R=e.add([e.text("Connecting to global leaderboard...",{size:Q.BODY}),e.pos(e.width()/2,z+100),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(R),Wh(10).then(Y=>{if(R.exists()){e.destroy(R);const N=g.indexOf(R);N>-1&&g.splice(N,1)}if(n!==Zo.GLOBAL)return;if(Y.error){const N=e.add([e.text(Y.error,{size:Q.BODY}),e.pos(e.width()/2,z+80),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(w.UI_TEXT)]);g.push(N);const H=e.add([e.rect(120,35),e.pos(e.width()/2,z+130),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);g.push(H);const I=e.add([e.text("Try Again",{size:Q.SMALL}),e.pos(e.width()/2,z+130),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(I),H.onClick(()=>{ke(),m()}),H.onHoverUpdate(()=>{H.color=e.rgb(...y.SECONDARY_HOVER)}),H.onHoverEnd(()=>{H.color=e.rgb(...y.SECONDARY)});return}const U=Y.entries;if(b(z),U.length===0){const N=e.add([e.text("No global entries yet. Be the first!",{size:Q.BODY}),e.pos(e.width()/2,z+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(w.UI_TEXT)]);g.push(N)}else U.forEach((N,H)=>{const I=z+40+H*35,F=N.name.toLowerCase()===A.toLowerCase();S(H+1,N,I,F)});if(Y.totalCount>0){const N=z+40+Math.min(U.length,10)*35+20,H=e.add([e.text(`${Y.totalCount} player${Y.totalCount!==1?"s":""} worldwide`,{size:Q.SMALL}),e.pos(e.width()/2,N),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(H)}})}function B(A,z){const R=e.width()/2,Y=20,U=R-(z-1)*Y/2,N=R+(z-1)*Y/2,H=25,I=U-H,F=N+H;for(let ne=0;ne<z;ne++){const se=ne===r,ge=U+ne*Y,ve=e.add([e.rect(16,16),e.pos(ge,A),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(w.UI_ELEMENTS)]),Oe=e.add([e.text(se?"":"",{size:14}),e.pos(ge,A),e.anchor("center"),e.color(se?255:120,se?255:120,se?255:120),e.fixed(),e.z(w.UI_TEXT)]),Ee=ne;ve.onClick(()=>{Ee!==r&&(ke(),r=Ee,m())}),ve.cursor="pointer",g.push(ve,Oe)}const V=e.add([e.rect(30,30),e.pos(I,A),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),j=e.add([e.text("<",{size:24}),e.pos(I,A),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);r>0&&(V.onClick(()=>{ke(),r--,m()}),V.cursor="pointer"),g.push(V,j);const ce=e.add([e.rect(30,30),e.pos(F,A),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(w.UI_ELEMENTS+1)]),ie=e.add([e.text(">",{size:24}),e.pos(F,A),e.anchor("center"),e.color(r<z-1?255:80,r<z-1?255:80,r<z-1?255:80),e.fixed(),e.z(w.UI_TEXT+1)]);r<z-1&&(ce.onClick(()=>{ke(),r++,m()}),ce.cursor="pointer"),g.push(ce,ie)}function b(A){const z=["#","Name","Score","Floor","Time"],R=[80,150,350,470,560];z.forEach((U,N)=>{const H=e.add([e.text(U,{size:Q.SMALL}),e.pos(R[N],A),e.anchor(N===0?"center":"left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);g.push(H)});const Y=e.add([e.rect(550,2),e.pos(e.width()/2,A+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(w.UI_ELEMENTS)]);g.push(Y)}function S(A,z,R,Y=!1){const U=[80,150,350,470,560],N=Y?y.GOLD:y.TEXT_PRIMARY,H=$t[z.character]||$t.survivor,I=e.add([e.text(A<=3?["","1st","2nd","3rd"][A]:`${A}`,{size:Q.BODY}),e.pos(U[0],R),e.anchor("center"),e.color(...A===1?[255,215,0]:A===2?[192,192,192]:A===3?[205,127,50]:N),e.fixed(),e.z(w.UI_TEXT)]);g.push(I);const F=e.add([e.text(`${H.char} ${z.name}`,{size:Q.BODY}),e.pos(U[1],R),e.anchor("left"),e.color(...N),e.fixed(),e.z(w.UI_TEXT)]);g.push(F);const V=e.add([e.text(wr(z.score),{size:Q.BODY}),e.pos(U[2],R),e.anchor("left"),e.color(...N),e.fixed(),e.z(w.UI_TEXT)]);g.push(V);const j=e.add([e.text(`${z.floor}`,{size:Q.BODY}),e.pos(U[3],R),e.anchor("left"),e.color(...N),e.fixed(),e.z(w.UI_TEXT)]);g.push(j);const ce=e.add([e.text(Pl(z.time),{size:Q.BODY}),e.pos(U[4],R),e.anchor("left"),e.color(...N),e.fixed(),e.z(w.UI_TEXT)]);if(g.push(ce),Y){const ie=e.add([e.rect(550,30),e.pos(e.width()/2,R),e.anchor("center"),e.color(...y.GOLD),e.opacity(.1),e.fixed(),e.z(w.UI_BACKGROUND+1)]);g.push(ie)}}const{SM:E}=zn.BUTTON,C=e.add([e.rect(E.width,E.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),C.onClick(()=>{Ut(),e.go("menu")}),C.onHoverUpdate(()=>{C.color=e.rgb(...y.SECONDARY_HOVER)}),C.onHoverEnd(()=>{C.color=e.rgb(...y.SECONDARY)}),e.onKeyPress("escape",()=>{Ut(),e.go("menu")}),T(),m()})}function k1(e,t,o){const n=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(w.OVERLAY)]),r=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(w.OVERLAY+1)]),l=e.add([e.text("Edit Player Name",{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+2)]),c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(w.OVERLAY+2)]);let d=t;const i=e.add([e.text(d,{size:Q.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.OVERLAY+3)]),h=e.add([e.text("(Max 20 characters)",{size:Q.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.OVERLAY+2)]),u=[n,r,l,c,i,h];function g(){u.forEach(b=>{b&&b.exists&&b.exists()&&e.destroy(b)})}const p=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),T=e.add([e.text("Cancel",{size:Q.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.OVERLAY+3)]);p.onClick(()=>{ke(),g()}),u.push(p,T);const m=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(w.OVERLAY+2)]),M=e.add([e.text("Save",{size:Q.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.OVERLAY+3)]);m.onClick(()=>{d.trim().length>0?(Ut(),o(d.trim()),g()):(h.text="Name cannot be empty!",h.color=e.rgb(255,100,100))}),u.push(m,M);const P=e.onCharInput(b=>{d.length<20&&/[a-zA-Z0-9 ]/.test(b)&&(d+=b,i.text=d,h.text="(Max 20 characters)",h.color=e.rgb(...y.TEXT_SECONDARY))}),f=e.onKeyPress("backspace",()=>{d.length>0&&(d=d.slice(0,-1),i.text=d||" ")}),_=e.onKeyPress("escape",()=>{g(),P.cancel(),f.cancel(),_.cancel(),B.cancel()}),B=e.onKeyPress("enter",()=>{d.trim().length>0&&(Ut(),o(d.trim()),g(),P.cancel(),f.cancel(),_.cancel(),B.cancel())})}function e2(e){e.scene("profile",(t={})=>{const o=t.externalProfile||null,n=o!==null,s=n?o:mt();let a=n?o.selectedPortrait:ci();const r=n?o.stats:vs(),l=n?o.playerLevel:ri(),c=n?o.totalXP:da(),d=n?o.playerName:Mo();n&&o.achievements;const i=n?o.unlockedPortraits:ih();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(w.BACKGROUND)]),li(e,{patternCount:8,particleCount:12}),n?e.add([e.text(`${d}'s Profile`,{size:Q.H1}),e.pos(e.width()/2,35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]):di(e,"PROFILE",e.width()/2,35,8);const h=80,u=140,g=720,p=e.width()/2;e.add([e.rect(g,u),e.pos(p,h+u/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const T=80,m=p-g/2+60,M=h+u/2,P=mr(a)||Zn.default;e.add([e.rect(T,T),e.pos(m,M),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(3,e.rgb(...P.color||[200,200,200])),e.fixed(),e.z(w.UI_BACKGROUND+1)]),e.add([e.text(P.icon,{size:40}),e.pos(m,M-5),e.anchor("center"),e.color(...P.color||[200,200,200]),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(`LV${l}`,{size:12}),e.pos(m,M+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);const f=m+80;let _=h+20,B=d;const b=e.add([e.text(B,{size:Q.H1}),e.pos(f,_),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]);if(!n){const Fe=p+g/2-20,Ae=Fe-24-8,Ie=e.add([e.rect(24,24),e.pos(Ae,_),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Ae-24/2,_),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),Ie.onClick(()=>{Ut(),k1(e,B,je=>{Nc(je),b.text=je,B=je})}),Ie.onHoverUpdate(()=>{Ie.color=e.rgb(...y.BG_LIGHT)}),Ie.onHoverEnd(()=>{Ie.color=e.rgb(...y.BG_MEDIUM)});const Ye=e.add([e.rect(24,24),e.pos(Fe,_),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Fe-24/2,_),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]),Ye.onClick(()=>{Ut();const je=nr();Nc(je),b.text=je,B=je}),Ye.onHoverUpdate(()=>{Ye.color=e.rgb(...y.BG_LIGHT)}),Ye.onHoverEnd(()=>{Ye.color=e.rgb(...y.BG_MEDIUM)})}_+=35;const S=Math.min(5,Math.floor(l/10)),E="".repeat(S)+"".repeat(5-S);e.add([e.text(`Level ${l}  ${E}`,{size:Q.LABEL}),e.pos(f,_),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),_+=30;const C=250,A=16,z=n?0:Nr(),R=c,Y=n?c:sh();e.add([e.rect(C,A),e.pos(f,_),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(w.UI_BACKGROUND+1)]);const U=Math.max(2,C*z);e.add([e.rect(U,A-4),e.pos(f+2,_),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(w.UI_ELEMENTS)]),e.add([e.text(`${Math.round(z*100)}%`,{size:10}),e.pos(f+C/2,_),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)]),_+=22,e.add([e.text(`${R.toLocaleString()} / ${Y.toLocaleString()} XP`,{size:Q.SMALL}),e.pos(f,_),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const N=h+u+10,H=165;e.add([e.rect(g,H),e.pos(p,N+H/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const I=f1(),F=p-g/2+30,V=N+20,j=40,ce=50,ie=13;let ne=null,se=null;function ge(Pe){ne&&ne.exists()&&(ne.text=`Selected: "${Pe.name}"`),se&&se.exists()&&(se.text=Pe.description)}I.forEach((Pe,Fe)=>{const Ae=Math.floor(Fe/ie),Ie=Fe%ie,Ye=F+Ie*ce,je=V+Ae*(ce+5),lt=n?i.includes(Pe.id):p1(Pe.id,s),dt=Pe.id===a,rt=lt?dt?[80,100,140]:y.BG_LIGHT:[40,40,50],gt=dt?y.GOLD:lt?Pe.color:[80,80,80],ht=e.add([e.rect(j,j),e.pos(Ye,je),e.anchor("center"),e.color(...rt),e.outline(dt?3:2,e.rgb(...gt)),n?null:e.area(),e.fixed(),e.z(w.UI_ELEMENTS)].filter(Boolean)),Bt=lt?Pe.icon:"",Tt=lt?Pe.color:[100,100,100];e.add([e.text(Bt,{size:lt?24:16}),e.pos(Ye,je-3),e.anchor("center"),e.color(...Tt),e.fixed(),e.z(w.UI_TEXT)]);const yt=lt?Pe.name.substring(0,8):"???";e.add([e.text(yt,{size:8}),e.pos(Ye,je+j/2+8),e.anchor("center"),e.color(...lt?y.TEXT_SECONDARY:[80,80,80]),e.fixed(),e.z(w.UI_TEXT)]),n||(ht.onClick(()=>{if(lt)Ut(),qg(Pe.id),a=Pe.id,ge(Pe),e.go("profile");else{ke();const Rt=g1(Pe.id);se&&se.exists()&&(se.text=`Locked: ${Rt}`,se.color=e.rgb(...y.DANGER))}}),ht.onHoverUpdate(()=>{dt||(ht.color=e.rgb(...lt?[100,120,160]:[50,50,60]))}),ht.onHoverEnd(()=>{dt||(ht.color=e.rgb(...rt))}))}),ne=e.add([e.text(`Selected: "${P.name}"`,{size:Q.SMALL}),e.pos(p,N+H-35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)]),se=e.add([e.text(P.description,{size:Q.SMALL-2}),e.pos(p,N+H-18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]);const ve=N+H+10,Oe=120;e.add([e.rect(g,Oe),e.pos(p,ve+Oe/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(w.UI_BACKGROUND)]);const Ee=r,Ne=Ee.totalRuns||0,et=Ne>0?Math.round((Ee.totalCurrencyEarned||0)/Ne):0,Te=Ne>0?((Ee.totalFloorsReached||0)/Ne).toFixed(1):"0",Mt=Ne>0?((Ee.totalRoomsCleared||0)/Ne).toFixed(1):"0",fe=Ee.fastestRunTime||0,Ce=Math.floor(fe/60),le=Math.floor(fe%60),Re=fe>0?`${Ce}:${le.toString().padStart(2,"0")}`:"--:--",Xe=[{label:"Total Runs",value:Ne},{label:"Best Floor",value:Ee.bestFloor||1},{label:"Best Level",value:Ee.bestLevel||1},{label:"Best Room",value:Ee.bestRoom||1},{label:"Fastest Run",value:Re}],Se=g/Xe.length;Xe.forEach((Pe,Fe)=>{const Ae=p-g/2+Se*Fe+Se/2,Ie=ve+15;e.add([e.text(Pe.label,{size:Q.SMALL-2}),e.pos(Ae,Ie),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(String(Pe.value),{size:Q.LABEL}),e.pos(Ae,Ie+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(w.UI_TEXT)])}),[{label:"Enemies",value:(Ee.totalEnemiesKilled||0).toLocaleString()},{label:"Bosses",value:Ee.totalBossesKilled||0},{label:"Rooms",value:(Ee.totalRoomsCleared||0).toLocaleString()},{label:"Avg Floor",value:Te},{label:"Avg Rooms",value:Mt}].forEach((Pe,Fe)=>{const Ae=p-g/2+Se*Fe+Se/2,Ie=ve+50;e.add([e.text(Pe.label,{size:Q.SMALL-2}),e.pos(Ae,Ie),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(String(Pe.value),{size:Q.SMALL}),e.pos(Ae,Ie+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)])}),[{label:"Total Money",value:(Ee.totalCurrencyEarned||0).toLocaleString()},{label:"Spent",value:(Ee.totalCurrencySpent||0).toLocaleString()},{label:"Avg Money",value:et.toLocaleString()},{label:"Floors",value:(Ee.totalFloorsReached||0).toLocaleString()},{label:"Play Time",value:(()=>{const Pe=Ee.totalPlayTime||0,Fe=Math.floor(Pe/3600),Ae=Math.floor(Pe%3600/60);return`${Fe}h ${Ae}m`})()}].forEach((Pe,Fe)=>{const Ae=p-g/2+Se*Fe+Se/2,Ie=ve+85;e.add([e.text(Pe.label,{size:Q.SMALL-2}),e.pos(Ae,Ie),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),e.add([e.text(String(Pe.value),{size:Q.SMALL}),e.pos(Ae,Ie+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(w.UI_TEXT)])});const{SM:Et}=zn.BUTTON,Ct=e.add([e.rect(Et.width,Et.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(w.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Q.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(w.UI_TEXT)]),Ct.onClick(()=>{ke(),e.go("menu")}),Ct.onHoverUpdate(()=>{Ct.color=e.rgb(...y.NEUTRAL_HOVER)}),Ct.onHoverEnd(()=>{Ct.color=e.rgb(...y.NEUTRAL)}),e.onKeyPress("escape",()=>{ke(),e.go("menu")})})}const Vo=wg({width:Rs.CANVAS_WIDTH,height:Rs.CANVAS_HEIGHT,background:Rs.BACKGROUND_COLOR,scale:Rs.CANVAS_SCALE,debug:Rs.DEBUG_MODE,root:document.querySelector("#game-container"),stretch:!0,letterbox:!0,crisp:!0});T1(Vo);u1(Vo);G1(Vo);K1(Vo);V1(Vo);$1(Vo);j1(Vo);Z1(Vo);Q1(Vo);e2(Vo);Vo.go("menu");
//# sourceMappingURL=main-Dkh8-ogj.js.map
