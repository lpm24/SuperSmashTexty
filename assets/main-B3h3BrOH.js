(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=o(s);fetch(s.href,a)}})();var gu=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return o=>{for(var n=o.length,s=new Uint8Array((n-(o[n-1]=="=")-(o[n-2]=="="))*3/4|0),a=0,r=0;a<n;){var l=e[o.charCodeAt(a++)],c=e[o.charCodeAt(a++)],d=e[o.charCodeAt(a++)],i=e[o.charCodeAt(a++)];s[r++]=l<<2|c>>4,s[r++]=c<<4|d>>2,s[r++]=d<<6|i}return s}})(),mu={version:"3001.0.19"};function sn(e,t,o){return t>o?sn(e,o,t):Math.min(Math.max(e,t),o)}var vt=class Qt{r=255;g=255;b=255;constructor(t,o,n){this.r=sn(t,0,255),this.g=sn(o,0,255),this.b=sn(n,0,255)}static fromArray(t){return new Qt(t[0],t[1],t[2])}static fromHex(t){if(typeof t=="number")return new Qt(t>>16&255,t>>8&255,t>>0&255);if(typeof t=="string"){let o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!o)throw new Error("Invalid hex color format");return new Qt(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16))}else throw new Error("Invalid hex color format")}static fromHSL(t,o,n){if(o==0)return new Qt(255*n,255*n,255*n);let s=(i,h,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<1/6?i+(h-i)*6*u:u<1/2?h:u<2/3?i+(h-i)*(2/3-u)*6:i),a=n<.5?n*(1+o):n+o-n*o,r=2*n-a,l=s(r,a,t+1/3),c=s(r,a,t),d=s(r,a,t-1/3);return new Qt(Math.round(l*255),Math.round(c*255),Math.round(d*255))}static RED=new Qt(255,0,0);static GREEN=new Qt(0,255,0);static BLUE=new Qt(0,0,255);static YELLOW=new Qt(255,255,0);static MAGENTA=new Qt(255,0,255);static CYAN=new Qt(0,255,255);static WHITE=new Qt(255,255,255);static BLACK=new Qt(0,0,0);clone(){return new Qt(this.r,this.g,this.b)}lighten(t){return new Qt(this.r+t,this.g+t,this.b+t)}darken(t){return this.lighten(-t)}invert(){return new Qt(255-this.r,255-this.g,255-this.b)}mult(t){return new Qt(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,o){return new Qt(Do(this.r,t.r,o),Do(this.g,t.g,o),Do(this.b,t.b,o))}toHSL(){let t=this.r/255,o=this.g/255,n=this.b/255,s=Math.max(t,o,n),a=Math.min(t,o,n),r=(s+a)/2,l=r,c=r;if(s==a)r=l=0;else{let d=s-a;switch(l=c>.5?d/(2-s-a):d/(s+a),s){case t:r=(o-n)/d+(o<n?6:0);break;case o:r=(n-t)/d+2;break;case n:r=(t-o)/d+4;break}r/=6}return[r,l,c]}eq(t){return this.r===t.r&&this.g===t.g&&this.b===t.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function Bt(...e){if(e.length===0)return new vt(255,255,255);if(e.length===1){if(e[0]instanceof vt)return e[0].clone();if(typeof e[0]=="string")return vt.fromHex(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return vt.fromArray(e[0])}else if(e.length===2){if(e[0]instanceof vt)return e[0].clone()}else if(e.length===3||e.length===4)return new vt(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var yu=(e,t,o)=>vt.fromHSL(e,t,o);function eo(e){return e*Math.PI/180}function Kn(e){return e*180/Math.PI}function Do(e,t,o){if(typeof e=="number"&&typeof t=="number")return e+(t-e)*o;if(e instanceof oe&&t instanceof oe||e instanceof vt&&t instanceof vt)return e.lerp(t,o);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function tn(e,t,o,n,s){return n+(e-t)/(o-t)*(s-n)}function xu(e,t,o,n,s){return sn(tn(e,t,o,n,s),n,s)}var oe=class io{x=0;y=0;constructor(t=0,o=t){this.x=t,this.y=o}static fromAngle(t){let o=eo(t);return new io(Math.cos(o),Math.sin(o))}static fromArray(t){return new io(t[0],t[1])}static ZERO=new io(0,0);static ONE=new io(1,1);static LEFT=new io(-1,0);static RIGHT=new io(1,0);static UP=new io(0,-1);static DOWN=new io(0,1);clone(){return new io(this.x,this.y)}add(...t){let o=J(...t);return new io(this.x+o.x,this.y+o.y)}sub(...t){let o=J(...t);return new io(this.x-o.x,this.y-o.y)}scale(...t){let o=J(...t);return new io(this.x*o.x,this.y*o.y)}dist(...t){let o=J(...t);return this.sub(o).len()}sdist(...t){let o=J(...t);return this.sub(o).slen()}static sdist(t,o){let n=t.x-o.x,s=t.y-o.y;return n*n+s*s}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return t===0?new io(0):this.scale(1/t)}normal(){return new io(this.y,-this.x)}reflect(t){return this.sub(t.scale(2*this.dot(t)))}project(t){return t.scale(t.dot(this)/t.len())}reject(t){return this.sub(this.project(t))}dot(t){return this.x*t.x+this.y*t.y}static dot(t,o){return t.x*o.x+t.y*o.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,o){return t.x*o.y-t.y*o.x}angle(...t){let o=J(...t);return Kn(Math.atan2(this.y-o.y,this.x-o.x))}angleBetween(...t){let o=J(...t);return Kn(Math.atan2(this.cross(o),this.dot(o)))}lerp(t,o){return new io(Do(this.x,t.x,o),Do(this.y,t.y,o))}slerp(t,o){let n=this.dot(t),s=this.cross(t),a=Math.atan2(s,n);return this.scale(Math.sin((1-o)*a)).add(t.scale(Math.sin(o*a))).scale(1/s)}isZero(){return this.x===0&&this.y===0}toFixed(t){return new io(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(t){return t.multVec2(this)}eq(t){return this.x===t.x&&this.y===t.y}bbox(){return new Ft(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function J(...e){if(e.length===1){if(e[0]instanceof oe)return new oe(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return new oe(...e[0])}return new oe(...e)}var $t=class Ka{x=0;y=0;w=1;h=1;constructor(t,o,n,s){this.x=t,this.y=o,this.w=n,this.h=s}scale(t){return new Ka(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new oe(this.x,this.y)}clone(){return new Ka(this.x,this.y,this.w,this.h)}eq(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function kt(e,t,o,n){return new $t(e,t,o,n)}var Fi=class ls{a;b;c;d;constructor(t,o,n,s){this.a=t,this.b=o,this.c=n,this.d=s}mul(t){return new ls(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(t){return J(this.a*t.x+this.b*t.y,this.c*t.x+this.d*t.y)}get inverse(){let t=this.det;return new ls(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new ls(this.a,this.c,this.b,this.d)}get eigenvalues(){let t=this.trace/2,o=this.det,n=t+Math.sqrt(t*t-o),s=t-Math.sqrt(t*t-o);return[n,s]}eigenvectors(t,o){return this.c!=0?[[t-this.d,this.c],[o-this.d,this.c]]:this.b!=0?[[this.b,t-this.a],[this.b,o-this.a]]:Math.abs(this.transform(J(1,0)).x-t)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let o=Math.cos(t),n=Math.sin(t);return new ls(o,n,-n,o)}static scale(t,o){return new ls(t,0,0,o)}},Ns=class _s{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(t,o,n,s,a,r,l,c,d){this.m11=t,this.m12=o,this.m13=n,this.m21=s,this.m22=a,this.m23=r,this.m31=l,this.m32=c,this.m33=d}static fromMat2(t){return new _s(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new Fi(this.m11,this.m12,this.m21,this.m22)}mul(t){return new _s(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(t){let o=Math.cos(t),n=Math.sin(t),s=this.m11,a=this.m12;return this.m11=o*this.m11+n*this.m21,this.m12=o*this.m12+n*this.m22,this.m21=o*this.m21-n*s,this.m22=o*this.m22-n*a,this}scale(t,o){return this.m11*=t,this.m12*=t,this.m21*=o,this.m22*=o,this}get inverse(){let t=this.det;return new _s((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new _s(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},an=class un{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(t){t&&(this.m=t)}static translate(t){return new un([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new un([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=eo(-t);let o=Math.cos(t),n=Math.sin(t);return new un([1,0,0,0,0,o,-n,0,0,n,o,0,0,0,0,1])}static rotateY(t){t=eo(-t);let o=Math.cos(t),n=Math.sin(t);return new un([o,0,n,0,0,1,0,0,-n,0,o,0,0,0,0,1])}static rotateZ(t){t=eo(-t);let o=Math.cos(t),n=Math.sin(t);return new un([o,-n,0,0,n,o,0,0,0,0,1,0,0,0,0,1])}translate(t){return this.m[12]+=this.m[0]*t.x+this.m[4]*t.y,this.m[13]+=this.m[1]*t.x+this.m[5]*t.y,this.m[14]+=this.m[2]*t.x+this.m[6]*t.y,this.m[15]+=this.m[3]*t.x+this.m[7]*t.y,this}scale(t){return this.m[0]*=t.x,this.m[4]*=t.y,this.m[1]*=t.x,this.m[5]*=t.y,this.m[2]*=t.x,this.m[6]*=t.y,this.m[3]*=t.x,this.m[7]*=t.y,this}rotate(t){t=eo(-t);let o=Math.cos(t),n=Math.sin(t),s=this.m[0],a=this.m[1],r=this.m[4],l=this.m[5];return this.m[0]=s*o+a*n,this.m[1]=-s*n+a*o,this.m[4]=r*o+l*n,this.m[5]=-r*n+l*o,this}mult(t){let o=[];for(let n=0;n<4;n++)for(let s=0;s<4;s++)o[n*4+s]=this.m[0+s]*t.m[n*4+0]+this.m[4+s]*t.m[n*4+1]+this.m[8+s]*t.m[n*4+2]+this.m[12+s]*t.m[n*4+3];return new un(o)}multVec2(t){return new oe(t.x*this.m[0]+t.y*this.m[4]+this.m[12],t.x*this.m[1]+t.y*this.m[5]+this.m[13])}getTranslation(){return new oe(this.m[12],this.m[13])}getScale(){if(this.m[0]!=0||this.m[1]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new oe(o,t/o)}else if(this.m[4]!=0||this.m[5]!=0){let t=this.m[0]*this.m[5]-this.m[1]*this.m[4],o=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new oe(t/o,o)}else return new oe(0,0)}getRotation(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return Kn(this.m[1]>0?Math.acos(this.m[0]/t):-Math.acos(this.m[0]/t))}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return Kn(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/t):-Math.acos(this.m[4]/t)))}else return 0}getSkew(){if(this.m[0]!=0||this.m[1]!=0){let t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new oe(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t),0)}else if(this.m[4]!=0||this.m[5]!=0){let t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new oe(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(t*t))}else return new oe(0,0)}invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],n=this.m[9]*this.m[15]-this.m[13]*this.m[11],s=this.m[9]*this.m[14]-this.m[13]*this.m[10],a=this.m[8]*this.m[15]-this.m[12]*this.m[11],r=this.m[8]*this.m[14]-this.m[12]*this.m[10],l=this.m[8]*this.m[13]-this.m[12]*this.m[9],c=this.m[6]*this.m[15]-this.m[14]*this.m[7],d=this.m[5]*this.m[15]-this.m[13]*this.m[7],i=this.m[5]*this.m[14]-this.m[13]*this.m[6],h=this.m[4]*this.m[15]-this.m[12]*this.m[7],u=this.m[4]*this.m[14]-this.m[12]*this.m[6],g=this.m[5]*this.m[15]-this.m[13]*this.m[7],p=this.m[4]*this.m[13]-this.m[12]*this.m[5],D=this.m[6]*this.m[11]-this.m[10]*this.m[7],m=this.m[5]*this.m[11]-this.m[9]*this.m[7],M=this.m[5]*this.m[10]-this.m[9]*this.m[6],B=this.m[4]*this.m[11]-this.m[8]*this.m[7],P=this.m[4]*this.m[10]-this.m[8]*this.m[6],f=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*n+this.m[7]*s,t[4]=-(this.m[4]*o-this.m[6]*a+this.m[7]*r),t[8]=this.m[4]*n-this.m[5]*a+this.m[7]*l,t[12]=-(this.m[4]*s-this.m[5]*r+this.m[6]*l),t[1]=-(this.m[1]*o-this.m[2]*n+this.m[3]*s),t[5]=this.m[0]*o-this.m[2]*a+this.m[3]*r,t[9]=-(this.m[0]*n-this.m[1]*a+this.m[3]*l),t[13]=this.m[0]*s-this.m[1]*r+this.m[2]*l,t[2]=this.m[1]*c-this.m[2]*d+this.m[3]*i,t[6]=-(this.m[0]*c-this.m[2]*h+this.m[3]*u),t[10]=this.m[0]*g-this.m[1]*h+this.m[3]*p,t[14]=-(this.m[0]*i-this.m[1]*u+this.m[2]*p),t[3]=-(this.m[1]*D-this.m[2]*m+this.m[3]*M),t[7]=this.m[0]*D-this.m[2]*B+this.m[3]*P,t[11]=-(this.m[0]*m-this.m[1]*B+this.m[3]*f),t[15]=this.m[0]*M-this.m[1]*P+this.m[2]*f;let O=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let v=0;v<4;v++)for(let T=0;T<4;T++)t[v*4+T]*=1/O;return new un(t)}clone(){return new un([...this.m])}toString(){return this.m.toString()}};function Kl(e,t,o,n=s=>-Math.cos(s)){return e+(n(o)+1)/2*(t-e)}var wu=1103515245,bu=12345,Mc=2147483648,Vl=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(wu*this.seed+bu)%Mc,this.seed/Mc}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new oe(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new vt(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(e.length===0)return this.gen();if(e.length===1){if(typeof e[0]=="number")return this.genNumber(0,e[0]);if(e[0]instanceof oe)return this.genVec2(J(0,0),e[0]);if(e[0]instanceof vt)return this.genColor(Bt(0,0,0),e[0])}else if(e.length===2){if(typeof e[0]=="number"&&typeof e[1]=="number")return this.genNumber(e[0],e[1]);if(e[0]instanceof oe&&e[1]instanceof oe)return this.genVec2(e[0],e[1]);if(e[0]instanceof vt&&e[1]instanceof vt)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},Va=new Vl(Date.now());function vu(e){return e!=null&&(Va.seed=e),Va.seed}function ao(...e){return Va.genAny(...e)}function Wl(...e){return Math.floor(ao(...e.length>0?e:[2]))}function Eu(e){return ao()<=e}function $l(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}function Au(e,t){return e.length<=t?e.slice():$l(e.slice()).slice(0,t)}function Su(e){return e[Wl(e.length)]}function Jl(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function Mu(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let o=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(o===0)return null;let n=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/o,s=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/o;return n<0||n>1||s<0||s>1?null:n}function Dr(e,t){let o=Mu(e,t);return o?J(e.p1.x+o*(e.p2.x-e.p1.x),e.p1.y+o*(e.p2.y-e.p1.y)):null}function Cr(e,t){let o=t.p2.sub(t.p1),n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;if(o.x!=0){let a=(e.pos.x-t.p1.x)/o.x,r=(e.pos.x+e.width-t.p1.x)/o.x;n=Math.max(n,Math.min(a,r)),s=Math.min(s,Math.max(a,r))}if(o.y!=0){let a=(e.pos.y-t.p1.y)/o.y,r=(e.pos.y+e.height-t.p1.y)/o.y;n=Math.max(n,Math.min(a,r)),s=Math.min(s,Math.max(a,r))}return s>=n&&s>=0&&n<=1}function ca(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function jl(e,t){let o=Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),n=Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height));return J(o,n).sdist(t.center)<=t.radius*t.radius}function Zl(e,t){return Ql(t,new Eo(e.points()))}function Rr(e,t){let o=t.sub(e.p1),n=e.p2.sub(e.p1);if(Math.abs(o.cross(n))>Number.EPSILON)return!1;let s=o.dot(n)/n.dot(n);return s>=0&&s<=1}function li(e,t){let o=e.p2.sub(e.p1),n=o.dot(o),s=e.p1.sub(t.center),a=2*o.dot(s),r=s.dot(s)-t.radius*t.radius,l=a*a-4*n*r;if(n<=Number.EPSILON||l<0)return!1;if(l==0){let c=-a/(2*n);if(c>=0&&c<=1)return!0}else{let c=(-a+Math.sqrt(l))/(2*n),d=(-a-Math.sqrt(l))/(2*n);if(c>=0&&c<=1||d>=0&&d<=1)return!0}return la(t,e.p1)}function Pr(e,t){if(Bn(t,e.p1)||Bn(t,e.p2))return!0;for(let o=0;o<t.pts.length;o++){let n=t.pts[o],s=t.pts[(o+1)%t.pts.length];if(Dr(e,new Io(n,s)))return!0}return!1}function la(e,t){return e.center.sdist(t)<e.radius*e.radius}function Tu(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}function da(e,t){let o=t.pts[t.pts.length-1];for(let n of t.pts){if(li(new Io(o,n),e))return!0;o=n}return la(e,t.pts[0])?!0:Bn(t,e.center)}function Ql(e,t){for(let o=0;o<e.pts.length;o++)if(Pr(new Io(e.pts[o],e.pts[(o+1)%e.pts.length]),t))return!0;return!!(e.pts.some(o=>Bn(t,o))||t.pts.some(o=>Bn(e,o)))}function Bn(e,t){let o=!1,n=e.pts;for(let s=0,a=n.length-1;s<n.length;a=s++)n[s].y>t.y!=n[a].y>t.y&&t.x<(n[a].x-n[s].x)*(t.y-n[s].y)/(n[a].y-n[s].y)+n[s].x&&(o=!o);return o}function Ir(e,t){t=t.sub(e.center);let o=eo(e.angle),n=Math.cos(o),s=Math.sin(o),a=t.x*n+t.y*s,r=-t.x*s+t.y*n;return a*a/(e.radiusX*e.radiusX)+r*r/(e.radiusY*e.radiusY)<1}function Yi(e,t){let o=t.center.sub(e.center),n=eo(e.angle),s=Math.cos(n),a=Math.sin(n),r=o.x*s+o.y*a,l=-o.x*a+o.y*s;return Ir(new yn(J(),e.radiusX+t.radius,e.radiusY+t.radius,0),J(r,l))}function kl(e,t){let o=e.toMat2().inverse;return t=new Io(o.transform(t.p1.sub(e.center)),o.transform(t.p2.sub(e.center))),li(t,new Po(J(),1))}function Du(e,t){if(e.radiusX===e.radiusY)return Yi(t,new Po(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Yi(e,new Po(t.center,t.radiusX));let o=new Ns(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),n=new Ns(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),s=e.center.x,a=e.center.y,r=t.center.x,l=t.center.y,c=eo(e.angle),d=eo(t.angle),i=new Ns(Math.cos(c),-Math.sin(c),s,Math.sin(c),Math.cos(c),a,0,0,1),h=new Ns(Math.cos(d),-Math.sin(d),r,Math.sin(d),Math.cos(d),l,0,0,1),u=i.inverse,g=h.inverse,p=u.transpose.mul(o).mul(u),D=g.transpose.mul(n).mul(g),m=p.m11,M=p.m12,B=p.m13,P=p.m21,f=p.m22,O=p.m23,v=p.m31,T=p.m32,x=p.m33,C=D.m11,S=D.m12,z=D.m13,L=D.m21,N=D.m22,_=D.m23,X=D.m31,H=D.m32,R=D.m33,F=m*f*x-m*O*T-M*P*x+M*O*v+B*P*T-B*f*v,G=(m*f*R-m*O*H-m*T*_+m*x*N-M*P*R+M*O*X+M*v*_-M*x*L+B*P*H-B*f*X-B*v*N+B*T*L+P*T*z-P*x*S-f*v*z+f*x*C+O*v*S-O*T*C)/F,Q=(m*N*R-m*_*H-M*L*R+M*_*X+B*L*H-B*N*X-P*S*R+P*z*H+f*C*R-f*z*X-O*C*H+O*S*X+v*S*_-v*z*N-T*C*_+T*z*L+x*C*N-x*S*L)/F,le=(C*N*R-C*_*H-S*L*R+S*_*X+z*L*H-z*N*X)/F;if(G>=0){let se=-3*Q+G**2,ne=3*G*le+Q*G**2-4*Q**2,ie=-27*le**2+18*le*G*Q+G**2*Q**2-4*G**3*le-4*Q**3;return!(se>0&&ne<0&&ie>0)}else{let se=-3*Q+G**2,ne=-27*le**2+18*le*G*Q+G**2*Q**2-4*G**3*le-4*Q**3;return!(se>0&&ne>0)}}function ed(e,t){return Br(e,new Eo(t.points()))}function Br(e,t){let o=e.toMat2().inverse;return t=new Eo(t.pts.map(n=>o.transform(n.sub(e.center)))),da(new Po(J(),1),t)}function Cu(e,t){return e.x===t.x&&e.y===t.y}function Ru(e,t){return t instanceof oe?Cu(t,e.pt):t instanceof Po?la(t,e.pt):t instanceof Io?Rr(t,e.pt):t instanceof Ft?ca(t,e.pt):t instanceof Eo?Bn(t,e.pt):t instanceof yn?Ir(t,e.pt):!1}function Pu(e,t){return t instanceof oe?Rr(e,t):t instanceof Po?li(e,t):t instanceof Io?Dr(e,t)!=null:t instanceof Ft?Cr(t,e):t instanceof Eo?Pr(e,t):t instanceof yn?kl(t,e):!1}function Iu(e,t){return t instanceof oe?la(e,t):t instanceof Po?Tu(e,t):t instanceof Io?li(t,e):t instanceof Ft?jl(t,e):t instanceof Eo?da(e,t):t instanceof yn?Yi(t,e):!1}function Bu(e,t){return t instanceof oe?ca(e,t):t instanceof Po?jl(e,t):t instanceof Io?Cr(e,t):t instanceof Ft?Jl(e,t):t instanceof Eo?Zl(e,t):t instanceof yn?ed(t,e):!1}function Lu(e,t){return t instanceof oe?Bn(e,t):t instanceof Po?da(t,e):t instanceof Io?Pr(t,e):t instanceof Ft?Zl(t,e):t instanceof Eo?Ql(t,e):t instanceof yn?Br(t,e):!1}function zu(e,t){return t instanceof oe?Ir(e,t):t instanceof Po?Yi(e,t):t instanceof Io?kl(e,t):t instanceof Ft?ed(e,t):t instanceof Eo?Br(e,t):t instanceof yn?Du(t,e):!1}function td(e,t,o){let n=e,s=o.p1,a=o.p2,r=t,l=a.sub(s),c=r.cross(l);if(Math.abs(c)<Number.EPSILON)return null;let d=s.sub(n),i=d.cross(l)/c;if(i<=0||i>=1)return null;let h=d.cross(r)/c;if(h<=0||h>=1)return null;let u=l.normal().unit();return t.dot(u)>0&&(u.x*=-1,u.y*=-1),{point:n.add(r.scale(i)),normal:u,fraction:i}}function Ou(e,t,o){let n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,a;if(e.x!=0){let r=(o.pos.x-e.x)/t.x,l=(o.pos.x+o.width-e.x)/t.x;a=J(-Math.sign(t.x),0),n=Math.max(n,Math.min(r,l)),s=Math.min(s,Math.max(r,l))}if(e.y!=0){let r=(o.pos.y-e.y)/t.y,l=(o.pos.y+o.height-e.y)/t.y;Math.min(r,l)>n&&(a=J(0,-Math.sign(t.y))),n=Math.max(n,Math.min(r,l)),s=Math.min(s,Math.max(r,l))}return s>=n&&n>=0&&n<=1?{point:e.add(t.scale(n)),normal:a,fraction:n}:null}function od(e,t,o){let n=e,s=o.center,a=t,r=a.dot(a),l=n.sub(s),c=2*a.dot(l),d=l.dot(l)-o.radius*o.radius,i=c*c-4*r*d;if(r<=Number.EPSILON||i<0)return null;if(i==0){let h=-c/(2*r);if(h>=0&&h<=1){let u=n.add(a.scale(h));return{point:u,normal:u.sub(s),fraction:h}}}else{let h=(-c+Math.sqrt(i))/(2*r),u=(-c-Math.sqrt(i))/(2*r),g=null;if(h>=0&&h<=1&&(g=h),u>=0&&u<=1&&(g=Math.min(u,g??u)),g!=null){let p=n.add(a.scale(g));return{point:p,normal:p.sub(s).unit(),fraction:g}}}return null}function Hu(e,t,o){let n=o.pts,s=null,a=n[n.length-1];for(let r=0;r<n.length;r++){let l=n[r],c=td(e,t,new Io(a,l));c&&(!s||s.fraction>c.fraction)&&(s=c),a=l}return s}function Uu(e,t,o){let n=o.toMat2(),s=n.inverse,a=s.transform(e.sub(o.center)),r=s.transform(t),l=od(a,r,new Po(J(),1));if(l){let c=Fi.rotation(eo(-o.angle)),d=Fi.scale(o.radiusX,o.radiusY).transform(l.point),i=n.transform(l.point).add(o.center),h=i.dist(e)/t.len();return{point:i,normal:c.transform(J(o.radiusY**2*d.x,o.radiusX**2*d.y)).unit(),fraction:h}}return l}function Nu(e,t,o,n=64){let s=e,a=t.len(),r=t.scale(1/a),l=0,c=J(Math.floor(e.x),Math.floor(e.y)),d=J(r.x>0?1:-1,r.y>0?1:-1),i=J(Math.abs(1/r.x),Math.abs(1/r.y)),h=J(d.x>0?c.x+1-e.x:e.x-c.x,d.y>0?c.y+1-e.y:e.y-c.y),u=J(i.x<1/0?i.x*h.x:1/0,i.y<1/0?i.y*h.y:1/0),g=-1;for(;l<=n;){let p=o(c);if(p===!0)return{point:s.add(r.scale(l)),normal:J(g===0?-d.x:0,g===1?-d.y:0),fraction:l/a,gridPos:c};if(p)return p;u.x<u.y?(c.x+=d.x,l=u.x,u.x+=i.x,g=0):(c.y+=d.y,l=u.y,u.y+=i.y,g=1)}return null}var _u=class Wa{pt;constructor(t){this.pt=t.clone()}transform(t){return new Wa(t.multVec2(this.pt))}bbox(){return new Ft(this.pt,0,0)}area(){return 0}clone(){return new Wa(this.pt)}collides(t){return Ru(this,t)}contains(t){return this.pt.eq(t)}raycast(t,o){return null}random(){return this.pt.clone()}},Io=class $a{p1;p2;constructor(t,o){this.p1=t.clone(),this.p2=o.clone()}transform(t){return new $a(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return Ft.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new $a(this.p1,this.p2)}collides(t){return Pu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return td(t,o,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(ao(1)))}},Ft=class Ja{pos;width;height;constructor(t,o,n){this.pos=t.clone(),this.width=o,this.height=n}static fromPoints(t,o){return new Ja(t.clone(),o.x-t.x,o.y-t.y)}center(){return new oe(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(t){return new Eo(this.points().map(o=>t.multVec2(o)))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new Ja(this.pos.clone(),this.width,this.height)}distToPoint(t){return Math.sqrt(this.sdistToPoint(t))}sdistToPoint(t){let o=this.pos,n=this.pos.add(this.width,this.height),s=Math.max(o.x-t.x,0,t.x-n.x),a=Math.max(o.y-t.y,0,t.y-n.y);return s*s+a*a}collides(t){return Bu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Ou(t,o,this)}random(){return this.pos.add(ao(this.width),ao(this.height))}},Po=class nd{center;radius;constructor(t,o){this.center=t.clone(),this.radius=o}transform(t){return new yn(this.center,this.radius,this.radius).transform(t)}bbox(){return Ft.fromPoints(this.center.sub(J(this.radius)),this.center.add(J(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new nd(this.center,this.radius)}collides(t){return Iu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return od(t,o,this)}random(){return this.center.add(oe.fromAngle(ao(360)).scale(ao(this.radius)))}},yn=class ds{center;radiusX;radiusY;angle;constructor(t,o,n,s=0){this.center=t.clone(),this.radiusX=o,this.radiusY=n,this.angle=s}static fromMat2(t){let o=t.inverse,n=o.transpose.mul(o),[s,a]=n.eigenvalues,[r,l]=n.eigenvectors(s,a),[c,d]=[1/Math.sqrt(s),1/Math.sqrt(a)];return c>d?new ds(J(),c,d,Kn(Math.atan2(-r[1],r[0]))):new ds(J(),d,c,Kn(Math.atan2(-l[1],l[0])))}toMat2(){let t=eo(this.angle),o=Math.cos(t),n=Math.sin(t);return new Fi(o*this.radiusX,-n*this.radiusY,n*this.radiusX,o*this.radiusY)}transform(t){if(this.angle==0&&t.getRotation()==0)return new ds(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let o=this.toMat2(),n=t.getRotation(),s=t.getScale();o=Ns.fromMat2(o).scale(s.x,s.y).rotate(n).toMat2();let a=ds.fromMat2(o);return a.center=t.multVec2(this.center),a}}bbox(){if(this.angle==0)return Ft.fromPoints(this.center.sub(J(this.radiusX,this.radiusY)),this.center.add(J(this.radiusX,this.radiusY)));{let t=eo(this.angle),o=Math.cos(t),n=Math.sin(t),s=this.radiusX*o,a=this.radiusX*n,r=this.radiusY*n,l=this.radiusY*o,c=Math.sqrt(s*s+r*r),d=Math.sqrt(a*a+l*l);return Ft.fromPoints(this.center.sub(J(c,d)),this.center.add(J(c,d)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new ds(this.center,this.radiusX,this.radiusY,this.angle)}collides(t){return zu(this,t)}contains(t){t=t.sub(this.center);let o=eo(this.angle),n=Math.cos(o),s=Math.sin(o),a=t.x*n+t.y*s,r=-t.x*s+t.y*n;return a*a/(this.radiusX*this.radiusX)+r*r/(this.radiusY*this.radiusY)<1}raycast(t,o){return Uu(t,o,this)}random(){return this.center}};function Xu(e,t,o,n){let s=t.sub(e),a=n.sub(o),r=s.cross(a);return r<1e-5&&r>-1e-5||(r=o.sub(e).cross(a)/r,r<0||r>1)?null:e.add(s.scale(r))}var Eo=class Xs{pts;constructor(t){if(t.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=t}transform(t){return new Xs(this.pts.map(o=>t.multVec2(o)))}bbox(){let t=J(Number.MAX_VALUE),o=J(-Number.MAX_VALUE);for(let n of this.pts)t.x=Math.min(t.x,n.x),o.x=Math.max(o.x,n.x),t.y=Math.min(t.y,n.y),o.y=Math.max(o.y,n.y);return Ft.fromPoints(t,o)}area(){let t=0,o=this.pts.length;for(let n=0;n<o;n++){let s=this.pts[n],a=this.pts[(n+1)%o];t+=s.x*a.y*.5,t-=a.x*s.y*.5}return Math.abs(t)}clone(){return new Xs(this.pts.map(t=>t.clone()))}collides(t){return Lu(this,t)}contains(t){return this.collides(t)}raycast(t,o){return Hu(t,o,this)}random(){return J()}cut(t,o){new Io(t,o);let n=[],s=[],a=o.sub(t),r=this.pts[this.pts.length-1],l=r.sub(t),c=a.cross(l)>0;return this.pts.forEach(d=>{l=d.sub(t);let i=a.cross(l)>0;if(c!=i){let h=Xu(r,d,t,o);n.push(h),s.push(h),c=i}(i?n:s).push(d),r=d}),[n.length?new Xs(n):null,s.length?new Xs(s):null]}};function Fu(e,t,o,n){let s=n*n,a=1-n,r=a*a;return e.scale(r).add(t.scale(2*a*n)).add(o.scale(s))}function Yu(e,t,o,n){let s=1-n;return t.sub(e).scale(2*s).add(o.sub(t).scale(2*n))}function qu(e,t,o,n){return o.sub(t.scale(2)).add(e).scale(2)}function Lr(e,t,o,n,s){let a=s*s,r=a*s,l=1-s,c=l*l,d=c*l;return e.scale(d).add(t.scale(3*c*s)).add(o.scale(3*l*a)).add(n.scale(r))}function Gu(e,t,o,n,s){let a=s*s,r=1-s,l=r*r;return t.sub(e).scale(3*l).add(o.sub(t).scale(6*r*s)).add(n.sub(o).scale(3*a))}function Ku(e,t,o,n,s){let a=1-s;return o.sub(t.scale(2)).add(e).scale(6*a).add(n.sub(o.scale(2)).add(t).scale(6*s))}function Vu(e,t,o,n,s){let a=.5*(((-s+2)*s-1)*s),r=.5*((3*s-5)*s*s+2),l=.5*(((-3*s+4)*s+1)*s),c=.5*((s-1)*s*s);return e.scale(a).add(t.scale(r)).add(o.scale(l)).add(n.scale(c))}function Wu(e,t,o,n,s){let a=.5*((-3*s+4)*s-1),r=.5*((9*s-10)*s),l=.5*((-9*s+8)*s+1),c=.5*((3*s-2)*s);return e.scale(a).add(t.scale(r)).add(o.scale(l)).add(n.scale(c))}function $u(e){let t=sd(e),o=t(1);return n=>{let s=n*o,a=t(s,!0);return e(a)}}function sd(e,t=10,o=10){let n=[0],s=[0],a=1/(t-1)/o,r=0,l=e(0),c=0;for(let d=1;d<t;d++){for(let i=0;i<o;i++){c+=a;let h=e(c),u=h.dist(l);r+=u,l=h}n[d]=r,s[d]=c}return s[t-1]=1,(d,i=!1)=>{if(i){let h=d;if(h<=0)return 0;if(h>=r)return 1;let u=0;for(;n[u+1]<h;)u++;let g=s[u],p=s[u+1],D=n[u],m=n[u+1],M=(h-D)/(m-D);return g+(p-g)*M}else{if(d<=0)return 0;if(d>=1)return n[t-1];let h=0;for(;s[h+1]<d;)h++;let u=s[h],g=s[h+1],p=n[h],D=n[h+1],m=(d-u)/(g-u);return p+(D-p)*m}}}function di(e,t,o,n){let s=2*e+t-2*n+o,a=-3*e+3*n-2*t-o,r=t,l=e;return c=>{let d=c*c,i=d*c;return s*i+a*d+r*c+l}}function id(e,t,o,n,s,a=di){let r=a(t.x,(1-s)*(o.x-e.x),(1-s)*(n.x-t.x),o.x),l=a(t.y,(1-s)*(o.y-e.y),(1-s)*(n.y-t.y),o.y);return c=>new oe(r(c),l(c))}function qi(e,t,o,n,s=di){return id(e,t,o,n,.5,s)}function Ju(e,t,o,n,s=di){return qi(n.add(e.sub(t).scale(6)),e,n,e.add(n.sub(o).scale(6)),s)}function ju(e,t,o,n,s,a,r,l=di){let c=l(t.x,.5*(1-s)*(1+r)*(1+a)*(t.x-e.x)+.5*(1-s)*(1-r)*(1-a)*(o.x-t.x),.5*(1-s)*(1+r)*(1-a)*(o.x-t.x)+.5*(1-s)*(1-r)*(1+a)*(n.x-o.x),o.x),d=l(t.y,.5*(1-s)*(1+r)*(1+a)*(t.y-e.y)+.5*(1-s)*(1-r)*(1-a)*(o.y-t.y),.5*(1-s)*(1+r)*(1-a)*(o.y-t.y)+.5*(1-s)*(1-r)*(1+a)*(n.y-o.y),o.y);return i=>new oe(c(i),d(i))}function Zu(e,t,o,n){let s=2*e+t-2*n+o,a=-3*e+3*n-2*t+o,r=t;return l=>{let c=l*l;return 3*s*c+2*a*l+r}}function Is(e){return 0<=e&&e<=1}function Sa(e,t){return Math.abs(e-t)<=Number.EPSILON}function Bs(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Qu(e,t,o,n){let s=3*e-6*t+3*o,a=-3*e+3*t,r=e,l=-e+3*t-3*o+n;if(Sa(l,0)){if(Sa(s,0))return Sa(a,0)?[]:[-r/a].filter(Is);let m=Math.sqrt(a*a-4*s*r),M=2*s;return[(m-a)/M,(-a-m)/M].filter(Is)}s/=l,a/=l,r/=l;let c=(3*a-s*s)/3,d=c/3,i=(2*s*s*s-9*s*a+27*r)/27,h=i/2,u=h*h+d*d*d;if(u<0){let m=-c/3,M=m*m*m,B=Math.sqrt(M),P=-i/(2*B),f=P<-1?-1:P>1?1:P,O=Math.acos(f),v=2*Bs(B),T=v*Math.cos(O/3)-s/3,x=v*Math.cos((O+2*Math.PI)/3)-s/3,C=v*Math.cos((O+4*Math.PI)/3)-s/3;return[T,x,C].filter(Is)}if(u===0){let m=h<0?Bs(-h):-Bs(h),M=2*m-s/3,B=-m-s/3;return[M,B].filter(Is)}let g=Math.sqrt(u),p=Bs(g-h),D=Bs(g+h);return[p-D-s/3].filter(Is)}function ku(e,t,o,n,s){let a=Qu(e.x-s,t.x-s,o.x-s,n.x-s);return a.length>0?Lr(e,t,o,n,a[0]).y:NaN}function e0(e){if(!e||e.length==0)throw new Error("Need at least one point for easingLinear.");let t=e.length;return o=>{if(o<=0||e.length==1||o<=e[0].x)return e[0].y;for(let n=0;n<t;n++)if(e[n].x>=o)return tn(o,e[n-1].x,e[n].x,e[n-1].y,e[n].y);return e[e.length-1].y}}function t0(e,t){return o=>ku(J(0,0),e,t,J(1,1),o)}function o0(e,t="jump-end"){let o=1/e,n=t=="jump-start"||t=="jump-both",s=t=="jump-end"||t=="jump-both",a=1/(e+(s?1:0)),r=n?a:0;return l=>{let c=Math.floor(l/o);return r+c*a}}function n0(e,t){let o=Number.MAX_VALUE,n={normal:J(0),distance:0};for(let s of[e,t])for(let a=0;a<s.pts.length;a++){let r=s.pts[a],l=s.pts[(a+1)%s.pts.length].sub(r).normal().unit(),c=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let g=0;g<e.pts.length;g++){let p=e.pts[g].dot(l);c=Math.min(c,p),d=Math.max(d,p)}let i=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let g=0;g<t.pts.length;g++){let p=t.pts[g].dot(l);i=Math.min(i,p),h=Math.max(h,p)}let u=Math.min(d,h)-Math.max(c,i);if(u<0)return null;if(u<Math.abs(o)){let g=h-c,p=i-d;o=Math.abs(g)<Math.abs(p)?g:p,n.normal=l,n.distance=o}}return n}function ad(e,t,o){return(t.x-e.x)*(o.y-e.y)-(t.y-e.y)*(o.x-e.x)>=0}function s0(e){let t=0,o=e[e.length-1];for(let n=0;n<e.length;n++)t+=(e[n].x-o.x)*(e[n].y+o.y),o=e[n];return t<0}function Ma(e,t,o,n){let s=n.x-o.x,a=n.y-o.y,r=s*(e.y-o.y)-a*(e.x-o.x),l=s*(t.y-o.y)-a*(t.x-o.x);return r*l>=0}function i0(e,t,o,n){return Ma(e,t,o,n)&&Ma(e,o,t,n)&&Ma(e,n,t,o)}function a0(e,t,o,n){for(let s of e)if(s!==t&&s!==o&&s!==n&&i0(s,t,o,n))return!0;return!1}function r0(e,t,o,n){return ad(e,t,o)&&!a0(n,e,t,o)}function rd(e){if(e.length<3)return[];if(e.length==3)return[e];let t=[],o=[],n=0;for(let h=0;h<e.length;h++){let u=e[n],g=e[h];(g.x<u.x||g.x==u.x&&g.y<u.y)&&(n=n),t[h]=h+1,o[h]=h-1}t[t.length-1]=0,o[0]=o.length-1,s0(e)||([t,o]=[o,t]);let s=[];for(let h=0;h<e.length;++h)ad(e[o[h]],e[h],e[t[h]])||s.push(e[h]);let a=[],r=e.length,l=1,c=0,d,i;for(;r>3;){d=t[l],i=o[l];let h=e[i],u=e[l],g=e[d];if(r0(h,u,g,s))a.push([h,u,g]),t[i]=d,o[d]=i,s.splice(s.indexOf(u),1),--r,c=0;else if(++c>r)return[];l=d}return d=t[l],i=o[l],a.push([e[i],e[l],e[d]]),a}function c0(e){if(e.length<3)return!1;let t=e.length-2,o=e.length-1,n=0,s=e[o].sub(e[t]),a=e[n].sub(e[o]),r=s.cross(a);for(;n+1<e.length;)if(t=o,o=n,n++,s=e[o].sub(e[t]),a=e[n].sub(e[o]),s.cross(a)*r<0)return!1;return!0}var cd=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ha="topleft",l0="monospace",Gi="monospace",ja="linear",zr=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],d0=zr.reduce((e,t)=>e+t.size,0),ld=2048,h0=ld*4*d0,u0=ld*6,f0=`
attribute vec2 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 0.0, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,p0=`
precision mediump float;

varying vec2 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	vec4 texColor = texture2D(u_tex, v_uv);
	return vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Za=`
vec4 vert(vec2 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Qa=`
vec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`,g0=new Set(["id","require"]),m0=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),Tc=200,y0=640,x0=65536,dd=Symbol.for("kaplay.cancel"),hd=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},es=class ud{paused=!1;cancel;constructor(t){this.cancel=t}static join(t){let o=new ud(()=>t.forEach(n=>n.cancel()));return Object.defineProperty(o,"paused",{get:()=>t[0].paused,set:n=>t.forEach(s=>s.paused=n)}),o.paused=!1,o}static replace(t,o){return t.cancel=()=>o.cancel(),o.paused=t.paused,Object.defineProperty(t,"paused",{get:()=>o.paused,set:n=>o.paused=n}),t}},vo=class{cancellers=new WeakMap;handlers=new hd;add(e){function t(...s){if(!n.paused)return e(...s)}let o=this.handlers.pushd(t),n=new es(o);return this.cancellers.set(t,o),n}addOnce(e){let t=this.add((...o)=>{t.cancel(),e(...o)});return t}next(){return new Promise(e=>this.addOnce(e))}trigger(...e){this.handlers.forEach(t=>{let o=t(...e),n;o===dd&&(n=this.cancellers.get(t))&&n()})}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},ei=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new vo),this.handlers[e].add(t)}onOnce(e,t){let o=this.on(e,(...n)=>{o.cancel(),t(...n)});return o}next(e){return new Promise(t=>{this.onOnce(e,(...o)=>t(o[0]))})}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},w0=e=>e[0]instanceof vt,b0=e=>e[0]instanceof oe,v0=e=>typeof e[0]=="number",fd=class{_items;_compareFn;constructor(e=(t,o)=>t<o){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(this._items.length===0)return null;let e=this._items[0],t=this._items.pop();return this._items.length!==0&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function E0(e){let t=window.atob(e),o=t.length,n=new Uint8Array(o);for(let s=0;s<o;s++)n[s]=t.charCodeAt(s);return n.buffer}function A0(e){return E0(e.split(",")[1])}function Or(e,t){let o=document.createElement("a");o.href=t,o.download=e,o.click()}function pd(e,t){Or(e,"data:text/plain;charset=utf-8,"+t)}function S0(e,t){pd(e,JSON.stringify(t))}function Dc(e,t){let o=URL.createObjectURL(t);Or(e,o),URL.revokeObjectURL(o)}var gd=e=>e.match(/^data:\w+\/\w+;base64,.+/),M0=e=>e.split(".").slice(0,-1).join(".");function Hr(e,t){if(e===t)return!0;let o=typeof e,n=typeof t;if(o!==n)return!1;if(o==="object"&&n==="object"&&e!==null&&t!==null){if(Array.isArray(e)!==Array.isArray(t))return!1;let s=Object.keys(e),a=Object.keys(t);if(s.length!==a.length)return!1;for(let r of s){let l=e[r],c=t[r];if(!Hr(l,c))return!1}return!0}return!1}var Cc=new Set,T0=e=>e instanceof Error?e.message:String(e);function D0(e){Cc.has(e)||(Cc.add(e),console.warn(e))}function Es(e,t){D0(`${e} is deprecated. Use ${t} instead.`)}function ka(e,t){return Number(e.toFixed(t))}function qt(e,t){return(...o)=>{let n=o.length;if(n===e.length)return e(...o);if(n===t.length)return t(...o)}}var C0=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function R0(e){if(typeof e!="string")throw new TypeError("string cannot be undefined or null");let t=[],o=0,n=0;for(;o<e.length;){if(n+=P0(o+n,e),U0(e[o+n])&&n++,z0(e[o+n])&&n++,O0(e[o+n])&&n++,N0(e[o+n])){n++;continue}t.push(e.substring(o,o+n)),o+=n,n=0}return t}function P0(e,t){let o=t[e];if(!I0(o)||e===t.length-1)return 1;let n=o+t[e+1],s=t.substring(e+2,e+5);return Rc(n)&&Rc(s)?4:B0(n)&&H0(s)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:L0(s)?4:2}function I0(e){return e&&ts(e[0].charCodeAt(0),55296,56319)}function Rc(e){return ts(Ur(e),127462,127487)}function B0(e){return ts(Ur(e),127988,127988)}function L0(e){return ts(Ur(e),127995,127999)}function z0(e){return typeof e=="string"&&ts(e.charCodeAt(0),65024,65039)}function O0(e){return typeof e=="string"&&ts(e.charCodeAt(0),8400,8447)}function H0(e){let t=e.codePointAt(0);return typeof e=="string"&&typeof t=="number"&&ts(t,917504,917631)}function U0(e){return typeof e=="string"&&C0.includes(e.charCodeAt(0))}function N0(e){return typeof e=="string"&&e.charCodeAt(0)===8205}function Ur(e){let t=e.charCodeAt(0)-55296,o=e.charCodeAt(1)-56320;return(t<<10)+o+65536}function ts(e,t,o){return e>=t&&e<=o}var Lo=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,jo=(e,t)=>Array.isArray(t)?t.some(o=>e.has(o)):e.has(t),Ei=(e,t,o)=>{e.has(t)?e.get(t)?.push(o):e.set(t,[o])},_0=(()=>{let e=0;return()=>e++})(),X0={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}};function md(){let e=w.globalOpt.pixelDensity??1,t=w.globalOpt.width,o=w.globalOpt.height,n=w.gfx.ggl.gl.drawingBufferWidth,s=w.gfx.ggl.gl.drawingBufferHeight,a=n/e,r=s/e,l=0,c=0,d=a,i=r;if(w.globalOpt.letterbox){if(!t||!o)throw new Error("Letterboxing requires width and height defined.");let h=a/r,u=t/o;if(h>u){let g=r*u;l=(a-g)/2,d=g}else{let g=a/u;i=g,c=(r-g)/2}}if(w.globalOpt.stretch&&(!w.globalOpt.width||!w.globalOpt.height))throw new Error("Stretching requires width and height defined.");w.gfx.viewport={x:l,y:c,width:d,height:i,scale:(w.gfx.viewport.width+w.gfx.viewport.height)/(w.gfx.width+w.gfx.height)}}function F0(e){return new oe(e.x*w.gfx.viewport.width/w.gfx.width,e.y*w.gfx.viewport.height/w.gfx.height)}function dn(e){return new oe((e.x-w.gfx.viewport.x)*w.gfx.width/w.gfx.viewport.width,(e.y-w.gfx.viewport.y)*w.gfx.height/w.gfx.viewport.height)}var Y0=()=>_n.lastInputDevice,q0=()=>{let e=_n.buttons;for(let t in e){let o=e[t].keyboard&&[e[t].keyboard].flat(),n=e[t].keyboardCode&&[e[t].keyboardCode].flat(),s=e[t].gamepad&&[e[t].gamepad].flat(),a=e[t].mouse&&[e[t].mouse].flat();o&&o.forEach(r=>{Ei(_n.buttonsByKey,r,t)}),n&&n.forEach(r=>{Ei(_n.buttonsByKeyCode,r,t)}),s&&s.forEach(r=>{Ei(_n.buttonsByGamepad,r,t)}),a&&a.forEach(r=>{Ei(_n.buttonsByMouse,r,t)})}},$s=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},G0=class{buttonState=new $s;stickState=new Map},K0=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce((t,o)=>t+o)/this.dts.length)),this.dts=[])}},_n,Pc=X0,V0=e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:1/50,restDt:0,time:0,realTime:0,fpsCounter:new K0,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new oe(0),mouseDeltaPos:new oe(0),keyState:new $s,mouseState:new $s,mergedGamepadState:new G0,gamepadStates:new Map,lastInputDevice:null,buttonState:new $s,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new ei}},W0=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=V0(e);_n=t,q0();function o(){return t.dt*t.timeScale}function n(){return t.fixedDt*t.timeScale}function s(){return t.restDt*t.timeScale}function a(){return t.isHidden}function r(){return t.time}function l(){return t.fpsCounter.fps}function c(){return t.numFrames}function d(){return t.canvas.toDataURL()}function i(I){t.canvas.style.cursor=I}function h(){return t.canvas.style.cursor}function u(I){if(I)try{let K=t.canvas.requestPointerLock();K?.catch&&K.catch(ee=>console.error(ee))}catch(K){console.error(K)}else document.exitPointerLock()}function g(){return!!document.pointerLockElement}function p(I){I.requestFullscreen?I.requestFullscreen():I.webkitRequestFullscreen&&I.webkitRequestFullscreen()}function D(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()}function m(I=!0){I?p(t.canvas):D()}function M(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function B(){t.stopped=!0;let I=Object.entries(bt),K=Object.entries(St),ee=Object.entries(ye);for(let[ue,Ze]of I)t.canvas.removeEventListener(ue,Ze);for(let[ue,Ze]of K)document.removeEventListener(ue,Ze);for(let[ue,Ze]of ee)window.removeEventListener(ue,Ze);ve.disconnect()}function P(I,K){t.loopID!==null&&cancelAnimationFrame(t.loopID);let ee=0,ue=0,Ze=it=>{if(t.stopped)return;if(document.visibilityState!=="visible"){t.loopID=requestAnimationFrame(Ze);return}let zt=it/1e3,rt=Math.min(zt-t.realTime,.25),Mt=e.maxFPS?1/e.maxFPS:0;if(t.realTime=zt,ue+=rt,ue>Mt){if(!t.skipTime){for(ee+=ue,t.dt=t.fixedDt,t.restDt=0;ee>t.fixedDt;)ee-=t.fixedDt,ee<t.fixedDt&&(t.restDt=ee),I();t.restDt=ee,t.dt=ue,t.time+=o(),t.fpsCounter.tick(t.dt)}ue=0,t.skipTime=!1,t.numFrames++,K(ct,yt)}t.loopID=requestAnimationFrame(Ze)};Ze(0)}function f(){return"ontouchstart"in window||navigator.maxTouchPoints>0}function O(){return t.mousePos.clone()}function v(){return t.mouseDeltaPos.clone()}function T(I="left"){return t.mouseState.pressed.has(I)}function x(I="left"){return t.mouseState.down.has(I)}function C(I="left"){return t.mouseState.released.has(I)}function S(){return t.isMouseMoved}function z(I){return I===void 0?t.keyState.pressed.size>0:jo(t.keyState.pressed,I)}function L(I){return I===void 0?t.keyState.pressedRepeat.size>0:jo(t.keyState.pressedRepeat,I)}function N(I){return I===void 0?t.keyState.down.size>0:jo(t.keyState.down,I)}function _(I){return I===void 0?t.keyState.released.size>0:jo(t.keyState.released,I)}function X(I){return I===void 0?t.mergedGamepadState.buttonState.pressed.size>0:jo(t.mergedGamepadState.buttonState.pressed,I)}function H(I){return I===void 0?t.mergedGamepadState.buttonState.down.size>0:jo(t.mergedGamepadState.buttonState.down,I)}function R(I){return I===void 0?t.mergedGamepadState.buttonState.released.size>0:jo(t.mergedGamepadState.buttonState.released,I)}function F(I){return I===void 0?t.buttonState.pressed.size>0:jo(t.buttonState.pressed,I)}function G(I){return I===void 0?t.buttonState.down.size>0:jo(t.buttonState.down,I)}function Q(I){return I===void 0?t.buttonState.released.size>0:jo(t.buttonState.released,I)}function le(I){return t.buttons?.[I]}function se(I,K){t.buttons[I]={...t.buttons[I],...K}}function ne(I){t.buttonState.press(I),t.events.trigger("buttonPress",I)}function ie(I){t.buttonState.release(I),t.events.trigger("buttonRelease",I)}function fe(I){return t.events.on("resize",I)}let Me=qt(I=>t.events.on("keyDown",I),(I,K)=>t.events.on("keyDown",ee=>Lo(I,ee)&&K(ee))),Ue=qt(I=>t.events.on("keyPress",K=>I(K)),(I,K)=>t.events.on("keyPress",ee=>Lo(I,ee)&&K(ee))),Ne=qt(I=>t.events.on("keyPressRepeat",I),(I,K)=>t.events.on("keyPressRepeat",ee=>Lo(I,ee)&&K(ee))),Pe=qt(I=>t.events.on("keyRelease",I),(I,K)=>t.events.on("keyRelease",ee=>Lo(I,ee)&&K(ee))),Ge=qt(I=>t.events.on("mouseDown",K=>I(K)),(I,K)=>t.events.on("mouseDown",ee=>Lo(I,ee)&&K(ee))),Te=qt(I=>t.events.on("mousePress",K=>I(K)),(I,K)=>t.events.on("mousePress",ee=>Lo(I,ee)&&K(ee))),ut=qt(I=>t.events.on("mouseRelease",K=>I(K)),(I,K)=>t.events.on("mouseRelease",ee=>ee===I&&K(ee)));function pe(I){return t.events.on("mouseMove",()=>I(O(),v()))}function Ae(I){return t.events.on("charInput",I)}function re(I){return t.events.on("touchStart",I)}function Ce(I){return t.events.on("touchMove",I)}function Fe(I){return t.events.on("touchEnd",I)}function De(I){return t.events.on("scroll",I)}function We(I){return t.events.on("hide",I)}function nt(I){return t.events.on("show",I)}let Tt=qt(I=>t.events.on("gamepadButtonPress",(K,ee)=>I(K,ee)),(I,K)=>t.events.on("gamepadButtonPress",(ee,ue)=>Lo(I,ee)&&K(ee,ue))),Lt=qt(I=>t.events.on("gamepadButtonDown",(K,ee)=>I(K,ee)),(I,K)=>t.events.on("gamepadButtonDown",(ee,ue)=>Lo(I,ee)&&K(ee,ue))),dt=qt(I=>t.events.on("gamepadButtonRelease",(K,ee)=>I(K,ee)),(I,K)=>t.events.on("gamepadButtonRelease",(ee,ue)=>Lo(I,ee)&&K(ee,ue)));function Ie(I,K){return t.events.on("gamepadStick",(ee,ue,Ze)=>ee===I&&K(ue,Ze))}function Be(I){t.events.on("gamepadConnect",I)}function Ke(I){t.events.on("gamepadDisconnect",I)}function qe(I){return t.mergedGamepadState.stickState.get(I)||new oe(0)}function ke(){return[...t.charInputted]}function at(){return[...t.gamepads]}let tt=qt(I=>t.events.on("buttonPress",K=>I(K)),(I,K)=>t.events.on("buttonPress",ee=>Lo(I,ee)&&K(ee))),ot=qt(I=>t.events.on("buttonDown",K=>I(K)),(I,K)=>t.events.on("buttonDown",ee=>Lo(I,ee)&&K(ee))),ft=qt(I=>t.events.on("buttonRelease",K=>I(K)),(I,K)=>t.events.on("buttonRelease",ee=>Lo(I,ee)&&K(ee)));function ct(){t.events.trigger("input"),t.keyState.down.forEach(I=>t.events.trigger("keyDown",I)),t.mouseState.down.forEach(I=>t.events.trigger("mouseDown",I)),t.buttonState.down.forEach(I=>{t.events.trigger("buttonDown",I)}),Nt()}function yt(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach((I,K)=>{t.mergedGamepadState.stickState.set(K,new oe(0))}),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new oe(0),t.gamepadStates.forEach(I=>{I.buttonState.update(),I.stickState.forEach((K,ee)=>{I.stickState.set(ee,new oe(0))})})}function Ht(I){let K={index:I.index,isPressed:ee=>t.gamepadStates.get(I.index)?.buttonState.pressed.has(ee)||!1,isDown:ee=>t.gamepadStates.get(I.index)?.buttonState.down.has(ee)||!1,isReleased:ee=>t.gamepadStates.get(I.index)?.buttonState.released.has(ee)||!1,getStick:ee=>t.gamepadStates.get(I.index)?.stickState.get(ee)||J()};return t.gamepads.push(K),t.gamepadStates.set(I.index,{buttonState:new $s,stickState:new Map([["left",new oe(0)],["right",new oe(0)]])}),K}function Dt(I){t.gamepads=t.gamepads.filter(K=>K.index!==I.index),t.gamepadStates.delete(I.index)}function Nt(){for(let I of navigator.getGamepads())I&&!t.gamepadStates.has(I.index)&&Ht(I);for(let I of t.gamepads){let K=navigator.getGamepads()[I.index];if(!K)continue;let ee=(e.gamepads??{})[K.id]||Pc[K.id]||Pc.default,ue=t.gamepadStates.get(I.index);if(ue){for(let Ze=0;Ze<K.buttons.length;Ze++){let it=ee.buttons[Ze],zt=K.buttons[Ze],rt=t.buttonsByGamepad.has(it);if(zt.pressed){if(ue.buttonState.down.has(it)){t.events.trigger("gamepadButtonDown",it,I);continue}t.lastInputDevice="gamepad",rt&&t.buttonsByGamepad.get(it)?.forEach(Mt=>{t.buttonState.press(Mt),t.events.trigger("buttonPress",Mt)}),t.mergedGamepadState.buttonState.press(it),ue.buttonState.press(it),t.events.trigger("gamepadButtonPress",it,I)}else ue.buttonState.down.has(it)&&(rt&&t.buttonsByGamepad.get(it)?.forEach(Mt=>{t.buttonState.release(Mt),t.events.trigger("buttonRelease",Mt)}),t.mergedGamepadState.buttonState.release(it),ue.buttonState.release(it),t.events.trigger("gamepadButtonRelease",it,I))}for(let Ze in ee.sticks){let it=ee.sticks[Ze];if(!it)continue;let zt=new oe(K.axes[it.x],K.axes[it.y]);ue.stickState.set(Ze,zt),t.mergedGamepadState.stickState.set(Ze,zt),t.events.trigger("gamepadStick",Ze,zt,I)}}}}let bt={},St={},ye={},$e=e.pixelDensity||1;bt.mousemove=I=>{let K=dn(new oe(I.offsetX,I.offsetY)),ee=new oe(I.movementX,I.movementY);if(M()){let ue=t.canvas.width/$e,Ze=t.canvas.height/$e,it=window.innerWidth,zt=window.innerHeight,rt=it/zt,Mt=ue/Ze;if(rt>Mt){let we=zt/Ze,be=(it-ue*we)/2;K.x=tn(I.offsetX-be,0,ue*we,0,ue),K.y=tn(I.offsetY,0,Ze*we,0,Ze)}else{let we=it/ue,be=(zt-Ze*we)/2;K.x=tn(I.offsetX,0,ue*we,0,ue),K.y=tn(I.offsetY-be,0,Ze*we,0,Ze)}}t.events.onOnce("input",()=>{t.isMouseMoved=!0,t.mousePos=K,t.mouseDeltaPos=ee,t.events.trigger("mouseMove")})};let ae=["left","middle","right","back","forward"];bt.mousedown=I=>{t.events.onOnce("input",()=>{let K=ae[I.button];K&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(K)&&t.buttonsByMouse.get(K)?.forEach(ee=>{t.buttonState.press(ee),t.events.trigger("buttonPress",ee)}),t.mouseState.press(K),t.events.trigger("mousePress",K))})},bt.mouseup=I=>{t.events.onOnce("input",()=>{let K=ae[I.button];K&&(t.buttonsByMouse.has(K)&&t.buttonsByMouse.get(K)?.forEach(ee=>{t.buttonState.release(ee),t.events.trigger("buttonRelease",ee)}),t.mouseState.release(K),t.events.trigger("mouseRelease",K))})};let Re=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),je={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};bt.keydown=I=>{Re.has(I.key)&&I.preventDefault(),t.events.onOnce("input",()=>{let K=je[I.key]||I.key.toLowerCase(),ee=I.code;if(K===void 0)throw new Error(`Unknown key: ${I.key}`);K.length===1?(t.events.trigger("charInput",K),t.charInputted.push(K)):K==="space"&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),I.repeat?(t.keyState.pressRepeat(K),t.events.trigger("keyPressRepeat",K)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(K)&&t.buttonsByKey.get(K)?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.buttonsByKeyCode.has(ee)&&t.buttonsByKeyCode.get(ee)?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.keyState.press(K),t.events.trigger("keyPressRepeat",K),t.events.trigger("keyPress",K))})},bt.keyup=I=>{t.events.onOnce("input",()=>{let K=je[I.key]||I.key.toLowerCase(),ee=I.code;t.buttonsByKey.has(K)&&t.buttonsByKey.get(K)?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.buttonsByKeyCode.has(ee)&&t.buttonsByKeyCode.get(ee)?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.keyState.release(K),t.events.trigger("keyRelease",K)})},bt.touchstart=I=>{I.preventDefault(),t.events.onOnce("input",()=>{let K=[...I.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=dn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(ue=>{t.buttonState.press(ue),t.events.trigger("buttonPress",ue)}),t.mouseState.press("left"),t.events.trigger("mousePress","left")),K.forEach(ue=>{t.events.trigger("touchStart",dn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},bt.touchmove=I=>{I.preventDefault(),t.events.onOnce("input",()=>{let K=[...I.changedTouches],ee=t.canvas.getBoundingClientRect();if(e.touchToMouse!==!1){let ue=t.mousePos;t.mousePos=dn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.mouseDeltaPos=t.mousePos.sub(ue),t.events.trigger("mouseMove")}K.forEach(ue=>{t.events.trigger("touchMove",dn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},bt.touchend=I=>{t.events.onOnce("input",()=>{let K=[...I.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=dn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.mouseDeltaPos=new oe(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach(ue=>{t.buttonState.release(ue),t.events.trigger("buttonRelease",ue)}),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),K.forEach(ue=>{t.events.trigger("touchEnd",dn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},bt.touchcancel=I=>{t.events.onOnce("input",()=>{let K=[...I.changedTouches],ee=t.canvas.getBoundingClientRect();e.touchToMouse!==!1&&(t.mousePos=dn(new oe(K[0].clientX-ee.x,K[0].clientY-ee.y)),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),K.forEach(ue=>{t.events.trigger("touchEnd",dn(new oe(ue.clientX-ee.x,ue.clientY-ee.y)),ue)})})},bt.wheel=I=>{I.preventDefault(),t.events.onOnce("input",()=>{t.events.trigger("scroll",new oe(I.deltaX,I.deltaY))})},bt.contextmenu=I=>I.preventDefault(),St.visibilitychange=()=>{document.visibilityState==="visible"?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},ye.gamepadconnected=I=>{let K=Ht(I.gamepad);t.events.onOnce("input",()=>{t.events.trigger("gamepadConnect",K)})},ye.gamepaddisconnected=I=>{let K=at().filter(ee=>ee.index===I.gamepad.index)[0];Dt(I.gamepad),t.events.onOnce("input",()=>{t.events.trigger("gamepadDisconnect",K)})};for(let[I,K]of Object.entries(bt))t.canvas.addEventListener(I,K);for(let[I,K]of Object.entries(St))document.addEventListener(I,K);for(let[I,K]of Object.entries(ye))window.addEventListener(I,K);let ve=new ResizeObserver(I=>{for(let K of I)if(K.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",()=>{t.events.trigger("resize")})}});return ve.observe(t.canvas),{state:t,dt:o,fixedDt:n,restDt:s,time:r,run:P,canvas:t.canvas,fps:l,numFrames:c,quit:B,isHidden:a,setFullscreen:m,isFullscreen:M,setCursor:i,screenshot:d,getGamepads:at,getCursor:h,setCursorLocked:u,isCursorLocked:g,isTouchscreen:f,mousePos:O,mouseDeltaPos:v,isKeyDown:N,isKeyPressed:z,isKeyPressedRepeat:L,isKeyReleased:_,isMouseDown:x,isMousePressed:T,isMouseReleased:C,isMouseMoved:S,isGamepadButtonPressed:X,isGamepadButtonDown:H,isGamepadButtonReleased:R,getGamepadStick:qe,isButtonPressed:F,isButtonDown:G,isButtonReleased:Q,setButton:se,getButton:le,pressButton:ne,releaseButton:ie,charInputted:ke,onResize:fe,onKeyDown:Me,onKeyPress:Ue,onKeyPressRepeat:Ne,onKeyRelease:Pe,onMouseDown:Ge,onMousePress:Te,onMouseRelease:ut,onMouseMove:pe,onCharInput:Ae,onTouchStart:re,onTouchMove:Ce,onTouchEnd:Fe,onScroll:De,onHide:We,onShow:nt,onGamepadButtonDown:Lt,onGamepadButtonPress:Tt,onGamepadButtonRelease:dt,onGamepadStick:Ie,onGamepadConnect:Be,onGamepadDisconnect:Ke,onButtonPress:tt,onButtonDown:ot,onButtonRelease:ft,getLastInputDeviceType:Y0,events:t.events}};function ro(){return w.app.dt()}function er(){return w.app.fixedDt()}function tr(){return w.app.restDt()}var $0=new oe(-1,-1),J0=new oe(0,-1),j0=new oe(1,-1),Z0=new oe(-1,0),Q0=new oe(0,0),k0=new oe(1,0),ef=new oe(-1,1),tf=new oe(0,1),of=new oe(1,1);function As(e){switch(e){case"topleft":return $0;case"top":return J0;case"topright":return j0;case"left":return Z0;case"center":return Q0;case"right":return k0;case"botleft":return ef;case"bot":return tf;case"botright":return of;default:return e}}function nf(e){switch(e){case"left":return 0;case"center":return .5;case"right":return 1;default:return 0}}function sf(e){return e.createBuffer(1,1,44100)}var Ai=2.5949095,Ic=1.70158+1,Bc=2*Math.PI/3,Lc=2*Math.PI/4.5,zi={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>e===0?0:Math.pow(2,10*e-10),easeOutExpo:e=>e===1?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>Ic*e*e*e-1.70158*e*e,easeOutBack:e=>1+Ic*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*((Ai+1)*2*e-Ai)/2:(Math.pow(2*e-2,2)*((Ai+1)*(e*2-2)+Ai)+2)/2,easeInElastic:e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*Bc),easeOutElastic:e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*Bc)+1,easeInOutElastic:e=>e===0?0:e===1?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Lc))/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Lc)/2+1,easeInBounce:e=>1-zi.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-zi.easeOutBounce(1-2*e))/2:(1+zi.easeOutBounce(2*e-1))/2},ti=zi;function af(e,t,o){let n=[],s=t;for(n.push(s);s!==e;){if(s=o.get(s),s==null)return null;n.push(s)}return n.reverse()}function rf(e,t,o){let n=new fd((r,l)=>r.cost<l.cost);n.insert({cost:0,node:t});let s=new Map;s.set(t,t);let a=new Map;for(a.set(t,0);n.length!==0;){let r=n.remove()?.node;if(r===o)break;let l=e.getNeighbours(r);for(let c of l){let d=(a.get(r)||0)+e.getCost(r,c)+e.getHeuristic(c,o);(!a.has(c)||d<a.get(c))&&(a.set(c,d),n.insert({cost:d,node:c}),s.set(c,r))}}return af(t,o,s)}var cf=class{a;b;polygon;constructor(e,t,o){this.a=e,this.b=t,this.polygon=new WeakRef(o)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},lf=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,o=0,n=0;for(let s of this._edges){s.polygon=new WeakRef(this);let a=s.a.x*s.b.y-s.a.y*s.b.x;t+=(s.a.x+s.b.x)*a,o+=(s.a.y+s.b.y)*a,n+=a}n/=2,this._centroid=J(t/(6*n),o/(6*n))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let o of this.edges)o.b.y>e.y!=o.a.y>e.y&&e.x<(o.a.x-o.b.x)*(e.y-o.b.y)/(o.a.y-o.b.y)+o.b.x&&(t=!t);return t}},df=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let o=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[o]}_findCommonEdge(e,t){for(let o of e.edges){let n=this._findEdge(o.b,o.a);if(n&&n.polygon.deref().id===t.id)return n}return null}addPolygon(e){let t=new lf(this._polygons.length),o=e.map((n,s)=>new cf(n,e[(s+1)%e.length],t));t.edges=o,this._polygons.push(t);for(let n of t.edges)this._addEdge(n);return t}addRect(e,t){let o=this._addPoint(e),n=this._addPoint(e.add(t.x,0)),s=this._addPoint(e.add(t)),a=this._addPoint(e.add(0,t.y));return this.addPolygon([o,n,s,a])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let o of this._polygons[e].edges){let n=this._findEdge(o.b,o.a);if(n){let s=n.polygon.deref();s&&t.push(s.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let o=this._polygons[e],n=this._polygons[t],s=o.centroid.x-n.centroid.x,a=o.centroid.y-n.centroid.y;return Math.sqrt(s*s+a*a)}getPath(e,t){return e===void 0||t===void 0?[]:e===t?[e,t]:rf(this,e,t)}getWaypointPath(e,t,o){let n=o?.type||"centroids",s=this._getLocation(e),a=this._getLocation(t);if(s===void 0||a===void 0)return[];let r=this.getPath(s.id,a.id);if(!r)return[];if(n==="edges"){let l=[];for(let c=1;c<r.length;c++){let d=this._polygons[r[c-1]],i=this._polygons[r[c]],h=this._findCommonEdge(d,i);l.push(h.middle.add(i.centroid.sub(h.middle).unit().scale(4)))}return[e,...l,t]}else return[e,...r.slice(1,-1).map(l=>this._polygons[l].centroid),t]}};function Js(e){let t=new an;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function hf(e){return new oe(e.x/fo()*2-1,-e.y/go()*2+1)}function Fs(e,t,o,n,s,a=1){n=eo(n%360),s=eo(s%360),s<=n&&(s+=Math.PI*2);let r=[],l=Math.ceil((s-n)/eo(8)*a),c=(s-n)/l,d=J(Math.cos(n),Math.sin(n)),i=J(Math.cos(c),Math.sin(c));for(let h=0;h<=l;h++)r.push(e.add(t*d.x,o*d.y)),d=J(d.x*i.x-d.y*i.y,d.x*i.y+d.y*i.x);return r}function uf(...e){let t=Bt(...e),o=e[3]??1;w.gfx.bgColor=t,w.gfx.bgAlpha=o,w.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,o)}function ff(){return w.gfx.bgColor?.clone?.()??null}function jt(...e){if(e[0]===void 0)return;let t=J(...e);t.x===0&&t.y===0||w.gfx.transform.translate(t)}function zo(){w.gfx.transformStack.push(w.gfx.transform.clone())}function pf(e){w.gfx.transform=e.clone()}function oi(...e){if(e[0]===void 0)return;let t=J(...e);t.x===1&&t.y===1||w.gfx.transform.scale(t)}function gs(e){e&&w.gfx.transform.rotate(e)}function Mo(){w.gfx.transformStack.length>0&&(w.gfx.transform=w.gfx.transformStack.pop())}function Oo(){w.gfx.renderer.flush()}function fo(){return w.gfx.width}function go(){return w.gfx.height}function yd(){return(w.gfx.viewport.width+w.gfx.viewport.height)/(w.gfx.width+w.gfx.height)}function Ki(){return J(fo()/2,go()/2)}var gf=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,o,n){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.textures=[Pn.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=n;let s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get 2d context");this.c2d=s}addSingle(e){let t=Pn.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new $t(0,0,1,1),0]}add(e){let t=e.width+this.padding*2,o=e.height+this.padding*2;if(t>this.canvas.width||o>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+o>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(Pn.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let n=this.textures[this.textures.length-1],s=new oe(this.x+this.padding,this.y+this.padding);return this.x+=t,o>this.curHeight&&(this.curHeight=o),e instanceof ImageData?this.c2d.putImageData(e,s.x,s.y):this.c2d.drawImage(e,s.x,s.y),n.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:s,size:new oe(e.width,e.height),texture:n}),this.lastTextureId++,[n,new $t(s.x/this.canvas.width,s.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function No(e){return typeof e!="string"||gd(e)?e:w.assets.urlPrefix+e}var _o=class xd{loaded=!1;data=null;error=null;onLoadEvents=new vo;onErrorEvents=new vo;onFinishEvents=new vo;constructor(t){t.then(o=>{this.loaded=!0,this.data=o,this.onLoadEvents.trigger(o)}).catch(o=>{if(this.error=o,this.onErrorEvents.numListeners()>0)this.onErrorEvents.trigger(o);else throw o}).finally(()=>{this.onFinishEvents.trigger(),this.loaded=!0})}static loaded(t){let o=new xd(Promise.resolve(t));return o.data=t,o.loaded=!0,o}onLoad(t){return this.loaded&&this.data?t(this.data):this.onLoadEvents.add(t),this}onError(t){return this.loaded&&this.error?t(this.error):this.onErrorEvents.add(t),this}onFinish(t){return this.loaded?t():this.onFinishEvents.add(t),this}then(t){return this.onLoad(t)}catch(t){return this.onError(t)}finally(t){return this.onFinish(t)}},is=class{assets=new Map;lastUID=0;add(e,t){let o=e??this.lastUID+++"",n=new _o(t);return this.assets.set(o,n),n}addLoaded(e,t){let o=e??this.lastUID+++"",n=_o.loaded(t);return this.assets.set(o,n),n}get(e){return this.assets.get(e)}progress(){if(this.assets.size===0)return 1;let e=0;return this.assets.forEach(t=>{t.loaded&&e++}),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter(e=>this.assets.get(e).error!==null).map(e=>[e,this.assets.get(e)])}};function Nr(e){return fetch(e).then(t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t})}function ua(e){return Nr(e).then(t=>t.json())}function mf(e){return Nr(e).then(t=>t.text())}function yf(e){return Nr(e).then(t=>t.arrayBuffer())}function xf(e){return e!==void 0&&(w.assets.urlPrefix=e),w.assets.urlPrefix}function wf(e,t){return w.assets.custom.add(e,ua(No(t)))}function fa(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((o,n)=>{t.onload=()=>o(t),t.onerror=()=>n(new Error(`Failed to load image from "${e}"`))})}function Vn(){let e=[w.assets.sprites,w.assets.sounds,w.assets.shaders,w.assets.fonts,w.assets.bitmapFonts,w.assets.custom];return e.reduce((t,o)=>t+o.progress(),0)/e.length}function wd(){return[w.assets.sprites,w.assets.sounds,w.assets.shaders,w.assets.fonts,w.assets.bitmapFonts,w.assets.custom].reduce((e,t)=>e.concat(t.getFailedAssets()),[])}function bf(e){return w.assets.custom.get(e)??null}function or(e){return w.assets.custom.add(null,e)}var vf=(e,t)=>({urlPrefix:"",sprites:new is,fonts:new is,bitmapFonts:new is,sounds:new is,shaders:new is,custom:new is,music:{},packer:new gf(e,2048,2048,t),loaded:!1}),Ef="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==",Ln=class Ys{tex;frames=[new $t(0,0,1,1)];anims={};slice9=null;constructor(t,o,n={},s=null){this.tex=t,o&&(this.frames=o),this.anims=n,this.slice9=s}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,o={}){return typeof t=="string"?Ys.fromURL(t,o):Promise.resolve(Ys.fromImage(t,o))}static fromImage(t,o={}){let[n,s]=o.singular?w.assets.packer.addSingle(t):w.assets.packer.add(t),a=o.frames?o.frames.map(r=>new $t(s.x+r.x*s.w,s.y+r.y*s.h,r.w*s.w,r.h*s.h)):vd(o.sliceX||1,o.sliceY||1,s.x,s.y,s.w,s.h);return new Ys(n,a,o.anims,o.slice9)}static fromURL(t,o={}){return fa(t).then(n=>Ys.fromImage(n,o))}};function Oi(e){if(typeof e=="string"){let t=bd(e);if(t)return t;if(Vn()<1)return null;throw new Error(`Sprite not found: ${e}`)}else{if(e instanceof Ln)return _o.loaded(e);if(e instanceof _o)return e;throw new Error(`Invalid sprite: ${e}`)}}function bd(e){return w.assets.sprites.get(e)??null}function js(e,t,o={sliceX:1,sliceY:1,anims:{}}){return t=No(t),Array.isArray(t)?t.some(n=>typeof n=="string")?w.assets.sprites.add(e,Promise.all(t.map(n=>typeof n=="string"?fa(n):Promise.resolve(n))).then(n=>zc(n,o))):w.assets.sprites.addLoaded(e,zc(t,o)):typeof t=="string"?w.assets.sprites.add(e,Ln.from(t,o)):w.assets.sprites.addLoaded(e,Ln.fromImage(t,o))}function vd(e=1,t=1,o=0,n=0,s=1,a=1){let r=[],l=s/e,c=a/t;for(let d=0;d<t;d++)for(let i=0;i<e;i++)r.push(new $t(o+i*l,n+d*c,l,c));return r}function zc(e,t={}){let o=document.createElement("canvas"),n=e[0].width,s=e[0].height;o.width=n*e.length,o.height=s;let a=o.getContext("2d");if(!a)throw new Error("Failed to create canvas context");e.forEach((l,c)=>{l instanceof ImageData?a.putImageData(l,c*n,0):a.drawImage(l,c*n,0)});let r=a.getImageData(0,0,e.length*n,s);return Ln.fromImage(r,{...t,sliceX:e.length,sliceY:1})}function Af(e="bean"){return js(e,Ef)}function Sf(e,t,o){t=No(t),o=No(o),typeof t=="string"&&!o&&(o=M0(t)+".json");let n=typeof o=="string"?ua(o):Promise.resolve(o);return w.assets.sprites.add(e,n.then(s=>{let a=s.meta.size,r=s.frames.map(c=>new $t(c.frame.x/a.w,c.frame.y/a.h,c.frame.w/a.w,c.frame.h/a.h)),l={};for(let c of s.meta.frameTags)c.from===c.to?l[c.name]=c.from:l[c.name]={from:c.from,to:c.to,speed:10,loop:!0,pingpong:c.direction==="pingpong"};return Ln.from(t,{frames:r,anims:l})}))}var Hi=class{fontface;filter=ja;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??ja,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:Bt(0,0,0)},typeof t.outline=="number"?this.outline.width=t.outline:typeof t.outline=="object"&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function Ed(e){if(!e)return Ed(w.globalOpt.font??l0);if(typeof e=="string"){let t=Sd(e),o=Ad(e);if(t)return t.data??t;if(o)return o.data??o;if(document.fonts.check(`64px ${e}`))return e;if(Vn()<1)return null;throw new Error(`Font not found: ${e}`)}else if(e instanceof _o)return e.data?e.data:e;return e}function Ad(e){return w.assets.fonts.get(e)??null}function Mf(e,t,o={}){let n=No(t),s=new FontFace(e,typeof t=="string"?`url(${n})`:n);return document.fonts.add(s),w.assets.fonts.add(e,s.load().catch(a=>{throw new Error(`Failed to load font from "${n}": ${a}`)}).then(a=>new Hi(a,o)))}function Tf(e,t,o,n){let s=e.width/t,a={},r=n.split("").entries();for(let[l,c]of r)a[c]=new $t(l%s*t,Math.floor(l/s)*o,t,o);return{tex:e,map:a,size:o}}function Sd(e){return w.assets.bitmapFonts.get(e)??null}function Df(e,t,o,n,s={}){let a=No(t);return w.assets.bitmapFonts.add(e,fa(a).then(r=>Tf(Pn.fromImage(w.gfx.ggl,r,s),o,n,s.chars??cd)))}function Cf(e,t){return t=No(t),w.assets.sprites.add(e,new Promise(async o=>{let n=typeof t=="string"?await ua(t):t,s=await Promise.all(n.frames.map(fa)),a=document.createElement("canvas");a.width=n.width,a.height=n.height*n.frames.length;let r=a.getContext("2d");if(!r)throw new Error("Failed to create canvas context");s.forEach((c,d)=>{r.drawImage(c,0,d*n.height)});let l=await js(null,a,{sliceY:n.frames.length,anims:n.anims});o(l)}))}var Rf=class{ctx;glProgram;constructor(e,t,o,n){this.ctx=e,e.onDestroy(()=>this.free());let s=e.gl,a=s.createShader(s.VERTEX_SHADER),r=s.createShader(s.FRAGMENT_SHADER);if(!a||!r)throw new Error("Failed to create shader");s.shaderSource(a,t),s.shaderSource(r,o),s.compileShader(a),s.compileShader(r);let l=s.createProgram();if(this.glProgram=l,s.attachShader(l,a),s.attachShader(l,r),n.forEach((c,d)=>s.bindAttribLocation(l,d,c)),s.linkProgram(l),!s.getProgramParameter(l,s.LINK_STATUS)){let c=s.getShaderInfoLog(a);if(c)throw new Error("VERTEX SHADER "+c);let d=s.getShaderInfoLog(r);if(d)throw new Error("FRAGMENT SHADER "+d)}s.deleteShader(a),s.deleteShader(r)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let o in e){let n=e[o],s=t.getUniformLocation(this.glProgram,o);if(typeof n=="number")t.uniform1f(s,n);else if(n instanceof an)t.uniformMatrix4fv(s,!1,new Float32Array(n.m));else if(n instanceof vt)t.uniform3f(s,n.r,n.g,n.b);else if(n instanceof oe)t.uniform2f(s,n.x,n.y);else if(Array.isArray(n))n[0],v0(n)?t.uniform1fv(s,n):b0(n)?t.uniform2fv(s,n.map(a=>[a.x,a.y]).flat()):w0(n)&&t.uniform3fv(s,n.map(a=>[a.r,a.g,a.b]).flat());else throw new Error("Unsupported uniform data type")}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function _r(e,t=Za,o=Qa){let n=f0.replace("{{user}}",t??Za),s=p0.replace("{{user}}",o??Qa);try{return new Rf(e,n,s,zr.map(a=>a.name))}catch(a){let r=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,l=T0(a).match(r);if(!l?.groups)throw a;let c=Number(l.groups.line)-14,d=l.groups.msg.trim(),i=l.groups.type.toLowerCase();throw new Error(`${i} shader line ${c}: ${d}`)}}function Pf(e){if(!e)return w.gfx.defShader;if(typeof e=="string"){let t=Md(e);if(t)return t.data??t;if(Vn()<1)return null;throw new Error(`Shader not found: ${e}`)}else if(e instanceof _o)return e.data?e.data:e;return e}function Md(e){return w.assets.shaders.get(e)??null}function If(e,t,o){return w.assets.shaders.addLoaded(e,_r(w.gfx.ggl,t,o))}function Bf(e,t,o){t=No(t),o=No(o);let n=a=>a?mf(a):Promise.resolve(null),s=Promise.all([n(t),n(o)]).then(([a,r])=>_r(w.gfx.ggl,a,r));return w.assets.shaders.add(e,s)}var ni=class Ui{buf;constructor(t){this.buf=t}static fromArrayBuffer(t){return new Promise((o,n)=>w.audio.ctx.decodeAudioData(t,o,n)).then(o=>new Ui(o))}static fromURL(t){return gd(t)?Ui.fromArrayBuffer(A0(t)):yf(t).then(o=>Ui.fromArrayBuffer(o))}};function Lf(e){if(typeof e=="string"){let t=Td(e);if(t)return t;if(Vn()<1)return null;throw new Error(`Sound not found: ${e}`)}else{if(e instanceof ni)return _o.loaded(e);if(e instanceof _o)return e;throw new Error(`Invalid sound: ${e}`)}}function Td(e){return w.assets.sounds.get(e)??null}function zf(e,t){return t=No(t),w.assets.sounds.add(e,typeof t=="string"?ni.fromURL(t):ni.fromArrayBuffer(t))}function Of(e,t){let o=No(t),n=new Audio(o);return n.preload="auto",w.assets.music[e]=o}function Dd(e,t){return e=No(e),or(typeof t=="string"?new Promise((o,n)=>{ua(t).then(s=>{Dd(e,s).then(o).catch(n)})}):Ln.from(e).then(o=>{let n={};for(let s in t){let a=t[s],r=o.frames[0],l=2048*r.w,c=2048*r.h,d=a.frames?a.frames.map(h=>new $t(r.x+(a.x+h.x)/l*r.w,r.y+(a.y+h.y)/c*r.h,h.w/l*r.w,h.h/c*r.h)):vd(a.sliceX||1,a.sliceY||1,r.x+a.x/l*r.w,r.y+a.y/c*r.h,a.width/l*r.w,a.height/c*r.h),i=new Ln(o.tex,d,a.anims);w.assets.sprites.addLoaded(s,i),n[s]=i}return n}))}function On(e,t,o=!1,n,s,a={}){let r=n??w.gfx.defTex,l=s??w.gfx.defShader,c=Pf(l);if(!c||c instanceof _o)return;let d=w.gfx.fixed||o?w.gfx.transform:w.game.cam.transform.mult(w.gfx.transform),i=[];for(let h of e){let u=hf(d.multVec2(h.pos));i.push(u.x,u.y,h.uv.x,h.uv.y,h.color.r/255,h.color.g/255,h.color.b/255,h.opacity)}w.gfx.renderer.push(w.gfx.ggl.gl.TRIANGLES,i,t,c,r,a)}function Rn(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(zo(),jt(e.pos),oi(e.scale),gs(e.angle),jt(e.offset),e.fill!==!1){let o=e.color??vt.WHITE,n=e.pts.map((a,r)=>({pos:new oe(a.x,a.y),uv:e.uv?e.uv[r]:new oe(0,0),color:e.colors&&e.colors[r]?e.colors[r].mult(o):o,opacity:e.opacity??1})),s;e.triangulate?s=rd(e.pts).map(a=>a.map(r=>e.pts.indexOf(r))).flat():s=[...Array(t-2).keys()].map(a=>[0,a+1,a+2]).flat(),On(n,e.indices??s,e.fixed,e.uv?e.tex:w.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&Xr({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),Mo()}}function Cd(e){if(e.radiusX===void 0||e.radiusY===void 0)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(e.radiusX===0||e.radiusY===0)return;let t=e.start??0,o=e.end??360,n=As(e.anchor??"center").scale(new oe(-e.radiusX,-e.radiusY)),s=Fs(n,e.radiusX,e.radiusY,t,o,e.resolution);s.unshift(n);let a=Object.assign({},e,{pts:s,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(s.length-1).fill(e.gradient[1])]}:{}});if(o-t>=360&&e.outline){e.fill!==!1&&Rn(Object.assign({},a,{outline:null})),Rn(Object.assign({},a,{pts:s.slice(1),fill:!1}));return}Rn(a)}function Ss(e){if(typeof e.radius!="number")throw new Error('drawCircle() requires property "radius".');e.radius!==0&&Cd(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function qs(e){let{p1:t,p2:o}=e;if(!t||!o)throw new Error('drawLine() requires properties "p1" and "p2".');let n=e.width||1,s=o.sub(t).unit().normal().scale(n*.5),a=[t.sub(s),t.add(s),o.add(s),o.sub(s)].map(r=>({pos:new oe(r.x,r.y),uv:new oe(0),color:e.color??vt.WHITE,opacity:e.opacity??1}));On(a,[0,1,3,1,2,3],e.fixed,w.gfx.defTex,e.shader,e.uniform??void 0)}function Hf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||J(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let p=r.scale(-n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),D=Math.PI/p,m=c.scale(-1),M=Math.cos(D),B=Math.sin(D);for(let P=0;P<p;P++)o.push(i),o.push(i.sub(m)),m=J(m.x*M-m.y*B,m.x*B+m.y*M)}}for(let p=1;p<t.length;p++){if(i===t[p]||i.eq(t[p]))continue;d=i,i=t[p];let D=i.sub(d),m=D.len(),M=D.normal().scale(-n/m),B=r.cross(D);if(Math.abs(B)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(D)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=D,l=m,c=M;continue}let P=M.sub(c).cross(D)/B,f=c.add(r.scale(P));B>0?(o.push(d.add(f)),o.push(d.sub(c)),o.push(d.add(f)),o.push(d.sub(M))):(o.push(d.add(c)),o.push(d.sub(f)),o.push(d.add(M)),o.push(d.sub(f))),r=D,l=m,c=M}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let p=r.scale(n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),D=Math.PI/p,m=c.scale(1),M=Math.cos(D),B=Math.sin(D);for(let P=0;P<p;P++)m=J(m.x*M-m.y*B,m.x*B+m.y*M),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(p=>({pos:a.add(p),uv:J(),color:e.color||vt.WHITE,opacity:e.opacity??1})),u=[],g=0;for(let p=0;p<o.length-2;p+=2)u[g++]=p+1,u[g++]=p,u[g++]=p+2,u[g++]=p+2,u[g++]=p+3,u[g++]=p+1;s&&(u[g++]=o.length-1,u[g++]=o.length-2,u[g++]=0,u[g++]=0,u[g++]=1,u[g++]=o.length-1),On(h,u,e.fixed,w.gfx.defTex,e.shader,e.uniform??void 0)}function Uf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||J(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let p=r.scale(-n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),D=Math.PI/p,m=c.scale(-1),M=Math.cos(D),B=Math.sin(D);for(let P=0;P<p;P++)o.push(i),o.push(i.sub(m)),m=J(m.x*M-m.y*B,m.x*B+m.y*M)}}for(let p=1;p<t.length;p++){if(i===t[p]||i.eq(t[p]))continue;d=i,i=t[p];let D=i.sub(d),m=D.len(),M=D.normal().scale(-n/m),B=r.cross(D);if(Math.abs(B)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(D)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=D,l=m,c=M;continue}let P=M.sub(c).cross(D)/B,f=c.add(r.scale(P));if(B>0){let O=d.add(f),v=Math.max(n,10),T=eo(c.angleBetween(M)/v),x=c,C=Math.cos(T),S=Math.sin(T);for(let z=0;z<v;z++)o.push(O),o.push(d.sub(x)),x=J(x.x*C-x.y*S,x.x*S+x.y*C)}else{let O=d.sub(f),v=Math.max(n,10),T=eo(c.angleBetween(M)/v),x=c,C=Math.cos(T),S=Math.sin(T);for(let z=0;z<v;z++)o.push(d.add(x)),o.push(O),x=J(x.x*C-x.y*S,x.x*S+x.y*C)}r=D,l=m,c=M}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let p=r.scale(n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),D=Math.PI/p,m=c.scale(1),M=Math.cos(D),B=Math.sin(D);for(let P=0;P<p;P++)m=J(m.x*M-m.y*B,m.x*B+m.y*M),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(p=>({pos:a.add(p),uv:J(),color:e.color||vt.WHITE,opacity:e.opacity??1})),u=[],g=0;for(let p=0;p<o.length-2;p+=2)u[g++]=p+1,u[g++]=p,u[g++]=p+2,u[g++]=p+2,u[g++]=p+3,u[g++]=p+1;s&&(u[g++]=o.length-1,u[g++]=o.length-2,u[g++]=0,u[g++]=0,u[g++]=1,u[g++]=o.length-1),On(h,u,e.fixed,w.gfx.defTex,e.shader,e.uniform??void 0)}function Nf(e){let t=e.pts,o=[],n=(e.width||1)*.5,s=t[0]===t[t.length-1]||t[0].eq(t[t.length-1]),a=e.pos||J(0,0),r;s?r=t[0].sub(t[t.length-2]):r=t[1].sub(t[0]);let l=r.len(),c=r.normal().scale(-n/l),d,i=t[0];if(!s)switch(e.cap){case"square":{let p=r.scale(-n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),D=Math.PI/p,m=c.scale(-1),M=Math.cos(D),B=Math.sin(D);for(let P=0;P<p;P++)o.push(i),o.push(i.sub(m)),m=J(m.x*M-m.y*B,m.x*B+m.y*M)}}for(let p=1;p<t.length;p++){if(i===t[p]||i.eq(t[p]))continue;d=i,i=t[p];let D=i.sub(d),m=D.len(),M=D.normal().scale(-n/m),B=r.cross(D);if(Math.abs(B)/(l*m)<.05){o.push(d.add(c)),o.push(d.sub(c)),r.dot(D)<0&&(o.push(d.sub(c)),o.push(d.add(c))),r=D,l=m,c=M;continue}let P=M.sub(c).cross(D)/B,f=c.add(r.scale(P));o.push(d.add(f)),o.push(d.sub(f)),r=D,l=m,c=M}if(!s)switch(o.push(i.add(c)),o.push(i.sub(c)),e.cap){case"square":{let p=r.scale(n/l);o.push(i.add(p).add(c)),o.push(i.add(p).sub(c));break}case"round":{let p=Math.max(n,10),D=Math.PI/p,m=c.scale(1),M=Math.cos(D),B=Math.sin(D);for(let P=0;P<p;P++)m=J(m.x*M-m.y*B,m.x*B+m.y*M),o.push(i),o.push(i.sub(m))}}if(o.length<4)return;let h=o.map(p=>({pos:a.add(p),uv:J(),color:e.color||vt.WHITE,opacity:e.opacity??1})),u=[],g=0;for(let p=0;p<o.length-2;p+=2)u[g++]=p+1,u[g++]=p,u[g++]=p+2,u[g++]=p+2,u[g++]=p+3,u[g++]=p+1;s&&(u[g++]=o.length-1,u[g++]=o.length-2,u[g++]=0,u[g++]=0,u[g++]=1,u[g++]=o.length-1),On(h,u,e.fixed,w.gfx.defTex,e.shader,e.uniform??void 0)}function Xr(e){let t=e.pts,o=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return Hf(e);case"round":return Uf(e);case"miter":return Nf(e)}if(e.radius&&t.length>=3){qs(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let s=t[n],a=t[n+1];qs(Object.assign({},e,{p1:s,p2:a}))}qs(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let n=0;n<t.length-1;n++)qs(Object.assign({},e,{p1:t[n],p2:t[n+1]})),e.join!=="none"&&Ss(Object.assign({},e,{pos:t[n],radius:o/2}))}}function Rd(e,t){let o=t.segments??16,n=[];for(let s=0;s<=o;s++)n.push(e(s/o));Xr({pts:n,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function _f(e){Rd(t=>Lr(e.pt1,e.pt2,e.pt3,e.pt4,t),e)}var Pn=class Pd{ctx;src=null;glTex;width;height;constructor(t,o,n,s={}){this.ctx=t;let a=t.gl,r=t.gl.createTexture();if(!r)throw new Error("Failed to create texture");this.glTex=r,t.onDestroy(()=>this.free()),this.width=o,this.height=n;let l={linear:a.LINEAR,nearest:a.NEAREST}[s.filter??t.opts.texFilter??"nearest"],c={repeat:a.REPEAT,clampToEdge:a.CLAMP_TO_EDGE}[s.wrap??"clampToEdge"];this.bind(),o&&n&&a.texImage2D(a.TEXTURE_2D,0,a.RGBA,o,n,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,l),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,c),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,c),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,o,n={}){let s=new Pd(t,o.width,o.height,n);return s.update(o),s.src=o,s}update(t,o=0,n=0){let s=this.ctx.gl;this.bind(),s.texSubImage2D(s.TEXTURE_2D,0,o,n,s.RGBA,s.UNSIGNED_BYTE,t),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},Vi=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,o,n={}){this.ctx=e;let s=e.gl;e.onDestroy(()=>this.free()),this.tex=new Pn(e,t,o,n);let a=s.createFramebuffer(),r=s.createRenderbuffer();if(!a||!r)throw new Error("Failed to create framebuffer");this.glFramebuffer=a,this.glRenderbuffer=r,this.bind(),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,t,o),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tex.glTex,0),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let o=this.width*4,n=new Uint8Array(o);for(let s=0;s<(this.height/2|0);s++){let a=s*o,r=(this.height-s-1)*o;n.set(t.subarray(a,a+o)),t.copyWithin(a,r,r+o),t.set(n,r)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},Xf=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,o,n){let s=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce((r,l)=>r+l.size,0),this.maxVertices=o,this.maxIndices=n;let a=s.createBuffer();if(!a)throw new Error("Failed to create vertex buffer");this.glVBuf=a,e.pushArrayBuffer(this.glVBuf),s.bufferData(s.ARRAY_BUFFER,o*4,s.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=s.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),s.bufferData(s.ELEMENT_ARRAY_BUFFER,n*4,s.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,o,n,s=null,a={}){(e!==this.curPrimitive||s!==this.curTex||n!==this.curShader||!Hr(this.curUniform,a)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+o.length>this.maxIndices)&&this.flush();let r=this.vqueue.length/this.stride;for(let l of t)this.vqueue.push(l);for(let l of o)this.iqueue.push(l+r);this.curPrimitive=e,this.curShader=n,this.curTex=s,this.curUniform=a}flush(){if(!this.curPrimitive||!this.curShader||this.vqueue.length===0||this.iqueue.length===0)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function Un(e){let t=[],o=a=>{t.push(a),e(a)},n=()=>{t.pop(),e(s()??null)},s=()=>t[t.length-1];return[o,n,s]}function Ff(e,t={}){let o=[];function n(O){o.push(O)}function s(){o.forEach(v=>v());let O=e.getExtension("WEBGL_lose_context");O&&O.loseContext()}let a=null;function r(O){if(Hr(O,a))return;a=O;let v=O.reduce((T,x)=>T+x.size,0);O.reduce((T,x,C)=>(e.vertexAttribPointer(C,x.size,e.FLOAT,!1,v*4,T),e.enableVertexAttribArray(C),T+x.size*4),0)}let[l,c]=Un(O=>e.bindTexture(e.TEXTURE_2D,O)),[d,i]=Un(O=>e.bindBuffer(e.ARRAY_BUFFER,O)),[h,u]=Un(O=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,O)),[g,p]=Un(O=>e.bindFramebuffer(e.FRAMEBUFFER,O)),[D,m]=Un(O=>e.bindRenderbuffer(e.RENDERBUFFER,O)),[M,B]=Un(O=>{if(!O)return;let{x:v,y:T,w:x,h:C}=O;e.viewport(v,T,x,C)}),[P,f]=Un(O=>e.useProgram(O));return M({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:n,destroy:s,pushTexture2D:l,popTexture2D:c,pushArrayBuffer:d,popArrayBuffer:i,pushElementArrayBuffer:h,popElementArrayBuffer:u,pushFramebuffer:g,popFramebuffer:p,pushRenderbuffer:D,popRenderbuffer:m,pushViewport:M,popViewport:B,pushProgram:P,popProgram:f,setVertexFormat:r}}var Ta={};function Oc(e,t){if(t.override){Object.assign(e,t);return}t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(J(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&e.ch.length===1&&(e.color=e.color.mult(t.color)),t.opacity!=null&&(e.opacity*=t.opacity)}function nr(e){let t={},o="",n=[],s=String(e),a=r=>{n.length>0&&(t[o.length]=n.slice()),o+=r};for(;s!=="";){if(s[0]==="\\"){if(s.length===1)throw new Error("Styled text error: \\ at end of string");a(s[1]),s=s.slice(2);continue}if(s[0]==="["){let r=/^\[(\/)?(\w+?)\]/.exec(s);if(!r){a(s[0]),s=s.slice(1);continue}let[l,c,d]=r;if(c!==void 0){let i=n.pop();if(i!==d)throw i!==void 0?new Error(`Styled text error: mismatched tags. Expected [/${i}], got [/${d}]`):new Error(`Styled text error: stray end tag [/${d}]`)}else n.push(d);s=s.slice(l.length);continue}a(s[0]),s=s.slice(1)}if(n.length>0)throw new Error(`Styled text error: unclosed tags ${n}`);return{charStyleMap:t,text:o}}function Wn(e){if(e.text===void 0)throw new Error('formatText() requires property "text".');let t=Ed(e.font);if(!e.text||e.text===""||t instanceof _o||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:o,text:n}=nr(e.text+""),s=R0(n);if(t instanceof Hi||typeof t=="string"){let P=t instanceof Hi?t.fontface.family:t,f=t instanceof Hi?{outline:t.outline,filter:t.filter}:{outline:null,filter:ja},O=Ta[P]??{font:{tex:new Pn(w.gfx.ggl,2048,2048,{filter:f.filter}),map:{},size:64},cursor:new oe(0),maxHeight:0,outline:f.outline};Ta[P]||(Ta[P]=O),t=O.font;for(let v of s)if(!O.font.map[v]){let T=w.fontCacheC2d;if(!T)throw new Error("fontCacheC2d is not defined.");if(!w.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");T.clearRect(0,0,w.fontCacheCanvas.width,w.fontCacheCanvas.height),T.font=`${t.size}px ${P}`,T.textBaseline="top",T.textAlign="left",T.fillStyle="#ffffff";let x=T.measureText(v),C=Math.ceil(x.width);if(!C)continue;let S=Math.ceil(Math.abs(x.actualBoundingBoxAscent))+Math.ceil(Math.abs(x.actualBoundingBoxDescent));O.outline&&O.outline.width&&O.outline.color&&(T.lineJoin="round",T.lineWidth=O.outline.width*2,T.strokeStyle=O.outline.color.toHex(),T.strokeText(v,O.outline.width,O.outline.width),C+=O.outline.width*2,S+=O.outline.width*3),T.fillText(v,O.outline?.width??0,O.outline?.width??0);let z=T.getImageData(0,0,C,S);if(O.cursor.x+C>2048&&(O.cursor.x=0,O.cursor.y+=O.maxHeight,O.maxHeight=0,O.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(z,O.cursor.x,O.cursor.y),t.map[v]=new $t(O.cursor.x,O.cursor.y,C,S),O.cursor.x+=C+1,O.maxHeight=Math.max(O.maxHeight,S)}}let a=e.size||t.size,r=J(e.scale??1).scale(a/t.size),l=e.lineSpacing??0,c=e.letterSpacing??0,d=0,i=0,h=0,u=[],g=[],p=0,D=null,m=0,M;for(;p<s.length;){let P=s[p];if(P===`
`)h+=a+l,u.push({width:d-c,chars:g}),D=null,m=0,d=0,g=[],M=void 0;else{let f=t.map[P];if(f){let O=f.w*r.x;e.width&&d+O>e.width&&(h+=a+l,D!=null&&(p-=g.length-D,P=s[p],f=t.map[P],O=f.w*r.x,g=g.slice(0,D-1),d=m),D=null,m=0,u.push({width:d-c,chars:g}),d=M??0,g=[]),g.push({tex:t.tex,width:f.w,height:f.h,quad:new $t(f.x/t.tex.width,f.y/t.tex.height,f.w/t.tex.width,f.h/t.tex.height),ch:P,pos:new oe(d,h),opacity:e.opacity??1,color:e.color??vt.WHITE,scale:J(r),angle:0}),P===" "&&(D=g.length,m=d),e.indentAll&&M===void 0&&/\S/.test(P)&&(M=d),d+=O,i=Math.max(i,d),d+=c}}p++}u.push({width:d-c,chars:g}),h+=a,e.width&&(i=e.width);let B=[];for(let P=0;P<u.length;P++){let f=(i-u[P].width)*nf(e.align??"left");for(let O of u[P].chars){let v=t.map[O.ch],T=B.length+P;if(O.pos=O.pos.add(f,0).add(v.w*r.x*.5,v.h*r.y*.5),e.transform){let x=typeof e.transform=="function"?e.transform(T,O.ch):e.transform;x&&Oc(O,x)}if(o[T]){let x=o[T];for(let C of x){let S=e.styles?.[C],z=typeof S=="function"?S(T,O.ch):S;z&&Oc(O,z)}}B.push(O)}}return{width:i,height:h,chars:B,opt:e,renderedText:n}}function si(e){if(e.width===void 0||e.height===void 0)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,n=As(e.anchor||ha).scale(new oe(t,o).scale(-.5)),s=e.quad||new $t(0,0,1,1),a=e.color||Bt(255,255,255),r=e.opacity??1,l=e.tex?.1/e.tex.width:0,c=e.tex?.1/e.tex.height:0,d=s.x+l,i=s.y+c,h=s.w-l*2,u=s.h-c*2;zo(),jt(e.pos),gs(e.angle),oi(e.scale),jt(n),On([{pos:new oe(-t/2,o/2),uv:new oe(e.flipX?d+h:d,e.flipY?i:i+u),color:a,opacity:r},{pos:new oe(-t/2,-o/2),uv:new oe(e.flipX?d+h:d,e.flipY?i+u:i),color:a,opacity:r},{pos:new oe(t/2,-o/2),uv:new oe(e.flipX?d:d+h,e.flipY?i+u:i),color:a,opacity:r},{pos:new oe(t/2,o/2),uv:new oe(e.flipX?d:d+h,e.flipY?i:i+u),color:a,opacity:r}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),Mo()}function $n(e){zo(),jt(e.opt.pos),gs(e.opt.angle),jt(As(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach(t=>{si({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})}),Mo()}function Ho(e){if(e.width===void 0||e.height===void 0)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,o=e.height,n=As(e.anchor||ha).add(1,1).scale(new oe(t,o).scale(-.5)),s=[new oe(0,0),new oe(t,0),new oe(t,o),new oe(0,o)];if(e.radius){let a=Math.min(t,o)/2,r=Array.isArray(e.radius)?e.radius.map(l=>Math.min(a,l)):new Array(4).fill(Math.min(a,e.radius));s=[new oe(r[0],0),...r[1]?Fs(new oe(t-r[1],r[1]),r[1],r[1],270,360):[J(t,0)],...r[2]?Fs(new oe(t-r[2],o-r[2]),r[2],r[2],0,90):[J(t,o)],...r[3]?Fs(new oe(r[3],o-r[3]),r[3],r[3],90,180):[J(0,o)],...r[0]?Fs(new oe(r[0],r[0]),r[0],r[0],180,270):[]]}Rn(Object.assign({},e,{offset:n,pts:s,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function Tn(e){Oo();let t=w.gfx.width,o=w.gfx.height;w.gfx.width=w.gfx.viewport.width,w.gfx.height=w.gfx.viewport.height,e(),Oo(),w.gfx.width=t,w.gfx.height=o}function Hc(e,t){Tn(()=>{let o=J(8);zo(),jt(e);let n=Wn({text:t,font:Gi,size:16,pos:o,color:Bt(255,255,255),fixed:!0}),s=n.width+o.x*2,a=n.height+o.x*2;e.x+s>=fo()&&jt(J(-s,0)),e.y+a>=go()&&jt(J(0,-a)),Ho({width:s,height:a,color:Bt(0,0,0),radius:4,opacity:.8,fixed:!0}),$n(n),Mo()})}function Id(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return Rn(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Yf(){if(w.debug.inspect){let e=null;for(let t of w.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(w.game.root.drawInspect(),e){let t=[],o=e.inspect();for(let n in o)o[n]?t.push(`${o[n]}`):t.push(`${n}`);Hc(F0(w.k.mousePos()),t.join(`
`))}Hc(J(8),`FPS: ${w.debug.fps()}`)}w.debug.paused&&Tn(()=>{zo(),jt(fo(),0),jt(-8,8);let e=32;Ho({width:e,height:e,anchor:"topright",color:Bt(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=1;t<=2;t++)Ho({width:4,height:e*.6,anchor:"center",pos:J(-e/3*t,e*.5),color:Bt(255,255,255),radius:2,fixed:!0});Mo()}),w.debug.timeScale!==1&&Tn(()=>{zo(),jt(fo(),go()),jt(-8,-8);let e=8,t=Wn({text:w.debug.timeScale.toFixed(1),font:Gi,size:16,color:Bt(255,255,255),pos:J(-e),anchor:"botright",fixed:!0});Ho({width:t.width+e*2+e*4,height:t.height+e*2,anchor:"botright",color:Bt(0,0,0),opacity:.8,radius:4,fixed:!0});for(let o=0;o<2;o++){let n=w.debug.timeScale<1;Id({p1:J(-t.width-e*(n?2:3.5),-e),p2:J(-t.width-e*(n?2:3.5),-e-t.height),p3:J(-t.width-e*(n?3.5:2),-e-t.height/2),pos:J(-o*e*1+(n?-e*.5:0),0),color:Bt(255,255,255),fixed:!0})}$n(t),Mo()}),w.debug.curRecording&&Tn(()=>{zo(),jt(0,go()),jt(24,-24),Ss({radius:12,color:Bt(255,0,0),opacity:Kl(0,1,w.app.time()*4),fixed:!0}),Mo()}),w.debug.showLog&&w.game.logs.length>0&&Tn(()=>{zo(),jt(0,go()),jt(8,-8);let e=8,t=[];for(let n of w.game.logs){let s="",a=n.msg instanceof Error?"error":"info";s+=`[time]${n.time.toFixed(2)}[/time]`,s+=" ",s+=`[${a}]${sr(n.msg)}[/${a}]`,t.push(s)}w.game.logs=w.game.logs.filter(n=>w.app.time()-n.time<(w.globalOpt.logTime||4));let o=Wn({text:t.join(`
`),font:Gi,pos:J(e,-e),anchor:"botleft",size:16,width:fo()*.6,lineSpacing:e/2,fixed:!0,styles:{time:{color:Bt(127,127,127)},info:{color:Bt(255,255,255)},error:{color:Bt(255,0,127)}}});Ho({width:o.width+e*2,height:o.height+e*2,anchor:"botleft",color:Bt(0,0,0),radius:4,opacity:.8,fixed:!0}),$n(o),Mo()})}function sr(e,t=!1,o=new Set){if(o.has(e))return"<recursive>";var n="",s;return t&&typeof e=="string"&&(e=JSON.stringify(e)),Array.isArray(e)&&(n=["[",e.map(a=>sr(a,!0,o.union(new Set([e])))).join(", "),"]"].join(""),e=n),e===null?"null":(typeof e=="object"&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(n+=e.constructor.name+" "),n+=["{",(s=Object.getOwnPropertyNames(e).map(a=>`${/^\w+$/.test(a)?a:JSON.stringify(a)}: ${sr(e[a],!0,o.union(new Set([e])))}`).join(", "))?` ${s} `:"","}"].join(""),e=n),String(e).replaceAll(new RegExp("(?<!\\\\)\\[","g"),"\\["))}function qf(){let e=w.game.cam,t=oe.fromAngle(ao(0,360)).scale(e.shake);e.shake=Do(e.shake,0,5*ro()),e.transform=new an().translate(Ki()).scale(e.scale).rotate(e.angle).translate((e.pos??Ki()).scale(-1).add(t)),w.game.root.draw(),Oo()}function Gf(){let e=Vn();w.game.events.numListeners("loading")>0?w.game.events.trigger("loading",e):Tn(()=>{let t=fo()/2,o=24,n=J(fo()/2,go()/2).sub(J(t/2,o/2));Ho({pos:J(0),width:fo(),height:go(),color:Bt(0,0,0)}),Ho({pos:n,width:t,height:o,fill:!1,outline:{width:4}}),Ho({pos:n,width:t*e,height:o})})}function Bd(e,t,o){let n=w.gfx.ggl.gl;Oo(),n.clear(n.STENCIL_BUFFER_BIT),n.enable(n.STENCIL_TEST),n.stencilFunc(n.NEVER,1,255),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),t(),Oo(),n.stencilFunc(o,1,255),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),e(),Oo(),n.disable(n.STENCIL_TEST)}function Kf(e,t){let o=w.gfx.ggl.gl;Bd(e,t,o.EQUAL)}function Wi(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new $t(0,0,1,1),o=e.tex.width*t.w,n=e.tex.height*t.h,s=new oe(1);if(e.tiled){let a=As(e.anchor||ha);(e.pos?.x||0)-(a.x+1)*.5*(e.width||o),(e.pos?.y||0)-(a.y+1)*.5*(e.height||n);let r=(e.width||o)/o,l=(e.height||n)/n,c=Math.floor(r),d=Math.floor(l),i=r-c,h=l-d,u=(c+i?1:0)*(d+h?1:0),g=new Array(u*6),p=new Array(u*4),D=0,m=(M,B,P,f,O)=>{g[D*6+0]=D*4+0,g[D*6+1]=D*4+1,g[D*6+2]=D*4+3,g[D*6+3]=D*4+1,g[D*6+4]=D*4+2,g[D*6+5]=D*4+3,p[D*4+0]={pos:new oe(M-a.x,B-a.y),uv:new oe(O.x,O.y),color:e.color||vt.WHITE,opacity:e.opacity||1},p[D*4+1]={pos:new oe(M+P-a.x,B-a.y),uv:new oe(O.x+O.w,O.y),color:e.color||vt.WHITE,opacity:e.opacity||1},p[D*4+2]={pos:new oe(M+P-a.x,B+f-a.y),uv:new oe(O.x+O.w,O.y+O.h),color:e.color||vt.WHITE,opacity:e.opacity||1},p[D*4+3]={pos:new oe(M-a.x,B+f-a.y),uv:new oe(O.x,O.y+O.h),color:e.color||vt.WHITE,opacity:e.opacity||1},D++};for(let M=0;M<d;M++){for(let B=0;B<c;B++)m(B*o,M*n,o,n,t);i&&m(c*o,M*n,o*i,n,new $t(t.x,t.y,t.w*i,t.h))}if(h){for(let M=0;M<c;M++)m(M*o,d*n,o,n*h,new $t(t.x,t.y,t.w,t.h*h));i&&m(c*o,d*n,o*i,n*h,new $t(t.x,t.y,t.w*i,t.h*h))}On(p,g,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(s.x=e.width/o,s.y=e.height/n):e.width?(s.x=e.width/o,s.y=s.x):e.height&&(s.y=e.height/n,s.x=s.y),si(Object.assign({},e,{scale:s.scale(e.scale||new oe(1)),tex:e.tex,quad:t,width:o,height:n}))}function Vf(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Oi(e.sprite);if(!t||!t.data)return;let o=t.data.frames[e.frame??0];if(!o)throw new Error(`Frame not found: ${e.frame??0}`);Wi(Object.assign({},e,{tex:t.data.tex,quad:o.scale(e.quad??new $t(0,0,1,1))}))}function Wf(e,t){let o=w.gfx.ggl.gl;Bd(e,t,o.NOTEQUAL)}function Uc(e){$n(Wn(e))}var $f=(e,t)=>{let o=_r(t,Za,Qa),n=e.pixelDensity??1,s=e.scale??1,{gl:a}=t,r=Pn.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new Vi(t,e.width*n*s,e.height*n*s):new Vi(t,a.drawingBufferWidth,a.drawingBufferHeight),c=null,d=1;e.background&&(typeof e.background=="string"?c=Bt(e.background):(c=Bt(...e.background),d=e.background[3]??1),a.clearColor(c.r/255,c.g/255,c.b/255,d??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let i=new Xf(t,zr,h0,u0),h=Pn.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:o,defTex:r,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:i,transform:new an,transformStack:[],bgTex:h,bgColor:c,bgAlpha:d,width:e.width??a.drawingBufferWidth/n/s,height:e.height??a.drawingBufferHeight/n/s,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}};function Yn(e){return e.fixed?!0:e.parent?Yn(e.parent):!1}function Jn(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Jf(e,t={}){return{id:"circle",radius:e,draw(){Ss(Object.assign(Jn(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new Ft(new oe(this.anchor?0:-this.radius),this.radius*2,this.radius*2)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Ld(...e){return{id:"color",color:Bt(...e),inspect(){return`color: ${this.color.toString()}`}}}function jf(e){return{add(){this.canvas=e}}}function Zf(e=1){let t,o=0,n=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){n||(o+=ro(),this.opacity=tn(o,0,e,0,t),o>=e&&(this.opacity=t,n=!0))}}}function Qf(e="intersect"){return{id:"mask",mask:e}}function zd(e){return{id:"opacity",opacity:e??1,fadeIn(t=1,o=w.k.easings.linear){return w.game.root.tween(0,this.opacity,t,n=>this.opacity=n,o)},fadeOut(t=1,o=w.k.easings.linear){return w.game.root.tween(this.opacity,0,t,n=>this.opacity=n,o)},inspect(){return`opacity: ${ka(this.opacity,1)}`}}}function kf(e=1,t=Bt(0,0,0),o=1,n="miter",s=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:o,join:n,miterLimit:s,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var ep=class{pos=J(0);vel=J(0);acc=J(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function tp(e,t){let o=t.lifetime,n=[],s=e.colors||[vt.WHITE],a=e.opacities||[1],r=e.quads||[new $t(0,0,1,1)],l=e.scales||[1],c=e.lifeTime,d=t.direction,i=t.spread,h=e.speed||[0,0],u=e.angle||[0,0],g=e.angularVelocity||[0,0],p=e.acceleration||[J(0),J(0)],D=e.damping||[0,0],m=[],M=new Array(e.max),B=0,P=0;for(let v=0;v<e.max;v++){m[v*6+0]=v*4+0,m[v*6+1]=v*4+1,m[v*6+2]=v*4+3,m[v*6+3]=v*4+1,m[v*6+4]=v*4+2,m[v*6+5]=v*4+3;for(let T=0;T<4;T++)M[v*4+T]={pos:new oe(0,0),uv:new oe(0,0),color:Bt(255,255,255),opacity:1};n[v]=new ep}let f=new vo;function O(v=0){for(;v<e.max;){if(n[v].gc)return v;v++}return null}return{id:"particles",emit(v){let T=0;for(let x=0;x<v;x++){if(T=O(T),T==null)return;let C=ao(d-i,d+i),S=oe.fromAngle(C).scale(ao(h[0],h[1])),z=ao(u[0],u[1]),L=ao(g[0],g[1]),N=J(ao(p[0].x,p[1].x),ao(p[0].y,p[1].y)),_=ao(D[0],D[1]),X=c?ao(c[0],c[1]):null,H=t.shape?t.shape.random():J(),R=n[T];R.lt=X,R.pos=H,R.vel=S,R.acc=N,R.angle=z,R.angularVelocity=L,R.damping=_,R.angularVelocity=L,R.gc=!1}B+=v},update(){if(o!==void 0&&o<=0)return;let v=ro();for(let T of n)if(!T.gc){if(T.t+=v,T.lt&&T.t>=T.lt){T.gc=!0,B--;continue}T.vel=T.vel.add(T.acc.scale(v)).scale(1-T.damping*v),T.pos=T.pos.add(T.vel.scale(v)),T.angle+=T.angularVelocity*v}for(o!==void 0&&(o-=v,o<=0&&f.trigger()),P+=v;B<e.max&&t.rate&&P>t.rate;)this.emit(1),B++,P-=t.rate},draw(){if(!(o!==void 0&&o<=0)){for(let v=0;v<n.length;v++){let T=n[v];if(T.gc)continue;let x=T.progress,C=Math.floor(T.progress*s.length),S=C<s.length-1?Do(s[C],s[C+1],tn(x,C/s.length,(C+1)/s.length,0,1)):s[C],z=Math.floor(T.progress*a.length),L=z<a.length-1?Do(a[z],a[z+1],tn(x,z/a.length,(z+1)/a.length,0,1)):a[z],N=Math.floor(T.progress*r.length),_=r[N],X=Math.floor(T.progress*l.length),H=l[X],R=Math.cos(T.angle*Math.PI/180),F=Math.sin(T.angle*Math.PI/180),G=(e.texture?e.texture.width:10)*_.w/2,Q=(e.texture?e.texture.height:10)*_.h/2,le=v*4,se=M[le];se.pos.x=T.pos.x+-G*H*R- -Q*H*F,se.pos.y=T.pos.y+-G*H*F+-Q*H*R,se.uv.x=_.x,se.uv.y=_.y,se.color.r=S.r,se.color.g=S.g,se.color.b=S.b,se.opacity=L,se=M[le+1],se.pos.x=T.pos.x+G*H*R- -Q*H*F,se.pos.y=T.pos.y+G*H*F+-Q*H*R,se.uv.x=_.x+_.w,se.uv.y=_.y,se.color.r=S.r,se.color.g=S.g,se.color.b=S.b,se.opacity=L,se=M[le+2],se.pos.x=T.pos.x+G*H*R-Q*H*F,se.pos.y=T.pos.y+G*H*F+Q*H*R,se.uv.x=_.x+_.w,se.uv.y=_.y+_.h,se.color.r=S.r,se.color.g=S.g,se.color.b=S.b,se.opacity=L,se=M[le+3],se.pos.x=T.pos.x+-G*H*R-Q*H*F,se.pos.y=T.pos.y+-G*H*F+Q*H*R,se.uv.x=_.x,se.uv.y=_.y+_.h,se.color.r=S.r,se.color.g=S.g,se.color.b=S.b,se.opacity=L}On(M,m,this.fixed,e.texture,this.shader,this.uniform)}},onEnd(v){return f.add(v)},inspect(){return`count: ${B}/${e.max}`}}}function op(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){Rn(Object.assign(Jn(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new Eo(this.pts)},inspect(){return`polygon: ${this.pts.map(o=>`[${o.x},${o.y}]`).join(",")}`}}}function Od(e,t,o){let n;return w.game.root.get("area").forEach(s=>{if(o&&o.some(r=>s.is(r)))return;let a=s.worldArea().raycast(e,t);a&&(n?a.fraction<n.fraction&&(n=a,n.object=s):(n=a,n.object=s))}),n}function Hd(e,t,o={}){return{id:"rect",width:e,height:t,radius:o.radius||0,draw(){Ho(Object.assign(Jn(this),{width:this.width,height:this.height,radius:this.radius,fill:o.fill}))},renderArea(){return new Ft(J(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function np(e,t){return{id:"shader",shader:e,...typeof t=="function"?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect(){return`shader: ${e}`}}}function sp(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let o=w.game.root.add([$i(t.pos??J(0))]),n=e.length,s=0,a=null,r=null,l=null,c=null,d=v=>v.x+v.y*s,i=v=>J(Math.floor(v%s),Math.floor(v/s)),h=()=>{a=[];for(let v of o.children)u(v)},u=v=>{let T=d(v.tilePos);a[T]?a[T].push(v):a[T]=[v]},g=v=>{let T=d(v.tilePos);if(a[T]){let x=a[T].indexOf(v);x>=0&&a[T].splice(x,1)}},p=()=>{let v=!1;for(let T of o.children){let x=o.pos2Tile(T.pos);(T.tilePos.x!=x.x||T.tilePos.y!=x.y)&&(v=!0,g(T),T.tilePos.x=x.x,T.tilePos.y=x.y,u(T))}v&&o.trigger("spatialMapChanged")},D=()=>{let v=o.getSpatialMap(),T=o.numRows()*o.numColumns();r?r.length=T:r=new Array(T),r.fill(1,0,T);for(let x=0;x<v.length;x++){let C=v[x];if(C){let S=0;for(let z of C)if(z.isObstacle){S=1/0;break}else S+=z.cost;r[x]=S||1}}},m=()=>{let v=o.getSpatialMap(),T=o.numRows()*o.numColumns();l?l.length=T:l=new Array(T),l.fill(15,0,T);for(let x=0;x<v.length;x++){let C=v[x];if(C){let S=C.length,z=15;for(let L=0;L<S;L++)z|=C[L].edgeMask;l[x]=z}}},M=()=>{let v=o.numRows()*o.numColumns(),T=(C,S)=>{let z=[];for(z.push(C);z.length>0;){let L=z.pop();f(L).forEach(N=>{c[N]<0&&(c[N]=S,z.push(N))})}};c?c.length=v:c=new Array(v),c.fill(-1,0,v);let x=0;for(let C=0;C<r.length;C++){if(c[C]>=0){x++;continue}T(C,x),x++}},B=(v,T)=>r[T],P=(v,T)=>{let x=i(v),C=i(T);return x.dist(C)},f=(v,T)=>{let x=[],C=Math.floor(v%s),S=C>0&&l[v]&1&&r[v-1]!==1/0,z=v>=s&&l[v]&2&&r[v-s]!==1/0,L=C<s-1&&l[v]&4&&r[v+1]!==1/0,N=v<s*n-s-1&&l[v]&8&&r[v+s]!==1/0;return T?(S&&(z&&x.push(v-s-1),x.push(v-1),N&&x.push(v+s-1)),z&&x.push(v-s),L&&(z&&x.push(v-s+1),x.push(v+1),N&&x.push(v+s+1)),N&&x.push(v+s)):(S&&x.push(v-1),z&&x.push(v-s),L&&x.push(v+1),N&&x.push(v+s)),x},O={id:"level",tileWidth(){return t.tileWidth},tileHeight(){return t.tileHeight},spawn(v,...T){let x=J(...T),C=(()=>{if(typeof v=="string"){if(t.tiles[v]){if(typeof t.tiles[v]!="function")throw new Error("Level symbol def must be a function returning a component list");return t.tiles[v](x)}else if(t.wildcardTile)return t.wildcardTile(v,x)}else{if(Array.isArray(v))return v;throw new Error("Expected a symbol or a component list")}})();if(!C)return null;let S=!1,z=!1;for(let N of C)N.id==="tile"&&(z=!0),N.id==="pos"&&(S=!0);S||C.push($i(this.tile2Pos(x))),z||C.push(eh());let L=o.add(C);return S&&(L.tilePosOffset=L.pos.clone()),L.tilePos=x,L.transform=Js(L),a&&(u(L),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),L},numColumns(){return s},numRows(){return n},levelWidth(){return s*this.tileWidth()},levelHeight(){return n*this.tileHeight()},tile2Pos(...v){return J(...v).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...v){let T=J(...v);return J(Math.floor(T.x/this.tileWidth()),Math.floor(T.y/this.tileHeight()))},getSpatialMap(){return a||h(),a},removeFromSpatialMap:g,insertIntoSpatialMap:u,onSpatialMapChanged(v){return this.on("spatialMapChanged",v)},onNavigationMapInvalid(v){return this.on("navigationMapInvalid",v)},getAt(v){a||h();let T=d(v);return a[T]||[]},raycast(v,T){let x=this.toWorld(v),C=this.toWorld(v.add(T)).sub(x),S=1/this.tileWidth(),z=v.scale(S),L=Nu(z,T,N=>{let _=this.getAt(N);if(_.some(H=>H.isObstacle))return!0;let X=null;for(let H of _)if(H.has("area")){let R=H.worldArea().raycast(x,C);R&&(X?R.fraction<X.fraction&&(X=R,X.object=H):(X=R,X.object=H))}return X&&(X.point=this.fromWorld(X.point).scale(S)),X||!1},64);return L&&(L.point=L.point.scale(this.tileWidth())),L},update(){a&&p()},invalidateNavigationMap(){r=null,l=null,c=null},onNavigationMapChanged(v){return this.on("navigationMapChanged",v)},getTilePath(v,T,x={}){if(r||D(),l||m(),c||M(),v.x<0||v.x>=s||v.y<0||v.y>=n||T.x<0||T.x>=s||T.y<0||T.y>=n)return null;let C=d(v),S=d(T);if(r[S]===1/0)return null;if(C===S)return[];if(c[C]!=-1&&c[C]!==c[S])return null;let z=new fd((R,F)=>R.cost<F.cost);z.insert({cost:0,node:C});let L=new Map;L.set(C,C);let N=new Map;for(N.set(C,0);z.length!==0;){let R=z.remove()?.node;if(R===S)break;let F=f(R,x.allowDiagonals);for(let G of F){let Q=(N.get(R)||0)+B(R,G)+P(G,S);(!N.has(G)||Q<N.get(G))&&(N.set(G,Q),z.insert({cost:Q,node:G}),L.set(G,R))}}let _=[],X=S,H=i(X);for(_.push(H);X!==C;){let R=L.get(X);if(R===void 0)throw new Error("Bug in pathfinding algorithm");X=R;let F=i(X);_.push(F)}return _.reverse()},getPath(v,T,x={}){let C=this.tileWidth(),S=this.tileHeight(),z=this.getTilePath(this.pos2Tile(v),this.pos2Tile(T),x);return z?[v,...z.slice(1,-1).map(L=>L.scale(C,S).add(C/2,S/2)),T]:null}};return o.use(O),o.onNavigationMapInvalid(()=>{o.invalidateNavigationMap(),o.trigger("navigationMapChanged")}),e.forEach((v,T)=>{let x=v.split("");s=Math.max(x.length,s),x.forEach((C,S)=>{o.spawn(C,J(S,T))})}),o}function Bo(e,t,o){return w.game.objEvents.registers[e]||(w.game.objEvents.registers[e]=new hd),w.game.objEvents.on(e,(n,...s)=>{n.is(t)&&o(n,...s)})}var ip=(e,t,...o)=>{for(let n of w.game.root.children)n.is(t)&&n.trigger(e,o)},ap=qt(e=>{let t=w.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Bo("fixedUpdate",e,t)),Ud=qt(e=>{let t=w.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(o){t.paused=o},cancel:()=>t.destroy()}},(e,t)=>Bo("update",e,t)),rp=qt(e=>{let t=w.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(o){t.hidden=o},cancel:()=>t.destroy()}},(e,t)=>Bo("draw",e,t)),Nd=qt(e=>w.game.events.on("add",e),(e,t)=>Bo("add",e,t)),cp=qt(e=>w.game.events.on("destroy",e),(e,t)=>Bo("destroy",e,t)),lp=qt(e=>w.game.events.on("use",e),(e,t)=>Bo("use",e,t)),dp=qt(e=>w.game.events.on("unuse",e),(e,t)=>Bo("unuse",e,t)),_d=qt(e=>w.game.events.on("tag",e),(e,t)=>Bo("tag",e,t)),hp=qt(e=>w.game.events.on("untag",e),(e,t)=>Bo("untag",e,t));function up(e,t,o){return Bo("collide",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function fp(e,t,o){return Bo("collideUpdate",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function pp(e,t,o){return Bo("collideEnd",e,(n,s,a)=>s.is(t)&&o(n,s,a))}function pa(e,t){w.game.root.get(e,{recursive:!0}).forEach(t),Nd(e,t),_d((o,n)=>{n===e&&t(o)})}var gp=qt(e=>w.app.onMousePress(e),(e,t)=>{let o=[];return pa(e,n=>{if(!n.area)throw new Error("onClick() requires the object to have area() component");o.push(n.onClick(()=>t(n)))}),es.join(o)});function mp(e,t){let o=[];return pa(e,n=>{if(!n.area)throw new Error("onHover() requires the object to have area() component");o.push(n.onHover(()=>t(n)))}),es.join(o)}function yp(e,t){let o=[];return pa(e,n=>{if(!n.area)throw new Error("onHoverUpdate() requires the object to have area() component");o.push(n.onHoverUpdate(()=>t(n)))}),es.join(o)}function xp(e,t){let o=[];return pa(e,n=>{if(!n.area)throw new Error("onHoverEnd() requires the object to have area() component");o.push(n.onHoverEnd(()=>t(n)))}),es.join(o)}function wp(e){w.game.events.on("loading",e)}function bp(e){w.app.onResize(e)}function vp(e){w.game.events.on("error",e)}function Fr(e){w.assets.loaded?e():w.game.events.on("load",e)}function Ep(e){if(w.assets.loaded)wd().forEach(t=>e(...t));else return w.game.events.on("loadError",e)}function Xd(...e){w.game.cam.pos=J(...e)}function Fd(){return w.game.cam.pos?w.game.cam.pos.clone():Ki()}function Yd(...e){w.game.cam.scale=J(...e)}function qd(){return w.game.cam.scale.clone()}function Gd(e){w.game.cam.angle=e}function Kd(){return w.game.cam.angle}function Ap(){return w.game.cam.transform.clone()}function Vd(e=Bt(255,255,255),t=1){let o=w.game.root.add([Hd(fo(),go()),Ld(e),zd(1),nh()]),n=o.fadeOut(t);return n.onEnd(()=>kd(o)),n}function Sp(){return w.game.cam.transform.clone()}function Mp(e=12){w.game.cam.shake+=e}function ir(e){return w.game.cam.transform.multVec2(e)}function Wd(e){return w.game.cam.transform.invert().multVec2(e)}function Tp(...e){return Es("camPos","setCamPos / getCamPos"),e.length>0&&Xd(...e),Fd()}function Dp(...e){return Es("camScale","setCamScale / getCamScale"),e.length>0&&Yd(...e),qd()}function Cp(e){return Es("camRot","setCamRot / getCamRot"),e!==void 0&&Gd(e),Kd()}function Rp(e=Bt(255,255,255),t=1){return Es("camFlash","flash"),Vd(e,t)}function Yr(e=[]){let t=new Map,o=[],n={},s=new ei,a=[],r=new Set("*"),l=w.globalOpt.tagsAsComponents,c=null,d=!1,i={id:_0(),hidden:!1,transform:new an,children:[],parent:null,set paused(u){if(u!==d){d=u;for(let g of a)g.paused=u}},get paused(){return d},get tags(){return Array.from(r)},add(u){let g=Array.isArray(u)?Yr(u):u;if(g.parent)throw new Error("Cannot add a game obj that already has a parent.");return g.parent=this,g.transform=Js(g),this.children.push(g),g.trigger("add",g),w.game.events.trigger("add",g),g},readd(u){let g=this.children.indexOf(u);return g!==-1&&(this.children.splice(g,1),this.children.push(u)),u},remove(u){let g=this.children.indexOf(u);if(g!==-1){u.parent=null,this.children.splice(g,1);let p=D=>{D.trigger("destroy"),w.game.events.trigger("destroy",D),D.children.forEach(m=>p(m))};p(u)}},removeAll(u){if(u)this.get(u).forEach(g=>this.remove(g));else for(let g of[...this.children])this.remove(g)},fixedUpdate(){this.paused||(this.children.forEach(u=>u.fixedUpdate()),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach(u=>u.update()),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(Oo(),this.canvas.bind());let u=w.gfx.fixed;this.fixed&&(w.gfx.fixed=!0),zo(),jt(this.pos),oi(this.scale),gs(this.angle);let g=this.children.sort((p,D)=>{let m=p.layerIndex??w.game.defaultLayerIndex,M=D.layerIndex??w.game.defaultLayerIndex;return m-M||(p.z??0)-(D.z??0)});if(this.mask){let p={intersect:w.k.drawMasked,subtract:w.k.drawSubtracted}[this.mask];if(!p)throw new Error(`Invalid mask func: "${this.mask}"`);p(()=>{g.forEach(D=>D.draw())},()=>{this.trigger("draw")})}else this.trigger("draw"),g.forEach(p=>p.draw());Mo(),w.gfx.fixed=u,this.canvas&&(Oo(),this.canvas.unbind())},drawInspect(){this.hidden||(zo(),jt(this.pos),oi(this.scale),gs(this.angle),this.children.forEach(u=>u.drawInspect()),this.trigger("drawInspect"),Mo())},use(u){if(typeof u=="string")return r.add(u);if(!u||typeof u!="object")throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof u}"`);let g=[];u.id?(this.unuse(u.id),n[u.id]=[],g=n[u.id],t.set(u.id,u),l&&r.add(u.id)):o.push(u);for(let D in u){if(g0.has(D))continue;let m=Object.getOwnPropertyDescriptor(u,D);if(m)if(typeof m.value=="function"&&(u[D]=u[D].bind(this)),m.set&&Object.defineProperty(u,D,{set:m.set.bind(this)}),m.get&&Object.defineProperty(u,D,{get:m.get.bind(this)}),m0.has(D)){let M=D==="add"?()=>{c=B=>g.push(B),u[D]?.(),c=null}:u[D];g.push(this.on(D,M).cancel)}else if(this[D]===void 0)Object.defineProperty(this,D,{get:()=>u[D],set:M=>u[D]=M,configurable:!0,enumerable:!0}),g.push(()=>delete this[D]);else{let M=t.values().find(B=>B[D]!==void 0)?.id;throw new Error(`Duplicate component property: "${D}" while adding component "${u.id}"`+(M?` (originally added by "${M}")`:""))}}let p=()=>{if(u.require){for(let D of u.require)if(!this.c(D))throw new Error(`Component "${u.id}" requires component "${D}"`)}};u.destroy&&g.push(u.destroy.bind(this)),this.exists()?(p(),u.add&&(c=D=>g.push(D),u.add.call(this),c=null),u.id&&(this.trigger("use",u.id),w.game.events.trigger("use",this,u.id))):u.require&&g.push(this.on("add",p).cancel)},unuse(u){if(t.has(u)){for(let g of t.values())if(g.require&&g.require.includes(u))throw new Error(`Can't unuse. Component "${g.id}" requires component "${u}"`);t.delete(u),this.trigger("unuse",u),w.game.events.trigger("unuse",this,u)}else l&&r.has(u)&&r.delete(u);n[u]&&(n[u].forEach(g=>g()),delete n[u])},c(u){return t.get(u)??null},get(u,g={}){let p=(m,M)=>g.only==="comps"?m.has(M):g.only==="tags"?m.is(M):m.is(M)||m.has(M),D=g.recursive?this.children.flatMap(function m(M){return[M,...M.children.flatMap(m)]}):this.children;if(D=D.filter(m=>u?p(m,u):!0),g.liveUpdate){let m=B=>g.recursive?this.isAncestorOf(B):B.parent===this,M=[];M.push(w.k.onAdd(B=>{m(B)&&p(B,u)&&D.push(B)})),M.push(w.k.onDestroy(B=>{if(m(B)&&p(B,u)){let P=D.findIndex(f=>f.id===B.id);P!==-1&&D.splice(P,1)}})),this.onDestroy(()=>{for(let B of M)B.cancel()})}return D},query(u){let g=u.hierarchy||"children",p=u.include,D=u.exclude,m=[];switch(g){case"children":m=this.children;break;case"siblings":m=this.parent?this.parent.children.filter(B=>B!==this):[];break;case"ancestors":let M=this.parent;for(;M;)m.push(M),M=M.parent;break;case"descendants":m=this.children.flatMap(function B(P){return[P,...P.children.flatMap(B)]});break}if(p&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(M=>M.is(p)):m=m.filter(M=>u.include.some(B=>M.is(B)))),D&&((u.includeOp||"and")==="and"||!Array.isArray(u.include)?m=m.filter(M=>!M.is(D)):m=m.filter(M=>!u.exclude.some(B=>M.is(B)))),u.visible===!0&&(m=m.filter(M=>M.visible)),u.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let M=u.distanceOp||"near",B=u.distance*u.distance;M==="near"?m=m.filter(P=>P.pos&&this.pos.sdist(P.pos)<=B):m=m.filter(P=>P.pos&&this.pos.sdist(P.pos)>B)}return u.name&&(m=m.filter(M=>M.name===u.name)),m},isAncestorOf(u){return u.parent?u.parent===this||this.isAncestorOf(u.parent):!1},exists(){return w.game.root.isAncestorOf(this)},is(u,g="and"){return Array.isArray(u)?g==="and"?u.every(p=>r.has(p)):u.some(p=>r.has(p)):r.has(u)},tag(u){if(Array.isArray(u))for(let g of u)r.add(g),this.trigger("tag",g),w.game.events.trigger("tag",this,g);else r.add(u),this.trigger("tag",u),w.game.events.trigger("tag",this,u)},untag(u){if(Array.isArray(u))for(let g of u)r.delete(g),this.trigger("untag",g),w.game.events.trigger("untag",this,g);else r.delete(u),this.trigger("untag",u),w.game.events.trigger("untag",this,u)},has(u,g="and"){return Array.isArray(u)?g==="and"?u.every(p=>t.has(p)):u.some(p=>t.has(p)):t.has(u)},on(u,g){let p=s.on(u,g.bind(this));return c&&c(()=>p.cancel()),p},trigger(u,...g){s.trigger(u,...g),w.game.objEvents.trigger(u,this,...g)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let u={};for(let[g,p]of t)u[g]=p.inspect?.()??null;for(let[g,p]of o.entries()){if(p.inspect){u[g]=p.inspect();continue}for(let[D,m]of Object.entries(p))typeof m!="function"&&(u[D]=`${D}: ${m}`)}return u},onAdd(u){return this.on("add",u)},onFixedUpdate(u){return this.on("fixedUpdate",u)},onUpdate(u){return this.on("update",u)},onDraw(u){return this.on("draw",u)},onDestroy(u){return this.on("destroy",u)},onUse(u){return this.on("use",u)},onUnuse(u){return this.on("unuse",u)},clearEvents(){s.clear()}},h=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let u of h)i[u]=(...g)=>{let p=w.app[u]?.(...g);return a.push(p),i.onDestroy(()=>p.cancel()),i.on("sceneEnter",()=>{a.splice(a.indexOf(p),1);let D=w.app[u]?.(...g);es.replace(p,D),a.push(p)}),p};for(let u of e)i.use(u);return i}var Pp=()=>({events:new ei,objEvents:new ei,root:Yr([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new oe(1),angle:0,shake:0,transform:new an}});function Ip(e){w.game.gravity=e?(w.game.gravity||J(0,1)).unit().scale(e):null}function Bp(){return w.game.gravity?w.game.gravity.len():0}function Lp(e){w.game.gravity=e.unit().scale(w.game.gravity?w.game.gravity.len():1)}function Zs(){return w.game.gravity?w.game.gravity.unit():J(0,1)}var zp=gu("//uUBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAATAAAeAAANDQ0NDRoaGhoaKCgoKCg1NTU1NTVDQ0NDQ1BQUFBQXl5eXl5ra2tra2t5eXl5eYaGhoaGlJSUlJShoaGhoaGvr6+vr7y8vLy8ysrKysrX19fX19fl5eXl5fLy8vLy//////8AAAA5TEFNRTMuMTAwAaoAAAAAAAAAABSAJAOPhgAAgAAAHgBaqIlmAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uUBAAP8h1kPIABR4BEDGeQAEbkSb2RAACBFMEyMiAAASJw4xjgwAGyRvfIoZT2QKGV5YNw/tKID9+X93qXtBQUFBQ/e+EFKTQUT/dy3f5dK/3d04rkXHpufCClDAaH7jDMgFAQEGfPt+jI352U9vU4GLRpzkUDeeeTQggQe2ggF3d7/3j697DnhCH5iGf38//iNj9oy2Jk71oj+CBAABGNB4RJNMwgCABCB//8//l////1z6XEGd73az07sOkwZD9VYgjzjmQ6j4EMfZM86OJ7GUWwvFw3ZPcdVEtczf9RNf6xMyxLjZZgjMQ7KDkLSU8g2E12UDUWrf//////9LdtFdeeqKwSitW9SJL59VM5pyUGiBNiK0jIGO0j7p3pUpWpaeqi1nTvqP3b43mGmM6HeXFjIlRwiFiIDQRRAGgkDQhxMMv//+f1//6XM/PfMvysJa3993MjDjhaRkrV3cRPXjGptDDGTHtFKUeMHU0K5STvVfMtVX/UXHctt1Z1//uUBB0AgnZkQAAgRTBMzIgAACiqCdB9E1QRgAFuIuGmhjABPZRJRCHi4etY2gcEYRwFw5KFBMMRV/////z6kX2ppnJszEzKbkZKEumm+pBRUDBg9IsgXGXrazn1QhmGjBrLVjT5Xvir0HT7d//HSZh18IZdji2N5JZgbA3DwQAahogSDqUhQuNtpJmBTwAGMY2QP3c/dy4EKsAABoXEJEFmlf/c4TgYtwcAbwfD4gOOoS1QIH7jDnNzYVe1x4mNFyD2jMVaaykjV29ePMARwXcUOgAFr+UjhVz4jhwMDFxPKgYs3cDFpohVgAAYAIO7u8eAAjRNA7hBFAwN3ACDvu7nETkLMrnyIj8v/9fNwhF9vKRfm82P5zPPmLV/WKs9G3d16n/v3rubEN0zgs7RdWrHne9brdv5bI4EwEAM6lj7aVdTKtXQHgLdzCKQ2kcihe4FyMcD1r3nR4TWxuax5EOZJEs3DEQnjyqyB8cSfrI6GEcoJxiHBDEfrTOFYrO1//uUBCgAA406ym5hgAB1R1ktzDwACxDBZzj0gAFhGrA3HoACypAXH9HY4umZan4ZlZKldajczMzMzOTnzMvnb77f/1IuSzHIbnJLJdapWmwUAQBXqWPtqV1OyqVqXhB9abR90OyKEsM51pIJK/nXplbDPtKz2dH+oVWeZSm8z7nvAZ19bneqhk3qeBhrhZiLbCc8sRnXb520RnPFd61/AgSR4f8CVlfWpD/////+N6/jv8v4f/6Ln///06c8YYcQIaGmAJ9VhMHEZYc9Kn0TOOYKv2cibDoZieAaGy4Cd6AfGkxQQr+agomAw+dC7AkjOxklIZEpUgmHxXP7/znl/4qT9Z/8+T2a0WF9/lvpv39if/KZnV6Gp1vQRmN1rYDAADfLGQxVR2d49LQLXdImm5n40smwjQ4aIYKMeKCOEw0OBV5cHA8cFV8mB5LyIIeksHspy79/iTv9SH+v66f2Wn/i+Lt//x9y//5MohgAAXiTCVBil4RUZ7XUvPRCD9Uc//uUBAoAAro3Wzc9AABXRutm56AACrUhc6eYT0FWpC508wnoO35hs9j6x7PQOB0PF0JWIkYwigNPoXUBA0cKA6JwDB7lRKDm/93r/mb6iEqL5lv3Vq//6YgYd1AgECi4xACCYbHyukYAAF4kwlQYpeEVGe11Lz0Qg/VHDt+YbPY+sez0DgdDxdCViJGMIoDT6F1AQNHCgOicAwe5USg5v/d6/5m+ohKi+Zb91av/+mIGHdQIBAouMQAgmGx8rptmoLKSACTuBBUPFsH6RlCz+UhoKeVfJy/eqOspBG4PScFOnOxYJJcf/nVzmyfR42Zwxy//hfSUrPq1SzFnO7q/SzNUzst+GQpnZ/kLwzVZ9xJ2lVa02zUFlJABJ3AgqHi2D9IyhZ/KQ0FPKvk5fvVHWUgjcHpOCnTnYsEkuP/zq5zZPo8bM4Y5f/wvpKVn1apZiznd1fpZmqZ2W/DIUzs/yF4Zqs+4k7SqtaYkWgEGMgppYQlMVdKcos2bWFZbFIJp//uUBAsAAr0wWe1hAABXpgs9rCAACwS5azj0gAFgly1nHpAAVgWmZa3LaUWCcGh5HgOEYkViyQUjrX+G5FUr5Dla1ZhtXDf7ckpazXwzeusqq+zXwUePSw8NYzlZKWfbyzod4dCRItAIMZBTSwhKYq6U5RZs2sKy2KQTSrAtMy1uW0osE4NDyPAcIxIrFkgpHWv8NyKpXyHK1qzDauG/25JS1mvhm9dZVV9mvgo8elh4axnKyUs+3lnQ7w6EkIEIIZFKlBSAGwRMrEIEuM658s5gvyVtFDrQtgTY2YSPlAJcgwlXLmokM8sUQJYJOm3eaW04jWVsoghX+ZBt3SHFZOypVez//VONpL+du6U+4WLXBC79cuhAhBDIpUoKQA2CJlYhAlxnXPlnMF+StoodaFsCbGzCR8oBLkGEq5c1EhnliiBLBJ027zS2nEaytlEEK/zINu6Q4rJ2VKr2f/6pxtJfzt3Sn3Cxa4IXfrl6IGEh4icUSUDRZk/k88VFEmCy//uUBAkAAociWgZh4ABQ5EtAzDwAC6zBXBmXgAF1mCuDMvAART7WmhWQ9QwYJexoKJ+z1bcQqfEFmtDtXH8lUg2omFi2b/4+UhW/j+bHgwAM8SqMAQFxYj9wqAwhlftf//sSQMJDxE4okoGizJ/J54qKJMFkin2tNCsh6hgwS9jQUT9nq24hU+ILNaHauP5KpBtRMLFs3/x8pCt/H82PBgAZ4lUYAgLixH7hUBhDK/a///YmHznKbibgJd0lEi0TfuHXCfhZ0faHA6GL3GuUpLTgTwnd/upcFAbo+BGMfzKxWE9PNg+sbrEwwRLn6uFElWTc/zN8Yvf5V3xV29///8OO/f7j3cT0mgMTPP9uPEwIQ+c5TcTcBLukokWib9w64T8LOj7Q4HQxe41ylJacCeE7v91LgoDdHwIxj+ZWKwnp5sH1jdYmGCJc/Vwokqybn+ZvjF7/Ku+Ku3v///hx37/ce7iek0BiZ5/tx4mBCmI5QXQAgigG+j0P8fdg2Xjs//uUBAiAAqwlWwY94ABVhKtgx7wACoilZ7z0AAFUlOz3noAAii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlGI5QXQAgigG+j0P8fdg2Xjsii2PkO1AMBYBIssJqQ5PtEdSQ2WE3xIF22b19axY89F5QQmWCwxJrf51h5mt74jRvBahCxQkS0MgJxY15ITjX3sb+vlEBsAgCSkHfwmFY/MMKQyg4tjhHeuR2mpSZWstSwEQAw00wZaogwgZL3PPVWw9vuB51zUXf3Df/ytV917DjxQEGA+0mbu4YYg4TnkRcMGQsxH/Ioc1AbAIAkpB38JhWPzDCkMoOLY4R3rkdpqUmVrLUsBEAMNNMGWqIMIGS9zz1VsPb7gedc1F39w3/8rVfdew48UQIFwus29HKDIAW8tcsSGAOKXK/jHmF1AkIAAC8ZUaEFwTHUylbannoarv7HwxH8//uUBAwEAtAx18sMQuBVJisaYSJeCmhnX6eZLQFZJy208wmidE7zXIRk0ZLYCqc1eg1sKc3HZuweFNeSCHHGg+JyhTcd8RE3/+rJXIdH6UpI2qUdVtHGRCOewEOXGUfKG2/v+RIoA0MAAAByh2gABL0EpLTwNTz0qzjM2ER8SF2lsSRLESGiqG5JXMCauo+aTB1GQKTyJd6SDnG6Iv8rkaoYeRihQbVGzJSSQ4sOghQh7vhkf+T0agMeCYAcAABBO40gsg/gOpfIiHoQgldEIGLVK9EaTFmFH9jkkvLA41VT/4q0XDJLUopJkJmWHAqZyRAPJOvBUS+NYSLC4FFjoJkUfGP/La3XNJCMJPep5CkIaRQCSTuM4ikUepPHAnZLEErtHuqs1EWDizBAvsdVeWBxqqn9aiS9FK24Z0KUhvVkY7ZbylKV/SrKiK0yrKqFkPe3/sZ//8xt6t2dajIDpFMRf6tSU9FIlJJKChTJIgq2hhZlrTlNcpaB/Xv5rDOU//uUBA2AAoQl1lVgwARQxLrKrBgAjCyVTrmngAGFkqnXNPAAg4ANdH9PKxIijn/xmvyjW2ZISnLe5yUtyv2ufSTfVJUGyoFiU6s6Crgyd2PEyn5Ul/85kUElPRSJSSSgoUySIKtoYWZa05TXKWgf17+awzlIOADXR/TxLEiKOf/GZ/KNbZkhKct7nJS3K/a59JN9UlQbKgWJTqzoKuDJ3Y8TKflSX/zmRQSCs10kCQCFAcBJCZCbl2c0bF5RBELfoQBmp3G2m3m3lgZoN0/BmhutukeGPbe/GtGj9jtiXNZdfDjIwYiYvnePS27ebO75y/Edksl4SONB/PlBrg6dNh8h+pW2//lktFhYcFZrpIEgEKA4CSEyE3Ls5o2LyiCIW/QgDNTuNtNvNvLAzQbp+DNDdbdI8Me29+NaNH7HbEuay6+HGRgxExfO8elt282d3zl+I7JZLwkcaD+fKDXB06bD5D9Stt//LJaLCw4AhAEAACKEywIJz0PRwTBn6tS2//uUBAmAAmUjVNdhAABMpGqa7CAACWiNUay8pYEtEao1l5SwsvqET9LUv/TIpAROYdsSHIoHxzccjRUPRZmVQnHLH7FYdB9rF8Q11yOCAKeHZHyIhMO///lWz0JPcAQgCAABFCZYEE56Ho4Jgz9WpbWX1CJ+lqX/pkUgInMO2JDkUD45uORoqHoszKoTjlj9isOg+1i+Ia65HBAFPDsj5EQmHf//yrZ6EnuACgcjEAKT2Dfl0wUuCCDwOHgDLjMYs6OLViO840e/fHfBZmadNu+NYYNVT84fPkYRCJ/K5V3vsq0Gh0H0YgBP+moubbodw+IHr/kgAoHIxACk9g35dMFLggg8Dh4Ay4zGLOji1YjvONHv3x3wWZmnTbvjWGDVU/OHz5GEQifyuVd77KtBodB9GIAT/pqLm26HcPiB6/5KAE6OeESRRgDMViF4jCI2bT5fbThs6iKGQfPTVaYtXdjMROEbiIqKlZk1KJAzpcWEnNs6FapfKXq1jerLEhaS//uUBB+BAmUqVWsMKrhMpUqtYYVXCTSlTzWSgAE0lKp2sFAAqcgRPyRHxKsBPAQVtIgCdHPCJIowBmKxC8RhEbNp8vtpw2dRFDIPnpqtMWruxmInCNxEVFSsyalEgZ0uLCTm2dCtUvlL1axvVliQtJVOQIn5Ij4lWAngIK2kQCHQhVnhkMD1BlLGveBt13z8bjbsI+MtfqdjdaAQiJFeBGV0AQFB2Qr8QDBc8iiATM25R8+fqp/Izn9CHGC7CEg5BTqd6jM4IBoADCiIYSTWAeAwKIoGBRr+EfZ3bjcbhhdDLX6nY3WgEIiRXgRloICoOyFfiA4+RRAJmbco+fP1U/kZz+hDjBdhCQcgp1O9QZnAQAbiCQAm485bonLdZ5NLqAAAEaPfiGAJsDpfUrAhC8wIZFkkEsiX6UBGvscp3FQfN5VNjWCnQ6AGqvk/UqZBbG3rpCt0gR7qtiNBxOfSeTupa6fMjXaMuYTclIn9ZIVayP2pYMiVUajtVYufukCu//uUBDWABAw9Uu5p4AKDx9qdzLwAiiyjShmngAFFlGlDNPAAm9bW7Vct6q61jNa/e6f/0cL33T31CoACacjUkabckdbjkoAAQ2Pe5fJoCshU+EXmCMRGkCbpN6UCNfKFHfcVB8kSOgSgDsuTAAtXyfqVMgtjb10hW6QI91XCQyZP85jl1K90+ZGuz5Ewl0gGT+skKsGAr0weA/JVRqO1Vi5+6QK6b1tbtFct6q61jNa+26fG/RwvfdPeIpm6BswQctcoCeIAYEYf1mWXRGbxQSwlUiCoY91ytUSo4mqDAgHrhQ3Y/4l2ptfeDG/xHfQXlda18S59aW+rZz8/Gtf7vXU0aFeJUKxkREA+tA5tnJGCDlrlATxADAjD+syy6IzeKCWEqkQVDHuuVqiVHE1QYEA9cKG7H/Eu1Nr7wY3+I76C8rrWviXPrS31bOfn41r/d66mjQrxKhWMiIgH1oHNs5Iw4nNwugqcGVUIoOnFryq5YBVMFyLPEAM4rxNXgSVW//uUBA+AAtkszwZtgABapZngzbAACxyZTzmkgAljkynnNJABzA8PYTFvx2VIR78NqPytscLolrRXGbLUv3rfHNp37BGU77n4xv9NNmu7larWfrk294JgJMNJQ9k6Z//3mHE5uF0FTgyqhFB04teVXLAKpguRZ4gBnFeJq8CSq2YHh7CYt+OypCPfhtR+VtjhdEtaK4zZal+9b45tO/YIynfc/GN/pps13crVaz9cm3vBMBJhpKLJ0z//vAA/m9Y8//8wALImAAl3wUQQSnfKuPXkDS5Ql5I8JfOufQG0twDlAxToCFKYarEoVqWFNJ6nNVd9fnX5/O72D/GEfeJf1TBIwjlyh7XHDg+dW/e///9oGG0YAH83rHn//mABZEwAEu+CiCCU75Vx68gaXKEvJHhL51z6A2luAcoGKdAQpTDVYlCtSwppPU5qrvr86/P53ewf4wj7xL+qYJGEcuUPa44cHzq373///tAw2joy5iMKijE5A82dFg4+liKoGBQF//uUBAmAAqobToZt4ABVI2nQzbwAClBrX7j0gBFKDWv3HpACuAcKpXhYKYZtV8OtethxIYxrF3onBiRVg0Z5VNJHjodV8sWdI031RiPzue4vQ9IA5zgUawg6s0J1ixM4H0rkVfR6DLmIwqKMTkDzZ0WDj6WIqgYFAW4BwqleFgphm1Xw6162HEhjGsXeicGJFWDRnlU2I8dDqvlizpGm+qMR+dz3F6HpAHOcCjWEHVmhOsWJnA+lcir6PQCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRCCI3I43G43HIxGIwIABFJObxBmwXEYYlhzHKcYl4ccyEKlyI6ONNnSpVx1pORjqKXEvGgpRqN/VI1tIQnEAogesbyZtJhhEj7rQutav+WB4ClRDWAElxIBP/fgA5BRsQaBJEcORBgUrqXzDOmyQ7B8Js0//uUBA+AAnIbz+9swABNA3nq7ZgACYxbKSxpgQEzi6UljTAh0ph0igLRRPKosl/+21oMFkUfTMlPbu5vLWMhsIpBoJlEBWacSYwqxs0adkSycpqwAugFfb4AMMU0BUCAJUc6VBAkwaXzDlPhDsnkNmmlMVAKAOiieBJHkv/22tBkzUfXZJ+37zy1jILgmkGjpRAVmnCVjCrGzRozkSydWoAAhAKsACEHAmDZAyOJvjXlQsCbLAhfALBGnDuUyMsKxSWoyN41Ma1yzl81ldaycS4FmOc/HeG0F0EouNMvOJY8wRknQ2MHFgo50O9wABCAVYAEIOBMGyBkcTfGvKhYE2WBC+AWCNOHcpkZYViktRkbxqY1rlnL5rK61k4lwLMc5+Od4vceyz2aZfD2t6Yf1T8VpbBUmvyf/6WSCIaFJmBQHBBPnChjBCJpALOEZzWEOoXAjEVcJwU6QNMnCQemw5lYr1wP4Yrd7Kh813KsJITdZtDZdO/Nb/EeIEOq6mn9//uUBCMMglwayou4eTBKg1lRdw8mCRxbKCzswxEuGGWdow2oj0ziXaKZIIhoUmYFAcEE+cKGMEImkAs4RnNYQ6hcCMRVwnBTpA0ycJB6bDmVivXA/hit3sqHzXcqwkhN1m0Nl0781v8R4gQ3qup/2PTcl2geDKLS0Dlz62OeezARhAXGxQHQWEYYrFAT3TZw4FCwS4JDTF8AkaliQVaJoBk2ZlkiTQ2GgZmiQ1TzBSo+AA7JnYoKkVD1ZLuX4AtuEAwAFeAsHNMiPlXBIxSunQZU2GQTJoCe6bOHAoWCXBIaYvkUWljkvhpGS5mWFUrqaky+ZUivDyLT+PkTH9Nf5Jc8MPCT5LS5agFKBGvwAEGuOYUBgViPhKwULrvceUN2EYE5cfjEPVa76oYHc8iajBh079LyeBx+8xsatjP5+f/v9moz085O0y92c1/TLeIQBc5iarAMAtQBhIDsHMLAswKiDlZBMLgFd7jyhuwXBjO4/GIeq131ERQsohipJqEF//uUBDuAAl4rSc1swABNpWkWriAAT6S1N7msABH4Fqa3NYACK3Y2lxKnyqWlj4I9evjntWStpWltoH3a1c9wPfBQe51tv4QIRW5JWpHY2wmAQCAA3Ez8JQ0wQP/M2RNaIDhCYutAAONBBkAlvb4j4+qi40CU4Bh3bhxXygTVd/7vSq0iY6iSWWXrsXQ29eVJCqUsoXWy7X/vdWvP1JZg/tBEovFId////7rne699onXkM9DUl/+GAZBQDf8JEQCKo//+ogQCRyuRRuRthMAgEABkJp6CMpiBP+aMybcYnwznWkEqoAuaC5GfvF8HZFWg/FXSa8blglIwmKgd/7XpVaYZFGTZZe5DuQPushJSpXIpuwbX/vdWvL6kswcmPQFF4Ef3////LXO917pQHTyGedqP//DAMgoD3/CREAiqP/2eqv////////3dk90KlpVV3eUWVjHLZSMUp5hxnpOcO1WpXVXu4ijKYTSd3IJ7Kzt6Wp7FWiGQUEGFRgdCgpRM//uUBB8P8lRjwIcAoABJLFgQ4BQASJmNAgAFHEkIsiAAAaegRMowxhYVZBMOCoAh7/////////79CTkvIITTqZkZjVGEMPHvEBE7IZXMpGVFYqsKyOYw5jjmOZkFDdkZLkW+9NjEIZxbiYixXO5QkcoRVQoYBgYPlK+XmRGbwXaEFZGvWIpZLWEizxltQ9uELQV7E73d3HESrONG7w3dTdpF6Skf/zNT3I6rIKxJy1oKCtGGjj5FDxcKB+HpYd/3//i3rZFOT0N05+QpgWZYZ3pi5biJNCj4fRQQwYK8p48BQUTWPDTbNjkPn8+1VXKvJ7dJ5Gb2mESWLjnHOYNH07r6//////////icK81KXqTXuvQEteLGdY0DKwrjQVTIMKbgE0b41Egi1KxtuNwUpf9X+bNqTUlXbDClWgIlS4wMVc1F0QZc3/N/yto/7eUShjGUstRgIUZXKUrFYwU5SgKOxgYE+krfVkf6St/VpnMaYwpwoCjoZwoCZwqFC4LH//uUBD+P4jNjPwAjN8I7THfwAEnqR8mAugCAcQkHsheEERr40LUwj//hIzL//9k/9rJZ9lks+yyVDL/////81YHZUMj//yZZLHIy7/5qwMHHIyZZL/sslQyNWt/I1DBQYRxPYaxS/////5kn///6on0VEVP/6on/7OVFVO5QwUGEOzyhgaoqKhQwMGCUjt////8qaLdr/qTiyzLxaJxpRTt6RBhIhDZMQU1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"),Op=()=>(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let o=new ni(sf(e));return e.decodeAudioData(zp.buffer.slice(0)).then(n=>{o.buf=n}).catch(n=>{console.error("Failed to load burp: ",n)}),{ctx:e,masterNode:t,burpSnd:o}})();function Hp(e,t={}){let o=new vo,n=new Audio(e);n.crossOrigin="anonymous",n.loop=!!t.loop,w.audio.ctx.createMediaElementSource(n).connect(w.audio.masterNode);function s(){w.debug.paused||w.app.isHidden()&&!w.globalOpt.backgroundAudio||w.audio.ctx.resume()}function a(){s(),n.play()}return t.paused||a(),n.onended=()=>o.trigger(),{play(){a()},seek(r){n.currentTime=r},stop(){n.pause(),this.seek(0)},set loop(r){n.loop=r},get loop(){return n.loop},set paused(r){r?n.pause():a()},get paused(){return n.paused},time(){return n.currentTime},duration(){return n.duration},set volume(r){n.volume=sn(r,0,1)},get volume(){return n.volume},set speed(r){n.playbackRate=Math.max(r,0)},get speed(){return n.playbackRate},set detune(r){},get detune(){return 0},onEnd(r){return o.add(r)},then(r){return this.onEnd(r)}}}function Up(e,t={}){if(typeof e=="string"&&w.assets.music[e])return Hp(w.assets.music[e],t);let o=w.audio.ctx,n=t.paused??!1,s=o.createBufferSource(),a=new vo,r=o.createGain(),l=o.createStereoPanner(),c=t.seek??0,d=0,i=0,h=!1;s.loop=!!t.loop,s.detune.value=t.detune??0,s.playbackRate.value=t.speed??1,s.connect(l),s.onended=()=>{p()>=(s.buffer?.duration??Number.POSITIVE_INFINITY)&&a.trigger()},l.pan.value=t.pan??0,l.connect(r),r.connect(w.audio.masterNode),r.gain.value=t.volume??1;let u=m=>{s.buffer=m.buf,n||(d=o.currentTime,s.start(0,c),h=!0)},g=Lf(e);g instanceof _o&&g.onLoad(u);let p=()=>{if(!s.buffer)return 0;let m=n?i-d:o.currentTime-d,M=s.buffer.duration;return s.loop?m%M:Math.min(m,M)},D=m=>{let M=o.createBufferSource();return M.buffer=m.buffer,M.loop=m.loop,M.playbackRate.value=m.playbackRate.value,M.detune.value=m.detune.value,M.onended=m.onended,M.connect(l),M};return{stop(){this.paused=!0,this.seek(0)},set paused(m){if(n!==m)if(n=m,m)h&&(s.stop(),h=!1),i=o.currentTime;else{s=D(s);let M=i-d;s.start(0,M),h=!0,d=o.currentTime-M,i=0}},get paused(){return n},play(m=0){this.seek(m),this.paused=!1},seek(m){s.buffer?.duration&&(m>s.buffer.duration||(n?(s=D(s),d=i-m):(s.stop(),s=D(s),d=o.currentTime-m,s.start(0,m),h=!0,i=0)))},set speed(m){s.playbackRate.value=m},get speed(){return s.playbackRate.value},set detune(m){s.detune.value=m},get detune(){return s.detune.value},set volume(m){r.gain.value=Math.max(m,0)},get volume(){return r.gain.value},set pan(m){l.pan.value=m},get pan(){return l.pan.value},set loop(m){s.loop=m},get loop(){return s.loop},duration(){return s.buffer?.duration??0},time(){return p()%this.duration()},onEnd(m){return a.add(m)},then(m){return this.onEnd(m)}}}function $d(e){return w.k.play(w.audio.burpSnd,e)}function Jd(e){w.audio.masterNode.gain.value=e}function jd(){return w.audio.masterNode.gain.value}function Np(e){return Es("volume","setVolume / getVolume"),e!==void 0&&Jd(e),jd()}function Zd(){w.app.onHide(()=>{w.globalOpt.backgroundAudio||w.audio.ctx.suspend()}),w.app.onShow(()=>{!w.globalOpt.backgroundAudio&&!w.debug.paused&&w.audio.ctx.resume()}),w.app.onResize(()=>{if(w.app.isFullscreen())return;let e=w.globalOpt.width&&w.globalOpt.height;e&&!w.globalOpt.stretch&&!w.globalOpt.letterbox||(w.canvas.width=w.canvas.offsetWidth*w.pixelDensity,w.canvas.height=w.canvas.offsetHeight*w.pixelDensity,md(),e||(w.gfx.frameBuffer.free(),w.gfx.frameBuffer=new Vi(w.gfx.ggl,w.gfx.ggl.gl.drawingBufferWidth,w.gfx.ggl.gl.drawingBufferHeight),w.gfx.width=w.gfx.ggl.gl.drawingBufferWidth/w.pixelDensity/w.gscale,w.gfx.height=w.gfx.ggl.gl.drawingBufferHeight/w.pixelDensity/w.gscale))}),w.globalOpt.debug!==!1&&(w.app.onKeyPress(w.globalOpt.debugKey??"f1",()=>w.debug.inspect=!w.debug.inspect),w.app.onKeyPress("f2",()=>w.debug.clearLog()),w.app.onKeyPress("f8",()=>w.debug.paused=!w.debug.paused),w.app.onKeyPress("f7",()=>{w.debug.timeScale=ka(sn(w.debug.timeScale-.2,0,2),1)}),w.app.onKeyPress("f9",()=>{w.debug.timeScale=ka(sn(w.debug.timeScale+.2,0,2),1)}),w.app.onKeyPress("f10",()=>w.debug.stepFrame())),w.globalOpt.burp&&w.app.onKeyPress("b",()=>$d())}function _p(e,t={}){let o=w.game.root.add([$i(e),oh()]),n=(t.speed||1)*5,s=t.scale||1;o.add([ar(w.boomSprite),Ji(0),lr("center"),_c(n,s),...t.comps??[]]);let a=o.add([ar(w.kaSprite),Ji(0),lr("center"),rr(),...t.comps??[]]);return a.wait(.4/n,()=>a.use(_c(n,s))),a.onDestroy(()=>o.destroy()),o}function Qd(e,t){if(w.game.layers)throw Error("Layers can only be assigned once.");let o=e.indexOf(t);if(o==-1)throw Error("The default layer name should be present in the layers list.");w.game.layers=e,w.game.defaultLayerIndex=o}function Xp(){return w.game.layers}function Fp(){return w.game.layers?.[w.game.defaultLayerIndex]??null}function Yp(e,t){Es("layers","setLayers"),Qd(e,t)}function kd(e){e.destroy()}function qp(){return w.game.root}function Gp(e,t){w.game.scenes[e]=t}function Kp(e,...t){if(!w.game.scenes[e])throw new Error(`Scene not found: ${e}`);w.game.events.onOnce("frameEnd",()=>{w.game.events.trigger("sceneLeave",e),w.app.events.clear(),w.game.events.clear(),w.game.objEvents.clear(),[...w.game.root.children].forEach(o=>{!o.stay||o.scenesToStay&&!o.scenesToStay.includes(e)?w.game.root.remove(o):o.trigger("sceneEnter",e)}),w.game.root.clearEvents(),Zd(),w.game.cam={pos:null,scale:J(1),angle:0,shake:0,transform:new an},w.game.scenes[e](...t)}),w.game.currentScene=e}function Vp(e){return w.game.events.on("sceneLeave",e)}function Wp(){return w.game.currentScene}function ar(e,t={}){let o=null,n=null,s=null,a=new vo;if(!e)throw new Error("Please pass the resource name or data to sprite()");let r=(d,i,h,u)=>{let g=J(1,1);return h&&u?(g.x=h/(d.width*i.w),g.y=u/(d.height*i.h)):h?(g.x=h/(d.width*i.w),g.y=g.x):u&&(g.y=u/(d.height*i.h),g.x=g.y),g},l=(d,i)=>{if(!i)return;let h=i.frames[0].clone();t.quad&&(h=h.scale(t.quad));let u=r(i.tex,h,t.width,t.height);if(d.width=i.tex.width*h.w*u.x,d.height=i.tex.height*h.h*u.y,i.anims)for(let g in i.anims){let p=i.anims[g];typeof p!="number"&&(p.frames=c(p))}o=i,a.trigger(o),t.anim&&d.play(t.anim)},c=d=>{if(d.frames)return d.frames;let i=[];if(d.from===void 0||d.to===void 0)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let h=Math.abs(d.to-d.from)+1;for(let u=0;u<h;u++)i.push(d.from+u*Math.sign(d.to-d.from));if(d.pingpong)for(let u=h-2;u>0;u--)i.push(i[u]);return i};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new $t(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(d){let i=Oi(d);i&&i.onLoad(h=>l(this,h))},get animFrame(){if(!o||!n||s===null)return this.frame;let d=o.anims[n.name];return typeof d=="number"?d:d.from===void 0||d.to===void 0?n.frameIndex:this.frame-Math.min(d.from,d.to)},draw(){if(!o)return;let d=o.frames[this.frame??0];if(!d)throw new Error(`Frame not found: ${this.frame??0}`);if(o.slice9){let{left:i,right:h,top:u,bottom:g}=o.slice9,p=o.tex.width*d.w,D=o.tex.height*d.h,m=this.width-i-h,M=this.height-u-g,B=i/p,P=h/p,f=1-B-P,O=u/D,v=g/D,T=1-O-v,x=[kt(0,0,B,O),kt(B,0,f,O),kt(B+f,0,P,O),kt(0,O,B,T),kt(B,O,f,T),kt(B+f,O,P,T),kt(0,O+T,B,v),kt(B,O+T,f,v),kt(B+f,O+T,P,v),kt(0,0,i,u),kt(i,0,m,u),kt(i+m,0,h,u),kt(0,u,i,M),kt(i,u,m,M),kt(i+m,u,h,M),kt(0,u+M,i,g),kt(i,u+M,m,g),kt(i+m,u+M,h,g)];for(let C=0;C<9;C++){let S=x[C],z=x[C+9];Wi(Object.assign(Jn(this),{pos:z.pos(),tex:o.tex,quad:d.scale(S),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:z.w,height:z.h}))}}else Wi(Object.assign(Jn(this),{tex:o.tex,quad:d.scale(this.quad??new $t(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let d=Oi(e);d?d.onLoad(i=>l(this,i)):Fr(()=>l(this,Oi(e).data))},update(){if(!o||!n||s===null)return;let d=o.anims[n.name];if(typeof d=="number"){this.frame=d;return}if(d.speed===0)throw new Error("Sprite anim speed cannot be 0");if(n.timer+=ro()*this.animSpeed,n.timer>=1/n.speed){n.timer=0,n.frameIndex+=s;let i=d.frames;if(n.frameIndex>=i.length)if(n.pingpong&&!d.pingpong)s=-1,n.frameIndex=i.length-2;else if(n.loop)n.frameIndex=0;else{this.frame=i.at(-1),n.onEnd(),this.stop();return}else if(n.frameIndex<0)if(n.pingpong&&n.loop)s=1,n.frameIndex=1;else if(n.loop)n.frameIndex=i.length-1;else{this.frame=i[0],n.onEnd(),this.stop();return}this.frame=i[n.frameIndex]}},play(d,i={}){if(!o){a.add(()=>this.play(d,i));return}let h=o.anims[d];if(h===void 0)throw new Error(`Anim not found: ${d}`);n&&this.stop(),n=typeof h=="number"?{name:d,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:d,timer:0,loop:i.loop??h.loop??!1,pingpong:i.pingpong??h.pingpong??!1,speed:i.speed??h.speed??10,frameIndex:0,onEnd:i.onEnd??(()=>{})},s=typeof h=="number"?null:1,this.frame=typeof h=="number"?h:h.frames[0],this.trigger("animStart",d)},stop(){if(!n)return;let d=n.name;n=null,this.trigger("animEnd",d)},numFrames(){return o?.frames.length??0},getCurAnim(){return n},curAnim(){return n?.name},getAnim(d){return o?.anims[d]??null},hasAnim(d){return!!this.getAnim(d)},onAnimEnd(d){return this.on("animEnd",d)},onAnimStart(d){return this.on("animStart",d)},renderArea(){return new Ft(J(0),this.width,this.height)},inspect(){return typeof e=="string"?`sprite: "${e}"`:null}}}function $p(e,t={}){function o(s){let a=Wn(Object.assign(Jn(s),{text:s.text+"",size:s.textSize,font:s.font,width:t.width&&s.width,align:s.align,letterSpacing:s.letterSpacing,lineSpacing:s.lineSpacing,transform:s.textTransform,styles:s.textStyles,indentAll:t.indentAll}));return t.width||(s.width=a.width/(s.scale?.x||1)),s.height=a.height/(s.scale?.y||1),a}let n={id:"text",set text(s){e=s,o(this),this.renderedText=nr(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?nr(e).text:"",add(){Fr(()=>o(this))},draw(){$n(o(this))},renderArea(){return new Ft(J(0),this.width,this.height)}};return o(n),n}function Jp(e,t){return{id:"rect",width:e,height:t,draw(){si(Object.assign(Jn(this),{width:this.width,height:this.height}))},renderArea(){return new Ft(J(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function jp(e={}){let t=null,o=null,n=null,s=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation(){return o&&n?o[n]:null},getPath(){return o?o.slice():null},getTarget(){return t},isNavigationFinished(){return o?n===null:!0},isTargetReachable(){return o!==null},isTargetReached(){return t?this.pos.eq(t):!0},setTarget(a){t=a,o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n=o?0:null,o&&n!==null?(s||(s=this.getLevel().onNavigationMapChanged(()=>{t&&o&&n!==null&&(o=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),o?(n=0,this.trigger("navigationNext",this,o[n])):(n=null,this.trigger("navigationEnded",this)))}),this.onDestroy(()=>s?.cancel())),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,o[n])):this.trigger("navigationEnded",this)},update(){if(t&&o&&n!==null){if(this.pos.sdist(o[n])<2)if(n===o.length-1){this.pos=t.clone(),n=null,this.trigger("navigationEnded",this),this.trigger("targetReached",this);return}else n++,this.trigger("navigationNext",this,o[n]);this.moveTo(o[n],this.agentSpeed)}},onNavigationStarted(a){return this.on("navigationStarted",a)},onNavigationNext(a){return this.on("navigationNext",a)},onNavigationEnded(a){return this.on("navigationEnded",a)},onTargetReached(a){return this.on("targetReached",a)},inspect(){return"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(o)})}}}function Zp(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(o){return this.graph?.getWaypointPath(this.pos,o,e.navigationOpt)},get graph(){if(t)return t;let o=this.parent;for(;o;){if(o.has("pathfinderMap"))return o.graph;o=o.parent}},set graph(o){t=o}}}function Qp(e={}){let t=e.waypoints,o=e.speed||100,n=e.endBehavior||"stop",s=0,a=t!=null;return{id:"patrol",require:["pos"],get patrolSpeed(){return o},set patrolSpeed(r){o=r},get waypoints(){return t},set waypoints(r){t=r,s=0,a=!1},get nextLocation(){return t?t[s]:void 0},update(){let r=this.nextLocation;if(!(!t||!r||a)&&(this.moveTo(r,o),this.pos.sdist(r)<9))switch(n){case"loop":s=(s+1)%t.length;break;case"ping-pong":s=s+1,s==t.length&&(t.reverse(),s=0);break;case"stop":s<t.length-1?s+=1:a||(a=!0,this.trigger("patrolFinished",this));break}},onPatrolFinished(r){return this.on("patrolFinished",r)}}}function kp(e,t={}){let o=typeof e=="function"?e:()=>w.game.root.query(e),n=t.checkFrequency||1,s=typeof t.direction=="number"?oe.fromAngle(t.direction):t.direction,a=0;return{id:"sentry",require:["pos"],direction:typeof t.direction=="number"?oe.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(r){this.direction=r!==void 0?oe.fromAngle(r):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(r,l,c){let d=(typeof l=="number"?oe.fromAngle(l):l)||s,i=c||t.fieldOfView;if(!d||!i||i>=360)return!0;let h=i/2;return r.pos&&d.angleBetween(r.pos.sub(this.pos))<=h},hasLineOfSight(r){let l=Od(this.pos,r.pos.sub(this.pos),t.raycastExclude);return l!=null&&l.object===r},update(){if(a+=ro(),a>n){a-=n;let r=o();if(r.length&&s&&this.fieldOfView&&this.fieldOfView<360){let l=this.fieldOfView/2;r=r.filter(c=>c.pos&&s.angleBetween(c.pos.sub(this.pos))<=l)}r.length&&t.lineOfSight&&(r=r.filter(l=>l.pos&&this.hasLineOfSight(l))),r.length>0&&(this.spotted=r,this.trigger("objectSpotted",r))}},onObjectsSpotted(r){return this.on("objectSpotted",r)}}}function eh(e={}){let t=J(0),o=e.isObstacle??!1,n=e.cost??0,s=e.edges??[],a=()=>{let l={left:1,top:2,right:4,bottom:8};return s.map(c=>l[c]||0).reduce((c,d)=>c|d,0)},r=a();return{id:"tile",tilePosOffset:e.offset??J(0),set tilePos(l){let c=this.getLevel();t=l.clone(),this.pos=J(this.tilePos.x*c.tileWidth(),this.tilePos.y*c.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(l){o!==l&&(o=l,this.getLevel().invalidateNavigationMap())},get isObstacle(){return o},set cost(l){n!==l&&(n=l,this.getLevel().invalidateNavigationMap())},get cost(){return n},set edges(l){s=l,r=a(),this.getLevel().invalidateNavigationMap()},get edges(){return s},get edgeMask(){return r},getLevel(){return this.parent},tileMove(l){let c=this.getLevel();c.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(l),c.insertIntoSpatialMap(this),c.trigger("spatialMapChanged")},moveLeft(){this.tileMove(J(-1,0))},moveRight(){this.tileMove(J(1,0))},moveUp(){this.tileMove(J(0,-1))},moveDown(){this.tileMove(J(0,1))}}}var qr=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,o){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||ti.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=o}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,o){let n=t-1,s=e/this.duration;if(this.loops!==0&&s>=this.loops)return[n,0,!0];let a=Math.trunc(s);if(s-=a,(this.direction=="reverse"||this.direction=="ping-pong"&&a&1)&&(s=1-s),o){let r=0;for(;o[r+1]!==void 0&&o[r+1]<s;)r++;return r>=n?[n,0,!0]:[r,(s-o[r])/(o[r+1]-o[r]),!1]}else{let r=Math.floor((t-1)*s);return[r,(s-r/n)*n,!1]}}setValue(e,t,o){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(o);break;case"angle":e.angle=e.base.angle+o;break;case"scale":e.scale=e.base.scale.scale(o);break;case"opacity":e.opacity=e.base.opacity*o;break;default:e[t]=o}else e[t]=o}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),this.direction!=="forward"&&(e.direction=this.direction),this.easing!=ti.linear&&(e.easing=this.easing.name),this.interpolation!=="linear"&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map(t=>this.easing.name)),e}};function Nc(e,t){return t.add(t.sub(e))}var eg=class extends qr{keys;constructor(e,t,o,n){super(e,o,n),this.keys=t}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;this.setValue(e,this.name,Do(this.keys[o],this.keys[o+1],a(n)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},tg=class extends qr{keys;curves;dcurves;constructor(e,t,o,n,s){if(super(e,o,n),this.keys=t,this.interpolation==="spline"){this.curves=[],s&&(this.dcurves=[]);for(let a=0;a<this.keys.length-1;a++){let r=this.keys[a],l=a+1,c=this.keys[l],d=a>0?this.keys[a-1]:Nc(c,r),i=l<this.keys.length-1?this.keys[l+1]:Nc(r,c);this.curves.push(qi(d,r,c,i)),s&&this.dcurves?.push(qi(d,r,c,i,Zu))}}}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation==="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[o].lerp(this.keys[o+1],a(n)));break;case"slerp":this.setValue(e,this.name,this.keys[o].slerp(this.keys[o+1],a(n)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[o](a(n))),this.dcurves&&this.setValue(e,"angle",this.dcurves[o](a(n)).angle());break}}}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map(e=>[e.x,e.y])})}},og=class extends qr{keys;constructor(e,t,o,n){super(e,o,n),this.keys=t}update(e,t){let[o,n,s]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(n==0||this.interpolation=="none")this.setValue(e,this.name,this.keys[o]);else{let a=this.easings?this.easings[o]:this.easing;this.setValue(e,this.name,this.keys[o].lerp(this.keys[o+1],a(n)))}return s}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function ng(e={}){let t=[],o=0,n=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:J(0,0),angle:0,scale:J(1,1),opacity:1},animation:{paused:!1,seek(s){o=sn(s,0,this.duration),t.forEach(a=>{a.isFinished=!1}),n=!1},get duration(){return t.reduce((s,a)=>Math.max(a.duration,s),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let s=!0,a;o+=ro();for(let r of t)a=r.update(this,o),a&&!r.isFinished&&(r.isFinished=!0,this.trigger("animateChannelFinished",r.name)),s&&=a;s&&!n&&(n=!0,this.trigger("animateFinished"))},animate(s,a,r){n=!1,this.unanimate(s),typeof a[0]=="number"?t.push(new eg(s,a,r,e.relative||!1)):a[0]instanceof oe?t.push(new tg(s,a,r,e.relative||!1,s==="pos"&&(e.followMotion||!1))):a[0]instanceof vt&&t.push(new og(s,a,r,e.relative||!1))},unanimate(s){let a=t.findIndex(r=>r.name===s);a>=0&&t.splice(a,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(s){return this.on("animateFinished",s)},onAnimateChannelFinished(s){return this.on("animateChannelFinished",s)},serializeAnimationChannels(){return t.reduce((s,a)=>(s[a.name]=a.serialize(),s),{})},serializeAnimationOptions(){let s={};return e.followMotion&&(s.followMotion=!0),e.relative&&(s.relative=!0),s}}}function th(e,t){let o={name:e.name};return e.has("animate")&&(o.channels=e.serializeAnimationChannels(),Object.assign(o,e.serializeAnimationOptions())),e.children.length>0&&(o.children=e.children.filter(n=>n.has("named")).map(n=>th(n,n.name))),o}function _c(e=2,t=1){let o=0;return{require:["scale"],update(){let n=Math.sin(o*e)*t;n<0&&this.destroy(),this.scale=J(n),o+=ro()}}}function sg(e,t){if(e==null)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(o=1){this.setHP(e-o),this.trigger("hurt",o)},heal(o=1){let n=e;this.setHP(e+o),this.trigger("heal",e-n)},hp(){return e},maxHP(){return t??null},setMaxHP(o){t=o},setHP(o){e=t?Math.min(t,o):o,e<=0&&this.trigger("death")},onHurt(o){return this.on("hurt",o)},onHeal(o){return this.on("heal",o)},onDeath(o){return this.on("death",o)},inspect(){return`health: ${e}`}}}function ig(e,t={}){if(e==null)throw new Error("lifespan() requires time");let o=t.fade??0;return{id:"lifespan",require:["opacity"],add(){w.game.root.wait(e,()=>{this.opacity=this.opacity??1,o>0?w.game.root.tween(this.opacity,0,o,n=>this.opacity=n,ti.linear).onEnd(()=>{this.destroy()}):this.destroy()})}}}function ag(e){return{id:"named",name:e}}function rg(e,t,o){if(!e)throw new Error("state() requires an initial state");let n={};function s(c){n[c]||(n[c]={enter:new vo,end:new vo,update:new vo,draw:new vo})}function a(c,d,i){return s(d),n[d][c].add(i)}function r(c,d,...i){s(d),n[d][c].trigger(...i)}let l=!1;return{id:"state",state:e,enterState(c,...d){if(l=!0,t&&!t.includes(c))throw new Error(`State not found: ${c}`);let i=this.state;if(o){if(!o?.[i])return;let h=typeof o[i]=="string"?[o[i]]:o[i];if(!h.includes(c))throw new Error(`Cannot transition state from "${i}" to "${c}". Available transitions: ${h.map(u=>`"${u}"`).join(", ")}`)}r("end",i,...d),this.state=c,r("enter",c,...d),r("enter",`${i} -> ${c}`,...d)},onStateTransition(c,d,i){return a("enter",`${c} -> ${d}`,i)},onStateEnter(c,d){return a("enter",c,d)},onStateUpdate(c,d){return a("update",c,d)},onStateDraw(c,d){return a("draw",c,d)},onStateEnd(c,d){return a("end",c,d)},update(){l||(r("enter",e),l=!0),r("update",this.state)},draw(){r("draw",this.state)},inspect(){return`state: ${this.state}`}}}function oh(e){return{id:"stay",stay:!0,scenesToStay:e}}function cg(e=!0,t){let o,n;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let s=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};o=w.k.onCharInput(a=>{this.hasFocus&&(!t||this.typedText.length<t)&&(w.k.isKeyDown("shift")?this.typedText+=a.toUpperCase():this.typedText+=a,s())}),n=w.k.onKeyPressRepeat("backspace",()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1),s())})},destroy(){o.cancel(),n.cancel()}}}function rr(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(t,o,n=1/0,s=!1){let a=s?0:t,r=new vo,l=this.onUpdate(()=>{a+=w.app.state.dt;for(let c=0;a>=t&&c<this.maxLoopsPerFrame;c++)if(n--,o(),a-=t,n<=0){l.cancel(),r.trigger();return}});return{get paused(){return l.paused},set paused(c){l.paused=c},cancel:l.cancel,onEnd(c){r.add(c)},then(c){return r.add(c),this}}},wait(t,o){return this.loop(t,o??(()=>{}),1,!0)},tween(t,o,n,s,a=ti.linear){let r=0,l=[],c=this.onUpdate(()=>{r+=w.app.state.dt;let d=Math.min(r/n,1);s(Do(t,o,a(d))),d===1&&(c.cancel(),s(o),l.forEach(i=>i()))});return{get paused(){return c.paused},set paused(d){c.paused=d},onEnd(d){l.push(d)},then(d){return this.onEnd(d),this},cancel(){c.cancel()},finish(){c.cancel(),s(o),l.forEach(d=>d())}}}}}var cr=0;function lg(){return cr>0}function dg(e={}){let t={},o=new Set,n=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){cr++,this.area.cursor&&n.push(this.onHover(()=>w.app.setCursor(this.area.cursor))),n.push(this.onCollideUpdate((s,a)=>{if(!s.id)throw new Error("area() requires the object to have an id");t[s.id]||this.trigger("collide",s,a),a&&(t[s.id]=a,o.add(s.id))}))},destroy(){cr--;for(let s of n)s.cancel()},fixedUpdate(){for(let s in t)o.has(Number(s))||(this.trigger("collideEnd",t[s].target),delete t[s]);o.clear()},drawInspect(){let s=this.localArea();zo(),jt(this.area.offset);let a={outline:{width:4/yd(),color:Bt(0,0,255)},anchor:this.anchor,fill:!1,fixed:Yn(this)};s instanceof Ft?Ho({...a,pos:s.pos,width:s.width*this.area.scale.x,height:s.height*this.area.scale.y}):s instanceof Eo?Rn({...a,pts:s.pts,scale:this.area.scale}):s instanceof Po&&Ss({...a,pos:s.center,radius:s.radius}),Mo()},area:{shape:e.shape??null,scale:e.scale?J(e.scale):J(1),offset:e.offset??J(0),cursor:e.cursor??null},isClicked(){return w.app.isMousePressed()&&this.isHovering()},isHovering(){let s=Yn(this)?w.k.mousePos():w.k.toWorld(w.k.mousePos());return this.hasPoint(s)},checkCollision(s){if(!s.id)throw new Error("checkCollision() requires the object to have an id");return t[s.id]??null},getCollisions(){return Object.values(t)},isColliding(s){if(!s.id)throw new Error("isColliding() requires the object to have an id");return!!t[s.id]},isOverlapping(s){if(!s.id)throw new Error("isOverlapping() requires the object to have an id");let a=t[s.id];return a&&a.hasOverlap()},onClick(s,a="left"){let r=this.onMousePress(a,()=>{this.isHovering()&&s()});return n.push(r),r},onHover(s){let a=!1;return this.onUpdate(()=>{a?a=this.isHovering():this.isHovering()&&(a=!0,s())})},onHoverUpdate(s){return this.onUpdate(()=>{this.isHovering()&&s()})},onHoverEnd(s){let a=!1;return this.onUpdate(()=>{a?this.isHovering()||(a=!1,s()):a=this.isHovering()})},onCollide(s,a){if(typeof s=="function"&&a===void 0)return this.on("collide",s);if(typeof s=="string")return this.onCollide((r,l)=>{r.is(s)&&a?.(r,l)});throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(s,a){if(typeof s=="function"&&a===void 0)return this.on("collideUpdate",s);if(typeof s=="string")return this.on("collideUpdate",(r,l)=>r.is(s)&&a?.(r,l));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(s,a){if(typeof s=="function"&&a===void 0)return this.on("collideEnd",s);if(typeof s=="string")return this.on("collideEnd",r=>r.is(s)&&a?.(r));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(s){return Bn(this.worldArea(),s)},resolveCollision(s){let a=this.checkCollision(s);a&&!a.resolved&&(this.pos=this.pos.add(a.displacement),a.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let s=this.localArea();if(!(s instanceof Eo||s instanceof Ft))throw new Error("Only support polygon and rect shapes for now");let a=this.transform.clone().translate(this.area.offset).scale(J(this.area.scale??1));if(s instanceof Ft){let r=As(this.anchor||ha).add(1,1).scale(-.5).scale(s.width,s.height);a.translate(r)}return s.transform(a)},screenArea(){let s=this.worldArea();return Yn(this)?s:s.transform(w.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function hg(e={}){let t=null,o=null,n=!1,s=J(0),a=null,r=null,l;return{id:"body",require:["pos"],vel:J(0),drag:e.drag??0,jumpForce:e.jumpForce??y0,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),r=this.pos.clone(),l=this.pos.clone(),this.mass===0)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate((c,d)=>{if(!d||!c.has("body")||d.resolved)return;this.trigger("beforePhysicsResolve",d);let i=d.reverse();if(c.trigger("beforePhysicsResolve",i),!(d.resolved||i.resolved)&&!(this.isStatic&&c.isStatic)){if(!this.isStatic&&!c.isStatic){let h=this.mass+c.mass;this.pos=this.pos.add(d.displacement.scale(c.mass/h)),c.pos=c.pos.add(d.displacement.scale(-this.mass/h)),this.transform=Js(this),c.transform=Js(c)}else{let h=!this.isStatic&&c.isStatic?d:d.reverse();h.source.pos=h.source.pos.add(h.displacement),h.source.transform=Js(h.source)}d.resolved=!0,this.trigger("physicsResolve",d),c.trigger("physicsResolve",d.reverse())}}),this.onPhysicsResolve(c=>{if(w.game.gravity)if(c.isBottom()&&this.isFalling()){this.vel=this.vel.reject(w.game.gravity.unit());let d=t;t=c.target,d!=t&&(o=c.target.pos),n?n=!1:d||(this.trigger("ground",t),c.target.trigger("land",this))}else c.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(w.game.gravity.unit()),this.trigger("headbutt",c.target),c.target.trigger("headbutted",this))}))},update(){t&&this.isColliding(t)&&t.exists()&&t.has("body")&&(o&&!t.pos.eq(o)&&e.stickToPlatform!==!1&&this.moveBy(t.pos.sub(o)),o=t.pos);let c=tr();c&&(this.pos.x==l.x&&(this.pos.x=Do(a.x,r.x,c/er()),l.x=this.pos.x),this.pos.y==l.y&&(this.pos.y=Do(a.y,r.y,c/er()),l.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==l.x&&(this.pos.x=a.x),this.pos.y==l.y&&(this.pos.y=a.y),a=null),w.game.gravity&&!this.isStatic){n&&(t=null,o=null,this.trigger("fallOff"),n=!1),t&&(!this.isColliding(t)||!t.exists()||!t.has("body"))&&(n=!0);let c=this.vel.clone();this.vel=this.vel.add(w.game.gravity.scale(this.gravityScale*ro()));let d=e.maxVelocity??x0;this.vel.slen()>d*d&&(this.vel=this.vel.unit().scale(d)),c.dot(w.game.gravity)<0&&this.vel.dot(w.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=s.x*ro(),this.vel.y+=s.y*ro(),this.vel.x*=1-this.drag*ro(),this.vel.y*=1-this.drag*ro(),this.move(this.vel),tr()){a=this.pos.clone();let c=this.vel.add(s.scale(ro()));r=this.pos.add(c.scale(ro())),l=this.pos.clone()}s.x=0,s.y=0},onPhysicsResolve(c){return this.on("physicsResolve",c)},onBeforePhysicsResolve(c){return this.on("beforePhysicsResolve",c)},curPlatform(){return t},isGrounded(){return t!==null},isFalling(){return this.vel.dot(Zs())>0},isJumping(){return this.vel.dot(Zs())<0},applyImpulse(c){this.isStatic||(this.vel=this.vel.add(c))},addForce(c){this.isStatic||(s.x+=c.x/this.mass,s.y+=c.y/this.mass)},jump(c){this.isStatic||(t=null,o=null,this.vel=Zs().scale(-c||-this.jumpForce))},onGround(c){return this.on("ground",c)},onFall(c){return this.on("fall",c)},onFallOff(c){return this.on("fallOff",c)},onHeadbutt(c){return this.on("headbutt",c)},onLand(c){return this.on("land",c)},onHeadbutted(c){return this.on("headbutted",c)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function ug(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround(()=>{t=this.numJumps})},doubleJump(o){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(o))},onDoubleJump(o){return this.on("doubleJump",o)},inspect(){return`jumpsLeft: ${t}`}}}function fg(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",(t,o)=>{let n=o?.normal.normal(),s=t.vel.project(n),a=n?.scale(this.speed)?.sub(s);t.addForce(a?.scale(t.mass*this.forceScale))})}}}function pg(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{if(!t.has("body"))return;let n=oe.fromAngle(this.forceAngle).scale(this.forceMagnitude);t.addForce(n),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function gg(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",(t,o)=>{let n=this.pos.sub(t.pos),s=n.len(),a=s*this.distanceScale/10,r=this.forceMode==="constant"?1:this.forceMode==="inverseLinear"?1/a:1/a**2,l=n.scale(this.forceMagnitude*r/s);t.addForce(l),this.linearDrag&&t.addForce(t.vel.scale(-this.linearDrag))})}}}function mg(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function yg(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve(t=>{let o=t.target.vel,n=Zs().scale(-1).angleBetween(o);Math.abs(n)>this.surfaceArc/2&&t.preventResolution()})}}}function xg(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",(t,o)=>{let n=t,s=n.worldArea(),[a,r]=s.cut(J(-100,this.surfaceLevel),J(100,this.surfaceLevel));a&&(this.applyBuoyancy(n,a),this.applyDrag(n,a)),this.flowMagnitude&&n.addForce(oe.fromAngle(this.flowAngle).scale(this.flowMagnitude))})},applyBuoyancy(t,o){let n=this.density*o.area(),s=J(0,1).scale(-n);t.addForce(s)},applyDrag(t,o){let n=t.vel,s=this.density*this.linearDrag,a=n.scale(-s);t.addForce(a)}}}function lr(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return typeof this.anchor=="string"?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function nh(){return{id:"fixed",fixed:!0}}function wg(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??J(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function bg(e){let t=w.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?w.game.layers?.[t]??null:null},set layer(o){if(t=w.game.layers?.indexOf(o),t==-1)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function vg(e,t){let o=typeof e=="number"?oe.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(o.scale(t))}}}function Eg(e={}){let t=!1,o=new Ft(J(0),fo(),go()),n=new Ft(J(0),0,0),s=a=>{a.isOffScreen()?(t||(a.trigger("exitView"),t=!0),e.hide&&(a.hidden=!0),e.pause&&(a.paused=!0),e.destroy&&a.destroy()):(t&&(a.trigger("enterView"),t=!1),e.hide&&(a.hidden=!1),e.pause&&(a.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??Tc,isOffScreen(){let a=this.screenPos();if(!a)return!1;if(o.width=fo(),o.height=go(),!this.offscreenDistance&&this.width&&this.height)return n.width=this.width,n.height=this.height,n.pos=this.pos,n.collides(o);let r=this.offscreenDistance?this.offscreenDistance:Tc;return!ca(o,a)&&o.sdistToPoint(a)>r*r},onExitScreen(a){return this.on("exitView",a)},onEnterScreen(a){return this.on("enterView",a)},add(){e.pause&&e.unpause?Ud(()=>s(this)):this.onUpdate(()=>s(this))}}}function $i(...e){return{id:"pos",pos:J(...e),moveBy(...t){this.pos=this.pos.add(J(...t))},move(...t){this.moveBy(J(...t).scale(ro()))},moveTo(...t){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.moveTo(J(t[0],t[1]),t[2]);let o=t[0],n=t[1];if(n===void 0){this.pos=J(o);return}let s=o.sub(this.pos);if(s.len()<=n*ro()){this.pos=J(o);return}this.move(s.unit().scale(n))},worldPos(t=null){return t?(this.pos=this.pos.add(this.fromWorld(t)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(t){return this.parent?this.parent.transform.multVec2(this.pos.add(t)):this.pos.add(t)},fromWorld(t){return this.parent?this.parent.transform.invert().multVec2(t).sub(this.pos):t.sub(this.pos)},screenPos(t=null){if(t)return this.pos=this.pos.add(this.fromScreen(t)),null;{let o=this.worldPos();return o?Yn(this)?o:ir(o):null}},toScreen(t){let o=this.toWorld(t);return Yn(this)?o:ir(o)},fromScreen(t){return Yn(this)?this.fromWorld(t):this.fromWorld(Wd(t))},toOther(t,o){return t.fromWorld(this.toWorld(o))},fromOther(t,o){return t.toOther(this,o)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){Ss({color:Bt(255,0,0),radius:4/yd()})}}}function Ag(e){return{id:"rotate",angle:e??0,rotateBy(t){this.angle+=t},rotateTo(t){this.angle=t},inspect(){return`angle: ${Math.round(this.angle)}`}}}function Ji(...e){if(e.length===0)return Ji(1);let t=J(...e);return{id:"scale",set scale(o){if(!(o instanceof oe))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=J(o)},get scale(){return t},scaleTo(...o){t=J(...o)},scaleBy(...o){t=t.scale(J(...o))},inspect(){return t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}}function Sg(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Mg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABqxJREFUeJztnU1yFDkQRtMEB+AG7Fk6fBPO6ZsQLGc/N5gbMAtosJvqKv2kpPxS763A0W5XSXqVqZ+SngzgF58/fflx/7N///vnacW1gBkFD2Z2LOYNBF3Dx9UXAGs5kxLWwhNxU2qlJHrOhwLfkNZoiaBzIa3dCFJYLXgSboKXmETPeVDQyamR8vX55fe/v37/9vBzCDoH0tqktEpZ+t0IOh4KOBm16euZmETPtVDAiRgRLRF0HRRuEkrFrE1hzR4Lipxj+bD6AqCPz5++/Bgp5tXfdv1CeAdPPmFmSkn0nE+a0drdFm6XiOkdKWEuKRptTXqlLuqqFNaM6Dkb+T5nbb+npo8WjZVinqFantFJk9bWojaRThq7HzKN8wiPJ7aCoJHEZN5zHvJp7RE1DTV6SnZ1fa/PL1MjJtF5HmnT2tJF3GZ/BIj05I8ULUtR6ypER7ogjxpw61rRGxEal4KYjNyORzatbUlHSxr06tFcBTHPiN5NUEJWzlZKG/aKRqYk5tl1IKgPafucZ7w+vxSluLP6olHnL6MQQfYV6bpk/+BRZXm+cXHEiApSipZHlE6tRBDMkxmyysl5VsmtjXiFoJmiZU35ZWK0oNv1OY+omSv0GDDKJCaMI42cHg25dvFCi6QZxVS6ViVSpLUz38A4oiS9ySjlW2althGWKZrN6XNuOVpbwq0ReIzqZhfTrHwE/PZZuEYqcnqO0tZQGxVqRylprLGIEDXNkLOKEakbYsYiiphmiQaEZuD9BghixiKSmGYJIueqBt4TRZEyHtHENCNyNtMaRREzHhHFNBOKnKv7myVcVXKka4WfRBXTjMjpypl8iBmP6MsOmed0Bgk1UHjxXlpORIAWIqeybyGtha1QEdNMRM5s7wLCGpTENBORE6AXNTHNkBM2QFFMM4F5ToX5TYiLqphmRE7YmMhimiEnJEb9XBdJOUlp4Qp1Mc1E5QQ4I/qyvFJCy8n8JnijEjXNAi3fQ0TwIEM6e2OqnAgII8kkptkgOZEQZlN6BquZjqhVFxlBOkZq4Z6WASAFQQ8jZwQJ70FK8CTiaeb3fDSLJyMiwiwiS/q0SkwEBE+85jYjSTpcTiSE2WQRtVlOpAMVemVdtjXmlZxICFlQk/TJjHcmYS96JJ0p6KmcZggKeWmVdPopYwgKuxJVUuQE+EU0Sd99KYICxJH0ry9DUIA/rFy3WyWnGYLCnqyQ9PCXERTgmJmSPvwlBAU4p1bUWklPP1yytA9JYWdGRtLLDyEowDUjomiRwQgKUIZnJC3OgREUoByPSDpkDyEkBfhJj6RNQ7xEUYA6aiS9Cdo8SUoUBaijVtCuFQwICtBGiajdawARFKCNK0HdVtEjKUAd0+Q0q9v/FklhJ1rmP4e8JEoUBejfq2jYNgtEUdgJzwN7u6dSSkBQyMSME7O7FyHUQpoLCqw8rv5o+d6Uw3NvfzjagUkAZvOlLH1lLMyx8wCzWBEhW3ZDmLZ7NTsrwCpmyui5A1+IPidigjcjhZy14/vytBYxwRsPMVcf/2c2QU72wQUVIgj5lqFyIiZEJ5qQb1me1gLMJLKM93wY9cVETYiGkphmg+RETFhJljY2LHICQB/uchI1AXxwlRMxAfwgrYVtUHvxwk1OoiaAL8MjJ2ICtOEip1q6APnJEBS6VwiRzp4vtM5YBvf3m/EeI8DyvUZK33z4+v1bqsZ7dN+3n2W6zwgMO44hY0X1vIqkXh419x7lXh9ds8oyviFyRqmcXrxf2FUtF89ymFkG6nI2p7WZB4FGvUWfLcVt4ahsdy+TR7ifz6lc0F5v0GfalmXldpE3esrr6PrTR84sjNjS4kpQhQhaUi4lD6KR1xK9DHupfoKoR02vSFDy9FWNoKVivv1/lG7OfZkqR043OZUbWgmtFaomaGl51ZTHCnFv5bqNnFGjZvRtEFUEHSHmI1ZHWgVBXZ5+sxvX7ANlPChpjKsknSllKaPlRU4nZo0Yjq6wiIJGFPMML2mj3M8ZRRe4QkzF6FhCJEFbBn4i0iKswn11yenZiLLKeMRqQdWiZSmlkqrcV9d0gPfksAcqBW+2ZqAoq5gZGSrnTtGwlVmCIqUepxWxerj7iIyNZ7SgiKmJhJw7NJpRgiKmLuHl3KnReA4UIaU+y+WkcbzHQ1DEzMGQ9aJH0BDK6RE0y9wlTDp2HuppERQxc0FFBaZGUMTMB5UlQG/fHyk1odJEaBUUMXWh4oSoFRQxtaHyxMi2uBseQwUKciUoYuaAShTlkaCImQcqUph7QREzF/8DSS/2GZ2/N/sAAAAASUVORK5CYII=",Tg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOcAAACDCAYAAAB2kQxsAAAAAXNSR0IArs4c6QAABdRJREFUeJzt3d3N3TYMgGG16ADdoAhyl7UyV9bqXRB0g2zQXgRGDcOWSIoUaX3vAwQBknMk/4gWLcnHrQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDEb9kb8FH99eeXf6Wf/efn35ynDyj1pEsb6G6NUxOYZ7sdB/QtPdnWRnn29gbKMYDUspPs0SgPb22cHANo/JG9AZF6wWBp3JLgeir36bvff3x9LOvzp2/dbSFA97bk5I4a9VMD7TXOUcP0uJ+d6emu5d6V1QvMs5nj8FZPx37X/b2TFpzShtnafeP0DipJMFnLnN3/w1OQ7tZgP+pA4VVKcHo0TG36KNULKGt5XsHZmi1APS5WM2Vqg0i7vbsG6YcIznN9vRTxXHavgdxtv6Tc3vc1pAHqdaG6ipwKYprpf1sFp6aH0gRTrxxLubPB2avHu+c/l3mICvqnsr//+Cq+qGrK1Xw/wzbBaRkNvSv3yew9cq+cu89L6nu6F/cMzCgzF1ftANlbe+Otp1IkDVxyVfbo6Z481f3507dhvXfbrk3HpdtjKTNqKuio8678c7mzF6ns6arfMyrVNoA75wMfNU2hKSeCx3Fq7dc+SPfDc39H9Vqn2CT//4bsYeT1PecOJyGSJdh6PZOlbElPZz2PHtlD1cUeS4LT4z5IOihwfNaD5ERm9qxH/dZ7Vmt9M999CtCZbdLUP/p3r2zFQ0paG8lr4Eb6+ZWBcSeq/qhyK6bXUfXOSgtO7/tOb9eT1NveqKttpYbiyXu/euV51JV16/T6e86zyF5TUp731V5Sp+Z7M71h9QvFNWWuvr0Sy4LzLfNvrel6zRX1e+hN2VzrnNlfaYD0xhCs++851lDh3vNV95xe6YvHgb8bwbNcuc+f09wbaUj2dzYgjz93//5kh94t0quCM8OKK6glKKuM0EYHfhUZWd8WwenZa0rLsp6s2YY66o0k9WUvS4NManBaGuo1eDIHgUZ1ePdkntsfFaCz5VZJdStsxyt7ziMNXHEAK5yk1mqmhrMPf1fcp57Vqe3SqZTMEduZhqAZyaywFne0DVHngHTZ11bznE88l/1lBZ9meP8851plWkBCO7drmQvWnL/sY/fKtFaqN3iy6iofsQxNktJnTMgfPXJUz3w3VaP5vOQ7Iyszvy2DczSi+aYFET2jINUEqFcAS4+rV480WlwRWXe07dLa0YGvfl9kmbTvPZJ1TXGvn4t4yuRp+2aMgk27wkm63DIztU3vOVfueC8wK4zKWtK0M+nvJXmOdlt65MgFFCva06qsKz044SvjIiN5TjLaaHxhtNyyouXBGZ1WSn66Ivt+M7pRZAWoZsDq+t2emeM1am/WtHxFG9runrO1/n1CxLK7CilxJM/H4bwuTJJBvWtgvm0gcNu01uvpd8la1soLE7xkpYDea4Ot6W3GOSzRc3o/qHw2M9qmXWA+uw+jbd0hyO9Yz0+vJ9QGcO/8ZV2YUqYVPN8dImXp3aJ/w1XTGGYfKZN+P7IXiXqO1uINLzFOm/Pz+BV4C03PNEqpZl//ELXP1ro8nhLyKLPHMyAiXyvh4cMFZ2uyAJXc62gzgJl1nhrSLMEzcLx+5qQnIhgqv6qhTHC2Zmus1tUuowCVDkRU6j0jgiJqhLPSSq2q7wMtMSBkdbcQWjNCq2nMlRrTnajAPP/t+c5Sj3K8VNueQ+pGzaa2MyOb2sZseW2dpL6ZnjMzfeQFt/Fe3XP2WIfGvRY6a569jCJ9TaIlcCS9KQE5p1TP2VrMbwLNDlZEvpE5AkGxh9f2nLO/QOetytIwAnMf6SfS2ns+jaZ6B4i2sWvSvF0HWOAj/aRGNFAaPXbw2rS2Rzr0T/ChshKNM3qd4135BCaqK9VAKy+lAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4DBC0k0jFtF9wAAAAASUVORK5CYII=",Dg=mu.version,w={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},Cg=(e={tagsAsComponents:!0})=>{w.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),w.k.quit()),w.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let o=e.canvas??t.appendChild(document.createElement("canvas"));w.canvas=o;let n=e.scale??1;w.gscale=n;let s=e.width&&e.height&&!e.stretch&&!e.letterbox;s?(o.width=e.width*n,o.height=e.height*n):(o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight);let a=["outline: none","cursor: default"];if(s){let pe=o.width,Ae=o.height;a.push(`width: ${pe}px`),a.push(`height: ${Ae}px`)}else a.push("width: 100%"),a.push("height: 100%");e.crisp&&(a.push("image-rendering: pixelated"),a.push("image-rendering: crisp-edges")),o.style.cssText=a.join(";");let r=e.pixelDensity||1;w.pixelDensity=r,o.width*=r,o.height*=r,o.tabIndex=0;let l=document.createElement("canvas");l.width=256,l.height=256,w.fontCacheCanvas=l;let c=l.getContext("2d",{willReadFrequently:!0});w.fontCacheC2d=c;let d=W0({canvas:o,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});w.app=d;let i=[],h=d.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!h)throw new Error("WebGL not supported");let u=h,g=Ff(u,{texFilter:e.texFilter}),p=$f(e,g);w.gfx=p;let D=Op();w.audio=D;let m=vf(g,e.spriteAtlasPadding??0);w.assets=m;let M=Pp();w.game=M,M.root.use(rr());function B(pe,Ae){let re=new Vi(g,pe,Ae);return{clear:()=>re.clear(),free:()=>re.free(),toDataURL:()=>re.toDataURL(),toImageData:()=>re.toImageData(),width:re.width,height:re.height,draw:Ce=>{Oo(),re.bind(),Ce(),Oo(),re.unbind()},get fb(){return re}}}function P(){u.clear(u.COLOR_BUFFER_BIT),p.frameBuffer.bind(),u.clear(u.COLOR_BUFFER_BIT),p.bgColor||Tn(()=>{si({width:fo(),height:go(),quad:new $t(0,0,fo()/64,go()/64),tex:p.bgTex,fixed:!0})}),p.renderer.numDraws=0,p.fixed=!1,p.transformStack.length=0,p.transform=new an}function f(pe,Ae){p.postShader=pe,p.postShaderUniform=Ae??null}function O(){Oo(),p.lastDrawCalls=p.renderer.numDraws,p.frameBuffer.unbind(),u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight);let pe=p.width,Ae=p.height;p.width=u.drawingBufferWidth/r,p.height=u.drawingBufferHeight/r,Wi({flipY:!0,tex:p.frameBuffer.tex,pos:new oe(p.viewport.x,p.viewport.y),width:p.viewport.width,height:p.viewport.height,shader:p.postShader,uniform:typeof p.postShaderUniform=="function"?p.postShaderUniform():p.postShaderUniform,fixed:!0}),Oo(),p.width=pe,p.height=Ae}let v=!1,T={inspect:!1,set timeScale(pe){w.app.state.timeScale=pe},get timeScale(){return w.app.state.timeScale},showLog:!0,fps:()=>d.fps(),numFrames:()=>d.numFrames(),stepFrame:ie,drawCalls:()=>p.lastDrawCalls,clearLog:()=>M.logs=[],log:(...pe)=>{let Ae=e.logMax??8,re=pe.length>1?pe.concat(" ").join(" "):pe[0];M.logs.unshift({msg:re,time:d.time()}),M.logs.length>Ae&&(M.logs=M.logs.slice(0,Ae))},error:pe=>T.log(new Error(pe.toString?pe.toString():pe)),curRecording:null,numObjects:()=>H("*",{recursive:!0}).length,get paused(){return v},set paused(pe){v=pe,pe?D.ctx.suspend():D.ctx.resume()}};w.debug=T;function x(pe,Ae){try{return JSON.parse(window.localStorage[pe])}catch{return Ae?(C(pe,Ae),Ae):null}}function C(pe,Ae){window.localStorage[pe]=JSON.stringify(Ae)}function S(pe,...Ae){let re=pe(Te),Ce;typeof re=="function"?Ce=re(...Ae)(Te):Ce=re;for(let Fe in Ce)Te[Fe]=Ce[Fe],e.global!==!1&&(window[Fe]=Ce[Fe]);return Te}function z(pe){let Ae=d.canvas.captureStream(pe),re=D.ctx.createMediaStreamDestination();D.masterNode.connect(re);let Ce=new MediaRecorder(Ae),Fe=[];return Ce.ondataavailable=De=>{De.data.size>0&&Fe.push(De.data)},Ce.onerror=()=>{D.masterNode.disconnect(re),Ae.getTracks().forEach(De=>De.stop())},Ce.start(),{resume(){Ce.resume()},pause(){Ce.pause()},stop(){return Ce.stop(),D.masterNode.disconnect(re),Ae.getTracks().forEach(De=>De.stop()),new Promise(De=>{Ce.onstop=()=>{De(new Blob(Fe,{type:"video/mp4"}))}})},download(De="kaboom.mp4"){this.stop().then(We=>Dc(De,We))}}}function L(){return document.activeElement===d.canvas}let N=M.root.add.bind(M.root),_=M.root.readd.bind(M.root),X=M.root.removeAll.bind(M.root),H=M.root.get.bind(M.root),R=M.root.wait.bind(M.root),F=M.root.loop.bind(M.root),G=M.root.query.bind(M.root),Q=M.root.tween.bind(M.root),le=js(null,Tg),se=js(null,Mg);w.kaSprite=le,w.boomSprite=se;function ne(){M.root.fixedUpdate()}function ie(){M.root.update()}class fe{source;target;normal;distance;resolved=!1;constructor(Ae,re,Ce,Fe,De=!1){this.source=Ae,this.target=re,this.normal=Ce,this.distance=Fe,this.resolved=De}get displacement(){return this.normal.scale(this.distance)}reverse(){return new fe(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(M.gravity||J(0,1))>0}isRight(){return this.displacement.cross(M.gravity||J(0,1))<0}isTop(){return this.displacement.dot(M.gravity||J(0,1))>0}isBottom(){return this.displacement.dot(M.gravity||J(0,1))<0}preventResolution(){this.resolved=!0}}function Me(){if(!lg())return;let pe={},Ae=e.hashGridSize||64,re=new an,Ce=[];function Fe(De){if(Ce.push(re.clone()),De.pos&&re.translate(De.pos),De.scale&&re.scale(De.scale),De.angle&&re.rotate(De.angle),De.transform=re.clone(),De.c("area")&&!De.paused){let We=De,nt=We.worldArea().bbox(),Tt=Math.floor(nt.pos.x/Ae),Lt=Math.floor(nt.pos.y/Ae),dt=Math.ceil((nt.pos.x+nt.width)/Ae),Ie=Math.ceil((nt.pos.y+nt.height)/Ae),Be=new Set;for(let Ke=Tt;Ke<=dt;Ke++)for(let qe=Lt;qe<=Ie;qe++)if(!pe[Ke])pe[Ke]={},pe[Ke][qe]=[We];else if(!pe[Ke][qe])pe[Ke][qe]=[We];else{let ke=pe[Ke][qe];e:for(let at of ke){if(at.paused||!at.exists()||Be.has(at.id))continue;for(let ot of We.collisionIgnore)if(at.is(ot))continue e;for(let ot of at.collisionIgnore)if(We.is(ot))continue e;let tt=n0(We.worldArea(),at.worldArea());if(tt){let ot=new fe(We,at,tt.normal,tt.distance);We.trigger("collideUpdate",at,ot);let ft=ot.reverse();ft.resolved=ot.resolved,at.trigger("collideUpdate",We,ft)}Be.add(at.id)}ke.push(We)}}De.children.forEach(Fe),re=Ce.pop()}Fe(M.root)}function Ue(pe){console.error(pe),D.ctx.suspend();let Ae=pe.message??String(pe)??"Unknown error, check console for more info";d.run(()=>{},()=>{P(),Tn(()=>{let re=fo(),Ce=go(),Fe={size:36,width:re-64,letterSpacing:4,lineSpacing:4,font:Gi,fixed:!0};Ho({width:re,height:Ce,color:Bt(0,0,255),fixed:!0});let De=Wn({...Fe,text:"Error",pos:J(32),color:Bt(255,128,0),fixed:!0});$n(De),Uc({...Fe,text:Ae,pos:J(32,32+De.height+16),fixed:!0}),Mo(),M.events.trigger("error",pe)}),O()})}function Ne(pe){i.push(pe)}function Pe(){M.events.onOnce("frameEnd",()=>{d.quit(),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);let pe=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(let Ae=0;Ae<pe;Ae++)u.activeTexture(u.TEXTURE0+Ae),u.bindTexture(u.TEXTURE_2D,null),u.bindTexture(u.TEXTURE_CUBE_MAP,null);u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),g.destroy(),i.forEach(Ae=>Ae())})}let Ge=!0;d.run(()=>{try{m.loaded&&(T.paused||ne(),Me())}catch(pe){Ue(pe)}},(pe,Ae)=>{try{pe(),m.loaded||Vn()===1&&!Ge&&(m.loaded=!0,wd().forEach(re=>M.events.trigger("loadError",...re)),M.events.trigger("load")),!m.loaded&&e.loadingScreen!==!1||Ge?(P(),Gf(),O()):(T.paused||ie(),Me(),P(),qf(),e.debug!==!1&&Yf(),O()),Ge&&(Ge=!1),M.events.trigger("frameEnd"),Ae()}catch(re){Ue(re)}}),md(),Zd();let Te={_k:w,VERSION:Dg,loadRoot:xf,loadProgress:Vn,loadSprite:js,loadSpriteAtlas:Dd,loadSound:zf,loadMusic:Of,loadBitmapFont:Df,loadFont:Mf,loadShader:If,loadShaderURL:Bf,loadAseprite:Sf,loadPedit:Cf,loadBean:Af,loadJSON:wf,load:or,getSound:Td,getFont:Ad,getBitmapFont:Sd,getSprite:bd,getShader:Md,getAsset:bf,Asset:_o,SpriteData:Ln,SoundData:ni,width:fo,height:go,center:Ki,dt:ro,fixedDt:er,restDt:tr,time:d.time,screenshot:d.screenshot,record:z,isFocused:L,setCursor:d.setCursor,getCursor:d.getCursor,setCursorLocked:d.setCursorLocked,isCursorLocked:d.isCursorLocked,setFullscreen:d.setFullscreen,isFullscreen:d.isFullscreen,isTouchscreen:d.isTouchscreen,onLoad:Fr,onLoadError:Ep,onLoading:wp,onResize:bp,onGamepadConnect:d.onGamepadConnect,onGamepadDisconnect:d.onGamepadDisconnect,onError:vp,onCleanup:Ne,flash:Vd,setCamPos:Xd,getCamPos:Fd,setCamRot:Gd,getCamRot:Kd,setCamScale:Yd,getCamScale:qd,getCamTransform:Ap,camPos:Tp,camScale:Dp,camFlash:Rp,camRot:Cp,camTransform:Sp,shake:Mp,toScreen:ir,toWorld:Wd,setGravity:Ip,getGravity:Bp,setGravityDirection:Lp,getGravityDirection:Zs,setBackground:uf,getBackground:ff,getGamepads:d.getGamepads,getTreeRoot:qp,add:N,make:Yr,destroy:kd,destroyAll:X,get:H,query:G,readd:_,pos:$i,scale:Ji,rotate:Ag,color:Ld,opacity:zd,anchor:lr,area:dg,sprite:ar,text:$p,polygon:op,rect:Hd,circle:Jf,uvquad:Jp,outline:kf,particles:tp,body:hg,platformEffector:yg,surfaceEffector:fg,areaEffector:pg,pointEffector:gg,buoyancyEffector:xg,constantForce:mg,doubleJump:ug,shader:np,textInput:cg,timer:rr,fixed:nh,stay:oh,health:sg,lifespan:ig,named:ag,state:rg,z:Sg,layer:bg,move:vg,offscreen:Eg,follow:wg,fadeIn:Zf,mask:Qf,drawon:jf,raycast:Od,tile:eh,animate:ng,serializeAnimation:th,agent:jp,sentry:kp,patrol:Qp,pathfinder:Zp,trigger:ip,on:Bo,onFixedUpdate:ap,onUpdate:Ud,onDraw:rp,onAdd:Nd,onDestroy:cp,onTag:_d,onUntag:hp,onUse:lp,onUnuse:dp,onClick:gp,onCollide:up,onCollideUpdate:fp,onCollideEnd:pp,onHover:mp,onHoverUpdate:yp,onHoverEnd:xp,onKeyDown:d.onKeyDown,onKeyPress:d.onKeyPress,onKeyPressRepeat:d.onKeyPressRepeat,onKeyRelease:d.onKeyRelease,onMouseDown:d.onMouseDown,onMousePress:d.onMousePress,onMouseRelease:d.onMouseRelease,onMouseMove:d.onMouseMove,onCharInput:d.onCharInput,onTouchStart:d.onTouchStart,onTouchMove:d.onTouchMove,onTouchEnd:d.onTouchEnd,onScroll:d.onScroll,onHide:d.onHide,onShow:d.onShow,onGamepadButtonDown:d.onGamepadButtonDown,onGamepadButtonPress:d.onGamepadButtonPress,onGamepadButtonRelease:d.onGamepadButtonRelease,onGamepadStick:d.onGamepadStick,onButtonPress:d.onButtonPress,onButtonDown:d.onButtonDown,onButtonRelease:d.onButtonRelease,mousePos:d.mousePos,mouseDeltaPos:d.mouseDeltaPos,isKeyDown:d.isKeyDown,isKeyPressed:d.isKeyPressed,isKeyPressedRepeat:d.isKeyPressedRepeat,isKeyReleased:d.isKeyReleased,isMouseDown:d.isMouseDown,isMousePressed:d.isMousePressed,isMouseReleased:d.isMouseReleased,isMouseMoved:d.isMouseMoved,isGamepadButtonPressed:d.isGamepadButtonPressed,isGamepadButtonDown:d.isGamepadButtonDown,isGamepadButtonReleased:d.isGamepadButtonReleased,getGamepadStick:d.getGamepadStick,isButtonPressed:d.isButtonPressed,isButtonDown:d.isButtonDown,isButtonReleased:d.isButtonReleased,setButton:d.setButton,getButton:d.getButton,pressButton:d.pressButton,releaseButton:d.releaseButton,getLastInputDeviceType:d.getLastInputDeviceType,charInputted:d.charInputted,loop:F,wait:R,play:Up,setVolume:Jd,getVolume:jd,volume:Np,burp:$d,audioCtx:D.ctx,Line:Io,Rect:Ft,Circle:Po,Ellipse:yn,Point:_u,Polygon:Eo,Vec2:oe,Color:vt,Mat4:an,Quad:$t,RNG:Vl,rand:ao,randi:Wl,randSeed:vu,vec2:J,rgb:Bt,hsl2rgb:yu,quad:kt,choose:Su,chooseMultiple:Au,shuffle:$l,chance:Eu,lerp:Do,tween:Q,easings:ti,map:tn,mapc:xu,wave:Kl,deg2rad:eo,rad2deg:Kn,clamp:sn,evaluateQuadratic:Fu,evaluateQuadraticFirstDerivative:Yu,evaluateQuadraticSecondDerivative:qu,evaluateBezier:Lr,evaluateBezierFirstDerivative:Gu,evaluateBezierSecondDerivative:Ku,evaluateCatmullRom:Vu,evaluateCatmullRomFirstDerivative:Wu,curveLengthApproximation:sd,normalizedCurve:$u,hermite:di,cardinal:id,catmullRom:qi,bezier:Ju,kochanekBartels:ju,easingSteps:o0,easingLinear:e0,easingCubicBezier:t0,testLineLine:Dr,testRectRect:Jl,testRectLine:Cr,testRectPoint:ca,testCirclePolygon:da,testLinePoint:Rr,testLineCircle:li,isConvex:c0,triangulate:rd,NavMesh:df,drawSprite:Vf,drawText:Uc,formatText:Wn,drawRect:Ho,drawLine:qs,drawLines:Xr,drawTriangle:Id,drawCircle:Ss,drawEllipse:Cd,drawUVQuad:si,drawPolygon:Rn,drawCurve:Rd,drawBezier:_f,drawFormattedText:$n,drawMasked:Kf,drawSubtracted:Wf,pushTransform:zo,popTransform:Mo,pushTranslate:jt,pushScale:oi,pushRotate:gs,pushMatrix:pf,usePostEffect:f,makeCanvas:B,debug:T,scene:Gp,getSceneName:Wp,go:Kp,onSceneLeave:Vp,layers:Yp,getLayers:Xp,setLayers:Qd,getDefaultLayer:Fp,addLevel:sp,getData:x,setData:C,download:Or,downloadJSON:S0,downloadText:pd,downloadBlob:Dc,plug:S,ASCII_CHARS:cd,canvas:d.canvas,addKaboom:_p,LEFT:oe.LEFT,RIGHT:oe.RIGHT,UP:oe.UP,DOWN:oe.DOWN,RED:vt.RED,GREEN:vt.GREEN,BLUE:vt.BLUE,YELLOW:vt.YELLOW,MAGENTA:vt.MAGENTA,CYAN:vt.CYAN,WHITE:vt.WHITE,BLACK:vt.BLACK,quit:Pe,KEvent:vo,KEventHandler:ei,KEventController:es,cancel:()=>dd};w.k=Te;let ut=e.plugins;if(ut&&ut.forEach(S),e.global!==!1)for(let pe in Te)window[pe]=Te[pe];return e.focus!==!1&&d.canvas.focus(),Te},Rg=Cg;const Xc=["Swift","Mighty","Bold","Silent","Fierce","Brave","Quick","Sharp","Dark","Bright","Wild","Cool","Hot","Frozen","Burning","Iron","Steel","Golden","Silver","Crimson","Azure","Jade","Ruby","Onyx","Electric","Toxic","Mystic","Ancient","Cyber","Neon","Phantom","Shadow","Storm","Thunder","Frost","Blaze","Venom","Razor","Nitro","Turbo","Alpha","Omega","Prime","Elite","Epic","Royal","Noble","Rogue","Savage","Reigning","Rising","Rookie","Veteran","Seasoned","Underdog","Favored","Viral","Trending","Famous","Infamous","Ultimate","Supreme","Grand","Major","Premier","Star","Main","Top","Peak","Apex","Brutal","Ruthless","Vicious","Crushing","Raging","Furious","Frenzied","Berserk","Mad","Crazy","Lethal","Deadly","Fatal","Killer","Murder","Immortal","Eternal","Heavy","Hard","Tough","Gritty","Scrappy","Mean","Nasty","Dirty","Raw","Primal","Amazing","Awesome","Dazzling","Stunning","Shocking","Dynamic","Radical","Extreme","Intense","Hyper","Ultra","Mega","Super","Power","Atomic","Nuclear","Chaos","Havoc","Mayhem","Rampage","Carnage","Cocky","Sneaky","Tricky","Sly","Cunning","Wicked","Evil","Sinister","Twisted","Crooked","Lucky","Unlucky","Cursed","Blessed","Chosen","Lone","Solo","Outlaw","Rebel","Bandit"],Fc=["Wolf","Eagle","Tiger","Dragon","Phoenix","Hawk","Lion","Bear","Falcon","Raven","Viper","Cobra","Panther","Shark","Raptor","Hunter","Warrior","Knight","Ninja","Samurai","Ronin","Striker","Sniper","Ranger","Scout","Titan","Champion","Hero","Legend","Master","Blade","Arrow","Bullet","Rocket","Comet","Star","Moon","Sun","Bolt","Flash","Storm","Flame","Wave","Wind","Quake","Slayer","Reaper","Wraith","Ghost","Specter","Finalist","Victor","Winner","Champ","Hopeful","Prospect","Wildcard","Underdog","Favorite","Prodigy","Rookie","Veteran","Pro","Amateur","Phenom","Showman","Icon","Brawler","Bruiser","Slugger","Puncher","Boxer","Fighter","Scrapper","Battler","Duelist","Crusher","Smasher","Basher","Masher","Thrasher","Pummeler","Pounder","Hammer","Mauler","Mangler","Knockout","Haymaker","Uppercut","Jab","Hook","Spartan","Viking","Wrecking","Rampage","Havoc","Mayhem","Chaos","Carnage","Fury","Menace","Terror","Horror","Dread","Fist","Knuckle","Claw","Talon","Spike","Axe","Hammer","Mace","Flail","Club","Cannon","Mortar","Missile","Bomb","Grenade","Shiv","Machete","Cleaver","Hatchet","Gorilla","Rhino","Bull","Boar","Pitbull","Doberman","Mastiff","Bulldog","Scorpion","Mantis","Hornet","Wasp","Spider","Croc","Gator","Piranha","Orca","Hyena","Jackal","Badger","Warthog","Mongoose","Outlaw","Bandit","Thug","Goon","Hooligan","Punk","Rebel","Maverick","Renegade","Assassin","Bounty","Hitman","Enforcer","Boss","Kingpin","Warlord","Overlord","Tyrant"];function dr(){const e=Xc[Math.floor(Math.random()*Xc.length)],t=Fc[Math.floor(Math.random()*Fc.length)];return`${e}${t}`}function hr(){return Math.floor(1e5+Math.random()*9e5).toString()}function Pg(e){return/^\d{6}$/.test(e)}const rn={floor2:{id:"floor2",name:"Floor 2 Reached",description:"Reach Floor 2",category:"progression",icon:"2",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:2},hint:"Progress further into the facility"},floor3:{id:"floor3",name:"Floor 3 Reached",description:"Reach Floor 3",category:"progression",icon:"3",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:3},hint:"Keep pushing deeper"},floor5:{id:"floor5",name:"Floor 5 Reached",description:"Reach Floor 5",category:"progression",icon:"5",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:5},hint:"The halfway point awaits",unlocks:["trailIce"]},floor10:{id:"floor10",name:"Double Digits",description:"Reach Floor 10",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestFloor",value:10},unlocks:["plasmaRifle"]},firstSynergy:{id:"firstSynergy",name:"Combo Starter",description:"Activate your first synergy",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect upgrades that work together",unlocks:["trailShadow"]},allCharacters:{id:"allCharacters",name:"Full Roster",description:"Unlock all characters",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Progress through floors to unlock characters"},maxUpgrade:{id:"maxUpgrade",name:"Maxed Out",description:"Max out a permanent upgrade",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Purchase the same upgrade multiple times"},firstDoor:{id:"firstDoor",name:"Door Explorer",description:"Enter a special door",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Find and enter a special door in a room"},firstKill:{id:"firstKill",name:"First Blood",description:"Kill your first enemy",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1},hint:"Defeat any enemy"},kill100:{id:"kill100",name:"Enemy Slayer",description:"Kill 100 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:100},hint:"Keep fighting!",unlocks:["trailFire"]},kill500:{id:"kill500",name:"Massacre",description:"Kill 500 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:500},hint:"The carnage continues",unlocks:["trailPoison"]},kill1000:{id:"kill1000",name:"Rampage",description:"Kill 1000 enemies total",category:"combat",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalEnemiesKilled",value:1e3},hint:"A true warrior emerges"},killStreak10:{id:"killStreak10",name:"On Fire",description:"Kill 10 enemies in 5 seconds",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Defeat enemies rapidly",unlocks:["deathVaporize"]},multikill:{id:"multikill",name:"Multi-Kill",description:"Kill 5 enemies with one attack",category:"combat",icon:"",unlocked:!1,difficulty:"challenge",hint:"Use piercing or explosive attacks",unlocks:["deathPixelate"]},firstBoss:{id:"firstBoss",name:"Boss Hunter",description:"Defeat your first boss",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:1},hint:"Clear Floor 1 to face a boss",unlocks:["deathExplosion"]},boss5:{id:"boss5",name:"Boss Slayer",description:"Defeat 5 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:5},hint:"Keep defeating floor bosses",unlocks:["deathDisintegrate"]},boss10:{id:"boss10",name:"Boss Veteran",description:"Defeat 10 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalBossesKilled",value:10},hint:"Experience makes perfect"},boss25:{id:"boss25",name:"Boss Crusher",description:"Defeat 25 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:25},unlocks:["railgun"],hint:"Become a boss-hunting expert"},boss50:{id:"boss50",name:"Boss Destroyer",description:"Defeat 50 bosses total",category:"boss",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalBossesKilled",value:50},hint:"The ultimate boss hunter"},minibossSlayer:{id:"minibossSlayer",name:"Miniboss Hunter",description:"Defeat 10 minibosses",category:"boss",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalMinibossesKilled",value:10},hint:"Minibosses appear in later rooms"},firstRun:{id:"firstRun",name:"First Run",description:"Complete your first run",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:1},hint:"Play until you die (or win!)"},run10:{id:"run10",name:"Veteran",description:"Complete 10 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:10},hint:"Practice makes progress"},run50:{id:"run50",name:"Dedicated",description:"Complete 50 runs",category:"run",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRuns",value:50},hint:"A true fan of the show"},run100:{id:"run100",name:"Century",description:"Complete 100 runs",category:"run",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRuns",value:100},hint:"The ultimate dedication"},quickDeath:{id:"quickDeath",name:"Speedrun Fail",description:"Die within 30 seconds",category:"run",icon:"",unlocked:!1,difficulty:"normal",hint:"Sometimes things go wrong fast"},longRun:{id:"longRun",name:"Marathon",description:"Survive for 30 minutes",category:"run",icon:"",unlocked:!1,difficulty:"challenge",hint:"Keep surviving as long as possible"},level10:{id:"level10",name:"Level 10",description:"Reach level 10 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:10},hint:"Collect XP and level up"},level20:{id:"level20",name:"Level 20",description:"Reach level 20 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"bestLevel",value:20},hint:"Keep grinding for XP"},level30:{id:"level30",name:"Powerhouse",description:"Reach level 30 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:30},hint:"Build becomes unstoppable"},level50:{id:"level50",name:"Unstoppable",description:"Reach level 50 in a single run",category:"upgrade",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestLevel",value:50},hint:"Ultimate power achieved"},upgradeCollector:{id:"upgradeCollector",name:"Collector",description:"Have 15 upgrades at once",category:"upgrade",icon:"",unlocked:!1,difficulty:"normal",hint:"Collect many different upgrades"},synergyMaster:{id:"synergyMaster",name:"Synergy Master",description:"Activate 3 synergies in one run",category:"upgrade",icon:"",unlocked:!1,difficulty:"challenge",hint:"Build for multiple synergy combos",unlocks:["trailRainbow"]},earn100:{id:"earn100",name:"Pocket Change",description:"Earn 100 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:100},hint:"Play runs to earn credits"},earn500:{id:"earn500",name:"Savings Account",description:"Earn 500 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:500},hint:"Keep earning and saving",unlocks:["glowGold"]},earn1000:{id:"earn1000",name:"Money Bags",description:"Earn 1000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencyEarned",value:1e3},hint:"A fortune awaits"},earn5000:{id:"earn5000",name:"Fortune",description:"Earn 5000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:5e3},hint:"Building an empire"},earn10000:{id:"earn10000",name:"Tycoon",description:"Earn 10000 credits total",category:"currency",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalCurrencyEarned",value:1e4},hint:"The ultimate collector"},bigSpender:{id:"bigSpender",name:"Big Spender",description:"Spend 1000 credits in the shop",category:"currency",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalCurrencySpent",value:1e3},hint:"Buy upgrades from the shop"},perfectFloor:{id:"perfectFloor",name:"Untouchable",description:"Clear a floor without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Dodge everything on an entire floor",unlocks:["glowVoid"]},speedRunner:{id:"speedRunner",name:"Speed Demon",description:"Clear Floor 3 in under 5 minutes",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Rush through the first 3 floors",unlocks:["glowElectric"]},bossRush:{id:"bossRush",name:"Boss Rush",description:"Defeat 3 bosses in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Reach and defeat multiple floor bosses"},noHitBoss:{id:"noHitBoss",name:"Flawless Victory",description:"Defeat a boss without taking damage",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Perfect boss fight execution"},glassCannonWin:{id:"glassCannonWin",name:"Living Dangerously",description:"Defeat a boss while below 25% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Living dangerously pays off"},closeCall:{id:"closeCall",name:"Close Call",description:"Survive with 1 HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Get very close to death but survive",unlocks:["glowCrimson"]},pacifist:{id:"pacifist",name:"Pacifist Start",description:"Clear Room 1 without attacking",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Just dodge everything"},noDamageRoom:{id:"noDamageRoom",name:"Perfect Room",description:"Clear 5 rooms without damage in one run",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Master your dodging skills"},kill5000:{id:"kill5000",name:"Exterminator",description:"Kill 5,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:5e3},hint:"A lifetime of combat"},kill10000:{id:"kill10000",name:"Annihilator",description:"Kill 10,000 enemies total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalEnemiesKilled",value:1e4},hint:"The ultimate destroyer"},floor15:{id:"floor15",name:"Deep Delver",description:"Reach Floor 15",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:15},hint:"Go deeper than ever before"},floor20:{id:"floor20",name:"Abyssal",description:"Reach Floor 20",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"bestFloor",value:20},hint:"The final frontier"},rooms100:{id:"rooms100",name:"Room Master",description:"Clear 100 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalRoomsCleared",value:100},hint:"Clear many rooms across all runs"},rooms500:{id:"rooms500",name:"Hall Walker",description:"Clear 500 rooms total",category:"benchmark",icon:"",unlocked:!1,difficulty:"benchmark",threshold:{stat:"totalRoomsCleared",value:500},hint:"Keep exploring"},firstPickup:{id:"firstPickup",name:"Loot Goblin",description:"Collect your first pickup",category:"progression",icon:"",unlocked:!1,difficulty:"normal",hint:"Pick up health, XP, or other items"},healingAddict:{id:"healingAddict",name:"Healing Addict",description:"Collect 50 health pickups",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalHealthPickups",value:50},hint:"Stay alive by healing"},xpHoarder:{id:"xpHoarder",name:"XP Hoarder",description:"Collect 1000 XP orbs",category:"progression",icon:"",unlocked:!1,difficulty:"normal",threshold:{stat:"totalXpOrbs",value:1e3},hint:"Collect all those green orbs"},comeback:{id:"comeback",name:"Comeback King",description:"Win a room after being below 10% HP",category:"challenge",icon:"",unlocked:!1,difficulty:"challenge",hint:"Never give up!"}},Uo={normal:[200,200,200],challenge:[255,200,100],benchmark:[200,150,255]},Yc={normal:25,challenge:50,benchmark:100};function sh(e){return!e||e.unlocks&&e.unlocks.length>0?0:e.reward!==void 0?e.reward:Yc[e.difficulty]||Yc.normal}function Ig(e){return Object.values(rn).filter(t=>t.category===e)}function Bg(){const e=new Set;return Object.values(rn).forEach(t=>e.add(t.category)),Array.from(e)}function ih(e){return rn[e]||null}function ji(e,t){const o=rn[e];if(!o||!o.threshold)return null;const n=t[o.threshold.stat]||0,s=o.threshold.value,a=Math.min(n/s,1);return{current:n,target:s,progress:a,percentage:Math.round(a*100)}}const Wt={survivor:{name:"The Survivor",description:"Balanced stats, +10% XP gain",cost:0,unlockedByDefault:!0,char:"@",color:[100,150,255],stats:{health:100,speed:150,damage:10},weapon:"pistol",ability:"xpBoost"},scout:{name:"The Scout",description:"Fast and agile, +20% speed, +10% dodge",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,255,100],stats:{health:75,speed:200,damage:8},weapon:"smg",ability:"speedBoost"},tank:{name:"The Tank",description:"High health and defense, +25% health, +15% damage reduction",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[150,150,150],stats:{health:150,speed:100,damage:12},weapon:"shotgun",ability:"tankStats"},sniper:{name:"The Sniper",description:"High damage, precision-focused, +50% crit chance",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3},char:"",color:[100,255,255],stats:{health:80,speed:120,damage:20},weapon:"sniper",ability:"critBoost"},pyro:{name:"The Pyro",description:"Fire specialist, +25% fire damage over time",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2},char:"",color:[255,150,50],stats:{health:90,speed:150,damage:12},weapon:"flamethrower",ability:"fireDot"},bomber:{name:"The Bomber",description:"Explosive specialist, +50% blast radius, projectiles explode on hit",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"boss10"},char:"",color:[255,100,100],stats:{health:85,speed:130,damage:15},weapon:"launcher",ability:"explosiveShots"},engineer:{name:"The Engineer",description:"Support class, +2 orbital drones that auto-attack nearby enemies",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"level20"},char:"",color:[100,200,255],stats:{health:80,speed:140,damage:8},weapon:"pistol",ability:"orbitalDrones"},vampire:{name:"The Vampire",description:"Lifesteal specialist, +15% lifesteal, -20% max health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"kill1000"},char:"",color:[180,50,180],stats:{health:70,speed:160,damage:14},weapon:"smg",ability:"vampiric"},berserker:{name:"The Berserker",description:"Rage mode, +100% damage below 30% HP, takes +25% more damage",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"glassCannonWin"},char:"",color:[255,50,50],stats:{health:120,speed:140,damage:18},weapon:"shotgun",ability:"rage"},ghost:{name:"The Ghost",description:"Evasion master, +25% dodge chance, +15% crit, lower health",cost:0,unlockedByDefault:!1,unlockRequirement:{type:"achievement",value:"perfectFloor"},char:"",color:[200,200,255],stats:{health:60,speed:180,damage:11},weapon:"smg",ability:"ethereal"}},ah={default:{name:"Default Weapon",description:"Single bullet weapon",cost:0,unlockedByDefault:!0},spreadShot:{name:"Spread Shot",description:"Fires 3 projectiles in a cone, lower damage each",cost:250,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:2}},boomerang:{name:"Boomerang Blaster",description:"Projectiles return, hitting enemies twice",cost:400,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},chainLightning:{name:"Chain Lightning",description:"Bounces to 3 nearby enemies, -20% per bounce",cost:500,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:3}},railgun:{name:"Railgun",description:"Pierces ALL enemies in a line, 3s cooldown",cost:600,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4},requiredAchievement:"boss25"},homingMissiles:{name:"Homing Missiles",description:"Slower projectiles that track enemies",cost:700,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:4}},plasmaRifle:{name:"Plasma Rifle",description:"High damage, penetrates 2 enemies",cost:800,unlockedByDefault:!1,unlockRequirement:{type:"floor",value:5},requiredAchievement:"floor10"}},fs={trailNone:{name:"No Trail",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"trail"},trailFire:{name:"Fire Trail",description:"Leave a blazing trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[255,100,50],requiredAchievement:"kill100"},trailIce:{name:"Ice Trail",description:"Leave a frosty trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,200,255],requiredAchievement:"floor5"},trailPoison:{name:"Toxic Trail",description:"Leave a poisonous trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[100,255,100],requiredAchievement:"kill500"},trailShadow:{name:"Shadow Trail",description:"Leave a dark trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:[80,50,120],requiredAchievement:"firstSynergy"},trailRainbow:{name:"Rainbow Trail",description:"Leave a colorful trail behind you",cost:0,unlockedByDefault:!1,category:"trail",color:"rainbow",requiredAchievement:"synergyMaster"},deathNone:{name:"Standard Death",description:"Default enemy death effect",cost:0,unlockedByDefault:!0,category:"death"},deathExplosion:{name:"Explosive Death",description:"Enemies explode dramatically",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"firstBoss"},deathDisintegrate:{name:"Disintegration",description:"Enemies crumble into particles",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"boss5"},deathVaporize:{name:"Vaporize",description:"Enemies vanish in a puff of smoke",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"killStreak10"},deathPixelate:{name:"Pixelate",description:"Enemies break into pixels",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"multikill"},deathFireworks:{name:"Fireworks",description:"Enemies burst like fireworks",cost:0,unlockedByDefault:!1,category:"death",requiredAchievement:"floor10"},glowNone:{name:"No Glow",description:"Default appearance",cost:0,unlockedByDefault:!0,category:"glow"},glowGold:{name:"Golden Aura",description:"Radiate a golden glow",cost:0,unlockedByDefault:!1,category:"glow",color:[255,200,50],requiredAchievement:"earn500"},glowCrimson:{name:"Crimson Aura",description:"Radiate a blood-red glow",cost:0,unlockedByDefault:!1,category:"glow",color:[200,50,50],requiredAchievement:"closeCall"},glowElectric:{name:"Electric Aura",description:"Crackle with electricity",cost:0,unlockedByDefault:!1,category:"glow",color:[100,150,255],requiredAchievement:"speedRunner"},glowVoid:{name:"Void Aura",description:"Emanate dark energy",cost:0,unlockedByDefault:!1,category:"glow",color:[50,0,80],requiredAchievement:"perfectFloor"}},rh={healthPack:{name:"Health Pack",description:"Start next run with +30 bonus HP",cost:30,consumable:!0,effect:{type:"startingHealth",value:30}},damageAmp:{name:"Damage Amp",description:"+25% damage for first floor",cost:35,consumable:!0,effect:{type:"tempDamage",value:.25,duration:"floor"}},speedSerum:{name:"Speed Serum",description:"+30% speed for first floor",cost:25,consumable:!0,effect:{type:"tempSpeed",value:.3,duration:"floor"}},wealthCharm:{name:"Wealth Charm",description:"+30% credits earned this run",cost:50,consumable:!0,effect:{type:"creditMultiplier",value:.3,duration:"run"}},luckyCoin:{name:"Lucky Coin",description:"+15% crit chance for first floor",cost:40,consumable:!0,effect:{type:"tempCrit",value:.15,duration:"floor"}},armorPlating:{name:"Armor Plating",description:"+20% damage reduction for first floor",cost:45,consumable:!0,effect:{type:"tempDefense",value:.2,duration:"floor"}},xpBooster:{name:"XP Booster",description:"+50% XP gained for first floor",cost:40,consumable:!0,effect:{type:"tempXP",value:.5,duration:"floor"}},emergencyRevive:{name:"Emergency Revive",description:"Auto-revive once at 25% HP",cost:75,consumable:!0,effect:{type:"autoRevive",value:.25,uses:1}}},Lg={startingHealth:{name:"Starting Health +10",description:"Start the show with +10 max health",cost:50,maxLevel:5,tier:1},startingDamage:{name:"Starting Damage +1",description:"Start the show with +1 damage",cost:75,maxLevel:5,tier:1},startingSpeed:{name:"Starting Speed +10",description:"Start the show with +10 speed",cost:60,maxLevel:5,tier:1},xpMagnet:{name:"XP Magnet",description:"+15% XP pickup radius per level",cost:60,maxLevel:5,tier:2},propDurability:{name:"Prop Durability",description:"Props last +2 seconds per level",cost:80,maxLevel:5,tier:2},propDropChance:{name:"Prop Drop Chance",description:"+5% prop drop chance per level",cost:100,maxLevel:5,tier:2},creditBonus:{name:"Credit Bonus",description:"+8% credits earned per level",cost:120,maxLevel:5,tier:2},luckyStart:{name:"Lucky Start",description:"+5% starting crit chance per level",cost:100,maxLevel:4,tier:3},thickSkin:{name:"Thick Skin",description:"+3% damage reduction per level",cost:100,maxLevel:5,tier:3},secondWind:{name:"Second Wind",description:"+5% revive health per level (up to 25%)",cost:150,maxLevel:4,tier:3},bossBounty:{name:"Boss Bounty",description:"+15 bonus credits per boss kill",cost:150,maxLevel:3,tier:3},mulligan:{name:"Mulligan",description:"+1 reroll per run for upgrade drafts",cost:300,maxLevel:3,tier:4},comfortZone:{name:"Comfort Zone",description:"+0.1s invulnerability after hit",cost:200,maxLevel:3,tier:4},toughChoices:{name:"Tough Choices",description:"+1 upgrade option in drafts (4 total)",cost:500,maxLevel:1,tier:4},headStart:{name:"Head Start",description:"Begin each run at level 2",cost:750,maxLevel:1,tier:4}};function zg(e){switch(e){case"characters":return Wt;case"weapons":return ah;case"permanentUpgrades":return Lg;case"cosmetics":return fs;case"boosters":return rh;default:return{}}}const ch="superSmashTexty_save",Og="$",ur={version:1,currency:0,playerName:null,inviteCode:null,totalXP:0,playerLevel:1,selectedPortrait:"default",unlocks:{characters:["survivor"],weapons:["default"],permanentUpgrades:[],portraits:["default"]},permanentUpgradeLevels:{},permanentUpgradePurchaseHistory:{},stats:{totalRuns:0,totalFloorsReached:0,totalRoomsCleared:0,totalEnemiesKilled:0,totalBossesKilled:0,bestFloor:1,bestRoom:1,bestLevel:1,totalCurrencyEarned:0,totalPlayTime:0,fastestRunTime:0},achievements:[],runHistory:[]},qc=20;function mt(){try{const t=localStorage.getItem(ch);if(t){const o=JSON.parse(t),n={...ur,...o};return n.playerName||(n.playerName=dr(),Zt(n)),n.inviteCode||(n.inviteCode=hr(),Zt(n)),n}}catch(t){console.error("Error loading save:",t)}const e={...ur};return e.playerName=dr(),e.inviteCode=hr(),Zt(e),e}function Zt(e){try{return localStorage.setItem(ch,JSON.stringify(e)),!0}catch(t){return console.error("Error saving game:",t),!1}}function Hg(){return mt()}function ps(e){const t=mt();return t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+e),Zt(t),t.currency}function jn(){return mt().currency}function Go(e,t){const o=mt();return o.unlocks[e]&&o.unlocks[e].includes(t)}function lh(e,t){const o=mt();return o.unlocks[e]||(o.unlocks[e]=[]),o.unlocks[e].includes(t)?!1:(o.unlocks[e].push(t),Zt(o),!0)}function Gc(e){mt();let t=!1;for(const[o,n]of Object.entries(Wt))n.unlockRequirement&&n.unlockRequirement.type==="floor"&&e>=n.unlockRequirement.value&&(Go("characters",o)||(lh("characters",o),t=!0));return t}function Ug(e){let t=[];for(const[o,n]of Object.entries(Wt))n.unlockRequirement&&n.unlockRequirement.type==="achievement"&&n.unlockRequirement.value===e&&(Go("characters",o)||(lh("characters",o),t.push({type:"character",key:o,name:n.name})));return t}function xn(){return mt().selectedCharacter||"survivor"}function Kc(e){const t=mt();t.selectedCharacter=e,Zt(t)}function Ct(e){const t=mt();return t.permanentUpgradeLevels||(t.permanentUpgradeLevels={}),t.permanentUpgradeLevels[e]||0}function Ng(e,t,o){const n=mt();return n.currency>=o?(n.currency-=o,n.unlocks[e]||(n.unlocks[e]=[]),n.unlocks[e].includes(t)||n.unlocks[e].push(t),Zt(n),!0):!1}function dh(e){const t=[50,65,90,115,160];return e<t.length?t[e]:160+(e-4)*50}function _g(e,t,o){const n=mt(),s=Ct(e);return o&&s>=o?{success:!1,reason:"maxLevel"}:n.currency<t?{success:!1,reason:"insufficientCurrency"}:(n.currency-=t,n.permanentUpgradeLevels||(n.permanentUpgradeLevels={}),n.permanentUpgradeLevels[e]=(s||0)+1,n.permanentUpgradePurchaseHistory||(n.permanentUpgradePurchaseHistory={}),n.permanentUpgradePurchaseHistory[e]||(n.permanentUpgradePurchaseHistory[e]=[]),n.permanentUpgradePurchaseHistory[e].push(t),n.unlocks.permanentUpgrades||(n.unlocks.permanentUpgrades=[]),n.unlocks.permanentUpgrades.includes(e)||n.unlocks.permanentUpgrades.push(e),Zt(n),{success:!0,newLevel:n.permanentUpgradeLevels[e]})}function Xg(e,t){const o=mt();return o.currency<t?{success:!1,reason:"insufficientCurrency"}:(o.activeBoosters||(o.activeBoosters=[]),o.currency-=t,o.stats&&(o.stats.totalCurrencySpent=(o.stats.totalCurrencySpent||0)+t),o.activeBoosters.push({key:e,purchasedAt:Date.now()}),Zt(o),{success:!0,boosterKey:e})}function Fg(){return(mt().activeBoosters||[]).length}function Yg(){const e=mt(),t=e.activeBoosters||[];return e.activeBoosters=[],Zt(e),t}function hh(){const e=mt();if(e.permanentUpgradePurchaseHistory&&Object.keys(e.permanentUpgradePurchaseHistory).length>0){let t=0;return Object.keys(e.permanentUpgradePurchaseHistory).forEach(o=>{const n=e.permanentUpgradePurchaseHistory[o];n&&Array.isArray(n)&&n.forEach(s=>{t+=s})}),t}if(e.permanentUpgradeLevels&&Object.keys(e.permanentUpgradeLevels).length>0){let t=0;return Object.keys(e.permanentUpgradeLevels).forEach(o=>{const n=e.permanentUpgradeLevels[o]||0;for(let s=0;s<n;s++)t+=dh(s)}),t}return 0}function qg(e){const t=mt(),o=Ct(e);if(o===0)return{success:!1,reason:"noLevels"};let n=0;if(t.permanentUpgradePurchaseHistory&&t.permanentUpgradePurchaseHistory[e]&&t.permanentUpgradePurchaseHistory[e].length>0){const s=t.permanentUpgradePurchaseHistory[e];n=s[s.length-1],s.pop(),s.length===0&&delete t.permanentUpgradePurchaseHistory[e]}else n=dh(o-1);if(t.currency+=n,t.permanentUpgradeLevels[e]=o-1,t.permanentUpgradeLevels[e]===0&&(delete t.permanentUpgradeLevels[e],t.unlocks.permanentUpgrades)){const s=t.unlocks.permanentUpgrades.indexOf(e);s>-1&&t.unlocks.permanentUpgrades.splice(s,1)}return Zt(t),{success:!0,refundAmount:n,newLevel:t.permanentUpgradeLevels[e]||0}}function Gg(){const e=mt(),t=hh();return t===0?{success:!1,reason:"noUpgrades"}:(e.currency+=t,e.permanentUpgradeLevels={},e.permanentUpgradePurchaseHistory={},e.unlocks.permanentUpgrades&&(e.unlocks.permanentUpgrades=[]),Zt(e),{success:!0,refundAmount:t})}function Da(e){const t=mt();t.stats.totalRuns++,t.stats.totalFloorsReached+=e.floorsReached||0,t.stats.totalRoomsCleared+=e.roomsCleared||0,t.stats.totalEnemiesKilled+=e.enemiesKilled||0,t.stats.totalBossesKilled+=e.bossesKilled||0,t.stats.totalCurrencyEarned+=e.currencyEarned||0,e.floorsReached>t.stats.bestFloor&&(t.stats.bestFloor=e.floorsReached),e.roomsCleared>t.stats.bestRoom&&(t.stats.bestRoom=e.roomsCleared),e.level>t.stats.bestLevel&&(t.stats.bestLevel=e.level||1),Zt(t)}function Gr(e){const t=mt();return t.achievements||(t.achievements=[]),t.achievements.includes(e)}function Kg(e){const t=mt();if(t.achievements||(t.achievements=[]),!t.achievements.includes(e)){t.achievements.push(e);const o=ih(e),n=sh(o);return n>0&&(t.currency=Math.min(Number.MAX_SAFE_INTEGER,t.currency+n),console.log(`[MetaProgression] Achievement "${e}" awarded ${n} credits`)),Zt(t),Ug(e).then(s=>{s.length>0&&console.log("[MetaProgression] Achievement unlocked characters:",s)}),!0}return!1}function uh(){return mt().achievements||[]}function Ms(){return mt().stats||ur.stats}function Ca(e){let t=0;t+=e.floorsReached*10,t+=e.roomsCleared*5,t+=Math.floor(e.enemiesKilled*.5),e.floorsReached>=2&&(t+=10),e.floorsReached>=3&&(t+=20),e.floorsReached>=4&&(t+=30),e.enemiesKilled>=50&&(t+=10),e.enemiesKilled>=100&&(t+=20),e.enemiesKilled>=200&&(t+=30);const o=Ct("bossBounty");o>0&&e.bossesKilled>0&&(t+=e.bossesKilled*o*15);const n=Ct("creditBonus");return n>0&&(t=Math.floor(t*(1+n*.08))),Math.floor(t)}function ga(){return Og}function Co(){return mt().playerName||"Player"}function Vc(e){const t=mt();return t.playerName=e,Zt(t),t.playerName}function Zn(){return mt().inviteCode||"000000"}function Vg(e){const t=mt();return t.inviteCode=e,Zt(t),t.inviteCode}function Wg(e){const t=mt();t.runHistory||(t.runHistory=[]);const o={timestamp:Date.now(),character:e.character||"survivor",weapon:e.weapon||"pistol",floorsReached:e.floorsReached||1,roomsCleared:e.roomsCleared||0,enemiesKilled:e.enemiesKilled||0,bossesKilled:e.bossesKilled||0,level:e.level||1,currencyEarned:e.currencyEarned||0,duration:e.duration||0,deathCause:e.deathCause||"Unknown",upgrades:e.upgrades||[],synergies:e.synergies||[]};return t.runHistory.unshift(o),t.runHistory.length>qc&&(t.runHistory=t.runHistory.slice(0,qc)),Zt(t),o}function $g(){return mt().runHistory||[]}function Jg(e){const t=mt();return t.equippedCosmetics&&t.equippedCosmetics[e]||(e==="trail"?"trailNone":e==="death"?"deathNone":"glowNone")}function Wc(e,t){const o=mt();return o.equippedCosmetics||(o.equippedCosmetics={trail:"trailNone",death:"deathNone",glow:"glowNone"}),!t.includes("None")&&!Go("cosmetics",t)?!1:(o.equippedCosmetics[e]=t,Zt(o),!0)}function jg(){return mt().equippedCosmetics||{trail:"trailNone",death:"deathNone",glow:"glowNone"}}function Zi(e){return Math.floor(Math.sqrt(e/100))+1}function fr(e){return e<=1?0:Math.pow(e-1,2)*100}function hi(){const e=mt();return Zi(e.totalXP||0)}function ma(){return mt().totalXP||0}function fh(){const e=hi();return fr(e+1)}function Kr(){const e=ma(),t=Zi(e),o=fr(t),n=fr(t+1);return n===o?1:(e-o)/(n-o)}function Zg(e){const t=mt(),o=Zi(t.totalXP||0);t.totalXP=(t.totalXP||0)+e;const n=Zi(t.totalXP);return t.playerLevel=n,Zt(t),{newXP:t.totalXP,newLevel:n,levelsGained:n-o,oldLevel:o}}function Qg(e){let t=0;return t+=e.floorsReached*50,t+=(e.enemiesKilled||0)*2,t+=(e.bossesKilled||0)*100,e.floorsReached>=5&&(t+=200),e.isDailyRun&&(t+=500),t}function ui(){return mt().selectedPortrait||"default"}function kg(e){const t=mt();return t.selectedPortrait=e,Zt(t),!0}function ph(){return mt().unlocks?.portraits||["default"]}const em=.15,Qi=120,$c=50,Dn=.5,Si=.7,te={systemInitialized:!1,touchInitialized:!1,gamepadConnected:!1,gamepadIndex:null,moveX:0,moveY:0,aimX:0,aimY:0,aimActive:!1,touchEnabled:!1,leftTouch:null,rightTouch:null,leftJoystickCenter:null,rightJoystickCenter:null,leftJoystickBase:null,leftJoystickKnob:null,rightJoystickBase:null,rightJoystickKnob:null,k:null};function Mi(e,t=em){return Math.abs(e)<t?0:(e>0?1:-1)*(Math.abs(e)-t)/(1-t)}function tm(e){if(te.k=e,te.systemInitialized)return;te.systemInitialized=!0,window.addEventListener("gamepadconnected",o=>{console.log("[InputSystem] Gamepad connected:",o.gamepad.id),te.gamepadConnected=!0,te.gamepadIndex=o.gamepad.index}),window.addEventListener("gamepaddisconnected",o=>{console.log("[InputSystem] Gamepad disconnected:",o.gamepad.id),o.gamepad.index===te.gamepadIndex&&(te.gamepadConnected=!1,te.gamepadIndex=null)});const t=navigator.getGamepads();for(let o=0;o<t.length;o++)if(t[o]){console.log("[InputSystem] Found existing gamepad:",t[o].id),te.gamepadConnected=!0,te.gamepadIndex=t[o].index;break}te.touchEnabled="ontouchstart"in window||navigator.maxTouchPoints>0,console.log("[InputSystem] Initialized. Gamepad:",te.gamepadConnected,"Touch:",te.touchEnabled)}function om(){if(!te.gamepadConnected||te.gamepadIndex===null)return;const t=navigator.getGamepads()[te.gamepadIndex];if(!t){te.gamepadConnected=!1,te.gamepadIndex=null;return}te.moveX=Mi(t.axes[0]||0),te.moveY=Mi(t.axes[1]||0);const o=Mi(t.axes[2]||0),n=Mi(t.axes[3]||0);te.aimX=o,te.aimY=n,te.aimActive=Math.abs(o)>0||Math.abs(n)>0}function nm(e){if(!te.touchEnabled)return;if(rm(),te.touchInitialized){Jc(e);return}te.touchInitialized=!0,Jc(e);const t=e.canvas;t.addEventListener("touchstart",sm,{passive:!1}),t.addEventListener("touchmove",im,{passive:!1}),t.addEventListener("touchend",jc,{passive:!1}),t.addEventListener("touchcancel",jc,{passive:!1}),console.log("[InputSystem] Touch controls initialized")}function Jc(e){const t=e.width(),o=e.height(),n=t*.15,s=o*.75,a=t*.85,r=o*.75;te.leftJoystickBase=e.add([e.circle(Qi/2),e.pos(n,s),e.anchor("center"),e.color(100,100,100),e.opacity(Dn),e.fixed(),e.z(1e3),"touchJoystick"]),te.leftJoystickKnob=e.add([e.circle($c/2),e.pos(n,s),e.anchor("center"),e.color(200,200,200),e.opacity(Dn),e.fixed(),e.z(1001),"touchJoystick"]),te.rightJoystickBase=e.add([e.circle(Qi/2),e.pos(a,r),e.anchor("center"),e.color(100,100,100),e.opacity(Dn),e.fixed(),e.z(1e3),"touchJoystick"]),te.rightJoystickKnob=e.add([e.circle($c/2),e.pos(a,r),e.anchor("center"),e.color(255,100,100),e.opacity(Dn),e.fixed(),e.z(1001),"touchJoystick"]),te.leftJoystickCenter={x:n,y:s},te.rightJoystickCenter={x:a,y:r}}function sm(e){e.preventDefault();const t=te.k,o=t.canvas.getBoundingClientRect(),n=t.width()/o.width,s=t.height()/o.height;for(const a of e.changedTouches){const r=(a.clientX-o.left)*n,l=(a.clientY-o.top)*s;r<t.width()/2&&te.leftTouch===null?(te.leftTouch=a.identifier,te.leftJoystickCenter={x:r,y:l},te.leftJoystickBase&&(te.leftJoystickBase.pos.x=r,te.leftJoystickBase.pos.y=l,te.leftJoystickBase.opacity=Si),te.leftJoystickKnob&&(te.leftJoystickKnob.pos.x=r,te.leftJoystickKnob.pos.y=l,te.leftJoystickKnob.opacity=Si)):r>=t.width()/2&&te.rightTouch===null&&(te.rightTouch=a.identifier,te.rightJoystickCenter={x:r,y:l},te.rightJoystickBase&&(te.rightJoystickBase.pos.x=r,te.rightJoystickBase.pos.y=l,te.rightJoystickBase.opacity=Si),te.rightJoystickKnob&&(te.rightJoystickKnob.pos.x=r,te.rightJoystickKnob.pos.y=l,te.rightJoystickKnob.opacity=Si),te.aimActive=!0)}}function im(e){e.preventDefault();const t=te.k,o=t.canvas.getBoundingClientRect(),n=t.width()/o.width,s=t.height()/o.height;for(const a of e.changedTouches){const r=(a.clientX-o.left)*n,l=(a.clientY-o.top)*s;if(a.identifier===te.leftTouch&&te.leftJoystickCenter){const c=r-te.leftJoystickCenter.x,d=l-te.leftJoystickCenter.y,i=Math.sqrt(c*c+d*d),h=Qi/2,u=Math.min(i,h),g=Math.atan2(d,c);te.leftJoystickKnob&&(te.leftJoystickKnob.pos.x=te.leftJoystickCenter.x+Math.cos(g)*u,te.leftJoystickKnob.pos.y=te.leftJoystickCenter.y+Math.sin(g)*u);const p=u/h;te.moveX=Math.cos(g)*p,te.moveY=Math.sin(g)*p}if(a.identifier===te.rightTouch&&te.rightJoystickCenter){const c=r-te.rightJoystickCenter.x,d=l-te.rightJoystickCenter.y,i=Math.sqrt(c*c+d*d),h=Qi/2,u=Math.min(i,h),g=Math.atan2(d,c);te.rightJoystickKnob&&(te.rightJoystickKnob.pos.x=te.rightJoystickCenter.x+Math.cos(g)*u,te.rightJoystickKnob.pos.y=te.rightJoystickCenter.y+Math.sin(g)*u);const p=u/h;te.aimX=Math.cos(g)*p,te.aimY=Math.sin(g)*p,te.aimActive=p>.1}}}function jc(e){e.preventDefault();for(const t of e.changedTouches)t.identifier===te.leftTouch&&(te.leftTouch=null,te.moveX=0,te.moveY=0,te.leftJoystickKnob&&te.leftJoystickCenter&&(te.leftJoystickKnob.pos.x=te.leftJoystickCenter.x,te.leftJoystickKnob.pos.y=te.leftJoystickCenter.y),te.leftJoystickBase&&(te.leftJoystickBase.opacity=Dn),te.leftJoystickKnob&&(te.leftJoystickKnob.opacity=Dn)),t.identifier===te.rightTouch&&(te.rightTouch=null,te.aimX=0,te.aimY=0,te.aimActive=!1,te.rightJoystickKnob&&te.rightJoystickCenter&&(te.rightJoystickKnob.pos.x=te.rightJoystickCenter.x,te.rightJoystickKnob.pos.y=te.rightJoystickCenter.y),te.rightJoystickBase&&(te.rightJoystickBase.opacity=Dn),te.rightJoystickKnob&&(te.rightJoystickKnob.opacity=Dn))}function am(){return{x:te.moveX,y:te.moveY}}function Zc(){return{x:te.aimX,y:te.aimY,active:te.aimActive}}function rm(){const e=te.k;if(e){try{e.get("touchJoystick").forEach(t=>{t&&t.exists()&&e.destroy(t)})}catch{}te.leftJoystickBase=null,te.leftJoystickKnob=null,te.rightJoystickBase=null,te.rightJoystickKnob=null,te.leftTouch=null,te.rightTouch=null,te.moveX=0,te.moveY=0,te.aimX=0,te.aimY=0,te.aimActive=!1}}const pr={pistol:{name:"Basic Pistol",icon:"",char:"",color:[255,255,255],fireRate:3.75,projectileSpeed:300,baseDamage:10,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,category:"balanced",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},smg:{name:"Rapid Fire SMG",icon:"",char:"",color:[100,200,255],fireRate:7.5,projectileSpeed:350,baseDamage:6,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,category:"rapid",upgradeCategories:["damage","fireRate","multiShot","piercing","crit"]},shotgun:{name:"Spread Shotgun",icon:"",char:"",color:[255,200,100],fireRate:2,projectileSpeed:250,baseDamage:8,projectileCount:3,spreadAngle:35,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},sniper:{name:"Sniper Rifle",icon:"",char:"",color:[100,255,255],fireRate:1,projectileSpeed:500,baseDamage:20,projectileCount:1,spreadAngle:0,piercing:1,obstaclePiercing:0,critChance:.05,critDamage:2.5,range:900,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]},flamethrower:{name:"Flame Thrower",icon:"",char:"",color:[255,150,50],fireRate:12.5,projectileSpeed:200,baseDamage:8,projectileCount:1,spreadAngle:15,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:150,category:"area",upgradeCategories:["damage","fireRate","range","spread","dot"]},orbital:{name:"Orbital Weapons",icon:"",char:"",color:[100,200,255],fireRate:0,projectileSpeed:0,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:0,critDamage:1,range:0,orbitRadius:45,rotationSpeed:180,category:"passive",upgradeCategories:["orbitalCount","orbitalSpeed","orbitalRadius","damage"]},explosive:{name:"Explosive Launcher",icon:"",char:"",color:[255,100,50],fireRate:1.5,projectileSpeed:200,baseDamage:25,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:500,explosionRadius:50,explosionDamage:15,category:"area",upgradeCategories:["damage","explosionRadius","explosionDamage","fireRate","range"]},chainLightning:{name:"Chain Lightning",icon:"",char:"",color:[255,255,100],fireRate:3,projectileSpeed:400,baseDamage:12,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:600,chainRange:70,maxJumps:3,chainDamageReduction:.15,category:"multiTarget",upgradeCategories:["damage","chainJumps","chainRange","fireRate","chainDamage"]},boomerang:{name:"Boomerang Blaster",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:250,baseDamage:14,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:400,returnsToPlayer:!0,returnSpeedMultiplier:1.2,category:"multiTarget",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},railgun:{name:"Railgun",icon:"",char:"",color:[150,200,255],fireRate:.33,projectileSpeed:800,baseDamage:50,projectileCount:1,spreadAngle:0,piercing:999,obstaclePiercing:1,critChance:.1,critDamage:3,range:1e3,infinitePierce:!0,category:"precision",upgradeCategories:["damage","crit","critDamage","fireRate","obstaclePiercing"]},spreadShot:{name:"Spread Shot",icon:"",char:"",color:[255,180,100],fireRate:2.5,projectileSpeed:280,baseDamage:6,projectileCount:3,spreadAngle:25,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:450,category:"spread",upgradeCategories:["damage","pelletCount","spread","fireRate","crit"]},homingMissiles:{name:"Homing Missiles",icon:"",char:"",color:[255,100,150],fireRate:1.5,projectileSpeed:180,baseDamage:18,projectileCount:1,spreadAngle:0,piercing:0,obstaclePiercing:0,critChance:.05,critDamage:2,range:700,homing:!0,homingStrength:3,category:"precision",upgradeCategories:["damage","fireRate","range","crit","projectileSpeed"]},plasmaRifle:{name:"Plasma Rifle",icon:"",char:"",color:[100,255,200],fireRate:2,projectileSpeed:350,baseDamage:16,projectileCount:1,spreadAngle:0,piercing:2,obstaclePiercing:0,critChance:.08,critDamage:2.2,range:650,category:"precision",upgradeCategories:["damage","piercing","crit","fireRate","range"]}};function gh(e){return pr[e]||pr.pistol}function cm(e,t){return gh(e).upgradeCategories.includes(t)}const Ls={CANVAS_WIDTH:800,CANVAS_HEIGHT:600,CANVAS_SCALE:1,BACKGROUND_COLOR:[0,0,0],DEBUG_MODE:!1},Zo={COLLISION_SIZE:12,BASE_PICKUP_RADIUS:30,INVULNERABILITY_DURATION:1,IMMUNITY_FLASH_RATE:10,NORMAL_COLOR:[100,150,255],IMMUNITY_ALPHA:.3,ROOM_MARGIN:20},gn={BASE_XP_TO_NEXT_LEVEL:15,XP_SCALING_FACTOR:1.25,STARTING_LEVEL:1,STARTING_XP:0,LEVEL_UP_NOTIFICATION_Y:100,LEVEL_UP_NOTIFICATION_DURATION:.5},En={SURVIVOR_XP_BOOST:1.1,SCOUT_SPEED_BOOST:1.2,SCOUT_DODGE_CHANCE:.1,TANK_HEALTH_BOOST:1.25,TANK_DAMAGE_REDUCTION:.15,SNIPER_CRIT_CHANCE_MULTIPLIER:1.5,SNIPER_CRIT_DAMAGE_MULTIPLIER:1.25,PYRO_FIRE_DOT_MULTIPLIER:1.25},uo={MIN_DAMAGE:1,KNOCKBACK_ENEMY:20,KNOCKBACK_ENEMY_FROM_PROJECTILE:15,KNOCKBACK_MINIBOSS:25,KNOCKBACK_BOSS:10,KNOCKBACK_BOSS_FROM_PROJECTILE:10,BASE_ENEMY_DAMAGE:10,BASE_MINIBOSS_DAMAGE:15,BASE_BOSS_DAMAGE:18,BOSS_ENRAGE_DAMAGE_MULTIPLIER:1.25,MULTISHOT_STAGGER_DELAY:.02,HIT_FLASH_DURATION:.1,CRIT_COLOR:[255,200,0],HIT_COLOR:[255,255,255]},ms={ORBITAL_CONTACT_COOLDOWN:.2,BASE_ORBIT_RADIUS:45,BASE_ROTATION_SPEED:180,DEFAULT_WEAPON_RANGE:750},Gt={XP_LIFETIME:10,XP_PULSE_SPEED:5,XP_PULSE_AMOUNT:.2,XP_COLOR:[100,200,255],CURRENCY_LIFETIME:15,CURRENCY_PULSE_SPEED:4,CURRENCY_PULSE_AMOUNT:.15,CURRENCY_COLOR:[255,215,0],MAGNETIZE_SPEED:800,MAGNETIZE_ACCELERATION:600,COLLECTION_RADIUS:20};function Ra(e,t=0,o=0){const n=e*(1-o);return Math.max(uo.MIN_DAMAGE,n-t)}function lm(e,t=null){return(t?t.next():Math.random())<e}function dm(e,t=2){return Math.floor(e*t)}function Pa(e,t,o,n=null){const s=n||xn(),a=Wt[s]||Wt.survivor,r=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(0,0,0),e.scale(1.15),e.rotate(0),e.z(-1),"playerOutline"]),l=e.add([e.text(a.char,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...a.color),e.rotate(0),e.area(),e.health(a.stats.health),"player"]);l.outline=r,l.characterKey=s,l.characterData=a,l.speed=a.stats.speed,l.originalSpeed=a.stats.speed,l.slowed=!1,l.maxHealth=a.stats.health;const c=Ct("headStart");l.level=c>0?2:gn.STARTING_LEVEL,l.xp=gn.STARTING_XP,l.xpToNext=gn.BASE_XP_TO_NEXT_LEVEL,l.pickupRadius=Zo.BASE_PICKUP_RADIUS,l.invulnerable=!1,l.invulnerableTime=0,l.invulnerableDuration=Zo.INVULNERABILITY_DURATION,l.setHP(l.maxHealth);const d=a.weapon||"pistol",i=gh(d);l.weaponKey=d,l.weaponDef=i,l.baseFireRate=i.fireRate,l.baseProjectileSpeed=i.projectileSpeed,l.baseProjectileDamage=i.baseDamage;const h=a.stats.damage||10,u=i.baseDamage,g=h/10;if(l.fireRate=i.fireRate,l.projectileSpeed=i.projectileSpeed,l.projectileDamage=Math.floor(u*g),l.lastFireTime=0,l.projectileCount=i.projectileCount,l.piercing=i.piercing,l.obstaclePiercing=i.obstaclePiercing,l.critChance=i.critChance,l.critDamage=i.critDamage,l.spreadAngle=i.spreadAngle,l.defense=0,l.weaponRange=i.range,l.weaponCategory=i.category,i.orbitRadius&&(l.orbitRadius=i.orbitRadius,l.rotationSpeed=i.rotationSpeed,l.orbitalOrbs=[],l.orbitalAngles=[]),i.explosionRadius&&(l.explosionRadius=i.explosionRadius,l.explosionDamage=i.explosionDamage),i.chainRange&&(l.chainRange=i.chainRange,l.maxJumps=i.maxJumps,l.chainDamageReduction=i.chainDamageReduction),l.xpMultiplier=1,l.dodgeChance=0,l.damageReduction=0,l.weapons=[d],l.passiveUpgrades=[],l.upgradeStacks={},a.ability==="xpBoost"?l.xpMultiplier=En.SURVIVOR_XP_BOOST:a.ability==="speedBoost"?(l.speed=l.speed*En.SCOUT_SPEED_BOOST,l.originalSpeed=l.speed,l.dodgeChance=En.SCOUT_DODGE_CHANCE):a.ability==="tankStats"?(l.maxHealth=Math.floor(l.maxHealth*En.TANK_HEALTH_BOOST),l.setHP(l.maxHealth),l.damageReduction=En.TANK_DAMAGE_REDUCTION):a.ability==="critBoost"?(l.critChance=(l.critChance||0)*En.SNIPER_CRIT_CHANCE_MULTIPLIER,l.critDamage=(l.critDamage||2)*En.SNIPER_CRIT_DAMAGE_MULTIPLIER):a.ability==="fireDot"&&(l.fireDotMultiplier=En.PYRO_FIRE_DOT_MULTIPLIER),!a.skipPermanentUpgrades){const P=Ct("luckyStart");P>0&&(l.critChance=(l.critChance||0)+P*.05);const f=Ct("thickSkin");f>0&&(l.damageReduction=(l.damageReduction||0)+f*.03);const O=Ct("xpMagnet");O>0&&(l.pickupRadius=Math.floor(l.pickupRadius*(1+O*.15)));const v=Ct("comfortZone");v>0&&(l.invulnerableDuration=l.invulnerableDuration+v*.1)}l.canMove=!0,l.canShoot=!0,l.isDead=!1;let p=e.vec2(0,0),D=document.hasFocus(),m={w:!1,s:!1,a:!1,d:!1,up:!1,down:!1,left:!1,right:!1};l.moveDir=p,e.onKeyDown(["w","up"],()=>{l.isRemote||!D||m.w||m.up||(p.y=-1,l.moveDir=p)}),e.onKeyDown(["s","down"],()=>{l.isRemote||!D||m.s||m.down||(p.y=1,l.moveDir=p)}),e.onKeyDown(["a","left"],()=>{l.isRemote||!D||m.a||m.left||(p.x=-1,l.moveDir=p)}),e.onKeyDown(["d","right"],()=>{l.isRemote||!D||m.d||m.right||(p.x=1,l.moveDir=p)}),e.onKeyRelease(["w","up"],()=>{l.isRemote||(m.w=!1,m.up=!1,!e.isKeyDown("s")&&!e.isKeyDown("down")&&(p.y=0,l.moveDir=p))}),e.onKeyRelease(["s","down"],()=>{l.isRemote||(m.s=!1,m.down=!1,!e.isKeyDown("w")&&!e.isKeyDown("up")&&(p.y=0,l.moveDir=p))}),e.onKeyRelease(["a","left"],()=>{l.isRemote||(m.a=!1,m.left=!1,!e.isKeyDown("d")&&!e.isKeyDown("right")&&(p.x=0,l.moveDir=p))}),e.onKeyRelease(["d","right"],()=>{l.isRemote||(m.d=!1,m.right=!1,!e.isKeyDown("a")&&!e.isKeyDown("left")&&(p.x=0,l.moveDir=p))});const M=()=>{l.isRemote||(D=!1,p.x=0,p.y=0,l.moveDir=p,l.isShooting=!1,m={w:e.isKeyDown("w"),s:e.isKeyDown("s"),a:e.isKeyDown("a"),d:e.isKeyDown("d"),up:e.isKeyDown("up"),down:e.isKeyDown("down"),left:e.isKeyDown("left"),right:e.isKeyDown("right")})},B=()=>{D=!0};return window.addEventListener("blur",M),window.addEventListener("focus",B),l.onDestroy(()=>{window.removeEventListener("blur",M),window.removeEventListener("focus",B)}),l.onUpdate(()=>{if(l.outline&&l.outline.exists()&&(l.outline.pos=l.pos.clone()),e.paused)return;if(l.invulnerable)if(l.invulnerableTime-=e.dt(),l.invulnerableTime<=0)l.invulnerable=!1,l.color=e.rgb(...Zo.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1);else{const T=Zo.IMMUNITY_FLASH_RATE;Math.floor(l.invulnerableTime*T)%2===0?(l.color=e.rgb(...Zo.NORMAL_COLOR),l.outline&&l.outline.exists()&&(l.outline.opacity=1)):(l.color=e.rgb(...Zo.NORMAL_COLOR,Zo.IMMUNITY_ALPHA),l.outline&&l.outline.exists()&&(l.outline.opacity=Zo.IMMUNITY_ALPHA))}if(l.canMove===!1)return;om();let P=p;if(l.isRemote&&l.move)P=e.vec2(l.move.x,l.move.y);else if(!l.isRemote){const T=am();(T.x!==0||T.y!==0)&&(P=e.vec2(T.x,T.y))}if(P.len()>0){const T=P.len(),C=P.scale(1/T).scale(l.speed*e.dt()),S=l.pos.x+C.x,z=l.pos.y+C.y;let L=!0,N=!0;const _=e.get("obstacle"),X=Zo.COLLISION_SIZE;for(const H of _){if(!H.exists())continue;const R=H.pos.x-H.width/2,F=H.pos.x+H.width/2,G=H.pos.y-H.height/2,Q=H.pos.y+H.height/2,le=S-X,se=S+X,ne=l.pos.y-X,ie=l.pos.y+X;se>R&&le<F&&ie>G&&ne<Q&&(L=!1);const fe=l.pos.x-X,Me=l.pos.x+X,Ue=z-X,Ne=z+X;Me>R&&fe<F&&Ne>G&&Ue<Q&&(N=!1)}L&&(l.pos.x=S),N&&(l.pos.y=z)}const f=e.width(),O=e.height(),v=Zo.ROOM_MARGIN;l.pos.x=e.clamp(l.pos.x,v,f-v),l.pos.y=e.clamp(l.pos.y,v,O-v)}),l}const He={peer:null,connections:new Map,isHost:!0,hostId:null,hostConnection:null,messageHandlers:new Map,connectionCallbacks:[],isInitialized:!1,peerId:null};function Vr(e,t=!0){return new Promise((o,n)=>{if(He.isInitialized){console.warn("Network already initialized"),o(e);return}if(window.addEventListener("beforeunload",()=>{Wr()}),typeof Peer>"u"){console.error("PeerJS library not loaded"),n(new Error("PeerJS library not available"));return}He.isHost=t;const s=t?`smash-${e}`:void 0,a=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";let r;a?r={debug:3,host:"localhost",port:9e3,path:"/",secure:!1,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}}:r={debug:2,secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"turn:numb.viagenie.ca",username:"webrtc@live.com",credential:"muazkh"}]}};try{He.peer=new Peer(s,r),He.peer.on("open",l=>{He.peerId=l,He.isInitialized=!0;const c=t&&l.startsWith("smash-")?l.substring(6):l;o(c)}),He.peer.on("error",l=>{if(console.error("Peer error:",l),l.type==="unavailable-id"&&t){if(console.warn("Peer ID already taken - generating new code and retrying..."),He.peer){try{He.peer.destroy()}catch(c){console.warn("Error destroying peer:",c)}He.peer=null,He.peerId=null,He.isInitialized=!1}setTimeout(()=>{const c=hr();Vr(c,t).then(o).catch(n)},2e3);return}l.type==="network"?console.warn("PeerJS server unavailable - multiplayer disabled"):l.type==="peer-unavailable"?console.warn("Host not found - check invite code"):l.type==="server-error"&&console.warn("PeerJS server error - multiplayer may be unavailable"),He.isInitialized||n(new Error(`Multiplayer unavailable: ${l.type||"connection failed"}`))}),t&&He.peer.on("connection",l=>{hm(l)})}catch(l){console.error("Failed to create peer:",l),n(l)}})}function hm(e){He.isHost&&(e.on("open",()=>{He.connections.set(e.peer,e),He.connectionCallbacks.forEach(t=>t("join",e.peer))}),e.on("data",t=>{mh(t,e.peer)}),e.on("close",()=>{He.connections.delete(e.peer),He.connectionCallbacks.forEach(t=>t("leave",e.peer))}),e.on("error",t=>{console.error("Connection error with",e.peer,":",t)}))}function um(e){return new Promise((t,o)=>{if(He.isHost){o(new Error("Host cannot connect to another host"));return}if(!He.isInitialized){o(new Error("Network not initialized"));return}const n=`smash-${e}`;let s,a=!1;const r=He.peer.connect(n,{reliable:!0});s=setTimeout(()=>{a||(console.error("[NetworkSystem] Connection timeout - host may be offline or unreachable"),console.error("[NetworkSystem] This could be due to:"),console.error("  - Host not found (wrong code or host offline)"),console.error("  - Firewall blocking connection"),console.error("  - NAT traversal failure (TURN servers may be overloaded)"),r.close(),o(new Error("Connection timeout - could not reach host")))},3e4),r.on("open",()=>{a=!0,clearTimeout(s),s=null,He.hostConnection=r,He.hostId=n,t()}),r.on("data",l=>{mh(l,n)}),r.on("close",()=>{s&&(clearTimeout(s),s=null),He.hostConnection=null,He.hostId=null,He.connectionCallbacks.forEach(l=>l("host_disconnect"))}),r.on("error",l=>{a=!0,clearTimeout(s),s=null,console.error("[NetworkSystem] Connection error:",l),console.error("[NetworkSystem] Error type:",l.type||"unknown"),o(l)})})}function mh(e,t){if(!e||!e.type){console.warn("Invalid message:",e);return}const o=He.messageHandlers.get(e.type);o?o(e.payload,t):console.warn("No handler for message type:",e.type)}function _e(e,t){He.messageHandlers.set(e,t)}function Pt(e){He.messageHandlers.delete(e)}function yh(e){He.connectionCallbacks.includes(e)||He.connectionCallbacks.push(e)}function po(e,t){if(He.isHost){console.warn("Host cannot send to itself");return}if(!He.hostConnection){console.warn("Not connected to host");return}He.hostConnection.send({type:e,payload:t})}function Ko(e,t,o){if(!He.isHost){console.warn("Only host can send to specific peers");return}const n=He.connections.get(e);n?n.send({type:t,payload:o}):console.warn("No connection to peer:",e)}function Ve(e,t,o=[]){if(!He.isHost){console.warn("Only host can broadcast");return}He.connections.forEach((n,s)=>{o.includes(s)||n.send({type:e,payload:t})})}function Wr(){He.isHost?(He.connections.forEach(e=>e.close()),He.connections.clear()):He.hostConnection&&(He.hostConnection.close(),He.hostConnection=null,He.hostId=null),He.peer&&(He.peer.destroy(),He.peer=null),He.messageHandlers.clear(),He.connectionCallbacks=[],He.isInitialized=!1,He.peerId=null}function fm(){const e=He.peerId&&He.peerId.startsWith("smash-")?He.peerId.substring(6):He.peerId;return{isInitialized:He.isInitialized,isHost:He.isHost,peerId:e,hostId:He.hostId,connectedPeers:Array.from(He.connections.keys()),peerCount:He.connections.size}}const k={slots:[{playerId:"local",playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!0,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1},{playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null,isReady:!1}],isHost:!0,maxSlots:4,peerIdToSlot:new Map,networkInitialized:!1,kaplayInstance:null,hostInviteCode:null,disconnectedPlayers:new Map,reconnectWindow:15e3,countdownActive:!1,countdownStartTime:0,countdownDuration:3e3,activeEmotes:new Map,emoteCallbacks:[]};let ii=!1,ai=!1;async function xh(e=null){if(e&&(k.kaplayInstance=e),k.isHost){const t=Co(),o=Zn(),n=xn(),s=ui();k.slots[0].playerId="local",k.slots[0].playerName=t,k.slots[0].inviteCode=o,k.slots[0].selectedCharacter=n,k.slots[0].selectedPortrait=s,k.slots[0].isLocal=!0,k.slots[0].permanentUpgradeLevels={startingHealth:Ct("startingHealth"),startingDamage:Ct("startingDamage"),startingSpeed:Ct("startingSpeed"),propDurability:Ct("propDurability"),propDropChance:Ct("propDropChance")},console.log("[PartySystem] Host player initialized in slot 0:",{name:k.slots[0].playerName,code:k.slots[0].inviteCode,character:k.slots[0].selectedCharacter})}else console.log("[PartySystem] Client mode - preserving existing slot assignments");if(!k.networkInitialized)try{console.log("[PartySystem] Initializing network as host...");const t=Zn(),o=await Vr(t,!0);o!==t&&(console.log(`[PartySystem] Invite code changed: ${t} -> ${o}`),Vg(o),k.slots[0].inviteCode=o),k.networkInitialized=!0,k.isHost=!0,pm(),console.log("[PartySystem] Network initialized as host - ready to accept connections")}catch(t){console.error("[PartySystem] Failed to initialize network as host:",t),console.log("[PartySystem] Multiplayer disabled - running in single-player mode")}}function pm(){ii||(ii=!0,_e("join_request",(e,t)=>{console.log("[PartySystem] Join request from:",t),console.log("[PartySystem] Payload:",{playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter}),e.playerName||console.warn("[PartySystem] Join request missing playerName, using default");const o=gm(e.playerName||"Player",e.inviteCode||"000000",e.selectedCharacter||"survivor",e.selectedPortrait||"default",t,e.permanentUpgradeLevels||null);if(o!==null){const n={slots:k.slots.map(s=>({playerId:s.playerId,playerName:s.playerName,inviteCode:s.inviteCode,selectedCharacter:s.selectedCharacter,selectedPortrait:s.selectedPortrait,permanentUpgradeLevels:s.permanentUpgradeLevels,isLocal:!1})),yourSlotIndex:o};console.log("[PartySystem] Sending party_sync to new player:",{hostName:n.slots[0].playerName,hostCharacter:n.slots[0].selectedCharacter,newPlayerSlot:o}),Ko(t,"party_sync",n),setTimeout(()=>{ny(t)},250),Fn()}else Ko(t,"join_rejected",{reason:"Party full"})}),_e("player_info",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.playerName&&(k.slots[o].playerName=e.playerName),Fn())}),_e("character_change",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} changed character to:`,e.selectedCharacter),k.slots[o].selectedCharacter=e.selectedCharacter,Fn())}),_e("ready_change",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(console.log(`[PartySystem] Player in slot ${o} ready state:`,e.isReady),k.slots[o].isReady=e.isReady,Fn(),wh())}),_e("party_emote",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.slotIndex=o,$r(e),Ve("party_emote",e))}),_e("profile_request",(e,t)=>{const o=e.targetSlot;if(o===0)vh(e,t);else{const n=k.slots[o]?.peerId;n&&Ko(n,"profile_request",{requestingSlot:k.peerIdToSlot.get(t),forwardTo:t})}}),_e("profile_response",(e,t)=>{const o=k.peerIdToSlot.get(t);o!==void 0&&(e.slotIndex=o,e.forwardTo?Ko(e.forwardTo,"profile_response",e):Eh(e))}),yh((e,t)=>{e==="leave"&&xm(t)}))}function ys(){return k}function Nn(){return k.slots.filter(e=>e.playerId!==null).length}function Qc(){return!k.isHost&&k.hostInviteCode?k.hostInviteCode:Zn()}function gm(e,t,o,n,s,a=null){for(let r=1;r<k.slots.length;r++)if(k.slots[r].playerId===null)return k.slots[r].playerId=`player_${Date.now()}_${r}`,k.slots[r].playerName=e,k.slots[r].inviteCode=t,k.slots[r].selectedCharacter=o,k.slots[r].selectedPortrait=n,k.slots[r].peerId=s,k.slots[r].permanentUpgradeLevels=a,k.peerIdToSlot.set(s,r),r;return null}async function mm(e){const t={playerName:Co(),inviteCode:Zn(),selectedCharacter:xn()};try{console.log("[PartySystem] Joining as client - clearing all party slots");for(let o=0;o<k.slots.length;o++)k.slots[o]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,selectedPortrait:null,isLocal:!1,peerId:null};return k.networkInitialized&&k.isHost&&(console.log("[PartySystem] Switching from host to client - disconnecting current peer..."),Wr(),k.networkInitialized=!1,k.isHost=!1,ii=!1,ai=!1),k.networkInitialized||(await Vr("client",!1),k.networkInitialized=!0,k.isHost=!1),k.hostInviteCode=e,ym(),await um(e),po("join_request",{playerName:t.playerName,inviteCode:t.inviteCode,selectedCharacter:t.selectedCharacter,selectedPortrait:ui()||"default",permanentUpgradeLevels:{startingHealth:Ct("startingHealth"),startingDamage:Ct("startingDamage"),startingSpeed:Ct("startingSpeed"),propDurability:Ct("propDurability"),propDropChance:Ct("propDropChance")}}),!0}catch(o){return console.error("Failed to join party:",o),console.log("[PartySystem] Restoring local player after join failure"),ki(t),!1}}function ki(e){k.networkInitialized&&!k.isHost&&Wr(),k.isHost=!0,k.hostInviteCode=null,k.networkInitialized=!1,ii=!1,ai=!1;for(let t=0;t<k.slots.length;t++)k.slots[t]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null};k.slots[0]={playerId:"local",playerName:e.playerName||Co(),inviteCode:e.inviteCode||Zn(),selectedCharacter:e.selectedCharacter||xn(),isLocal:!0,peerId:null},xh(k.kaplayInstance).catch(t=>{console.warn("[PartySystem] Failed to re-initialize as host:",t)})}function ym(){ai||(ai=!0,_e("party_sync",e=>{console.log("[PartySystem] Received party sync:",{hostName:e.slots[0].playerName,hostCharacter:e.slots[0].selectedCharacter,yourSlot:e.yourSlotIndex,totalSlots:e.slots.filter(o=>o.playerId!==null).length}),k.slots=e.slots,e.yourSlotIndex!==void 0&&(k.slots[e.yourSlotIndex].isLocal=!0,console.log(`[PartySystem] Marked slot ${e.yourSlotIndex} as local`)),k.slots[0].isLocal=!1;const t=k.slots.filter(o=>o.playerId!==null).length;console.log("[PartySystem] Party synced successfully:",{partySize:t,hostInSlot0:k.slots[0].playerName,localSlot:e.yourSlotIndex})}),_e("join_rejected",e=>{console.error("Join rejected:",e.reason),alert(`Failed to join party: ${e.reason}`)}),_e("game_start",e=>{console.log("Host started game - joining..."),k.kaplayInstance?k.kaplayInstance.go("game",{resetState:!0}):console.error("Cannot join game: Kaplay instance not available")}),_e("countdown_start",e=>{console.log("[PartySystem] Countdown started by host:",e.duration),k.countdownActive=!0,k.countdownStartTime=Date.now(),k.countdownDuration=e.duration||3e3}),_e("countdown_cancel",()=>{console.log("[PartySystem] Countdown cancelled by host"),k.countdownActive=!1,k.countdownStartTime=0}),_e("party_update",e=>{const t=k.slots.findIndex(o=>o.isLocal);k.slots=e.slots,t!==-1&&(k.slots[t].isLocal=!0)}),_e("party_emote",e=>{$r(e)}),_e("profile_request",e=>{vh()}),_e("profile_response",e=>{Eh(e)}),yh(e=>{if(e==="host_disconnect"){console.log("[PartySystem] Host disconnected - returning to solo party"),alert("Host disconnected - returning to main menu");const t={playerName:Co(),inviteCode:Zn(),selectedCharacter:xn()};ki(t),k.kaplayInstance&&k.kaplayInstance.go("menu")}}))}function Fn(){k.isHost&&Ve("party_update",{slots:k.slots.map(e=>({playerId:e.playerId,playerName:e.playerName,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter,selectedPortrait:e.selectedPortrait,permanentUpgradeLevels:e.permanentUpgradeLevels,isLocal:!1,isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))})}function kc(){k.isHost&&(console.log("Broadcasting game start to all clients"),Ve("game_start",{}))}function xm(e){const t=k.peerIdToSlot.get(e);if(t!==void 0){console.log("[PartySystem] Player disconnected from slot",t,"- starting reconnection window");const o={...k.slots[t]};k.disconnectedPlayers.set(t,{disconnectTime:Date.now(),playerData:o,peerId:e}),k.slots[t].isDisconnected=!0,Ve("player_disconnected",{slotIndex:t,reconnectWindow:k.reconnectWindow}),k.peerIdToSlot.delete(e),setTimeout(()=>{wm(t)},k.reconnectWindow)}}function wm(e){k.disconnectedPlayers.get(e)&&(console.log("[PartySystem] Reconnection window expired for slot",e,"- removing player"),km(e),bm(e),k.disconnectedPlayers.delete(e),Ve("player_removed",{slotIndex:e}),Fn())}function bm(e){if(e>0&&e<k.slots.length){const t=k.slots[e].peerId;return t&&k.peerIdToSlot.delete(t),k.slots[e]={playerId:null,playerName:null,inviteCode:null,selectedCharacter:null,isLocal:!1,peerId:null,isReady:!1},!0}return!1}function vm(){return k.slots.map((e,t)=>({slotNumber:t+1,isEmpty:e.playerId===null,playerName:e.playerName||"Empty Slot",isLocal:e.isLocal,inviteCode:e.inviteCode,selectedCharacter:e.selectedCharacter||"survivor",selectedPortrait:e.selectedPortrait||"default",isReady:e.isReady||!1,isDisconnected:e.isDisconnected||!1}))}function el(e){k.slots[0].selectedCharacter=e,k.networkInitialized&&(k.isHost?Fn():po("character_change",{selectedCharacter:e}))}function Em(){const e=xs();return e===null?!1:(k.slots[e].isReady=!k.slots[e].isReady,k.networkInitialized&&(k.isHost?(Fn(),wh()):po("ready_change",{isReady:k.slots[e].isReady})),k.slots[e].isReady)}function xs(){const e=k.slots.findIndex(t=>t.isLocal);return e>=0?e:null}function Am(){const e=xs();return e!==null&&k.slots[e].isReady}function tl(){const e=k.slots.filter(t=>t.playerId!==null);return e.length<2?!1:e.every(t=>t.isReady)}function wh(){k.isHost&&(tl()&&!k.countdownActive?Sm():!tl()&&k.countdownActive&&Mm())}function Sm(){k.isHost&&(k.countdownActive=!0,k.countdownStartTime=Date.now(),Ve("countdown_start",{duration:k.countdownDuration}),console.log("[PartySystem] Countdown started"))}function Mm(){k.isHost&&(k.countdownActive=!1,k.countdownStartTime=0,Ve("countdown_cancel",{}),console.log("[PartySystem] Countdown cancelled"))}function ol(){if(!k.countdownActive)return{active:!1,timeRemaining:0};const e=Date.now()-k.countdownStartTime;return{active:!0,timeRemaining:Math.max(0,k.countdownDuration-e)}}function $r(e){const{slotIndex:t,emoteType:o}=e;k.activeEmotes.set(t,{emoteType:o,startTime:Date.now()}),k.emoteCallbacks.forEach(n=>{try{n(t,o)}catch(s){console.error("[PartySystem] Emote callback error:",s)}})}function nl(e){const t=xs();if(t===null)return;const o={slotIndex:t,emoteType:e};$r(o),k.networkInitialized&&(k.isHost?Ve("party_emote",o):po("party_emote",o))}function Tm(e){k.emoteCallbacks.push(e)}function Dm(e){const t=k.emoteCallbacks.indexOf(e);t!==-1&&k.emoteCallbacks.splice(t,1)}function Cm(e,t=2e3){const o=k.activeEmotes.get(e);return o?Date.now()-o.startTime>t?(k.activeEmotes.delete(e),null):o.emoteType:null}function Rm(){k.emoteCallbacks=[],k.activeEmotes.clear(),ii=!1,ai=!1}const Xn=new Map;function bh(){return{playerName:Co(),selectedPortrait:ui(),playerLevel:hi(),totalXP:ma(),stats:Ms(),achievements:uh(),unlockedPortraits:ph()}}function Pm(e,t){const o=k.slots[e];if(!o||o.playerId===null){console.warn("[PartySystem] Cannot request profile for empty slot:",e),t(null);return}if(o.isLocal){t(bh());return}if(Xn.set(e,t),k.isHost){const n=o.peerId;n?Ko(n,"profile_request",{requestingSlot:xs()}):(console.warn("[PartySystem] No peerId for slot:",e),t(null),Xn.delete(e))}else po("profile_request",{targetSlot:e});setTimeout(()=>{if(Xn.has(e)){console.warn("[PartySystem] Profile request timed out for slot:",e);const n=Xn.get(e);Xn.delete(e),n(null)}},5e3)}function vh(e,t=null){const o=bh();k.isHost&&t?Ko(t,"profile_response",{slotIndex:xs(),profileData:o}):po("profile_response",{slotIndex:xs(),profileData:o})}function Eh(e){const{slotIndex:t,profileData:o}=e,n=Xn.get(t);n&&(Xn.delete(t),n(o))}const on={gatekeeper:{name:"Studio Head",coreChar:"GG",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:500,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:125,damageReduction:.3,shieldRegenRate:0},swarmQueen:{name:"Showrunner",coreChar:"QQ",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:800,baseArmorHealth:175,baseShieldHealth:0,baseSpeed:50,size:28,baseXPValue:250,damageReduction:.35,shieldRegenRate:0},twinGuardianMelee:{name:"Co-Host (Melee)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:110,size:28,baseXPValue:175,damageReduction:.3,meleeDamage:22,shieldRegenRate:0},twinGuardianRanged:{name:"Co-Host (Ranged)",coreChar:"",armorChar:"[]",shieldChar:"{}",color:[100,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:600,baseArmorHealth:125,baseShieldHealth:0,baseSpeed:70,size:28,baseXPValue:175,damageReduction:.3,projectileDamage:13,projectileSpeed:250,fireRate:1,shieldRegenRate:0}};function Im(e){return on[e]||on.gatekeeper}function ea(e,t,o,n="gatekeeper",s=1,a=null){const r=Im(n),l=1+(s-1)*.2,c={coreChar:r.coreChar,armorChar:r.armorChar||"()",shieldChar:r.shieldChar||"{}",color:r.color,armorColor:r.armorColor||[200,200,200],shieldColor:r.shieldColor||[100,200,255],health:Math.floor(r.baseHealth*l),armorHealth:Math.floor((r.baseArmorHealth||0)*l),maxArmorHealth:Math.floor((r.baseArmorHealth||0)*l),shieldHealth:Math.floor((r.baseShieldHealth||0)*l),maxShieldHealth:Math.floor((r.baseShieldHealth||0)*l),speed:Math.floor(r.baseSpeed*(1+(s-1)*.05)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),damageReduction:r.damageReduction||0,shieldRegenRate:(r.shieldRegenRate||0)*l};function d(){const h=c.armorHealth>c.maxArmorHealth*.5?"(":"",u=c.armorHealth>0?")":"";return`${h}${c.coreChar}${u}`}const i=e.add([e.text(d(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"boss"]);return i.maxHealth=c.health,i.speed=c.speed,i.xpValue=c.xpValue,i.type=n,i.floor=s,i.textSize=c.size,i.rng=a,r.meleeDamage&&(i.meleeDamage=r.meleeDamage),r.projectileDamage&&(i.projectileDamage=r.projectileDamage),r.projectileSpeed&&(i.projectileSpeed=r.projectileSpeed),r.fireRate&&(i.fireRate=r.fireRate),(n==="twinGuardianMelee"||n==="twinGuardianRanged")&&(i.enraged=!1,i.enrage=function(){this.enraged||(this.enraged=!0,this.speed=Math.floor(this.speed*1.5),this.type==="twinGuardianMelee"?(this.chargeCooldownTimer=0,this.meleeDamage=Math.floor(this.meleeDamage*1.25)):(this.fireRate=this.fireRate*1.5,this.projectileDamage=Math.floor(this.projectileDamage*1.25)),this.color=e.rgb(255,200,0))}),i.armorHealth=c.armorHealth,i.maxArmorHealth=c.maxArmorHealth,i.damageReduction=c.damageReduction,i.coreChar=c.coreChar,i.armorChar=c.armorChar,i.armorColor=c.armorColor,i.shieldHealth=c.shieldHealth,i.maxShieldHealth=c.maxShieldHealth,i.shieldRegenRate=c.shieldRegenRate,i.shieldChar=c.shieldChar,i.shieldColor=c.shieldColor,i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.updateVisual=function(){let h="",u="",g="",p="";if(i.shieldHealth>0){const m=i.shieldHealth/i.maxShieldHealth;m>.66?(h="",u=""):m>.33?(h="",u=""):(h="",u="")}if(i.armorHealth>0){const m=i.armorHealth/i.maxArmorHealth;m>.66?(g="",p=""):m>.33?(g="",p=""):(g="",p="")}const D=`${h}${g}${i.coreChar}${p}${u}`;i.text=D,i.shieldHealth>0?i.color=e.rgb(...c.shieldColor):i.color=e.rgb(...c.color)},i.takeDamage=function(h){let u=!1,g=!1;const p=i.shieldHealth,D=i.armorHealth;i.lastDamageTime=e.time();const m=3;if(i.shieldRegenCooldown=m,i.shieldHealth>0){const M=Math.min(h,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-M),u=i.shieldHealth!==p;const B=h-M;B>0&&i.takeDamageInternal(B)}else i.takeDamageInternal(h);g=i.armorHealth!==D,(u||g)&&i.updateVisual()},i.takeDamageInternal=function(h){if(i.armorHealth>0){const u=Math.floor(h*(1-i.damageReduction)),g=Math.min(u,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-g);const p=h-u;if(p>0){const D=i.armorHealth>0?1-i.damageReduction:1,m=Math.floor(p*D);i.hurt(m)}}else i.hurt(h)},i.attackTimer=0,i.minionSpawnTimer=0,i.chargeCooldownTimer=0,i.chargeDurationTimer=0,i.radialBurstTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeSpeed=0,i.spawnedMinions=[],i.enraged=!1,i.twinPartner=null,i.getPhase=function(){const h=i.hp()/i.maxHealth;return h>.75?1:h>.5?2:3},i.spawnMinions=function(){if(!i.exists())return;const h=i.getPhase(),u=h===1?2:3;for(let g=0;g<u;g++){const p=i.rng?i.rng.next()*.5:Math.random()*.5,D=Math.PI*2/u*g+p,M=40+(i.rng?i.rng.next()*20:Math.random()*20),B=i.pos.x+Math.cos(D)*M,P=i.pos.y+Math.sin(D)*M,O=(i.rng?i.rng.next():Math.random())<.5?"rusher":"basic",v=In(e,B,P,O,s);v.isBossMinion=!0,i.spawnedMinions.push(v),he()&&me()&&Yo(v,{type:O,floor:s,isBossMinion:!0})}},i.radialBurst=function(){if(!i.exists())return;const h=[e.vec2(0,-1),e.vec2(.707,-.707),e.vec2(1,0),e.vec2(.707,.707),e.vec2(0,1),e.vec2(-.707,.707),e.vec2(-1,0),e.vec2(-.707,-.707)];i.getPhase();const u=200,g=12;h.forEach(p=>{const D=Ro(e,i.pos.x,i.pos.y,p,u,g,0,0,!1);D.isBossProjectile=!0,D.color=e.rgb(255,100,100)})},i.startCharge=function(h){if(!i.exists())return;i.isCharging=!0;const u=e.vec2(h.x-i.pos.x,h.y-i.pos.y);if(u.len()>0&&(i.chargeDirection=u.unit(),!i.chargeSpeed||i.chargeSpeed===0)){const g=i.getPhase?i.getPhase():1;i.chargeSpeed=i.speed*(g===1?2.5:g===2?3:3.5)}},i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const M=1;if(i.shieldRegenTimer>=M){const B=i.shieldRegenRate*M;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+B),i.shieldRegenTimer=0,i.shieldHealth>0&&i.updateVisual()}}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!he()||me())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color,i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&i.updateVisual()}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const h=e.get("player")[0];if(!h||!h.exists())return;const u=i.getPhase();if(i.type==="gatekeeper"){i.attackTimer+=e.dt(),i.minionSpawnTimer+=e.dt(),i.radialBurstTimer+=e.dt();const M=u===1?8:u===2?6:5,B=10,P=u===1?8:u===2?6:5;if(i.isCharging){const f=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=f.x,i.pos.y+=f.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{i.chargeCooldownTimer+=e.dt();const f=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y);if(f.len()>0){const v=f.unit(),T=i.speed*(u===1?1:u===2?1.2:1.5),x=v.scale(T*e.dt()),C=i.pos.x+x.x,S=i.pos.y+x.y;let z=!0,L=!0;const N=e.get("obstacle"),_=i.size||14;for(const X of N){if(!X.exists())continue;const H=X.pos.x-X.width/2,R=X.pos.x+X.width/2,F=X.pos.y-X.height/2,G=X.pos.y+X.height/2,Q=C-_,le=C+_,se=i.pos.y-_,ne=i.pos.y+_;le>H&&Q<R&&ne>F&&se<G&&(z=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0));const ie=i.pos.x-_,fe=i.pos.x+_,Me=S-_,Ue=S+_;fe>H&&ie<R&&Ue>F&&Me<G&&(L=!1,i.isCharging&&(i.isCharging=!1,i.chargeTimer=0))}z&&(i.pos.x=C),L&&(i.pos.y=S)}i.minionSpawnTimer>=M&&(i.spawnMinions(),i.minionSpawnTimer=0),i.chargeCooldownTimer>=B&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{i.exists()&&(i.color=e.rgb(...c.color),i.startCharge(h.pos))}),i.chargeCooldownTimer=0),i.radialBurstTimer>=P&&(i.radialBurst(),i.radialBurstTimer=0)}}else if(i.type==="twinGuardianMelee"){i.attackTimer+=e.dt(),i.chargeCooldownTimer+=e.dt();const M=8,B=150,P=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),f=P.len();if(i.isCharging){const O=i.chargeDirection.scale(i.chargeSpeed*e.dt());i.pos.x+=O.x,i.pos.y+=O.y,i.chargeDurationTimer+=e.dt(),i.chargeDurationTimer>=1.2&&(i.isCharging=!1,i.chargeDurationTimer=0,i.chargeCooldownTimer=0)}else{if(f>0){const O=P.unit(),v=i.speed*(i.enraged?1.5:1),T=O.scale(v*e.dt()),x=i.pos.x+T.x,C=i.pos.y+T.y;let S=!0,z=!0;const L=e.get("obstacle"),N=i.size||14;for(const _ of L){if(!_.exists())continue;const X=_.pos.x-_.width/2,H=_.pos.x+_.width/2,R=_.pos.y-_.height/2,F=_.pos.y+_.height/2,G=x-N,Q=x+N,le=i.pos.y-N,se=i.pos.y+N;Q>X&&G<H&&se>R&&le<F&&(S=!1);const ne=i.pos.x-N,ie=i.pos.x+N,fe=C-N,Me=C+N;ie>X&&ne<H&&Me>R&&fe<F&&(z=!1)}S&&(i.pos.x=x),z&&(i.pos.y=C)}i.chargeCooldownTimer>=M&&f<B&&(i.color=e.rgb(255,255,0),e.wait(.3,()=>{if(i.exists()){i.color=e.rgb(...c.color);const O=i.enraged?3.5:2.5;i.chargeSpeed=i.speed*O,i.startCharge(h.pos)}}),i.chargeCooldownTimer=0)}}else if(i.type==="twinGuardianRanged"){i.attackTimer+=e.dt();const M=200,B=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),P=B.len();if(P>0){const O=B.unit();let v=i.speed*(i.enraged?1.5:1);if(P<M){const T=O.scale(-v*e.dt()),x=i.pos.x+T.x,C=i.pos.y+T.y;let S=!0,z=!0;const L=e.get("obstacle"),N=i.size||14;for(const _ of L){if(!_.exists())continue;const X=_.pos.x-_.width/2,H=_.pos.x+_.width/2,R=_.pos.y-_.height/2,F=_.pos.y+_.height/2,G=x-N,Q=x+N,le=i.pos.y-N,se=i.pos.y+N;Q>X&&G<H&&se>R&&le<F&&(S=!1);const ne=i.pos.x-N,ie=i.pos.x+N,fe=C-N,Me=C+N;ie>X&&ne<H&&Me>R&&fe<F&&(z=!1)}S&&(i.pos.x=x),z&&(i.pos.y=C)}else if(P>M*1.5){const T=O.scale(v*e.dt()),x=i.pos.x+T.x,C=i.pos.y+T.y;let S=!0,z=!0;const L=e.get("obstacle"),N=i.size||14;for(const _ of L){if(!_.exists())continue;const X=_.pos.x-_.width/2,H=_.pos.x+_.width/2,R=_.pos.y-_.height/2,F=_.pos.y+_.height/2,G=x-N,Q=x+N,le=i.pos.y-N,se=i.pos.y+N;Q>X&&G<H&&se>R&&le<F&&(S=!1);const ne=i.pos.x-N,ie=i.pos.x+N,fe=C-N,Me=C+N;ie>X&&ne<H&&Me>R&&fe<F&&(z=!1)}S&&(i.pos.x=x),z&&(i.pos.y=C)}}const f=1/(i.fireRate*(i.enraged?1.5:1));if(i.attackTimer>=f){if(P>0){const O=B.unit(),v=Ro(e,i.pos.x,i.pos.y,O,i.projectileSpeed,i.projectileDamage*(i.enraged?1.25:1),0,0,!1);v.isBossProjectile=!0,v.color=e.rgb(100,150,255)}i.attackTimer=0}}else if(i.type==="swarmQueen"){i.minionSpawnTimer+=e.dt();const M=i.hp()/i.maxHealth;let B;M>.66?B=5:M>.33?B=3:B=2;const P=i.spawnedMinions.filter(L=>L.exists()&&L.hp()>0);if(i.minionSpawnTimer>=B&&P.length<8){const L=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",N=(i.rng?i.rng.next():Math.random())*Math.PI*2,_=50+(i.rng?i.rng.next():Math.random())*30,X=i.pos.x+Math.cos(N)*_,H=i.pos.y+Math.sin(N)*_,R=In(e,X,H,L,s);R.isBossMinion=!0,i.spawnedMinions.push(R),i.spawnedMinions=i.spawnedMinions.filter(F=>F.exists()),i.minionSpawnTimer=0}const O=e.width()/2,v=e.height()/2,T=150,x=e.vec2(O-i.pos.x,v-i.pos.y),C=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y),S=C.len();let z=e.vec2(0,0);if(x.len()>30&&(z=z.add(x.unit().scale(.5))),S<T&&(z=z.add(C.unit().scale(-1))),z.len()>0){const N=z.unit().scale(i.speed*e.dt()),_=i.pos.x+N.x,X=i.pos.y+N.y;let H=!0,R=!0;const F=e.get("obstacle"),G=i.size||14;for(const Q of F){if(!Q.exists())continue;const le=Q.pos.x-Q.width/2,se=Q.pos.x+Q.width/2,ne=Q.pos.y-Q.height/2,ie=Q.pos.y+Q.height/2,fe=_-G,Me=_+G,Ue=i.pos.y-G,Ne=i.pos.y+G;Me>le&&fe<se&&Ne>ne&&Ue<ie&&(H=!1);const Pe=i.pos.x-G,Ge=i.pos.x+G,Te=X-G,ut=X+G;Ge>le&&Pe<se&&ut>ne&&Te<ie&&(R=!1)}H&&(i.pos.x=_),R&&(i.pos.y=X)}}else{const M=e.vec2(h.pos.x-i.pos.x,h.pos.y-i.pos.y);if(M.len()>0){const f=M.unit().scale(i.speed*e.dt()),O=i.pos.x+f.x,v=i.pos.y+f.y;let T=!0,x=!0;const C=e.get("obstacle"),S=i.size||14;for(const z of C){if(!z.exists())continue;const L=z.pos.x-z.width/2,N=z.pos.x+z.width/2,_=z.pos.y-z.height/2,X=z.pos.y+z.height/2,H=O-S,R=O+S,F=i.pos.y-S,G=i.pos.y+S;R>L&&H<N&&G>_&&F<X&&(T=!1);const Q=i.pos.x-S,le=i.pos.x+S,se=v-S,ne=v+S;le>L&&Q<N&&ne>_&&se<X&&(x=!1)}T&&(i.pos.x=O),x&&(i.pos.y=v)}}const g=e.width(),p=e.height(),D=20,m=i.size||14;i.pos.x=e.clamp(i.pos.x,D+m,g-D-m),i.pos.y=e.clamp(i.pos.y,D+m,p-D-m)}),i.isDead=!1,i.onDeath(()=>{he()&&me()&&i.mpEntityId&&oc({entityId:i.mpEntityId,entityType:"boss",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue})}),n==="swarmQueen"&&i.onDeath(()=>{const h=8+Math.floor((i.rng?i.rng.next():Math.random())*5);for(let u=0;u<h;u++){const g=Math.PI*2/h*u+(i.rng?i.rng.next():Math.random())*.3,p=40+(i.rng?i.rng.next():Math.random())*20,D=i.pos.x+Math.cos(g)*p,m=i.pos.y+Math.sin(g)*p,M=(i.rng?i.rng.next():Math.random())<.5?"fast":"basic",B=In(e,D,m,M,s);B.isBossMinion=!0}}),i.updateVisual(),he()&&me()&&(Yo(i,{type:n,floor:s,isBoss:!0}),i.enemyType=n),i}function Bm(e,t,o,n=1,s=null){const a=ea(e,t.pos.x,t.pos.y,"twinGuardianMelee",n,s),r=ea(e,o.pos.x,o.pos.y,"twinGuardianRanged",n,s);return a.twinPartner=r,r.twinPartner=a,a.onDeath(()=>{r&&r.exists()&&!r.enraged&&(r.enrage(),he()&&me()&&dl(r.networkId))}),r.onDeath(()=>{a&&a.exists()&&!a.enraged&&(a.enrage(),he()&&me()&&dl(a.networkId))}),[a,r]}const zn={orbital:{weaponKey:"orbital",name:"Orbital Weapons",duration:30,isTimeBased:!0,dropChance:.15,icon:"",color:[100,200,255]},explosive:{weaponKey:"explosive",name:"Explosive Launcher",ammo:20,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,100,50]},chainLightning:{weaponKey:"chainLightning",name:"Chain Lightning",ammo:25,isAmmoBased:!0,dropChance:.12,icon:"",color:[255,255,100]}};function Lm(e,t=1){if(!["heavyTank","golem","shieldBearer","spawner","mage"].includes(e))return null;const n=1+(t-1)*.1,a=Ct("propDropChance")*.05;for(const[r,l]of Object.entries(zn)){const c=l.dropChance*n+a,d=Math.min(c,1);if(Math.random()<d)return r}return null}function Ia(e,t){const o=zn[t];if(!o)return;const n=pr[o.weaponKey];if(n){if(e.originalWeapon||(e.originalWeapon={weaponKey:e.weaponKey,weaponDef:e.weaponDef,fireRate:e.fireRate,projectileSpeed:e.projectileSpeed,projectileDamage:e.projectileDamage,projectileCount:e.projectileCount,piercing:e.piercing,obstaclePiercing:e.obstaclePiercing,critChance:e.critChance,critDamage:e.critDamage,spreadAngle:e.spreadAngle,weaponRange:e.weaponRange,weaponCategory:e.weaponCategory},e.orbitRadius&&(e.originalWeapon.orbitRadius=e.orbitRadius),e.rotationSpeed&&(e.originalWeapon.rotationSpeed=e.rotationSpeed),e.explosionRadius&&(e.originalWeapon.explosionRadius=e.explosionRadius),e.explosionDamage&&(e.originalWeapon.explosionDamage=e.explosionDamage),e.chainRange&&(e.originalWeapon.chainRange=e.chainRange),e.maxJumps&&(e.originalWeapon.maxJumps=e.maxJumps),e.chainDamageReduction&&(e.originalWeapon.chainDamageReduction=e.chainDamageReduction)),e.powerupWeapon=t,e.weaponKey=o.weaponKey,e.weaponDef=n,e.fireRate=n.fireRate,e.projectileSpeed=n.projectileSpeed,e.projectileDamage=n.baseDamage,e.projectileCount=n.projectileCount,e.piercing=n.piercing,e.obstaclePiercing=n.obstaclePiercing,e.critChance=n.critChance,e.critDamage=n.critDamage,e.spreadAngle=n.spreadAngle,e.weaponRange=n.range,e.weaponCategory=n.category,n.orbitRadius&&(e.orbitRadius=n.orbitRadius,e.rotationSpeed=n.rotationSpeed,e.orbitalOrbs=[],e.orbitalAngles=[],e.orbitalNeedsReinit=!0),n.explosionRadius&&(e.explosionRadius=n.explosionRadius,e.explosionDamage=n.explosionDamage),n.chainRange&&(e.chainRange=n.chainRange,e.maxJumps=n.maxJumps,e.chainDamageReduction=n.chainDamageReduction),o.isAmmoBased)e.powerupAmmo=o.ammo,e.powerupDuration=null;else if(o.isTimeBased){const a=Ct("propDurability")*2;e.powerupDuration=o.duration+a,e.powerupAmmo=null}}}function gr(e){if(!e.originalWeapon)return;const t=e.originalWeapon;e.weaponKey=t.weaponKey,e.weaponDef=t.weaponDef,e.fireRate=t.fireRate,e.projectileSpeed=t.projectileSpeed,e.projectileDamage=t.projectileDamage,e.projectileCount=t.projectileCount,e.piercing=t.piercing,e.obstaclePiercing=t.obstaclePiercing,e.critChance=t.critChance,e.critDamage=t.critDamage,e.spreadAngle=t.spreadAngle,e.weaponRange=t.weaponRange,e.weaponCategory=t.weaponCategory,t.orbitRadius&&(e.orbitRadius=t.orbitRadius),t.rotationSpeed&&(e.rotationSpeed=t.rotationSpeed),t.explosionRadius&&(e.explosionRadius=t.explosionRadius),t.explosionDamage&&(e.explosionDamage=t.explosionDamage),t.chainRange&&(e.chainRange=t.chainRange),t.maxJumps&&(e.maxJumps=t.maxJumps),t.chainDamageReduction&&(e.chainDamageReduction=t.chainDamageReduction),e.weaponKey!=="orbital"&&e.orbitalOrbs&&(e.orbitalOrbs=[],e.orbitalAngles=[]),e.powerupWeapon=null,e.powerupAmmo=null,e.powerupDuration=null,e.originalWeapon=null}function zm(e,t=0){if(!e.powerupWeapon)return!1;const o=zn[e.powerupWeapon];return o&&(o.isAmmoBased&&e.powerupAmmo!==null&&e.powerupAmmo<=0||o.isTimeBased&&e.powerupDuration!==null&&(e.powerupDuration-=t,e.powerupDuration<=0))?(he()&&me()&&e.slotIndex!==void 0&&ul(e.slotIndex,e.powerupWeapon),gr(e),!0):!1}function Om(e){if(!e.powerupWeapon)return;const t=zn[e.powerupWeapon];t&&t.isAmmoBased&&e.powerupAmmo!==null&&(e.powerupAmmo=Math.max(0,e.powerupAmmo-1))}function Hm(e){if(!e.powerupWeapon)return null;const t=zn[e.powerupWeapon];return t?{name:t.name,icon:t.icon,color:t.color,ammo:e.powerupAmmo,duration:e.powerupDuration,isAmmoBased:t.isAmmoBased,isTimeBased:t.isTimeBased}:null}function Gs(e,t,o,n){const s=e.add([e.text("+",{size:16}),e.pos(t,o),e.anchor("center"),e.color(...Gt.XP_COLOR),e.area(),e.scale(1),"xpPickup"]);return s.value=n,s.lifetime=Gt.XP_LIFETIME,s.age=0,s.collected=!1,s.magnetizing=!1,s.magnetizeSpeed=0,s.targetPlayer=null,s.isFlyingToUI=!1,s.velocityY=-150-Math.random()*100,s.gravity=600,s.groundY=o,s.bounceDamping=.5,s.bouncing=!0,s.onUpdate(()=>{if(s.isFlyingToUI){const l=e.vec2(e.width()/2,e.height()-18).sub(s.pos);l.len()<10?e.destroy(s):s.pos=s.pos.add(l.unit().scale(1e3*e.dt()));return}if(e.paused){const r=Math.sin(s.age*Gt.XP_PULSE_SPEED)*Gt.XP_PULSE_AMOUNT;s.scale=e.vec2(1+r);return}s.age+=e.dt();const a=Math.sin(s.age*Gt.XP_PULSE_SPEED)*Gt.XP_PULSE_AMOUNT;if(s.scale=e.vec2(1+a),!s.magnetizing&&s.bouncing&&(s.velocityY+=s.gravity*e.dt(),s.pos.y+=s.velocityY*e.dt(),s.pos.y>=s.groundY&&(s.pos.y=s.groundY,s.velocityY=-s.velocityY*s.bounceDamping,Math.abs(s.velocityY)<20&&(s.bouncing=!1,s.velocityY=0))),s.magnetizing&&s.targetPlayer&&s.targetPlayer.exists()){s.bouncing=!1;const r=e.vec2(s.targetPlayer.pos.x-s.pos.x,s.targetPlayer.pos.y-s.pos.y),l=r.len();if(l>0){const c=r.scale(1/l);s.magnetizeSpeed=Math.min(s.magnetizeSpeed+Gt.MAGNETIZE_ACCELERATION*e.dt(),Gt.MAGNETIZE_SPEED),s.pos=s.pos.add(c.scale(s.magnetizeSpeed*e.dt()))}}s.age>=s.lifetime&&e.destroy(s)}),s.pickupType="xp",he()&&me()&&ec(s,{type:"xpPickup",value:n}),he()&&s.onDestroy(()=>{tc(s)}),s}const sl=["$","","","","","","",""];function Ni(){return sl[Math.floor(Math.random()*sl.length)]}function Ks(e,t,o,n,s=null){const a=s||Ni(),r=e.add([e.text(a,{size:9}),e.pos(t,o),e.anchor("center"),e.color(...Gt.CURRENCY_COLOR),e.area(),e.scale(1),e.opacity(1),"currencyPickup"]);return r.value=n,r.lifetime=Gt.CURRENCY_LIFETIME,r.age=0,r.collected=!1,r.magnetizing=!1,r.magnetizeSpeed=0,r.targetPlayer=null,r.isFlyingToUI=!1,r.velocityY=-150-Math.random()*100,r.gravity=600,r.groundY=o,r.bounceDamping=.5,r.bouncing=!0,r.onUpdate(()=>{if(r.isFlyingToUI){const i=e.vec2(e.width()-20,20).sub(r.pos);i.len()<10?e.destroy(r):r.pos=r.pos.add(i.unit().scale(1e3*e.dt()));return}if(e.paused){const d=Math.sin(r.age*Gt.CURRENCY_PULSE_SPEED)*Gt.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+d);return}r.age+=e.dt();const l=Math.sin(r.age*Gt.CURRENCY_PULSE_SPEED)*Gt.CURRENCY_PULSE_AMOUNT;r.scale=e.vec2(1+l);const c=r.lifetime-r.age;if(c<=4&&c>0){const d=4+(4-c)*2,i=Math.sin(r.age*d*Math.PI*2);r.opacity=.65+i*.35,i>0?r.color=e.rgb(255,255,200):r.color=e.rgb(...Gt.CURRENCY_COLOR)}else r.opacity=1;if(!r.magnetizing&&r.bouncing&&(r.velocityY+=r.gravity*e.dt(),r.pos.y+=r.velocityY*e.dt(),r.pos.y>=r.groundY&&(r.pos.y=r.groundY,r.velocityY=-r.velocityY*r.bounceDamping,Math.abs(r.velocityY)<20&&(r.bouncing=!1,r.velocityY=0))),r.magnetizing&&r.targetPlayer&&r.targetPlayer.exists()){r.bouncing=!1;const d=e.vec2(r.targetPlayer.pos.x-r.pos.x,r.targetPlayer.pos.y-r.pos.y),i=d.len();if(i>0){const h=d.scale(1/i);r.magnetizeSpeed=Math.min(r.magnetizeSpeed+Gt.MAGNETIZE_ACCELERATION*e.dt(),Gt.MAGNETIZE_SPEED),r.pos=r.pos.add(h.scale(r.magnetizeSpeed*e.dt()))}}r.age>=r.lifetime&&e.destroy(r)}),r.pickupType="currency",he()&&me()&&ec(r,{type:"currencyPickup",value:n,icon:a}),he()&&r.onDestroy(()=>{tc(r)}),r}function il(e,t,o,n){const s=zn[n];if(!s)return null;const a=e.add([e.text(s.icon,{size:24}),e.pos(t,o),e.anchor("center"),e.color(...s.color),e.area(),e.scale(1),"powerupWeaponPickup"]);return a.powerupKey=n,a.lifetime=Gt.CURRENCY_LIFETIME,a.age=0,a.collected=!1,a.magnetizing=!1,a.magnetizeSpeed=0,a.targetPlayer=null,a.velocityY=-150-Math.random()*100,a.gravity=600,a.groundY=o,a.bounceDamping=.5,a.bouncing=!0,a.onUpdate(()=>{if(e.paused){const l=Math.sin(a.age*4)*.15;a.scale=e.vec2(1+l),a.angle=Math.sin(a.age*2)*10;return}a.age+=e.dt();const r=Math.sin(a.age*4)*.15;if(a.scale=e.vec2(1+r),a.angle=Math.sin(a.age*2)*10,!a.magnetizing&&a.bouncing&&(a.velocityY+=a.gravity*e.dt(),a.pos.y+=a.velocityY*e.dt(),a.pos.y>=a.groundY&&(a.pos.y=a.groundY,a.velocityY=-a.velocityY*a.bounceDamping,Math.abs(a.velocityY)<20&&(a.bouncing=!1,a.velocityY=0))),a.magnetizing&&a.targetPlayer&&a.targetPlayer.exists()){a.bouncing=!1;const l=e.vec2(a.targetPlayer.pos.x-a.pos.x,a.targetPlayer.pos.y-a.pos.y),c=l.len();if(c>0){const d=l.scale(1/c);a.magnetizeSpeed=Math.min(a.magnetizeSpeed+Gt.MAGNETIZE_ACCELERATION*e.dt(),Gt.MAGNETIZE_SPEED),a.pos=a.pos.add(d.scale(a.magnetizeSpeed*e.dt()))}}a.age>=a.lifetime&&e.destroy(a)}),a.pickupType="powerup",he()&&me()&&ec(a),he()&&a.onDestroy(()=>{tc(a)}),a}class mn{constructor(t){this.seed=t>>>0,this.originalSeed=this.seed}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}range(t,o){return o<=t?(console.warn(`SeededRandom.range: Invalid range [${t}, ${o}). Returning min.`),t):Math.floor(t+this.next()*(o-t))}rangeFloat(t,o){return t+this.next()*(o-t)}choose(t){if(!(!t||t.length===0))return t[this.range(0,t.length)]}shuffle(t){const o=[...t];for(let n=o.length-1;n>0;n--){const s=this.range(0,n+1);[o[n],o[s]]=[o[s],o[n]]}return o}probability(t){return this.next()<t}reset(){this.seed=this.originalSeed}getState(){return this.seed}setState(t){this.seed=t>>>0}}function Jr(...e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e[o]|0;return t>>>0}function Um(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)|0;return t>>>0}const as={peers:new Map,localLatency:0,lastPingId:0,lastPingSentTime:0,handlersRegistered:!1};function Nm(){as.handlersRegistered||(as.handlersRegistered=!0,_e("ping",(e,t)=>{me()?Ko(t,"pong",{pingId:e.pingId,serverTime:Date.now()}):po("pong",{pingId:e.pingId,serverTime:Date.now()})}),_e("pong",(e,t)=>{const o=Date.now(),n=e.pingId;if(me()){const s=as.peers.get(t);if(s&&s.pingId===n){const a=o-s.lastPingTime;s.latency=a}}else as.lastPingId===n&&(as.localLatency=o-as.lastPingSentTime)}))}const wt={damage:10,fireRate:10,speed:10,health:10,projectileSpeed:10,xpGain:10,pickupRadius:10,multiShot:5,piercing:5,obstaclePiercing:5,critChance:10,critDamage:10,spreadShot:5,pelletCount:5,range:5,dot:10,orbitalCount:5,orbitalSpeed:10,orbitalRadius:10,explosionRadius:10,explosionDamage:10,chainJumps:5,chainRange:10,chainDamage:10,defense:10,lifesteal:5,dodgeChance:5,thorns:5,aoeSize:10,knockback:5,magnetRange:10,invulnTime:5,moveDamage:5,lowHealthDmg:5,killSpeed:5},ws={damage:{name:"Damage Boost",icon:"",description:"+25% damage",category:"weapon",upgradeCategory:"damage",maxStacks:10,getDescription:e=>`+25% damage${e>0?` (${e}/${wt.damage})`:""}`,apply:e=>{const t=e.upgradeStacks?.damage||0,o=e.baseProjectileDamage||e.weaponDef?.baseDamage||10,n=Math.pow(1.25,t);e.projectileDamage=Math.floor(o*n)}},fireRate:{name:"Fire Rate",icon:"",description:"+20% fire rate",category:"weapon",upgradeCategory:"fireRate",maxStacks:10,getDescription:e=>`+20% fire rate${e>0?` (${e}/${wt.fireRate})`:""}`,apply:e=>{const t=e.upgradeStacks?.fireRate||0,o=e.baseFireRate||e.weaponDef?.fireRate||1.5,n=Math.pow(1.2,t);e.fireRate=o*n}},speed:{name:"Movement Speed",icon:"",description:"+15% movement speed",category:"passive",maxStacks:10,getDescription:e=>`+15% movement speed${e>0?` (${e}/${wt.speed})`:""}`,apply:e=>{const t=e.upgradeStacks?.speed||0,o=e.characterData?.stats?.speed||150,n=Math.pow(1.15,t);e.speed=Math.floor(o*n),e.originalSpeed=e.speed}},health:{name:"Max Health",icon:"",description:"+20 max HP",category:"passive",maxStacks:10,getDescription:e=>`+20 max HP${e>0?` (${e}/${wt.health})`:""}`,apply:e=>{const t=e.upgradeStacks?.health||0,o=e.characterData?.stats?.health||100,n=t*20,s=e.maxHealth;e.maxHealth=o+n;const a=e.maxHealth-s;a>0&&e.setHP(e.hp()+a)}},projectileSpeed:{name:"Projectile Speed",icon:"",description:"+25% projectile speed",category:"weapon",maxStacks:10,getDescription:e=>`+25% projectile speed${e>0?` (${e}/${wt.projectileSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.projectileSpeed||0,o=e.baseProjectileSpeed||e.weaponDef?.projectileSpeed||300,n=Math.pow(1.25,t);e.projectileSpeed=Math.floor(o*n)}},xpGain:{name:"XP Gain",icon:"",description:"+15% XP from enemies",category:"passive",maxStacks:10,getDescription:e=>`+15% XP from enemies${e>0?` (${e}/${wt.xpGain})`:""}`,apply:e=>{const t=e.upgradeStacks?.xpGain||0,o=e.characterData?.ability==="xpBoost"?1.1:1;e.xpMultiplier=o+t*.15}},pickupRadius:{name:"Pickup Radius",icon:"",description:"+50% pickup range",category:"passive",maxStacks:10,getDescription:e=>`+50% pickup range${e>0?` (${e}/${wt.pickupRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.pickupRadius||0,o=30,n=Math.pow(1.5,t);e.pickupRadius=Math.floor(o*n)}},multiShot:{name:"Multi-Shot",icon:"",description:"+1 projectile per shot",category:"weapon",upgradeCategory:"multiShot",validWeapons:["pistol","smg","sniper"],maxStacks:5,getDescription:e=>`+1 projectile per shot${e>0?` (${e}/${wt.multiShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.multiShot||0,o=e.weaponDef?.projectileCount||1;e.projectileCount=o+t}},piercing:{name:"Piercing",icon:"",description:"+1 enemy penetration",category:"weapon",upgradeCategory:"piercing",maxStacks:5,getDescription:e=>`+1 enemy penetration${e>0?` (${e}/${wt.piercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.piercing||0,o=e.weaponDef?.piercing||0;e.piercing=o+t}},obstaclePiercing:{name:"Obstacle Piercing",icon:"",description:"+1 obstacle penetration",category:"weapon",maxStacks:5,getDescription:e=>`+1 obstacle penetration${e>0?` (${e}/${wt.obstaclePiercing})`:""}`,apply:e=>{const t=e.upgradeStacks?.obstaclePiercing||0,o=e.weaponDef?.obstaclePiercing||0;e.obstaclePiercing=o+t}},critChance:{name:"Critical Strike",icon:"",description:"+10% crit chance",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+10% crit chance${e>0?` (${e}/${wt.critChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.critChance||0;let n=(e.weaponDef?.critChance||.05)+t*.1;e.characterData?.ability==="critBoost"&&(n*=1.5),e.critChance=n}},critDamage:{name:"Critical Power",icon:"",description:"+50% crit damage",category:"weapon",upgradeCategory:"crit",maxStacks:10,getDescription:e=>`+50% crit damage${e>0?` (${e}/${wt.critDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.critDamage||0;let n=(e.weaponDef?.critDamage||2)+t*.5;e.characterData?.ability==="critBoost"&&(n*=1.25),e.critDamage=n}},spreadShot:{name:"Spread Shot",icon:"",description:"+30 spread angle",category:"weapon",upgradeCategory:"spread",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+30 spread angle${e>0?` (${e}/${wt.spreadShot})`:""}`,apply:e=>{const t=e.upgradeStacks?.spreadShot||0,o=e.weaponDef?.spreadAngle||0;e.spreadAngle=o+t*30}},pelletCount:{name:"More Pellets",icon:"",description:"+1 pellet per shot",category:"weapon",upgradeCategory:"pelletCount",validWeapons:["shotgun"],maxStacks:5,getDescription:e=>`+1 pellet per shot${e>0?` (${e}/${wt.pelletCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.pelletCount||0,o=e.weaponDef?.projectileCount||3;e.projectileCount=o+t}},range:{name:"Extended Range",icon:"",description:"+25% weapon range",category:"weapon",upgradeCategory:"range",validWeapons:["sniper","flamethrower","explosive"],maxStacks:5,getDescription:e=>`+25% weapon range${e>0?` (${e}/${wt.range})`:""}`,apply:e=>{const t=e.upgradeStacks?.range||0,o=e.weaponDef?.range||600,n=Math.pow(1.25,t);e.weaponRange=Math.floor(o*n)}},dot:{name:"Burn Damage",icon:"",description:"+25% fire damage over time",category:"weapon",upgradeCategory:"dot",validWeapons:["flamethrower"],maxStacks:10,getDescription:e=>`+25% fire damage over time${e>0?` (${e}/${wt.dot})`:""}`,apply:e=>{const t=e.upgradeStacks?.dot||0,o=e.characterData?.ability==="fireDot"?1.25:1;e.fireDotMultiplier=o+t*.25}},orbitalCount:{name:"Extra Orb",icon:"",description:"+1 orbital orb",category:"weapon",upgradeCategory:"orbitalCount",validWeapons:["orbital"],maxStacks:5,getDescription:e=>`+1 orbital orb${e>0?` (${e}/${wt.orbitalCount})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalCount||0,o=e.weaponDef?.projectileCount||1;e.projectileCount=o+t,e.weaponKey==="orbital"&&e.orbitalOrbs&&(e.orbitalNeedsReinit=!0)}},orbitalSpeed:{name:"Faster Orbit",icon:"",description:"+50% orbital rotation speed",category:"weapon",upgradeCategory:"orbitalSpeed",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+50% orbital rotation speed${e>0?` (${e}/${wt.orbitalSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalSpeed||0,o=e.weaponDef?.rotationSpeed||180,n=Math.pow(1.5,t);e.rotationSpeed=o*n}},orbitalRadius:{name:"Wider Orbit",icon:"",description:"+20% orbital radius",category:"weapon",upgradeCategory:"orbitalRadius",validWeapons:["orbital"],maxStacks:10,getDescription:e=>`+20% orbital radius${e>0?` (${e}/${wt.orbitalRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.orbitalRadius||0,o=e.weaponDef?.orbitRadius||45,n=Math.pow(1.2,t);e.orbitRadius=Math.floor(o*n)}},explosionRadius:{name:"Bigger Explosion",icon:"",description:"+25% explosion radius",category:"weapon",upgradeCategory:"explosionRadius",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion radius${e>0?` (${e}/${wt.explosionRadius})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionRadius||0,o=e.weaponDef?.explosionRadius||50,n=Math.pow(1.25,t);e.explosionRadius=Math.floor(o*n)}},explosionDamage:{name:"Explosive Power",icon:"",description:"+25% explosion damage",category:"weapon",upgradeCategory:"explosionDamage",validWeapons:["explosive"],maxStacks:10,getDescription:e=>`+25% explosion damage${e>0?` (${e}/${wt.explosionDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.explosionDamage||0,o=e.weaponDef?.explosionDamage||15,n=Math.pow(1.25,t);e.explosionDamage=Math.floor(o*n)}},chainJumps:{name:"More Chains",icon:"",description:"+1 chain jump",category:"weapon",upgradeCategory:"chainJumps",validWeapons:["chainLightning"],maxStacks:5,getDescription:e=>`+1 chain jump${e>0?` (${e}/${wt.chainJumps})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainJumps||0,o=e.weaponDef?.maxJumps||3;e.maxJumps=o+t}},chainRange:{name:"Longer Chain",icon:"",description:"+25% chain range",category:"weapon",upgradeCategory:"chainRange",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`+25% chain range${e>0?` (${e}/${wt.chainRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainRange||0,o=e.weaponDef?.chainRange||70,n=Math.pow(1.25,t);e.chainRange=Math.floor(o*n)}},chainDamage:{name:"Chain Power",icon:"",description:"-10% damage reduction per jump",category:"weapon",upgradeCategory:"chainDamage",validWeapons:["chainLightning"],maxStacks:10,getDescription:e=>`-10% damage reduction per jump${e>0?` (${e}/${wt.chainDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.chainDamage||0,o=e.weaponDef?.chainDamageReduction||.15;e.chainDamageReduction=Math.max(.05,o-t*.1)}},defense:{name:"Armor",icon:"",description:"+2 damage reduction",category:"passive",maxStacks:10,getDescription:e=>`+2 damage reduction${e>0?` (${e}/${wt.defense})`:""}`,apply:e=>{const t=e.upgradeStacks?.defense||0,o=e.characterData?.ability==="tankStats"?.15:0;e.defense=o+t*2}},lifesteal:{name:"Life Drain",icon:"",description:"Heal 2% of damage dealt",category:"passive",maxStacks:5,getDescription:e=>`Heal ${(e||1)*2}% of damage dealt${e>0?` (${e}/${wt.lifesteal})`:""}`,apply:e=>{const t=e.upgradeStacks?.lifesteal||0;e.lifestealPercent=t*.02}},dodgeChance:{name:"Evasion",icon:"",description:"+5% dodge chance",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% dodge chance${e>0?` (${e}/${wt.dodgeChance})`:""}`,apply:e=>{const t=e.upgradeStacks?.dodgeChance||0,o=e.characterData?.ability==="dodgeChance"?.1:0;e.dodgeChance=o+t*.05}},thorns:{name:"Thorns",icon:"",description:"Reflect 15% damage to attackers",category:"passive",maxStacks:5,getDescription:e=>`Reflect ${(e||1)*15}% damage${e>0?` (${e}/${wt.thorns})`:""}`,apply:e=>{const t=e.upgradeStacks?.thorns||0;e.thornsPercent=t*.15}},aoeSize:{name:"Blast Radius",icon:"",description:"+15% explosion/area size",category:"weapon",upgradeCategory:"explosionRadius",maxStacks:10,getDescription:e=>`+${(e||1)*15}% AoE size${e>0?` (${e}/${wt.aoeSize})`:""}`,apply:e=>{const t=e.upgradeStacks?.aoeSize||0;if(e.aoeSizeMultiplier=1+t*.15,e.explosionRadius){const o=e.weaponDef?.explosionRadius||50;e.explosionRadius=Math.floor(o*e.aoeSizeMultiplier)}}},knockback:{name:"Impact Force",icon:"",description:"+20% knockback",category:"weapon",maxStacks:5,getDescription:e=>`+${(e||1)*20}% knockback${e>0?` (${e}/${wt.knockback})`:""}`,apply:e=>{const t=e.upgradeStacks?.knockback||0;e.knockbackMultiplier=1+t*.2}},magnetRange:{name:"Treasure Hunter",icon:"",description:"+25% pickup radius",category:"passive",maxStacks:10,getDescription:e=>`+${(e||1)*25}% pickup radius${e>0?` (${e}/${wt.magnetRange})`:""}`,apply:e=>{const t=e.upgradeStacks?.magnetRange||0,o=30,n=e.upgradeStacks?.pickupRadius||0,s=Math.pow(1.5,n);e.pickupRadius=Math.floor(o*s*(1+t*.25))}},invulnTime:{name:"Iron Skin",icon:"",description:"+0.15s invulnerability frames",category:"passive",maxStacks:5,getDescription:e=>`+${((e||1)*.15).toFixed(2)}s invuln${e>0?` (${e}/${wt.invulnTime})`:""}`,apply:e=>{const t=e.upgradeStacks?.invulnTime||0,o=1;e.invulnerableDuration=o+t*.15}},moveDamage:{name:"Momentum",icon:"",description:"+2% damage per speed stack",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*2}% damage per speed stack${e>0?` (${e}/${wt.moveDamage})`:""}`,apply:e=>{const t=e.upgradeStacks?.moveDamage||0;e.moveDamageBonus=t*.02}},lowHealthDmg:{name:"Desperation",icon:"",description:"+5% damage per 10% missing HP",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*5}% damage per 10% missing HP${e>0?` (${e}/${wt.lowHealthDmg})`:""}`,apply:e=>{const t=e.upgradeStacks?.lowHealthDmg||0;e.lowHealthDmgBonus=t*.05}},killSpeed:{name:"Bloodlust",icon:"",description:"+3% speed for 3s on kill",category:"passive",maxStacks:5,getDescription:e=>`+${(e||1)*3}% speed for 3s on kill${e>0?` (${e}/${wt.killSpeed})`:""}`,apply:e=>{const t=e.upgradeStacks?.killSpeed||0;e.killSpeedBonus=t*.03,e.killSpeedDuration=3,e.killSpeedStacks=0,e.killSpeedTimer=0}}};function _m(e,t){if(e.category==="passive"){const o=t.upgradeStacks?.[e.key]||0,n=e.maxStacks||wt[e.key]||10;return!(o>=n)}if(e.category==="weapon"){const o=t.upgradeStacks?.[e.key]||0,n=e.maxStacks||wt[e.key]||10;if(o>=n)return!1;const s=t.characterData?.weapon||t.weaponKey||"pistol";return e.validWeapons?e.validWeapons.includes(s):e.upgradeCategory?cm(s,e.upgradeCategory):!0}return!0}function Xm(e=3,t=null,o=null){let s=Object.keys(ws).map(c=>({key:c,...ws[c],type:"upgrade"})),a=s;t&&(a=s.filter(c=>_m(c,t))),a.length<e&&(a=s);const r=[],l=new Set;for(;r.length<e&&r.length<a.length;){const c=o?o.range(0,a.length):Math.floor(Math.random()*a.length),d=a[c];l.has(d.key)||(l.add(d.key),r.push(d))}return r}function jr(e,t){const o=ws[t];o&&(o.category==="passive"&&(e.passiveUpgrades.includes(t)||e.passiveUpgrades.push(t)),e.upgradeStacks||(e.upgradeStacks={}),e.upgradeStacks[t]=(e.upgradeStacks[t]||0)+1,ta(e))}function ta(e){Object.keys(ws).forEach(t=>{e.upgradeStacks&&e.upgradeStacks[t]>0&&ws[t].apply(e)})}function Fm(e,t){if(!e)return"";if(e.getDescription){const o=t?.upgradeStacks?.[e.key]||0;return e.getDescription(o)}return e.weaponKey&&e.getDescription?e.getDescription():e.description}const Hn={BUTTON:{SM:{width:120,height:30},MD:{width:160,height:36},LG:{width:280,height:45},XL:{width:320,height:50}}},Z={H1:24,H2:18,BODY:16,SMALL:14,TINY:12,MICRO:11,TITLE:36,HEADER:24,LABEL:18,BUTTON:20,HUD:16},y={PRIMARY:[80,180,80],PRIMARY_HOVER:[120,220,120],SECONDARY:[80,120,200],SECONDARY_HOVER:[120,160,255],TERTIARY:[180,80,180],TERTIARY_HOVER:[220,120,220],GOLD:[200,150,50],GOLD_HOVER:[240,190,90],NEUTRAL:[100,100,120],NEUTRAL_HOVER:[140,140,160],DANGER:[180,50,50],DANGER_HOVER:[220,90,90],SUCCESS:[100,255,100],WARNING:[255,200,100],ERROR:[255,100,100],INFO:[100,200,255],TEXT_PRIMARY:[255,255,255],TEXT_SECONDARY:[200,200,200],TEXT_TERTIARY:[150,150,150],TEXT_DISABLED:[100,100,100],BG_DARK:[20,20,30],BG_MEDIUM:[40,40,50],BG_LIGHT:[60,60,70],BG_DISABLED:[60,60,60],BORDER:[150,180,255],BORDER_HOVER:[255,255,255],BORDER_ACTIVE:[100,200,255],HEALTH_FULL:[100,255,100],HEALTH_MEDIUM:[255,255,100],HEALTH_LOW:[255,100,100],XP_BAR:[100,200,255],BOSS_NAME:[255,200,100],MINIBOSS_NAME:[255,150,100]},rs={WIDTH:300,HEIGHT:50,HOVER_SCALE:1.05},_i={HEALTH:"HP",FLOOR:"Floor",DAMAGE:"Damage",SPEED:"Speed"};function ri(e){return e.toUpperCase()}function al(e,t){return`${e}/${t}`}const b={BACKGROUND:0,GAME_ENTITIES:10,PARTICLES:50,UI_BACKGROUND:100,UI_ELEMENTS:200,UI_TEXT:300,OVERLAY:500,MODAL:1500,TOOLTIP:2e3,PAUSE_MENU:2001,DEBUG:9999},zs=["$","","","","","","",""];function fi(e,t={}){const{patternCount:o=12,particleCount:n=20,includeCursorFollowers:s=!1}=t,a=["","","","","","","",""];for(let r=0;r<o;r++){const l=e.add([e.text(a[Math.floor(Math.random()*a.length)],{size:20}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.15),e.scale(1),e.z(b.PARTICLES)]);l.pulseTime=Math.random()*Math.PI*2,l.pulseSpeed=1+Math.random()*2,l.onUpdate(()=>{l.pulseTime+=e.dt()*l.pulseSpeed;const c=.8+Math.sin(l.pulseTime)*.3;l.scale=e.vec2(c,c),l.opacity=.1+Math.abs(Math.sin(l.pulseTime))*.15})}for(let r=0;r<n;r++){const l=e.add([e.text(["*","+","",""][Math.floor(Math.random()*4)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.3+Math.random()*.3),e.z(b.PARTICLES)]);l.speed=10+Math.random()*20,l.onUpdate(()=>{l.pos.y+=l.speed*e.dt(),l.pos.y>e.height()&&(l.pos.y=0,l.pos.x=Math.random()*e.width())})}if(s){const r=[];e.loop(5,()=>{if(r.length<3&&Math.random()<.3){const l=["","","","","","",""],c=e.add([e.text(l[Math.floor(Math.random()*l.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(100+Math.random()*100,100+Math.random()*100,200+Math.random()*55),e.opacity(.4+Math.random()*.2),e.rotate(Math.random()*360),e.z(b.PARTICLES)]);c.followSpeed=20+Math.random()*30,c.rotationSpeed=50+Math.random()*100,c.lifetime=15+Math.random()*10,c.onUpdate(()=>{const i=e.mousePos().sub(c.pos),h=i.len();if(h>5){const u=i.scale(1/h);c.pos=c.pos.add(u.scale(c.followSpeed*e.dt()))}if(c.angle+=c.rotationSpeed*e.dt(),c.lifetime-=e.dt(),c.lifetime<=0){e.destroy(c);const u=r.indexOf(c);u>-1&&r.splice(u,1)}}),r.push(c)}})}}const Ym={CONTESTANTS:["           ","    ","                              ","                            ","                      ","                           "],MERCH:["       ","   ","       ","       ","      ","          "],OPTIONS:["        ","  ","             ","             ","            ","                 "],"RATINGS AND RECORDS":["                           ","            ","                               ","                              ","                         ","                                  "],PROFILE:["         ","     ","            ","             ","            ","              "]};function pi(e,t,o,n,s=8){function a(u,g,p){g/=100,p/=100;const D=(1-Math.abs(2*p-1))*g,m=D*(1-Math.abs(u/60%2-1)),M=p-D/2;let B=0,P=0,f=0;return u>=0&&u<60?(B=D,P=m,f=0):u>=60&&u<120?(B=m,P=D,f=0):u>=120&&u<180?(B=0,P=D,f=m):u>=180&&u<240?(B=0,P=m,f=D):u>=240&&u<300?(B=m,P=0,f=D):u>=300&&u<360&&(B=D,P=0,f=m),[Math.round((B+M)*255),Math.round((P+M)*255),Math.round((f+M)*255)]}const r=ri(t),l=Ym[r];if(!l){console.warn(`ASCII art not found for "${r}", using plain text`);const u=e.add([e.text(r,{size:s*2,font:"monospace"}),e.pos(o,n),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"animatedTitle"]);let g=0;return u.onUpdate(()=>{g+=e.dt();const p=g*50%360,D=a(p,80,60);u.color=e.rgb(...D);const m=Math.sin(g*2)*2;u.pos.y=n+m}),[u]}const c=[],d=10,i=n-l.length*d/2;l.forEach((u,g)=>{const p=e.add([e.text(u,{size:s,font:"monospace"}),e.pos(o,i+g*d),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"animatedTitle"]);c.push(p)});let h=0;return e.onUpdate(()=>{h+=e.dt(),c.forEach((u,g)=>{const p=(h*50+g*20)%360,D=a(p,80,60);u.color=e.rgb(...D);const m=Math.sin(h*2+g*.3)*2;u.pos.y=i+g*d+m,Math.random()<.001&&(u.pos.x=o+(Math.random()-.5)*10,e.wait(.1,()=>{u.exists()&&(u.pos.x=o)}))})}),c}function Zr(e,t,o){const n=()=>2+Math.random()*3,s=e.add([e.text(`${zs[0]}: ${t}`,{size:Z.LABEL}),e.pos(0,0),e.opacity(0),e.fixed()]),a=s.width+30,r=40;e.destroy(s);const l=e.add([e.rect(a,r),e.pos(e.width()-20,20),e.anchor("topright"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(b.UI_BACKGROUND)]),c=e.add([e.text(`${zs[0]}: ${t}`,{size:Z.LABEL}),e.pos(e.width()-20-a/2,40),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);c.symbolIndex=0,c.timeSinceLastChange=0,c.currentCurrency=t,c.symbolChangeInterval=n();const d=i=>{c.currentCurrency=i,c.text=`${zs[c.symbolIndex]}: ${i}`;const h=c.width+30;Math.abs(h-a)>10&&(l.width=h,c.pos.x=e.width()-20-h/2)};return c.onUpdate(()=>{c.timeSinceLastChange+=e.dt(),c.timeSinceLastChange>=c.symbolChangeInterval&&(c.timeSinceLastChange=0,c.symbolIndex=(c.symbolIndex+1)%zs.length,c.text=`${zs[c.symbolIndex]}: ${c.currentCurrency}`,c.symbolChangeInterval=n())}),{panel:l,text:c,updateCurrency:d}}const ht={queue:[],activeToasts:[],k:null,maxActiveToasts:3,toastWidth:300,toastHeight:80,toastMargin:10,animationDuration:.3,displayDuration:3};function Qr(e){ht.k=e,ht.queue=[],ht.activeToasts=[]}function Ah(e){if(!ht.k){console.warn("Toast system not initialized");return}const o={title:e.title||"Notification",message:e.message||"",icon:e.icon||"!",iconColor:e.iconColor||y.TEXT_PRIMARY,type:e.type||"info",duration:e.duration||ht.displayDuration};ht.queue.push(o),Sh()}function qm(e){const t=Uo[e.difficulty]||Uo.normal;let o=" Achievement Unlocked!";e.difficulty==="challenge"?o=" Challenge Complete!":e.difficulty==="benchmark"&&(o=" Milestone Reached!"),Ah({title:o,message:`${e.name}
${e.description}`,icon:e.icon,iconColor:t,type:"achievement",duration:5,difficulty:e.difficulty})}function Gm(e,t){const o=Uo[t.difficulty]||Uo.normal;Ah({title:`${e} unlocked:`,message:t.name,icon:t.icon,iconColor:o,type:"achievement",duration:3})}function Sh(){if(ht.k)for(;ht.queue.length>0&&ht.activeToasts.length<ht.maxActiveToasts;){const t=ht.queue.shift();Km(t)}}function Km(e){const t=ht.k;if(!t)return;const o=t.width()+ht.toastWidth,n=t.width()-ht.toastMargin-ht.toastWidth/2,s=ht.activeToasts.length,a=ht.toastMargin+s*(ht.toastHeight+ht.toastMargin)+ht.toastHeight/2+20;let r=y.BORDER,l=[...y.BG_MEDIUM],c=2;e.type==="achievement"?(r=e.iconColor,l=[35,30,45],c=3):e.type==="success"?r=y.SUCCESS:e.type==="error"&&(r=y.ERROR);const d=t.add([t.rect(ht.toastWidth,ht.toastHeight),t.pos(o,a),t.anchor("center"),t.color(...l),t.outline(c,t.rgb(...r)),t.opacity(.95),t.fixed(),t.z(b.TOOLTIP),"toast"]);if(e.type==="achievement"){let B=0;d.onUpdate(()=>{B+=t.dt();const P=Math.sin(B*4)*.2+.8,f=Math.min(255,r[0]*P),O=Math.min(255,r[1]*P),v=Math.min(255,r[2]*P);d.outline.color=t.rgb(f,O,v)})}const i=t.add([t.rect(50,ht.toastHeight-10),t.pos(o-ht.toastWidth/2+30,a),t.anchor("center"),t.color(...l),t.opacity(.5),t.fixed(),t.z(b.TOOLTIP+1),"toast"]),h=e.type==="achievement"?32:28,u=t.add([t.text(e.icon,{size:h}),t.pos(o-ht.toastWidth/2+30,a),t.anchor("center"),t.color(...e.iconColor),t.fixed(),t.z(b.TOOLTIP+2),"toast"]);if(e.type==="achievement"){let B=0;const P=a;u.onUpdate(()=>{B+=t.dt();const f=Math.abs(Math.sin(B*3))*3;u.pos.y=P-f})}const g=t.add([t.text(e.title,{size:14}),t.pos(o-ht.toastWidth/2+65,a-20),t.anchor("left"),t.color(...e.type==="achievement"?[255,220,100]:y.TEXT_PRIMARY),t.fixed(),t.z(b.TOOLTIP+2),"toast"]),p=e.message.split(`
`),D=[];p.forEach((B,P)=>{const f=t.add([t.text(B,{size:12,width:ht.toastWidth-80}),t.pos(o-ht.toastWidth/2+65,a-5+P*16),t.anchor("left"),t.color(...y.TEXT_SECONDARY),t.fixed(),t.z(b.TOOLTIP+2),"toast"]);D.push(f)});const m={container:d,iconBg:i,icon:u,title:g,messages:D,startX:o,targetX:n,y:a,state:"entering",timer:0,data:e};ht.activeToasts.push(m);const M=t.onUpdate(()=>{if(m.state==="done"){M.cancel();return}if(m.timer+=t.dt(),m.state==="entering"){const B=Math.min(m.timer/ht.animationDuration,1),P=$m(B),f=cl(m.startX,m.targetX,P);rl(m,f),B>=1&&(m.state="visible",m.timer=0)}else if(m.state==="visible")m.timer>=m.data.duration&&(m.state="exiting",m.timer=0);else if(m.state==="exiting"){const B=Math.min(m.timer/ht.animationDuration,1),P=Jm(B),f=t.width()+ht.toastWidth,O=cl(m.targetX,f,P);rl(m,O);const v=1-B;m.container.opacity=v*.95,m.iconBg.opacity=v*.5,m.icon.opacity=v,m.title.opacity=v,m.messages.forEach(T=>T.opacity=v),B>=1&&(m.state="done",Vm(m))}});m.updateHandler=M}function rl(e,t){const o=t-e.container.pos.x;e.container.pos.x=t,e.iconBg.pos.x+=o,e.icon.pos.x+=o,e.title.pos.x+=o,e.messages.forEach(n=>n.pos.x+=o)}function Vm(e){const t=ht.k;if(!t)return;e.updateHandler&&e.updateHandler.cancel(),e.container.exists()&&t.destroy(e.container),e.iconBg.exists()&&t.destroy(e.iconBg),e.icon.exists()&&t.destroy(e.icon),e.title.exists()&&t.destroy(e.title),e.messages.forEach(n=>{n.exists()&&t.destroy(n)});const o=ht.activeToasts.indexOf(e);o>-1&&ht.activeToasts.splice(o,1),Wm(),Sh()}function Wm(){ht.activeToasts.forEach((e,t)=>{if(e.state==="visible"||e.state==="entering"){const o=ht.toastMargin+t*(ht.toastHeight+ht.toastMargin)+ht.toastHeight/2+20,n=e.container.pos.y,s=o-n;e.container.pos.y=o,e.iconBg.pos.y+=s,e.icon.pos.y+=s,e.title.pos.y+=s,e.messages.forEach((a,r)=>{a.pos.y+=s}),e.y=o}})}function $m(e){return 1-Math.pow(1-e,3)}function Jm(e){return e*e*e}function cl(e,t,o){return e+(t-e)*o}const U={isActive:!1,players:new Map,localPlayerSlot:0,lastSyncTime:0,syncInterval:1/15,lastResyncTime:0,resyncInterval:5,inputBuffer:[],isHost:!1,enemies:new Map,projectiles:new Map,pickups:new Map,nextEntityId:1,k:null,gameSeed:0,floorRng:null,roomRng:null,currentFloor:1,currentRoom:{x:0,y:0},pendingXP:0,onGameSeedCallback:null};function jm(e,t=0,o=null,n=null){U.isActive=!0,U.isHost=e,U.localPlayerSlot=t,U.players.clear(),U.inputBuffer=[],U.lastSyncTime=0,U.k=o,Nm(),U.enemies.clear(),U.projectiles.clear(),U.pickups.clear(),U.nextEntityId=1,n!==null?U.gameSeed=n:e&&(U.gameSeed=Math.floor(Math.random()*4294967295)),U.floorRng=new mn(U.gameSeed),U.currentFloor=1,U.currentRoom={x:0,y:0},e?Zm():(oa=!1,Qm())}function Zm(){mr||(mr=!0,_e("player_input",(e,t)=>{if(!e||typeof e!="object")return;const o=ys(),n=o.slots.findIndex(s=>s.peerId===t);if(n!==-1&&U.players.has(n)){const s=U.players.get(n);if(!s||!s.exists())return;if(e.move&&typeof e.move=="object"){const a=Math.max(-1,Math.min(1,Number(e.move.x)||0)),r=Math.max(-1,Math.min(1,Number(e.move.y)||0));s.move={x:a,y:r}}if(e.shoot!==void 0&&(s.isShooting=!!e.shoot),e.aimAngle!==void 0){const a=Number(e.aimAngle)||0;s.aimAngle=Math.max(-360,Math.min(360,a))}}else console.warn("[Multiplayer] Could not find player for peer:",t,"slot:",n),console.warn("[Multiplayer] Party slots:",o.slots),console.warn("[Multiplayer] Registered players:",Array.from(U.players.keys()))}),_e("pause_request",(e,t)=>{U.k&&(U.k.paused=e.paused,U.k.gameData&&U.k.gameData.updatePauseUI&&U.k.gameData.updatePauseUI(e.paused),Ve("pause_state",{paused:e.paused}))}),_e("player_death",(e,t)=>{const o=U.players.get(e.slotIndex);o&&o.exists()&&(o.isDead=!0,o.canMove=!1,o.canShoot=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5),Ve("player_death",{slotIndex:e.slotIndex},[t]))}),_e("enemy_death",(e,t)=>{Ve("entity_destroyed",{entityId:e.entityId,entityType:e.entityType,x:e.x,y:e.y})}),_e("resync_request",(e,t)=>{Ko(t,"game_state",kr())}),_e("level_up_queued",(e,t)=>{Ve("level_up_queued",{slotIndex:e.slotIndex,level:e.level,timestamp:Date.now()})}),_e("player_emote",(e,t)=>{Ve("player_emote",e)}),_e("upgrade_selected",(e,t)=>{const o=U.players.get(e.slotIndex);o&&o.exists()&&(jr(o,e.upgradeKey),o.upgradeStacks||(o.upgradeStacks={}),o.upgradeStacks[e.upgradeKey]=(o.upgradeStacks[e.upgradeKey]||0)+1,o.selectedUpgrades||(o.selectedUpgrades=new Set),o.selectedUpgrades.add(e.upgradeKey),ta(o)),Ve("upgrade_selected",{slotIndex:e.slotIndex,upgradeKey:e.upgradeKey,timestamp:Date.now()})}),_e("synergy_activated",(e,t)=>{Ve("synergy_activated",{slotIndex:e.slotIndex,synergies:e.synergies,timestamp:Date.now()})}),_e("achievement_unlocked",(e,t)=>{Ve("achievement_unlocked",{achievementId:e.achievementId,playerSlotIndex:e.playerSlotIndex,playerName:e.playerName})}))}let oa=!1,mr=!1;function Qm(){oa||(oa=!0,_e("game_state",e=>{if(U.k){if(e.players&&e.players.forEach(t=>{if(t.slotIndex!==U.localPlayerSlot){const o=U.players.get(t.slotIndex);o&&o.exists()&&(o.netTarget?(o.netTarget.x=t.x,o.netTarget.y=t.y):o.netTarget={x:t.x,y:t.y},o.angle=t.angle||0,o.outline&&o.outline.exists()&&(o.outline.angle=o.angle),t.maxHealth!==void 0&&(o.maxHealth=t.maxHealth),t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.invulnerable!==void 0&&(o.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(o.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(o.isDead=t.isDead,o.isDead?(o.canShoot=!1,o.canMove=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5)):(o.canShoot=!0,o.canMove=!0,o.opacity=1,o.outline&&o.outline.exists()&&(o.outline.opacity=1))),t.weapons&&(o.weapons=t.weapons),t.passiveUpgrades&&(o.passiveUpgrades=t.passiveUpgrades),t.upgradeStacks&&(o.upgradeStacks=t.upgradeStacks),t.speed!==void 0&&(o.speed=t.speed),t.damage!==void 0&&(o.damage=t.damage),t.pickupRadius!==void 0&&(o.pickupRadius=t.pickupRadius),t.runStats&&(o.runStats||(o.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),o.runStats.kills=t.runStats.kills,o.runStats.creditsPickedUp=t.runStats.creditsPickedUp,o.runStats.bossesKilled=t.runStats.bossesKilled))}else{const o=U.players.get(U.localPlayerSlot);o&&o.exists()&&(t.hp!==void 0&&o.setHP&&o.setHP(t.hp),t.maxHealth!==void 0&&(o.maxHealth=t.maxHealth),t.invulnerable!==void 0&&(o.invulnerable=t.invulnerable),t.invulnerableTime!==void 0&&(o.invulnerableTime=t.invulnerableTime),t.isDead!==void 0&&(o.isDead=t.isDead,o.isDead?(o.canShoot=!1,o.canMove=!1,o.isShooting=!1,o.opacity=.5,o.outline&&o.outline.exists()&&(o.outline.opacity=.5)):(o.canShoot=!0,o.canMove=!0,o.opacity=1,o.outline&&o.outline.exists()&&(o.outline.opacity=1))),t.runStats&&(o.runStats||(o.runStats={kills:0,creditsPickedUp:0,bossesKilled:0}),o.runStats.kills=t.runStats.kills,o.runStats.creditsPickedUp=t.runStats.creditsPickedUp,o.runStats.bossesKilled=t.runStats.bossesKilled))}}),e.enemies){const t=new Set;e.enemies.forEach(o=>{t.add(o.id);const n=U.enemies.get(o.id);n&&n.exists()&&(n.netTarget?(n.netTarget.x=o.x,n.netTarget.y=o.y):n.netTarget={x:o.x,y:o.y},o.maxHealth!==void 0&&(n.maxHealth=o.maxHealth),n.setHP&&o.hp!==void 0&&n.setHP(o.hp),o.shieldHealth!==void 0&&(n.shieldHealth=o.shieldHealth),o.armorHealth!==void 0&&(n.armorHealth=o.armorHealth),n.updateVisual&&n.updateVisual())}),U.enemies.forEach((o,n)=>{!t.has(n)&&o.exists()&&(o.cleanupHealthBars&&typeof o.cleanupHealthBars=="function"&&o.cleanupHealthBars(),U.k.destroy(o),U.enemies.delete(n))})}if(e.pickups){const t=new Set;e.pickups.forEach(o=>{t.add(o.id);const n=U.pickups.get(o.id);if(n&&n.exists()){if(n.pos.x=o.x,n.pos.y=o.y,o.magnetizing!==void 0)if(n.magnetizing=o.magnetizing,o.magnetizing&&o.targetPlayerSlot!==void 0){const s=U.players.get(o.targetPlayerSlot);s&&s.exists()?n.targetPlayer=s:(n.magnetizing=!1,n.targetPlayer=null)}else o.magnetizing||(n.targetPlayer=null);o.isFlyingToUI!==void 0&&(n.isFlyingToUI=o.isFlyingToUI)}}),U.pickups.forEach((o,n)=>{!t.has(n)&&o.exists()&&(U.k.destroy(o),U.pickups.delete(n))})}}}),_e("spawn_entity",e=>{if(U.k){if(e.entityType==="enemy"){let t;e.isBoss?t=ea(U.k,e.x,e.y,e.type,e.floor):t=In(U.k,e.x,e.y,e.type,e.floor),t.mpEntityId=e.id,e.isBossMinion&&(t.isBossMinion=!0),U.enemies.set(e.id,t)}else if(e.entityType==="xpPickup"){const t=Gs(U.k,e.x,e.y,e.value);t.mpEntityId=e.id,t.pickupType="xp",U.pickups.set(e.id,t)}else if(e.entityType==="currencyPickup"){const t=Ks(U.k,e.x,e.y,e.value,e.icon);t.mpEntityId=e.id,t.pickupType="currency",U.pickups.set(e.id,t)}}}),_e("spawn_projectile",e=>{if(!U.k)return;const t=U.k.vec2(e.directionX,e.directionY),o=Ro(U.k,e.x,e.y,t,e.speed,e.damage,e.piercing,e.obstaclePiercing,e.isCrit,e.maxRange);(e.char||e.color)&&(o.text=e.char,e.color&&(o.color=U.k.rgb(...e.color))),o.mpEntityId=e.id,U.projectiles.set(e.id,o)}),_e("damage_dealt",e=>{if(!U.k)return;const t=U.k.add([U.k.text(e.damage.toString(),{size:e.isCrit?24:18}),U.k.pos(e.x,e.y),U.k.anchor("center"),U.k.color((e.isCrit,255),e.isCrit?200:255,e.isCrit?0:255),U.k.opacity(1),U.k.lifespan(.8),U.k.z(1e3)]);t.onUpdate(()=>{t.exists()&&(t.pos.y-=50*U.k.dt(),t.opacity-=1.25*U.k.dt())});const o=U.enemies.get(e.targetId);if(o&&o.exists()){const n=o.color;o.color=U.k.rgb(255,255,255),U.k.wait(.1,()=>{o.exists()&&(o.color=n)})}}),_e("entity_destroyed",e=>{if(!U.k)return;const t=U.enemies.get(e.entityId)||U.pickups.get(e.entityId);t&&t.exists()&&(t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),U.k.destroy(t),(e.entityType==="pickup"||e.entityType==="xpPickup"||e.entityType==="currencyPickup")&&U.pickups.delete(e.entityId)),U.enemies.delete(e.entityId),U.projectiles.delete(e.entityId),U.pickups.delete(e.entityId)}),_e("boss_enrage",e=>{if(!U.k)return;const t=U.enemies.get(e.networkId);t&&t.exists()&&t.enrage&&t.enrage()}),_e("players_revived",e=>{if(!U.k)return;const o=.05+Ct("secondWind")*.05;U.players.forEach((n,s)=>{if(n&&n.exists()&&(n.hp()<=0||n.isDead)){const a=Math.max(1,Math.floor(n.maxHealth*o));n.setHP(a),n.isDead=!1,s===U.localPlayerSlot&&(n.canMove=!0,n.canShoot=!0);const r=Math.round(o*100),l=U.k.add([U.k.text(` REVIVED (${r}% HP) `,{size:16}),U.k.pos(n.pos.x,n.pos.y-40),U.k.anchor("center"),U.k.color(100,255,100),U.k.opacity(1),U.k.lifespan(2),U.k.z(1e3)]);l.onUpdate(()=>{l.exists()&&(l.pos.y-=30*U.k.dt(),l.opacity-=.5*U.k.dt())}),n.opacity=1,n.characterData&&(n.color=U.k.rgb(...n.characterData.color)),n.outline&&n.outline.exists()&&(n.outline.opacity=1)}})}),_e("game_seed",e=>{U.gameSeed=e.seed,U.floorRng=new mn(U.gameSeed),e.roomTemplateKey&&(U.firstRoomTemplateKey=e.roomTemplateKey,console.log("[Multiplayer] Client received first room template:",e.roomTemplateKey)),U.onGameSeedCallback&&(U.onGameSeedCallback(),U.onGameSeedCallback=null)}),_e("pause_state",e=>{U.k&&(U.k.paused=e.paused,U.k.gameData&&U.k.gameData.updatePauseUI&&U.k.gameData.updatePauseUI(e.paused))}),_e("xp_gain",e=>{const t=U.players.get(U.localPlayerSlot);t&&t.exists()&&!t.isDead&&t.addXP?t.addXP(e.value):U.pendingXP+=e.value}),_e("currency_gain",e=>{ps(e.value)}),_e("enemy_split",e=>{U.k&&U.k.gameData&&U.k.gameData.incrementSplitEnemies&&U.k.gameData.incrementSplitEnemies(e.count)}),_e("player_death",e=>{const t=U.players.get(e.slotIndex);t&&t.exists()&&(t.isDead=!0,t.canMove=!1,t.canShoot=!1,t.isShooting=!1,t.opacity=.5,t.outline&&t.outline.exists()&&(t.outline.opacity=.5))}),_e("player_disconnected",e=>{const t=U.players.get(e.slotIndex);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),U.k.destroy(t),U.players.delete(e.slotIndex))}),_e("host_quit",e=>{hs(),U.k&&U.k.go("menu")}),_e("achievement_unlocked",e=>{if(e.playerSlotIndex!==U.localPlayerSlot){const t=rn[e.achievementId];t&&U.k&&(Qr(U.k),Gm(e.playerName,t))}}))}function ll(e,t){U.players.set(e,t),t.mpSlotIndex=e}function km(e){const t=U.players.get(e);t&&t.exists()&&(t.pendingLevelUps&&(t.pendingLevelUps=[]),t.cleanupHealthBars&&typeof t.cleanupHealthBars=="function"&&t.cleanupHealthBars(),U.k&&U.k.destroy(t),U.players.delete(e),U.isHost&&ey(e))}function ey(e){U.isHost&&Ve("player_disconnected",{slotIndex:e})}function ty(e){if(U.isActive)if(U.lastSyncTime+=e,U.lastResyncTime+=e,U.isHost)U.lastSyncTime>=U.syncInterval&&(oy(),U.lastSyncTime=0),U.lastResyncTime>=U.resyncInterval&&(U.players.forEach((t,o)=>{t&&t.exists()&&(t.isDead&&t.hp()>0&&(console.warn("[Multiplayer] Desync detected: Player",o,"is marked dead but has HP. Correcting..."),t.setHP(0)),!t.isDead&&t.hp()<=0&&(console.warn("[Multiplayer] Desync detected: Player",o,"has no HP but not marked dead. Correcting..."),t.isDead=!0,t.canMove=!1,t.canShoot=!1))}),U.lastResyncTime=0);else{if(U.lastSyncTime>=U.syncInterval&&(iy(),U.lastSyncTime=0),U.lastResyncTime>=U.resyncInterval){let o=!1;U.players.forEach((n,s)=>{n&&n.exists()&&(n.isDead&&n.hp()>0&&(console.warn("[Multiplayer] Client desync: Player",s,"is dead but has HP"),o=!0),!n.isDead&&n.hp()<=0&&(console.warn("[Multiplayer] Client desync: Player",s,"has no HP but not dead"),o=!0))}),o&&By(),U.lastResyncTime=0}const t=Math.min(e*10,1);U.players.forEach(o=>{o.exists()&&o.isRemote&&o.netTarget&&(o.pos.x+=(o.netTarget.x-o.pos.x)*t,o.pos.y+=(o.netTarget.y-o.pos.y)*t)}),U.enemies.forEach(o=>{o.exists()&&o.netTarget&&(o.pos.x+=(o.netTarget.x-o.pos.x)*t,o.pos.y+=(o.netTarget.y-o.pos.y)*t)})}}function kr(){const e=[],t=[],o=[],n=[];return U.players.forEach((s,a)=>{if(s.exists()){let r=[],l=[],c={};try{s.weapons&&(r=JSON.parse(JSON.stringify(s.weapons))),s.passiveUpgrades&&(l=JSON.parse(JSON.stringify(s.passiveUpgrades))),s.upgradeStacks&&(c=JSON.parse(JSON.stringify(s.upgradeStacks)))}catch(i){console.warn("Failed to serialize player upgrades:",i)}let d=s.maxHealth;s.hp&&typeof s.hp=="function"?d=s.hp():typeof s.hp=="number"&&(d=s.hp),e.push({slotIndex:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),angle:Number(s.angle||0),hp:Number(d),maxHealth:Number(s.maxHealth||100),level:Number(s.level||1),xp:Number(s.xp||0),isDead:!!s.isDead,weapons:r,passiveUpgrades:l,upgradeStacks:c,speed:Number(s.speed||0),damage:Number(s.damage||0),pickupRadius:Number(s.pickupRadius||0),invulnerable:!!s.invulnerable,invulnerableTime:Number(s.invulnerableTime||0),runStats:s.runStats?{kills:Number(s.runStats.kills||0),creditsPickedUp:Number(s.runStats.creditsPickedUp||0),bossesKilled:Number(s.runStats.bossesKilled||0)}:null})}}),U.enemies.forEach((s,a)=>{if(s.exists()){let r=0;s.hp&&typeof s.hp=="function"?r=s.hp():typeof s.hp=="number"&&(r=s.hp),t.push({id:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),hp:Number(r),maxHealth:Number(s.maxHealth||0),type:String(s.enemyType||"basic"),shieldHealth:Number(s.shieldHealth||0),armorHealth:Number(s.armorHealth||0)})}else U.enemies.delete(a)}),U.projectiles.forEach((s,a)=>{s.exists()||U.projectiles.delete(a)}),U.pickups.forEach((s,a)=>{if(s.exists()){const r={id:Number(a),x:Number(s.pos.x),y:Number(s.pos.y),type:String(s.pickupType||"xp"),magnetizing:!!s.magnetizing,isFlyingToUI:!!s.isFlyingToUI};s.magnetizing&&s.targetPlayer&&s.targetPlayer.slotIndex!==void 0&&(r.targetPlayerSlot=Number(s.targetPlayer.slotIndex)),n.push(r)}else U.pickups.delete(a)}),{players:e,enemies:t,projectiles:o,pickups:n}}function oy(){U.isHost&&Ve("game_state",kr())}function ny(e){!U.isHost||!U.isActive||(console.log("Sending initial game state to new joiner:",e),Ko(e,"game_state",kr()),sy(e))}function sy(e){!U.isHost||!U.isActive||!U.k||(U.k,console.log("[Multiplayer] Sending existing entities to new joiner:",e),U.enemies.forEach((t,o)=>{if(t&&t.exists()){const n={entityId:o,entityType:"enemy",x:t.pos.x,y:t.pos.y,enemyType:t.type||"basic",floor:t.floor||1,isBoss:t.is("boss")||!1,isMiniboss:t.is("miniboss")||!1,health:t.hp(),maxHealth:t.maxHealth,armorHealth:t.armorHealth||0,shieldHealth:t.shieldHealth||0};Ko(e,"spawn_entity",n)}}),U.pickups.forEach((t,o)=>{if(t&&t.exists()){const n={entityId:o,entityType:"pickup",x:t.pos.x,y:t.pos.y,pickupType:t.pickupType||(t.is("xpPickup")?"xp":t.is("currencyPickup")?"currency":"powerup"),xpValue:t.xpValue||0,currencyValue:t.currencyValue||0};Ko(e,"spawn_entity",n)}}),console.log("[Multiplayer] Sent",U.enemies.size,"enemies and",U.pickups.size,"pickups to new joiner"))}function iy(){if(U.isHost)return;const e=U.players.get(U.localPlayerSlot);if(!e||!e.exists())return;const t=e.moveDir?{x:Number(e.moveDir.x||0),y:Number(e.moveDir.y||0)}:{x:0,y:0};po("player_input",{slotIndex:Number(U.localPlayerSlot),move:t,shoot:!!e.isShooting,aimAngle:Number(e.aimAngle||0)})}function he(){return U.isActive}function ay(){return U.players.size}function hs(){U.isActive=!1,U.players.clear(),U.inputBuffer=[],U.enemies.clear(),U.projectiles.clear(),U.pickups.clear(),U.nextEntityId=1,Pt("player_input"),Pt("pause_request"),Pt("player_death"),Pt("enemy_death"),Pt("resync_request"),Pt("level_up_queued"),Pt("player_emote"),Pt("upgrade_selected"),Pt("synergy_activated"),Pt("achievement_unlocked"),Pt("game_state"),Pt("spawn_entity"),Pt("spawn_projectile"),Pt("damage_dealt"),Pt("entity_destroyed"),Pt("boss_enrage"),Pt("players_revived"),Pt("game_seed"),Pt("pause_state"),Pt("xp_gain"),Pt("currency_gain"),Pt("enemy_split"),Pt("player_disconnected"),Pt("host_quit"),Rm(),oa=!1,mr=!1}function Yo(e,t={}){if(!U.isHost)return null;const o=U.nextEntityId++;return e.mpEntityId=o,U.enemies.set(o,e),Ve("spawn_entity",{id:o,entityType:"enemy",x:e.pos.x,y:e.pos.y,type:t.type||"basic",floor:t.floor||1,isBoss:t.isBoss||!1,isBossMinion:t.isBossMinion||!1}),o}function us(e,t={}){if(!U.isHost)return null;const o=U.nextEntityId++;e.mpEntityId=o,U.projectiles.set(o,e);let n=[255,255,100];return e.color&&e.color.r!==void 0&&(n=[Math.round(e.color.r),Math.round(e.color.g),Math.round(e.color.b)]),Ve("spawn_projectile",{id:Number(o),x:Number(e.pos.x),y:Number(e.pos.y),directionX:Number(e.direction.x),directionY:Number(e.direction.y),speed:Number(e.speed),damage:Number(e.damage),piercing:Number(e.piercing||0),obstaclePiercing:Number(e.obstaclePiercing||0),isCrit:!!e.isCrit,maxRange:Number(e.maxRange),angle:Number(e.angle||0),char:e.text||t.char||"*",color:n}),o}function ry(e){U.isActive&&e.mpEntityId!==void 0&&U.projectiles.delete(e.mpEntityId)}function ec(e,t={}){if(!U.isHost)return null;const o=U.nextEntityId++;e.mpEntityId=o,U.pickups.set(o,e);const n={id:o,entityType:t.type||"xpPickup",x:e.pos.x,y:e.pos.y,value:t.value||e.value||1};return t.type==="currencyPickup"&&t.icon&&(n.icon=t.icon),Ve("spawn_entity",n),o}function tc(e){U.isActive&&e.mpEntityId!==void 0&&U.pickups.delete(e.mpEntityId)}function me(){return U.isHost}function cy(e){!U.isHost||!U.isActive||Ve("damage_dealt",{targetId:Number(e.targetId),targetType:String(e.targetType),damage:Number(e.damage),isCrit:!!e.isCrit,attackerId:e.attackerId!==void 0?Number(e.attackerId):null,x:Number(e.x),y:Number(e.y)})}function Mh(e){!U.isHost||!U.isActive||Ve("player_healed",{slotIndex:Number(e.slotIndex),healAmount:Number(e.healAmount),newHP:Number(e.newHP),source:String(e.source||"unknown")})}function Ba(e){!U.isHost||!U.isActive||Ve("player_dodged",{slotIndex:Number(e.slotIndex),x:Number(e.x),y:Number(e.y)})}function oc(e){!U.isHost||!U.isActive||Ve("entity_destroyed",{entityId:Number(e.entityId),entityType:String(e.entityType),x:Number(e.x),y:Number(e.y),xpDropped:e.xpDropped!==void 0?Number(e.xpDropped):0,currencyDropped:e.currencyDropped!==void 0?Number(e.currencyDropped):0})}function dl(e){!U.isHost||!U.isActive||Ve("boss_enrage",{networkId:e})}function ly(){!U.isHost||!U.isActive||Ve("players_revived",{timestamp:Date.now()})}function hl(e,t,o=[]){!U.isHost||!U.isActive||Ve("game_over",{runStats:e,currencyEarned:t,partyStats:o,timestamp:Date.now()})}function dy(){!U.isHost||!U.isActive||Ve("host_quit",{timestamp:Date.now()})}function hy(e){!U.isHost||!U.isActive||Ve("powerup_weapon_applied",{powerupKey:e,timestamp:Date.now()})}function uy(e,t){U.isActive&&(U.isHost?Ve("upgrade_selected",{slotIndex:e,upgradeKey:t,timestamp:Date.now()}):po("upgrade_selected",{slotIndex:e,upgradeKey:t}))}function fy(e,t){U.isActive&&(U.isHost?Ve("level_up_queued",{slotIndex:e,level:t,timestamp:Date.now()}):po("level_up_queued",{slotIndex:e,level:t}))}function py(e,t){U.isActive&&(U.isHost?Ve("synergy_activated",{slotIndex:e,synergies:t,timestamp:Date.now()}):po("synergy_activated",{slotIndex:e,synergies:t}))}function ul(e,t){!U.isHost||!U.isActive||Ve("powerup_expired",{slotIndex:e,powerupKey:t,timestamp:Date.now()})}function fl(){return U.gameSeed!==0}function gy(e){U.onGameSeedCallback=e}function my(e){U.currentFloor=e;const t=Jr(U.gameSeed,e);U.floorRng=new mn(t)}function Ti(){const e=Jr(U.gameSeed,U.currentFloor,U.currentRoom.x,U.currentRoom.y);return new mn(e)}function yy(){const e=U.firstRoomTemplateKey;return U.firstRoomTemplateKey=null,e}function xy(){return U.floorRng}function wy(e,t){const o=Jr(U.gameSeed,e,t);return new mn(o)}function by(e=null){U.isHost&&Ve("game_seed",{seed:U.gameSeed,roomTemplateKey:e})}function vy(e){U.isHost&&Ve("pause_state",{paused:e})}function Ey(e){U.isHost||po("pause_request",{paused:e})}function Ay(e){U.isHost||po("enemy_death",e)}function Sy(e,t=null){U.isHost&&Ve("obstacle_data",{obstacles:e,doorStates:t})}function My(){U.isHost&&Ve("room_completed",{})}function Ty(e){U.isHost&&Ve("xp_gain",{value:e})}function Dy(e){U.isHost&&Ve("currency_gain",{value:e})}function Cy(){const e=U.pendingXP;return U.pendingXP=0,e}function pl(e,t){U.isHost?Ve("player_emote",{slotIndex:e,emoteType:t}):po("player_emote",{slotIndex:e,emoteType:t})}function Ry(e,t=null,o=null,n=null,s=null){U.isHost&&Ve("room_transition",{entryDirection:e,allPlayerStats:t,gridDirection:o,currentFloor:n,roomTemplateKey:s})}function Py(e){U.isHost&&Ve("enemy_split",{count:e})}function Iy(e){U.isActive&&(U.isHost?Ve("player_death",{slotIndex:e}):po("player_death",{slotIndex:e}))}function By(){U.isHost||po("resync_request",{timestamp:Date.now()})}function Ly(){return U.localPlayerSlot}function zy(e,t){if(!U.isActive)return;const s=ys().slots[t]?.name||`Player ${t+1}`;Ve("achievement_unlocked",{achievementId:e,playerSlotIndex:t,playerName:s})}class gl{constructor(t,o,n,s=0){this.k=t,this.createFn=o,this.resetFn=n,this.pool=[],this.active=new Set;for(let a=0;a<s;a++){const r=this.createFn(t);r.hidden=!0,r.paused!==void 0&&(r.paused=!0),this.pool.push(r)}}acquire(...t){let o;return this.pool.length>0?(o=this.pool.pop(),o.hidden=!1,o.paused!==void 0&&(o.paused=!1)):o=this.createFn(this.k),this.resetFn&&this.resetFn(o,...t),this.active.add(o),o._pooled=!0,o}release(t){if(!(!t||!t._pooled)){if(!t.exists||!t.exists()){this.active.delete(t);return}t.hidden=!0,t.paused!==void 0&&(t.paused=!0),t.pos&&(t.pos.x=-9999,t.pos.y=-9999),this.active.delete(t),this.pool.push(t)}}clear(){for(const t of this.pool)t.exists&&t.exists()&&this.k.destroy(t);this.pool=[];for(const t of this.active)t.exists&&t.exists()&&this.k.destroy(t);this.active.clear()}getPoolSize(){return this.pool.length}getActiveCount(){return this.active.size}prewarm(t){for(let o=0;o<t;o++){const n=this.createFn(this.k);n.hidden=!0,n.paused!==void 0&&(n.paused=!0),n._pooled=!0,n.pos&&(n.pos.x=-9999,n.pos.y=-9999),this.pool.push(n)}}}const pn={projectiles:null,particles:null};function Oy(e){pn.projectiles=new gl(e,t=>{const o=t.add([t.text("*",{size:16}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,100),t.rotate(0),t.area(),"projectile"]);return o.hidden=!0,o},(t,o,n,s,a,r,l,c,d,i)=>{t.pos.x=o,t.pos.y=n,t.damage=r,t.piercing=l||0,t.obstaclePiercing=c||0,t.piercedEnemies=new Set,t.piercedObstacles=new Set,t.isCrit=d||!1,t.maxRange=i||750,t.distanceTraveled=0,t.direction=s,t.speed=a,t.isBoomerang=!1,t.isReturning=!1,t.ownerPlayer=null,t.returnSpeedMultiplier=1.2,t.isExplosive=!1,t.isChainLightning=!1,t.isEnemyProjectile=!1,t.isBossProjectile=!1,t.isReflected=!1,t.reflectionCount=0,t.chainedEnemies=null,t.chainJumps=0,t.ownerSlotIndex=void 0,t.burnDamage=null,t.burnDuration=null,t.text="*",t.color=d?e.rgb(255,200,0):e.rgb(255,255,100);const h=Math.atan2(s.y,s.x)*(180/Math.PI)+90;t.angle=h},50),pn.particles=new gl(e,t=>{const o=t.add([t.text("*",{size:12}),t.pos(-9999,-9999),t.anchor("center"),t.color(255,255,255),t.z(100),"particle"]);return o.hidden=!0,o},(t,o,n,s={})=>{const{char:a="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:i=1,fadeStart:h=.3,friction:u=.95,zIndex:g=100}=s;t.pos.x=o,t.pos.y=n,t.text=a,t.color=e.rgb(...l),t.z=g,t.opacity=1,t.velocity={x:c.x,y:c.y},t.gravity=d,t.friction=u,t.lifetime=i,t.fadeStart=h,t.age=0,t.initialOpacity=1},100)}function Th(){return pn.particles}function Hy(){pn.projectiles&&(pn.projectiles.clear(),pn.projectiles=null),pn.particles&&(pn.particles.clear(),pn.particles=null)}function Ro(e,t,o,n,s,a,r=0,l=0,c=!1,d=null){const i=Math.atan2(n.y,n.x)*(180/Math.PI)+90,h=e.add([e.text("*",{size:16}),e.pos(t,o),e.anchor("center"),e.color(255,c?200:255,c?0:100),e.rotate(i),e.area(),"projectile"]);return h.damage=a,h.piercing=r,h.obstaclePiercing=l,h.piercedEnemies=new Set,h.piercedObstacles=new Set,h.isCrit=c,h.maxRange=d||ms.DEFAULT_WEAPON_RANGE,h.distanceTraveled=0,h.direction=n,h.speed=s,h.isBoomerang=!1,h.isReturning=!1,h.ownerPlayer=null,h.returnSpeedMultiplier=1.2,h.useWeaponVisual=function(u){u&&u.char&&(h.text=u.char),u&&u.color&&(h.isCrit||(h.color=e.rgb(...u.color))),u&&u.range&&(h.maxRange=u.range)},h.onUpdate(()=>{if(e.paused)return;if(h.isBoomerang){if(h.isReturning)if(h.ownerPlayer&&h.ownerPlayer.exists()&&!h.ownerPlayer.isDead){const D=e.vec2(h.ownerPlayer.pos.x-h.pos.x,h.ownerPlayer.pos.y-h.pos.y),m=D.len();if(m>0){const M=D.unit(),B=h.speed*h.returnSpeedMultiplier,P=M.scale(B*e.dt());if(h.pos.x+=P.x,h.pos.y+=P.y,h.direction=M,m<30){e.destroy(h);return}}}else{e.destroy(h);return}else{const D=h.direction.scale(h.speed*e.dt());h.distanceTraveled+=D.len(),h.pos.x+=D.x,h.pos.y+=D.y,h.distanceTraveled>=h.maxRange&&(h.isReturning=!0,h.piercedEnemies.clear(),h.distanceTraveled=0)}const p=Math.atan2(h.direction.y,h.direction.x)*(180/Math.PI)+90;h.angle=p;return}const u=h.direction.scale(h.speed*e.dt()),g=u.len();if(h.distanceTraveled+=g,h.pos.x+=u.x,h.pos.y+=u.y,h.distanceTraveled>=h.maxRange){e.destroy(h);return}(h.pos.x<0||h.pos.x>e.width()||h.pos.y<0||h.pos.y>e.height())&&e.destroy(h)}),he()&&me()&&us(h),he()&&h.onDestroy(()=>{ry(h)}),h}const bs={rusher:{name:"Security Guard",char:"",color:[255,150,100],baseHealth:25,baseSpeed:90,size:18,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:9},shooter:{name:"Camera Operator",char:"",color:[100,200,255],baseHealth:30,baseSpeed:70,size:18,baseXPValue:2,behavior:"shoot",fireRate:.53,projectileSpeed:200,projectileDamage:7},zombie:{name:"Audience Member",char:"",color:[150,150,150],baseHealth:45,baseSpeed:50,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:11},slime:{name:"Fan",char:"",color:[100,255,100],baseHealth:12,baseSpeed:40,size:16,baseXPValue:1,behavior:"rush",pathfindingMode:"smart",damage:5,splits:!0},bat:{name:"Stagehand",char:"",color:[200,150,255],baseHealth:10,baseSpeed:135,size:14,baseXPValue:2,behavior:"erratic",damage:6},charger:{name:"Head of Security",char:"",color:[255,200,100],baseHealth:20,baseSpeed:175,size:18,baseXPValue:3,behavior:"charge",pathfindingMode:"smart",damage:17,chargeCooldown:3},turret:{name:"Camera Director",char:"",color:[200,200,200],baseHealth:60,baseSpeed:0,size:20,baseXPValue:3,behavior:"turret",fireRate:1.2,projectileSpeed:250,projectileDamage:13},heavyTank:{name:"Bouncer",char:"",color:[150,150,255],baseHealth:125,baseSpeed:40,size:24,baseXPValue:5,behavior:"rush",pathfindingMode:"smart",damage:22},zippy:{name:"Runner",char:"",color:[255,255,150],baseHealth:7,baseSpeed:200,size:14,baseXPValue:2,behavior:"erratic",damage:5},exploder:{name:"Pyrotechnics Tech",char:"",color:[255,100,50],baseHealth:25,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,explodes:!0,explosionDamage:17,explosionRadius:60},orbiter:{name:"Floor Manager",char:"",color:[255,150,0],baseHealth:35,baseSpeed:60,size:20,baseXPValue:4,behavior:"perimeter",pathfindingMode:"perimeter",damage:10,explodes:!0,explosionDamage:20,explosionRadius:80,shrapnel:!0,shrapnelCount:12},splitter:{name:"Intern",char:"",color:[200,255,200],baseHealth:40,baseSpeed:75,size:20,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,splits:!0,splitCount:2},mage:{name:"Lighting Director",char:"",color:[200,100,255],baseHealth:70,baseSpeed:50,size:20,baseXPValue:4,behavior:"shoot",fireRate:.6,projectileSpeed:180,projectileDamage:12},shieldBearer:{name:"Stage Manager",char:"",color:[150,150,200],baseHealth:90,baseSpeed:40,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:15,blocksProjectiles:!0},golem:{name:"Set Designer",char:"",color:[100,100,100],baseHealth:250,baseSpeed:30,size:26,baseXPValue:7,behavior:"rush",pathfindingMode:"smart",damage:30},wraith:{name:"Editor",char:"",color:[150,150,255],baseHealth:20,baseSpeed:225,size:16,baseXPValue:3,behavior:"teleport",damage:13,teleportCooldown:4,teleportRange:150},spawner:{name:"Casting Director",char:"",color:[255,150,100],baseHealth:80,baseSpeed:40,size:20,baseXPValue:5,behavior:"spawner",damage:8,spawnInterval:6,spawnType:"rusher"},buffer:{name:"Assistant Director",char:"",color:[255,200,100],baseHealth:35,baseSpeed:50,size:18,baseXPValue:3,behavior:"buffer",damage:6,buffRadius:100,buffAmount:.2},phaser:{name:"Ghost Writer",char:"",color:[180,180,255],baseHealth:25,baseSpeed:100,size:18,baseXPValue:3,behavior:"phase",pathfindingMode:"none",damage:10,phaseOpacity:.5,phaseThroughObstacles:!0},mimic:{name:"Stunt Double",char:"@",color:[255,100,100],baseHealth:35,baseSpeed:150,size:18,baseXPValue:4,behavior:"mimic",pathfindingMode:"none",damage:12,mimicDuration:2,mimicCooldown:4},healer:{name:"Producer",char:"",color:[100,255,150],baseHealth:70,baseSpeed:40,size:20,baseXPValue:4,behavior:"healer",damage:8,healRadius:120,healAmount:12,healInterval:4},teleporter:{name:"Executive Producer",char:"",color:[200,150,255],baseHealth:25,baseSpeed:90,size:18,baseXPValue:3,behavior:"teleportPlayer",damage:8,teleportRange:200,teleportCooldown:5},freezer:{name:"Network Executive",char:"",color:[150,200,255],baseHealth:60,baseSpeed:50,size:20,baseXPValue:4,behavior:"freeze",damage:10,slowRadius:80,slowAmount:.4},leech:{name:"Talent Agent",char:"",color:[255,100,150],baseHealth:30,baseSpeed:80,size:18,baseXPValue:3,behavior:"rush",pathfindingMode:"smart",damage:8,lifesteal:7},reflector:{name:"Mirror Master",char:"",color:[200,200,255],baseHealth:80,baseSpeed:45,size:22,baseXPValue:5,behavior:"shield",pathfindingMode:"smart",damage:12,reflectsProjectiles:!0,reflectChance:.4},bomber:{name:"Demolitions Expert",char:"",color:[255,150,100],baseHealth:70,baseSpeed:0,size:22,baseXPValue:5,behavior:"bomber",fireRate:.4,projectileSpeed:100,projectileDamage:20,homingStrength:.5,bombExplosionRadius:50},basic:{name:"Crew Member",char:"E",color:[255,100,100],baseHealth:30,baseSpeed:50,size:20,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:8},tank:{name:"Camera Operator",char:"",color:[150,150,255],baseHealth:80,baseSpeed:30,size:24,baseXPValue:4,behavior:"rush",pathfindingMode:"smart",damage:20},fast:{name:"Runner",char:"F",color:[255,255,100],baseHealth:20,baseSpeed:90,size:16,baseXPValue:2,behavior:"rush",pathfindingMode:"smart",damage:6}};function Uy(e){return bs[e]||bs.basic}const nn=32,Ny=100;class _y{constructor(){this.elements=[]}enqueue(t,o){this.elements.push({element:t,priority:o}),this.elements.sort((n,s)=>n.priority-s.priority)}dequeue(){return this.elements.shift()?.element}isEmpty(){return this.elements.length===0}}function ml(e,t){return{gx:Math.floor(e/nn),gy:Math.floor(t/nn)}}function Dh(e,t){return{x:e*nn+nn/2,y:t*nn+nn/2}}function La(e,t,o,n,s){if(t<0||o<0||t>=n||o>=s)return!1;const a=Dh(t,o),r=e.get("obstacle");for(const l of r){if(!l.exists())continue;const c=nn/2,d=a.x-c,i=a.x+c,h=a.y-c,u=a.y+c,g=l.pos.x-l.width/2,p=l.pos.x+l.width/2,D=l.pos.y-l.height/2,m=l.pos.y+l.height/2;if(i>g&&d<p&&u>D&&h<m)return!1}return!0}function Xy(e,t){return Math.abs(e.gx-t.gx)+Math.abs(e.gy-t.gy)}function Fy(e,t,o,n,s){const a=e.width(),r=e.height(),l=Math.ceil(a/nn),c=Math.ceil(r/nn),d=ml(t,o),i=ml(n,s);if(!La(e,d.gx,d.gy,l,c)||!La(e,i.gx,i.gy,l,c))return[];const h=new _y;h.enqueue(d,0);const u=new Map,g=new Map,p=P=>`${P.gx},${P.gy}`;u.set(p(d),null),g.set(p(d),0);let D=0;const m=l*c;for(;!h.isEmpty()&&D<m;){D++;const P=h.dequeue();if(P.gx===i.gx&&P.gy===i.gy)break;const f=[{gx:P.gx+1,gy:P.gy},{gx:P.gx-1,gy:P.gy},{gx:P.gx,gy:P.gy+1},{gx:P.gx,gy:P.gy-1},{gx:P.gx+1,gy:P.gy+1},{gx:P.gx+1,gy:P.gy-1},{gx:P.gx-1,gy:P.gy+1},{gx:P.gx-1,gy:P.gy-1}];for(const O of f){if(!La(e,O.gx,O.gy,l,c))continue;const T=O.gx!==P.gx&&O.gy!==P.gy?1.4:1,x=g.get(p(P))+T,C=p(O);if(!g.has(C)||x<g.get(C)){g.set(C,x);const S=x+Xy(O,i);h.enqueue(O,S),u.set(C,P)}}}const M=[];let B=i;for(;B&&u.has(p(B));){const P=Dh(B.gx,B.gy);if(M.unshift(P),B=u.get(p(B)),M.length>Ny)break}return M}function Yy(e,t,o,n){if((!t.pathfindingPath||t.pathfindingTimer<=0)&&(t.pathfindingPath=Fy(e,t.pos.x,t.pos.y,o,n),t.pathfindingTimer=.5,t.pathfindingWaypointIndex=0),t.pathfindingTimer-=e.dt(),t.pathfindingPath&&t.pathfindingPath.length>0){const r=t.pathfindingPath[t.pathfindingWaypointIndex];if(r){const l=e.vec2(r.x-t.pos.x,r.y-t.pos.y),c=l.len();if(c<nn/2&&(t.pathfindingWaypointIndex++,t.pathfindingWaypointIndex>=t.pathfindingPath.length&&(t.pathfindingPath=null,t.pathfindingTimer=0)),c>0)return l.unit()}}const s=e.vec2(o-t.pos.x,n-t.pos.y);return s.len()>0?s.unit():e.vec2(0,0)}function qy(e,t){const o=e.width(),n=e.height(),s=40;t.perimeterMode||(t.perimeterMode={side:"top",targetX:t.pos.x,targetY:s});const a=t.perimeterMode;t.speed*e.dt();const r=20,l=e.vec2(a.targetX-t.pos.x,a.targetY-t.pos.y),c=l.len();if(c<r)switch(a.side){case"top":a.side="right",a.targetX=o-s,a.targetY=s;break;case"right":a.side="bottom",a.targetX=o-s,a.targetY=n-s;break;case"bottom":a.side="left",a.targetX=s,a.targetY=n-s;break;case"left":a.side="top",a.targetX=s,a.targetY=s;break}return c>0?l.unit():e.vec2(0,0)}function In(e,t,o,n="basic",s=1,a=null){const r=Uy(n),l=1+(s-1)*.3,c={char:r.char,color:r.color,health:Math.floor(r.baseHealth*l),speed:Math.floor(r.baseSpeed*(1+(s-1)*.1)),size:r.size,xpValue:Math.floor(r.baseXPValue*l),behavior:r.behavior};function d(){return c.char}const i=e.add([e.text(d(),{size:c.size}),e.pos(t,o),e.anchor("center"),e.color(...c.color),e.area(),e.health(c.health),"enemy"]);i.originalColor=c.color,i.maxHealth=c.health,i.speed=c.speed,i.xpValue=c.xpValue,i.type=n,i.behavior=c.behavior,i.floor=s,i.pathfindingMode=r.pathfindingMode||"none",r.damage&&(i.damage=r.damage),r.fireRate&&(i.fireRate=r.fireRate),r.projectileSpeed&&(i.projectileSpeed=r.projectileSpeed),r.projectileDamage&&(i.projectileDamage=r.projectileDamage),r.chargeCooldown&&(i.chargeCooldown=r.chargeCooldown),r.splits&&(i.splits=!0,i.splitCount=r.splitCount||2,i.splitType=r.splitType||n),r.explodes&&(i.explodes=!0,i.explosionDamage=r.explosionDamage,i.explosionRadius=r.explosionRadius,r.shrapnel&&(i.shrapnel=!0,i.shrapnelCount=r.shrapnelCount||8));let h=0,u=0,g=0;if(s>=2){const T=a?a.next():Math.random();s>=2&&(n==="zombie"||n==="turret"||n==="heavyTank"||T<.3)&&(h=Math.floor(15+(s-2)*5))}if(s>=3){const T=a?a.next():Math.random();(n==="shooter"||n==="turret"||n==="wraith"||T<.2)&&(u=Math.floor(10+(s-3)*5),g=1+(s-3)*.5)}if(s>=4){const T=a?a.next():Math.random();(n==="heavyTank"||n==="spawner"||T<.1)&&(h===0&&(h=Math.floor(20+(s-4)*5)),u===0&&(u=Math.floor(15+(s-4)*5),g=1.5+(s-4)*.5))}const p=(r.baseArmorHealth||0)+h;i.armorHealth=Math.floor(p*l),i.maxArmorHealth=Math.floor(p*l),i.damageReduction=r.damageReduction||(p>0?.2:0),i.armorChar=r.armorChar||"[]",i.armorColor=r.armorColor||[200,200,200];const D=(r.baseShieldHealth||0)+u;i.shieldHealth=Math.floor(D*l),i.maxShieldHealth=Math.floor(D*l),i.shieldRegenRate=((r.shieldRegenRate||0)+g)*l,i.shieldChar=r.shieldChar||"{}",i.shieldColor=r.shieldColor||[100,200,255],i.shieldRegenTimer=0,i.shieldRegenCooldown=0,i.lastDamageTime=0,i.originalColor=c.color,i.coreChar=c.char,i.updateVisual=function(){let T="",x="",C="",S="";if(i.shieldHealth>0){const L=i.shieldHealth/i.maxShieldHealth;L>.66?(T="",x=""):L>.33?(T="",x=""):(T="",x="")}if(i.armorHealth>0){const L=i.armorHealth/i.maxArmorHealth;L>.66?(C="",S=""):L>.33?(C="",S=""):(C="",S="")}const z=`${T}${C}${i.coreChar}${S}${x}`;i.text=z,i.shieldHealth>0?i.color=e.rgb(...i.shieldColor):i.color=e.rgb(...i.originalColor)},i.takeDamage=function(T){let x=!1,C=!1;const S=i.shieldHealth,z=i.armorHealth;i.lastDamageTime=e.time();const L=3;if(i.shieldRegenCooldown=L,i.shieldHealth>0){const N=Math.min(T,i.shieldHealth);i.shieldHealth=Math.max(0,i.shieldHealth-N),x=i.shieldHealth!==S;const _=T-N;_>0&&i.takeDamageInternal(_)}else i.takeDamageInternal(T);C=i.armorHealth!==z,(x||C)&&i.updateVisual()},i.takeDamageInternal=function(T){if(i.armorHealth>0){const x=Math.floor(T*(1-i.damageReduction)),C=Math.min(x,i.armorHealth);i.armorHealth=Math.max(0,i.armorHealth-C);const S=T-x;if(S>0){const z=i.armorHealth>0?1-i.damageReduction:1,L=Math.floor(S*z);i.hurt(L)}}else i.hurt(T)},r.blocksProjectiles&&(i.blocksProjectiles=!0),r.teleportCooldown&&(i.teleportCooldown=r.teleportCooldown),r.teleportRange&&(i.teleportRange=r.teleportRange),r.spawnInterval&&(i.spawnInterval=r.spawnInterval),r.spawnType&&(i.spawnType=r.spawnType),r.buffRadius&&(i.buffRadius=r.buffRadius),r.buffAmount&&(i.buffAmount=r.buffAmount),r.healRadius&&(i.healRadius=r.healRadius),r.healAmount&&(i.healAmount=r.healAmount),r.healInterval&&(i.healInterval=r.healInterval),r.slowRadius&&(i.slowRadius=r.slowRadius),r.slowAmount&&(i.slowAmount=r.slowAmount),r.lifesteal&&(i.lifesteal=r.lifesteal),r.phaseOpacity&&(i.phaseOpacity=r.phaseOpacity),r.phaseThroughObstacles&&(i.phaseThroughObstacles=r.phaseThroughObstacles),r.mimicDuration&&(i.mimicDuration=r.mimicDuration),r.mimicCooldown&&(i.mimicCooldown=r.mimicCooldown),r.reflectsProjectiles&&(i.reflectsProjectiles=r.reflectsProjectiles),r.reflectChance&&(i.reflectChance=r.reflectChance),r.homingStrength&&(i.homingStrength=r.homingStrength),r.bombExplosionRadius&&(i.bombExplosionRadius=r.bombExplosionRadius),i.updateVisual(),i.attackTimer=0,i.chargeTimer=0,i.isCharging=!1,i.chargeDirection=null,i.chargeDuration=0,i.chargePauseTimer=0,i.teleportTimer=0,i.spawnTimer=0,i.healTimer=0,i.buffedEnemies=new Set,i.mimicTimer=0,i.mimicMovementHistory=[],i.isMimicking=!1,i.mimicMoveIndex=0,i.phaseOpacity&&(i.opacity=i.phaseOpacity),i.stuckTimer=0,i.stuckThreshold=1,i.lastPosition={x:t,y:o},i.lastPositionUpdateTime=0,i.avoidanceDirection=null,i.avoidanceTimer=0;const m=30,M=3,B=-20,P=e.add([e.rect(m,M),e.pos(t,o+B),e.anchor("center"),e.color(50,50,50),e.z(100),"enemyHealthBar"]),f=e.add([e.rect(m,M),e.pos(t,o+B),e.anchor("center"),e.color(200,200,200),e.z(101),"enemyHealthBar"]);i.healthBarBg=P,i.healthBar=f,i.showHealthThreshold=.5,P.hidden=!0,f.hidden=!0,i.onUpdate(()=>{if(i.exists()&&i.healthBar&&i.healthBarBg){const T=i.hp()/i.maxHealth;if(T<i.showHealthThreshold&&T>0){i.healthBarBg.hidden=!1,i.healthBar.hidden=!1,i.healthBarBg.pos.x=i.pos.x,i.healthBarBg.pos.y=i.pos.y+B,i.healthBar.pos.x=i.pos.x,i.healthBar.pos.y=i.pos.y+B;const C=m*T;i.healthBar.width=Math.max(1,C),i.healthBar.pos.x=i.pos.x-(m-C)/2}else i.healthBarBg.hidden=!0,i.healthBar.hidden=!0}}),i.cleanupHealthBars=function(){i.healthBarBg&&i.healthBarBg.exists()&&e.destroy(i.healthBarBg),i.healthBar&&i.healthBar.exists()&&e.destroy(i.healthBar)};const O=(T,x)=>{const C=e.get("obstacle"),S=i.size||12;for(const z of C){if(!z.exists())continue;const L=z.pos.x-z.width/2,N=z.pos.x+z.width/2,_=z.pos.y-z.height/2,X=z.pos.y+z.height/2,H=T-S,R=T+S,F=x-S,G=x+S;if(R>L&&H<N&&G>_&&F<X)return!1}return!0},v=T=>{const x=T.len(),C=x>0?T.unit():e.vec2(0,0);i.lastPositionUpdateTime+=e.dt(),i.lastPositionUpdateTime>=.1&&(Math.sqrt(Math.pow(i.pos.x-i.lastPosition.x,2)+Math.pow(i.pos.y-i.lastPosition.y,2))<5?i.stuckTimer+=i.lastPositionUpdateTime:i.stuckTimer=0,i.lastPosition={x:i.pos.x,y:i.pos.y},i.lastPositionUpdateTime=0);const S=i.pos.x+T.x,z=i.pos.y+T.y;if(O(S,z))return i.avoidanceDirection=null,i.avoidanceTimer=0,T;if(i.avoidanceTimer-=e.dt(),i.stuckTimer>=i.stuckThreshold||i.avoidanceTimer<=0){const L=e.vec2(-C.y,C.x),N=e.vec2(C.y,-C.x),_=[L.scale(x),N.scale(x),e.vec2(L.x*.7+C.x*.3,L.y*.7+C.y*.3).unit().scale(x),e.vec2(N.x*.7+C.x*.3,N.y*.7+C.y*.3).unit().scale(x),e.vec2(L.x*.5+C.x*.5,L.y*.5+C.y*.5).unit().scale(x),e.vec2(N.x*.5+C.x*.5,N.y*.5+C.y*.5).unit().scale(x)];for(const X of _){const H=i.pos.x+X.x,R=i.pos.y+X.y;if(O(H,R))return i.avoidanceDirection=e.vec2(X.x,X.y).unit(),i.avoidanceTimer=.8,X}if(i.avoidanceDirection){const X=i.avoidanceDirection.scale(x),H=i.pos.x+X.x,R=i.pos.y+X.y;if(O(H,R))return X}return O(S,i.pos.y)?e.vec2(T.x,0):O(i.pos.x,z)?e.vec2(0,T.y):e.vec2(0,0)}else if(i.avoidanceDirection){const L=i.avoidanceDirection.scale(x),N=i.pos.x+L.x,_=i.pos.y+L.y;if(O(N,_))return L;i.avoidanceDirection=null,i.avoidanceTimer=0}return O(S,i.pos.y)?e.vec2(T.x,0):O(i.pos.x,z)?e.vec2(0,T.y):e.vec2(0,0)};return i.onUpdate(()=>{if(e.paused)return;if(i.shieldRegenRate>0&&i.shieldHealth<i.maxShieldHealth&&i.hp()>0&&!i.isDead){if((!he()||me())&&(i.shieldRegenCooldown>0&&(i.shieldRegenCooldown-=e.dt()),i.shieldRegenCooldown<=0)){i.shieldRegenTimer+=e.dt();const H=1;if(i.shieldRegenTimer>=H){const R=i.shieldRegenRate*H;i.shieldHealth=Math.min(i.maxShieldHealth,i.shieldHealth+R),i.shieldRegenTimer=0}}i.shieldHealth>0&&i.updateVisual&&i.updateVisual()}i.burnDuration>0&&i.hp()>0&&!i.isDead&&(i.burnTimer=(i.burnTimer||0)+e.dt(),i.burnTimer>=.5&&((!he()||me())&&(i.takeDamage?i.takeDamage(i.burnDamage):i.hurt(i.burnDamage)),i.color=e.rgb(255,150,50),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}),i.burnTimer=0),i.burnDuration-=e.dt(),i.burnDuration<=0&&(i.burnDamage=0,i.burnTimer=0));const T=e.gameData?.alivePlayers||e.get("player").filter(H=>H.exists()&&!H.isDead&&H.hp()>0);if(T.length===0)return;let x=T[0],C=Math.sqrt(Math.pow(x.pos.x-i.pos.x,2)+Math.pow(x.pos.y-i.pos.y,2));for(let H=1;H<T.length;H++){const R=T[H],F=Math.sqrt(Math.pow(R.pos.x-i.pos.x,2)+Math.pow(R.pos.y-i.pos.y,2));F<C&&(C=F,x=R)}const S=e.vec2(x.pos.x-i.pos.x,x.pos.y-i.pos.y),z=S.len();if(i.behavior==="turret"){if(i.attackTimer+=e.dt(),z>0&&i.attackTimer>=1/i.fireRate){const H=S.unit(),R=Ro(e,i.pos.x,i.pos.y,H,i.projectileSpeed,i.projectileDamage,0,0,!1);R.isEnemyProjectile=!0,R.color=e.rgb(...i.originalColor),i.attackTimer=0}return}if(i.behavior==="shoot"){i.attackTimer+=e.dt();const H=150;let R=e.vec2(0,0);if(z>H*1.2?R=S.unit().scale(i.speed*e.dt()):z<H*.8&&(R=S.unit().scale(-i.speed*e.dt())),z>0&&i.attackTimer>=1/i.fireRate){const F=S.unit(),G=Ro(e,i.pos.x,i.pos.y,F,i.projectileSpeed,i.projectileDamage,0,0,!1);G.isEnemyProjectile=!0,G.color=e.rgb(...i.originalColor),i.attackTimer=0}if(R.len()>0){const F=v(R);i.pos.x+=F.x,i.pos.y+=F.y;const G=20,Q=i.size||12;i.pos.x=e.clamp(i.pos.x,G+Q,e.width()-G-Q),i.pos.y=e.clamp(i.pos.y,G+Q,e.height()-G-Q)}return}if(i.behavior==="charge"){if(i.chargeTimer+=e.dt(),i.isCharging)if(i.chargeDuration+=e.dt(),i.chargeDuration>=.8)i.isCharging=!1,i.chargeDuration=0,i.chargePauseTimer=0;else{const R=i.chargeDirection.scale(i.speed*e.dt()),F=v(R);F.len()<R.len()*.3?(i.isCharging=!1,i.chargePauseTimer=.1):(i.pos.x+=F.x,i.pos.y+=F.y)}else if(i.chargePauseTimer>0)i.chargePauseTimer+=e.dt(),i.chargePauseTimer>=1&&(i.chargePauseTimer=0,i.chargeTimer=0);else if(i.chargeTimer>=i.chargeCooldown)i.color=e.rgb(255,255,0),e.wait(.2,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor),z>0&&(i.isCharging=!0,i.chargeDirection=S.unit(),i.chargeDuration=0))}),i.chargeTimer=0;else{const R=S.unit().scale(i.speed*.5*e.dt()),F=v(R);F.len()<R.len()*.5&&i.isCharging&&(i.isCharging=!1,i.chargePauseTimer=.1),i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="erratic"){if(z>0){const H=S.unit(),R=e.vec2((Math.random()-.5)*.4,(Math.random()-.5)*.4),G=e.vec2(H.x+R.x,H.y+R.y).unit().scale(i.speed*e.dt()),Q=v(G);i.pos.x+=Q.x,i.pos.y+=Q.y}return}if(i.behavior==="shield"){if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="teleport"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&z>0){const H=S.unit(),R=e.vec2(i.pos.x+H.x*i.teleportRange,i.pos.y+H.y*i.teleportRange);O(R.x,R.y)&&(i.pos.x=R.x,i.pos.y=R.y,i.teleportTimer=0,i.color=e.rgb(255,255,255),e.wait(.1,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))}))}else if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="spawner"){if(i.spawnTimer+=e.dt(),i.spawnTimer>=i.spawnInterval){const H=Math.random()*Math.PI*2,R=30,F=i.pos.x+Math.cos(H)*R,G=i.pos.y+Math.sin(H)*R;if(O(F,G)){const Q=In(e,F,G,i.spawnType||"rusher",i.floor);Q.isBossMinion=!0,i.spawnTimer=0}}if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="buffer"){if(i.attackTimer+=e.dt(),i.attackTimer>=1){const H=e.get("enemy");for(const R of H){if(!R.exists()||R===i)continue;e.vec2(R.pos.x-i.pos.x,R.pos.y-i.pos.y).len()<=i.buffRadius?(R.buffed||(R.buffed=!0,R.originalSpeed=R.speed,R.originalDamage=R.damage||10),R.speed=R.originalSpeed*(1+i.buffAmount),R.damage=R.originalDamage*(1+i.buffAmount),i.buffedEnemies.add(R)):i.buffedEnemies.has(R)&&(R.buffed&&(R.speed=R.originalSpeed,R.damage=R.originalDamage,R.buffed=!1),i.buffedEnemies.delete(R))}i.attackTimer=0}if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="healer"){if(i.healTimer+=e.dt(),i.healTimer>=i.healInterval){const H=e.get("enemy");for(const R of H){if(!R.exists()||R===i)continue;if(e.vec2(R.pos.x-i.pos.x,R.pos.y-i.pos.y).len()<=i.healRadius){const Q=R.hp(),le=R.maxHealth;if(Q<le){const se=Math.min(le,Q+i.healAmount);R.setHP(se);const ne=e.add([e.text("+",{size:16}),e.pos(R.pos.x,R.pos.y-20),e.anchor("center"),e.color(100,255,100),e.z(200)]);e.wait(.5,()=>{ne.exists()&&e.destroy(ne)})}}}i.healTimer=0}if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="teleportPlayer"){if(i.teleportTimer+=e.dt(),i.teleportTimer>=i.teleportCooldown&&z<=80){const H=Math.random()*Math.PI*2,R=x.pos.x+Math.cos(H)*i.teleportRange,F=x.pos.y+Math.sin(H)*i.teleportRange,G=Math.max(50,Math.min(e.width()-50,R)),Q=Math.max(50,Math.min(e.height()-50,F));x.pos.x=G,x.pos.y=Q,i.teleportTimer=0;const le=e.add([e.text("!",{size:24}),e.pos(x.pos.x,x.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.3,()=>{le.exists()&&e.destroy(le)})}if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="freeze"){if(z<=i.slowRadius?(x.slowed||(x.slowed=!0,x.originalSpeed=x.speed),x.speed=x.originalSpeed*(1-i.slowAmount)):x.slowed&&(x.speed=x.originalSpeed,x.slowed=!1),z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="phase"){if(z>0){const H=S.unit();i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt();const R=e.width(),F=e.height(),G=20,Q=i.size||12;i.pos.x=e.clamp(i.pos.x,G+Q,R-G-Q),i.pos.y=e.clamp(i.pos.y,G+Q,F-G-Q)}return}if(i.behavior==="mimic"){if(i.mimicTimer+=e.dt(),i.isMimicking)if(i.mimicMoveIndex<i.mimicMovementHistory.length){const H=i.mimicMovementHistory[i.mimicMoveIndex],R=e.vec2(H.x*e.dt()*60,H.y*e.dt()*60),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y,i.mimicMoveIndex++}else i.isMimicking=!1,i.mimicTimer=0,i.mimicMovementHistory=[],i.mimicMoveIndex=0;else if(i.mimicTimer<i.mimicDuration){if(x.move&&(x.move.x!==0||x.move.y!==0)&&i.mimicMovementHistory.push({x:x.move.x,y:x.move.y}),z>0){const R=S.unit().scale(i.speed*.5*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}}else if(i.mimicTimer>=i.mimicCooldown)if(i.mimicMovementHistory.length>0)i.isMimicking=!0,i.mimicMoveIndex=0,i.color=e.rgb(255,255,255),e.wait(.15,()=>{i.exists()&&(i.color=e.rgb(...i.originalColor))});else{if(z>0){const R=S.unit().scale(i.speed*1.5*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}i.mimicTimer=0}else if(z>0){const R=S.unit().scale(i.speed*e.dt()),F=v(R);i.pos.x+=F.x,i.pos.y+=F.y}return}if(i.behavior==="bomber"){if(i.attackTimer+=e.dt(),z>0&&i.attackTimer>=1/i.fireRate){const H=S.unit(),R=Ro(e,i.pos.x,i.pos.y,H,i.projectileSpeed,i.projectileDamage,0,0,!1);R.isEnemyProjectile=!0,R.isBomb=!0,R.homingStrength=i.homingStrength,R.bombExplosionRadius=i.bombExplosionRadius,R.targetPlayer=x,R.color=e.rgb(255,100,0),R.text="",R.onUpdate(()=>{if(R.targetPlayer&&R.targetPlayer.exists()&&!R.targetPlayer.isDead){const F=e.vec2(R.targetPlayer.pos.x-R.pos.x,R.targetPlayer.pos.y-R.pos.y),G=F.len()>0?F.unit():e.vec2(0,0);R.direction=e.vec2(R.direction.x+(G.x-R.direction.x)*R.homingStrength*e.dt(),R.direction.y+(G.y-R.direction.y)*R.homingStrength*e.dt()).unit()}}),i.attackTimer=0}return}if(i.behavior==="rush"&&z>0){let H;if(i.pathfindingMode==="smart")H=Yy(e,i,x.pos.x,x.pos.y);else{const F=S.unit().scale(i.speed*e.dt());H=v(F).unit()}i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt()}if(i.behavior==="perimeter"){const H=qy(e,i);i.pos.x+=H.x*i.speed*e.dt(),i.pos.y+=H.y*i.speed*e.dt()}const L=e.width(),N=e.height(),_=20,X=i.size||12;i.pos.x=e.clamp(i.pos.x,_+X,L-_-X),i.pos.y=e.clamp(i.pos.y,_+X,N-_-X)}),i.isDead=!1,i.onDeath(()=>{if(i.behavior==="buffer"&&i.buffedEnemies)for(const T of i.buffedEnemies)T.exists()&&T.buffed&&(T.speed=T.originalSpeed,T.damage=T.originalDamage,T.buffed=!1)}),i.onDeath(()=>{if(he()&&me()&&i.mpEntityId&&oc({entityId:i.mpEntityId,entityType:"enemy",x:i.pos.x,y:i.pos.y,xpDropped:i.xpValue}),i.splits&&i.hp()<=0){if(he()&&!me())return;const T=i.splitCount||2,x=i.splitType||"slime";for(let C=0;C<T;C++){const S=Math.PI*2/T*C,z=20,L=i.pos.x+Math.cos(S)*z,N=i.pos.y+Math.sin(S)*z,_=In(e,L,N,x,i.floor);_.maxHealth=Math.max(10,Math.floor(_.maxHealth/2)),_.setHP(_.maxHealth),_.size=Math.max(8,Math.floor(_.size*.8)),_.splits=!1,_.isSplitEnemy=!0,he()&&me()&&Yo&&Yo(_,{maxHealth:_.maxHealth,floor:i.floor})}e.gameData&&e.gameData.incrementSplitEnemies&&e.gameData.incrementSplitEnemies(T),he()&&me()&&Py(T)}if(i.explodes&&i.hp()<=0){(!he()||me())&&e.get("player").forEach(C=>{if(C&&C.exists()&&!C.isDead&&e.vec2(C.pos.x-i.pos.x,C.pos.y-i.pos.y).len()<=i.explosionRadius&&!C.invulnerable){const L=Math.max(1,i.explosionDamage-(C.defense||0));C.hurt(L),C.invulnerable=!0,C.invulnerableTime=C.invulnerableDuration,C.color=e.rgb(255,100,100)}});const T=e.add([e.text("*",{size:24}),e.pos(i.pos.x,i.pos.y),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{T.exists()&&e.destroy(T)})}}),he()&&me()&&(Yo(i,{type:n,floor:s}),i.enemyType=n),i}const Qn={brute:{name:"Security Chief",coreChar:"B",armorChar:"[]",shieldChar:"{}",color:[255,100,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:200,baseArmorHealth:50,baseShieldHealth:0,baseSpeed:60,size:24,baseXPValue:50,damageReduction:.25,shieldRegenRate:0,meleeDamage:18,behavior:"charge"},sentinel:{name:"Technical Director",coreChar:"S",armorChar:"[]",shieldChar:"{}",color:[100,200,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:180,baseArmorHealth:40,baseShieldHealth:30,baseSpeed:50,size:24,baseXPValue:45,damageReduction:.2,shieldRegenRate:2,projectileDamage:12,projectileSpeed:250,fireRate:1.2,behavior:"shoot"},berserker:{name:"Stunt Coordinator",coreChar:"Z",armorChar:"[]",shieldChar:"{}",color:[255,50,50],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:250,baseArmorHealth:0,baseShieldHealth:0,baseSpeed:80,size:24,baseXPValue:55,damageReduction:0,shieldRegenRate:0,meleeDamage:20,behavior:"rush"},guardian:{name:"Studio Manager",coreChar:"G",armorChar:"[]",shieldChar:"{}",color:[150,150,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:220,baseArmorHealth:60,baseShieldHealth:0,baseSpeed:40,size:24,baseXPValue:50,damageReduction:.3,shieldRegenRate:0,meleeDamage:16,behavior:"rush"},warlock:{name:"Creative Director",coreChar:"W",armorChar:"[]",shieldChar:"{}",color:[200,100,255],armorColor:[200,200,200],shieldColor:[100,200,255],baseHealth:160,baseArmorHealth:0,baseShieldHealth:40,baseSpeed:55,size:24,baseXPValue:48,damageReduction:0,shieldRegenRate:3,projectileDamage:14,projectileSpeed:220,fireRate:1,behavior:"shoot"}};function Gy(e){return Qn[e]||Qn.brute}function Ky(e,t,o,n="brute",s=1){const a=Gy(n),r=1+(s-1)*.2,l={coreChar:a.coreChar,armorChar:a.armorChar||"[]",shieldChar:a.shieldChar||"{}",color:a.color,armorColor:a.armorColor||[200,200,200],shieldColor:a.shieldColor||[100,200,255],health:Math.floor(a.baseHealth*r),armorHealth:Math.floor((a.baseArmorHealth||0)*r),maxArmorHealth:Math.floor((a.baseArmorHealth||0)*r),shieldHealth:Math.floor((a.baseShieldHealth||0)*r),maxShieldHealth:Math.floor((a.baseShieldHealth||0)*r),speed:Math.floor(a.baseSpeed*(1+(s-1)*.05)),size:a.size,xpValue:Math.floor(a.baseXPValue*r),damageReduction:a.damageReduction||0,shieldRegenRate:(a.shieldRegenRate||0)*r},c=e.add([e.text(l.coreChar,{size:l.size}),e.pos(t,o),e.anchor("center"),e.color(...l.color),e.area(),e.health(l.health),"miniboss"]);return c.maxHealth=l.health,c.speed=l.speed,c.xpValue=l.xpValue,c.type=n,c.floor=s,a.meleeDamage&&(c.meleeDamage=a.meleeDamage),a.projectileDamage&&(c.projectileDamage=a.projectileDamage),a.projectileSpeed&&(c.projectileSpeed=a.projectileSpeed),a.fireRate&&(c.fireRate=a.fireRate),c.armorHealth=l.armorHealth,c.maxArmorHealth=l.maxArmorHealth,c.damageReduction=l.damageReduction,c.coreChar=l.coreChar,c.armorChar=l.armorChar,c.armorColor=l.armorColor,c.shieldHealth=l.shieldHealth,c.maxShieldHealth=l.maxShieldHealth,c.shieldRegenRate=l.shieldRegenRate,c.shieldChar=l.shieldChar,c.shieldColor=l.shieldColor,c.shieldRegenTimer=0,c.shieldRegenCooldown=0,c.lastDamageTime=0,c.attackTimer=0,c.chargeCooldownTimer=0,c.chargeDurationTimer=0,c.isCharging=!1,c.chargeDirection=null,c.chargeSpeed=0,c.updateVisual=function(){let d="",i="",h="",u="";if(c.shieldHealth>0){const p=c.shieldHealth/c.maxShieldHealth;p>.66?(d="",i=""):p>.33?(d="",i=""):(d="",i="")}if(c.armorHealth>0){const p=c.armorHealth/c.maxArmorHealth;p>.66?(h="",u=""):p>.33?(h="",u=""):(h="",u="")}const g=`${d}${h}${c.coreChar}${u}${i}`;c.text=g,c.shieldHealth>0?c.color=e.rgb(...l.shieldColor):c.color=e.rgb(...l.color)},c.takeDamage=function(d){let i=!1,h=!1;const u=c.shieldHealth,g=c.armorHealth;c.lastDamageTime=e.time();const p=3;if(c.shieldRegenCooldown=p,c.shieldHealth>0){const D=Math.min(d,c.shieldHealth);c.shieldHealth=Math.max(0,c.shieldHealth-D),i=c.shieldHealth!==u;const m=d-D;m>0&&c.takeDamageInternal(m)}else c.takeDamageInternal(d);h=c.armorHealth!==g,(i||h)&&c.updateVisual()},c.takeDamageInternal=function(d){if(c.armorHealth>0){const i=Math.floor(d*(1-c.damageReduction)),h=Math.min(i,c.armorHealth);c.armorHealth=Math.max(0,c.armorHealth-h);const u=d-i;if(u>0){const g=c.armorHealth>0?1-c.damageReduction:1,p=Math.floor(u*g);c.hurt(p)}}else c.hurt(d)},c.startCharge=function(d){if(!c.exists())return;c.isCharging=!0;const i=e.vec2(d.x-c.pos.x,d.y-c.pos.y);i.len()>0&&(c.chargeDirection=i.unit(),c.chargeSpeed=c.speed*2.5)},c.onUpdate(()=>{if(e.paused)return;if(c.shieldRegenRate>0&&c.shieldHealth<c.maxShieldHealth&&c.hp()>0&&!c.isDead&&(c.shieldRegenCooldown>0&&(c.shieldRegenCooldown-=e.dt()),c.shieldRegenCooldown<=0)){c.shieldRegenTimer+=e.dt();const m=1;if(c.shieldRegenTimer>=m){const M=c.shieldRegenRate*m;c.shieldHealth=Math.min(c.maxShieldHealth,c.shieldHealth+M),c.shieldRegenTimer=0,c.shieldHealth>0&&c.updateVisual()}}c.burnDuration>0&&c.hp()>0&&!c.isDead&&(c.burnTimer=(c.burnTimer||0)+e.dt(),c.burnTimer>=.5&&((!he()||me())&&(c.takeDamage?c.takeDamage(c.burnDamage):c.hurt(c.burnDamage)),c.color,c.color=e.rgb(255,150,50),e.wait(.1,()=>{c.exists()&&c.updateVisual()}),c.burnTimer=0),c.burnDuration-=e.dt(),c.burnDuration<=0&&(c.burnDamage=0,c.burnTimer=0));const d=e.get("player")[0];if(!d||!d.exists())return;const i=e.vec2(d.pos.x-c.pos.x,d.pos.y-c.pos.y),h=i.len();if(a.behavior==="charge"){c.attackTimer+=e.dt(),c.chargeCooldownTimer+=e.dt();const m=6,M=200;if(c.isCharging){const B=c.chargeDirection.scale(c.chargeSpeed*e.dt());c.pos.x+=B.x,c.pos.y+=B.y,c.chargeDurationTimer+=e.dt(),c.chargeDurationTimer>=1&&(c.isCharging=!1,c.chargeDurationTimer=0,c.chargeCooldownTimer=0)}else{if(h>0){const P=i.unit().scale(c.speed*e.dt());c.pos.x+=P.x,c.pos.y+=P.y}c.chargeCooldownTimer>=m&&h<M&&(c.color=e.rgb(255,255,0),e.wait(.3,()=>{c.exists()&&(c.color=e.rgb(...l.color),c.startCharge(d.pos))}),c.chargeCooldownTimer=0)}}else if(a.behavior==="shoot"){c.attackTimer+=e.dt();const m=180;if(h>0){const B=i.unit();let P=c.speed;if(h<m){const f=B.scale(-P*e.dt());c.pos.x+=f.x,c.pos.y+=f.y}else if(h>m*1.5){const f=B.scale(P*e.dt());c.pos.x+=f.x,c.pos.y+=f.y}}const M=1/c.fireRate;if(c.attackTimer>=M){if(h>0){const B=i.unit(),P=Ro(e,c.pos.x,c.pos.y,B,c.projectileSpeed,c.projectileDamage,0,0,!1);P.isBossProjectile=!0,P.color=e.rgb(...l.color)}c.attackTimer=0}}else if(a.behavior==="rush"&&h>0){const M=i.unit().scale(c.speed*e.dt());c.pos.x+=M.x,c.pos.y+=M.y}const u=e.width(),g=e.height(),p=20,D=c.size||24;c.pos.x=e.clamp(c.pos.x,p+D,u-p-D),c.pos.y=e.clamp(c.pos.y,p+D,g-p-D)}),c.isDead=!1,c.updateVisual(),c}function Vy(e,t,o,n){const s=e.add([e.rect(40,40),e.pos(t,o),e.anchor("center"),e.area(),e.opacity(0),e.fixed(),"door"]);return s.direction=n,s.open=!1,s.isSpawnDoor=!1,s.blocked=!1,s.gridDirection=null,s.parts=[],s.updateVisual=()=>{s.parts.forEach(r=>{r.exists()&&e.destroy(r)}),s.parts=[];let a;if(s.blocked?a=e.rgb(80,80,80):s.open?a=e.rgb(100,255,100):s.isSpawnDoor?a=e.rgb(200,50,50):a=e.rgb(200,200,100),n==="north"||n==="south"){const r=s.blocked?"":s.open?"":"",l=e.add([e.text(r,{size:24}),e.pos(t,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(l);const c=e.add([e.text(s.open?"":"",{size:20}),e.pos(t-35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(c);const d=e.add([e.text(s.open?"":"",{size:20}),e.pos(t+35,o),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(d)}else{const r=s.blocked?["","",""]:s.open?["","",""]:["","",""],l=16;for(let i=0;i<r.length;i++){const h=(i-1)*l,u=e.add([e.text(r[i],{size:24}),e.pos(t,o+h),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(u)}const c=e.add([e.text(s.open?"":"",{size:20}),e.pos(t,o-l*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(c);const d=e.add([e.text(s.open?"":"",{size:20}),e.pos(t,o+l*1.5),e.anchor("center"),e.color(a),e.fixed(),e.z(100)]);s.parts.push(d)}if(s.blocked){const r=e.add([e.text("X",{size:28}),e.pos(t,o),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(101)]);s.parts.push(r)}},Object.defineProperty(s,"color",{get:()=>s._color,set:a=>{s._color=a,s.parts.forEach(r=>{r.exists()&&(r.color=a)})}}),Object.defineProperty(s,"text",{get:()=>s._text||"=",set:a=>{s._text=a}}),s.onDestroy(()=>{s.parts.forEach(a=>{a.exists()&&e.destroy(a)}),s.parts=[]}),s.updateVisual(),s}function yl(e,t,o,n,s,a="wall",r="#",l=null){const c=a==="wall",d=c?e.rgb(100,100,100):e.rgb(140,140,140),i=c?e.rgb(80,80,80):e.rgb(120,120,120),h=e.add([e.rect(n,s),e.pos(t,o),e.anchor("center"),e.color(l||d),e.outline(2,l||i),e.area({width:n,height:s}),e.fixed(),"obstacle",a==="wall"?"wall":"cover"]);return h.type=a,h.width=n,h.height=s,h}const Wy={CHAR:"",SIZE:20,COLOR:[180,80,40],DAMAGED_COLOR:[220,100,30],CRITICAL_COLOR:[255,60,20],MAX_HEALTH:3,EXPLOSION_RADIUS:80,EXPLOSION_DAMAGE:25,CHAIN_DELAY:.15,KNOCKBACK_FORCE:200,SHAKE_INTENSITY:.5,EXPLOSION_DURATION:.3};let qn=[];function $y(e,t,o,n={}){const s={...Wy,...n},a=e.add([e.text(s.CHAR,{size:s.SIZE}),e.pos(t,o),e.anchor("center"),e.area({width:s.SIZE,height:s.SIZE}),e.color(...s.COLOR),e.z(50),e.opacity(1),"barrel","obstacle",{maxHealth:s.MAX_HEALTH,currentHealth:s.MAX_HEALTH,explosionRadius:s.EXPLOSION_RADIUS,explosionDamage:s.EXPLOSION_DAMAGE,chainDelay:s.CHAIN_DELAY,knockbackForce:s.KNOCKBACK_FORCE,isExploding:!1,barrelId:Math.random().toString(36).substr(2,9)}]),r=e.add([e.rect(24,4),e.pos(t,o-18),e.anchor("center"),e.color(40,40,40),e.z(51),"barrelHealthBar"]),l=e.add([e.rect(22,2),e.pos(t-11,o-18),e.anchor("left"),e.color(255,100,50),e.z(52),"barrelHealthBar"]);return a.healthBarBg=r,a.healthBarFill=l,a.updateHealthBar=()=>{if(!a.exists())return;const c=a.currentHealth/a.maxHealth;r.exists()&&(r.pos.x=a.pos.x,r.pos.y=a.pos.y-18),l.exists()&&(l.pos.x=a.pos.x-11,l.pos.y=a.pos.y-18,l.width=22*c,c<=.33?l.color=e.rgb(255,50,50):c<=.66&&(l.color=e.rgb(255,150,50))),c<=.33?(a.color=e.rgb(...s.CRITICAL_COLOR),a.pos.x+=(Math.random()-.5)*2,a.pos.y+=(Math.random()-.5)*2):c<=.66&&(a.color=e.rgb(...s.DAMAGED_COLOR))},a.takeDamage=(c=1,d=null,i=!1)=>{a.isExploding||!a.exists()||(a.currentHealth-=c,a.updateHealthBar(),!i&&he()&&me()&&Ve("barrel_damage",{x:a.pos.x,y:a.pos.y,damage:c,currentHealth:a.currentHealth}),a.color,a.color=e.rgb(255,255,255),e.wait(.05,()=>{a.exists()&&a.updateHealthBar()}),a.currentHealth<=0&&a.explode(d))},a.explode=(c=null)=>{if(a.isExploding||!a.exists())return;a.isExploding=!0;const d=a.pos.x,i=a.pos.y;he()&&me()&&Ve("barrel_explode",{barrelId:a.barrelId,x:d,y:i,radius:a.explosionRadius,damage:a.explosionDamage}),Jy(e,d,i,a.explosionRadius),jy(e,d,i,a.explosionRadius,a.explosionDamage,a.knockbackForce),e.wait(a.chainDelay,()=>{Zy(e,d,i,a.explosionRadius,a.barrelId)}),r.exists()&&e.destroy(r),l.exists()&&e.destroy(l),qn=qn.filter(h=>h!==a),e.destroy(a)},qn.push(a),a}function Jy(e,t,o,n){const s=e.add([e.circle(n),e.pos(t,o),e.anchor("center"),e.color(255,150,50),e.opacity(.8),e.scale(1),e.z(100),"explosionEffect"]),a=e.add([e.circle(n*.6),e.pos(t,o),e.anchor("center"),e.color(255,255,150),e.opacity(.9),e.scale(1),e.z(101),"explosionEffect"]),r=e.add([e.text("*",{size:40}),e.pos(t,o),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.scale(1),e.z(102),"explosionEffect"]);e.tween(s.scale,e.vec2(1.5,1.5),.2,l=>s.scale=l),e.tween(s.opacity,0,.3,l=>s.opacity=l,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)}),e.tween(a.scale,e.vec2(1.3,1.3),.15,l=>a.scale=l),e.tween(a.opacity,0,.25,l=>a.opacity=l,e.easings.easeOutQuad).onEnd(()=>{a.exists()&&e.destroy(a)}),e.tween(r.scale,e.vec2(2,2),.1,l=>r.scale=l),e.tween(r.opacity,0,.2,l=>r.opacity=l).onEnd(()=>{r.exists()&&e.destroy(r)});for(let l=0;l<8;l++){const c=Math.PI*2*l/8,d=100+Math.random()*100,i=e.add([e.text(["#","*","+","~"][Math.floor(Math.random()*4)],{size:12}),e.pos(t,o),e.anchor("center"),e.color(255,150+Math.random()*100,50),e.opacity(1),e.z(99),"explosionDebris"]),h=t+Math.cos(c)*d,u=o+Math.sin(c)*d;e.tween(i.pos,e.vec2(h,u),.4,g=>i.pos=g,e.easings.easeOutQuad),e.tween(i.opacity,0,.4,g=>i.opacity=g).onEnd(()=>{i.exists()&&e.destroy(i)})}}function jy(e,t,o,n,s,a,r){e.get("enemy").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);if(l.takeDamage?l.takeDamage(i):l.hp&&l.hurt(i),c>0){const h=e.vec2(l.pos.x-t,l.pos.y-o).unit(),u=a*d;l.pos.x+=h.x*u*.1,l.pos.y+=h.y*u*.1}}}),e.get("miniboss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);l.takeDamage&&l.takeDamage(i,null)}}),e.get("boss").forEach(l=>{if(!l.exists())return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d);l.takeDamage&&l.takeDamage(i,null)}}),e.get("player").forEach(l=>{if(!l.exists()||l.isDead)return;const c=e.vec2(l.pos.x-t,l.pos.y-o).len();if(c<=n){const d=1-c/n*.5,i=Math.floor(s*d*.5);if(!l.invulnerable&&(l.hurt(i),c>0)){const h=e.vec2(l.pos.x-t,l.pos.y-o).unit(),u=a*d;l.pos.x+=h.x*u*.05,l.pos.y+=h.y*u*.05}}})}function Zy(e,t,o,n,s){const a=n*1.2;qn.forEach(r=>{if(!r.exists()||r.isExploding||r.barrelId===s)return;e.vec2(r.pos.x-t,r.pos.y-o).len()<=a&&r.takeDamage(r.maxHealth,s)})}function xl(e,t,o=5){return qn.find(n=>{if(!n.exists()||n.isExploding)return!1;const s=Math.abs(n.pos.x-e),a=Math.abs(n.pos.y-t);return s<=o&&a<=o})||null}function Qy(){qn.forEach(e=>{e.exists()&&(e.healthBarBg&&e.healthBarBg.exists()&&e.healthBarBg.destroy(),e.healthBarFill&&e.healthBarFill.exists()&&e.healthBarFill.destroy(),e.destroy())}),qn=[]}class za{constructor(t=128){this.cellSize=t,this.cells=new Map,this.entityToCell=new Map}getCellKey(t,o){const n=Math.floor(t/this.cellSize),s=Math.floor(o/this.cellSize);return`${n},${s}`}insert(t){if(!t||!t.pos)return;const o=this.getCellKey(t.pos.x,t.pos.y);this.cells.has(o)||this.cells.set(o,new Set),this.cells.get(o).add(t),this.entityToCell.set(t,o)}remove(t){if(!t)return;const o=this.entityToCell.get(t);if(!o)return;const n=this.cells.get(o);n&&(n.delete(t),n.size===0&&this.cells.delete(o)),this.entityToCell.delete(t)}update(t){if(!t||!t.pos)return;const o=this.entityToCell.get(t),n=this.getCellKey(t.pos.x,t.pos.y);o!==n&&(this.remove(t),this.insert(t))}getNearby(t,o,n){const s=[],a=Math.ceil(n/this.cellSize),r=this.getCellKey(t,o),[l,c]=r.split(",").map(Number);for(let d=-a;d<=a;d++)for(let i=-a;i<=a;i++){const h=`${l+d},${c+i}`,u=this.cells.get(h);u&&s.push(...u)}return s}getInBounds(t,o,n,s){const a=[],r=Math.floor(t/this.cellSize),l=Math.floor(o/this.cellSize),c=Math.floor(n/this.cellSize),d=Math.floor(s/this.cellSize);for(let i=r;i<=c;i++)for(let h=l;h<=d;h++){const u=`${i},${h}`,g=this.cells.get(u);g&&a.push(...g)}return a}getAt(t,o){const n=this.getCellKey(t,o),s=this.cells.get(n);return s?[...s]:[]}clear(){this.cells.clear(),this.entityToCell.clear()}getStats(){let t=0,o=0,n=1/0;return this.cells.forEach(s=>{const a=s.size;t+=a,o=Math.max(o,a),n=Math.min(n,a)}),{cellCount:this.cells.size,totalEntities:t,averageEntitiesPerCell:this.cells.size>0?(t/this.cells.size).toFixed(2):0,maxEntitiesInCell:o,minEntitiesInCell:n===1/0?0:n,cellSize:this.cellSize}}}let qo=null,vs=1,na=1,nc=1,Ch=!0,sc=!0,wo=null,yr=null;const ky={menu:"./audio/menu-theme.mp3",combat:"./audio/combat-theme.mp3",defeat:"./audio/defeat-theme.mp3"},Oa={};function Rh(){return qo||(qo=new(window.AudioContext||window.webkitAudioContext)),qo}function ex(){qo&&qo.state==="suspended"&&qo.resume().then(()=>{console.log("[Audio] AudioContext resumed")}).catch(e=>{console.warn("[Audio] Failed to resume AudioContext:",e)})}function ic(){return qo||Rh(),qo&&qo.state==="suspended"&&qo.resume(),qo}function Ph(e){vs=Math.max(0,Math.min(1,e)),wo&&(wo.volume=na*vs)}function Ih(e){nc=Math.max(0,Math.min(1,e))}function Bh(e){Ch=e}function Lh(e){sc=e}function Je(e,t,o="square",n=.3,s={}){if(s.isUI&&!Ch||s.isCombat&&!sc)return;const a=ic(),r=a.currentTime,l=a.createOscillator();l.type=o,l.frequency.setValueAtTime(e,r),s.pitchBend&&l.frequency.exponentialRampToValueAtTime(e*s.pitchBend,r+t);const c=a.createGain(),d=n*nc*vs,i=s.attack||.01;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(d,r+i);const h=s.decay||.1;c.gain.setValueAtTime(d,r+t-h),c.gain.exponentialRampToValueAtTime(.01,r+t),l.connect(c),c.connect(a.destination),l.start(r),l.stop(r+t)}function Ts(e,t=.3,o={}){if(o.isCombat&&!sc)return;const n=ic(),s=n.currentTime,a=n.sampleRate*e,r=n.createBuffer(1,a,n.sampleRate),l=r.getChannelData(0);for(let p=0;p<a;p++)l[p]=Math.random()*2-1;const c=n.createBufferSource();c.buffer=r;const d=n.createBiquadFilter();d.type=o.filterType||"lowpass",d.frequency.setValueAtTime(o.filterFreq||2e3,s);const i=n.createGain(),h=t*nc*vs,u=o.attack||.01,g=o.decay||.1;i.gain.setValueAtTime(0,s),i.gain.linearRampToValueAtTime(h,s+u),i.gain.setValueAtTime(h,s+e-g),i.gain.exponentialRampToValueAtTime(.01,s+e),c.connect(d),d.connect(i),i.connect(n.destination),c.start(s),c.stop(s+e)}function Xe(e,t=.1){return e*(1+(Math.random()-.5)*t)}function zh(){const e=Math.random();e<.33?Je(Xe(280,.15),.08,"triangle",.14,{attack:.002,decay:.05,pitchBend:.65}):e<.66?Je(Xe(320,.15),.09,"sine",.13,{attack:.003,decay:.06,pitchBend:.7}):Je(Xe(300,.15),.07,"triangle",.14,{attack:.002,decay:.04,pitchBend:.6})}function tx(){const e=Math.random();e<.33?Je(Xe(220,.3),.04,"triangle",.08,{attack:.001,decay:.025,pitchBend:.5}):e<.66?Je(Xe(240,.3),.035,"sine",.09,{attack:.001,decay:.02,pitchBend:.6}):Je(Xe(200,.3),.045,"triangle",.08,{attack:.001,decay:.03,pitchBend:.4})}function ox(){const e=Xe(60,.15);Je(e,.1,"sine",.12,{attack:.002,decay:.08,pitchBend:.4}),Ts(Xe(.04,.2),Xe(.12,.2),{attack:.002,decay:.06,filterType:"lowpass",filterFreq:Xe(800,.3)})}function nx(){Je(Xe(350,.2),.05,"triangle",.12,{attack:.001,decay:.03,pitchBend:.3}),Je(Xe(50,.15),.1,"sine",.1,{attack:.001,decay:.07,pitchBend:.5})}function sx(){Ts(.08,Xe(.15,.4),{attack:.005,decay:.04,filterType:"bandpass",filterFreq:Xe(800,.5)})}function ix(){Je(Xe(55,.2),.15,"sine",.1,{attack:.002,decay:.12,pitchBend:.4}),Je(Xe(100,.2),.12,"triangle",.08,{attack:.005,decay:.08,pitchBend:.5})}function ax(){Je(Xe(250,.3),.08,"triangle",.1,{attack:.001,decay:.06,pitchBend:1.6}),Ts(Xe(.03,.3),.08,{attack:.001,decay:.04,filterType:"bandpass",filterFreq:Xe(2e3,.4)})}function rx(){Je(Xe(180,.4),.1,"triangle",.14,{attack:.02,decay:.06,pitchBend:1.3})}function cx(){zh()}function wl(){const e=Math.random();e<.25?Je(Xe(280,.2),.06,"sine",.12,{attack:.002,decay:.04,pitchBend:.2}):e<.5?Je(Xe(320,.2),.05,"triangle",.12,{attack:.002,decay:.035,pitchBend:.15}):e<.75?Je(Xe(240,.2),.07,"sine",.14,{attack:.003,decay:.05,pitchBend:.25}):Je(Xe(360,.2),.05,"triangle",.1,{attack:.002,decay:.03,pitchBend:.1})}function An(){const e=Math.random();e<.33?(Je(Xe(180,.2),.1,"triangle",.18,{attack:.003,decay:.07,pitchBend:.2}),Je(Xe(400,.2),.06,"sine",.1,{attack:.005,decay:.04,pitchBend:.1})):e<.66?(Je(Xe(160,.2),.12,"triangle",.18,{attack:.003,decay:.08,pitchBend:.25}),Je(Xe(320,.2),.07,"sine",.12,{attack:.005,decay:.05,pitchBend:.15})):(Je(Xe(200,.2),.11,"triangle",.18,{attack:.003,decay:.08,pitchBend:.3}),Je(Xe(440,.2),.05,"sine",.08,{attack:.005,decay:.03,pitchBend:.1}))}function bl(){const e=Math.random();e<.33?Je(Xe(200,.2),.25,"sawtooth",.2,{attack:.01,decay:.2,pitchBend:.2}):e<.66?(Je(Xe(180,.2),.3,"square",.2,{attack:.01,decay:.25,pitchBend:.15}),Ts(.15,.12,{attack:.05,decay:.1,filterFreq:Xe(1500,.4)})):Je(Xe(220,.2),.28,"triangle",.2,{attack:.01,decay:.23,pitchBend:.25})}function Oh(){Je(Xe(50,.15),.3,"sawtooth",.3,{attack:.001,decay:.25,pitchBend:.3}),Je(Xe(100,.2),.25,"square",.25,{attack:.005,decay:.2,pitchBend:.4}),Ts(Xe(.3,.2),Xe(.25,.3),{attack:.001,decay:.25,filterType:"lowpass",filterFreq:Xe(1200,.5)})}function lx(){const e=Math.random();e<.33?Je(Xe(600,.2),.08,"sine",.15,{attack:.01,decay:.05,pitchBend:1.2}):e<.66?Je(Xe(650,.2),.09,"triangle",.15,{attack:.01,decay:.06,pitchBend:1.3}):Je(Xe(550,.2),.1,"sine",.15,{attack:.01,decay:.07,pitchBend:1.15})}function vl(){const e=Math.random();e<.33?(Je(Xe(800,.2),.06,"sine",.16,{attack:.005,decay:.04}),setTimeout(()=>{Je(Xe(1e3,.2),.05,"triangle",.14,{attack:.005,decay:.03})},30)):e<.66?(Je(Xe(900,.2),.08,"triangle",.16,{attack:.005,decay:.05,pitchBend:.85}),Je(Xe(1200,.2),.06,"sine",.12,{attack:.01,decay:.04})):(Je(Xe(750,.2),.05,"square",.14,{attack:.005,decay:.03}),setTimeout(()=>{Je(Xe(1100,.2),.07,"sine",.16,{attack:.005,decay:.05})},40))}function dx(){ic().currentTime;const t=400;[1,1.25,1.5,2].forEach((n,s)=>{setTimeout(()=>{Je(t*n,.15,"square",.2,{attack:.01,decay:.1})},s*80)})}function Ha(){Je(Xe(200,.2),.25,"sawtooth",.18,{attack:.02,decay:.15,pitchBend:1.6})}function Ot(){Je(Xe(500,.15),.08,"square",.15,{attack:.01,decay:.05})}function et(){Je(Xe(400,.15),.06,"triangle",.12,{attack:.01,decay:.04})}function hx(){Je(Xe(500,.1),.2,"square",.18,{attack:.01,decay:.15}),setTimeout(()=>{Je(Xe(750,.1),.18,"square",.15,{attack:.01,decay:.13})},50)}function El(){Je(Xe(50,.1),.5,"sawtooth",.25,{attack:.05,decay:.4,pitchBend:.8}),setTimeout(()=>{Je(Xe(800,.2),.3,"square",.2,{attack:.01,decay:.25})},100)}function ux(){for(let t=0;t<8;t++)setTimeout(()=>{Je(400*(1-t*.1),.15,"sawtooth",.2,{attack:.01,decay:.1})},t*60);setTimeout(()=>{Oh()},480)}function fx(){[400,500,600,800].forEach((t,o)=>{setTimeout(()=>{Je(t,.2,"square",.18,{attack:.01,decay:.15})},o*100)})}function Di(){Je(Xe(600,.1),.15,"sine",.2,{attack:.01,decay:.1}),setTimeout(()=>{Je(Xe(800,.1),.2,"sine",.18,{attack:.01,decay:.15})},80)}function Ua(){Je(Xe(150,.1),.2,"sawtooth",.2,{attack:.01,decay:.15,pitchBend:.7}),Ts(.1,.15,{attack:.01,decay:.08,filterType:"lowpass",filterFreq:Xe(500,.3)})}function px(){Je(Xe(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:.8})}function Al(){Je(Xe(400,.1),.08,"square",.15,{attack:.01,decay:.05,pitchBend:1.2})}function gx(e){const t=e?.toLowerCase()||"";t.includes("pistol")?zh():t.includes("smg")||t.includes("submachine")?tx():t.includes("shotgun")?ox():t.includes("sniper")||t.includes("rifle")?nx():t.includes("flame")||t.includes("thrower")?sx():t.includes("explosive")||t.includes("launcher")||t.includes("rocket")?ix():t.includes("chain")||t.includes("lightning")?ax():t.includes("orbital")?rx():cx()}function Hh(e){na=Math.max(0,Math.min(1,e)),wo&&(wo.volume=na*vs)}function Uh(){wo&&(wo.pause(),wo.currentTime=0,wo=null,yr=null)}function ac(e,t=!0){if(yr===e&&wo&&!wo.paused)return;Uh();const o=ky[e];if(!o){console.warn(`[Music] Unknown track: ${e}`);return}try{Oa[e]||(Oa[e]=new Audio(o)),wo=Oa[e],wo.loop=t,wo.volume=na*vs,yr=e;const n=wo.play();n!==void 0&&n.catch(s=>{console.warn(`[Music] Playback failed for ${e}:`,s.message)})}catch(n){console.warn(`[Music] Failed to play ${e}:`,n.message)}}function Sl(){ac("menu")}function mx(){ac("combat")}function yx(){ac("defeat")}const Nh="superSmashTexty_settings",ci={version:1,audio:{masterVolume:1,sfxVolume:1,musicVolume:.35,uiSounds:!0,combatSounds:!0},controls:{moveUp:"w",moveDown:"s",moveLeft:"a",moveRight:"d",pause:"escape",interact:"space"},visual:{showParticles:!0,showScreenShake:!0,showHitFreeze:!0,showDamageNumbers:!0,compactHUD:!1,showFPS:!1,showTimer:!0},gameplay:{autoPause:!1,autoPickupCurrency:!1,autoPickupXP:!1,confirmBeforeQuit:!0,skipIntroAnimation:!1},accessibility:{colorblindMode:"off",reducedMotion:!1,largeText:!1,highContrast:!1}};function rc(){try{const e=localStorage.getItem(Nh);if(e){const t=JSON.parse(e);return _h(ci,t)}}catch(e){console.error("Error loading settings:",e)}return{...ci}}function _h(e,t){const o={...e};return Na(e)&&Na(t)&&Object.keys(t).forEach(n=>{Na(t[n])?n in e?o[n]=_h(e[n],t[n]):Object.assign(o,{[n]:t[n]}):Object.assign(o,{[n]:t[n]})}),o}function Na(e){return e&&typeof e=="object"&&!Array.isArray(e)}function Xh(e){try{return localStorage.setItem(Nh,JSON.stringify(e)),!0}catch(t){return console.error("Error saving settings:",t),!1}}function xr(){return rc()}function so(e,t,o){const n=rc();return n[e]||(n[e]={}),n[e][t]=o,Xh(n),n}function bo(e,t){return rc()[e]?.[t]??ci[e]?.[t]}function xx(){return Xh({...ci}),{...ci}}function Vo(e,t,o,n={}){const s=Th();if(s)return s.acquire(t,o,n);const{char:a="*",size:r=12,color:l=[255,255,255],velocity:c={x:0,y:0},gravity:d=0,lifetime:i=1,fadeStart:h=.3,friction:u=.95,zIndex:g=100}=n,p=e.add([e.text(a,{size:r}),e.pos(t,o),e.anchor("center"),e.color(...l),e.z(g),"particle"]);return p.velocity={x:c.x,y:c.y},p.gravity=d,p.friction=u,p.lifetime=i,p.fadeStart=h,p.age=0,p.initialOpacity=1,p}function wx(e,t){const o=Th();o&&t._pooled?o.release(t):e.destroy(t)}function bx(e){e.get("particle").forEach(o=>{if(!o.exists()||o.hidden)return;if(o.age+=e.dt(),o.age>=o.lifetime){wx(e,o);return}o.pos.x+=o.velocity.x*e.dt()*60,o.pos.y+=o.velocity.y*e.dt()*60,o.velocity.y+=o.gravity*e.dt()*60,o.velocity.x*=o.friction,o.velocity.y*=o.friction;const n=o.age/o.lifetime;if(n>=o.fadeStart){const s=(n-o.fadeStart)/(1-o.fadeStart);o.opacity=o.initialOpacity*(1-s)}})}function gi(){return!(bo("visual","showParticles")===!1||bo("accessibility","reducedMotion"))}function xo(e,t,o,n={}){if(!gi())return;const{count:s=8,color:a=[255,50,50],speed:r=2,isCrit:l=!1}=n,c=[".",",","'","`","*"],d=l?s*1.5:s,i=l?r*1.5:r,h=l?[255,200,0]:a;for(let u=0;u<d;u++){const g=Math.PI*2*u/d+(Math.random()-.5)*.5,p=.5+Math.random()*.5,D={x:Math.cos(g)*i*p,y:Math.sin(g)*i*p};Vo(e,t,o,{char:c[Math.floor(Math.random()*c.length)],size:8+Math.random()*6,color:h,velocity:D,gravity:.15,lifetime:.5+Math.random()*.3,fadeStart:.4,friction:.92})}}function Vs(e,t,o,n={}){if(!gi())return;const{count:s=8,color:a=[255,100,100],speed:r=2.5,isBoss:l=!1,isMiniboss:c=!1}=n,d=["*","+",""],i=l?s*2:c?s*1.5:s,h=l?r*1.5:c?r*1.2:r;for(let u=0;u<i;u++){const g=Math.PI*2*u/i+(Math.random()-.5)*.3,p=.6+Math.random()*.4,D={x:Math.cos(g)*h*p,y:Math.sin(g)*h*p};Vo(e,t,o,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*6,color:a,velocity:D,gravity:.1,lifetime:.5+Math.random()*.3,fadeStart:.2,friction:.92})}}function Os(e,t,o,n,s={}){if(!gi())return;const{count:a=5,color:r=[255,255,100],speed:l=2.5,isCrit:c=!1}=s,d=["","","",""],i=c?a*2:a,h=c?[255,200,0]:r,u=Math.sqrt(n.x*n.x+n.y*n.y),g=u>0?{x:n.x/u,y:n.y/u}:{x:1,y:0};for(let p=0;p<i;p++){const D=(Math.random()-.5)*Math.PI*.6,m=Math.atan2(g.y,g.x)+D,M=.6+Math.random()*.8,B={x:Math.cos(m)*l*M,y:Math.sin(m)*l*M};Vo(e,t,o,{char:d[Math.floor(Math.random()*d.length)],size:10+Math.random()*4,color:h,velocity:B,gravity:.05,lifetime:.3+Math.random()*.2,fadeStart:.3,friction:.88,zIndex:150})}}function vx(e,t,o,n,s){if(!gi())return;const r={trailFire:["","","",""],trailIce:["*","","",""],trailPoison:["~","","",""],trailShadow:["","","",""],trailRainbow:["","","",""]}[n]||["","","*"],l=r[Math.floor(Math.random()*r.length)];let c=s;if(s==="rainbow"){const h=Date.now()*.1%360;c=Ex(h,100,60)}const d=(Math.random()-.5)*8,i=(Math.random()-.5)*8;Vo(e,t+d,o+i,{char:l,size:10+Math.random()*6,color:c,velocity:{x:(Math.random()-.5)*.3,y:(Math.random()-.5)*.3},gravity:n==="trailFire"?-.02:.01,lifetime:.4+Math.random()*.2,fadeStart:.2,friction:.98,zIndex:-10})}function Ex(e,t,o){t/=100,o/=100;const n=t*Math.min(o,1-o),s=a=>{const r=(a+e/30)%12;return o-n*Math.max(Math.min(r-3,9-r,1),-1)};return[Math.round(s(0)*255),Math.round(s(8)*255),Math.round(s(4)*255)]}function Ml(e,t,o,n){const s=e.add([e.text("",{size:48}),e.pos(t.pos.x,t.pos.y),e.anchor("center"),e.color(...n),e.opacity(.3),e.z(-5),"playerGlow"]);return s.target=t,s.glowType=o,s.pulseTime=0,s.baseOpacity=.25,s}function Ax(e,t){if(!t||!t.exists()||!t.target||!t.target.exists()){t&&t.exists()&&e.destroy(t);return}t.pos=t.target.pos.clone(),t.pulseTime+=e.dt()*3;const o=Math.sin(t.pulseTime)*.1;t.opacity=t.baseOpacity+o,t.glowType==="glowElectric"&&Math.random()<.05&&(t.opacity=t.baseOpacity+.3)}function Sx(e,t,o,n,s=[255,100,100]){if(gi())switch(n){case"deathExplosion":Mx(e,t,o,s);break;case"deathDisintegrate":Tx(e,t,o,s);break;case"deathVaporize":Dx(e,t,o,s);break;case"deathPixelate":Cx(e,t,o,s);break;case"deathFireworks":Rx(e,t,o,s);break;default:Vs(e,t,o,{color:s})}}function Mx(e,t,o,n){const s=["*","#","@","X","+",""],r=e.add([e.text("",{size:40}),e.pos(t,o),e.anchor("center"),e.color(255,255,200),e.opacity(1),e.z(200),"particle"]);r.age=0,r.lifetime=.2,r.fadeStart=0,r.velocity={x:0,y:0},r.gravity=0,r.friction=1;for(let l=0;l<20;l++){const c=Math.PI*2*l/20,d=4+Math.random()*2;Vo(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:14+Math.random()*10,color:[255,200,100],velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.92})}for(let l=0;l<20/2;l++){const c=Math.random()*Math.PI*2,d=2+Math.random()*2;Vo(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:10+Math.random()*6,color:n,velocity:{x:Math.cos(c)*d,y:Math.sin(c)*d},gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}}function Tx(e,t,o,n){const s=["","","","","",""];for(let r=0;r<25;r++){const l=(Math.random()-.5)*20,c=(Math.random()-.5)*20,d=Math.random()*Math.PI*2,i=.5+Math.random()*1.5;Vo(e,t+l,o+c,{char:s[Math.floor(Math.random()*s.length)],size:8+Math.random()*8,color:[n[0]*(.6+Math.random()*.4),n[1]*(.6+Math.random()*.4),n[2]*(.6+Math.random()*.4)],velocity:{x:Math.cos(d)*i,y:Math.sin(d)*i},gravity:.2,lifetime:1+Math.random()*.5,fadeStart:.5,friction:.96})}}function Dx(e,t,o,n){const s=["~","","","",""];for(let r=0;r<20;r++){const l=(Math.random()-.5)*15,c=Math.random()*Math.PI*2,d=.3+Math.random()*.5;Vo(e,t+l,o,{char:s[Math.floor(Math.random()*s.length)],size:10+Math.random()*10,color:[Math.min(255,n[0]+100),Math.min(255,n[1]+100),Math.min(255,n[2]+100)],velocity:{x:Math.cos(c)*d,y:-1.5-Math.random()*1.5},gravity:-.05,lifetime:1.2+Math.random()*.5,fadeStart:.3,friction:.98})}}function Cx(e,t,o,n){const s=["","","","","",""];for(let l=-5/2;l<=5/2;l++)for(let c=-5/2;c<=5/2;c++){const d=l*6,i=c*6,h=Math.sqrt(l*l+c*c),u=Math.atan2(c,l),g=1+h*.3+Math.random()*.5;Vo(e,t+d,o+i,{char:s[Math.floor(Math.random()*s.length)],size:8+Math.random()*4,color:n,velocity:{x:Math.cos(u)*g,y:Math.sin(u)*g},gravity:.08,lifetime:.6+Math.random()*.4,fadeStart:.4,friction:.94})}}function Rx(e,t,o,n){const s=["*","+","x","X","#"];for(let c=0;c<12;c++){const d=Math.PI*2*c/12,i=.7+Math.random()*.6,h={x:Math.cos(d)*3*i,y:Math.sin(d)*3*i};Vo(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:12+Math.random()*8,color:n,velocity:h,gravity:.1,lifetime:.8+Math.random()*.4,fadeStart:.3,friction:.94})}const l=Math.floor(12/2);for(let c=0;c<l;c++){const d=Math.random()*Math.PI*2,i=.3+Math.random()*.4,h={x:Math.cos(d)*3*i*.5,y:Math.sin(d)*3*i*.5};Vo(e,t,o,{char:s[Math.floor(Math.random()*s.length)],size:16+Math.random()*8,color:[255,200,100],velocity:h,gravity:.05,lifetime:.6+Math.random()*.3,fadeStart:.2,friction:.9})}}let To=null,ko=null,en=0,Cn=0,Qs=!1,wr=0;const Px=.05;let br=0;const Ix=100;function Bx(e){To=e}function Sn(e=5,t=.1){if(!To||!bo("visual","showScreenShake")||bo("accessibility","reducedMotion"))return;const o=To.time();if(o-wr<Px){en>0&&(Cn=Math.max(Cn,e),en=Math.max(en,t));return}wr=o,en<=0&&(ko=To.camPos()),Cn=Math.max(Cn,e),en=Math.max(en,t)}function Lx(e){if(!(!To||en<=0))if(en-=e,en>0){const t=(Math.random()-.5)*2*Cn,o=(Math.random()-.5)*2*Cn;ko&&To.camPos(ko.x+t,ko.y+o)}else ko&&To.camPos(ko),Cn=0,ko=null}function Hs(e=50){if(!To||!bo("visual","showHitFreeze")||bo("accessibility","reducedMotion")||To.paused||Qs)return;const t=Date.now();t-br<Ix||(br=t,To.paused=!0,Qs=!0,setTimeout(()=>{To.paused=!1,Qs=!1},e))}function zx(){return Qs}const fn={playerHit:()=>{Sn(6,.1),Hs(30)},criticalHit:()=>{Sn(4,.08),Hs(40)},bossHit:()=>{Sn(3,.05)},bossDeath:()=>{Sn(15,.3),Hs(100)},explosion:()=>{Sn(10,.2),Hs(60)},playerDeath:()=>{Sn(12,.25),Hs(150)},levelUp:()=>{Sn(5,.15)},smallImpact:()=>{Sn(2,.05)}};function Ox(){en=0,Cn=0,To&&ko&&To.camPos(ko),ko=null,wr=0,br=0,Qs=!1}function _a(e,t,o,n,s={}){if(bo("visual","showDamageNumbers")===!1)return;const{isCrit:a=!1,color:r=a?[255,200,50]:[255,255,255]}=s,l=a?18:14,c=a?`${n}!`:`${n}`,d=(Math.random()-.5)*20,i=(Math.random()-.5)*10,h=e.add([e.text(c,{size:l}),e.pos(t+d,o-20+i),e.anchor("center"),e.color(...r),e.z(500),"damageNumber"]);let u=0;const g=.8;h.onUpdate(()=>{u+=e.dt(),h.pos.y-=40*e.dt(),h.opacity=Math.max(0,1-u/g),u>=g&&e.destroy(h)})}function Us(e,t,o,n){if(!t||!t.exists())return;const s=20,a=e.width()-s,r=e.height()-s,l=s,c=s,d=t.pos.x+o.x*n,i=t.pos.y+o.y*n,h=Math.max(l,Math.min(a,d)),u=Math.max(c,Math.min(r,i)),g=t.pos.x,p=t.pos.y;t.pos.x=h,t.pos.y=u;const D=e.get("wall"),m=e.get("obstacle"),M=[...D,...m];let B=!1;for(const P of M)if(P.exists()&&t.isColliding&&t.isColliding(P)){B=!0;break}B&&(t.pos.x=g,t.pos.y=p)}function Tl(e,t){let o=0;t.weaponKey==="orbital"&&vr(e,t),e.onUpdate(()=>{if(e.paused)return;if(t.isRemote)t.aimAngle!==void 0&&(t.angle=t.aimAngle,t.outline&&t.outline.exists()&&(t.outline.angle=t.aimAngle));else{const i=Zc();let h,u;if(i.active&&(i.x!==0||i.y!==0))h=e.vec2(i.x,i.y),u=1;else{const g=e.mousePos();h=e.vec2(g.x-t.pos.x,g.y-t.pos.y),u=h.len()}if(u>0){const g=Math.atan2(h.y,h.x)*(180/Math.PI);t.angle=g,t.outline&&t.outline.exists()&&(t.outline.angle=g)}}if(t.canShoot===!1){t.isShooting=!1;return}const n=e.get("enemy"),s=e.get("boss"),a=e.get("miniboss");if(!(n.length>0||s.length>0||a.length>0)&&t.weaponKey!=="orbital"){t.isShooting=!1;return}if(t.weaponKey==="orbital"){Hx(e,t),t.isShooting=!1;return}const l=e.time();let c,d=!1;if(t.isRemote){if(he()&&!me()){t.isShooting=!1;return}if(t.aimAngle!==void 0&&t.isShooting){const i=t.aimAngle*(Math.PI/180);c=e.vec2(Math.cos(i),Math.sin(i)),d=!0}else{t.isShooting=!1;return}}else{const i=Zc();let h,u;if(i.active&&(i.x!==0||i.y!==0))h=e.vec2(i.x,i.y),u=1;else{const g=e.mousePos();h=e.vec2(g.x-t.pos.x,g.y-t.pos.y),u=h.len()}if(u>0){if(t.aimAngle=Math.atan2(h.y,h.x)*(180/Math.PI),c=h.unit(),he()&&!me()){t.isShooting=u>0&&t.canShoot;return}d=!0}else{t.aimAngle=0,t.isShooting=!1;return}t.isShooting=u>0&&t.canShoot}if(d&&c){let i=t.fireRate;if(t.bulletTimeEnabled&&t.bulletTimeBonus&&t.move&&(t.move.x!==0||t.move.y!==0)&&(i=t.fireRate*(1+t.bulletTimeBonus)),t.speedDemonEnabled&&t.speedDemonFireRatePerStack){const h=t.upgradeStacks?.speed||0;h>0&&(i=i*(1+h*t.speedDemonFireRatePerStack))}if(l-o>=1/i){const h=t.projectileCount||1,u=t.spreadAngle||0,g=[];if(h===1)g.push(c);else if(u>0){const p=h>1?u/(h-1):0,D=-u/2;for(let m=0;m<h;m++){const B=(D+p*m)*(Math.PI/180),P=Math.cos(B),f=Math.sin(B),O=e.vec2(c.x*P-c.y*f,c.x*f+c.y*P);g.push(O.unit())}}else for(let p=0;p<h;p++)g.push(c);g.forEach((p,D)=>{const m=u===0&&h>1?D*uo.MULTISHOT_STAGGER_DELAY:0;e.wait(m,()=>{const M=lm(t.critChance||0);let B=M?dm(t.projectileDamage,t.critDamage||2):t.projectileDamage;t.piercingDamageBonus&&(t.piercing||0)>0&&(B=Math.floor(B*t.piercingDamageBonus));let P=t.weaponRange||ms.DEFAULT_WEAPON_RANGE;if(M&&t.deadeyeEnabled&&t.deadeyeRangeBonus&&(P=P*(1+t.deadeyeRangeBonus)),gx(t.weaponKey),t.weaponKey==="flamethrower"){const f=Ro(e,t.pos.x,t.pos.y,p,t.projectileSpeed,B,t.piercing||0,t.obstaclePiercing||0,M,P);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex;const O=Math.floor(B*.3),v=2,T=t.fireDotMultiplier||1;f.burnDamage=Math.floor(O*T),f.burnDuration=v,he()&&me()&&us(f,{weaponKey:t.weaponKey,burnDamage:f.burnDamage,burnDuration:f.burnDuration})}else if(t.weaponKey==="explosive"){const f=Ux(e,t.pos.x,t.pos.y,p,t.projectileSpeed,B,t.explosionRadius,t.explosionDamage,P,M);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,he()&&me()&&us(f,{weaponKey:t.weaponKey,explosionRadius:f.explosionRadius,explosionDamage:f.explosionDamage})}else if(t.weaponKey==="chainLightning"){const f=Nx(e,t.pos.x,t.pos.y,p,t.projectileSpeed,B,t.chainRange,t.maxJumps,t.chainDamageReduction,P,M);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,he()&&me()&&us(f,{weaponKey:t.weaponKey,chainRange:f.chainRange,maxJumps:f.maxJumps,chainDamageReduction:f.chainDamageReduction})}else if(t.weaponKey==="boomerang"){const f=Ro(e,t.pos.x,t.pos.y,p,t.projectileSpeed,B,t.piercing||0,t.obstaclePiercing||0,M,P);f.isBoomerang=!0,f.ownerPlayer=t,f.returnSpeedMultiplier=t.weaponDef?.returnSpeedMultiplier||1.2,t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,he()&&me()&&us(f,{weaponKey:t.weaponKey})}else{const f=Ro(e,t.pos.x,t.pos.y,p,t.projectileSpeed,B,t.piercing||0,t.obstaclePiercing||0,M,P);t.weaponDef&&f.useWeaponVisual(t.weaponDef),f.ownerSlotIndex=t.slotIndex,he()&&me()&&us(f,{weaponKey:t.weaponKey||"pistol"})}})}),o=l,Om(t)}}}),e.onCollide("projectile","wall",(n,s)=>{if(!e.paused){if(n.isExplosive){Xa(e,n,n.pos.x,n.pos.y);return}n.piercedObstacles&&n.piercedObstacles.has(s)||(n.obstaclePiercing>0?(n.piercedObstacles&&n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)):e.destroy(n))}}),e.onCollide("projectile","cover",(n,s)=>{if(!e.paused&&n.obstaclePiercing>0&&n.piercedObstacles){if(n.piercedObstacles.has(s))return;n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)}}),e.onCollide("projectile","obstacle",(n,s)=>{e.paused||n.isExplosive||n.piercedObstacles&&n.piercedObstacles.has(s)||(n.obstaclePiercing>0?(n.piercedObstacles&&n.piercedObstacles.add(s),n.piercedObstacles.size>(n.obstaclePiercing||0)&&e.destroy(n)):e.destroy(n))}),e.onCollide("projectile","barrel",(n,s)=>{e.paused||!s.exists()||s.isExploding||n.isEnemyProjectile||n.isBossProjectile||(s.takeDamage&&s.takeDamage(1),n.piercing>0||n.obstaclePiercing>0?n.piercedObstacles&&n.piercedObstacles.add(s):n.isExplosive||n.exists()&&e.destroy(n))}),e.onCollide("projectile","enemy",(n,s)=>{if(e.paused||n.isEnemyProjectile||n.isBossProjectile)return;const a=2,r=n.reflectionCount||0;if(s.reflectsProjectiles&&!n.isReflected&&r<a&&Math.random()<(s.reflectChance||.4)){n.isReflected=!0,n.reflectionCount=r+1,n.isEnemyProjectile=!0,n.direction=e.vec2(-n.direction.x,-n.direction.y),n.color=e.rgb(255,100,100),n.damage=Math.floor(n.damage*.7),e.add([e.text("*",{size:20}),e.pos(s.pos.x,s.pos.y),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.lifespan(.3),e.z(500)]);return}if(n.isExplosive){Xa(e,n,s.pos.x,s.pos.y);return}if(n.isChainLightning){if(n.chainedEnemies&&n.chainedEnemies.has(s))return;if(!he()||me()){const i=n.chainJumps||0,h=1-(n.chainDamageReduction||.15)*i,u=Math.floor(n.damage*Math.max(.1,h));s.takeDamage?s.takeDamage(u):s.hurt(u)}n.chainedEnemies&&n.chainedEnemies.add(s),n.chainJumps<n.maxJumps?Dl(e,n,s):e.destroy(n);return}if(n.piercedEnemies&&n.piercedEnemies.has(s))return;if(he()&&!me()){wl(),xo(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}wl();let l=n.damage;if(n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);h&&h.executionerEnabled&&h.executionerThreshold&&s.hp()/(s.maxHealth||s.hp())<h.executionerThreshold&&(l=Math.floor(l*(1+(h.executionerDamageBonus||1))))}if(s.takeDamage?s.takeDamage(l):s.hurt(l),_a(e,s.pos.x,s.pos.y,l,{isCrit:n.isCrit}),n.isCrit&&n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);if(h&&h.vampiricCrits&&h.vampiricHealPercent){const u=Math.floor(l*h.vampiricHealPercent);if(u>0&&h.hp()<h.maxHealth){const g=Math.min(h.maxHealth,h.hp()+u);h.setHP(g)}}}if(n.ownerSlotIndex!==void 0){const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);if(h&&h.lifestealPercent&&h.lifestealPercent>0){let u=h.lifestealPercent;n.isCrit&&h.vampireLordEnabled&&h.vampireLordMultiplier&&(u*=h.vampireLordMultiplier);const g=Math.floor(l*u);if(g>0&&h.hp()<h.maxHealth){const p=Math.min(h.maxHealth,h.hp()+g);h.setHP(p),he()&&me()&&Mh({slotIndex:h.slotIndex,healAmount:g,newHP:p,source:"lifesteal"})}}}if(n.ownerSlotIndex!==void 0){s.lastHitBySlot=n.ownerSlotIndex;const h=e.get("player").find(u=>u.slotIndex===n.ownerSlotIndex);h&&h.survivalistEnabled&&(h.survivalistLastCombatTime=e.time())}he()&&me()&&cy({targetId:s.mpEntityId,targetType:"enemy",damage:l,isCrit:n.isCrit||!1,x:s.pos.x,y:s.pos.y}),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),xo(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);const c=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);if(c.len()>0){const i=c.unit(),h=uo.KNOCKBACK_ENEMY_FROM_PROJECTILE;Us(e,s,i,h)}Os(e,s.pos.x,s.pos.y,c,{isCrit:n.isCrit}),n.isCrit&&fn.criticalHit(),s.color=n.isCrit?e.rgb(...uo.CRIT_COLOR):e.rgb(...uo.HIT_COLOR),e.wait(uo.HIT_FLASH_DURATION,()=>{s.exists()&&(s.color=e.rgb(255,100,100))})}),e.onCollide("projectile","boss",(n,s)=>{if(e.paused)return;if(n.isExplosive){Xa(e,n,s.pos.x,s.pos.y);return}if(n.isChainLightning){if(n.chainedEnemies&&n.chainedEnemies.has(s))return;if(!he()||me()){const r=n.chainJumps||0,l=1-(n.chainDamageReduction||.15)*r,c=Math.floor(n.damage*Math.max(.1,l));s.takeDamage?s.takeDamage(c):s.hurt(c)}n.chainedEnemies&&n.chainedEnemies.add(s),e.wait(.01,()=>{n.exists()&&(n.chainJumps<n.maxJumps?Dl(e,n,s):e.destroy(n))});return}if(n.piercedEnemies&&n.piercedEnemies.has(s))return;if(he()&&!me()){xo(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const r=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Os(e,s.pos.x,s.pos.y,r,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}s.takeDamage?s.takeDamage(n.damage):s.hurt(n.damage),_a(e,s.pos.x,s.pos.y,n.damage,{isCrit:n.isCrit}),n.ownerSlotIndex!==void 0&&(s.lastHitBySlot=n.ownerSlotIndex),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),xo(e,s.pos.x,s.pos.y,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);const a=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);a.len()>0&&Us(e,s,a.unit(),uo.KNOCKBACK_BOSS_FROM_PROJECTILE),Os(e,s.pos.x,s.pos.y,a,{isCrit:n.isCrit}),n.isCrit?fn.criticalHit():fn.bossHit(),s.color=n.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{s.exists()&&s.updateVisual()})}),e.onCollide("projectile","miniboss",(n,s)=>{if(e.paused||n.isEnemyProjectile||n.isBossProjectile||n.piercedEnemies&&n.piercedEnemies.has(s))return;if(he()&&!me()){xo(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const l=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Os(e,s.pos.x,s.pos.y,l,{isCrit:n.isCrit}),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n);return}let a=n.damage;n.isCrit&&(a=Math.floor(a*1.5)),s.takeDamage?s.takeDamage(a):s.hurt(a),_a(e,s.pos.x,s.pos.y,a,{isCrit:n.isCrit}),n.ownerSlotIndex!==void 0&&(s.lastHitBySlot=n.ownerSlotIndex),n.burnDamage&&n.burnDuration&&(s.burnDamage=n.burnDamage,s.burnDuration=n.burnDuration,s.burnTimer=0),xo(e,s.pos.x,s.pos.y,{isCrit:n.isCrit});const r=e.vec2(s.pos.x-n.pos.x,s.pos.y-n.pos.y);Os(e,s.pos.x,s.pos.y,r,{isCrit:n.isCrit}),n.isCrit&&fn.criticalHit(),n.piercedEnemies&&n.piercedEnemies.add(s),n.piercedEnemies.size>(n.piercing||0)&&e.destroy(n),s.color=n.isCrit?e.rgb(255,200,0):e.rgb(255,255,255),e.wait(.1,()=>{s.exists()&&s.updateVisual()})}),e.onCollide("enemy","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(he()&&!me()){An(),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(...uo.HIT_COLOR);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){he()&&me()&&Ba({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}An(),fn.playerHit();const a=n.damage||uo.BASE_ENEMY_DAMAGE,r=Ra(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),n.lifesteal&&n.exists()){const d=n.hp(),i=n.maxHealth;if(d<i){const h=Math.min(i,d+n.lifesteal);n.setHP(h)}}if(n.isVampiric&&n.vampiricHealAmount&&n.exists()){const d=n.hp(),i=n.maxHealth;if(d<i){const h=Math.min(i,d+n.vampiricHealAmount);n.setHP(h)}}if(s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=uo.KNOCKBACK_ENEMY;Us(e,n,d,i)}s.color=e.rgb(...uo.HIT_COLOR)}),e.onCollide("miniboss","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(he()&&!me()){An(),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){he()&&me()&&Ba({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}An(),fn.playerHit();let a=uo.BASE_MINIBOSS_DAMAGE;(n.type==="brute"||n.type==="berserker"||n.type==="guardian")&&n.meleeDamage&&(a=n.meleeDamage);const r=Ra(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.takeDamage?n.takeDamage(d):n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.takeDamage?n.takeDamage(i):n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=uo.KNOCKBACK_MINIBOSS;Us(e,n,d,i)}s.color=e.rgb(255,100,100)}),e.onCollide("boss","player",(n,s)=>{if(e.paused||s.isDead||s.hp()<=0||s.invulnerable)return;if(he()&&!me()){An(),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){he()&&me()&&Ba({slotIndex:s.slotIndex,x:s.pos.x,y:s.pos.y});return}An(),fn.playerHit();let a=uo.BASE_BOSS_DAMAGE;if(n.type==="twinGuardianMelee"&&n.meleeDamage){const d=n.enraged?uo.BOSS_ENRAGE_DAMAGE_MULTIPLIER:1;a=n.meleeDamage*d}const r=Ra(a,s.defense||0,s.damageReduction||0);if(s.hurt(r),s.survivalistEnabled&&(s.survivalistLastCombatTime=e.time()),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.thornsPercent&&s.thornsPercent>0&&n.exists()){const d=Math.floor(a*s.thornsPercent);if(d>0)if(s.thornsIgnoreArmor)n.takeDamage?n.takeDamage(d):n.hurt(d);else{const i=Math.max(1,d-(n.defense||0));n.takeDamage?n.takeDamage(i):n.hurt(i)}}const l=e.vec2(n.pos.x-s.pos.x,n.pos.y-s.pos.y);if(l.len()>0){const d=l.unit(),i=uo.KNOCKBACK_BOSS;Us(e,n,d,i)}s.color=e.rgb(255,100,100)}),e.onCollide("projectile","player",(n,s)=>{if(e.paused||!n.isBossProjectile&&!n.isEnemyProjectile||s.isDead||s.hp()<=0||s.invulnerable)return;if(he()&&!me()){An(),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),s.color=e.rgb(255,100,100),e.destroy(n);return}if(s.dodgeChance&&Math.random()<s.dodgeChance){e.destroy(n);return}An(),fn.playerHit();const a=n.damage*(1-(s.damageReduction||0)),r=Math.max(1,a-(s.defense||0));s.hurt(r),s.invulnerable||(s.invulnerable=!0,s.invulnerableTime=s.invulnerableDuration),xo(e,s.pos.x,s.pos.y,{color:[255,100,100]}),e.destroy(n),s.color=e.rgb(255,100,100)}),e.onCollide("orbital","enemy",(n,s)=>{if(!e.paused&&s.exists()&&!(n.contactCooldown>0)){if(he()&&!me()){n.contactCooldown=n.contactCooldownDuration||.2;return}s.hurt(n.damage),n.contactCooldown=n.contactCooldownDuration||.2}}),e.onCollide("orbital","boss",(n,s)=>{if(!e.paused&&s.exists()&&!(n.contactCooldown>0)){if(he()&&!me()){n.contactCooldown=n.contactCooldownDuration||.2;return}s.takeDamage?s.takeDamage(n.damage):s.hurt(n.damage),n.contactCooldown=n.contactCooldownDuration||.2}})}function vr(e,t){t.orbitalOrbs&&t.orbitalOrbs.length>0&&t.orbitalOrbs.forEach(s=>{s&&s.exists()&&e.destroy(s)}),t.orbitalOrbs=[],t.orbitalAngles=[];const o=t.projectileCount||1,n=t.orbitRadius||ms.BASE_ORBIT_RADIUS;for(let s=0;s<o;s++){const a=360/o*s,r=a*Math.PI/180,l=t.pos.x+Math.cos(r)*n,c=t.pos.y+Math.sin(r)*n,d=e.add([e.text(t.weaponDef?.char||"",{size:16}),e.pos(l,c),e.anchor("center"),e.color(...t.weaponDef?.color||[100,200,255]),e.area(),"orbital","playerProjectile"]);d.damage=t.projectileDamage||12,d.contactCooldown=0,d.contactCooldownDuration=ms.ORBITAL_CONTACT_COOLDOWN,t.orbitalOrbs.push(d),t.orbitalAngles.push(a)}}function Hx(e,t){t.orbitalNeedsReinit&&(t.orbitalOrbs&&t.orbitalOrbs.forEach(a=>{a.exists()&&a.destroy()}),t.orbitalOrbs=[],t.orbitalAngles=[],vr(e,t),t.orbitalNeedsReinit=!1);const o=t.projectileCount||1;if((!t.orbitalOrbs||t.orbitalOrbs.length!==o)&&vr(e,t),!t.orbitalOrbs||!t.orbitalAngles)return;const n=t.rotationSpeed||ms.BASE_ROTATION_SPEED,s=t.orbitRadius||ms.BASE_ORBIT_RADIUS;t.orbitalOrbs.forEach((a,r)=>{if(!a.exists())return;t.orbitalAngles[r]=(t.orbitalAngles[r]+n*e.dt())%360;const l=t.orbitalAngles[r]*Math.PI/180;a.pos.x=t.pos.x+Math.cos(l)*s,a.pos.y=t.pos.y+Math.sin(l)*s,a.contactCooldown>0&&(a.contactCooldown-=e.dt())}),t.orbitalOrbs=t.orbitalOrbs.filter(a=>a.exists()),t.orbitalOrbs.length!==t.orbitalAngles.length&&(t.orbitalAngles=t.orbitalAngles.slice(0,t.orbitalOrbs.length))}function Ux(e,t,o,n,s,a,r,l,c,d=!1){const i=Ro(e,t,o,n,s,a,0,0,d,c);return i.isExplosive=!0,i.explosionRadius=r||50,i.explosionDamage=l||15,i}function Nx(e,t,o,n,s,a,r,l,c,d,i=!1){const h=Ro(e,t,o,n,s,a,0,0,i,d);return h.isChainLightning=!0,h.chainRange=r||70,h.maxJumps=l||3,h.chainDamageReduction=c||.15,h.chainJumps=0,h.chainedEnemies=new Set,h}function Xa(e,t,o,n){if(!t.exists())return;Oh(),fn.explosion();const s=t.explosionRadius||50,a=t.explosionDamage||15;if(!he()||me()){const l=e.get("enemy"),c=e.get("boss"),d=[...l,...c];for(const i of d){if(!i.exists())continue;e.vec2(i.pos.x-o,i.pos.y-n).len()<=s&&(i.takeDamage?i.takeDamage(a):i.hurt(a))}}const r=e.add([e.text("*",{size:24}),e.pos(o,n),e.anchor("center"),e.color(255,200,0),e.z(200)]);e.wait(.2,()=>{r.exists()&&e.destroy(r)}),e.destroy(t)}function Dl(e,t,o){if(!t.exists())return;const n=t.chainRange||70,s=e.get("enemy"),a=e.get("boss"),r=[...s,...a];let l=null,c=n;for(const d of r){if(!d.exists()||d===o||t.chainedEnemies&&t.chainedEnemies.has(d))continue;const i=e.vec2(d.pos.x-o.pos.x,d.pos.y-o.pos.y).len();i<=n&&i<c&&(l=d,c=i)}if(l){t.chainJumps=(t.chainJumps||0)+1;const d=o.pos,i=l.pos,h=e.vec2(i.x-d.x,i.y-d.y).len(),u=Math.atan2(i.y-d.y,i.x-d.x),g=(d.x+i.x)/2,p=(d.y+i.y)/2,D=e.add([e.rect(h,2),e.pos(g,p),e.anchor("center"),e.rotate(u),e.color(255,255,100),e.z(150)]);e.wait(.1,()=>{D.exists()&&e.destroy(D)}),t.pos.x=l.pos.x,t.pos.y=l.pos.y}else e.destroy(t)}const _x={movement:{id:"movement",message:"Use WASD to move",duration:3,trigger:"firstMove"},shooting:{id:"shooting",message:"Aim with mouse - autofire!",duration:3,trigger:"firstShoot"},levelUp:{id:"levelUp",message:"Choose upgrade with 1-3 or click",duration:4,trigger:"firstLevelUp"},synergy:{id:"synergy",message:"Combine upgrades for bonuses!",duration:4,trigger:"firstSynergy"},shop:{id:"shop",message:"Spend credits on permanent upgrades",duration:4,trigger:"firstShopVisit"}},Fh="superSmashTexty_tutorialProgress";let Fa=null;function Yh(){try{const e=localStorage.getItem(Fh);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load tutorial progress:",e)}return{hintsShown:[]}}function Xx(e){try{localStorage.setItem(Fh,JSON.stringify(e))}catch(t){console.warn("Failed to save tutorial progress:",t)}}function Fx(e){return Yh().hintsShown.includes(e)}function Yx(e){const t=Yh();t.hintsShown.includes(e)||(t.hintsShown.push(e),Xx(t))}function qh(e,t){if(Fa||Fx(t))return!1;const o=_x[t];if(!o)return!1;Yx(t);const n=e.add([e.rect(300,40),e.pos(e.width()/2,50),e.anchor("center"),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(700),"tutorialHint"]),s=e.add([e.text(o.message,{size:16}),e.pos(e.width()/2,50),e.anchor("center"),e.color(255,255,200),e.fixed(),e.z(701),"tutorialHint"]);return Fa={bg:n,text:s},e.wait(o.duration,()=>{n.exists()&&e.destroy(n),s.exists()&&e.destroy(s),Fa=null}),!0}function qx(e){qh(e,"movement")}function Gx(e){qh(e,"synergy")}const Gh={shotgun:{name:"Shotgun Blast",description:"Multi-Shot + Spread Shot: Wider spread angle",required:["multiShot","spreadShot"],apply:e=>{e.spreadAngle>0&&e.projectileCount>1&&(e.spreadAngle=(e.spreadAngle||0)*1.5)}},volley:{name:"Piercing Volley",description:"Piercing + Multi-Shot: All projectiles pierce",required:["piercing","multiShot"],apply:e=>{e.piercing>0&&e.projectileCount>1&&(e.piercing=(e.piercing||0)+1)}},criticalMaster:{name:"Critical Master",description:"Critical Strike + Critical Power: +25% crit chance, +100% crit damage",required:["critChance","critDamage"],apply:e=>{e.critChance>0&&e.critDamage>2&&(e.critChance=(e.critChance||0)+.25,e.critDamage=(e.critDamage||2)+1)}},barrage:{name:"Barrage",description:"Multi-Shot + Fire Rate: Faster multi-projectile firing",required:["multiShot","fireRate"],apply:e=>{e.projectileCount>1&&(e.fireRate=(e.fireRate||1.5)*1.3)}},armorPiercing:{name:"Armor Piercing",description:"Piercing + Damage Boost: Piercing projectiles deal +50% damage",required:["piercing","damage"],apply:e=>{e.piercing>0&&(e.piercingDamageBonus=1.5)}},tank:{name:"Tank",description:"Armor + Max Health: +50% max health, +5 defense",required:["defense","health"],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*1.5),e.setHP(Math.floor(e.hp()*1.5)),e.defense=(e.defense||0)+5}},vacuum:{name:"Loot Vacuum",description:"Movement Speed + Pickup Radius: +100% pickup radius",required:["speed","pickupRadius"],apply:e=>{e.pickupRadius>0&&(e.pickupRadius=Math.floor(e.pickupRadius*2))}},xpMagnet:{name:"XP Magnet",description:"XP Gain + Pickup Radius: +50% XP multiplier",required:["xpGain","pickupRadius"],apply:e=>{e.xpMultiplier&&(e.xpMultiplier=(e.xpMultiplier||1)+.5)}},glassCannon:{name:"Glass Cannon",description:"Damage x3 + Health: -25% max HP, +100% damage",required:["damage","damage","damage","health"],requiredCounts:{damage:3,health:1},apply:e=>{if((e.upgradeStacks?.damage||0)>=3){const o=Math.floor(e.maxHealth*.75);e.maxHealth=o;const n=Math.max(1,Math.floor(o*.25)),s=Math.max(n,Math.min(e.hp(),o));e.setHP(s),e.projectileDamage=Math.floor(e.projectileDamage*2)}}},vampiricRounds:{name:"Vampiric Rounds",description:"Crit Chance + Crit Damage + Health: Heal 5% of crit damage",required:["critChance","critDamage","health"],apply:e=>{e.vampiricCrits=!0,e.vampiricHealPercent=.05}},bulletTime:{name:"Bullet Time",description:"Speed + Fire Rate: +20% fire rate while moving",required:["speed","fireRate"],apply:e=>{e.bulletTimeEnabled=!0,e.bulletTimeBonus=.2}},berserker:{name:"Berserker",description:"Damage x3 + Speed x2: +50% damage/speed below 30% HP",requiredCounts:{damage:3,speed:2},apply:e=>{e.berserkerEnabled=!0,e.berserkerThreshold=.3,e.berserkerDamageBonus=.5,e.berserkerSpeedBonus=.5}},deadeye:{name:"Deadeye",description:"Crit x2 + Range x2: Crits have +50% range",requiredCounts:{critChance:2,range:2},apply:e=>{e.deadeyeEnabled=!0,e.deadeyeRangeBonus=.5}},survivor:{name:"Survivalist",description:"Health x2 + Defense x2: Regen 1% HP/sec out of combat",requiredCounts:{health:2,defense:2},apply:e=>{e.survivalistEnabled=!0,e.survivalistRegenPercent=.01,e.survivalistCombatCooldown=3,e.survivalistLastCombatTime=0}},thornMaster:{name:"Retribution",description:"Thorns x3 + Defense x2: Thorns ignore enemy armor",requiredCounts:{thorns:3,defense:2},apply:e=>{e.thornsIgnoreArmor=!0,e.thornsPercent=(e.thornsPercent||0)*1.5}},vampireLord:{name:"Vampire Lord",description:"Lifesteal x3 + Crit Dmg x2: Crits heal 3x lifesteal",requiredCounts:{lifesteal:3,critDamage:2},apply:e=>{e.vampireLordEnabled=!0,e.vampireLordMultiplier=3}},executioner:{name:"Executioner",description:"Damage x2 + Piercing x2: +100% damage to enemies <25% HP",requiredCounts:{damage:2,piercing:2},apply:e=>{e.executionerEnabled=!0,e.executionerThreshold=.25,e.executionerDamageBonus=1}},speedDemon:{name:"Speed Demon",description:"Speed x3 + Fire Rate x2: +1% fire rate per speed stack",requiredCounts:{speed:3,fireRate:2},apply:e=>{e.speedDemonEnabled=!0,e.speedDemonFireRatePerStack=.01}},fortress:{name:"Fortress",description:"Health x3 + Invuln x2: Immunity blocks all damage sources",requiredCounts:{health:3,invulnTime:2},apply:e=>{e.fortressEnabled=!0,e.invulnerableDuration=(e.invulnerableDuration||1)*1.5}}};function Kh(e,t){e.selectedUpgrades||(e.selectedUpgrades=new Set),e.selectedUpgrades.add(t)}function Xi(e,t){if(!t.selectedUpgrades||t.selectedUpgrades.size<2)return;const o=[];for(const[n,s]of Object.entries(Gh)){let a=!1;if(s.requiredCounts){a=!0;for(const[r,l]of Object.entries(s.requiredCounts))if((t.upgradeStacks?.[r]||0)<l){a=!1;break}}else a=s.required.every(r=>t.selectedUpgrades.has(r));a&&(t.activeSynergies||(t.activeSynergies=new Set),t.activeSynergies.has(n)||(s.apply(t),t.activeSynergies.add(n),o.push(s),Gx(e),Kx(e,s)))}return o}function Kx(e,t){const o=e.add([e.text(`SYNERGY: ${t.name}`,{size:20}),e.pos(e.width()/2,150),e.anchor("center"),e.color(255,200,0),e.fixed(),e.z(600)]),n=e.add([e.text(t.description,{size:14}),e.pos(e.width()/2,175),e.anchor("center"),e.color(200,200,100),e.fixed(),e.z(600)]);e.wait(3,()=>{o.exists()&&(e.destroy(o),e.destroy(n))})}function Cl(e){if(!(!e.activeSynergies||e.activeSynergies.size===0))for(const t of e.activeSynergies){const o=Gh[t];o&&o.apply&&o.apply(e)}}let oo=!1;function Rl(e,t,o,n=null,s=null,a=null){if(oo)return;oo=!0;const r=he();r||(e.paused=!0),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip());let l=!1;e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(l=!0));const c=Ct("toughChoices"),d=Ct("mulligan"),i=3+c;let h=a!==null?a:d,u=0;function g(){let O=null;if(he()){const v=t.playerIndex!==void 0?t.playerIndex:0,T=s||t.level||1;O=wy(v,T+u*100)}return Xm(i,t,O)}let p=g();const D=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.opacity(1),e.fixed(),e.z(b.MODAL),"upgradeOverlay"]);l&&e.gameData&&e.gameData.minimap&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update()),e.wait(.05,()=>{D.exists()&&(D.opacity=.9)});const m=r&&n?`${n} - Level Up! Choose an Upgrade`:"Level Up! Choose an Upgrade";e.add([e.text(m,{size:Z.TITLE}),e.pos(e.width()/2,80),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.MODAL+1),"upgradeUI"]);function M(){e.get("upgradeCard").forEach(_=>e.destroy(_));const O=200,v=150,T=e.width()-40;let x,C,S;if(p.length<=3)x=O,C=v,S=250;else if(p.length<=5)x=160,C=130,S=180;else{const _=T/p.length;x=Math.min(140,_-10),C=120,S=x+10}const z=e.width()/2-S*(p.length-1)/2,L=e.height()/2,N=[];return p.forEach((_,X)=>{const H=z+X*S,R=e.add([e.rect(x,C),e.pos(H,L),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.MODAL+1),e.area(),"upgradeUI","upgradeCard"]),F=x<=140?32:48;if(_.icon){const ne=_.category==="passive"?y.SUCCESS:_.weaponKey?y.WARNING:y.INFO;e.add([e.text(_.icon,{size:F}),e.pos(H,L-C/3),e.anchor("center"),e.color(...ne),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"])}const G=x<=140?12:Z.BUTTON;e.add([e.text(_.name,{size:G,width:x-10}),e.pos(H,L-5),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"]);const Q=x<=140?10:Z.BODY,le=Fm(_,t);e.add([e.text(le,{size:Q,width:x-10}),e.pos(H,L+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"]);const se=x<=140?14:Z.HEADER;e.add([e.text(`${X+1}`,{size:se}),e.pos(H+x/2-15,L-C/2+12),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.MODAL+2),"upgradeUI","upgradeCard"]),N.push({card:R,upgrade:_,index:X}),R.onClick(()=>{oo&&f(X)})}),N}M();let B=null;if(d>0){const O=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.WARNING)),e.fixed(),e.z(b.MODAL+1),e.area(),"upgradeUI"]);B=e.add([e.text(`(R) Reroll (${h})`,{size:14}),e.pos(e.width()/2,e.height()-60),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.MODAL+2),"upgradeUI"]),O.onClick(()=>{oo&&h>0&&P()})}function P(){h<=0||(h--,u++,p=g(),M(),B&&B.exists()&&(B.text=`(R) Reroll (${h})`,h===0&&(B.color=e.rgb(...y.TEXT_SECONDARY))))}function f(O){if(!oo)return;const v=p[O];hx(),oo=!1,jr(t,v.key),Kh(t,v.key);const T=Xi(e,t);if(he()&&t.slotIndex!==void 0&&(uy(t.slotIndex,v.key),T&&T.length>0)){const x=T.map(C=>C.name);py(t.slotIndex,x)}e.get("upgradeUI").forEach(x=>e.destroy(x)),e.get("upgradeOverlay").forEach(x=>e.destroy(x)),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),r||(e.paused=!1),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.wait(.1,()=>{o&&o(v,h)})}e.onKeyPress("1",()=>{oo&&p.length>=1&&f(0)}),e.onKeyPress("2",()=>{oo&&p.length>=2&&f(1)}),e.onKeyPress("3",()=>{oo&&p.length>=3&&f(2)}),e.onKeyPress("4",()=>{oo&&p.length>=4&&f(3)}),e.onKeyPress("5",()=>{oo&&p.length>=5&&f(4)}),e.onKeyPress("6",()=>{oo&&p.length>=6&&f(5)}),e.onKeyPress("7",()=>{oo&&p.length>=7&&f(6)}),e.onKeyPress("8",()=>{oo&&p.length>=8&&f(7)}),e.onKeyPress("9",()=>{oo&&p.length>=9&&f(8)}),e.onKeyPress("0",()=>{oo&&p.length>=10&&f(9)}),e.onKeyPress("r",()=>{oo&&h>0&&P()})}function Ci(){return oo}function Pl(e,t,o=null,n=!1){let s=!1;t.pendingLevelUps=t.pendingLevelUps||[],t.addXP=function(r){if(e.paused||s)return;const l=t.xpMultiplier||1,c=Math.floor(r*l);for(t.xp+=c;t.xp>=t.xpToNext&&!s&&t.xpToNext>0;){s=!0,t.xp-=t.xpToNext,t.level++;const d=t.level;t.xpToNext=Math.max(1,Math.floor(t.xpToNext*gn.XP_SCALING_FACTOR)),a(e,t,d)}};function a(r,l,c){if(r.paused&&!n){s=!1;return}dx();const d=r.add([r.text(`Level ${c}!`,{size:24}),r.pos(r.width()/2,gn.LEVEL_UP_NOTIFICATION_Y),r.anchor("center"),r.color(255,255,100),r.fixed(),r.z(1e3)]);n&&l.slotIndex!==void 0?(fy(l.slotIndex,c),l.pendingLevelUps.push(c)):(l.pendingLevelUps.push(c),bo("gameplay","autoPause")&&!r.paused&&r.wait(.3,()=>{if(!r.paused&&l.pendingLevelUps.length>0){r.paused=!0;const h=l.pendingLevelUps.shift();Rl(r,l,()=>{s=!1,r.paused=!1},null,h)}})),r.wait(gn.LEVEL_UP_NOTIFICATION_DURATION,()=>{d.exists()&&r.destroy(d),s=!1})}return{processPendingLevelUp:()=>{if(t.pendingLevelUps.length>0&&!s){s=!0;const r=t.pendingLevelUps.shift(),l=t.playerName||(t.isRemote?`Player ${t.slotIndex+1}`:"You");Rl(e,t,()=>{s=!1},n?l:null,r)}}}}const Vx={1:{rusher:25,shooter:20,zombie:20,slime:15,bat:20},2:{charger:18,turret:12,heavyTank:18,zippy:18,exploder:20,splitter:14},3:{mage:15,shieldBearer:12,golem:12,wraith:12,spawner:12,buffer:15,orbiter:7,phaser:8,mimic:7},4:{healer:18,teleporter:15,freezer:18,leech:20,reflector:14,bomber:15}};function Wx(){return{basic:15,rusher:25,tank:30,fast:30}}function $x(e,t=null){const o=Object.values(e).reduce((s,a)=>s+a,0);let n=(t?t.next():Math.random())*o;for(const[s,a]of Object.entries(e))if(n-=a,n<=0)return s;return Object.keys(e)[0]}function Er(e=1,t=null){const o=Vx[e]||Wx();return $x(o,t)}const Vh={swift:{name:"Swift",prefix:"",color:[255,255,100],apply:e=>{e.speed=Math.floor(e.speed*1.5)}},armored:{name:"Armored",prefix:"",color:[100,150,255],apply:e=>{e.maxHealth=Math.floor(e.maxHealth*2),e.setHP(e.maxHealth),e.damageReduction=(e.damageReduction||0)+.25}},vampiric:{name:"Vampiric",prefix:"",color:[255,100,100],apply:e=>{e.isVampiric=!0,e.vampiricHealAmount=10}}},Il={2:{spawnChance:.1},3:{spawnChance:.12},4:{spawnChance:.15}};function Jx(e,t=null){if(e<2)return!1;const o=Il[e]||Il[4];return(t?t.next():Math.random())<o.spawnChance}function jx(e=null){const t=Object.keys(Vh),o=e?e.next():Math.random(),n=Math.floor(o*t.length);return t[n]}function Zx(e,t,o){const n=Vh[o];if(!n)return;t.isElite=!0,t.eliteModifier=o,n.apply(t);const s=`${n.prefix}${t.coreChar}`;t.coreChar=s,t.text=s,t.originalColor=n.color,t.color=e.rgb(...n.color),t.xpValue=Math.floor(t.xpValue*1.5),t.updateVisual&&t.updateVisual()}function Bl(e,t,o,n=null){if(t.isBoss||t.isBossEnemy||!Jx(o,n))return!1;const s=jx(n);return Zx(e,t,s),!0}const Qx=800,kx=600,Ri=20;let ks=null;const Gn={empty:{name:"Empty Room",obstacles:[],barrels:[],spawnDoors:null,floorAffinity:[1]},streetCorners:{name:"Street Corners",obstacles:[{x:150,y:150,width:50,height:50,type:"cover",char:""},{x:650,y:150,width:50,height:50,type:"cover",char:""},{x:150,y:450,width:50,height:50,type:"cover",char:""},{x:650,y:450,width:50,height:50,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:400}],spawnDoors:null,floorAffinity:[1]},alleyway:{name:"Alleyway",obstacles:[{x:200,y:200,width:30,height:200,type:"wall",char:""},{x:600,y:200,width:30,height:200,type:"wall",char:""}],barrels:[{x:250,y:250},{x:550,y:350}],spawnDoors:null,floorAffinity:[1]},factoryFloor:{name:"Factory Floor",obstacles:[{x:200,y:180,width:80,height:40,type:"wall",char:""},{x:600,y:180,width:80,height:40,type:"wall",char:""},{x:200,y:420,width:80,height:40,type:"wall",char:""},{x:600,y:420,width:80,height:40,type:"wall",char:""},{x:400,y:300,width:60,height:60,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:[2]},assemblyLine:{name:"Assembly Line",obstacles:[{x:250,y:250,width:300,height:25,type:"wall",char:""},{x:250,y:350,width:300,height:25,type:"wall",char:""}],barrels:[{x:150,y:300},{x:650,y:300},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[2]},storageYard:{name:"Storage Yard",obstacles:[{x:180,y:180,width:50,height:50,type:"cover",char:""},{x:620,y:180,width:50,height:50,type:"cover",char:""},{x:180,y:420,width:50,height:50,type:"cover",char:""},{x:620,y:420,width:50,height:50,type:"cover",char:""},{x:320,y:300,width:40,height:40,type:"cover",char:""},{x:480,y:300,width:40,height:40,type:"cover",char:""}],barrels:[{x:250,y:250},{x:550,y:250},{x:250,y:350},{x:550,y:350},{x:400,y:200}],spawnDoors:null,floorAffinity:[2]},serverRoom:{name:"Server Room",obstacles:[{x:200,y:150,width:30,height:300,type:"wall",char:""},{x:350,y:150,width:30,height:300,type:"wall",char:""},{x:500,y:150,width:30,height:300,type:"wall",char:""},{x:650,y:150,width:30,height:300,type:"wall",char:""}],barrels:[{x:275,y:200},{x:425,y:400},{x:575,y:250}],spawnDoors:null,floorAffinity:[3]},controlCenter:{name:"Control Center",obstacles:[{x:400,y:200,width:120,height:80,type:"wall",char:""},{x:200,y:350,width:60,height:60,type:"cover",char:""},{x:600,y:350,width:60,height:60,type:"cover",char:""}],barrels:[{x:300,y:200},{x:500,y:200},{x:400,y:450}],spawnDoors:null,floorAffinity:[3]},dataVault:{name:"Data Vault",obstacles:[{x:250,y:200,width:40,height:40,type:"wall",char:""},{x:550,y:200,width:40,height:40,type:"wall",char:""},{x:250,y:400,width:40,height:40,type:"wall",char:""},{x:550,y:400,width:40,height:40,type:"wall",char:""},{x:400,y:300,width:100,height:100,type:"wall",char:""}],barrels:[{x:180,y:300},{x:620,y:300}],spawnDoors:null,floorAffinity:[3]},hiveCluster:{name:"Hive Cluster",obstacles:[{x:300,y:180,width:50,height:50,type:"cover",char:""},{x:500,y:180,width:50,height:50,type:"cover",char:""},{x:200,y:300,width:50,height:50,type:"cover",char:""},{x:600,y:300,width:50,height:50,type:"cover",char:""},{x:300,y:420,width:50,height:50,type:"cover",char:""},{x:500,y:420,width:50,height:50,type:"cover",char:""}],barrels:[{x:400,y:180},{x:400,y:420},{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:[4]},bioLab:{name:"Bio Lab",obstacles:[{x:300,y:250,width:200,height:30,type:"wall",char:""},{x:300,y:350,width:200,height:30,type:"wall",char:""},{x:400,y:300,width:30,height:130,type:"wall",char:""}],barrels:[{x:200,y:200},{x:600,y:200},{x:200,y:400},{x:600,y:400},{x:400,y:150},{x:400,y:450}],spawnDoors:null,floorAffinity:[4]},xenoNest:{name:"Xeno Nest",obstacles:[{x:400,y:300,width:80,height:80,type:"wall",char:""},{x:250,y:200,width:35,height:35,type:"cover",char:""},{x:550,y:200,width:35,height:35,type:"cover",char:""},{x:250,y:400,width:35,height:35,type:"cover",char:""},{x:550,y:400,width:35,height:35,type:"cover",char:""}],barrels:[{x:180,y:150},{x:620,y:150},{x:180,y:450},{x:620,y:450}],spawnDoors:null,floorAffinity:[4]},centerPillar:{name:"Center Pillar",obstacles:[{x:400,y:200,width:60,height:60,type:"wall",char:"#"},{x:400,y:400,width:60,height:60,type:"wall",char:"#"}],barrels:[{x:250,y:300},{x:550,y:300}],spawnDoors:null,floorAffinity:null},corners:{name:"Corner Cover",obstacles:[{x:150,y:150,width:40,height:40,type:"cover",char:""},{x:650,y:150,width:40,height:40,type:"cover",char:""},{x:150,y:450,width:40,height:40,type:"cover",char:""},{x:650,y:450,width:40,height:40,type:"cover",char:""}],barrels:[{x:400,y:200},{x:400,y:400}],spawnDoors:null,floorAffinity:null},hallway:{name:"Hallway",obstacles:[{x:200,y:250,width:400,height:20,type:"wall",char:"#"},{x:200,y:330,width:400,height:20,type:"wall",char:"#"}],barrels:[{x:150,y:290},{x:650,y:290}],spawnDoors:null,floorAffinity:null},cross:{name:"Cross Pattern",obstacles:[{x:350,y:200,width:100,height:20,type:"wall",char:"#"},{x:390,y:200,width:20,height:200,type:"wall",char:"#"}],barrels:[{x:250,y:200},{x:550,y:200},{x:250,y:400},{x:550,y:400}],spawnDoors:null,floorAffinity:null},barrelRoom:{name:"Barrel Room",obstacles:[{x:400,y:300,width:50,height:50,type:"cover",char:""}],barrels:[{x:250,y:200},{x:300,y:200},{x:275,y:250},{x:500,y:400},{x:550,y:400},{x:525,y:350},{x:150,y:150},{x:650,y:450}],spawnDoors:null,floorAffinity:null},scattered:{name:"Scattered Obstacles",obstacles:[{x:250,y:200,width:30,height:30,type:"cover",char:""},{x:550,y:250,width:30,height:30,type:"cover",char:""},{x:350,y:400,width:50,height:30,type:"wall",char:"#"},{x:150,y:350,width:30,height:50,type:"wall",char:"#"}],barrels:[{x:450,y:200},{x:250,y:400},{x:600,y:350}],spawnDoors:null,floorAffinity:null}};function e1(e,t,o,n){const s=o/2,a=n/2,r=Ri+s,l=Qx-Ri-s,c=Ri+a,d=kx-Ri-a,i=Math.max(r,Math.min(l,e)),h=Math.max(c,Math.min(d,t));return{x:i,y:h}}function t1(e,t){const o={1:{wall:[55,55,65],obstacle:[70,70,80],cover:[85,85,95]},2:{wall:[75,60,50],obstacle:[90,70,55],cover:[100,80,65]},3:{wall:[45,55,75],obstacle:[55,70,95],cover:[65,85,115]},4:{wall:[60,45,70],obstacle:[75,55,85],cover:[90,65,100]},5:{wall:[35,30,45],obstacle:[45,38,55],cover:[55,45,65]}},n=o[Math.min(t,5)]||o[5];return{wallColor:e.rgb(...n.wall),obstacleColor:e.rgb(...n.obstacle),coverColor:e.rgb(...n.cover)}}function Ws(e,t=null){const o=Object.keys(Gn),n=ks?o.filter(h=>h!==ks):o,s=[],a=[];n.forEach(h=>{const u=Gn[h];u.floorAffinity===null?a.push(h):u.floorAffinity.includes(e)&&s.push(h)});const l=s.length>0&&(t?t.next():Math.random())<.7?s:a.length>0?a:n,c=l.length>0?l:o,d=t?t.range(0,c.length):Math.floor(Math.random()*c.length),i=c[d];return ks=i,{key:i,...Gn[i]}}function o1(e,t=null,o=1){const n=Gn[e];if(!n||!n.barrels||n.barrels.length===0)return[];let s=[...n.barrels];if(o>=2&&(t?t.next():Math.random())<.3+o*.1){const r=100+(t?t.next():Math.random())*600,l=100+(t?t.next():Math.random())*400;s.push({x:r,y:l})}return o===1&&(t?t.next():Math.random())<.5&&s.length>1&&(s=s.slice(0,Math.ceil(s.length/2))),s}function n1(){ks=null}function Ll(e){return Gn[e]?(ks=e,{key:e,...Gn[e]}):(console.warn(`Unknown room template key: ${e}, falling back to empty`),{key:"empty",...Gn.empty})}let cc=[],lc=null;function s1(e){if(Gr(e))return!1;if(Kg(e)){if(cc.push(e),lc){const t=rn[e];t&&(fx(),qm(t),he()&&zy(e,Ly()))}return!0}return!1}function i1(e){cc=[],lc=e,e&&Qr(e)}function a1(){return[...cc]}function Pi(e,t=null){e&&(lc=e,Qr(e));const o=Ms(),n={bestFloor:Math.max(o.bestFloor||0,t?.floor||0),totalEnemiesKilled:(o.totalEnemiesKilled||0)+(t?.enemiesKilled||0),totalBossesKilled:(o.totalBossesKilled||0)+(t?.bossesKilled||0),totalRuns:o.totalRuns||0,bestLevel:Math.max(o.bestLevel||0,t?.level||0),totalCurrencyEarned:(o.totalCurrencyEarned||0)+(t?.currencyEarned||0)},s=[],a=(r,l)=>{r&&s1(l)&&s.push(l)};return a(n.bestFloor>=2,"floor2"),a(n.bestFloor>=3,"floor3"),a(n.bestFloor>=5,"floor5"),a(n.bestFloor>=10,"floor10"),a(n.bestFloor>=15,"floor15"),a(n.bestFloor>=20,"floor20"),a(n.totalEnemiesKilled>=1,"firstKill"),a(n.totalEnemiesKilled>=100,"kill100"),a(n.totalEnemiesKilled>=500,"kill500"),a(n.totalEnemiesKilled>=1e3,"kill1000"),a(n.totalEnemiesKilled>=5e3,"kill5000"),a(n.totalEnemiesKilled>=1e4,"kill10000"),a(n.totalBossesKilled>=1,"firstBoss"),a(n.totalBossesKilled>=5,"boss5"),a(n.totalBossesKilled>=10,"boss10"),a(n.totalBossesKilled>=25,"boss25"),a(n.totalBossesKilled>=50,"boss50"),a(n.totalRuns>=1,"firstRun"),a(n.totalRuns>=10,"run10"),a(n.totalRuns>=50,"run50"),a(n.totalRuns>=100,"run100"),a(n.bestLevel>=10,"level10"),a(n.bestLevel>=20,"level20"),a(n.bestLevel>=30,"level30"),a(n.bestLevel>=50,"level50"),a(n.totalCurrencyEarned>=100,"earn100"),a(n.totalCurrencyEarned>=500,"earn500"),a(n.totalCurrencyEarned>=1e3,"earn1000"),a(n.totalCurrencyEarned>=5e3,"earn5000"),a(n.totalCurrencyEarned>=1e4,"earn10000"),s}class Ii{constructor(t,o,n="combat"){this.position={x:t,y:o},this.type=n,this.template=null,this.connections={up:!1,down:!1,right:!1},this.visited=!1,this.cleared=!1,this.enemyTypes=[],this.isBossRoom=n==="boss"}getKey(){return`${this.position.x},${this.position.y}`}getAdjacentPosition(t){const{x:o,y:n}=this.position;switch(t){case"up":return{x:o,y:n-1};case"down":return{x:o,y:n+1};case"right":return{x:o+1,y:n};default:return null}}}class r1{constructor(t,o=6,n=3,s=null){this.floor=t,this.width=o,this.height=n,this.grid=[],this.rooms=new Map,this.startPosition=null,this.bossPosition=null,this.currentPosition=null,this.visitedRooms=new Set,this.rng=s,this.generate()}random(){return this.rng?this.rng.next():Math.random()}randomRange(t,o){return this.rng?this.rng.range(t,o):Math.floor(Math.random()*(o-t))+t}generate(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null));const t=Math.floor(this.height/2);this.startPosition={x:0,y:t};const o=this.height===1?0:this.randomRange(0,this.height);this.bossPosition={x:this.width-1,y:o};const n=new Ii(0,t,"start");this.setRoom(0,t,n);const s=new Ii(this.width-1,o,"boss");this.setRoom(this.width-1,o,s),this.generateMainPath(),this.addBranchRooms(),this.establishConnections(),this.assignRoomProperties(),this.validate(),this.currentPosition={...this.startPosition},this.markRoomVisited(this.startPosition.x,this.startPosition.y)}generateMainPath(){const t=this.findPath(this.startPosition,this.bossPosition);for(const o of t)if(!this.getRoom(o.x,o.y)){const n=new Ii(o.x,o.y,"combat");this.setRoom(o.x,o.y,n)}}findPath(t,o){const n=[];let s={...t};for(;s.x<o.x||s.y!==o.y;)n.push({...s}),s.x<o.x?s.y!==o.y&&this.random()<.3?s.y+=s.y<o.y?1:-1:s.x+=1:s.y+=s.y<o.y?1:-1;return n.push({...o}),n}addBranchRooms(){const t=Math.floor(this.width*this.height*.3);let o=0;for(let n=1;n<this.width-1;n++)for(let s=0;s<this.height&&!(o>=t);s++){if(this.getRoom(n,s))continue;if(n>0&&this.getRoom(n-1,s)&&this.random()<.5){const r=new Ii(n,s,"combat");this.setRoom(n,s,r),o++}}}establishConnections(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const n=this.getRoom(t,o);n&&(t<this.width-1&&this.getRoom(t+1,o)&&(n.connections.right=!0),o>0&&this.getRoom(t,o-1)&&(n.connections.up=!0),o<this.height-1&&this.getRoom(t,o+1)&&(n.connections.down=!0))}}assignRoomProperties(){for(let t=0;t<this.width;t++)for(let o=0;o<this.height;o++){const n=this.getRoom(t,o);if(n&&(n.type!=="boss"&&(n.template=Ws(this.floor,this.rng)),n.type==="combat")){const s=this.randomRange(3,6);n.enemyTypes=[];for(let a=0;a<s;a++)n.enemyTypes.push(Er(this.floor,this.rng))}}}validate(){const t=new Set,o=[this.startPosition];for(t.add(`${this.startPosition.x},${this.startPosition.y}`);o.length>0;){const n=o.shift(),s=this.getRoom(n.x,n.y);if(!s)continue;if(s.type==="boss")return console.log("[FloorMap] Validation passed: Boss is reachable"),!0;const a=["up","down","right"];for(const r of a)if(s.connections[r]){const l=s.getAdjacentPosition(r),c=`${l.x},${l.y}`;t.has(c)||(t.add(c),o.push(l))}}return console.error("[FloorMap] Validation failed: Boss is not reachable!"),!1}getRoom(t,o){return t<0||t>=this.width||o<0||o>=this.height?null:this.grid[o][t]}setRoom(t,o,n){t<0||t>=this.width||o<0||o>=this.height||(this.grid[o][t]=n,this.rooms.set(n.getKey(),n))}getCurrentRoom(){return this.getRoom(this.currentPosition.x,this.currentPosition.y)}getAvailableExits(){const t=this.getCurrentRoom();if(!t)return[];const o=[],n=["up","down","right"];for(const s of n)if(t.connections[s]){const a=t.getAdjacentPosition(s),r=this.getRoom(a.x,a.y);r&&!r.visited&&o.push({direction:s,position:a,room:r})}return o}markRoomVisited(t,o){const n=this.getRoom(t,o);n&&(n.visited=!0,this.visitedRooms.add(n.getKey()))}markRoomCleared(t,o){const n=this.getRoom(t,o);n&&(n.cleared=!0)}moveToRoom(t){const o=this.getCurrentRoom();if(!o||!o.connections[t])return console.warn(`[FloorMap] Cannot move ${t} from current position`),!1;const n=o.getAdjacentPosition(t);return this.getRoom(n.x,n.y)?(this.currentPosition=n,this.markRoomVisited(n.x,n.y),console.log(`[FloorMap] Moved to room (${n.x}, ${n.y})`),!0):(console.warn(`[FloorMap] No room found at ${n.x}, ${n.y}`),!1)}getTotalRooms(){return this.rooms.size}getVisitedCount(){return this.visitedRooms.size}getGridForMinimap(){const t=[];for(let o=0;o<this.height;o++){const n=[];for(let s=0;s<this.width;s++){const a=this.getRoom(s,o);a?s===this.currentPosition.x&&o===this.currentPosition.y?n.push({type:"current",room:a}):a.visited?n.push({type:"visited",room:a}):this.isRoomRevealed(s,o)?n.push({type:"revealed",room:a}):n.push({type:"hidden"}):n.push({type:"empty"})}t.push(n)}return t}isRoomRevealed(t,o){if(!this.getRoom(t,o))return!1;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const{dx:a,dy:r}of s){const l=this.getRoom(t+a,o+r);if(l&&l.visited)return!0}return!1}debugPrint(){console.log(`
[FloorMap] Floor ${this.floor} - ${this.width}x${this.height}`),console.log(`Start: (${this.startPosition.x}, ${this.startPosition.y})`),console.log(`Boss: (${this.bossPosition.x}, ${this.bossPosition.y})`),console.log(`Current: (${this.currentPosition.x}, ${this.currentPosition.y})`),console.log(`Rooms: ${this.getTotalRooms()}, Visited: ${this.getVisitedCount()}
`);for(let t=0;t<this.height;t++){let o="";for(let n=0;n<this.width;n++){const s=this.getRoom(n,t);s?s.type==="start"?o+="[S]":s.type==="boss"?o+="[B]":n===this.currentPosition.x&&t===this.currentPosition.y?o+="[]":s.visited?o+="[]":o+="[R]":o+="[ ]",o+=" "}console.log(o)}console.log(`
Connections:`);for(const[t,o]of this.rooms){const n=[];o.connections.up&&n.push(""),o.connections.down&&n.push(""),o.connections.right&&n.push(""),console.log(`  (${o.position.x}, ${o.position.y}): ${n.join(", ")||"none"}`)}}}function c1(e,t=null){const o=Math.min(3+e,10),n=Math.min(2+Math.floor(e/2),6),s=new r1(e,o,n,t);return s.debugPrint(),s}const Mn={MINIMIZED:"minimized",OPEN:"open",MAXIMIZED:"maximized"},Vt={MARGIN_RIGHT:12,MARGIN_TOP:32,BUTTON_SIZE:38,OPEN_WIDTH:130,OPEN_HEIGHT:85,MAX_MIN_WIDTH:200,MAX_MIN_HEIGHT:160,CELL_SIZE_SMALL:11,CELL_SIZE_LARGE:16,Z_BASE:900,Z_TEXT:901,Z_ICON:902},Xt={BG_PANEL:[25,25,40],BG_HEADER:[35,35,55],BORDER:[80,120,180],BORDER_HOVER:[120,160,220],TEXT_TITLE:[200,210,255],TEXT_MUTED:[140,140,160],ICON_MAP:[130,160,220],BADGE_FLOOR:[255,220,80],CURRENT:[255,255,100],VISITED:[80,220,100],AVAILABLE:[120,120,140],BOSS:[255,90,90],HIDDEN:[50,50,70],CELL_BG:[30,30,45],CELL_BORDER:[45,45,60]};class l1{constructor(t,o){this.k=t,this.floorMap=o,this.mode=Mn.MINIMIZED,this.elements=[],this.isHovered=!1,this.destroyed=!1,this.floorMap&&typeof this.floorMap.getGridForMinimap=="function"&&this.render()}getRightX(){return this.k.width()-Vt.MARGIN_RIGHT}getTopY(){return Vt.MARGIN_TOP}toggle(){if(!this.destroyed){try{et()}catch(t){console.warn("[Minimap] Sound playback failed:",t)}this.mode===Mn.MINIMIZED?this.mode=Mn.OPEN:this.mode===Mn.OPEN?this.mode=Mn.MAXIMIZED:this.mode=Mn.MINIMIZED,this.update()}}update(){this.destroyed||(this.clear(),this.render())}clear(){this.elements.forEach(t=>{try{t&&t.exists()&&this.k.destroy(t)}catch{}}),this.elements=[]}render(){this.destroyed||(this.mode===Mn.MINIMIZED?this.renderMinimized():this.mode===Mn.OPEN?this.renderOpen():this.renderMaximized())}createPanel(t,o,n,s){const a=this.k.add([this.k.rect(t,o),this.k.pos(n,s),this.k.anchor("topright"),this.k.color(...Xt.BG_PANEL),this.k.outline(2,this.k.rgb(...Xt.BORDER)),this.k.fixed(),this.k.z(Vt.Z_BASE),this.k.area(),this.k.opacity(.95),"minimap"]);return a.onHover(()=>{a.outline.color=this.k.rgb(...Xt.BORDER_HOVER),a.outline.width=3}),a.onHoverEnd(()=>{a.outline.color=this.k.rgb(...Xt.BORDER),a.outline.width=2}),a.onClick(()=>this.toggle()),this.elements.push(a),a}renderMinimized(){const t=this.getRightX(),o=this.getTopY(),n=Vt.BUTTON_SIZE;this.createPanel(n,n,t,o);const s=t-n/2,a=o+n/2,r=this.k.add([this.k.text("",{size:22}),this.k.pos(s,a),this.k.anchor("center"),this.k.color(...Xt.ICON_MAP),this.k.fixed(),this.k.z(Vt.Z_TEXT),"minimap"]);this.elements.push(r);const l=this.k.add([this.k.text(`F${this.floorMap.floor}`,{size:9}),this.k.pos(t-n+4,o+4),this.k.anchor("topleft"),this.k.color(...Xt.BADGE_FLOOR),this.k.fixed(),this.k.z(Vt.Z_ICON),"minimap"]);this.elements.push(l)}renderOpen(){const t=this.getRightX(),o=this.getTopY(),n=Vt.OPEN_WIDTH,s=Vt.OPEN_HEIGHT,a=Vt.CELL_SIZE_SMALL,r=this.floorMap.getGridForMinimap();if(!r||r.length===0||!r[0]){this.renderMinimized();return}this.createPanel(n,s,t,o);const l=18,c=this.k.add([this.k.rect(n-4,l),this.k.pos(t-2,o+2),this.k.anchor("topright"),this.k.color(...Xt.BG_HEADER),this.k.fixed(),this.k.z(Vt.Z_TEXT),"minimap"]);this.elements.push(c);const d=this.k.add([this.k.text(`Floor ${this.floorMap.floor}`,{size:10}),this.k.pos(t-n/2,o+2+l/2),this.k.anchor("center"),this.k.color(...Xt.TEXT_TITLE),this.k.fixed(),this.k.z(Vt.Z_ICON),"minimap"]);this.elements.push(d);const i=r[0].length*a;r.length*a;const h=t-n/2-i/2,u=o+l+8;this.renderGrid(r,h,u,a,!1);const g=this.k.add([this.k.text(`${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()} rooms`,{size:8}),this.k.pos(t-n/2,o+s-8),this.k.anchor("center"),this.k.color(...Xt.TEXT_MUTED),this.k.fixed(),this.k.z(Vt.Z_TEXT),"minimap"]);this.elements.push(g)}renderMaximized(){const t=this.getRightX(),o=this.getTopY(),n=Vt.CELL_SIZE_LARGE,s=this.floorMap.getGridForMinimap();if(!s||s.length===0||!s[0]){this.renderMinimized();return}const a=s[0].length*n,r=s.length*n,l=70,c=26,d=16,i=Math.max(Vt.MAX_MIN_WIDTH,a+d*2),h=Math.max(Vt.MAX_MIN_HEIGHT,r+c+l+d),u=Math.min(i,this.k.width()-Vt.MARGIN_RIGHT-10);this.createPanel(u,h,t,o);const g=this.k.add([this.k.rect(u-4,c),this.k.pos(t-2,o+2),this.k.anchor("topright"),this.k.color(...Xt.BG_HEADER),this.k.fixed(),this.k.z(Vt.Z_TEXT),"minimap"]);this.elements.push(g);const p=this.k.add([this.k.text(`FLOOR ${this.floorMap.floor}    ${this.floorMap.getVisitedCount()}/${this.floorMap.getTotalRooms()}`,{size:11}),this.k.pos(t-u/2,o+2+c/2),this.k.anchor("center"),this.k.color(...Xt.TEXT_TITLE),this.k.fixed(),this.k.z(Vt.Z_ICON),"minimap"]);this.elements.push(p);const D=Math.min(a,u-d*2),m=t-u/2-D/2,M=o+c+12;this.renderGrid(s,m,M,n,!0);const B=M+r+12;this.renderLegend(t-u+d,B)}renderGrid(t,o,n,s,a){for(let r=0;r<t.length;r++)for(let l=0;l<t[r].length;l++){const c=t[r][l],d=o+l*s,i=n+r*s;if(c.type==="empty")continue;if(a){const g=this.k.add([this.k.rect(s-2,s-2),this.k.pos(d,i),this.k.anchor("topleft"),this.k.color(...Xt.CELL_BG),this.k.outline(1,this.k.rgb(...Xt.CELL_BORDER)),this.k.fixed(),this.k.z(Vt.Z_TEXT),"minimap"]);this.elements.push(g)}const{char:h,color:u}=this.getCellDisplay(c);if(h){const g=a?12:9,p=this.k.add([this.k.text(h,{size:g}),this.k.pos(d+s/2-1,i+s/2-1),this.k.anchor("center"),this.k.color(...u),this.k.fixed(),this.k.z(Vt.Z_ICON),"minimap"]);this.elements.push(p)}}}getCellDisplay(t){switch(t.type){case"current":return{char:"",color:Xt.CURRENT};case"visited":return t.room.isBossRoom?{char:"B",color:Xt.BOSS}:{char:"",color:Xt.VISITED};case"revealed":return t.room.isBossRoom?{char:"B",color:[...Xt.BOSS.map(o=>Math.min(255,o+50))]}:{char:"",color:Xt.AVAILABLE};case"hidden":return{char:"",color:Xt.HIDDEN};default:return{char:"",color:[100,100,100]}}}renderLegend(t,o){const n=[{char:"",label:"Current",color:Xt.CURRENT},{char:"",label:"Cleared",color:Xt.VISITED},{char:"",label:"Available",color:Xt.AVAILABLE},{char:"B",label:"Boss",color:Xt.BOSS}],s=80,a=14;n.forEach((r,l)=>{const c=l%2,d=Math.floor(l/2),i=t+c*s,h=o+d*a,u=this.k.add([this.k.text(r.char,{size:10}),this.k.pos(i,h),this.k.anchor("topleft"),this.k.color(...r.color),this.k.fixed(),this.k.z(Vt.Z_ICON),"minimap"]);this.elements.push(u);const g=this.k.add([this.k.text(r.label,{size:8}),this.k.pos(i+14,h+1),this.k.anchor("topleft"),this.k.color(...Xt.TEXT_MUTED),this.k.fixed(),this.k.z(Vt.Z_ICON),"minimap"]);this.elements.push(g)})}destroy(){this.destroyed=!0,this.clear()}}function d1(e,t){return new l1(e,t)}const zl={city:{name:"Urban Streets",description:"Abandoned city blocks overrun by chaos",floors:[1],decorations:[{char:"",pattern:"horizontal_lines",density:"medium",opacity:.18},{char:"",pattern:"vertical_lines",density:"low",opacity:.15},{char:"",pattern:"scattered",count:4,opacity:.22},{char:"",pattern:"scattered",count:3,opacity:.18},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:12,opacity:.12},{char:"",pattern:"random",count:6,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08}],baseColor:[55,55,65],ambientColor:[70,70,80]},mechanical:{name:"Industrial Complex",description:"Rusted factories and hazardous machinery",floors:[2],decorations:[{char:"",pattern:"horizontal_lines",density:"high",opacity:.15},{char:"",pattern:"grid",spacing:70,opacity:.18},{char:"",pattern:"scattered",count:5,opacity:.22},{char:"",pattern:"scattered",count:4,opacity:.2},{char:"",pattern:"edges",count:16,opacity:.16},{char:"",pattern:"corners",opacity:.24},{char:"",pattern:"random",count:10,opacity:.1},{char:"",pattern:"scattered",count:2,opacity:.15},{char:"",pattern:"horizontal_lines",density:"low",opacity:.12}],baseColor:[75,60,50],ambientColor:[90,75,60]},futuristic:{name:"Cyber Station",description:"High-tech facility with malfunctioning systems",floors:[3],decorations:[{char:"",pattern:"vertical_lines",density:"medium",opacity:.16},{char:"",pattern:"horizontal_lines",density:"medium",opacity:.16},{char:"",pattern:"grid",spacing:90,opacity:.14},{char:"",pattern:"scattered",count:6,opacity:.18},{char:"",pattern:"corners",opacity:.22},{char:"",pattern:"scattered",count:8,opacity:.16},{char:"",pattern:"grid",spacing:150,opacity:.1},{char:"",pattern:"random",count:5,opacity:.12},{char:"",pattern:"edges",count:20,opacity:.15}],baseColor:[45,55,75],ambientColor:[60,80,120]},alien:{name:"Alien Vessel",description:"Otherworldly organic ship interior",floors:[4],decorations:[{char:"",pattern:"wavy_lines",density:"medium",opacity:.15},{char:"~",pattern:"random",count:20,opacity:.12},{char:"",pattern:"scattered",count:5,opacity:.2},{char:"",pattern:"grid",spacing:110,opacity:.16},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:6,opacity:.16},{char:"",pattern:"random",count:12,opacity:.1},{char:"",pattern:"scattered",count:15,opacity:.08},{char:"",pattern:"random",count:8,opacity:.12},{char:"",pattern:"random",count:8,opacity:.12}],baseColor:[60,45,70],ambientColor:[80,60,100]},void:{name:"The Void",description:"Reality breaks down at the edge of existence",floors:[5,6,7,8],decorations:[{char:"",pattern:"random",count:25,opacity:.15},{char:"",pattern:"random",count:15,opacity:.12},{char:"",pattern:"scattered",count:8,opacity:.18},{char:"",pattern:"grid",spacing:120,opacity:.14},{char:"",pattern:"corners",opacity:.2},{char:"",pattern:"scattered",count:10,opacity:.16},{char:"",pattern:"random",count:20,opacity:.1},{char:"",pattern:"random",count:20,opacity:.1}],baseColor:[35,30,45],ambientColor:[50,40,70]}};function h1(e){for(const[t,o]of Object.entries(zl))if(o.floors.includes(e))return{key:t,...o};return{key:"city",...zl.city}}function u1(e,t,o=800,n=600){const s=h1(t),a=[],r=30;return s.decorations.forEach(l=>{const c=s.baseColor,d=e.rgb(c[0]+(Math.random()-.5)*20,c[1]+(Math.random()-.5)*20,c[2]+(Math.random()-.5)*20);switch(l.pattern){case"horizontal_lines":{const i=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<n-r;h+=i)a.push({char:l.char,x:o/2,y:h+(Math.random()-.5)*20,color:d,opacity:l.opacity,size:12});break}case"vertical_lines":{const i=l.density==="high"?40:l.density==="medium"?80:120;for(let h=r;h<o-r;h+=i)a.push({char:l.char,x:h+(Math.random()-.5)*20,y:n/2,color:d,opacity:l.opacity,size:12});break}case"wavy_lines":{for(let h=r;h<n-r;h+=60)for(let u=r;u<o-r;u+=40)a.push({char:l.char,x:u+Math.sin(h*.05)*15,y:h,color:d,opacity:l.opacity,size:10});break}case"grid":{const i=l.spacing||80;for(let h=r;h<n-r;h+=i)for(let u=r;u<o-r;u+=i)a.push({char:l.char,x:u+(Math.random()-.5)*10,y:h+(Math.random()-.5)*10,color:d,opacity:l.opacity,size:14});break}case"scattered":{const i=l.count||5;for(let h=0;h<i;h++)a.push({char:l.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(n-r*2),color:d,opacity:l.opacity,size:16});break}case"random":{const i=l.count||10;for(let h=0;h<i;h++)a.push({char:l.char,x:r+Math.random()*(o-r*2),y:r+Math.random()*(n-r*2),color:d,opacity:l.opacity,size:10+Math.random()*6});break}case"corners":{[{x:r+40,y:r+40},{x:o-r-40,y:r+40},{x:r+40,y:n-r-40},{x:o-r-40,y:n-r-40}].forEach(h=>{a.push({char:l.char,x:h.x,y:h.y,color:d,opacity:l.opacity,size:18})});break}case"edges":{const i=l.count||8,h=Math.floor(i/4);for(let u=0;u<h;u++)a.push({char:l.char,x:o/h*u+o/(h*2),y:r+20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:o/h*u+o/(h*2),y:n-r-20,color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:r+20,y:n/h*u+n/(h*2),color:d,opacity:l.opacity,size:12});for(let u=0;u<h;u++)a.push({char:l.char,x:o-r-20,y:n/h*u+n/(h*2),color:d,opacity:l.opacity,size:12});break}}}),a}function f1(e,t,o=800,n=600){u1(e,t,o,n).forEach(a=>{e.add([e.text(a.char,{size:a.size}),e.pos(a.x,a.y),e.color(a.color),e.opacity(a.opacity),e.z(0),"floorDecoration"])})}class sa{constructor(t,o){this.playerId=t,this.characterKey=o,this.x=400,this.y=300,this.velocityX=0,this.velocityY=0,this.health=100,this.maxHealth=100,this.speed=150,this.level=gn.STARTING_LEVEL,this.xp=gn.STARTING_XP,this.xpToNext=gn.BASE_XP_TO_NEXT_LEVEL,this.xpMultiplier=1,this.weaponKey="pistol",this.fireRate=1.5,this.projectileSpeed=300,this.projectileDamage=10,this.projectileCount=1,this.piercing=0,this.obstaclePiercing=0,this.critChance=.05,this.critDamage=2,this.spreadAngle=0,this.weaponRange=600,this.pickupRadius=30,this.defense=0,this.damageReduction=0,this.dodgeChance=0,this.invulnerable=!1,this.invulnerableTime=0,this.slowed=!1,this.isDead=!1,this.weapons=[],this.passiveUpgrades=[],this.upgradeStacks={},this.input={moveX:0,moveY:0,aimX:0,aimY:0,firing:!1}}toJSON(){return{playerId:this.playerId,characterKey:this.characterKey,x:this.x,y:this.y,velocityX:this.velocityX,velocityY:this.velocityY,health:this.health,maxHealth:this.maxHealth,speed:this.speed,level:this.level,xp:this.xp,xpToNext:this.xpToNext,xpMultiplier:this.xpMultiplier,weaponKey:this.weaponKey,fireRate:this.fireRate,projectileSpeed:this.projectileSpeed,projectileDamage:this.projectileDamage,projectileCount:this.projectileCount,piercing:this.piercing,obstaclePiercing:this.obstaclePiercing,critChance:this.critChance,critDamage:this.critDamage,spreadAngle:this.spreadAngle,weaponRange:this.weaponRange,pickupRadius:this.pickupRadius,defense:this.defense,damageReduction:this.damageReduction,dodgeChance:this.dodgeChance,invulnerable:this.invulnerable,invulnerableTime:this.invulnerableTime,slowed:this.slowed,isDead:this.isDead,weapons:this.weapons,passiveUpgrades:this.passiveUpgrades,upgradeStacks:this.upgradeStacks}}static fromJSON(t){const o=new sa(t.playerId,t.characterKey);return Object.assign(o,t),o}}class ia{constructor(t,o,n,s,a={}){this.id=t,this.type=o,this.x=n,this.y=s,this.data=a,this.removed=!1}toJSON(){return{id:this.id,type:this.type,x:this.x,y:this.y,data:this.data,removed:this.removed}}static fromJSON(t){return new ia(t.id,t.type,t.x,t.y,t.data)}}class aa{constructor(){this.sessionId=this.generateId(),this.gameMode="singleplayer",this.isPaused=!1,this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players=new Map,this.localPlayerId=null,this.entities=new Map,this.nextEntityId=1,this.doors=[],this.obstacles=[],this.credits=0,this.totalCreditsEarned=0,this.gameTime=0,this.deltaTime=0}addPlayer(t,o){const n=new sa(t,o);return this.players.set(t,n),this.localPlayerId===null&&(this.localPlayerId=t),n}getPlayer(t){return this.players.get(t)}getLocalPlayer(){return this.players.get(this.localPlayerId)}getAllPlayers(){return Array.from(this.players.values())}addEntity(t,o,n,s={}){const a=this.generateEntityId(),r=new ia(a,t,o,n,s);return this.entities.set(a,r),r}getEntity(t){return this.entities.get(t)}getEntitiesByType(t){return Array.from(this.entities.values()).filter(o=>o.type===t&&!o.removed)}removeEntity(t){const o=this.entities.get(t);o&&(o.removed=!0)}cleanupRemovedEntities(){for(const[t,o]of this.entities.entries())o.removed&&this.entities.delete(t)}updateTime(t){this.deltaTime=t,this.gameTime+=t}nextRoom(){this.currentRoom++,this.roomCleared=!1}nextFloor(){this.currentFloor++,this.currentRoom=1,this.floorComplete=!1,this.roomCleared=!1}clearRoom(){this.roomCleared=!0}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateEntityId(){return this.nextEntityId++}toJSON(){return{sessionId:this.sessionId,gameMode:this.gameMode,isPaused:this.isPaused,currentFloor:this.currentFloor,currentRoom:this.currentRoom,roomCleared:this.roomCleared,players:Array.from(this.players.entries()).map(([t,o])=>[t,o.toJSON()]),entities:Array.from(this.entities.entries()).map(([t,o])=>[t,o.toJSON()]),doors:this.doors,obstacles:this.obstacles,gameTime:this.gameTime,localPlayerId:this.localPlayerId,nextEntityId:this.nextEntityId}}static fromJSON(t){const o=new aa;return o.sessionId=t.sessionId,o.gameMode=t.gameMode,o.isPaused=t.isPaused,o.currentFloor=t.currentFloor,o.currentRoom=t.currentRoom,o.roomCleared=t.roomCleared,o.gameTime=t.gameTime,o.localPlayerId=t.localPlayerId,o.nextEntityId=t.nextEntityId,o.players=new Map(t.players.map(([n,s])=>[n,sa.fromJSON(s)])),o.entities=new Map(t.entities.map(([n,s])=>[n,ia.fromJSON(s)])),o.doors=t.doors,o.obstacles=t.obstacles,o}snapshot(){return JSON.parse(JSON.stringify(this.toJSON()))}reset(){this.currentFloor=1,this.currentRoom=1,this.roomCleared=!1,this.floorComplete=!1,this.players.clear(),this.entities.clear(),this.doors=[],this.obstacles=[],this.gameTime=0,this.nextEntityId=1}}class p1{constructor(){this.gameState=null}init(t="singleplayer"){return this.gameState=new aa,this.gameState.gameMode=t,this.gameState}getState(){if(!this.gameState)throw new Error("GameState not initialized! Call StateManager.init() first.");return this.gameState}loadState(t){return this.gameState=aa.fromJSON(t),this.gameState}clear(){this.gameState=null}}const Ol=new p1;class dc{constructor(t,o,n){this.playerId=t,this.frameNumber=o,this.timestamp=n,this.moveX=0,this.moveY=0,this.aimX=0,this.aimY=0,this.firing=!1,this.pause=!1,this.interact=!1}toJSON(){return{playerId:this.playerId,frameNumber:this.frameNumber,timestamp:this.timestamp,moveX:this.moveX,moveY:this.moveY,aimX:this.aimX,aimY:this.aimY,firing:this.firing,pause:this.pause,interact:this.interact}}static fromJSON(t){const o=new dc(t.playerId,t.frameNumber,t.timestamp);return Object.assign(o,t),o}}class g1{constructor(){this.frameNumber=0,this.inputQueues=new Map,this.currentInputs=new Map,this.inputHistory=[],this.maxHistoryFrames=120,this.keysPressed=new Set,this.mouseX=0,this.mouseY=0,this.mousePressed=!1,this.eventHandlers=[]}init(t){this.k=t,this.setupKeyboardListeners(),this.setupMouseListeners()}setupKeyboardListeners(){const t=this.k;["w","a","s","d","up","down","left","right"].forEach(n=>{this.eventHandlers.push(t.onKeyPress(n,()=>{this.keysPressed.add(n)})),this.eventHandlers.push(t.onKeyRelease(n,()=>{this.keysPressed.delete(n)}))}),this.eventHandlers.push(t.onKeyPress("escape",()=>{this.onPausePressed()})),this.eventHandlers.push(t.onKeyPress("space",()=>{this.onInteractPressed()})),this.eventHandlers.push(t.onKeyPress("e",()=>{this.onInteractPressed()}))}setupMouseListeners(){const t=this.k;this.eventHandlers.push(t.onMouseMove(o=>{this.mouseX=o.x,this.mouseY=o.y})),this.eventHandlers.push(t.onMousePress(()=>{this.mousePressed=!0})),this.eventHandlers.push(t.onMouseRelease(()=>{this.mousePressed=!1}))}collectLocalInput(t){const o=new dc(t,this.frameNumber,Date.now());return o.moveX=this.getMoveX(),o.moveY=this.getMoveY(),o.aimX=this.mouseX,o.aimY=this.mouseY,o.firing=!0,o}getMoveX(){let t=0;return(this.keysPressed.has("a")||this.keysPressed.has("left"))&&(t-=1),(this.keysPressed.has("d")||this.keysPressed.has("right"))&&(t+=1),t}getMoveY(){let t=0;return(this.keysPressed.has("w")||this.keysPressed.has("up"))&&(t-=1),(this.keysPressed.has("s")||this.keysPressed.has("down"))&&(t+=1),t}onPausePressed(){this.pauseRequested=!0}onInteractPressed(){this.interactRequested=!0}queueInput(t){this.inputQueues.has(t.playerId)||this.inputQueues.set(t.playerId,[]),this.inputQueues.get(t.playerId).push(t)}getInputsForFrame(t){const o=new Map;for(const n of t){const s=this.inputQueues.get(n);let a;s&&s.length>0?a=s.shift():a=this.collectLocalInput(n),o.set(n,a)}return this.currentInputs=o,this.inputHistory.push(new Map(o)),this.inputHistory.length>this.maxHistoryFrames&&this.inputHistory.shift(),this.frameNumber++,o}getPlayerInput(t){return this.currentInputs.get(t)}getInputHistory(){return this.inputHistory}clear(){this.eventHandlers.forEach(t=>{t&&t.cancel&&t.cancel()}),this.eventHandlers=[],this.frameNumber=0,this.inputQueues.clear(),this.currentInputs.clear(),this.inputHistory=[],this.keysPressed.clear(),this.pauseRequested=!1,this.interactRequested=!1}resetFrameFlags(){this.pauseRequested=!1,this.interactRequested=!1}}class m1{constructor(){this.inputManager=null}init(t){return this.inputManager=new g1,this.inputManager.init(t),this.inputManager}getManager(){if(!this.inputManager)throw new Error("InputManager not initialized! Call InputManager.init() first.");return this.inputManager}clear(){this.inputManager&&this.inputManager.clear(),this.inputManager=null}}const Hl=new m1,Ul={PLAYER_JOINED:"player_joined",PLAYER_LEFT:"player_left"};class ra{constructor(t,o,n=null){this.type=t,this.data=o,this.senderId=n,this.timestamp=Date.now()}toJSON(){return{type:this.type,data:this.data,senderId:this.senderId,timestamp:this.timestamp}}static fromJSON(t){const o=new ra(t.type,t.data,t.senderId);return o.timestamp=t.timestamp,o}}class y1{constructor(){this.isConnected=!1,this.isHost=!1,this.localPlayerId=null,this.sessionId=null,this.players=new Map,this.messageQueue=[],this.eventHandlers=new Map,this.mode="local"}init(t="local"){return this.mode=t,this.localPlayerId=this.generatePlayerId(),t==="local"&&(this.isConnected=!0,this.isHost=!0,this.sessionId=this.generateSessionId(),this.addPlayer(this.localPlayerId,{name:"Player 1",isLocal:!0})),this.localPlayerId}async connect(t=null){return this.mode==="local"||(this.isConnected=!0,this.sessionId=t||this.generateSessionId(),this.emit("connected",{sessionId:this.sessionId})),!0}disconnect(){this.isConnected&&(this.emit("disconnected"),this.isConnected=!1,this.players.clear(),this.messageQueue=[])}send(t,o){const n=new ra(t,o,this.localPlayerId);this.mode!=="local"&&(console.log("[Network] Send:",n),this.messageQueue.push(n))}broadcast(t,o){this.send(t,o)}sendTo(t,o,n){const s=new ra(o,n,this.localPlayerId);console.log(`[Network] SendTo ${t}:`,s)}receive(){const t=[...this.messageQueue];this.messageQueue=[];for(const o of t)this.handleMessage(o);return t}handleMessage(t){switch(this.emit(t.type,t.data,t.senderId),t.type){case Ul.PLAYER_JOINED:this.addPlayer(t.senderId,t.data);break;case Ul.PLAYER_LEFT:this.removePlayer(t.senderId);break}}addPlayer(t,o){this.players.set(t,{id:t,...o,joinedAt:Date.now()}),this.emit("playerJoined",{playerId:t,playerInfo:o})}removePlayer(t){const o=this.players.get(t);this.players.delete(t),this.emit("playerLeft",{playerId:t,playerInfo:o})}getPlayers(){return Array.from(this.players.values())}isPlayerConnected(t){return this.players.has(t)}on(t,o){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(o)}off(t,o){if(this.eventHandlers.has(t)){const n=this.eventHandlers.get(t),s=n.indexOf(o);s>-1&&n.splice(s,1)}}emit(t,o,n=null){if(this.eventHandlers.has(t)){const s=this.eventHandlers.get(t);for(const a of s)a(o,n)}}generatePlayerId(){return`player-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getPing(){return 0}isHostClient(){return this.isHost}getLocalPlayerId(){return this.localPlayerId}clear(){this.disconnect(),this.eventHandlers.clear()}}class x1{constructor(){this.networkManager=null}init(t="local"){return this.networkManager=new y1,this.networkManager.init(t)}getManager(){if(!this.networkManager)throw new Error("NetworkManager not initialized! Call NetworkManager.init() first.");return this.networkManager}clear(){this.networkManager&&this.networkManager.clear(),this.networkManager=null}}const w1=new x1;let j={currentFloor:1,currentRoom:1,playerStats:null,entryDirection:null,floorMap:null,minimap:null,rerollsRemaining:0,playersRevivedThisRun:new Set,isDailyRun:!1,dailyCharacter:null,dailySeed:null,dailyRNG:null},Et={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0},Bi=!1;function Nl(e,t,o=null){const n=o===null,s=n?Ct("startingHealth"):o?.startingHealth||0;s>0&&(t.maxHealth+=s*10,t.setHP(t.maxHealth));const a=n?Ct("startingDamage"):o?.startingDamage||0;a>0&&(t.projectileDamage+=a);const r=n?Ct("startingSpeed"):o?.startingSpeed||0;r>0&&(t.speed+=r*10)}function b1(e,t,o){const n=Yg();if(n.length!==0&&(o.activeBoosters=[],o.creditMultiplier=1,n.forEach(s=>{const a=rh[s.key];if(!a||!a.effect)return;const r=a.effect;switch(r.type){case"startingHealth":t.maxHealth+=r.value,t.setHP(t.hp()+r.value);break;case"tempDamage":t.projectileDamage=Math.floor(t.projectileDamage*(1+r.value)),o.activeBoosters.push({type:"tempDamage",value:r.value,duration:r.duration});break;case"tempSpeed":t.speed=Math.floor(t.speed*(1+r.value)),t.originalSpeed=t.speed,o.activeBoosters.push({type:"tempSpeed",value:r.value,duration:r.duration});break;case"creditMultiplier":o.creditMultiplier=(o.creditMultiplier||1)+r.value;break;case"tempCrit":t.critChance=(t.critChance||0)+r.value,o.activeBoosters.push({type:"tempCrit",value:r.value,duration:r.duration});break;case"tempDefense":t.damageReduction=(t.damageReduction||0)+r.value,o.activeBoosters.push({type:"tempDefense",value:r.value,duration:r.duration});break;case"tempXP":t.xpMultiplier=(t.xpMultiplier||1)*(1+r.value),o.activeBoosters.push({type:"tempXP",value:r.value,duration:r.duration});break;case"autoRevive":t.autoRevive={health:r.value,uses:r.uses};break}}),n.length>0)){const s=e.add([e.text(`${n.length} Booster${n.length>1?"s":""} Active!`,{size:18}),e.pos(e.width()/2,100),e.anchor("center"),e.color(100,255,150),e.fixed(),e.z(2e3),e.opacity(1)]);e.wait(2,()=>{s.exists()&&e.tween(s.opacity,0,.5,a=>s.opacity=a,e.easings.easeOutQuad).onEnd(()=>{s.exists()&&e.destroy(s)})})}}function v1(e){e.scene("game",t=>{if(mx(),t?.resetState){const E=w1.init("local");Hl.init(e),Ol.init("singleplayer").addPlayer(E,"survivor")}const o=Ol.getState();if(tm(e),nm(e),Qy(),e.paused=!1,t?.resetState){j.currentFloor=1,j.currentRoom=1,j.playerStats=null,j.allPlayerStats=null,j.entryDirection=null,j.floorMap=null,j.playersRevivedThisRun=new Set,n1(),j.isDailyRun=t?.isDailyRun||!1,j.dailyCharacter=t?.dailyCharacter||null,j.dailySeed=t?.dailySeed||null,j.dailyRNG=j.isDailyRun&&j.dailySeed?new mn(j.dailySeed):null,j.isDailyRun&&console.log("[DailyRun] Starting daily run with character:",j.dailyCharacter,"seed:",j.dailySeed),Et={floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{},startTime:Date.now()},i1(e);const E=Ct("mulligan");j.rerollsRemaining=E,Bi=!1,e.wait(1,()=>qx(e)),e.gameData&&(e.gameData.weaponDetailSavedState=void 0)}let n=j.currentFloor,s=j.currentRoom;const a={updates:[],keyPresses:[]};let r=!1,l=!1;const c=[];let d=null;const i={enemies:new za(128),obstacles:new za(128),pickups:new za(128)};Bx(e),Ox();const h=Nn();function u(){if(j.isDailyRun&&j.dailySeed){const E=j.dailySeed+n*1e4+s*100;return new mn(E)}else if(h>1)return Ti();return null}const g=()=>{h>1&&(my(n),console.log("[Multiplayer] Generating floor map with seed:",fl()?"valid":"invalid (0)"));const E=h>1?xy():null;j.floorMap=c1(n,E),j.minimap&&j.minimap.destroy(),j.minimap=d1(e,j.floorMap),e.gameData&&(e.gameData.minimap=j.minimap)};!j.floorMap||j.floorMap.floor!==n?g():j.minimap&&j.minimap.update(),n>Et.floorsReached&&(Et.floorsReached=n);const p={1:"Public Access",2:"Local Affiliate",3:"Cable Network",4:"Premium Channel",5:"Streaming Giant",6:"Global Broadcast",7:"Galactic Signal"},D=E=>p[E]||`Network ${E}`,m=bo("gameplay","skipIntroAnimation");if(s===1&&!m){const E=e.add([e.text(`Floor ${n}`,{size:32}),e.pos(e.width()/2,e.height()/3),e.anchor("center"),e.color(255,255,255),e.opacity(1),e.fixed(),e.z(3e3)]),W=e.add([e.text(D(n),{size:20}),e.pos(e.width()/2,e.height()/3+40),e.anchor("center"),e.color(200,200,255),e.opacity(1),e.fixed(),e.z(3e3)]);e.wait(2,()=>{E.exists()&&E.onUpdate(()=>{E.opacity-=.02,E.opacity<=0&&e.destroy(E)}),W.exists()&&W.onUpdate(()=>{W.opacity-=.02,W.opacity<=0&&e.destroy(W)})})}const M=30;let B=e.width()/2,P=e.height()/2;if(j.entryDirection)switch(j.entryDirection){case"north":B=e.width()/2,P=M;break;case"south":B=e.width()/2,P=e.height()-M;break;case"west":B=M,P=e.height()/2;break;case"east":B=e.width()-M,P=e.height()/2;break}let f;const O=j.isDailyRun?j.dailyCharacter:null;if(j.playerStats){f=Pa(e,B,P,O),Object.assign(f,j.playerStats);const E=f.isRemote;if(f.isRemote=!1,E&&console.log("[Room Transition] Fixed isRemote flag - local player was incorrectly marked as remote"),f.setHP(j.playerStats.currentHP||f.maxHealth),j.playerStats.selectedUpgrades&&(f.selectedUpgrades=new Set(j.playerStats.selectedUpgrades)),j.playerStats.activeSynergies&&(f.activeSynergies=new Set(j.playerStats.activeSynergies)),j.playerStats.pendingLevelUps&&(f.pendingLevelUps=[...j.playerStats.pendingLevelUps]),f.upgradeStacks&&Object.keys(f.upgradeStacks).length>0&&ta(f),f.activeSynergies&&f.activeSynergies.size>0){Cl(f);const W=j.playerStats.currentHP||f.maxHealth;f.setHP(Math.min(W,f.maxHealth))}if((f.powerupWeapon==="orbital"||f.weaponKey==="orbital")&&(f.orbitalOrbs=[],f.orbitalAngles=[],f.orbitalNeedsReinit=!0),f.slowed=!1,f.isDead?(f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5)):(f.canMove=!0,f.canShoot=!0,f.opacity=1,f.outline&&f.outline.exists()&&(f.outline.opacity=1)),j.equippedCosmetics){if(j.equippedCosmetics.glow&&j.equippedCosmetics.glow!=="glowNone"&&!f.isDead){const W=fs[j.equippedCosmetics.glow];W&&W.color&&(f.glowEffect=Ml(e,f,j.equippedCosmetics.glow,W.color))}if(j.equippedCosmetics.trail&&j.equippedCosmetics.trail!=="trailNone"){const W=fs[j.equippedCosmetics.trail];W&&(f.trailType=j.equippedCosmetics.trail,f.trailColor=W.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}}}else{const E=j.isDailyRun?j.dailyCharacter:null;f=Pa(e,B,P,E),Nl(e,f),b1(e,f,j);const W=jg();if(j.equippedCosmetics=W,W.glow&&W.glow!=="glowNone"){const q=fs[W.glow];q&&q.color&&(f.glowEffect=Ml(e,f,W.glow,q.color))}if(W.trail&&W.trail!=="trailNone"){const q=fs[W.trail];q&&(f.trailType=W.trail,f.trailColor=q.color,f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}f.runStats={kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}const v=ys(),T=fm();let x=new Array(v.maxSlots).fill(null);if(h>1&&T.isInitialized){const E=v.slots.findIndex(q=>q.isLocal);if(jm(v.isHost,E,e),v.isHost){const q=Ti(),V=Ws(n,q);j.roomTemplateKey=V.key,console.log("[Multiplayer] Host selected first room template:",V.key),by(V.key)}v.isHost?g():gy(()=>{console.log("[Multiplayer] Client received seed, regenerating floor map"),g()}),f.slotIndex=E,f.playerName=v.slots[E].playerName;const W=E*30;f.pos.x=B+W,ll(E,f),x[E]=f,v.slots.forEach((q,V)=>{if(V!==E&&q.playerId!==null){const Y=V*30,A=Pa(e,B+Y,P,q.selectedCharacter);if(A.isRemote=!0,A.slotIndex=V,A.playerName=q.playerName,j.allPlayerStats&&j.allPlayerStats.length>0){const Ye=j.allPlayerStats.find(Oe=>Oe.slotIndex===V);if(Ye){if(Object.assign(A,Ye),A.isRemote=!0,A.setHP(Ye.currentHP||A.maxHealth),Ye.selectedUpgrades&&(A.selectedUpgrades=new Set(Ye.selectedUpgrades)),Ye.activeSynergies&&(A.activeSynergies=new Set(Ye.activeSynergies)),Ye.pendingLevelUps&&(A.pendingLevelUps=[...Ye.pendingLevelUps]),A.upgradeStacks&&Object.keys(A.upgradeStacks).length>0&&ta(A),A.activeSynergies&&A.activeSynergies.size>0){Cl(A);const Oe=Ye.currentHP||A.maxHealth;A.setHP(Math.min(Oe,A.maxHealth))}(A.powerupWeapon==="orbital"||A.weaponKey==="orbital")&&(A.orbitalOrbs=[],A.orbitalAngles=[],A.orbitalNeedsReinit=!0),A.slowed=!1,A.isDead?(A.canMove=!1,A.canShoot=!1,A.opacity=.5,A.outline&&A.outline.exists()&&(A.outline.opacity=.5)):(A.canMove=!0,A.canShoot=!0,A.opacity=1,A.outline&&A.outline.exists()&&(A.outline.opacity=1))}}else Nl(e,A,q.permanentUpgradeLevels);Tl(e,A),Pl(e,A,null,!0),ll(V,A),x[V]=A,v.isHost&&A.onDeath(()=>{if(A.isDead=!0,A.canMove=!1,A.canShoot=!1,A.opacity=.5,A.outline&&A.outline.exists()&&(A.outline.opacity=.5),!x.some(Oe=>Oe&&Oe.exists()&&Oe.hp()>0&&!Oe.isDead)){const Oe=Ca(Et),xt={...Et,level:f.level,currencyEarned:Oe};Da(xt),ps(Oe),Pi(e);const _t=x.filter(Yt=>Yt&&Yt.exists()).map(Yt=>({name:Yt.playerName||"Player",level:Yt.level||1,characterData:Yt.characterData,kills:Yt.runStats?.kills||0,deaths:Yt.runStats?.deaths||0,revives:Yt.runStats?.revives||0,damageTaken:Yt.runStats?.damageTaken||0,damageDealt:Yt.runStats?.damageDealt||0,xpCollected:Yt.runStats?.xpPickedUp||0,creditsPickedUp:Yt.runStats?.creditsPickedUp||0,bossesKilled:Yt.runStats?.bossesKilled||0}));he()&&(hl(Et,Oe,_t),hs()),e.go("gameOver",{runStats:{...Et},currencyEarned:Oe,partyStats:_t,isDailyRun:j.isDailyRun,dailyCharacter:j.dailyCharacter})}});const $=e.add([e.text(q.playerName,{size:10}),e.pos(0,-30),e.color(150,150,255),e.z(100)]),ge=40,Le=4,xe=-40,ze=e.add([e.rect(ge,Le),e.pos(A.pos.x,A.pos.y+xe),e.anchor("center"),e.color(50,50,50),e.z(100),"playerHealthBar"]),Se=e.add([e.rect(ge,Le),e.pos(A.pos.x,A.pos.y+xe),e.anchor("center"),e.color(100,255,100),e.z(101),"playerHealthBar"]);A.healthBarBg=ze,A.healthBar=Se,ze.hidden=!0,Se.hidden=!0,$.onUpdate(()=>{if(A.exists()){$.pos=e.vec2(A.pos.x,A.pos.y-30);const Ye=A.hp()/A.maxHealth;if(Ye<1&&Ye>0){ze.hidden=!1,Se.hidden=!1,ze.pos.x=A.pos.x,ze.pos.y=A.pos.y+xe,Se.pos.x=A.pos.x,Se.pos.y=A.pos.y+xe;const xt=Math.max(1,ge*Ye);Se.use(e.rect(xt,Le)),Se.pos.x=A.pos.x-(ge-xt)/2}else ze.hidden=!0,Se.hidden=!0}else $.destroy(),ze.exists()&&ze.destroy(),Se.exists()&&Se.destroy()})}}),me()||Bi||(Bi=!0,_e("room_transition",q=>{if(j.entryDirection=q.entryDirection,q.allPlayerStats){j.allPlayerStats=q.allPlayerStats;const Y=ys().slots.findIndex($=>$.isLocal),A=q.allPlayerStats.find($=>$&&$.slotIndex===Y);A?(j.playerStats=A,console.log("[Multiplayer] Client restored stats for slot",Y,"level:",A.level)):console.warn("[Multiplayer] Client could not find stats for local slot",Y,"in",q.allPlayerStats)}q.roomTemplateKey&&(j.roomTemplateKey=q.roomTemplateKey,console.log("[Multiplayer] Client received room template:",q.roomTemplateKey)),q.currentFloor&&q.currentFloor!==j.currentFloor?(console.log(`[Multiplayer] Floor advancement: ${j.currentFloor} -> ${q.currentFloor}`),j.currentFloor=q.currentFloor,j.floorMap=null,j.entryDirection=null):q.gridDirection&&j.floorMap&&j.floorMap.moveToRoom(q.gridDirection),!r&&(r=!0,Ha(),e.go("game"))}),_e("room_completed",()=>{if(l=!0,d(),c.forEach(Y=>{Y.exists()&&!Y.blocked&&(Y.open=!0,Y.isSpawnDoor=!1,Y.updateVisual())}),H){const Y=c.find(A=>A.direction==="north");Y&&Y.exists()&&(Y.blocked=!1,Y.open=!0,Y.isSpawnDoor=!1,Y.isFloorExit=!0,Y.updateVisual())}j.minimap&&j.minimap.update();const q=H?`BOSS DEFEATED! Floor ${n} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",V=e.add([e.text(q,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{V.exists()&&e.destroy(V)})}),_e("obstacle_data",q=>{console.log("[Multiplayer] Client received obstacle data:",q.obstacles.length,"obstacles"),e.get("obstacle").forEach(V=>e.destroy(V)),q.obstacles.forEach(V=>{const Y=Array.isArray(V.color)?e.rgb(V.color[0],V.color[1],V.color[2]):V.color;yl(e,V.x,V.y,V.width,V.height,V.type,V.char,Y)})}),_e("door_states",q=>{console.log("[Multiplayer] Client received door states:",q),typeof c<"u"&&c.length>0&&c.forEach(V=>{q.hasOwnProperty(V.direction)&&(V.blocked=q[V.direction],V.updateVisual())})}),_e("game_over",q=>{const V=q.currencyEarned||Ca(q.runStats||Et),Y={...q.runStats||Et,level:f.level,currencyEarned:V};Da(Y),ps(V),Pi(e),hs(),e.go("gameOver",{runStats:{...q.runStats||Et},currencyEarned:V,partyStats:q.partyStats||[],isDailyRun:j.isDailyRun,dailyCharacter:j.dailyCharacter})}),_e("powerup_weapon_applied",q=>{x.forEach(V=>{!V||!V.exists()||Ia(V,q.powerupKey)})}),_e("upgrade_selected",q=>{if(q.slotIndex===E)return;const V=x.find(Y=>Y.slotIndex===q.slotIndex);V&&V.exists()&&(jr(V,q.upgradeKey),Kh(V,q.upgradeKey),Xi(e,V))}),_e("level_up_queued",q=>{if(q.slotIndex===E)return;const V=x.find(Y=>Y.slotIndex===q.slotIndex);V&&V.exists()&&(V.level=q.level,V.pendingLevelUps||(V.pendingLevelUps=[]),V.pendingLevelUps.includes(q.level)||V.pendingLevelUps.push(q.level))}),_e("synergy_activated",q=>{if(q.slotIndex===E)return;const V=x.find(Y=>Y.slotIndex===q.slotIndex);V&&V.exists()&&Xi(e,V)}),_e("powerup_expired",q=>{const V=x.find(Y=>Y.slotIndex===q.slotIndex);V&&V.exists()&&gr(V)}),_e("player_healed",q=>{const V=x.find(Y=>Y.slotIndex===q.slotIndex);V&&V.exists()&&V.setHP(q.newHP)}),_e("player_dodged",q=>{const V=x.find(Y=>Y.slotIndex===q.slotIndex);if(V&&V.exists()){const Y=e.add([e.text("DODGE!",{size:14}),e.pos(q.x,q.y-30),e.anchor("center"),e.color(100,200,255),e.opacity(1),e.z(500)]);let A=0;Y.onUpdate(()=>{A+=e.dt(),Y.pos.y-=30*e.dt(),Y.opacity=Math.max(0,1-A/.8),A>=.8&&e.destroy(Y)})}}))}else f.slotIndex=0,x[0]=f;x.filter(E=>E!==null);function C(E,W){if(!E||!E.exists())return;const q=W==="exclamation"?"!":"",V=W==="exclamation"?[255,255,0]:[255,100,150],Y=e.add([e.text(q,{size:24}),e.pos(E.pos.x,E.pos.y-50),e.anchor("center"),e.color(...V),e.opacity(1),e.scale(1),e.z(1e3),"emote"]);let A=0;const $=1.5;Y.onUpdate(()=>{A+=e.dt(),Y.pos.x=E.pos.x,Y.pos.y=E.pos.y-50-A*30,A<.2?Y.scale=e.vec2(1+A*2):Y.scale=e.vec2(1.4-(A-.2)*.3),A>$*.6&&(Y.opacity=1-(A-$*.6)/($*.4)),A>=$&&e.destroy(Y)})}let S=0;const z=.1;e.onKeyPress("q",()=>{if(f.isDead)return;const E=e.time();E-S<z||(S=E,C(f,"exclamation"),he()&&pl(f.slotIndex,"exclamation"))}),e.onKeyPress("e",()=>{if(f.isDead)return;const E=e.time();E-S<z||(S=E,C(f,"heart"),he()&&pl(f.slotIndex,"heart"))}),h>1&&_e("player_emote",E=>{const W=x[E.slotIndex];W&&W.exists()&&C(W,E.emoteType)});const L=o.localPlayerId,N=o.getPlayer(L);N&&(N.x=f.pos.x,N.y=f.pos.y,N.health=f.hp(),N.maxHealth=f.maxHealth,N.speed=f.speed,N.level=f.level,N.xp=f.xp,N.xpToNext=f.xpToNext,N.xpMultiplier=f.xpMultiplier||1,N.weaponKey="pistol",N.fireRate=f.fireRate,N.projectileSpeed=f.projectileSpeed,N.projectileDamage=f.projectileDamage,N.projectileCount=f.projectileCount||1,N.piercing=f.piercing||0,N.obstaclePiercing=f.obstaclePiercing||0,N.critChance=f.critChance||.05,N.critDamage=f.critDamage||2,N.spreadAngle=f.spreadAngle||0,N.weaponRange=f.weaponRange||600,N.pickupRadius=f.pickupRadius,N.defense=f.defense||0,N.damageReduction=f.damageReduction||0,N.dodgeChance=f.dodgeChance||0),d=()=>{if(h<=1)return;const E=Ct("secondWind");if(E<=0)return;let W=0;x.forEach((q,V)=>{if(q&&(q.exists()&&q.hp()<=0||q.exists()&&q.isDead)){const Y=`player_${V}`;if(j.playersRevivedThisRun.has(Y))return;j.playersRevivedThisRun.add(Y);const A=.05+E*.05,$=Math.max(1,Math.floor(q.maxHealth*A));q.setHP($),q.isDead=!1,q.canMove=!0,q.canShoot=!0;const ge=Math.round(A*100),Le=e.add([e.text(` REVIVED (${ge}% HP) `,{size:16}),e.pos(q.pos.x,q.pos.y-40),e.anchor("center"),e.color(100,255,100),e.opacity(1),e.lifespan(2),e.z(1e3)]);Le.onUpdate(()=>{Le.pos.y-=30*e.dt(),Le.opacity-=.5*e.dt()}),q.opacity=1,q.characterData&&q.characterData.color&&(q.color=e.rgb(...q.characterData.color)),q.outline&&q.outline.exists()&&(q.outline.opacity=1),W++}}),W>0&&e.get("projectile").forEach(q=>{(q.isEnemyProjectile||q.isBossProjectile)&&e.destroy(q)}),W>0&&he()&&me()&&ly()},Tl(e,f);const _=Pl(e,f,d,h>1);if(f.isDead||(f.canMove=!0,f.canShoot=!0),h>1){const E=Cy();E>0&&f.addXP&&(console.log("[Multiplayer] Applying pending XP:",E),f.addXP(E))}j.playerStats&&j.playerStats.selectedUpgrades&&e.wait(.1,()=>{Xi(e,f)});const X=j.floorMap.getCurrentRoom(),H=X?X.isBossRoom:s===3;let R;if(h>1&&j.roomTemplateKey)R=Ll(j.roomTemplateKey),console.log("[Multiplayer] Using synced template:",j.roomTemplateKey),j.roomTemplateKey=null;else if(h>1&&!fl()){const E=yy();if(E)R=Ll(E),console.log("[Multiplayer] Client using first room template:",E);else{console.warn("[Multiplayer] No seed or template key available, using fallback");const W=Ti();R=Ws(n,W)}}else X&&X.template?R=X.template:R=Ws(n,u());const F=t1(e,n),G=20;f1(e,n,e.width(),e.height()),e.add([e.rect(e.width()-G*2,2),e.pos(e.width()/2,G),e.anchor("center"),e.color(F.wallColor),e.fixed()]),e.add([e.rect(e.width()-G*2,2),e.pos(e.width()/2,e.height()-G),e.anchor("center"),e.color(F.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-G*2),e.pos(G,e.height()/2),e.anchor("center"),e.color(F.wallColor),e.fixed()]),e.add([e.rect(2,e.height()-G*2),e.pos(e.width()-G,e.height()/2),e.anchor("center"),e.color(F.wallColor),e.fixed()]);const Q=s===1&&n===1,le=80;let se=e.width()/2,ne=e.height()/2;if(j.entryDirection)switch(j.entryDirection){case"north":se=e.width()/2,ne=M;break;case"south":se=e.width()/2,ne=e.height()-M;break;case"west":se=M,ne=e.height()/2;break;case"east":se=e.width()-M,ne=e.height()/2;break}const ie=[],fe=[],Me=h<=1||me();!Q&&Me&&(R.obstacles.forEach(E=>{const W=Math.sqrt(Math.pow(E.x-B,2)+Math.pow(E.y-P,2)),q=Math.sqrt(Math.pow(E.x-se,2)+Math.pow(E.y-ne,2)),V=Math.max(E.width,E.height)/2;if(W<le+V||q<le+V)return;const Y=e1(E.x,E.y,E.width,E.height),A=E.type==="wall"?F.obstacleColor:F.coverColor,$=yl(e,Y.x,Y.y,E.width,E.height,E.type,E.char||"#",A);if(ie.push($),h>1&&me()){let ge=null;A&&(Array.isArray(A)?ge=A:A.r!==void 0&&(ge=[A.r,A.g,A.b])),fe.push({x:Y.x,y:Y.y,width:E.width,height:E.height,type:E.type,char:E.char||"#",color:ge})}}),h>1&&me()&&e.wait(.1,()=>{Sy(fe)})),!Q&&!H&&Me&&o1(R.key,u(),n).forEach(W=>{const q=Math.sqrt(Math.pow(W.x-B,2)+Math.pow(W.y-P,2)),V=Math.sqrt(Math.pow(W.x-se,2)+Math.pow(W.y-ne,2));if(q<le+25||V<le+25)return;let Y=!1;ie.forEach(A=>{if(!A.exists())return;Math.sqrt(Math.pow(W.x-A.pos.x,2)+Math.pow(W.y-A.pos.y,2))<50&&(Y=!0)}),Y||$y(e,W.x,W.y)}),e.add([e.rect(82,22),e.pos(8,2),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(b.UI_BG)]);const Ue=e.add([e.text("",{size:Z.HUD}),e.pos(20,6),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT)]),Ne=e.add([e.text("0/0",{size:Z.HUD}),e.pos(40,6),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT)]);e.add([e.rect(85,22),e.pos(e.width()-10,2),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(b.UI_BG-1)]),e.add([e.text("$",{size:Z.LABEL}),e.pos(e.width()-20,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);const Pe=e.add([e.text("0",{size:Z.HUD}),e.pos(e.width()-40,6),e.anchor("topright"),e.color(255,215,0),e.fixed(),e.z(950)]);let Ge=null,Te=0;bo("visual","showTimer")!==!1&&(e.add([e.rect(60,18),e.pos(e.width()-10,28),e.anchor("topright"),e.color(0,0,0),e.opacity(.6),e.fixed(),e.z(b.UI_BG)]),Ge=e.add([e.text("0:00",{size:Z.SMALL-2}),e.pos(e.width()-15,30),e.anchor("topright"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]));let ut=null,pe=0,Ae=0,re=60;if(bo("visual","showFPS")&&(ut=e.add([e.text("60 FPS",{size:Z.SMALL-2}),e.pos(e.width()/2,6),e.anchor("top"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)])),he()){const E=ay(),W=T.isHost?[100,255,100]:[100,200,255],q=T.isHost?"HOST":"CLIENT";e.add([e.circle(4),e.pos(20,70),e.color(...W),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(`${q} (${E}P)`,{size:Z.SMALL-2}),e.pos(30,70),e.anchor("left"),e.color(...W),e.fixed(),e.z(b.UI_TEXT)])}const Ce=e.width()-40,Fe=15,De=e.height()-18;e.add([e.rect(Ce,Fe),e.pos(20,De),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.UI_BG)]);const We=f.xpToNext>0?f.xp/f.xpToNext:0,nt=Math.max(0,(Ce-34)*We),Tt=e.add([e.rect(nt,Fe-4),e.pos(58,De+2),e.color(100,200,255),e.fixed(),e.z(b.UI_BG+1)]),Lt=e.add([e.text(al(f.xp||0,f.xpToNext||10),{size:Z.SMALL-2}),e.pos(e.width()/2,De+Fe/2),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),dt=36,Ie=20+dt/2,Be=De+Fe/2;e.add([e.circle(dt/2),e.pos(Ie,Be),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(100,200,255)),e.fixed(),e.z(b.UI_BG+2)]);const Ke=e.add([e.text(`${f.level||1}`,{size:Z.BODY}),e.pos(Ie,Be),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_BG+3)]),qe=40,ke=8,at=25,tt=e.add([e.rect(qe,ke),e.pos(0,0),e.anchor("center"),e.color(...y.BG_DARK),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.z(b.OVERLAY)]),ot=e.add([e.rect(qe-2,ke-2),e.pos(0,0),e.anchor("center"),e.color(100,255,100),e.z(b.OVERLAY+1)]);tt.hidden=!0,ot.hidden=!0;const ft=48,ct=25,yt=e.height()-85,Ht=e.add([e.rect(ft,ft),e.pos(ct,yt),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(b.UI_BG)]),Dt=e.add([e.text("",{size:32}),e.pos(ct+ft/2,yt+ft/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),Nt=220,bt=90,St=e.add([e.rect(Nt,bt),e.pos(ct,yt-bt-10),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(b.OVERLAY+5)]),ye=e.add([e.text("",{size:24}),e.pos(ct+15,yt-bt-10+15),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+6)]),$e=e.add([e.text("Basic Pistol",{size:Z.SMALL,width:160}),e.pos(ct+50,yt-bt-10+10),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+6)]),ae=e.add([e.text("DMG: 10",{size:Z.SMALL-2}),e.pos(ct+50,yt-bt-10+30),e.color(255,150,150),e.fixed(),e.z(b.OVERLAY+6)]),Re=e.add([e.text("RATE: 3.75/s",{size:Z.SMALL-2}),e.pos(ct+50,yt-bt-10+47),e.color(150,200,255),e.fixed(),e.z(b.OVERLAY+6)]),je=e.add([e.text("DPS: 37.5",{size:Z.SMALL-2}),e.pos(ct+50,yt-bt-10+64),e.color(255,255,150),e.fixed(),e.z(b.OVERLAY+6)]);St.hidden=!0,ye.hidden=!0,$e.hidden=!0,ae.hidden=!0,Re.hidden=!0,je.hidden=!0;let ve=!1;t?.resetState&&(ve=!1),Ht.onClick(()=>{ve=!ve,St.hidden=!St.hidden,ye.hidden=!ye.hidden,$e.hidden=!$e.hidden,ae.hidden=!ae.hidden,Re.hidden=!Re.hidden,je.hidden=!je.hidden});const I=40,K=ct,ee=yt-I-10,ue=e.add([e.rect(I,I),e.pos(K,ee),e.color(0,0,0),e.opacity(.8),e.outline(2,e.rgb(200,200,50)),e.fixed(),e.z(b.UI_BG)]),Ze=e.add([e.text("",{size:28}),e.pos(K+I/2,ee+I/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),it=e.add([e.text("20",{size:14}),e.pos(K+I+5,ee+I/2),e.anchor("left"),e.color(255,255,150),e.fixed(),e.z(b.UI_TEXT)]);ue.hidden=!0,Ze.hidden=!0,it.hidden=!0;const zt=ct+ft+10,rt=yt,Mt=32,we=40,be=[];function ce(){if(be.forEach(W=>{W.exists()&&e.destroy(W)}),be.length=0,!f.exists())return;const E=[];f.upgradeStacks&&Object.entries(f.upgradeStacks).forEach(([W,q])=>{q>0&&E.push({key:W,stacks:q})}),E.forEach((W,q)=>{const V=zt+q*we,Y=ws[W.key];if(!Y)return;const A=e.add([e.rect(Mt,Mt),e.pos(V,rt),e.color(0,0,0),e.opacity(.7),e.outline(1,e.rgb(150,150,150)),e.fixed(),e.z(b.UI_BG)]),$=e.add([e.text(Y.icon,{size:20}),e.pos(V+Mt/2,rt+Mt/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),ge=e.add([e.text(W.stacks.toString(),{size:10}),e.pos(V+Mt-4,rt+Mt-4),e.anchor("botright"),e.color(255,255,100),e.fixed(),e.z(b.UI_TEXT+1)]);be.push(A,$,ge)})}const de=50,Ee=e.width()-de-25,st=e.height()-de-25,Qe=e.add([e.rect(de,de),e.pos(Ee,st),e.color(100,200,255),e.opacity(.9),e.outline(3,e.rgb(255,255,255)),e.area(),e.fixed(),e.z(b.OVERLAY+5)]),lt=e.add([e.text("+",{size:36}),e.pos(Ee+de/2,st+de/2),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+6)]),pt=20,co=Ee+de-pt/2,It=st-pt/2,Kt=e.add([e.circle(pt/2),e.pos(co,It),e.anchor("center"),e.color(255,50,50),e.outline(2,e.rgb(255,255,255)),e.fixed(),e.z(b.OVERLAY+7)]),lo=e.add([e.text("2",{size:12}),e.pos(co,It),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+8)]);Qe.hidden=!0,lt.hidden=!0,Kt.hidden=!0,lo.hidden=!0,Qe.onClick(()=>{_&&f.pendingLevelUps&&f.pendingLevelUps.length>0&&_.processPendingLevelUp()});let mo=0;Qe.onUpdate(()=>{if(Qe.hidden)return;mo+=e.dt()*4;const E=(Math.sin(mo)+1)/2,W=3+E*3,q=200+E*55;Qe.outline.width=W,Qe.outline.color=e.rgb(q,q,100+E*155);const V=1+E*.05;Qe.scale=e.vec2(V,V),lt.scale=e.vec2(V,V)});const to=e.add([e.rect(200,60),e.pos(0,0),e.color(0,0,0),e.opacity(.9),e.outline(2,e.rgb(200,200,200)),e.fixed(),e.z(b.OVERLAY+10)]),no=e.add([e.text("",{size:Z.SMALL,width:190}),e.pos(5,5),e.color(255,255,255),e.fixed(),e.z(b.OVERLAY+11)]);to.hidden=!0,no.hidden=!0;const os={level:()=>`Level ${f.level}
XP: ${f.xp}/${f.xpToNext}
Progress: ${Math.floor(f.xp/f.xpToNext*100)}%`,enemies:()=>(e.get("enemy").length+e.get("miniboss").length,`Enemies Remaining
Clear all to progress
Kills this run: ${Et.enemiesKilled}`),currency:()=>`Total Credits: ${jn()}
Use in shop between floors
Earn by killing enemies`,weapon:()=>{const E=f.weaponDef;return E?`${E.name}
Damage: ${f.projectileDamage}
Fire Rate: ${f.fireRate.toFixed(2)}/s
DPS: ${(f.projectileDamage*f.fireRate).toFixed(1)}`:"No weapon equipped"},health:()=>`Health: ${Math.floor(f.hp())}/${f.maxHealth}
Damage Reduction: ${Math.floor(f.damageReduction*100)}%`};function mi(E,W,q){const V=os[E];if(!V)return;const Y=V();no.text=Y,to.pos.x=Math.min(W+10,e.width()-210),to.pos.y=Math.min(q+10,e.height()-70),no.pos.x=to.pos.x+5,no.pos.y=to.pos.y+5,to.hidden=!1,no.hidden=!1}function fc(){to.hidden=!0,no.hidden=!0}function nu(){return{hidden:to.hidden,text:no.text,tooltipX:to.pos.x,tooltipY:to.pos.y,textX:no.pos.x,textY:no.pos.y}}function su(E){E&&(to.hidden=E.hidden,no.hidden=E.hidden,no.text=E.text,to.pos.x=E.tooltipX,to.pos.y=E.tooltipY,no.pos.x=E.textX,no.pos.y=E.textY)}e.gameData=e.gameData||{},e.gameData.hideTooltip=fc,e.gameData.saveTooltipState=nu,e.gameData.restoreTooltipState=su,e.gameData.minimap=j.minimap,Oy(e),e.gameData.spatialGrids=i,e.gameData.alivePlayers=[],e.gameData.additionalEnemiesFromSplits=0,e.gameData.incrementSplitEnemies=E=>{yi+=E,e.gameData.additionalEnemiesFromSplits=yi},e.gameData.minimapSavedMode=void 0,e.gameData.tooltipSavedState=void 0,a.updates.push(e.onUpdate(()=>{e.gameData.alivePlayers=e.get("player").filter(E=>!E.isDead&&E.exists()),i.enemies.clear(),e.get("enemy").forEach(E=>i.enemies.insert(E)),e.get("boss").forEach(E=>i.enemies.insert(E)),e.get("miniboss").forEach(E=>i.enemies.insert(E)),i.pickups.clear(),e.get("xpPickup").forEach(E=>i.pickups.insert(E)),e.get("currencyPickup").forEach(E=>i.pickups.insert(E)),e.get("powerupWeaponPickup").forEach(E=>i.pickups.insert(E))})),a.updates.push(e.onUpdate(()=>{Lx(e.dt())})),a.updates.push(e.onUpdate(()=>{const E=e.dt();if(Ge&&Ge.exists()){Te+=E;const W=Math.floor(Te/60),q=Math.floor(Te%60);Ge.text=`${W}:${q.toString().padStart(2,"0")}`}ut&&ut.exists()&&(Ae++,pe+=E,pe>=.5&&(re=Math.round(Ae/pe),ut.text=`${re} FPS`,re>=50?ut.color=e.rgb(100,255,100):re>=30?ut.color=e.rgb(255,255,100):ut.color=e.rgb(255,100,100),Ae=0,pe=0))})),a.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const E=e.dt();if(f.berserkerEnabled){const q=f.hp()/f.maxHealth<(f.berserkerThreshold||.3),V=1+(f.berserkerSpeedBonus||.5),Y=1+(f.berserkerDamageBonus||.5);q&&!f.berserkerActive?(f.berserkerActive=!0,f.speed=Math.floor(f.speed*V),f.projectileDamage=Math.floor(f.projectileDamage*Y)):!q&&f.berserkerActive&&(f.berserkerActive=!1,f.speed=Math.floor(f.speed/V),f.projectileDamage=Math.floor(f.projectileDamage/Y))}if(f.survivalistEnabled){const W=e.time()-(f.survivalistLastCombatTime||0),q=f.survivalistCombatCooldown||3;if(W>=q&&f.hp()<f.maxHealth){const V=f.survivalistRegenPercent||.01,Y=f.maxHealth*V*E;if(f.survivalistRegenAccum=(f.survivalistRegenAccum||0)+Y,f.survivalistRegenAccum>=1){const A=Math.floor(f.survivalistRegenAccum);f.survivalistRegenAccum-=A;const $=Math.min(f.maxHealth,f.hp()+A);f.setHP($),he()&&me()&&Mh({slotIndex:f.slotIndex,healAmount:A,newHP:$,source:"survivalist"})}}}})),a.updates.push(e.onUpdate(()=>{if(e.paused||!f.exists()||f.isDead)return;const E=e.dt();if(f.glowEffect&&Ax(e,f.glowEffect),f.trailType&&f.trailColor){f.trailTimer=(f.trailTimer||0)+E;const W=.05,q=f.pos.x-(f.lastTrailPos?.x||f.pos.x),V=f.pos.y-(f.lastTrailPos?.y||f.pos.y),Y=Math.sqrt(q*q+V*V);f.trailTimer>=W&&Y>2&&(vx(e,f.pos.x,f.pos.y,f.trailType,f.trailColor),f.trailTimer=0,f.lastTrailPos={x:f.pos.x,y:f.pos.y})}})),a.updates.push(e.onUpdate(()=>{if(e.paused||Ci())return;const E=e.mousePos();let W=!1;E.x>=20&&E.x<=180&&E.y>=20&&E.y<=35?(mi("level",E.x,E.y),W=!0):E.x>=20&&E.x<=180&&E.y>=40&&E.y<=55&&!Ne.hidden?(mi("enemies",E.x,E.y),W=!0):E.x>=e.width()-130&&E.x<=e.width()-10&&E.y>=10&&E.y<=50?(mi("currency",E.x,E.y),W=!0):E.x>=ct&&E.x<=ct+ft&&E.y>=yt&&E.y<=yt+ft&&(mi("weapon",E.x,E.y),W=!0),W||fc()}));const cn=e.add([e.text("",{size:Z.LABEL}),e.pos(e.width()/2,20),e.anchor("center"),e.color(...y.BOSS_NAME),e.fixed(),e.z(b.OVERLAY)]),ns=e.add([e.rect(300,20),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.OVERLAY)]),Jt=e.add([e.rect(296,16),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.HEALTH_LOW),e.fixed(),e.z(b.OVERLAY+1)]),Jo=e.add([e.rect(300,12),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.OVERLAY)]),ho=e.add([e.rect(296,8),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.OVERLAY+1)]),ln=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]),Ao=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,65),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]),wn=e.add([e.rect(300,12),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.BG_DARK),e.outline(2,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.OVERLAY)]),yo=e.add([e.rect(296,8),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.XP_BAR),e.fixed(),e.z(b.OVERLAY+1)]),Xo=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,85),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]);cn.hidden=!0,ns.hidden=!0,Jt.hidden=!0,Jo.hidden=!0,ho.hidden=!0,ln.hidden=!0,Ao.hidden=!0,wn.hidden=!0,yo.hidden=!0,Xo.hidden=!0,a.updates.push(e.onUpdate(()=>{e.paused||bx(e)})),a.updates.push(e.onUpdate(()=>{e.paused||he()&&ty(e.dt())})),a.updates.push(e.onUpdate(()=>{const E=f.exists()?f.hp():0,W=f.maxHealth>0?E/f.maxHealth:1;Ke.text=`${f.level||1}`;const q=f.xpToNext>0?f.xp/f.xpToNext:0;if(Tt.width=Math.max(0,(Ce-34)*q),Lt.text=al(f.xp,f.xpToNext),Pe.text=jn().toString(),W<1&&f.exists()){tt.hidden=!1,ot.hidden=!1;const A=f.pos.x,$=f.pos.y+at;tt.pos=e.vec2(A,$);const ge=Math.max(1,(qe-2)*W);ot.use(e.rect(ge,ke-2));const Le=A-qe/2+1+ge/2;ot.pos=e.vec2(Le,$),W>.6?ot.color=e.rgb(100,255,100):W>.3?ot.color=e.rgb(255,200,0):ot.color=e.rgb(255,50,50)}else tt.hidden=!0,ot.hidden=!0;if(!H&&!l){const A=e.get("enemy").length,$=Ds+yi+(Cs?1:0),ge=e.get("miniboss").length,Le=A+ge+Math.max(0,$-ss-yi-(Cs&&wa?1:0));Ne.text=`${Le}/${$}`,Ne.hidden=!1,Ue.hidden=!1}else Ne.hidden=!0,Ue.hidden=!0;if(f.exists()&&f.weaponDef){const A=f.weaponDef,$=(f.projectileDamage*f.fireRate).toFixed(1);Dt.text=A.icon||"",Dt.color=e.rgb(...A.color),ye.text=A.icon||"",ye.color=e.rgb(...A.color),$e.text=A.name,$e.color=e.rgb(...y.TEXT_PRIMARY),ae.text=`DMG: ${f.projectileDamage}`,Re.text=`RATE: ${f.fireRate.toFixed(2)}/s`,je.text=`DPS: ${$}`,e.paused&&!zx()?(e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=ve),St.hidden=!1,ye.hidden=!1,$e.hidden=!1,ae.hidden=!1,Re.hidden=!1,je.hidden=!1):(St.hidden=!ve,ye.hidden=!ve,$e.hidden=!ve,ae.hidden=!ve,Re.hidden=!ve,je.hidden=!ve)}if(f.exists()){zm(f,e.dt());const A=Hm(f);A?(ue.hidden=!1,Ze.hidden=!1,it.hidden=!1,Ze.text=A.icon,Ze.color=e.rgb(...A.color),ue.outline.color=e.rgb(...A.color),A.isAmmoBased?it.text=`${A.ammo}`:A.isTimeBased&&(it.text=`${Math.ceil(A.duration)}s`)):(ue.hidden=!0,Ze.hidden=!0,it.hidden=!0)}if(e.time()%.5<e.dt()&&ce(),f.exists()&&f.pendingLevelUps&&f.pendingLevelUps.length>0){Qe.hidden=!1,lt.hidden=!1;const A=f.pendingLevelUps.length;A>1?(Kt.hidden=!1,lo.hidden=!1,lo.text=A.toString()):(Kt.hidden=!0,lo.hidden=!0)}else Qe.hidden=!0,lt.hidden=!0,Kt.hidden=!0,lo.hidden=!0;const V=e.get("boss"),Y=V.filter(A=>A.type==="twinGuardianMelee"||A.type==="twinGuardianRanged");if(Y.length>0){const A=Y.find(ge=>ge.type==="twinGuardianMelee"),$=Y.find(ge=>ge.type==="twinGuardianRanged");if(A&&$&&(A.exists()||$.exists())){cn.hidden=!1,cn.text="THE CO-HOSTS";const ge=A.exists()?A.hp():0,Le=$.exists()?$.hp():0,xe=ge+Le,ze=(A.maxHealth||0)+($.maxHealth||0),Se=ze>0?Math.max(0,Math.min(1,xe/ze)):0;Jt.width=296*Se,Jt.pos.x=e.width()/2-296*(1-Se)/2,ln.text=`${Math.max(0,Math.floor(xe))}/${ze}`,ns.hidden=!1,Jt.hidden=!1,ln.hidden=!1;const Ye=A.exists()&&A.shieldHealth||0,Oe=$.exists()&&$.shieldHealth||0,xt=Ye+Oe,_t=(A.maxShieldHealth||0)+($.maxShieldHealth||0);if(_t>0){const Ps=Math.max(0,Math.min(1,xt/_t));yo.width=296*Ps,yo.pos.x=e.width()/2-296*(1-Ps)/2,Xo.text=`Shield: ${Math.max(0,Math.floor(xt))}/${_t}`,wn.hidden=!1,yo.hidden=!1,Xo.hidden=!1}else wn.hidden=!0,yo.hidden=!0,Xo.hidden=!0;const Yt=A.exists()&&A.armorHealth||0,vn=$.exists()&&$.armorHealth||0,vi=Yt+vn,Aa=(A.maxArmorHealth||0)+($.maxArmorHealth||0);if(Aa>0){const Ps=Math.max(0,Math.min(1,vi/Aa));ho.width=296*Ps,ho.pos.x=e.width()/2-296*(1-Ps)/2,Ao.text=`Armor: ${Math.max(0,Math.floor(vi))}/${Aa}`,Jo.hidden=!1,ho.hidden=!1,Ao.hidden=!1}else Jo.hidden=!0,ho.hidden=!0,Ao.hidden=!0;Se>.6?Jt.color=e.rgb(255,50,50):Se>.3?Jt.color=e.rgb(255,150,50):Jt.color=e.rgb(255,200,0)}else{const ge=A?.exists()?A:$;if(ge){const Le=ge.hp(),xe=ge.maxHealth,ze=ge.shieldHealth||0,Se=ge.maxShieldHealth||0,Ye=ge.armorHealth||0,Oe=ge.maxArmorHealth||0;cn.hidden=!1,cn.text=ge.enraged?"THE CO-HOSTS (ENRAGED)":"THE CO-HOSTS";const xt=Math.max(0,Math.min(1,Le/xe));if(Jt.width=296*xt,Jt.pos.x=e.width()/2-296*(1-xt)/2,ln.text=`${Math.max(0,Math.floor(Le))}/${xe}`,ns.hidden=!1,Jt.hidden=!1,ln.hidden=!1,Se>0){const _t=Math.max(0,Math.min(1,ze/Se));yo.width=296*_t,yo.pos.x=e.width()/2-296*(1-_t)/2,Xo.text=`Shield: ${Math.max(0,Math.floor(ze))}/${Se}`,wn.hidden=!1,yo.hidden=!1,Xo.hidden=!1}else wn.hidden=!0,yo.hidden=!0,Xo.hidden=!0;if(Oe>0){const _t=Math.max(0,Math.min(1,Ye/Oe));ho.width=296*_t,ho.pos.x=e.width()/2-296*(1-_t)/2,Ao.text=`Armor: ${Math.max(0,Math.floor(Ye))}/${Oe}`,Jo.hidden=!1,ho.hidden=!1,Ao.hidden=!1}else Jo.hidden=!0,ho.hidden=!0,Ao.hidden=!0;xt>.6?Jt.color=e.rgb(255,50,50):xt>.3?Jt.color=e.rgb(255,150,50):Jt.color=e.rgb(255,200,0)}else cn.hidden=!0,ns.hidden=!0,Jt.hidden=!0,Jo.hidden=!0,ho.hidden=!0,ln.hidden=!0,Ao.hidden=!0}}else if(V.length>0&&V[0].exists()){const A=V[0],$=A.hp(),ge=A.maxHealth,Le=A.shieldHealth||0,xe=A.maxShieldHealth||0,ze=A.armorHealth||0,Se=A.maxArmorHealth||0;let Ye="BOSS";A.type==="twinGuardianMelee"||A.type==="twinGuardianRanged"?Ye="THE CO-HOSTS":on[A.type]?.name&&(Ye=`THE ${on[A.type].name.toUpperCase()}`),cn.hidden=!1,ns.hidden=!1,Jt.hidden=!1,Jo.hidden=!1,ho.hidden=!1,ln.hidden=!1,Ao.hidden=!1,cn.text=Ye;const Oe=Math.max(0,Math.min(1,$/ge));if(Jt.width=296*Oe,Jt.pos.x=e.width()/2-296*(1-Oe)/2,ln.text=`${Math.max(0,Math.floor($))}/${ge}`,xe>0){const xt=Math.max(0,Math.min(1,Le/xe));yo.width=296*xt,yo.pos.x=e.width()/2-296*(1-xt)/2,Xo.text=`Shield: ${Math.max(0,Math.floor(Le))}/${xe}`,wn.hidden=!1,yo.hidden=!1,Xo.hidden=!1}else wn.hidden=!0,yo.hidden=!0,Xo.hidden=!0;if(Se>0){const xt=Math.max(0,Math.min(1,ze/Se));ho.width=296*xt,ho.pos.x=e.width()/2-296*(1-xt)/2,Ao.text=`Armor: ${Math.max(0,Math.floor(ze))}/${Se}`,Jo.hidden=!1,ho.hidden=!1,Ao.hidden=!1}else Jo.hidden=!0,ho.hidden=!0,Ao.hidden=!0;Oe>.6?Jt.color=e.rgb(255,50,50):Oe>.3?Jt.color=e.rgb(255,150,50):Jt.color=e.rgb(255,200,0)}else cn.hidden=!0,ns.hidden=!0,Jt.hidden=!0,Jo.hidden=!0,ho.hidden=!0,ln.hidden=!0,Ao.hidden=!0,wn.hidden=!0,yo.hidden=!0,Xo.hidden=!0})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const E=o.getPlayer(L);E&&(E.x=f.pos.x,E.y=f.pos.y,E.velocityX=0,E.velocityY=0,E.health=f.hp(),E.maxHealth=f.maxHealth,E.level=f.level,E.xp=f.xp,E.xpToNext=f.xpToNext,E.projectileDamage=f.projectileDamage,E.fireRate=f.fireRate,E.projectileSpeed=f.projectileSpeed,E.projectileCount=f.projectileCount||1,E.piercing=f.piercing||0,E.critChance=f.critChance||.05,E.critDamage=f.critDamage||2,E.pickupRadius=f.pickupRadius,E.defense=f.defense||0,E.isDead=f.isDead||!f.exists()||f.hp()<=0,E.invulnerable=f.invulnerable||!1,o.updateTime(e.dt()))})),o.currentFloor=n,o.currentRoom=s,o.roomCleared=!1,a.updates.push(e.onUpdate(()=>{if(e.paused)return;Hl.getManager().getInputsForFrame([L]).get(L)}));let Ds=H?0:24+(n-1)*6,ss=0,iu=2,pc=!1,wa=!1,Cs=!1,au=4,ba=0,yi=0;const gc=u()||new mn(Date.now());if(!H&&s!==1){const E=.15+(n-1)*.05;Cs=gc.next()<E}Cs&&(Ds=Math.floor(Ds*.5));function ru(E,W){const q=["brute","sentinel","berserker","guardian","warlock"];if(E>=3)return q[W.range(0,q.length)];{const V=["brute","berserker","guardian"];return V[W.range(0,V.length)]}}function cu(E){return{1:"gatekeeper",2:"swarmQueen",3:"twinGuardian"}[E]||"gatekeeper"}const lu=[{x:e.width()/2,y:M,direction:"north",gridDir:"up"},{x:e.width()/2,y:e.height()-M,direction:"south",gridDir:"down"},{x:M,y:e.height()/2,direction:"west",gridDir:null},{x:e.width()-M,y:e.height()/2,direction:"east",gridDir:"right"}],du=j.floorMap?j.floorMap.getAvailableExits():[],hu=new Set(du.map(E=>E.direction));lu.forEach(E=>{const W=Vy(e,E.x,E.y,E.direction);W.open=!1,W.isSpawnDoor=!0,W.gridDirection=E.gridDir,(E.gridDir===null||!hu.has(E.gridDir))&&(W.blocked=!0),W.updateVisual(),c.push(W)}),h>1&&me()&&e.wait(.1,()=>{const E={};c.forEach(W=>{E[W.direction]=W.blocked}),Ve("door_states",E)});let xi=0;const uu=.33;let mc=!1;a.updates.push(e.onUpdate(()=>{if(e.paused||l)return;if(mc||(ba=e.time(),mc=!0),H){if(!pc&&(!he()||me())){pc=!0;const Y=cu(n),A=u();if(Y==="twinGuardian"){const $=c.filter(Se=>Se.direction!==j.entryDirection);let ge,Le;if($.length>=2){const Se=[...$];for(let Oe=Se.length-1;Oe>0;Oe--){const xt=A?A.range(0,Oe+1):Math.floor(Math.random()*(Oe+1));[Se[Oe],Se[xt]]=[Se[xt],Se[Oe]]}ge=Se[0];const Ye={north:"south",south:"north",east:"west",west:"east"};Le=$.find(Oe=>Oe.direction===Ye[ge.direction])||Se[1]}else ge=c[0],Le=c[c.length>1?1:0];const xe=Bm(e,ge,Le,n,A);he()&&me()&&(Array.isArray(xe)?xe.forEach(Se=>{Yo(Se,{type:"twinGuardian",floor:n})}):xe&&Yo(xe,{type:"twinGuardian",floor:n})),El();const ze=e.add([e.text("THE CO-HOSTS",{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{ze.exists()&&e.destroy(ze)})}else{let $=c.find(Ye=>Ye.direction==="north");if(!$||j.entryDirection==="north"&&c.length>1){const Ye=c.filter(Oe=>Oe.direction!==j.entryDirection);if(Ye.length>0){const Oe=A?A.range(0,Ye.length):Math.floor(Math.random()*Ye.length);$=Ye[Oe]}else{const Oe=A?A.range(0,c.length):Math.floor(Math.random()*c.length);$=c[Oe]}}const ge=$?$.pos.x:e.width()/2,Le=$?$.pos.y:e.height()/2,xe=ea(e,ge,Le,Y,n,A);he()&&me()&&Yo(xe,{type:Y,floor:n,isBoss:!0}),El();let ze="BOSS";Y==="twinGuardian"?ze="THE CO-HOSTS":on[Y]?.name&&(ze=`THE ${on[Y].name.toUpperCase()}`);const Se=e.add([e.text(ze,{size:32}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,100,100),e.fixed()]);e.wait(2,()=>{Se.exists()&&e.destroy(Se)})}}if(!he()||me()){const Y=e.get("boss"),A=e.get("enemy").filter($=>$.isBossMinion);Y.length===0&&A.length===0&&!l&&(l=!0,xc())}return}if(Cs&&!wa&&(!he()||me())&&e.time()-ba>=1){wa=!0;const Y=ru(n,gc),A=u(),$=c.filter(_t=>_t.direction!==j.entryDirection),ge=$.length>0?$:c,Le=A?A.range(0,ge.length):Math.floor(Math.random()*ge.length),xe=ge[Le],ze=xe.pos.x,Se=xe.pos.y,Ye=Ky(e,ze,Se,Y,n);he()&&me()&&Yo(Ye,{type:Y,floor:n});const Oe=Qn[Y]?.name||"MINIBOSS",xt=e.add([e.text(`MINIBOSS: ${Oe.toUpperCase()}`,{size:24}),e.pos(e.width()/2,e.height()/2-100),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1.5,()=>{xt.exists()&&e.destroy(xt)})}const E=e.get("enemy").length,W=e.get("miniboss").length;if(ss>=Ds&&E===0&&W===0&&!l&&(!he()||me())&&(l=!0,xc()),ss<Ds&&(!he()||me())){if(xi+=e.dt(),ss===0&&xi<iu)return;if(xi>=uu){xi=0,ss++;const Y=u();if(Y)for(let A=0;A<ss-1;A++)Y.next();if(c.length>0){const A=e.time()-ba,ge=j.entryDirection&&A<au?c.filter(vi=>vi.direction!==j.entryDirection):c,Le=ge.length>0?ge:c,xe=Y?Y.range(0,Le.length):Math.floor(Math.random()*Le.length),ze=Le[xe],Se=ze.pos.x,Ye=ze.pos.y,Oe=15,xt=Se+(Y?Y.next()-.5:Math.random()-.5)*Oe,_t=Ye+(Y?Y.next()-.5:Math.random()-.5)*Oe,Yt=Er(n,Y),vn=In(e,xt,_t,Yt,n,Y);Bl(e,vn,n,Y),he()&&me()&&Yo(vn,{type:Yt,floor:n,isElite:vn.isElite,eliteModifier:vn.eliteModifier})}else{const A=Y?Y.range(0,4):Math.floor(e.rand(0,4));let $,ge;switch(A){case 0:$=Y?Y.rangeFloat(G,e.width()-G):e.rand(G,e.width()-G),ge=G;break;case 1:$=e.width()-G,ge=Y?Y.rangeFloat(G,e.height()-G):e.rand(G,e.height()-G);break;case 2:$=Y?Y.rangeFloat(G,e.width()-G):e.rand(G,e.width()-G),ge=e.height()-G;break;case 3:$=G,ge=Y?Y.rangeFloat(G,e.height()-G):e.rand(G,e.height()-G);break}const Le=Er(n,Y),xe=In(e,$,ge,Le,n,Y);Bl(e,xe,n,Y),he()&&me()&&Yo(xe,{type:Le,floor:n,isElite:xe.isElite,eliteModifier:xe.eliteModifier})}}}})),a.updates.push(e.onUpdate(()=>{e.paused||(e.get("enemy").forEach(E=>{if(E.hp()<=0&&!E.isDead){E.isDead=!0;const W=E.xpValue,q=E.pos.x,V=E.pos.y;if(E.cleanupHealthBars&&E.cleanupHealthBars(),E.explodes&&E.explosionRadius){const $=E.explosionRadius,ge=E.explosionDamage||15;f.exists()&&Math.sqrt(Math.pow(f.pos.x-q,2)+Math.pow(f.pos.y-V,2))<=$&&f.takeDamage(ge),i.enemies.getNearby(q,V,$).forEach(xe=>{if(xe===E||!xe.exists())return;const ze=xe.pos.x-q,Se=xe.pos.y-V;ze*ze+Se*Se<=$*$&&xe.hurt(ge)}),Vs(e,q,V,{color:[255,150,50]})}else{const $=j.equippedCosmetics?.death,ge=E.originalColor||[255,100,100];$&&$!=="deathNone"?Sx(e,q,V,$,ge):Vs(e,q,V,{color:ge})}if(E.shrapnel&&E.shrapnelCount){const $=E.shrapnelCount,ge=Math.PI*2/$,Le=250,xe=Math.floor((E.explosionDamage||15)*.6);for(let ze=0;ze<$;ze++){const Se=ge*ze,Ye=e.vec2(Math.cos(Se),Math.sin(Se)),Oe=Ro(e,q,V,Ye,Le,xe,0,0,!1);Oe.isEnemyProjectile=!0,Oe.color=e.rgb(...E.originalColor)}}E.cleanupHealthBars&&typeof E.cleanupHealthBars=="function"&&E.cleanupHealthBars(),he()&&E.mpEntityId&&(me()?oc({entityId:E.mpEntityId,entityType:"enemy",x:q,y:V}):Ay({entityId:E.mpEntityId,entityType:"enemy",x:q,y:V})),e.destroy(E),bl(),Et.enemiesKilled++;const Y=E.type||E.enemyType||"basic";Et.killsByType[Y]=(Et.killsByType[Y]||0)+1;const A=E.lastHitBySlot;if(A!==void 0&&x[A]&&x[A].runStats?x[A].runStats.kills++:f.runStats&&f.runStats.kills++,!he()||me()){const $=u();Gs(e,q,V,W);const ge=$?$.range(1,4):Math.floor(Math.random()*3)+1,Le=1;for(let ze=0;ze<ge;ze++){const Se=$?($.next()-.5)*20:(Math.random()-.5)*20,Ye=$?($.next()-.5)*20:(Math.random()-.5)*20,Oe=Ni();Ks(e,q+Se,V+Ye,Le,Oe)}const xe=Lm(E.type,n);if(xe){const ze=$?($.next()-.5)*30:(Math.random()-.5)*30,Se=$?($.next()-.5)*30:(Math.random()-.5)*30;il(e,q+ze,V+Se,xe)}}}}),e.get("miniboss").forEach(E=>{if(E.hp()<=0&&!E.isDead){E.isDead=!0;const W=E.xpValue,q=E.pos.x,V=E.pos.y;Vs(e,q,V,{color:[255,150,100],isMiniboss:!0}),e.destroy(E),bl(),Et.enemiesKilled++;const Y=E.type||"miniboss";Et.killsByType[Y]=(Et.killsByType[Y]||0)+1;const A=E.lastHitBySlot;if(A!==void 0&&x[A]&&x[A].runStats?x[A].runStats.kills++:f.runStats&&f.runStats.kills++,!he()||me()){const ge=u();Gs(e,q,V,W);const Le=ge?ge.range(10,16):Math.floor(Math.random()*6)+10,xe=1;for(let ze=0;ze<Le;ze++){const Se=Math.PI*2/Le*ze,Ye=ge?30+ge.next()*20:30+Math.random()*20,Oe=Math.cos(Se)*Ye,xt=Math.sin(Se)*Ye;Ks(e,q+Oe,V+xt,xe)}}const $=e.add([e.text("MINIBOSS DEFEATED!",{size:20}),e.pos(q,V-30),e.anchor("center"),e.color(255,200,100),e.fixed()]);e.wait(1,()=>{$.exists()&&e.destroy($)})}}),e.get("boss").forEach(E=>{if(E.hp()<=0&&!E.isDead){E.isDead=!0;const W=E.xpValue,q=E.pos.x,V=E.pos.y;Vs(e,q,V,{color:[255,200,100],isBoss:!0}),e.destroy(E),ux(),Et.enemiesKilled++,Et.bossesKilled++;const Y=E.type||"boss";Et.killsByType[Y]=(Et.killsByType[Y]||0)+1;const A=E.lastHitBySlot;if(A!==void 0&&x[A]&&x[A].runStats?(x[A].runStats.kills++,x[A].runStats.bossesKilled++):f.runStats&&(f.runStats.kills++,f.runStats.bossesKilled++),!he()||me()){const ge=u();Gs(e,q,V,W);const Le=ge?ge.range(20,31):Math.floor(Math.random()*11)+20,xe=1,ze=Ni();for(let Se=0;Se<Le;Se++){const Ye=Math.PI*2/Le*Se,Oe=ge?40+ge.next()*30:40+Math.random()*30,xt=Math.cos(Ye)*Oe,_t=Math.sin(Ye)*Oe;Ks(e,q+xt,V+_t,xe,ze)}}const $=e.add([e.text("BOSS DEFEATED!",{size:24}),e.pos(q,V-30),e.anchor("center"),e.color(255,255,100),e.fixed()]);e.wait(1.5,()=>{$.exists()&&e.destroy($)})}}))})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const E=bo("gameplay","autoPickupXP"),W=E?2e3:f.pickupRadius,q=W*1.5,V=new Set;h===1?i.pickups.getNearby(f.pos.x,f.pos.y,q).forEach(Y=>{Y.is&&Y.is("xpPickup")&&V.add(Y)}):x.forEach(Y=>{!Y||!Y.exists()||Y.isDead||i.pickups.getNearby(Y.pos.x,Y.pos.y,q).forEach(A=>{A.is&&A.is("xpPickup")&&V.add(A)})}),V.forEach(Y=>{if(Y.collected)return;let A=f,$=e.vec2(f.pos.x-Y.pos.x,f.pos.y-Y.pos.y).len();h>1&&x.forEach(Le=>{if(!Le||!Le.exists()||Le.isDead)return;const xe=e.vec2(Le.pos.x-Y.pos.x,Le.pos.y-Y.pos.y).len();xe<$&&($=xe,A=Le)});const ge=E?W:A.pickupRadius;if(!Y.magnetizing&&$<=ge&&(Y.magnetizing=!0,Y.targetPlayer=A),$<=Gt.COLLECTION_RADIUS&&!Y.collected){if(he()&&!me())return;Y.collected=!0,lx(),h>1?me()&&(f.exists()&&!f.isDead&&f.addXP&&f.addXP(Y.value),Ty(Y.value)):f.addXP(Y.value),Y.isFlyingToUI=!0}})})),a.updates.push(e.onUpdate(()=>{if(!f.exists()||e.paused)return;const E=bo("gameplay","autoPickupCurrency"),W=E?2e3:f.pickupRadius,q=W*1.5,V=new Set;h===1?i.pickups.getNearby(f.pos.x,f.pos.y,q).forEach(A=>{A.is&&A.is("currencyPickup")&&V.add(A)}):x.forEach(A=>{!A||!A.exists()||A.isDead||i.pickups.getNearby(A.pos.x,A.pos.y,q).forEach($=>{$.is&&$.is("currencyPickup")&&V.add($)})}),V.forEach(A=>{if(A.collected)return;let $=f,ge=e.vec2(f.pos.x-A.pos.x,f.pos.y-A.pos.y).len();h>1&&x.forEach(xe=>{if(!xe||!xe.exists()||xe.isDead)return;const ze=e.vec2(xe.pos.x-A.pos.x,xe.pos.y-A.pos.y).len();ze<ge&&(ge=ze,$=xe)});const Le=E?W:$.pickupRadius;if(!A.magnetizing&&ge<=Le&&(A.magnetizing=!0,A.targetPlayer=$),ge<=Gt.COLLECTION_RADIUS&&!A.collected){if(he()&&!me())return;A.collected=!0,vl(),ps(A.value),$&&$.runStats&&($.runStats.creditsPickedUp+=A.value),he()&&Dy(A.value),A.isFlyingToUI=!0}}),i.pickups.getNearby(f.pos.x,f.pos.y,f.pickupRadius*1.5).forEach(A=>{if(!A.is||!A.is("powerupWeaponPickup")||A.collected)return;const $=e.vec2(f.pos.x-A.pos.x,f.pos.y-A.pos.y).len();if(!A.magnetizing&&$<=f.pickupRadius&&(A.magnetizing=!0,A.targetPlayer=f),$<=Gt.COLLECTION_RADIUS&&!A.collected){if(he()&&!me())return;A.collected=!0,vl(),he()&&me()?(e.get("player").forEach(Se=>{Ia(Se,A.powerupKey)}),hy(A.powerupKey)):Ia(f,A.powerupKey);const ge=zn[A.powerupKey],Le=e.add([e.text(ge.icon,{size:32}),e.pos(f.pos.x,f.pos.y-30),e.color(...ge.color),e.anchor("center"),e.z(b.UI_TEXT+1),e.opacity(1)]);let xe=0;Le.onUpdate(()=>{xe+=e.dt(),Le.pos.y-=50*e.dt(),Le.opacity=Math.max(0,1-xe/.8),xe>=.8&&e.destroy(Le)}),e.destroy(A)}})}));let gt=null,Rt=null,bn=0,Fo=null,Rs=!1;const yc=.5,fu=10;he()&&!me()&&(_e("door_progress",E=>{if(E.clear){Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt),Rt=null,gt=null;return}(!Rt||!Rt.exists())&&(Rt=e.add([e.circle(20),e.pos(E.doorX,E.doorY),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),gt=e.add([e.circle(18),e.pos(E.doorX,E.doorY),e.anchor("center"),e.color(E.isForced?255:100,E.isForced?200:255,E.isForced?0:100),e.opacity(0),e.z(201),"doorProgress"])),gt&&gt.exists()&&(gt.opacity=E.progress,gt.scale=e.vec2(E.progress,E.progress),gt.color=e.rgb(E.isForced?255:100,E.isForced?200:255,E.isForced?0:100))}),_e("barrel_damage",E=>{const W=xl(E.x,E.y);W&&W.exists()&&!W.isExploding&&(W.currentHealth=E.currentHealth,W.updateHealthBar())}),_e("barrel_explode",E=>{const W=xl(E.x,E.y);W&&W.exists()&&!W.isExploding&&W.explode()})),a.updates.push(e.onUpdate(()=>{!f.exists()||e.paused||r||Ci()||he()&&!me()||(e.get("door").forEach(E=>{if(!(!E.open||r||E.isSpawnDoor||E.blocked))if(h>1){let W=!1,q=!0;x.forEach(($,ge)=>{if(!$||!$.exists()||$.isDead||$.hp()<=0)return;const xe=e.vec2($.pos.x-E.pos.x,$.pos.y-E.pos.y).len()<=40;ge===0&&(W=xe),xe||(q=!1)});const V=q||W,Y=W&&!q,A=Y?fu:yc;if(V){(Fo!==E||Rs!==Y)&&(bn=0,Fo=E,Rs=Y,Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt),Rt=e.add([e.circle(20),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),gt=e.add([e.circle(18),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(Y?255:100,Y?200:255,Y?0:100),e.opacity(0),e.z(201),"doorProgress"])),bn+=e.dt();const $=Math.min(bn/A,1);gt&&gt.exists()&&(gt.opacity=$,gt.scale=e.vec2($,$)),he()&&Ve("door_progress",{doorX:E.pos.x,doorY:E.pos.y,progress:$,isForced:Y}),$>=1&&(r=!0,Ha(),Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt),Fo=null,he()&&Ve("door_progress",{progress:0,clear:!0}),wc(E.direction))}else Fo===E&&(bn=0,Fo=null,Rs=!1,Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt),he()&&Ve("door_progress",{progress:0,clear:!0}))}else{if(f.isDead||f.hp()<=0)return;if(e.vec2(f.pos.x-E.pos.x,f.pos.y-E.pos.y).len()<=40){Fo!==E&&(bn=0,Fo=E,Rs=!1,Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt),Rt=e.add([e.circle(20),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(80,80,80),e.opacity(.8),e.z(200),"doorProgress"]),gt=e.add([e.circle(18),e.pos(E.pos.x,E.pos.y),e.anchor("center"),e.color(100,255,100),e.opacity(0),e.z(201),"doorProgress"])),bn+=e.dt();const V=Math.min(bn/yc,1);gt&&gt.exists()&&(gt.opacity=V,gt.scale=e.vec2(V,V)),V>=1&&(r=!0,Ha(),Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt),Fo=null,wc(E.direction))}else Fo===E&&(bn=0,Fo=null,Rs=!1,Rt&&Rt.exists()&&e.destroy(Rt),gt&&gt.exists()&&e.destroy(gt))}}),!Fo&&Rt&&Rt.exists()&&(e.destroy(Rt),e.destroy(gt)))}));function pu(){if(!f.exists())return;const E=e.width()/2,W=e.height()/2,q=5,V=3,Y=H?3:1,A=H?4:1,$=n*.5,ge=Math.floor((q+$)*Y),Le=Math.floor((V+$)*A),xe=u();for(let ze=0;ze<ge;ze++){const Se=Math.PI*2*ze/ge+(xe?xe.next():Math.random())*.3,Ye=40+(xe?xe.next():Math.random())*60,Oe=E+Math.cos(Se)*Ye,xt=W+Math.sin(Se)*Ye,_t=Math.floor(1+n*.5);Gs(e,Oe,xt,_t)}for(let ze=0;ze<Le;ze++){const Se=Math.PI*2*ze/Le+(xe?xe.next():Math.random())*.3+.5,Ye=50+(xe?xe.next():Math.random())*70,Oe=E+Math.cos(Se)*Ye,xt=W+Math.sin(Se)*Ye,_t=Math.floor(1+n*.3),Yt=Ni();Ks(e,Oe,xt,_t,Yt)}if(H){const ze=Object.keys(zn),Se=1+Math.floor((xe?xe.next():Math.random())*2);for(let Ye=0;Ye<Se;Ye++){const Oe=(xe?xe.next():Math.random())*Math.PI*2,xt=80+(xe?xe.next():Math.random())*40,_t=E+Math.cos(Oe)*xt,Yt=W+Math.sin(Oe)*xt,vn=ze[Math.floor((xe?xe.next():Math.random())*ze.length)];il(e,_t,Yt,vn)}}}function xc(){o.roomCleared=!0,o.clearRoom(),he()&&me()&&My(),h>1&&d(),Et.roomsCleared++;const E=f.exists()?f.level:1;if(Pi(e,{floor:j.currentFloor,enemiesKilled:Et.enemiesKilled,bossesKilled:Et.bossesKilled,level:E,currencyEarned:0}),j.floorMap&&X&&j.floorMap.markRoomCleared(X.position.x,X.position.y),c.forEach(V=>{V.exists()&&!V.blocked&&(V.open=!0,V.isSpawnDoor=!1,V.updateVisual())}),H){const V=c.find(Y=>Y.direction==="north");V&&V.exists()&&(V.blocked=!1,V.open=!0,V.isSpawnDoor=!1,V.isFloorExit=!0,V.updateVisual())}j.minimap&&j.minimap.update(),(!he()||me())&&pu();const W=H?`BOSS DEFEATED! Floor ${n} Complete! Enter a door to continue`:"Room Cleared! Enter a door to continue",q=e.add([e.text(W,{size:20}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(500)]);e.wait(5,()=>{q.exists()&&e.destroy(q)})}function wc(E){j.allPlayerStats=x.map((A,$)=>!A||!A.exists()?null:{slotIndex:A.slotIndex!==void 0?A.slotIndex:$,playerName:A.playerName,isRemote:A.isRemote||!1,isDead:A.isDead||!1,level:A.level,xp:A.xp,xpToNext:A.xpToNext,maxHealth:A.maxHealth,currentHP:A.hp(),speed:A.slowed?A.originalSpeed:A.speed,originalSpeed:A.originalSpeed||A.speed,slowed:!1,fireRate:A.fireRate,projectileSpeed:A.projectileSpeed,projectileDamage:A.projectileDamage,pickupRadius:A.pickupRadius,xpMultiplier:A.xpMultiplier||1,characterKey:A.characterKey,dodgeChance:A.dodgeChance||0,damageReduction:A.damageReduction||0,fireDotMultiplier:A.fireDotMultiplier||1,invulnerableDuration:A.invulnerableDuration||1,projectileCount:A.projectileCount||1,piercing:A.piercing||0,obstaclePiercing:A.obstaclePiercing||0,critChance:A.critChance||0,critDamage:A.critDamage||2,spreadAngle:A.spreadAngle||0,defense:A.defense||0,weaponRange:A.weaponRange||600,weapons:A.weapons||[],passiveUpgrades:A.passiveUpgrades||[],upgradeStacks:A.upgradeStacks||{},selectedUpgrades:A.selectedUpgrades?Array.from(A.selectedUpgrades):[],activeSynergies:A.activeSynergies?Array.from(A.activeSynergies):[],piercingDamageBonus:A.piercingDamageBonus||1,characterData:A.characterData,weaponDef:A.weaponDef,baseProjectileDamage:A.baseProjectileDamage,baseFireRate:A.baseFireRate,baseProjectileSpeed:A.baseProjectileSpeed,pendingLevelUps:A.pendingLevelUps||[],powerupWeapon:A.powerupWeapon||null,powerupAmmo:A.powerupAmmo!==void 0?A.powerupAmmo:null,powerupDuration:A.powerupDuration!==void 0?A.powerupDuration:null,originalWeapon:A.originalWeapon||null,weaponKey:A.weaponKey,weaponCategory:A.weaponCategory,orbitRadius:A.orbitRadius,rotationSpeed:A.rotationSpeed,explosionRadius:A.explosionRadius,explosionDamage:A.explosionDamage,chainRange:A.chainRange,maxJumps:A.maxJumps,chainDamageReduction:A.chainDamageReduction,thornsPercent:A.thornsPercent||0,thornsIgnoreArmor:A.thornsIgnoreArmor||!1,runStats:A.runStats||{kills:0,deaths:0,revives:0,damageTaken:0,damageDealt:0,creditsPickedUp:0,xpPickedUp:0,bossesKilled:0}}).filter(A=>A!==null);const W=j.allPlayerStats.find(A=>!A.isRemote);W&&(j.playerStats=W);const q={north:"south",south:"north",west:"east",east:"west"};j.entryDirection=q[E]||null;const Y={north:"up",south:"down",east:"right"}[E];if(j.floorMap)if(X&&X.isBossRoom&&X.cleared){if(n++,Gc(n-1)){const ge=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{ge.exists()&&e.destroy(ge)})}j.floorMap=null,j.entryDirection=null,s=1,o.nextFloor()}else Y?j.floorMap.moveToRoom(Y)?s=j.floorMap.getVisitedCount():(console.error("[Game] Failed to move in floor map - should not happen!"),s++):(console.warn("[Game] Invalid door direction:",E),s++),o.nextRoom();else if(s++,s>3){if(n++,Gc(n-1)){const $=e.add([e.text("NEW CHARACTER UNLOCKED!",{size:24}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(100,255,100),e.z(300)]);e.wait(3,()=>{$.exists()&&e.destroy($)})}s=1,j.entryDirection=null,o.nextFloor()}else o.nextRoom();if(j.currentFloor=n,j.currentRoom=s,he()&&me()){const A=Ti(),$=Ws(n,A);j.roomTemplateKey=$.key,console.log("[Multiplayer] Host selected next room template:",$.key),Ry(j.entryDirection,j.allPlayerStats,Y,n,j.roomTemplateKey)}e.go("game")}f.onDeath(()=>{if(f.orbitalOrbs&&(f.orbitalOrbs.forEach(Y=>{Y.exists()&&e.destroy(Y)}),f.orbitalOrbs=[]),f.glowEffect&&f.glowEffect.exists()&&(e.destroy(f.glowEffect),f.glowEffect=null),h>1&&(he()&&f.slotIndex!==void 0&&Iy(f.slotIndex),f.isDead=!0,f.canMove=!1,f.canShoot=!1,f.opacity=.5,f.outline&&f.outline.exists()&&(f.outline.opacity=.5),!me()||x.some(A=>A&&A.exists()&&A.hp()>0&&!A.isDead)))return;const E=Ca(Et),W={...Et,level:f.level,currencyEarned:E};Da(W),ps(E);const q=Et.startTime?Math.floor((Date.now()-Et.startTime)/1e3):0;Wg({character:f.characterData?.key||"survivor",weapon:f.weaponKey||"pistol",floorsReached:Et.floorsReached,roomsCleared:Et.roomsCleared,enemiesKilled:Et.enemiesKilled,bossesKilled:Et.bossesKilled,level:f.level||1,currencyEarned:E,duration:q,deathCause:"Enemy",upgrades:f.selectedUpgrades?Array.from(f.selectedUpgrades):[],synergies:f.activeSynergies?Array.from(f.activeSynergies):[]}),Pi(e);const V=x.filter(Y=>Y&&Y.exists()).map(Y=>({name:Y.playerName||"Player",level:Y.level||1,characterData:Y.characterData,kills:Y.runStats?.kills||0,deaths:Y.runStats?.deaths||0,revives:Y.runStats?.revives||0,damageTaken:Y.runStats?.damageTaken||0,damageDealt:Y.runStats?.damageDealt||0,xpCollected:Y.runStats?.xpPickedUp||0,creditsPickedUp:Y.runStats?.creditsPickedUp||0,bossesKilled:Y.runStats?.bossesKilled||0}));he()&&me()&&hl(Et,E,V),he()&&hs(),e.go("gameOver",{runStats:{...Et},currencyEarned:E,partyStats:V,isDailyRun:j.isDailyRun,dailyCharacter:j.dailyCharacter})});const va=e.add([e.rect(300,260),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_DARK),e.opacity(.95),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(2e3),"pauseOverlay"]),Ea=e.add([e.text("PAUSED",{size:Z.H1*2}),e.pos(e.width()/2,e.height()/2-95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2001),"pauseText"]),wi=e.height()/2,{LG:bc,SM:vc}=Hn.BUTTON,Ec=e.add([e.rect(bc.width,bc.height),e.pos(e.width()/2,wi-20),e.anchor("center"),e.color(...y.SUCCESS),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("RESUME",{size:Z.H2}),e.pos(e.width()/2,wi-20),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]);const Ac=e.add([e.rect(vc.width,vc.height),e.pos(e.width()/2,wi+45),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(2001),"pauseButton"]);e.add([e.text("QUIT",{size:Z.SMALL}),e.pos(e.width()/2,wi+45),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(2002),"pauseButton"]),va.hidden=!0,Ea.hidden=!0,e.get("pauseButton").forEach(E=>E.hidden=!0);const bi=E=>{E?(px(),e.gameData&&e.gameData.saveTooltipState&&e.gameData.hideTooltip&&(e.gameData.tooltipSavedState=e.gameData.saveTooltipState(),e.gameData.hideTooltip()),e.gameData&&e.gameData.minimap&&(e.gameData.minimapSavedMode=e.gameData.minimap.mode,e.gameData.minimap.mode!=="maximized"&&(e.gameData.minimap.mode="maximized",e.gameData.minimap.update())),e.gameData.weaponDetailSavedState===void 0&&(e.gameData.weaponDetailSavedState=ve)):(Al(),e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(ve=e.gameData.weaponDetailSavedState,St.hidden=!ve,ye.hidden=!ve,$e.hidden=!ve,ae.hidden=!ve,Re.hidden=!ve,je.hidden=!ve,e.gameData.weaponDetailSavedState=void 0)),va.hidden=!E,Ea.hidden=!E,e.get("pauseButton").forEach(W=>W.hidden=!E)};e.gameData.updatePauseUI=bi,Ec.onClick(()=>{!e.paused||Ec.hidden||(e.paused=!1,e.gameData&&e.gameData.minimap&&e.gameData.minimapSavedMode!==void 0&&(e.gameData.minimap.mode=e.gameData.minimapSavedMode,e.gameData.minimap.update(),e.gameData.minimapSavedMode=void 0),e.gameData&&e.gameData.restoreTooltipState&&e.gameData.tooltipSavedState&&(e.gameData.restoreTooltipState(e.gameData.tooltipSavedState),e.gameData.tooltipSavedState=void 0),e.gameData&&e.gameData.weaponDetailSavedState!==void 0&&(ve=e.gameData.weaponDetailSavedState,St.hidden=!ve,ye.hidden=!ve,$e.hidden=!ve,ae.hidden=!ve,Re.hidden=!ve,je.hidden=!ve,e.gameData.weaponDetailSavedState=void 0),Al(),va.hidden=!0,Ea.hidden=!0,e.get("pauseButton").forEach(E=>E.hidden=!0))}),Ac.onClick(()=>{if(!(!e.paused||Ac.hidden))if(he())if(me())dy(),hs(),j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu");else{e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Leave party and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const E=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(50,150,50),e.outline(2,e.rgb(100,200,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const W=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]),E.onClick(()=>{e.get("confirmDialog").forEach(q=>e.destroy(q)),hs(),j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu")}),W.onClick(()=>{e.get("confirmDialog").forEach(q=>e.destroy(q))})}else if(bo("gameplay","confirmBeforeQuit")!==!1){e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.8),e.fixed(),e.z(3e3),"confirmDialog"]),e.add([e.text("Abandon run and return to menu?",{size:20}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3001),"confirmDialog"]);const W=e.add([e.rect(100,40),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(150,50,50),e.outline(2,e.rgb(200,100,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("Yes",{size:16}),e.pos(e.width()/2-60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]);const q=e.add([e.rect(100,40),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(50,100,50),e.outline(2,e.rgb(100,150,100)),e.area(),e.fixed(),e.z(3001),"confirmDialog"]);e.add([e.text("No",{size:16}),e.pos(e.width()/2+60,e.height()/2+10),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(3002),"confirmDialog"]),W.onClick(()=>{e.get("confirmDialog").forEach(V=>e.destroy(V)),j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu")}),q.onClick(()=>{e.get("confirmDialog").forEach(V=>e.destroy(V))})}else j.currentFloor=1,j.currentRoom=1,j.playerStats=null,e.go("menu")}),a.keyPresses.push(e.onKeyPress("m",()=>{j.minimap&&!e.paused&&j.minimap.toggle()})),a.keyPresses.push(e.onKeyPress("escape",()=>{Ci()||(he()?me()?(e.paused=!e.paused,vy(e.paused),bi(e.paused)):Ey(!e.paused):(e.paused=!e.paused,bi(e.paused)))}));const Sc=()=>{he()||e.paused||Ci()||(e.paused=!0,bi(!0))};window.addEventListener("blur",Sc),e.onSceneLeave(()=>{window.removeEventListener("blur",Sc)}),e.onSceneLeave(()=>{if(a.updates.forEach(E=>{try{E&&E.cancel&&E.cancel()}catch(W){console.warn("[Game] Error canceling update handler:",W)}}),a.keyPresses.forEach(E=>{try{E&&E.cancel&&E.cancel()}catch(W){console.warn("[Game] Error canceling keypress handler:",W)}}),!me()&&he()){try{Pt("room_transition"),Pt("room_completed"),Pt("game_over")}catch(E){console.warn("[Game] Error unregistering message handlers:",E)}Bi=!1}j.minimap&&(j.minimap.destroy(),j.minimap=null),Hy()})})}const Ut={LEVEL:"level",CHARACTER:"character",ACHIEVEMENT:"achievement"},kn={default:{id:"default",name:"Rookie",icon:"",color:[200,200,200],category:Ut.LEVEL,unlockCondition:{type:"default"},description:"Everyone starts somewhere."},veteran:{id:"veteran",name:"Veteran",icon:"",color:[100,200,255],category:Ut.LEVEL,unlockCondition:{type:"level",value:10},description:"A seasoned competitor with many battles under their belt."},elite:{id:"elite",name:"Elite",icon:"",color:[255,200,100],category:Ut.LEVEL,unlockCondition:{type:"level",value:25},description:"Among the top performers in the arena."},legend:{id:"legend",name:"Legend",icon:"",color:[255,100,255],category:Ut.LEVEL,unlockCondition:{type:"level",value:50},description:"A living legend whose name echoes through the halls."},champion:{id:"champion",name:"Champion",icon:"",color:[255,215,0],category:Ut.LEVEL,unlockCondition:{type:"level",value:75},description:"A true champion who has conquered all challenges."},immortal:{id:"immortal",name:"Immortal",icon:"",color:[200,255,255],category:Ut.LEVEL,unlockCondition:{type:"level",value:100},description:"Transcended mortality. A god among players."},survivor:{id:"survivor",name:"Survivor",icon:"",color:[100,200,100],category:Ut.CHARACTER,unlockCondition:{type:"character",value:"survivor"},description:"The default hero. Never gives up."},berserker:{id:"berserker",name:"Berserker",icon:"",color:[255,100,100],category:Ut.CHARACTER,unlockCondition:{type:"character",value:"berserker"},description:"Rage incarnate. Pain is just fuel."},ranger:{id:"ranger",name:"Ranger",icon:"",color:[100,255,150],category:Ut.CHARACTER,unlockCondition:{type:"character",value:"ranger"},description:"Swift and precise. Death from a distance."},mage:{id:"mage",name:"Mage",icon:"",color:[200,100,255],category:Ut.CHARACTER,unlockCondition:{type:"character",value:"mage"},description:"Master of the arcane arts."},tank:{id:"tank",name:"Tank",icon:"",color:[150,150,200],category:Ut.CHARACTER,unlockCondition:{type:"character",value:"tank"},description:"An immovable wall. Nothing gets through."},assassin:{id:"assassin",name:"Assassin",icon:"",color:[150,100,150],category:Ut.CHARACTER,unlockCondition:{type:"character",value:"assassin"},description:"Silent. Deadly. Gone before you know it."},boss_slayer:{id:"boss_slayer",name:"Boss Slayer",icon:"",color:[255,180,50],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:100},description:"Has ended the reign of 100 bosses."},speedrunner:{id:"speedrunner",name:"Speedrunner",icon:"",color:[255,255,100],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"fastestRunTime",value:600,comparison:"lessThan"},description:"Completed a run in under 10 minutes."},perfectionist:{id:"perfectionist",name:"Perfectionist",icon:"",color:[255,255,255],category:Ut.ACHIEVEMENT,unlockCondition:{type:"achievement",value:"flawless_run"},description:"Completed a run without taking damage."},grinder:{id:"grinder",name:"Grinder",icon:"",color:[200,150,100],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:100},description:"Has completed 100 runs. Dedication personified."},collector:{id:"collector",name:"Collector",icon:"",color:[255,215,0],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:1e4},description:"Has earned 10,000 credits total."},exterminator:{id:"exterminator",name:"Exterminator",icon:"",color:[200,50,50],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e4},description:"Has eliminated 10,000 enemies."},explorer:{id:"explorer",name:"Explorer",icon:"",color:[100,180,100],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:5},description:"Reached floor 5. The journey begins."},delver:{id:"delver",name:"Delver",icon:"",color:[180,140,100],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:10},description:"Reached floor 10. Deep into the unknown."},abyssal:{id:"abyssal",name:"Abyssal",icon:"",color:[80,50,150],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"bestFloor",value:20},description:"Reached floor 20. Touched the abyss."},slayer:{id:"slayer",name:"Slayer",icon:"",color:[200,80,80],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalBossesKilled",value:25},description:"Has slain 25 bosses."},warrior:{id:"warrior",name:"Warrior",icon:"",color:[150,150,200],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalEnemiesKilled",value:1e3},description:"Has defeated 1,000 enemies."},rich:{id:"rich",name:"Wealthy",icon:"",color:[100,200,255],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalCurrencyEarned",value:5e4},description:"Has earned 50,000 credits. Living large."},dedicated:{id:"dedicated",name:"Dedicated",icon:"",color:[150,100,200],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRuns",value:50},description:"Has completed 50 runs. Committed to the grind."},marathoner:{id:"marathoner",name:"Marathoner",icon:"",color:[100,200,150],category:Ut.ACHIEVEMENT,unlockCondition:{type:"stat",stat:"totalRoomsCleared",value:500},description:"Has cleared 500 rooms. Endurance personified."}};function Ar(e){return kn[e]||null}function E1(){return Object.values(kn)}function A1(e,t){const o=kn[e];if(!o)return!1;const n=o.unlockCondition;switch(n.type){case"default":return!0;case"level":return Math.floor(Math.sqrt((t.totalXP||0)/100))+1>=n.value;case"character":return t.unlocks?.characters?.includes(n.value)||!1;case"achievement":return t.achievements?.includes(n.value)||!1;case"stat":const a=t.stats?.[n.stat]||0;return n.comparison==="lessThan"?a>0&&a<n.value:a>=n.value;default:return!1}}function S1(e){const t=kn[e];if(!t)return"Unknown";const o=t.unlockCondition;switch(o.type){case"default":return"Unlocked by default";case"level":return`Reach Level ${o.value}`;case"character":return`Unlock the ${o.value.charAt(0).toUpperCase()+o.value.slice(1)} character`;case"achievement":return`Complete the "${o.value}" achievement`;case"stat":const s={totalBossesKilled:"bosses killed",totalRuns:"runs completed",totalCurrencyEarned:"credits earned",totalEnemiesKilled:"enemies killed",fastestRunTime:"second run"}[o.stat]||o.stat;return o.comparison==="lessThan"?`Complete a run in under ${Math.floor(o.value/60)} minutes`:`${o.value.toLocaleString()} ${s}`;default:return"Unknown condition"}}const Wh="superSmashTextyDailyRuns",M1=["survivor","scout","tank","sniper","pyro","bomber","engineer","vampire","berserker","ghost"];function Wo(){return new Date().toISOString().split("T")[0]}function $h(e=null){const t=e||Wo();return Um(t+"SuperSmashTexty")}function hc(e=null){const t=$h(e);return new mn(t).choose(M1)}function T1(){return hc(Wo())}function ya(){try{const e=localStorage.getItem(Wh);return e?JSON.parse(e):{completedDays:{},attempts:{}}}catch(e){return console.warn("[DailyRuns] Failed to parse daily run data:",e),{completedDays:{},attempts:{}}}}function D1(e){try{localStorage.setItem(Wh,JSON.stringify(e))}catch(t){console.warn("[DailyRuns] Failed to save daily run data:",t)}}function C1(){const e=ya(),t=Wo();return!!e.completedDays[t]}function R1(e){return ya().completedDays[e]||null}function P1(){return R1(Wo())}function I1(e){const t=ya(),o=Wo(),n={date:o,score:e.score||0,floor:e.floor||1,character:e.character||T1(),duration:e.duration||0,completedAt:Date.now()};return t.completedDays[o]=n,D1(t),console.log("[DailyRuns] Marked daily completed:",n),n}function B1(){const e=ya(),t=Wo();return e.attempts[t]||0}function L1(){const e=Wo(),t=$h(e),o=hc(e),n=C1(),s=P1(),a=B1();return{date:e,seed:t,character:o,completed:n,completion:s,attempts:a}}const So={LEFT_COLUMN_X:20,LEFT_COLUMN_WIDTH:200,RIGHT_COLUMN_WIDTH:200,TOP_MARGIN:20};function cs(e,t,o,n,s=rs.WIDTH,a=rs.HEIGHT,r=Z.BUTTON){const l=y.SECONDARY,c=y.SECONDARY_HOVER,d=y.TEXT_PRIMARY,i=y.BORDER,h=e.add([e.rect(s,a),e.pos(o,n),e.anchor("center"),e.color(...l),e.outline(2,e.rgb(...i)),e.area(),e.fixed(),e.scale(1),e.z(b.UI_ELEMENTS),"menuButton"]),u=ri(t),g=e.add([e.text(u,{size:r}),e.pos(o,n),e.anchor("center"),e.color(...d),e.fixed(),e.scale(1),e.z(b.UI_TEXT),"menuButtonText"]);return h.originalColor=[...l],h.hoverColor=[...c],h.borderColor=[...i],h.isHovered=!1,h.disabled=!1,h.label=g,h.labels=[g],h.onHoverUpdate(()=>{h.disabled||(h.isHovered||(h.isHovered=!0,et()),h.color=e.rgb(...h.hoverColor),h.outline.color=e.rgb(...y.BORDER_HOVER),h.scale=e.vec2(rs.HOVER_SCALE,rs.HOVER_SCALE),g.scale=e.vec2(rs.HOVER_SCALE,rs.HOVER_SCALE))}),h.onHoverEnd(()=>{h.disabled||(h.isHovered=!1,h.color=e.rgb(...h.originalColor),h.outline.color=e.rgb(...h.borderColor),h.scale=e.vec2(1,1),g.scale=e.vec2(1,1))}),h.setDisabled=p=>{h.disabled=p,p?(h.color=e.rgb(...y.BG_DISABLED),g.color=e.rgb(...y.TEXT_DISABLED)):(h.color=e.rgb(...h.originalColor),g.color=e.rgb(...d))},h}function Sr(e,t,o){t/=100,o/=100;const n=(1-Math.abs(2*o-1))*t,s=n*(1-Math.abs(e/60%2-1)),a=o-n/2;let r=0,l=0,c=0;return e>=0&&e<60?(r=n,l=s,c=0):e>=60&&e<120?(r=s,l=n,c=0):e>=120&&e<180?(r=0,l=n,c=s):e>=180&&e<240?(r=0,l=s,c=n):e>=240&&e<300?(r=s,l=0,c=n):e>=300&&e<360&&(r=n,l=0,c=s),[Math.round((r+a)*255),Math.round((l+a)*255),Math.round((c+a)*255)]}function z1(e){return Sr(e,80,15)}function O1(e){e.scene("menu",()=>{Rh();const t=xr();Ph(t.audio.masterVolume),Hh(t.audio.musicVolume),Ih(t.audio.sfxVolume),t.audio.uiSounds!==void 0&&Bh(t.audio.uiSounds),t.audio.combatSounds!==void 0&&Lh(t.audio.combatSounds);let o=!1;const n=()=>{o||(o=!0,ex(),Sl())};e.onClick(n),e.onKeyPress(n),Sl();const s=jn(),a=e.width()-So.RIGHT_COLUMN_WIDTH-So.LEFT_COLUMN_X,r=e.width()/2;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(b.BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,0),e.color(...y.BORDER),e.fixed(),e.z(b.UI_BACKGROUND)]),e.add([e.rect(e.width(),4),e.pos(0,e.height()-4),e.color(...y.BORDER),e.fixed(),e.z(b.UI_BACKGROUND)]);const l=So.LEFT_COLUMN_X,c=So.TOP_MARGIN+50,d=So.LEFT_COLUMN_WIDTH,i=75,h=e.add([e.rect(d,i),e.pos(l,c),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_BACKGROUND),"profileCard"]),u=Ar(ui())||kn.default,g=45,p=l+32,D=c+i/2;e.add([e.rect(g,g),e.pos(p,D),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...u.color||[200,200,200])),e.fixed(),e.z(b.UI_BACKGROUND+1)]),e.add([e.text(u.icon,{size:24}),e.pos(p,D),e.anchor("center"),e.color(...u.color||[200,200,200]),e.fixed(),e.z(b.UI_TEXT)]);const m=Co(),M=m.length>16?m.substring(0,16)+"..":m,B=p+g/2+10;e.add([e.text(M,{size:Z.SMALL}),e.pos(B,c+15),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);const P=hi();e.add([e.text(`Lv.${P}`,{size:Z.SMALL-2}),e.pos(B,c+32),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);const f=Kr(),O=d-75,v=8,T=B,x=c+50;e.add([e.rect(O,v),e.pos(T,x),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(b.UI_BACKGROUND+1)]);const C=Math.max(2,O*f);e.add([e.rect(C,v-2),e.pos(T+1,x),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(b.UI_ELEMENTS)]),e.add([e.text(`${Math.round(f*100)}%`,{size:9}),e.pos(T+O/2,x),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]),h.onClick(()=>{Ot(),e.go("profile")}),h.onHoverUpdate(()=>{h.color=e.rgb(...y.BG_LIGHT)}),h.onHoverEnd(()=>{h.color=e.rgb(...y.BG_MEDIUM)}),xh(e);const S=So.LEFT_COLUMN_X,z=c+i+10,L=So.LEFT_COLUMN_WIDTH,N=24,_=3,X=8,H=X+N*4+_*3+55;e.add([e.rect(L,H),e.pos(S,z),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const R=z+X,F=[];function G(){F.forEach(be=>{be.forEach(ce=>{ce.exists()&&e.destroy(ce)})}),F.length=0,vm().forEach((be,ce)=>{const de=R+ce*(N+_),Ee=[],st=!be.isEmpty&&!be.isLocal,Qe=e.add([e.rect(L-16,N),e.pos(S+8,de),e.color(be.isEmpty?y.BG_DARK:y.BG_LIGHT),e.outline(1,e.rgb(...y.TEXT_DISABLED)),e.fixed(),e.z(b.UI_BACKGROUND+1),st?e.area():null,"partySlotUI"].filter(Boolean));Ee.push(Qe),st&&(Qe.onClick(()=>{Ot(),Pm(ce,It=>{It?e.go("profile",{externalProfile:It}):console.warn("Failed to load profile for slot",ce)})}),Qe.onHoverUpdate(()=>{Qe.color=e.rgb(80,90,110)}),Qe.onHoverEnd(()=>{Qe.color=e.rgb(...y.BG_LIGHT)}));let lt=`${be.slotNumber}`;be.isEmpty||(lt=(Ar(be.selectedPortrait)||kn.default).icon);const pt=e.add([e.text(lt,{size:be.isEmpty?Z.SMALL:Z.SMALL+2}),e.pos(S+18,de+N/2),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);if(Ee.push(pt),!be.isEmpty){const It=Wt[be.selectedCharacter]||Wt.survivor,Kt=e.add([e.text(It.char,{size:Z.SMALL}),e.pos(S+38,de+N/2),e.anchor("left"),e.color(...It.color),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);Ee.push(Kt)}const co=e.add([e.text(be.playerName.substring(0,16),{size:Z.SMALL-2}),e.pos(S+(be.isEmpty?32:55),de+N/2),e.anchor("left"),e.color(be.isEmpty?y.TEXT_DISABLED:be.isLocal?y.GOLD:y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);if(Ee.push(co),!be.isEmpty){const It=be.isReady?"":"",Kt=be.isReady?y.SUCCESS:y.TEXT_DISABLED,lo=e.add([e.text(It,{size:Z.SMALL-2}),e.pos(S+L-14,de+N/2),e.anchor("center"),e.color(...Kt),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);Ee.push(lo);const mo=Cm(ce);if(mo){const to=mo==="exclamation"?"!":"",no=mo==="exclamation"?[255,255,0]:[255,100,150],os=e.add([e.text(to,{size:Z.SMALL+2}),e.pos(S+L-28,de+N/2),e.anchor("center"),e.color(...no),e.fixed(),e.z(b.UI_TEXT+1),"partySlotUI"]);Ee.push(os)}}if(be.isDisconnected){const It=e.add([e.text("",{size:Z.SMALL-2}),e.pos(S+L-28,de+N/2),e.anchor("center"),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT),"partySlotUI"]);Ee.push(It)}F.push(Ee)})}G();let Q=0;e.onUpdate(()=>{Q+=e.dt(),Q>=1&&(Q=0,G(),typeof Ht=="function"&&Ht())});const le=R+4*(N+_)+6;e.add([e.text("Code:",{size:Z.SMALL-2}),e.pos(S+8,le),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const se=Qc(),ne=e.add([e.text(se,{size:Z.SMALL-2}),e.pos(S+L-8,le),e.anchor("right"),e.color(se==="OFFLINE"?[...y.TEXT_DISABLED]:[...y.GOLD]),e.fixed(),e.z(b.UI_TEXT)]);let ie=se!=="OFFLINE";ne.onUpdate(()=>{if(!ie){const we=Qc();we&&we!=="OFFLINE"&&(ne.text=we,ne.color=e.rgb(...y.GOLD),ie=!0)}});const fe=le+22;cs(e,"JOIN PARTY",S+L/2,fe,L-20,28,Z.SMALL).onClick(()=>{Ot(),e.go("joinParty")});const Ue=fe+30;let Ne=[],Pe=null,Ge={partySize:0,isReady:!1,countdownActive:!1,countdownSeconds:0};function Te(we=!1){const be=Nn(),ce=ol(),de=Am(),Ee=ce.active?Math.ceil(ce.timeRemaining/1e3):0;if(!(!we&&Ge.partySize===be&&Ge.isReady===de&&Ge.countdownActive===ce.active&&Ge.countdownSeconds===Ee)&&(Ge={partySize:be,isReady:de,countdownActive:ce.active,countdownSeconds:Ee},Ne.forEach(st=>{st.exists()&&e.destroy(st)}),Ne=[],Pe&&Pe.exists()&&(e.destroy(Pe),Pe=null),be>=2)){const st=e.add([e.rect(L-20,24),e.pos(S+L/2,Ue),e.anchor("center"),e.color(de?100:60,de?150:80,de?100:120),e.outline(2,e.rgb(de?100:80,de?200:120,de?100:180)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS),"readyButtonUI"]);Ne.push(st);const Qe=e.add([e.text(de?" READY":"READY UP",{size:Z.SMALL-2}),e.pos(S+L/2,Ue),e.anchor("center"),e.color(de?150:100,de?255:150,de?150:200),e.fixed(),e.z(b.UI_TEXT),"readyButtonUI"]);Ne.push(Qe),st.onClick(()=>{Ot(),Em(),Te(!0),G()}),ce.active&&(Pe=e.add([e.text(`Starting in ${Ee}...`,{size:Z.SMALL-2}),e.pos(S+L/2,Ue+20),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT),"countdownUI"]))}}Te(!0);let ut=0;e.onUpdate(()=>{if(ut+=e.dt(),ut<.1)return;ut=0;const we=ol();Nn()>=2&&Te(),we.active&&we.timeRemaining<=0&&ys().isHost&&(Ot(),kc(),e.go("game",{resetState:!0}))});const pe=So.RIGHT_COLUMN_WIDTH,Ae=120,re=a,Ce=So.TOP_MARGIN+50,Fe=L1(),De=Wt[Fe.character]||Wt.survivor;e.add([e.rect(pe,Ae),e.pos(re,Ce),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]),e.add([e.text("DAILY RUN",{size:Z.SMALL}),e.pos(re+pe/2,Ce+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(De.char,{size:28}),e.pos(re+pe/2,Ce+45),e.anchor("center"),e.color(...De.color),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(De.name,{size:Z.SMALL-2}),e.pos(re+pe/2,Ce+68),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const nt=Nn()>1;if(Fe.completed)e.add([e.text("COMPLETED",{size:Z.SMALL-2}),e.pos(re+pe/2,Ce+95),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT)]);else if(nt)e.add([e.text("SOLO ONLY",{size:Z.SMALL-2}),e.pos(re+pe/2,Ce+95),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);else{const we=e.add([e.rect(pe-40,28),e.pos(re+pe/2,Ce+95),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("PLAY",{size:Z.SMALL}),e.pos(re+pe/2,Ce+95),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),we.onClick(()=>{Nn()>1||(Ot(),e.go("game",{resetState:!0,isDailyRun:!0,dailyCharacter:Fe.character,dailySeed:Fe.seed,dailyDate:Fe.date}))}),we.onHoverUpdate(()=>{we.color=e.rgb(...y.SECONDARY_HOVER)}),we.onHoverEnd(()=>{we.color=e.rgb(...y.SECONDARY)})}Zr(e,s);const Tt=Ce+Ae+15;e.add([e.rect(So.RIGHT_COLUMN_WIDTH,100),e.pos(a,Tt),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_BACKGROUND),"leaderboardsPanel"]),e.add([e.text("LEADERBOARDS",{size:Z.SMALL}),e.pos(a+So.RIGHT_COLUMN_WIDTH/2,Tt+15),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text("",{size:32}),e.pos(a+So.RIGHT_COLUMN_WIDTH/2,Tt+50),e.anchor("center"),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text("VIEW",{size:Z.SMALL-2}),e.pos(a+So.RIGHT_COLUMN_WIDTH/2,Tt+80),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const dt=e.get("leaderboardsPanel")[0];dt&&(dt.onClick(()=>{Ot(),e.go("leaderboards")}),dt.onHoverUpdate(()=>{dt.color=e.rgb(...y.BG_LIGHT)}),dt.onHoverEnd(()=>{dt.color=e.rgb(...y.BG_MEDIUM)}));const Ie=160,Be=["     ","   ","     ","      ","       ","         ","","       ","   ","","","      ","         ","","     "," ","                  ","                    ","                   ","                    "],Ke=[],qe=12,ke=Ie-Be.length*qe/2;Be.forEach((we,be)=>{const ce=e.add([e.text(we,{size:10,font:"monospace"}),e.pos(r,ke+be*qe),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.z(b.UI_TEXT),"titleLine"]);Ke.push(ce)});let at=0;e.onUpdate(()=>{at+=e.dt(),Ke.forEach((we,be)=>{const ce=(at*50+be*20)%360,de=Sr(ce,80,60);we.color=e.rgb(...de);const Ee=Math.sin(at*2+be*.3)*2;we.pos.y=ke+be*qe+Ee,Math.random()<.001&&(we.pos.x=r+(Math.random()-.5)*10,e.wait(.1,()=>{we.exists()&&(we.pos.x=r)}))})});const tt=310,ot=55,{XL:ft,LG:ct}=Hn.BUTTON,yt=cs(e,"ACTION!",r,tt,ft.width,ft.height,Z.H1);yt.onClick(()=>{if(yt.disabled)return;Ot(),Nn()>1&&kc(),e.go("game",{resetState:!0})});function Ht(){const we=ys(),ce=Nn()>1&&!we.isHost;yt.setDisabled(ce)}Ht();const Dt=cs(e,"CONTESTANTS",r,tt+ot,ct.width,ct.height,Z.H2);Dt.onClick(()=>{Ot(),e.go("characterSelect")});const Nt=xn(),bt=Wt[Nt];if(bt){const we=Go("characters",Nt)||bt.unlockedByDefault,be=r+ct.width/2+35,ce=tt+ot,de=45,Ee=e.add([e.rect(de,de),e.pos(be,ce),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_BACKGROUND)]),st=e.add([e.text(bt.char,{size:28}),e.pos(be,ce),e.anchor("center"),e.color(...we?bt.color:y.BG_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);Ee.onClick(()=>{Ot(),e.go("characterSelect")}),Ee.onHoverUpdate(()=>{Ee.color=e.rgb(...y.BG_LIGHT),st.scale=e.vec2(1.1)}),Ee.onHoverEnd(()=>{Ee.color=e.rgb(...y.BG_MEDIUM),st.scale=e.vec2(1)})}const St=cs(e,"MERCH",r,tt+ot*2,ct.width,ct.height,Z.H2);St.onClick(()=>{Ot(),e.go("shop")});const ye=cs(e,"RATINGS",r,tt+ot*3,ct.width,ct.height,Z.H2);ye.onClick(()=>{Ot(),e.go("statistics")});const $e=cs(e,"OPTIONS",r,tt+ot*4,ct.width,ct.height,Z.H2);$e.onClick(()=>{Ot(),e.go("settings")});const ae=[yt,Dt,St,ye,$e];let Re=0;e.onUpdate(()=>{Re+=e.dt(),ae.forEach((we,be)=>{if(!we.exists()||we.isHovered)return;const ce=(Re*60+be*50)%360,de=Sr(ce,70,50),Ee=z1(ce);try{we.color=e.rgb(de[0],de[1],de[2]),we.originalColor=de,we.label&&we.label.exists()&&(we.label.color=e.rgb(Ee[0],Ee[1],Ee[2]))}catch{}})});const je=e.onKeyPress("space",()=>{yt.disabled||(Ot(),e.go("game",{resetState:!0}))}),ve=e.onKeyPress("c",()=>{et(),e.go("characterSelect")}),I=e.onKeyPress("s",()=>{et(),e.go("shop")}),K=e.onKeyPress("o",()=>{et(),e.go("settings")}),ee=e.onKeyPress("t",()=>{et(),e.go("statistics")});let ue=0;const Ze=.5,it=e.onKeyPress("q",()=>{const we=e.time();we-ue<Ze||(ue=we,nl("exclamation"),G())}),zt=e.onKeyPress("e",()=>{const we=e.time();we-ue<Ze||(ue=we,nl("heart"),G())}),rt=(we,be)=>{G()};Tm(rt),e.onSceneLeave(()=>{je.cancel(),ve.cancel(),I.cancel(),K.cancel(),ee.cancel(),it.cancel(),zt.cancel(),Dm(rt)});for(let we=0;we<12;we++){const be=e.add([e.text(["*","+",""][Math.floor(Math.random()*3)],{size:12}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.2+Math.random()*.2),e.z(b.PARTICLES)]);be.speed=15+Math.random()*25,be.onUpdate(()=>{be.pos.y+=be.speed*e.dt(),be.pos.y>e.height()&&(be.pos.y=0,be.pos.x=Math.random()*e.width())})}const Mt=["","","",""];for(let we=0;we<8;we++){const be=e.add([e.text(Mt[Math.floor(Math.random()*Mt.length)],{size:16}),e.pos(Math.random()*e.width(),Math.random()*e.height()),e.color(...y.BG_LIGHT),e.opacity(.1),e.scale(1),e.z(b.PARTICLES)]);be.pulseTime=Math.random()*Math.PI*2,be.pulseSpeed=1+Math.random()*1.5,be.onUpdate(()=>{be.pulseTime+=e.dt()*be.pulseSpeed;const ce=.8+Math.sin(be.pulseTime)*.2;be.scale=e.vec2(ce,ce),be.opacity=.08+Math.abs(Math.sin(be.pulseTime))*.1})}e.add([e.text("v0.1.1",{size:Z.MICRO}),e.pos(e.width()-10,e.height()-10),e.anchor("botright"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]),e.loop(12,()=>{if(Math.random()<.12){const we=100+Math.random()*(e.height()-200),be=Math.random()<.5?1:-1,ce=be>0?-50:e.width()+50,de=e.add([e.text("$",{size:24}),e.pos(ce,we),e.color(...y.GOLD),e.area({scale:2.5}),e.anchor("center"),e.scale(1),e.z(b.PARTICLES+1),"goldenEnemy"]);de.speed=150+Math.random()*100,de.direction=be,de.pulseTime=0,de.onClick(()=>{if(!de.exists())return;ps(1);for(let st=0;st<8;st++){const Qe=Math.PI*2*st/8,lt=e.add([e.text(["$",""][Math.floor(Math.random()*2)],{size:12}),e.pos(de.pos.x,de.pos.y),e.color(...y.GOLD),e.opacity(1),e.z(b.PARTICLES+2)]),pt=80+Math.random()*60;lt.velocity=e.vec2(Math.cos(Qe)*pt,Math.sin(Qe)*pt),lt.life=.8,lt.onUpdate(()=>{lt.pos=lt.pos.add(lt.velocity.scale(e.dt())),lt.life-=e.dt(),lt.opacity=lt.life/.8,lt.life<=0&&e.destroy(lt)})}const Ee=e.add([e.text("+$1",{size:18}),e.pos(de.pos.x,de.pos.y),e.anchor("center"),e.color(...y.SUCCESS),e.opacity(1),e.z(b.UI_TEXT)]);Ee.life=1.2,Ee.onUpdate(()=>{Ee.pos.y-=40*e.dt(),Ee.life-=e.dt(),Ee.opacity=Ee.life/1.2,Ee.life<=0&&e.destroy(Ee)}),e.destroy(de),e.wait(.1,()=>e.go("menu"))}),de.onUpdate(()=>{de.pos.x+=de.speed*de.direction*e.dt(),de.pulseTime+=e.dt();const Ee=Math.sin(de.pulseTime*8)*.15;de.scale=e.vec2(1+Ee,1+Ee),(de.direction>0&&de.pos.x>e.width()+100||de.direction<0&&de.pos.x<-100)&&e.destroy(de)})}})})}function H1(e){const t=[];for(const[o,n]of Object.entries(Wt))n.unlockRequirement?.type==="achievement"&&n.unlockRequirement?.value===e&&t.push({key:o,...n});return t}let At={isOpen:!1,elements:[],k:null,onClose:null};function Jh(e,t,o=null){At.isOpen&&Li(),At.k=e,At.isOpen=!0,At.onClose=o,At.elements=[];const n=Ms(),s=Gr(t.id),a=ji(t.id,n),r=Uo[t.difficulty]||Uo.normal,l=420,c=400,d=e.width()/2,i=e.height()/2,h=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(b.MODAL-1),e.area(),"achievementModalOverlay"]);At.elements.push(h),h.onClick(()=>{Li()});const u=e.add([e.rect(l,c),e.pos(d,i),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...r)),e.fixed(),e.z(b.MODAL),"achievementModal"]);At.elements.push(u);const g=e.add([e.text(t.name,{size:Z.HEADER}),e.pos(d,i-130),e.anchor("center"),e.color(...s?r:y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(g);const p=e.add([e.rect(64,64),e.pos(d,i-70),e.anchor("center"),e.color(s?50:30,s?50:30,s?60:30),e.outline(2,e.rgb(...s?r:y.TEXT_DISABLED)),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(p);const D=e.add([e.text(t.icon,{size:36}),e.pos(d,i-70),e.anchor("center"),e.color(...s?[255,255,255]:[80,80,80]),e.fixed(),e.z(b.MODAL+2),"achievementModal"]);At.elements.push(D);const m=e.add([e.text(t.description,{size:Z.BODY,width:l-40}),e.pos(d,i-25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(m);const M=H1(t.id),B=t.unlocks&&t.unlocks.length>0,P=M.length>0;if(P||B){const L=[];if(M.forEach(N=>{L.push(`${N.char} ${N.name}`)}),B&&t.unlocks.forEach(N=>{const _=ah[N],X=fs[N];_?L.push(_.name):X&&L.push(X.name)}),L.length>0){const N=e.add([e.text(`Unlocks: ${L.join(", ")}`,{size:Z.SMALL,width:l-40}),e.pos(d,i+5),e.anchor("center"),e.color(...s?y.SUCCESS:y.GOLD),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(N)}}const O=P||B?i+35:i+25;if(a&&!s){const _=O,X=e.add([e.rect(280,20),e.pos(d,_),e.anchor("center"),e.color(30,30,40),e.outline(2,e.rgb(80,80,100)),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(X);const H=Math.max(4,280*a.progress),R=e.add([e.rect(H,16),e.pos(d-280/2+H/2,_),e.anchor("center"),e.color(...r),e.opacity(.8),e.fixed(),e.z(b.MODAL+2),"achievementModal"]);At.elements.push(R);const F=e.add([e.text(`${a.current}/${a.target} (${a.percentage}%)`,{size:Z.SMALL}),e.pos(d,_+25),e.anchor("center"),e.color(...y.TEXT_TERTIARY),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(F)}else if(s){const L=e.add([e.text("UNLOCKED",{size:Z.LABEL}),e.pos(d,O),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(L)}const v=sh(t);if(v>0){const L=O+(s?35:a?55:35),N=e.add([e.text("-- REWARD --",{size:Z.SMALL}),e.pos(d,L),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(N);const _=ga(),X=e.add([e.text(`${_}${v}`,{size:Z.H2}),e.pos(d,L+25),e.anchor("center"),e.color(...s?y.SUCCESS:y.GOLD),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(X)}const T=t.difficulty.charAt(0).toUpperCase()+t.difficulty.slice(1),x=e.add([e.text(`${T}`,{size:Z.SMALL}),e.pos(d,i+c/2-60),e.anchor("center"),e.color(...r),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(x);const C=e.add([e.rect(80,30),e.pos(d,i+c/2-30),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.MODAL+1),"achievementModal"]);At.elements.push(C);const S=e.add([e.text("CLOSE",{size:Z.SMALL}),e.pos(d,i+c/2-30),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+2),"achievementModal"]);At.elements.push(S),C.onClick(()=>{et(),Li()});const z=e.onKeyPress("escape",()=>{Li()});At.escHandler=z}function Li(){if(!At.isOpen)return;const e=At.k;e&&(At.elements.forEach(t=>{t&&t.exists&&t.exists()&&e.destroy(t)}),At.elements=[],At.escHandler&&(At.escHandler.cancel(),At.escHandler=null),At.isOpen=!1,At.onClose&&(At.onClose(),At.onClose=null))}function jh(){return At.isOpen}const Zh={allTime:{publicKey:"696eba6f8f40bb1184b6c60f",privateKey:"YRU5IdY0w0uJvRF8cb9S1A21WwOAek3kyr3RcOYHbdYA"},daily:{publicKey:"696ff2ee8f40bb1184b8cc92",privateKey:"SgdqIaI_fkWUlRVwoWLQlA1yEXBc-33UKZYWPWJcOX6Q"}},U1="https://corsproxy.io/?",N1="http://dreamlo.com/lb";function Qh(e){return`${U1}${encodeURIComponent(N1+e)}`}const _1=6e4,Mr={allTime:{data:null,timestamp:0},daily:{data:null,timestamp:0}},X1=5e3;function kh(e){return e&&e.replace(/[^a-zA-Z0-9_-]/g,"").substring(0,20)||"Anonymous"}function F1(e){return typeof e=="number"&&e>0&&e<=2e5}async function eu(e,t=X1){const o=new AbortController,n=setTimeout(()=>o.abort(),t);try{const s=await fetch(e,{signal:o.signal});return clearTimeout(n),s}catch(s){throw clearTimeout(n),s}}async function uc(e,t="allTime"){try{if(!F1(e.score))return console.warn("[OnlineLeaderboards] Invalid score, skipping submission:",e.score),!1;const o=Zh[t];if(!o)return console.warn("[OnlineLeaderboards] Unknown board type:",t),!1;const n=kh(e.name),s=Math.floor(e.score),a=Math.floor(e.time||0),r=`${e.floor||1}|${e.character||"unknown"}|${e.date||""}`,l=`/${o.privateKey}/add/${encodeURIComponent(n)}/${s}/${a}/${encodeURIComponent(r)}`,c=Qh(l);console.log(`[OnlineLeaderboards] Submitting score to ${t}:`,{name:n,score:s,floor:e.floor});const d=await eu(c);return d.ok?(console.log(`[OnlineLeaderboards] Score submitted to ${t} successfully`),Mr[t].data=null,Mr[t].timestamp=0,!0):(console.warn("[OnlineLeaderboards] Submission failed with status:",d.status),!1)}catch(o){return o.name==="AbortError"?console.warn("[OnlineLeaderboards] Submission timed out"):console.warn("[OnlineLeaderboards] Submission error:",o.message),!1}}async function Y1(e){return uc(e,"daily")}function _l(e){const t=(e.text||"").split("|");return{name:e.name||"Anonymous",score:parseInt(e.score,10)||0,time:parseInt(e.seconds,10)||0,floor:parseInt(t[0],10)||1,character:t[1]||"survivor",date:t[2]||""}}async function tu(e=10,t="allTime"){try{const o=Zh[t];if(!o)return console.warn("[OnlineLeaderboards] Unknown board type:",t),{entries:[],totalCount:0,error:"Unknown board type"};const n=Mr[t],s=Date.now();if(n.data&&s-n.timestamp<_1)return console.log(`[OnlineLeaderboards] Using cached ${t} leaderboard`),{entries:n.data.slice(0,e),totalCount:n.data.length,error:null};const a=Qh(`/${o.publicKey}/json`);console.log(`[OnlineLeaderboards] Fetching ${t} leaderboard...`);const r=await eu(a);if(!r.ok)throw new Error(`HTTP ${r.status}`);const l=await r.json();let c=[];if(l?.dreamlo?.leaderboard?.entry){const d=l.dreamlo.leaderboard.entry;Array.isArray(d)?c=d.map(_l):c=[_l(d)]}return n.data=c,n.timestamp=s,console.log(`[OnlineLeaderboards] Fetched ${c.length} entries from ${t}`),{entries:c.slice(0,e),totalCount:c.length,error:null}}catch(o){return o.name==="AbortError"?(console.warn("[OnlineLeaderboards] Fetch timed out"),{entries:[],totalCount:0,error:"Connection timed out"}):(console.warn("[OnlineLeaderboards] Fetch error:",o.message),{entries:[],totalCount:0,error:"Could not connect to server"})}}async function q1(e,t){try{const o=await tu(1e3);if(o.error)return{rank:null,total:0,error:o.error};const n=kh(e),s=o.entries.findIndex(r=>r.name.toLowerCase()===n.toLowerCase());return s>=0?{rank:s+1,total:o.totalCount,error:null}:{rank:o.entries.filter(r=>r.score>t).length+1,total:o.totalCount+1,error:null}}catch(o){return console.warn("[OnlineLeaderboards] Error getting rank:",o.message),{rank:null,total:0,error:"Could not determine rank"}}}const ou="superSmashTextyLeaderboards",Ya=100,qa=100;function xa(){try{const e=localStorage.getItem(ou),t=e?JSON.parse(e):null;return{daily:t?.daily||{},allTime:t?.allTime||[],personal:t?.personal||{}}}catch(e){return console.warn("[Leaderboards] Failed to load leaderboards:",e),{daily:{},allTime:[],personal:{}}}}function G1(e){try{localStorage.setItem(ou,JSON.stringify(e))}catch(t){console.warn("[Leaderboards] Failed to save leaderboards:",t)}}function K1(e){const t=e.floorsReached*1e3,o=(e.enemiesKilled||0)*10,n=(e.bossesKilled||0)*500,s=e.duration||0,a=Math.max(0,3e4-Math.floor(s*50));return t+o+n+a}function V1(e){const t=xa(),o=Co(),n=e.date||Wo(),s={name:o,score:e.score||0,floor:e.floor||1,character:e.character||"survivor",time:e.time||0,date:n,timestamp:Date.now()};let a={rank:null,isNewBest:!1,dailyRank:null,isNewPersonalBest:!1};e.isDaily&&(t.daily[n]||(t.daily[n]=[]),t.daily[n].push(s),t.daily[n].sort((c,d)=>d.score-c.score),t.daily[n].length>Ya&&(t.daily[n]=t.daily[n].slice(0,Ya)),a.dailyRank=t.daily[n].findIndex(c=>c.timestamp===s.timestamp&&c.name===s.name)+1,(a.dailyRank===0||a.dailyRank>Ya)&&(a.dailyRank=null)),t.allTime.push(s),t.allTime.sort((c,d)=>d.score-c.score),t.allTime.length>qa&&(t.allTime=t.allTime.slice(0,qa)),a.rank=t.allTime.findIndex(c=>c.timestamp===s.timestamp&&c.name===s.name)+1,(a.rank===0||a.rank>qa)&&(a.rank=null);const r=s.character;t.personal[r]||(t.personal[r]={bestScore:0,bestFloor:0,bestTime:1/0});const l=t.personal[r];return s.score>l.bestScore&&(l.bestScore=s.score,a.isNewBest=!0,a.isNewPersonalBest=!0),s.floor>l.bestFloor&&(l.bestFloor=s.floor,a.isNewPersonalBest=!0),s.floor>=3&&s.time<l.bestTime&&(l.bestTime=s.time,a.isNewPersonalBest=!0),G1(t),console.log("[Leaderboards] Score submitted:",s,"Result:",a),uc(s).catch(c=>{console.warn("[Leaderboards] Online submission failed:",c)}),a}function W1(e=null,t=10){const o=xa(),n=e||Wo();return(o.daily[n]||[]).slice(0,t)}function $1(e=10){return xa().allTime.slice(0,e)}function J1(){return xa().personal}function Xl(e){if(e===1/0||e===void 0||e===null)return"--:--";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t}:${o.toString().padStart(2,"0")}`}function Tr(e){return(e||0).toLocaleString()}function Fl(e){if(e=Math.max(0,Math.min(1,e)),e<.5){const t=e*2;return[255,Math.round(200*t),50]}else{const t=(e-.5)*2;return[Math.round(255*(1-t)),200+Math.round(55*t),50+Math.round(100*t)]}}function Ga(e,t={}){const{label:o="",value:n=0,maxValue:s=100,x:a=0,y:r=0,width:l=80,color:c=y.PRIMARY,usePercentageColor:d=!1}=t,i=[],h=6,u=n/s,g=d?Fl(u):c,p=e.add([e.text(o,{size:Z.TINY}),e.pos(a,r),e.anchor("topleft"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);i.push(p);const D=e.add([e.rect(l,h),e.pos(a,r+14),e.anchor("topleft"),e.color(...y.BG_DARK),e.outline(1,e.rgb(50,50,60)),e.fixed(),e.z(b.UI_ELEMENTS)]);i.push(D);const m=Math.max(0,(l-2)*u),M=e.add([e.rect(m,h-2),e.pos(a+1,r+15),e.anchor("topleft"),e.color(...g),e.fixed(),e.z(b.UI_ELEMENTS+1)]);i.push(M);const B=e.add([e.text(`${n}`,{size:Z.MICRO}),e.pos(a+l+4,r+10),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);return i.push(B),{elements:i,updateValue:O=>{const v=Math.max(0,Math.min(s,O)),T=v/s;if(M.width=Math.max(0,(l-2)*T),B.text=`${v}`,d){const x=Fl(T);M.color=e.rgb(...x)}},destroy:()=>{i.forEach(O=>{O.exists()&&e.destroy(O)})}}}function j1(e){return bs[e]?.name?bs[e].name:Qn[e]?.name?Qn[e].name:on[e]?.name?on[e].name:e}function Z1(e){return bs[e]?.char||Qn[e]?.char||on[e]?.char||"E"}function Q1(e){return bs[e]?.color||Qn[e]?.color||on[e]?.color||[255,100,100]}const Yl=["$","","","",""],ql=[{id:"slayer",title:"Slayer",icon:"",desc:"Most enemy kills",check:e=>e.kills||0,color:[255,100,100]},{id:"collector",title:"Hoarder",icon:"",desc:"Most credits collected",check:e=>e.creditsPickedUp||0,color:[255,215,0]},{id:"bossBuster",title:"Boss Buster",icon:"",desc:"Most bosses defeated",check:e=>e.bossesKilled||0,color:[255,150,50]}];function k1(e){e.scene("gameOver",t=>{Uh(),yx();const o=t?.runStats||{floorsReached:1,roomsCleared:0,enemiesKilled:0,bossesKilled:0,killsByType:{}},n=t?.currencyEarned||0;jn(),Hg();const s=ga(),a=t?.partyStats||[],r=t?.isDailyRun||!1,l=t?.dailyCharacter||null,c=t?.dailyDate||Wo(),d=o.startTime?(Date.now()-o.startTime)/1e3:0,i=K1({floorsReached:o.floorsReached||1,enemiesKilled:o.enemiesKilled||0,bossesKilled:o.bossesKilled||0,duration:d}),h=l||xn(),u=V1({score:i,floor:o.floorsReached||1,character:h,time:d,isDaily:r,date:c}),g=Co(),p=he(),D={name:g,score:i,floor:o.floorsReached||1,character:h,time:d,date:c};uc(D,"allTime"),r&&Y1(D),r&&I1({score:i,floor:o.floorsReached||1,character:h,duration:d});const m=a.length>0?a.reduce((ce,de)=>ce+(de.creditsPickedUp||0),0):n,M=a1(),B=Qg({floorsReached:o.floorsReached||1,enemiesKilled:o.enemiesKilled||0,bossesKilled:o.bossesKilled||0,isDailyRun:r}),f=Zg(B).levelsGained>0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(20,15,25),e.opacity(.98),e.fixed(),e.z(b.OVERLAY)]);const O=25;e.add([e.text("BROADCAST TERMINATED",{size:28}),e.pos(e.width()/2,O),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.MODAL)]),e.add([e.text(`SCORE: ${Tr(i)}`,{size:22}),e.pos(e.width()/2,O+32),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL)]),e.add([e.text(`Floor ${o.floorsReached} | ${o.roomsCleared} Rooms | ${o.enemiesKilled} Kills | ${Math.floor(d)}s`,{size:12}),e.pos(e.width()/2,O+54),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL)]);const v=O+75;let T="";r&&u.dailyRank?(T=`Daily #${u.dailyRank}`,u.dailyRank===1&&(T+=" NEW RECORD!")):u.rank&&(T=`All-Time #${u.rank}`,u.isNewBest&&(T+=" PERSONAL BEST!")),T&&e.add([e.text(T,{size:14}),e.pos(e.width()/2-120,v),e.anchor("center"),e.color(...u.isNewBest?y.SUCCESS:y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL)]);const x=e.add([e.text("Global: ...",{size:14}),e.pos(e.width()/2+120,v),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL)]);q1(g,i).then(ce=>{x.exists()&&(ce.error?x.text="Global: offline":ce.rank?(x.text=`Global #${ce.rank} of ${ce.total}`,x.color=e.rgb(...y.GOLD)):x.text="Global: unranked")});const C=v+30,S=Math.max(a.length,1),z=a.length>0?a:[{name:g,characterData:{char:"@",color:[255,255,255]},kills:o.enemiesKilled,creditsPickedUp:n,bossesKilled:o.bossesKilled,achievements:M}],L={};if(z.length===1){const ce=z[0];ql.forEach(de=>{de.check(ce)>0&&(L[ce.name]||(L[ce.name]=[]),L[ce.name].push(de))})}else ql.forEach(ce=>{let de=null,Ee=0;z.forEach(st=>{const Qe=ce.check(st);Qe>Ee&&(Ee=Qe,de=st)}),de&&Ee>0&&(L[de.name]||(L[de.name]=[]),L[de.name].push(ce))});const _=Math.min(e.width()-210-30,500),X=20,H=(_-80)/S,R=28,F=80,G=R*7+10;e.add([e.rect(_,G),e.pos(X,C),e.color(30,25,35),e.outline(2,e.rgb(60,50,80)),e.fixed(),e.z(b.MODAL)]);let Q=C+8;z.forEach((ce,de)=>{const Ee=X+F+de*H+H/2,st=ce.characterData?.char||"@",Qe=ce.characterData?.color||[255,255,255];e.add([e.text(st,{size:20}),e.pos(Ee,Q+3),e.anchor("center"),e.color(...Qe),e.fixed(),e.z(b.MODAL+1)]);const lt=S<=2?16:S===3?12:10,pt=(ce.name||`P${de+1}`).substring(0,lt);e.add([e.text(pt,{size:11}),e.pos(Ee,Q+20),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL+1)])}),Q+=R+8,[{label:"Kills",getValue:ce=>ce.kills||0,color:y.DANGER},{label:"Credits",getValue:ce=>ce.creditsPickedUp||0,color:y.GOLD},{label:"Bosses",getValue:ce=>ce.bossesKilled||0,color:[255,150,50]}].forEach(ce=>{e.add([e.text(ce.label,{size:12}),e.pos(X+10,Q),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]),z.forEach((de,Ee)=>{const st=X+F+Ee*H+H/2,Qe=ce.getValue(de);e.add([e.text(String(Qe),{size:14}),e.pos(st,Q),e.anchor("center"),e.color(...ce.color),e.fixed(),e.z(b.MODAL+1)])}),Q+=R}),e.add([e.text("Awards",{size:12}),e.pos(X+10,Q),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]);let se=null;function ne(ce,de){se&&se.forEach(It=>{It.exists()&&e.destroy(It)});const Ee=220,st=100,Qe=e.width()/2,lt=e.height()/2,pt=[];pt.push(e.add([e.rect(Ee,st),e.pos(Qe,lt),e.anchor("center"),e.color(30,25,40),e.outline(3,e.rgb(...ce.color)),e.fixed(),e.z(b.MODAL+100)])),pt.push(e.add([e.text(ce.icon,{size:28}),e.pos(Qe,lt-28),e.anchor("center"),e.color(...ce.color),e.fixed(),e.z(b.MODAL+101)])),pt.push(e.add([e.text(ce.title,{size:16}),e.pos(Qe,lt),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.MODAL+101)])),pt.push(e.add([e.text(ce.desc,{size:11}),e.pos(Qe,lt+18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+101)]));const co=S>1?`Earned by ${de.name}`:"Earned this run";pt.push(e.add([e.text(co,{size:10}),e.pos(Qe,lt+34),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(b.MODAL+101)])),se=pt,e.wait(.1,()=>{const It=e.onClick(()=>{It.cancel(),se&&(se.forEach(Kt=>{Kt.exists()&&e.destroy(Kt)}),se=null)})})}z.forEach((ce,de)=>{const Ee=X+F+de*H+H/2,st=L[ce.name]||[];if(st.length>0){const pt=st.length*22+(st.length-1)*4,co=Ee-pt/2+22/2;st.forEach((It,Kt)=>{const lo=co+Kt*26,mo=e.add([e.rect(22,22),e.pos(lo,Q),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...It.color)),e.area(),e.fixed(),e.z(b.MODAL+1)]);e.add([e.text(It.icon,{size:12}),e.pos(lo,Q),e.anchor("center"),e.color(255,220,100),e.fixed(),e.z(b.MODAL+2)]),mo.onClick(()=>{et(),ne(It,ce)}),mo.cursor="pointer"})}else e.add([e.text("-",{size:14}),e.pos(Ee,Q),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)])}),Q+=R,e.add([e.text("Unlocks",{size:12}),e.pos(X+10,Q),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]),z.forEach((ce,de)=>{const Ee=X+F+de*H+H/2,st=ce.achievements||(de===0?M:[]);if(st.length>0){const Qe=Math.min(st.length,3),lt=22,pt=4,co=Qe*lt+(Qe-1)*pt,It=Ee-co/2+lt/2;if(st.slice(0,Qe).forEach((Kt,lo)=>{const mo=rn[Kt];if(!mo)return;const to=It+lo*(lt+pt),no=Uo[mo.difficulty]||Uo.normal,os=e.add([e.rect(lt,lt),e.pos(to,Q),e.anchor("center"),e.color(40,35,50),e.outline(2,e.rgb(...no)),e.area(),e.fixed(),e.z(b.MODAL+1)]);e.add([e.text(mo.icon,{size:12}),e.pos(to,Q),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.MODAL+2)]),os.onClick(()=>{et(),Jh(e,mo)}),os.cursor="pointer"}),st.length>Qe){const Kt=st.length-Qe,lo=It+Qe*(lt+pt);e.add([e.text(`+${Kt}`,{size:10}),e.pos(lo,Q),e.anchor("left"),e.color(200,180,100),e.fixed(),e.z(b.MODAL+1)])}}else e.add([e.text("-",{size:14}),e.pos(Ee,Q),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)])});const ie=C+G+15,fe=S===1?240:S===2?180:S===3?140:110,Me=10,Ne=(_-20-(S-1)*Me)/S,Pe=Math.min(fe,Ne),Ge=S===1?100:80,Te=S*Pe+(S-1)*Me,ut=X+(_-Te)/2+Pe/2,pe=[];z.forEach((ce,de)=>{const Ee=ut+de*(Pe+Me),st=ce.creditsPickedUp||0;e.add([e.rect(Pe-10,Ge),e.pos(Ee,ie+Ge/2),e.anchor("center"),e.outline(3,e.rgb(...y.TEXT_DISABLED)),e.color(0,0,0),e.opacity(.5),e.fixed(),e.z(b.MODAL)]);const Qe=S===1?20:16,lt=e.add([e.text(`0 ${s}`,{size:Qe}),e.pos(Ee,ie+Ge+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL+10)]);pe.push({x:Ee,y:ie,width:Pe-10,height:Ge,credits:st,label:lt,particles:[],spawnedCount:0,displayedCount:0})});const Ae=S===1?50:35,re=.06,Ce=280;let Fe=0;const De=.5;e.onUpdate(()=>{Fe+=e.dt(),!(Fe<De)&&pe.forEach((ce,de)=>{if(ce.credits<=0)return;const Ee=Math.min(ce.credits,Ae),st=ce.credits/Ee,Qe=Fe-De-de*.12,lt=Math.floor(Qe/re);for(;ce.spawnedCount<Ee&&ce.spawnedCount<lt;){const pt=ce.x+(Math.random()-.5)*(ce.width-16),co=ce.y-30-Math.random()*25,It=Yl[Math.floor(Math.random()*Yl.length)],Kt=e.add([e.text(It,{size:14}),e.pos(pt,co),e.anchor("center"),e.color(255,215,0),e.opacity(1),e.fixed(),e.z(b.MODAL+5),"currencyParticle",{velocity:Ce+Math.random()*60,landed:!1,value:st}]);ce.particles.push(Kt),ce.spawnedCount++}ce.particles.forEach(pt=>{if(!pt.exists()||pt.landed)return;pt.pos.y+=pt.velocity*e.dt();const co=ce.y+ce.height-6,It=ce.particles.filter(lo=>lo.landed).length*1.5,Kt=co-It;pt.pos.y>=Kt&&(pt.pos.y=Kt,pt.landed=!0,ce.displayedCount+=pt.value,ce.label.text=`${Math.floor(ce.displayedCount)} ${s}`,pt.opacity=.85)})})});const We=e.width()-110,nt=C,Tt=180,Lt=G+Ge+30;e.add([e.rect(Tt,Lt),e.pos(We-Tt/2,nt),e.color(25,20,30),e.outline(2,e.rgb(50,40,60)),e.fixed(),e.z(b.MODAL)]),e.add([e.text("STAFF",{size:14}),e.pos(We,nt+12),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text("TERMINATED",{size:14}),e.pos(We,nt+26),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL+1)]);const dt=o.killsByType||{},Ie=Object.entries(dt).filter(([ce,de])=>de>0).sort((ce,de)=>de[1]-ce[1]);let Be=nt+48;const Ke=20,qe=Math.floor((Lt-60)/Ke);if(Ie.length===0)e.add([e.text("No staff",{size:12}),e.pos(We,Be+10),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text("harmed",{size:12}),e.pos(We,Be+24),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)]);else{const ce=Math.min(Ie.length,qe);for(let de=0;de<ce;de++){const[Ee,st]=Ie[de],Qe=Z1(Ee),lt=Q1(Ee);e.add([e.text(Qe,{size:14}),e.pos(We-70,Be),e.anchor("center"),e.color(...lt),e.fixed(),e.z(b.MODAL+1)]);const pt=j1(Ee),co=pt.length>14?pt.substring(0,12)+"..":pt;e.add([e.text(co,{size:10}),e.pos(We-50,Be),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text(`x${st}`,{size:11}),e.pos(We+70,Be),e.anchor("right"),e.color(...y.DANGER),e.fixed(),e.z(b.MODAL+1)]),Be+=Ke}if(Ie.length>ce){const de=Ie.slice(ce).reduce((Ee,[st,Qe])=>Ee+Qe,0);e.add([e.text(`+${de} more`,{size:10}),e.pos(We,Be),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.MODAL+1)])}}const ke=e.height()-90;e.add([e.text(`+${m} ${s}`,{size:16}),e.pos(e.width()/2-100,ke),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.MODAL)]);const at=f?y.SUCCESS:[150,200,255],tt=f?`+${B} XP (LEVEL UP!)`:`+${B} XP`;e.add([e.text(tt,{size:16}),e.pos(e.width()/2+100,ke),e.anchor("center"),e.color(...at),e.fixed(),e.z(b.MODAL)]);const ot=hi(),ft=Kr(),ct=ma(),yt=fh();e.add([e.text(`Level ${ot}`,{size:12}),e.pos(e.width()/2,ke+18),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.MODAL)]);const Ht=200,Dt=8,Nt=e.width()/2,bt=ke+32;e.add([e.rect(Ht,Dt),e.pos(Nt,bt),e.anchor("center"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(b.MODAL)]);const St=Math.max(2,Ht*ft);e.add([e.rect(St,Dt-2),e.pos(Nt-Ht/2+St/2+1,bt),e.anchor("center"),e.color(100,180,255),e.fixed(),e.z(b.MODAL+1)]),e.add([e.text(`${ct} / ${yt} XP`,{size:10}),e.pos(e.width()/2,bt+12),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.MODAL)]);const ye=me(),$e=e.height()-30,{MD:ae,SM:Re}=Hn.BUTTON,je=20,ve=!p||ye,I=p&&!ye?"Waiting...":"PLAY AGAIN",K=ae.width,ee=ae.height,ue=Re.width,Ze=Re.height,it=K+je+ue,zt=e.width()/2-it/2,rt=e.add([e.rect(K,ee),e.pos(zt+K/2,$e),e.anchor("center"),e.color(...ve?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(...ve?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(b.MODAL)]),Mt=e.add([e.text(I,{size:Z.H2}),e.pos(zt+K/2,$e),e.anchor("center"),e.color(...ve?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(b.MODAL+1)]),we=e.add([e.rect(ue,Ze),e.pos(zt+K+je+ue/2,$e),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.scale(1),e.z(b.MODAL)]),be=e.add([e.text("MENU",{size:Z.SMALL}),e.pos(zt+K+je+ue/2,$e),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.scale(1),e.z(b.MODAL+1)]);ve&&(rt.onHoverUpdate(()=>{rt.color=e.rgb(...y.SUCCESS_HOVER||[80,180,80]),rt.scale=e.vec2(1.02,1.02),Mt.scale=e.vec2(1.02,1.02)}),rt.onHoverEnd(()=>{rt.color=e.rgb(...y.SUCCESS),rt.scale=e.vec2(1,1),Mt.scale=e.vec2(1,1)})),we.onHoverUpdate(()=>{we.color=e.rgb(...y.NEUTRAL_HOVER),we.scale=e.vec2(1.02,1.02),be.scale=e.vec2(1.02,1.02)}),we.onHoverEnd(()=>{we.color=e.rgb(...y.NEUTRAL),we.scale=e.vec2(1,1),be.scale=e.vec2(1,1)}),ve&&rt.onClick(()=>{Ot(),p&&ye&&Ve("game_restart",{}),e.go("game",{resetState:!0})}),we.onClick(()=>{et(),p&&!ye&&Pt("game_restart"),e.go("menu")}),p&&!ye&&_e("game_restart",()=>{Ot(),Pt("game_restart"),e.go("game",{resetState:!0})}),e.onKeyPress("space",()=>{p&&!ye||(Ot(),p&&ye&&Ve("game_restart",{}),e.go("game",{resetState:!0}))}),e.onKeyPress("escape",()=>{jh()||(et(),p&&!ye&&Pt("game_restart"),e.go("menu"))})})}function e2(e){e.scene("shop",()=>{const t=S=>(S.preventDefault(),!1);document.addEventListener("contextmenu",t),e.onSceneLeave(()=>{document.removeEventListener("contextmenu",t)});const o=jn(),n=ga();let s="permanentUpgrades";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),fi(e,{patternCount:10,particleCount:15}),pi(e,"MERCH",e.width()/2,35,8);const a=Zr(e,o),r=80,l=95,c=85,d=30,i=[{key:"permanentUpgrades",label:"Upgrades"},{key:"boosters",label:"Boosters"},{key:"cosmetics",label:"Cosmetics"},{key:"weapons",label:"Weapons"},{key:"characters",label:"Chars"}],h=(i.length-1)*l,u=e.width()/2-h/2,g=[];i.forEach((S,z)=>{const L=u+z*l,N=s===S.key,_=e.add([e.rect(c,d),e.pos(L,r),e.anchor("center"),e.color(...N?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),X=e.add([e.text(S.label,{size:Z.BODY}),e.pos(L,r),e.anchor("center"),e.color(...N?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(b.UI_TEXT)]);_.onClick(()=>{et(),s=S.key,m=0,O()}),g.push({bg:_,label:X,category:S.key})});const p=130;e.height()-p-100;let D=[],m=0;const M=6;let B=[],P=!1,f=!1;function O(){const S=jn();a.updateCurrency(S),g.forEach(ne=>{const ie=s===ne.category;ne.bg.color=e.rgb(ie?100:50,ie?100:50,ie?150:80),ne.label.color=e.rgb(ie?255:150,ie?255:150,ie?255:150)}),x(),D.forEach(ne=>{ne.exists()&&e.destroy(ne)}),D=[],B.forEach(ne=>{ne.exists()&&e.destroy(ne)}),B=[];const z=zg(s),N=Object.keys(z).filter(ne=>{const ie=z[ne];return s==="permanentUpgrades"||s==="boosters"?!0:!ie.unlockedByDefault});if(N.length===0){const ne=e.add([e.text("No items available in this category yet.",{size:18}),e.pos(e.width()/2,p+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);D.push(ne);return}const _=Math.ceil(N.length/M);m>=_&&(m=Math.max(0,_-1));const X=m*M,H=N.slice(X,X+M),R=340,F=105,G=F+8,Q=p+5,le=3,se=ne=>{if(!ne)return null;const ie=ne.toLowerCase();return ie.includes("hp")||ie.includes("health")?{icon:"",color:[255,100,100]}:ie.includes("damage")||ie.includes("dmg")?{icon:"",color:[255,200,100]}:ie.includes("speed")?{icon:"",color:[100,200,255]}:ie.includes("crit")?{icon:"",color:[255,255,100]}:ie.includes("xp")||ie.includes("pickup")?{icon:"",color:[100,255,200]}:ie.includes("defense")||ie.includes("reduction")?{icon:"",color:[150,150,255]}:ie.includes("credit")||ie.includes("silver")?{icon:"$",color:[200,150,50]}:ie.includes("level")?{icon:"",color:[200,100,255]}:ie.includes("invuln")||ie.includes("immunity")?{icon:"",color:[100,255,255]}:ie.includes("trail")||ie.includes("glow")||ie.includes("effect")?{icon:"",color:[200,150,255]}:null};if(H.forEach((ne,ie)=>{const fe=z[ne],Me=Math.floor(ie/le),Ue=ie%le,Ne=45+Me*(R+15),Pe=Q+Ue*G,Ge=fe.requiredAchievement||(fe.unlockRequirement?.type==="achievement"?fe.unlockRequirement.value:null),Te=Ge?!Gr(Ge):!1,ut=Ge?ih(Ge):null,pe=s==="characters"&&Go("characters",ne),Ae=s==="weapons"&&Go("weapons",ne),re=s==="permanentUpgrades"&&Ct(ne)>=(fe.maxLevel||1),Ce=s==="cosmetics"&&fe.requiredAchievement&&!Te,Fe=s==="cosmetics"&&(Go("cosmetics",ne)||fe.unlockedByDefault||Ce),De=s==="cosmetics"&&Jg(fe.category)===ne;let We,nt;Te?(We=e.rgb(60,50,50),nt=[30,25,25]):De?(We=e.rgb(100,200,255),nt=[35,45,55]):re||pe||Ae||Fe?(We=e.rgb(80,150,80),nt=[35,45,35]):(We=e.rgb(80,80,120),nt=[35,35,45]);const Tt=e.add([e.rect(R,F),e.pos(Ne,Pe),e.anchor("topleft"),e.color(...nt),e.outline(2,We),e.area(),e.fixed(),e.z(1e3)]);let Lt=Ne+10;if((s==="characters"||s==="weapons")&&fe.char){const ae=e.add([e.rect(40,40),e.pos(Ne+8,Pe+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),Re=e.add([e.text(fe.char,{size:28}),e.pos(Ne+28,Pe+28),e.anchor("center"),e.color(...Te?[60,60,60]:fe.color||[200,200,200]),e.fixed(),e.z(1002)]);D.push(ae,Re),Lt=Ne+55}if(s==="cosmetics"){const ae=fe.category==="trail"?"~":fe.category==="death"?"":"";let Re;fe.color==="rainbow"?Re=[255,100,200]:Array.isArray(fe.color)?Re=fe.color:Re=[150,150,200];const je=Te?[60,60,70]:Re,ve=Te?[50,50,60]:Re,I=e.add([e.rect(36,36),e.pos(Ne+8,Pe+8),e.anchor("topleft"),e.color(25,25,35),e.outline(1,e.rgb(...ve)),e.fixed(),e.z(1001)]),K=e.add([e.text(ae,{size:22}),e.pos(Ne+26,Pe+26),e.anchor("center"),e.color(...je),e.fixed(),e.z(1002)]);D.push(I,K),Lt=Ne+50}const dt=e.add([e.text(fe.name,{size:16}),e.pos(Lt,Pe+10),e.anchor("topleft"),e.color(Te?100:255,Te?100:255,Te?100:255),e.fixed(),e.z(1001)]),Ie=se(fe.description);if(Ie&&!Te){const ae=e.add([e.text(Ie.icon,{size:18}),e.pos(Ne+R-12,Pe+12),e.anchor("topright"),e.color(...Ie.color),e.fixed(),e.z(1001)]);D.push(ae)}if(Te){const ae=e.add([e.text("(X)",{size:14}),e.pos(Ne+R-10,Pe+10),e.anchor("topright"),e.color(150,80,80),e.fixed(),e.z(1002)]);D.push(ae)}const Be=R-Lt+Ne-90,Ke=Pe+30;let qe=fe.description,ke=null;if(Te&&ut){const ae=Ms();ae&&(ke=ji(ut.id,ae)),ke?qe=`${ut.name} (${ke.current}/${ke.target})`:qe=`Requires: ${ut.name}`}const at=e.add([e.text(qe,{size:12,width:Be}),e.pos(Lt,Ke),e.anchor("topleft"),e.color(Te?140:180,Te?110:180,Te?110:180),e.fixed(),e.z(1001)]);if(Te&&ke&&ke.target>1){const ae=Math.min(Be,120),Re=4,je=Lt,ve=Ke+18,I=e.add([e.rect(ae,Re),e.pos(je,ve),e.anchor("topleft"),e.color(40,35,45),e.fixed(),e.z(1001)]);D.push(I);const K=Math.max(0,ke.progress*ae);if(K>0){const ee=e.add([e.rect(K,Re),e.pos(je,ve),e.anchor("topleft"),e.color(100,80,130),e.fixed(),e.z(1002)]);D.push(ee)}}const tt=Pe+F-28,ot=Ne+R-85,ft=75,ct=24;function yt(ae){const Re=[50,65,90,115,160];return ae<Re.length?Re[ae]:160+(ae-4)*50}let Ht="",Dt=!1,Nt=fe.cost,bt=!1,St=0,ye=1;if(s==="permanentUpgrades"){const ae=Ct(ne),Re=fe.maxLevel||1;St=ae,ye=Re,bt=!0,ae>=Re?Ht="MAXED":(Nt=yt(ae),Dt=o>=Nt)}else if(s==="boosters"){const ae=Fg();Ht=ae>0?`Ready (${ae})`:"Consumable",Dt=o>=Nt}else s==="cosmetics"?(fe.category,De?Ht="EQUIPPED":Fe?Ht=Ce?"UNLOCKED":"OWNED":Te||(Dt=o>=Nt)):s==="characters"?pe||(Dt=o>=Nt):s==="weapons"&&(Ae||(Dt=o>=Nt));if(bt){const je=Lt,ve=tt+8,I=e.add([e.rect(100,8),e.pos(je,ve),e.anchor("topleft"),e.color(30,30,40),e.outline(1,e.rgb(60,60,80)),e.fixed(),e.z(1001)]),K=Math.max(0,St/ye*98);if(K>0){const ue=e.add([e.rect(K,6),e.pos(je+1,ve+1),e.anchor("topleft"),e.color(St>=ye?100:80,St>=ye?200:150,St>=ye?100:80),e.fixed(),e.z(1002)]);D.push(ue)}const ee=e.add([e.text(`${St}/${ye}`,{size:10}),e.pos(je+100+8,ve+4),e.anchor("left"),e.color(St>=ye?100:150,St>=ye?255:200,St>=ye?100:150),e.fixed(),e.z(1001)]);D.push(I,ee)}let $e=null;if(Ht&&!bt){let ae;switch(Ht){case"EQUIPPED":ae=[100,200,255];break;case"UNLOCKED":ae=[180,140,255];break;case"MAXED":case"OWNED":ae=[100,200,100];break;default:ae=[180,180,180]}$e=e.add([e.text(Ht,{size:11}),e.pos(Lt,tt+7),e.anchor("topleft"),e.color(...ae),e.fixed(),e.z(1001)])}if(Te&&ut){const ae=e.add([e.rect(ft,ct),e.pos(ot,tt),e.anchor("topleft"),e.color(50,40,60),e.outline(1,e.rgb(100,80,130)),e.area({width:ft,height:ct}),e.fixed(),e.z(1010)]),Re=e.add([e.text("VIEW",{size:11}),e.pos(ot+ft/2,tt+ct/2),e.anchor("center"),e.color(160,130,200),e.fixed(),e.z(1011)]);ae.onHover(()=>{ae.color=e.rgb(70,55,85),ae.outline.color=e.rgb(140,110,180),Re.color=e.rgb(200,170,255)}),ae.onHoverEnd(()=>{ae.color=e.rgb(50,40,60),ae.outline.color=e.rgb(100,80,130),Re.color=e.rgb(160,130,200)});const je=ut;ae.onClick(()=>{et(),Jh(e,je)}),ae.cursor="pointer",D.push(ae,Re)}else if(Te){const ae=e.add([e.text("LOCKED",{size:11}),e.pos(ot+ft/2,tt+ct/2),e.anchor("center"),e.color(100,80,80),e.fixed(),e.z(1001)]);D.push(ae)}else if(Dt||s==="permanentUpgrades"&&St<ye){const ae=e.add([e.rect(ft,ct),e.pos(ot,tt),e.anchor("topleft"),e.color(Dt?40:30,Dt?120:40,Dt?40:30),e.outline(1,e.rgb(Dt?80:50,Dt?180:60,Dt?80:50)),e.area(),e.fixed(),e.z(1001)]),Re=e.add([e.text(`$${Nt}`,{size:12}),e.pos(ot+ft/2,tt+ct/2),e.anchor("center"),e.color(Dt?255:120,Dt?255:120,Dt?255:120),e.fixed(),e.z(1002)]);if(s==="permanentUpgrades"&&St>0){let je=null;je=e.onMouseRelease("right",()=>{const ve=e.mousePos();if(ve.x>=ot&&ve.x<=ot+ft&&ve.y>=tt&&ve.y<=tt+ct){if(P)return;P=!0;const I=qg(ne);if(I&&I.success){Di();const K=e.add([e.text(`Refunded $${I.refundAmount}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,200,255),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{K.exists()&&e.destroy(K)}),O(),e.wait(.2,()=>{P=!1})}else P=!1}}),ae.onDestroy(()=>{je&&je.cancel()})}Dt&&ae.onClick(()=>{if(P)return;P=!0;let je;if(s==="permanentUpgrades"?je=_g(ne,Nt,fe.maxLevel):s==="boosters"?je=Xg(ne,Nt):je=Ng(s,ne,Nt),s==="permanentUpgrades"||s==="boosters")if(je&&je.success){Di();const ve=s==="boosters"?"Booster Ready!":"Purchased!",I=e.add([e.text(ve,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{I.exists()&&e.destroy(I)}),O(),e.wait(.2,()=>{P=!1})}else if(je&&je.reason==="insufficientCurrency"){Ua();const ve=e.add([e.text(`Not enough ${n}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ve.exists()&&e.destroy(ve)}),P=!1}else P=!1;else if(je){Di();const ve=e.add([e.text("Purchased!",{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ve.exists()&&e.destroy(ve)}),O(),e.wait(.2,()=>{P=!1})}else{Ua();const ve=e.add([e.text(`Not enough ${n}!`,{size:20}),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(2e3)]);e.wait(.5,()=>{ve.exists()&&e.destroy(ve)}),P=!1}}),D.push(ae,Re)}else if(s==="cosmetics"&&Fe&&!De){const ae=e.add([e.rect(ft,ct),e.pos(ot,tt),e.anchor("topleft"),e.color(40,80,120),e.outline(1,e.rgb(80,140,200)),e.area(),e.fixed(),e.z(1001)]),Re=e.add([e.text("EQUIP",{size:11}),e.pos(ot+ft/2,tt+ct/2),e.anchor("center"),e.color(200,230,255),e.fixed(),e.z(1002)]);ae.onHover(()=>{ae.color=e.rgb(50,100,150),ae.outline.color=e.rgb(100,170,240),Re.color=e.rgb(230,245,255)}),ae.onHoverEnd(()=>{ae.color=e.rgb(40,80,120),ae.outline.color=e.rgb(80,140,200),Re.color=e.rgb(200,230,255)}),ae.onClick(()=>{P||(P=!0,et(),Wc(fe.category,ne),P=!1,O())}),ae.cursor="pointer",D.push(ae,Re)}else if(s==="cosmetics"&&De&&!ne.includes("None")){const ae=e.add([e.rect(ft,ct),e.pos(ot,tt),e.anchor("topleft"),e.color(80,50,50),e.outline(1,e.rgb(160,100,100)),e.area(),e.fixed(),e.z(1001)]),Re=e.add([e.text("UNEQUIP",{size:11}),e.pos(ot+ft/2,tt+ct/2),e.anchor("center"),e.color(255,180,180),e.fixed(),e.z(1002)]);ae.onHover(()=>{ae.color=e.rgb(100,60,60),ae.outline.color=e.rgb(200,120,120),Re.color=e.rgb(255,210,210)}),ae.onHoverEnd(()=>{ae.color=e.rgb(80,50,50),ae.outline.color=e.rgb(160,100,100),Re.color=e.rgb(255,180,180)}),ae.onClick(()=>{if(P)return;P=!0,et();const je=fe.category+"None";Wc(fe.category,je),P=!1,O()}),ae.cursor="pointer",D.push(ae,Re)}D.push(Tt,dt,at),$e&&D.push($e)}),_>1){const ne=e.height()-115,ie=e.width()/2,fe=20,Me=ie-(_-1)*fe/2,Ue=ie+(_-1)*fe/2,Ne=35,Pe=Me-Ne,Ge=Ue+Ne,Te=e.add([e.rect(30,30),e.pos(Pe,ne),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+10)]),ut=e.add([e.text("<",{size:24}),e.pos(Pe,ne),e.anchor("center"),e.color(m>0?255:80,m>0?255:80,m>0?255:80),e.fixed(),e.z(b.UI_TEXT+10)]);m>0&&(Te.onClick(()=>{f||(f=!0,e.wait(0,()=>{f=!1}),et(),m--,O())}),Te.cursor="pointer"),B.push(Te,ut);const pe=e.add([e.rect(30,30),e.pos(Ge,ne),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+10)]),Ae=e.add([e.text(">",{size:24}),e.pos(Ge,ne),e.anchor("center"),e.color(m<_-1?255:80,m<_-1?255:80,m<_-1?255:80),e.fixed(),e.z(b.UI_TEXT+10)]);m<_-1&&(pe.onClick(()=>{f||(f=!0,e.wait(0,()=>{f=!1}),et(),m++,O())}),pe.cursor="pointer"),B.push(pe,Ae);for(let re=0;re<_;re++){const Ce=re===m,Fe=Me+re*fe,De=e.add([e.rect(16,16),e.pos(Fe,ne),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),We=e.add([e.text(Ce?"":"",{size:14}),e.pos(Fe,ne),e.anchor("center"),e.color(Ce?255:120,Ce?255:120,Ce?255:120),e.fixed(),e.z(b.UI_TEXT)]),nt=re;De.onClick(()=>{f||(f=!0,e.wait(0,()=>{f=!1}),nt!==m&&(et(),m=nt,O()))}),De.cursor="pointer",B.push(De,We)}}}let v=null,T=null;function x(){const S=hh();s==="permanentUpgrades"&&S>0?v?(T.text=`REFUND: $${S}`,v.hidden=!1,T.hidden=!1):(v=e.add([e.rect(200,30),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),T=e.add([e.text(`REFUND: $${S}`,{size:14}),e.pos(e.width()/2,e.height()-80),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(b.UI_TEXT)]),v.onClick(()=>{Gg().success?(Di(),O()):Ua()})):v&&(v.hidden=!0,T&&(T.hidden=!0))}O();const C=e.add([e.rect(120,35),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text(ri("Back"),{size:Z.BODY}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),C.onClick(()=>{et(),e.go("menu")}),e.onKeyPress("escape",()=>{jh()||e.go("menu")})})}function Gl(e,t){const o=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(b.OVERLAY)]),a=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(b.OVERLAY+1)]),r=[];function l(){r.forEach(D=>{D&&D.exists&&D.exists()&&e.destroy(D)})}const c=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),d=e.add([e.text("Cancel",{size:Z.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+3)]);c.onClick(()=>{l()}),r.push(o,a,c,d);const i=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(100,50,50),e.outline(2,e.rgb(150,100,100)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),h=e.add([e.text("Reset",{size:Z.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+50),e.anchor("center"),e.color(255,200,200),e.fixed(),e.z(b.OVERLAY+3)]);i.onClick(()=>{l(),t()}),r.push(i,h);const u=e.add([e.text("Reset to Defaults?",{size:Z.LABEL}),e.pos(e.width()/2,e.height()/2-50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]);r.push(u);const g=e.add([e.text("This will reset all settings to their default values.",{size:Z.SMALL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.OVERLAY+2)]);r.push(g);const p=e.onKeyPress("escape",()=>{l(),p.cancel()})}function t2(e){e.scene("settings",t=>{const o=t?.fromGame||!1;let n=xr(),s="audio";e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),fi(e,{patternCount:10,particleCount:15}),pi(e,"OPTIONS",e.width()/2,35,8);const a=80,r=100,l=90,c=30,d=[{key:"audio",label:"Audio"},{key:"video",label:"Video"},{key:"gameplay",label:"Gameplay"},{key:"controls",label:"Controls"},{key:"access",label:"Access."},{key:"data",label:"Data"}],i=(d.length-1)*r,h=e.width()/2-i/2,u=[];d.forEach((x,C)=>{const S=h+C*r,z=s===x.key,L=e.add([e.rect(l,c),e.pos(S,a),e.anchor("center"),e.color(z?100:50,z?100:50,z?150:80),e.outline(2,e.rgb(150,150,150)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),N=e.add([e.text(x.label,{size:16}),e.pos(S,a),e.anchor("center"),e.color(z?255:150,z?255:150,z?255:150),e.fixed(),e.z(b.UI_TEXT)]);L.onClick(()=>{s=x.key,M()}),u.push({bg:L,label:N,key:x.key})});const g=120,p=50,D=150;let m=[];function M(){u.forEach(S=>{const z=s===S.key;S.bg.color=e.rgb(z?100:50,z?100:50,z?150:80),S.label.color=e.rgb(z?255:150,z?255:150,z?255:150)}),m.forEach(S=>{S.exists()&&e.destroy(S)}),m=[],n=xr();const x=g+20;let C=x;if(s==="audio")C=B(e,"Master Volume",n.audio?.masterVolume??1,C,S=>{so("audio","masterVolume",S),Ph(S)}),C=B(e,"Music Volume",n.audio?.musicVolume??.35,C,S=>{so("audio","musicVolume",S),Hh(S)}),C=B(e,"SFX Volume",n.audio?.sfxVolume??1,C,S=>{so("audio","sfxVolume",S),Ih(S),et()}),C=P(e,"UI Sounds",n.audio?.uiSounds!==!1,C,S=>{so("audio","uiSounds",S),Bh(S)}),C=P(e,"Combat Sounds",n.audio?.combatSounds!==!1,C,S=>{so("audio","combatSounds",S),Lh(S)});else if(s==="video")C=P(e,"Show Particles",n.visual?.showParticles!==!1,C,S=>{so("visual","showParticles",S)}),C=P(e,"Screen Shake",n.visual?.showScreenShake!==!1,C,S=>{so("visual","showScreenShake",S)}),C=P(e,"Hit Freeze",n.visual?.showHitFreeze!==!1,C,S=>{so("visual","showHitFreeze",S)}),C=P(e,"Damage Numbers",n.visual?.showDamageNumbers!==!1,C,S=>{so("visual","showDamageNumbers",S)}),C=P(e,"FPS Counter",n.visual?.showFPS||!1,C,S=>{so("visual","showFPS",S)}),C=P(e,"Show Timer",n.visual?.showTimer!==!1,C,S=>{so("visual","showTimer",S)});else if(s==="controls"){const S=n.controls||{},z=[{label:"Move Up",key:"moveUp",value:S.moveUp||"w"},{label:"Move Down",key:"moveDown",value:S.moveDown||"s"},{label:"Move Left",key:"moveLeft",value:S.moveLeft||"a"},{label:"Move Right",key:"moveRight",value:S.moveRight||"d"},{label:"Pause",key:"pause",value:S.pause||"escape"},{label:"Interact",key:"interact",value:S.interact||"space"}];z.forEach((N,_)=>{const X=x+_*p,H=e.add([e.text(N.label+":",{size:16}),e.pos(150,X),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(b.UI_ELEMENTS)]),R=e.add([e.rect(100,30),e.pos(500,X),e.anchor("center"),e.color(50,50,70),e.outline(2,e.rgb(100,100,120)),e.fixed(),e.z(b.UI_ELEMENTS)]),F=e.add([e.text(N.value.toUpperCase(),{size:16}),e.pos(500,X),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT)]);m.push(H,R,F)});const L=x+z.length*p;if(L<e.height()-D){const N=e.add([e.text("(Key remapping coming soon)",{size:12}),e.pos(e.width()/2,L+20),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(b.UI_ELEMENTS)]);m.push(N)}}else if(s==="gameplay")C=P(e,"Auto-pause on Level Up",n.gameplay?.autoPause||!1,C,S=>{so("gameplay","autoPause",S)}),C=P(e,"Auto-pickup Currency",n.gameplay?.autoPickupCurrency||!1,C,S=>{so("gameplay","autoPickupCurrency",S)}),C=P(e,"Auto-pickup XP",n.gameplay?.autoPickupXP||!1,C,S=>{so("gameplay","autoPickupXP",S)}),C=P(e,"Confirm Before Quit",n.gameplay?.confirmBeforeQuit!==!1,C,S=>{so("gameplay","confirmBeforeQuit",S)}),C=P(e,"Skip Intro Animation",n.gameplay?.skipIntroAnimation||!1,C,S=>{so("gameplay","skipIntroAnimation",S)});else if(s==="access"){C=P(e,"Reduced Motion",n.accessibility?.reducedMotion||!1,C,z=>{so("accessibility","reducedMotion",z)});const S=e.add([e.text("Disables particles, screen shake, and hit freeze effects",{size:12}),e.pos(e.width()/2,C+10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);m.push(S),C+=40}else if(s==="data"){const S=e.add([e.rect(200,35),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),z=e.add([e.text("Export Save Data",{size:Z.SMALL}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);let L=null;S.onClick(()=>{try{const F=localStorage.getItem("superSmashTexty_save")||"{}";navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(F).then(()=>{L&&L.exists()&&(L.text="Copied to clipboard!",L.color=e.rgb(...y.SUCCESS))}).catch(()=>{L&&L.exists()&&(L.text="Failed to copy",L.color=e.rgb(...y.DANGER))}):(console.log("Save data:",F),L&&L.exists()&&(L.text="Check browser console (F12)",L.color=e.rgb(...y.TEXT_SECONDARY)))}catch(F){console.error("Export failed:",F)}}),m.push(S,z),C+=50,L=e.add([e.text("",{size:Z.SMALL-2}),e.pos(e.width()/2,C-10),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),m.push(L),C+=30;const N=e.add([e.rect(200,35),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),_=e.add([e.text("Import Save Data",{size:Z.SMALL}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);N.onClick(()=>{if(!navigator.clipboard||!navigator.clipboard.readText){L&&L.exists()&&(L.text="Clipboard not available",L.color=e.rgb(...y.DANGER));return}navigator.clipboard.readText().then(F=>{try{const G=JSON.parse(F);G&&typeof G=="object"&&(localStorage.setItem("superSmashTexty_save",F),L&&L.exists()&&(L.text="Import successful! Refresh to apply.",L.color=e.rgb(...y.SUCCESS)))}catch{L&&L.exists()&&(L.text="Invalid save data",L.color=e.rgb(...y.DANGER))}}).catch(()=>{L&&L.exists()&&(L.text="Failed to read clipboard",L.color=e.rgb(...y.DANGER))})}),m.push(N,_),C+=60;const X=e.add([e.rect(200,35),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),H=e.add([e.text("Reset All Progress",{size:Z.SMALL}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);X.onClick(()=>{Gl(e,()=>{localStorage.removeItem("superSmashTexty_save"),L&&L.exists()&&(L.text="Progress reset! Refresh to apply.",L.color=e.rgb(...y.SUCCESS))})}),m.push(X,H),C+=50;const R=e.add([e.text("Warning: Reset cannot be undone!",{size:10}),e.pos(e.width()/2,C),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.UI_ELEMENTS)]);m.push(R)}}function B(x,C,S,z,L){const N=x.add([x.text(C+":",{size:16}),x.pos(150,z),x.anchor("left"),x.color(200,200,200),x.fixed(),x.z(b.UI_ELEMENTS)]),_=300,X=20,H=x.add([x.rect(_,X),x.pos(500,z),x.anchor("center"),x.color(50,50,70),x.outline(2,x.rgb(100,100,120)),x.area(),x.fixed(),x.z(b.UI_ELEMENTS)]);function R(Me){if(Me<.5){const Ue=Me*2;return{r:255,g:Math.round(255*Ue),b:0}}else{const Ue=(Me-.5)*2;return{r:Math.round(255*(1-Ue)),g:255,b:0}}}const F=_*S,G=R(S),Q=x.add([x.rect(F,X-4),x.pos(500-(_-F)/2,z),x.anchor("center"),x.color(G.r,G.g,G.b),x.fixed(),x.z(b.UI_TEXT)]),le=500-_/2+F,se=x.add([x.rect(20,X+4),x.pos(le,z),x.anchor("center"),x.color(200,200,255),x.outline(2,x.rgb(150,150,200)),x.area(),x.fixed(),x.z(1002)]),ne=x.add([x.text(Math.round(S*100)+"%",{size:14}),x.pos(680,z),x.anchor("left"),x.color(255,255,255),x.fixed(),x.z(b.UI_ELEMENTS)]);let ie=!1;H.onClick(()=>{const Me=x.mousePos().x,Ue=500-_/2,Ne=Me-Ue,Pe=Math.max(0,Math.min(1,Ne/_));fe(Pe)}),se.onClick(()=>{ie=!0}),x.onMouseMove(()=>{if(ie&&x.isMouseDown()){const Me=x.mousePos().x,Ue=500-_/2,Ne=Me-Ue,Pe=Math.max(0,Math.min(1,Ne/_));fe(Pe)}else ie=!1}),x.onMouseRelease(()=>{ie=!1});function fe(Me){const Ue=_*Me;Q.width=Ue,Q.pos.x=500-(_-Ue)/2,se.pos.x=500-_/2+Ue,ne.text=Math.round(Me*100)+"%";const Ne=R(Me);Q.color=x.rgb(Ne.r,Ne.g,Ne.b),L(Me)}return m.push(N,H,Q,se,ne),z+p}function P(x,C,S,z,L){const N=x.add([x.text(C+":",{size:16,width:280}),x.pos(150,z),x.anchor("left"),x.color(200,200,200),x.fixed(),x.z(b.UI_ELEMENTS)]),_=80,X=30,H=550,R=x.add([x.rect(_,X),x.pos(H,z),x.anchor("center"),x.color(S?50:70,S?150:50,S?50:70),x.outline(2,x.rgb(100,100,120)),x.area(),x.fixed(),x.z(b.UI_ELEMENTS)]),F=24,G=S?H+_/2-F/2-4:H-_/2+F/2+4,Q=x.add([x.rect(F,F),x.pos(G,z),x.anchor("center"),x.color(255,255,255),x.outline(1,x.rgb(200,200,200)),x.fixed(),x.z(b.UI_TEXT)]),le=S?H-12:H+8,se=x.add([x.text(S?"ON":"OFF",{size:12}),x.pos(le,z),x.anchor("center"),x.color(S?100:150,S?255:150,S?100:150),x.fixed(),x.z(1002)]);return R.onClick(()=>{const ne=!S;S=ne,R.color=x.rgb(ne?50:70,ne?150:50,ne?50:70),Q.pos.x=ne?H+_/2-F/2-4:H-_/2+F/2+4,se.text=ne?"ON":"OFF",se.pos.x=ne?H-12:H+8,se.color=x.rgb(ne?100:150,ne?255:150,ne?100:150),L(ne)}),m.push(N,R,Q,se),z+p}const{MD:f,SM:O}=Hn.BUTTON,v=e.add([e.rect(f.width,f.height),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.DANGER),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("RESET",{size:Z.SMALL}),e.pos(e.width()/2+80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),v.onClick(()=>{Gl(e,()=>{xx(),M()})}),M();const T=e.add([e.rect(O.width,O.height),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2-80,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),T.onClick(()=>{o?e.go("game"):e.go("menu")}),e.onKeyPress("escape",()=>{o?e.go("game"):e.go("menu")})})}function o2(e,t,o){e=Math.max(0,Math.min(1,e)),t=Math.max(0,Math.min(1,t)),o=Math.max(0,Math.min(1,o));let n,s,a;if(t===0)n=s=a=o;else{const r=(d,i,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?d+(i-d)*6*h:h<.5?i:h<.6666666666666666?d+(i-d)*(.6666666666666666-h)*6:d),l=o<.5?o*(1+t):o+t-o*t,c=2*o-l;n=r(c,l,e+1/3),s=r(c,l,e),a=r(c,l,e-1/3)}return[Math.max(0,Math.min(255,Math.round(n*255))),Math.max(0,Math.min(255,Math.round(s*255))),Math.max(0,Math.min(255,Math.round(a*255)))]}function n2(e){e.scene("statistics",()=>{const t=Ms(),o=uh(),n=ga();let s="achievements",a="all",r=0;const l=15,c=8;let d=!1,i=null;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),fi(e,{patternCount:10,particleCount:15}),pi(e,"RATINGS AND RECORDS",e.width()/2,35,8);const h=80,u=160,g=150,p=30,D=[{key:"achievements",label:"Achievements"},{key:"history",label:"History"}],m=(D.length-1)*u,M=e.width()/2-m/2,B=[];D.forEach((L,N)=>{const _=M+N*u,X=s===L.key,H=e.add([e.rect(g,p),e.pos(_,h),e.anchor("center"),e.color(...X?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),R=e.add([e.text(L.label,{size:Z.BODY}),e.pos(_,h),e.anchor("center"),e.color(...X?y.TEXT_PRIMARY:y.TEXT_TERTIARY),e.fixed(),e.z(b.UI_TEXT)]);H.onClick(()=>{d||(d=!0,et(),s=L.key,r=0,a="all",e.wait(0,()=>{C(),e.wait(.1,()=>{d=!1})}))}),B.push({bg:H,label:R,key:L.key})});const P=140,O=e.height()-80;let v=[],T=[];const x=["all",...Bg()];function C(){if(!e||typeof e.add!="function"){console.error("k is not available or k.add is not a function");return}if(B.forEach(L=>{const N=s===L.key;L.bg.color=e.rgb(N?100:50,N?100:50,N?150:80),L.label.color=e.rgb(N?255:150,N?255:150,N?255:150)}),v.forEach(L=>{if(L&&typeof L.exists=="function"&&L.exists())try{e.destroy(L)}catch(N){console.warn("Error destroying content item:",N)}}),v=[],T.forEach(L=>{if(L&&typeof L.exists=="function"&&L.exists())try{e.destroy(L)}catch(N){console.warn("Error destroying category tab item:",N)}}),T=[],s==="achievements")try{const H=(e.width()-640)/2,R=P+5,F=O-R-80,G=R,Q=70,le=22,se=75,ne=x.slice(0,7),ie=(ne.length-1)*se,fe=e.width()/2-ie/2;ne.forEach((ye,$e)=>{const ae=fe+$e*se,Re=a===ye,je=ye==="all"?"All":ye.charAt(0).toUpperCase()+ye.slice(1),ve=e.add([e.rect(Q,le),e.pos(ae,G),e.anchor("center"),e.color(Re?80:40,Re?80:40,Re?120:60),e.outline(1,e.rgb(100,100,150)),e.area(),e.fixed(),e.z(1e3)]),I=e.add([e.text(je,{size:11}),e.pos(ae,G),e.anchor("center"),e.color(Re?255:150,Re?255:150,Re?255:150),e.fixed(),e.z(1001)]);ve.onClick(()=>{d||(d=!0,et(),a=ye,r=0,i=null,e.wait(0,()=>{C(),e.wait(.1,()=>{d=!1})}))}),T.push(ve,I)});let Me;a==="all"?Me=Object.values(rn):Me=Ig(a);const Ue=Math.ceil(Me.length/l);r>=Ue&&(r=Math.max(0,Ue-1));const Ne=r*l,Pe=Me.slice(Ne,Ne+l),Ge=R+35,Te=50,ut=8,pe=5,Ae=Te+22,re=H,Ce=e.add([e.rect(320,F-35),e.pos(H,Ge),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(999)]);v.push(Ce);const Fe=15;Pe.forEach((ye,$e)=>{const ae=o.includes(ye.id),Re=i&&i.id===ye.id,je=Math.floor($e/pe),ve=$e%pe,I=re+Fe+ve*(Te+ut),K=Ge+Fe+je*Ae,ee=Uo[ye.difficulty]||Uo.normal,ue=Re?[100,100,180]:ae?[50,50,65]:[30,30,40],Ze=Re?[150,150,255]:ae?ee:[50,50,60],it=e.add([e.rect(Te,Te),e.pos(I,K),e.anchor("topleft"),e.color(...ue),e.outline(Re?3:2,e.rgb(...Ze)),e.area({width:Te,height:Te}),e.fixed(),e.z(1e3)]),zt=e.add([e.text(ye.icon,{size:24}),e.pos(I+Te/2,K+Te/2),e.anchor("center"),e.color(ae?255:80,ae?255:80,ae?255:80),e.fixed(),e.z(1001)]);if(!ae){const rt=ji(ye.id,t);if(rt&&rt.percentage>0){const Mt=Te-4,we=Mt*rt.progress,be=e.add([e.rect(Mt,4),e.pos(I+2,K+Te-6),e.anchor("topleft"),e.color(20,20,30),e.fixed(),e.z(1001)]);if(v.push(be),we>0){const ce=e.add([e.rect(we,4),e.pos(I+2,K+Te-6),e.anchor("topleft"),e.color(...ee),e.opacity(.8),e.fixed(),e.z(1002)]);v.push(ce)}}}it.onClick(()=>{d||(et(),i=ye,d=!0,e.wait(0,()=>{C(),e.wait(.1,()=>{d=!1})}))}),v.push(it,zt)});const De=H+320+20,We=e.add([e.rect(300,F-35),e.pos(De,Ge),e.anchor("topleft"),e.color(30,28,40),e.outline(2,e.rgb(70,70,100)),e.fixed(),e.z(999)]);v.push(We);const nt=De+300/2,Tt=Ge+20;if(i){const ye=i,$e=o.includes(ye.id),ae=ji(ye.id,t),Re=Uo[ye.difficulty]||Uo.normal,je=e.add([e.rect(70,70),e.pos(nt,Tt+35),e.anchor("center"),e.color($e?45:25,$e?45:25,$e?55:30),e.outline(3,e.rgb(...$e?Re:[60,60,70])),e.fixed(),e.z(1e3)]);v.push(je);const ve=e.add([e.text(ye.icon,{size:40}),e.pos(nt,Tt+35),e.anchor("center"),e.color($e?255:100,$e?255:100,$e?255:100),e.fixed(),e.z(1001)]);v.push(ve);const I=e.add([e.text(ye.name,{size:16}),e.pos(nt,Tt+85),e.anchor("center"),e.color(...$e?[255,255,255]:[180,180,180]),e.fixed(),e.z(1e3)]);v.push(I);const K=ye.difficulty.charAt(0).toUpperCase()+ye.difficulty.slice(1),ee=e.add([e.text(K,{size:11}),e.pos(nt,Tt+105),e.anchor("center"),e.color(...Re),e.fixed(),e.z(1e3)]);v.push(ee);const ue=e.add([e.text(ye.description,{size:12}),e.pos(nt,Tt+130),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1e3)]);v.push(ue);let Ze=Tt+160;if($e){const it=e.add([e.text("UNLOCKED",{size:14}),e.pos(nt,Ze),e.anchor("center"),e.color(100,255,100),e.fixed(),e.z(1e3)]);v.push(it)}else if(ae){const rt=e.add([e.rect(200,16),e.pos(nt,Ze),e.anchor("center"),e.color(30,30,45),e.outline(1,e.rgb(70,70,90)),e.fixed(),e.z(1e3)]);v.push(rt);const Mt=Math.max(2,200*ae.progress),we=e.add([e.rect(Mt,12),e.pos(nt-200/2+Mt/2,Ze),e.anchor("center"),e.color(...Re),e.opacity(.9),e.fixed(),e.z(1001)]);v.push(we);const be=e.add([e.text(`${ae.current} / ${ae.target}`,{size:11}),e.pos(nt,Ze+20),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);v.push(be),Ze+=35}if(!$e&&ye.hint){const it=Ze+15,zt=e.add([e.text("Hint:",{size:10}),e.pos(nt,it),e.anchor("center"),e.color(120,120,140),e.fixed(),e.z(1e3)]);v.push(zt);const rt=e.add([e.text(ye.hint,{size:11}),e.pos(nt,it+18),e.anchor("center"),e.color(160,160,180),e.fixed(),e.z(1e3)]);v.push(rt)}}else{const ye=e.add([e.text("",{size:32}),e.pos(nt,Tt+60),e.anchor("center"),e.color(150,150,180),e.fixed(),e.z(1e3)]);v.push(ye);const $e=e.add([e.text("Select an achievement",{size:14}),e.pos(nt,Tt+100),e.anchor("center"),e.color(120,120,150),e.fixed(),e.z(1e3)]);v.push($e);const ae=e.add([e.text("to view details",{size:12}),e.pos(nt,Tt+120),e.anchor("center"),e.color(100,100,130),e.fixed(),e.z(1e3)]);v.push(ae)}if(Ue>1){const ye=O-55,$e=e.width()/2,ae=20,Re=$e-(Ue-1)*ae/2,je=$e+(Ue-1)*ae/2,ve=25,I=Re-ve,K=je+ve,ee=rt=>{d||rt===r||rt<0||rt>=Ue||(d=!0,et(),r=rt,e.wait(0,()=>{C(),e.wait(.15,()=>{d=!1})}))};for(let rt=0;rt<Ue;rt++){const Mt=rt===r,we=Re+rt*ae,be=e.add([e.rect(16,16),e.pos(we,ye),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),ce=e.add([e.text(Mt?"":"",{size:14}),e.pos(we,ye),e.anchor("center"),e.color(Mt?255:120,Mt?255:120,Mt?255:120),e.fixed(),e.z(b.UI_TEXT)]),de=rt;be.onClick(()=>ee(de)),be.cursor="pointer",v.push(be,ce)}const ue=e.add([e.rect(30,30),e.pos(I,ye),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Ze=e.add([e.text("<",{size:24}),e.pos(I,ye),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);if(r>0){const rt=r-1;ue.onClick(()=>ee(rt)),ue.cursor="pointer"}v.push(ue,Ze);const it=e.add([e.rect(30,30),e.pos(K,ye),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),zt=e.add([e.text(">",{size:24}),e.pos(K,ye),e.anchor("center"),e.color(r<Ue-1?255:80,r<Ue-1?255:80,r<Ue-1?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);if(r<Ue-1){const rt=r+1;it.onClick(()=>ee(rt)),it.cursor="pointer"}v.push(it,zt)}const Lt=Object.keys(rn).length,dt=o.length,Ie=dt/Lt,Be=Ie>=1,Ke=O-20,qe=e.width()/2,ke=e.add([e.text("",{size:24}),e.pos(qe-220,Ke),e.anchor("center"),e.color(Be?255:150,Be?215:150,Be?0:150),e.fixed(),e.scale(1),e.z(1002)]);if(v.push(ke),Be){let ye=0;ke.onUpdate(()=>{ye+=e.dt();const $e=1+Math.sin(ye*3)*.1;ke.scale=e.vec2($e,$e)})}const at=20,tt=Math.floor(Ie*at),ot=at-tt;let ft="";for(let ye=0;ye<tt;ye++)ft+="";for(let ye=0;ye<ot;ye++)ft+="";const ct=e.add([e.text("|"+"".repeat(at)+"|",{size:16}),e.pos(qe,Ke),e.anchor("center"),e.color(60,60,80),e.fixed(),e.z(1e3)]);v.push(ct);let yt;Be?yt=[255,215,0]:Ie>=.75?yt=[100,255,100]:Ie>=.5?yt=[255,255,100]:Ie>=.25?yt=[255,180,100]:yt=[200,200,200];const Ht=e.add([e.text("|"+ft+"|",{size:16}),e.pos(qe,Ke),e.anchor("center"),e.color(...yt),e.fixed(),e.z(1001)]);if(v.push(Ht),Be){let ye=0;Ht.onUpdate(()=>{ye+=e.dt();const $e=ye*60%360,ae=o2($e/360,1,.6);Ht.color=e.rgb(ae[0],ae[1],ae[2])})}const Dt=Math.round(Ie*100),Nt=Be?"COMPLETE!":`${Dt}%`,bt=e.add([e.text(`${dt}/${Lt}`,{size:14}),e.pos(qe+180,Ke-8),e.anchor("center"),e.color(180,180,200),e.fixed(),e.z(1002)]);v.push(bt);const St=e.add([e.text(Nt,{size:12}),e.pos(qe+180,Ke+8),e.anchor("center"),e.color(...Be?[255,215,0]:[150,150,180]),e.fixed(),e.opacity(1),e.z(1002)]);if(v.push(St),Be){let ye=0;St.onUpdate(()=>{ye+=e.dt();const $e=Math.sin(ye*4)*.3+.7;St.opacity=$e})}}catch(L){console.error("Error rendering achievements:",L);const N=e.add([e.text("Error loading achievements",{size:18}),e.pos(e.width()/2,P+50),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(1e3)]);v.push(N)}else if(s==="history"){const L=$g(),N=P+10,_=35;if(L.length===0){const X=e.add([e.text("No run history yet. Complete a run to see it here!",{size:16}),e.pos(e.width()/2,N+50),e.anchor("center"),e.color(150,150,150),e.fixed(),e.z(1e3)]);v.push(X)}else{const X=Math.ceil(L.length/c);r>=X&&(r=Math.max(0,X-1));const H=r*c,R=Math.min(H+c,L.length),F=L.slice(H,R),G=["#","Floor","Rooms","Kills","Level","Credits","Time"],Q=[60,120,200,280,360,450,550];if(G.forEach((ie,fe)=>{const Me=e.add([e.text(ie,{size:14}),e.pos(Q[fe],N),e.anchor("left"),e.color(255,200,100),e.fixed(),e.z(1e3)]);v.push(Me)}),F.forEach((ie,fe)=>{const Me=N+(fe+1)*_,Ue=H+fe+1,Ne=Math.floor(ie.duration/60),Pe=ie.duration%60,Ge=`${Ne}:${Pe.toString().padStart(2,"0")}`;[`${Ue}`,`${ie.floorsReached}`,`${ie.roomsCleared}`,`${ie.enemiesKilled}`,`${ie.level}`,`${n}${ie.currencyEarned}`,Ge].forEach((ut,pe)=>{const Ae=e.add([e.text(ut,{size:14}),e.pos(Q[pe],Me),e.anchor("left"),e.color(200,200,200),e.fixed(),e.z(1e3)]);v.push(Ae)})}),X>1){const ie=O-55,fe=e.width()/2,Me=20,Ue=fe-(X-1)*Me/2;for(let pe=0;pe<X;pe++){const Ae=pe===r,re=Ue+pe*Me,Ce=e.add([e.rect(16,16),e.pos(re,ie),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(1e3)]),Fe=e.add([e.text(Ae?"":"",{size:14}),e.pos(re,ie),e.anchor("center"),e.color(Ae?255:120,Ae?255:120,Ae?255:120),e.fixed(),e.z(1001)]),De=pe;Ce.onClick(()=>{d||De===r||(d=!0,et(),r=De,C(),e.wait(.1,()=>{d=!1}))}),Ce.cursor="pointer",v.push(Ce,Fe)}const Ne=Math.max(30,X*Me/2+25),Pe=e.add([e.rect(30,30),e.pos(fe-Ne,ie),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),Ge=e.add([e.text("<",{size:24}),e.pos(fe-Ne,ie),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(1003)]);r>0&&(Pe.onClick(()=>{d||(d=!0,et(),r--,C(),e.wait(.1,()=>{d=!1}))}),Pe.cursor="pointer"),v.push(Pe,Ge);const Te=e.add([e.rect(30,30),e.pos(fe+Ne,ie),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(1002)]),ut=e.add([e.text(">",{size:24}),e.pos(fe+Ne,ie),e.anchor("center"),e.color(r<X-1?255:80,r<X-1?255:80,r<X-1?255:80),e.fixed(),e.z(1003)]);r<X-1&&(Te.onClick(()=>{d||(d=!0,et(),r++,C(),e.wait(.1,()=>{d=!1}))}),Te.cursor="pointer"),v.push(Te,ut)}const le=H+1,se=R,ne=e.add([e.text(`Showing ${le}-${se} of ${L.length} runs`,{size:12}),e.pos(e.width()/2,O-20),e.anchor("center"),e.color(100,100,150),e.fixed(),e.z(1e3)]);v.push(ne)}}}C();const{SM:S}=Hn.BUTTON,z=e.add([e.rect(S.width,S.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),z.onClick(()=>{et(),e.go("menu")}),e.onKeyPress("escape",()=>{e.go("menu")})})}const hn={BREATHE_SPEED:1.5,BREATHE_AMOUNT:.04,BOB_SPEED:2,BOB_AMOUNT:3,GLOW_PULSE_SPEED:2,GLOW_MIN:.3,GLOW_MAX:.7};function s2(e){if(!e.unlockRequirement)return null;if(e.unlockRequirement.type==="floor")return`Unlock: Complete ${_i.FLOOR} ${e.unlockRequirement.value}`;if(e.unlockRequirement.type==="achievement"){const t=rn[e.unlockRequirement.value];return t?`Unlock: ${t.name}`:"Unlock: Achievement required"}return null}function i2(e){e.scene("characterSelect",()=>{const t=jn(),o=xn();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),fi(e,{patternCount:10,particleCount:15}),Zr(e,t),pi(e,"CONTESTANTS",e.width()/2,60,8);const n=Object.keys(Wt),s=360,a=s+20,r=e.width()-a-20,l=110,c=165,d=70,i=8,h=2,u=5,g=h*u,p=H=>H.replace(/^The\s+/i,""),D=(H,R,F,G)=>{const Q=[],le=/([+-]?\d+%?\s*(?:XP|health|HP|speed|damage|crit|dodge|reduction|lifesteal|blast radius|drones?|orbital))/gi,se=H.split(le),ne=H.match(le)||[];se.forEach((fe,Me)=>{});const ie=e.add([e.text(H,{size:Z.SMALL,width:G}),e.pos(R,F),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);if(Q.push(ie),ne.length>0){const fe=ne.join(" | "),Me=e.add([e.text(fe,{size:Z.TINY}),e.pos(R,F+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT+1)]);Q.push(Me)}return Q},m=Math.ceil(n.length/g);let M=0;const B=n.indexOf(o);B>=0&&(M=Math.floor(B/g));const P=[],f=o;let O=f,v=[],T=[],x=!1;function C(){if(x)return;x=!0,P.forEach(re=>{re&&re.exists&&re.exists()&&e.destroy(re)}),P.length=0,v.forEach(re=>{re&&re.exists&&re.exists()&&e.destroy(re)}),v=[],T.forEach(re=>{re&&re.exists&&re.exists()&&e.destroy(re)}),T=[];const H=M*g,R=Math.min(H+g,n.length);if(n.slice(H,R).forEach((re,Ce)=>{const Fe=Wt[re],De=Go("characters",re)||Fe.unlockedByDefault,We=O===re,nt=f===re,Tt=Math.floor(Ce/h),dt=20+Ce%h*(c+i),Ie=l+Tt*(d+i),Be=e.add([e.rect(c,d),e.pos(dt,Ie),e.anchor("topleft"),e.color(...We?y.BG_MEDIUM:y.BG_DARK),e.outline(2,We?e.rgb(...y.BORDER_ACTIVE):De?e.rgb(...y.TEXT_DISABLED):e.rgb(...y.BG_DARK)),e.area(),e.fixed(),e.scale(1),e.z(b.UI_ELEMENTS),{baseX:dt,baseY:Ie,isHovered:!1}]),Ke=e.add([e.text(Fe.char,{size:Z.HEADER}),e.pos(dt+28,Ie+d/2),e.anchor("center"),e.color(...De?Fe.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(b.UI_TEXT),{baseX:dt+28,baseY:Ie+d/2}]),qe=e.add([e.text(p(Fe.name),{size:Z.SMALL}),e.pos(dt+60,Ie+d/2),e.anchor("left"),e.color(...De?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.scale(1),e.z(b.UI_TEXT),{baseX:dt+60,baseY:Ie+d/2}]);if(Be.onHoverUpdate(()=>{if(!Be.isHovered&&!We&&(Be.isHovered=!0,et()),!We){Be.scale=e.vec2(1.05,1.05),Ke.scale=e.vec2(1.15,1.15),qe.scale=e.vec2(1.05,1.05),Be.color=e.rgb(50,50,65);const ke=Math.sin(e.time()*8)*2;Ke.pos.y=Ke.baseY+ke}}),Be.onHoverEnd(()=>{Be.isHovered=!1,Be.scale=e.vec2(1,1),Ke.scale=e.vec2(1,1),qe.scale=e.vec2(1,1),Be.color=e.rgb(...We?y.BG_MEDIUM:y.BG_DARK),Ke.pos.y=Ke.baseY}),!De){const ke=e.add([e.text("",{size:Z.SMALL}),e.pos(dt+c-18,Ie+d/2),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.OVERLAY)]);P.push(ke)}if(nt){const ke=e.add([e.circle(8),e.pos(dt+c-10,Ie+12),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT+1)]),at=e.add([e.text("",{size:10}),e.pos(dt+c-10,Ie+12),e.anchor("center"),e.color(255,255,255),e.fixed(),e.z(b.UI_TEXT+2)]);P.push(ke,at)}Be.onClick(()=>{O!==re&&(Ot(),O=re,C())}),Be.cursor="pointer",P.push(Be,Ke,qe)}),m>1){const re=l+u*(d+i)+15,Ce=s/2,Fe=20,De=Ce-(m-1)*Fe/2,We=Ce+(m-1)*Fe/2,nt=25,Tt=De-nt,Lt=We+nt;for(let qe=0;qe<m;qe++){const ke=qe===M,at=De+qe*Fe,tt=e.add([e.rect(16,16),e.pos(at,re),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),ot=e.add([e.text(ke?"":"",{size:14}),e.pos(at,re),e.anchor("center"),e.color(ke?255:120,ke?255:120,ke?255:120),e.fixed(),e.z(b.UI_TEXT)]),ft=qe;tt.onClick(()=>{ft!==M&&(et(),M=ft,C())}),tt.cursor="pointer",T.push(tt,ot)}const dt=e.add([e.rect(30,30),e.pos(Tt,re),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Ie=e.add([e.text("<",{size:24}),e.pos(Tt,re),e.anchor("center"),e.color(M>0?255:80,M>0?255:80,M>0?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);M>0&&(dt.onClick(()=>{et(),M--,C()}),dt.cursor="pointer"),T.push(dt,Ie);const Be=e.add([e.rect(30,30),e.pos(Lt,re),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Ke=e.add([e.text(">",{size:24}),e.pos(Lt,re),e.anchor("center"),e.color(M<m-1?255:80,M<m-1?255:80,M<m-1?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);M<m-1&&(Be.onClick(()=>{et(),M++,C()}),Be.cursor="pointer"),T.push(Be,Ke)}const G=Wt[O],Q=Go("characters",O)||G.unlockedByDefault;let le=l;const se=e.add([e.rect(r-10,380),e.pos(a+5,l-10),e.anchor("topleft"),e.color(25,25,35),e.outline(2,e.rgb(60,60,80)),e.fixed(),e.z(b.UI_ELEMENTS-1)]);v.push(se);const ne=e.add([e.circle(50),e.pos(a+r/2,le+45),e.anchor("center"),e.color(...Q?G.color:[80,80,80]),e.opacity(hn.GLOW_MIN),e.scale(1),e.fixed(),e.z(b.UI_ELEMENTS)]);v.push(ne);const ie=e.add([e.text(G.char,{size:72}),e.pos(a+r/2,le+45),e.anchor("center"),e.color(...Q?G.color:y.BG_DISABLED),e.fixed(),e.scale(1),e.z(b.UI_ELEMENTS+1),{baseY:le+45,baseScale:1,animTime:Math.random()*Math.PI*2}]);v.push(ie);const fe=e.onUpdate(()=>{if(!ie.exists())return;ie.animTime+=e.dt();const re=1+Math.sin(ie.animTime*hn.BREATHE_SPEED)*hn.BREATHE_AMOUNT;ie.scale=e.vec2(re,re);const Ce=Math.sin(ie.animTime*hn.BOB_SPEED)*hn.BOB_AMOUNT;if(ie.pos.y=ie.baseY+Ce,ne.exists()){const Fe=hn.GLOW_MIN+(Math.sin(ie.animTime*hn.GLOW_PULSE_SPEED)*.5+.5)*(hn.GLOW_MAX-hn.GLOW_MIN);ne.opacity=Fe,ne.scale=e.vec2(1+Fe*.3,1+Fe*.3)}});v.push({exists:()=>!0,destroy:()=>fe.cancel()}),le+=110;const Me=e.add([e.text(p(G.name),{size:Z.HEADER}),e.pos(a+r/2,le),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);v.push(Me),le+=35;const Ue=D(G.description,a+r/2,le,r-40);v.push(...Ue),le+=55;const Ne=e.add([e.text("Stats:",{size:Z.LABEL}),e.pos(a+20,le),e.anchor("left"),e.color(...y.WARNING),e.fixed(),e.z(b.UI_TEXT)]);v.push(Ne),le+=28;const Pe=100,Ge=a+40,Te=24,ut=Ga(e,{label:_i.HEALTH,value:G.stats.health,maxValue:175,x:Ge,y:le,width:Pe,usePercentageColor:!0});v.push(...ut.elements),le+=Te;const pe=Ga(e,{label:_i.SPEED,value:G.stats.speed,maxValue:225,x:Ge,y:le,width:Pe,usePercentageColor:!0});v.push(...pe.elements),le+=Te;const Ae=Ga(e,{label:_i.DAMAGE,value:G.stats.damage,maxValue:25,x:Ge,y:le,width:Pe,usePercentageColor:!0});if(v.push(...Ae.elements),le+=30,O===f){const re=e.add([e.text(" CURRENT SELECTION",{size:Z.LABEL}),e.pos(a+r/2,le),e.anchor("center"),e.color(...y.SUCCESS),e.fixed(),e.z(b.UI_TEXT)]);v.push(re)}if(!Q){const re=s2(G);if(re){const Ce=e.add([e.text(re,{size:Z.SMALL,width:r-40}),e.pos(a+r/2,le+30),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);v.push(Ce)}}x=!1}C(),e.onKeyPress("arrowleft",()=>{M>0&&(et(),M--,C())}),e.onKeyPress("arrowright",()=>{M<m-1&&(et(),M++,C())});const S=e.add([e.rect(120,35),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text(ri("Cancel"),{size:Z.BODY}),e.pos(e.width()/2-70,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),S.onClick(()=>{et(),e.go("menu")});let z=null,L=null,N=[];function _(){N.forEach(F=>{F&&F.exists&&F.exists()&&e.destroy(F)}),N=[];const H=Wt[O],R=Go("characters",O)||H.unlockedByDefault;z=e.add([e.rect(120,35),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(...R?y.SUCCESS:y.BG_DISABLED),e.outline(2,e.rgb(...R?y.BORDER:y.BG_DARK)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]),N.push(z),L=e.add([e.text(ri("Confirm"),{size:Z.BODY}),e.pos(e.width()/2+70,e.height()-40),e.anchor("center"),e.color(...R?y.TEXT_PRIMARY:y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]),N.push(L),R&&(z.onClick(()=>{Ot(),Kc(O),el(O),e.go("menu")}),z.cursor="pointer")}_();const X=C;C=function(){X(),_()},e.onKeyPress("escape",()=>{et(),e.go("menu")}),e.onKeyPress("enter",()=>{const H=Wt[O];(Go("characters",O)||H.unlockedByDefault)&&(Ot(),Kc(O),el(O),e.go("menu"))})})}function a2(e){e.scene("joinParty",()=>{const t={name:Co(),inviteCode:Zn(),character:xn()};let o=!1;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.fixed(),e.z(0)]),e.add([e.text("Join Party",{size:Z.TITLE}),e.pos(e.width()/2,100),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(10)]),e.add([e.text("Enter 6-digit invite code:",{size:Z.LABEL}),e.pos(e.width()/2,180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(10)]);let n="";const s=e.add([e.text("______",{size:Z.TITLE*1.5}),e.pos(e.width()/2,280),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(10)]),a=e.add([e.text("",{size:Z.SMALL}),e.pos(e.width()/2,360),e.anchor("center"),e.color(255,100,100),e.fixed(),e.z(10)]);e.add([e.text("Press ESC or click Cancel to go back",{size:Z.SMALL-2}),e.pos(e.width()/2,e.height()-100),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(10)]);let r=!1;function l(){let h="";for(let u=0;u<6;u++)u<n.length?h+=n[u]:h+="_";s.text=h}e.onCharInput(h=>{r||/[a-zA-Z0-9]/.test(h)&&n.length<6&&(et(),n+=h.toUpperCase(),l(),a.text="",n.length===6&&e.wait(.2,c))}),e.onKeyPress("backspace",()=>{r||n.length>0&&(et(),n=n.slice(0,-1),l(),a.text="")}),e.onKeyPress("escape",()=>{et(),o=!0,r=!1,ki(t),e.go("menu")}),e.onKeyPress("enter",()=>{r||n.length===6&&c()});async function c(){if(r)return;const h=n.trim();if(!Pg(h)){a.text="Invalid invite code format",a.color=e.rgb(255,100,100);return}r=!0,a.text="Joining party...",a.color=e.rgb(...y.GOLD);try{if(await mm(h)){if(o)return;Ot(),a.text="Successfully joined party!",a.color=e.rgb(...y.SUCCESS),e.wait(1,()=>{o||e.go("menu")})}else r=!1,a.text="Failed to join party. Check the code and try again.",a.color=e.rgb(255,100,100),n="",l()}catch(u){r=!1,console.error("[JoinParty] Error joining party:",u),a.text="Connection error. Please try again.",a.color=e.rgb(255,100,100),n="",l()}}const{MD:d}=Hn.BUTTON,i=e.add([e.rect(d.width,d.height),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(10)]);e.add([e.text("CANCEL",{size:Z.BODY}),e.pos(e.width()/2,e.height()-180),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(11)]),i.onClick(()=>{et(),o=!0,r=!1,ki(t),e.go("menu")}),i.onHoverUpdate(()=>{r||(i.color=e.rgb(...y.NEUTRAL_HOVER))}),i.onHoverEnd(()=>{i.color=e.rgb(...y.NEUTRAL)})})}const Qo={DAILY:"daily",ALL_TIME:"allTime",PERSONAL:"personal",GLOBAL:"global"};function r2(e){e.scene("leaderboards",(t={})=>{let n=t.tab||Qo.DAILY;const s=10,a=5;let r=0;e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(...y.BG_DARK),e.z(b.BACKGROUND)]),e.add([e.text("LEADERBOARDS",{size:Z.TITLE}),e.pos(e.width()/2,50),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);const l=100,c=115,d=8,i=c*4+d*3,h=(e.width()-i)/2,u=160;let g=[];function p(S,z,L){const N=n===z,_=e.add([e.rect(c,40),e.pos(L,l),e.anchor("center"),e.color(...N?y.SECONDARY:y.BG_MEDIUM),e.outline(2,e.rgb(...N?y.BORDER_HOVER:y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS),"tab"]),X=e.add([e.text(S,{size:Z.BODY}),e.pos(L,l),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT),"tab"]);return _.onClick(()=>{n!==z&&(et(),n=z,r=0,D(),m())}),_.onHoverUpdate(()=>{n!==z&&(_.color=e.rgb(...y.BG_LIGHT))}),_.onHoverEnd(()=>{n!==z&&(_.color=e.rgb(...y.BG_MEDIUM))}),{bg:_,label:X,tabType:z}}function D(){e.get("tab").forEach(S=>e.destroy(S)),p("DAILY",Qo.DAILY,h+c/2),p("ALL-TIME",Qo.ALL_TIME,h+c+d+c/2),p("PERSONAL",Qo.PERSONAL,h+(c+d)*2+c/2),p("GLOBAL",Qo.GLOBAL,h+(c+d)*3+c/2)}function m(){switch(g.forEach(S=>{S.exists()&&e.destroy(S)}),g=[],n){case Qo.DAILY:M();break;case Qo.ALL_TIME:B();break;case Qo.PERSONAL:P();break;case Qo.GLOBAL:f();break}}function M(){const S=Wo(),z=hc(S),L=Wt[z]||Wt.survivor,N=W1(S,100),_=Co(),X=Math.ceil(N.length/s);r>=X&&X>0&&(r=X-1);const H=r*s,R=N.slice(H,H+s),F=e.add([e.text(`Date: ${S}`,{size:Z.BODY}),e.pos(e.width()/2-100,u),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(F);const G=e.add([e.text(`Character: ${L.char} ${L.name}`,{size:Z.BODY}),e.pos(e.width()/2+50,u),e.anchor("left"),e.color(...L.color),e.fixed(),e.z(b.UI_TEXT)]);g.push(G);const Q=u+40;if(v(Q),N.length===0){const le=e.add([e.text("No entries yet. Be the first!",{size:Z.BODY}),e.pos(e.width()/2,Q+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);g.push(le)}else R.forEach((le,se)=>{const ne=Q+40+se*35,ie=le.name.toLowerCase()===_.toLowerCase(),fe=H+se+1;T(fe,le,ne,ie)}),X>1&&O(Q+40+s*35+10,X)}function B(){const S=$1(100),z=Co(),L=Math.ceil(S.length/s);r>=L&&L>0&&(r=L-1);const N=r*s,_=S.slice(N,N+s),X=u+10;if(v(X),S.length===0){const H=e.add([e.text("No entries yet. Play a game!",{size:Z.BODY}),e.pos(e.width()/2,X+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);g.push(H)}else _.forEach((H,R)=>{const F=X+40+R*35,G=H.name.toLowerCase()===z.toLowerCase(),Q=N+R+1;T(Q,H,F,G)}),L>1&&O(X+40+s*35+10,L)}function P(){const S=J1(),z=Object.keys(Wt),L=Math.ceil(z.length/a);r>=L&&(r=Math.max(0,L-1));const N=r*a,_=z.slice(N,N+a),X=u+10,H=["Character","Best Score","Best Floor","Best Time"],R=[120,280,420,540];H.forEach((G,Q)=>{const le=e.add([e.text(G,{size:Z.SMALL}),e.pos(R[Q],X),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(le)});const F=e.add([e.rect(500,2),e.pos(e.width()/2,X+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(b.UI_ELEMENTS)]);if(g.push(F),_.forEach((G,Q)=>{const le=Wt[G],se=S[G],ne=X+45+Q*40,ie=e.add([e.text(`${le.char} ${le.name}`,{size:Z.BODY}),e.pos(R[0],ne),e.anchor("left"),e.color(...le.color),e.fixed(),e.z(b.UI_TEXT)]);if(g.push(ie),se){const fe=e.add([e.text(Tr(se.bestScore),{size:Z.BODY}),e.pos(R[1],ne),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(fe);const Me=e.add([e.text(`Floor ${se.bestFloor}`,{size:Z.BODY}),e.pos(R[2],ne),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(Me);const Ue=e.add([e.text(Xl(se.bestTime),{size:Z.BODY}),e.pos(R[3],ne),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(Ue)}else{const fe=e.add([e.text("-- no data --",{size:Z.SMALL}),e.pos(R[1],ne),e.anchor("left"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);g.push(fe)}}),L>1){const G=X+45+a*40+20;O(G,L)}}function f(){const S=Co(),z=u+10,L=e.add([e.text("Connecting to global leaderboard...",{size:Z.BODY}),e.pos(e.width()/2,z+100),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(L),tu(10).then(N=>{if(L.exists()){e.destroy(L);const X=g.indexOf(L);X>-1&&g.splice(X,1)}if(n!==Qo.GLOBAL)return;if(N.error){const X=e.add([e.text(N.error,{size:Z.BODY}),e.pos(e.width()/2,z+80),e.anchor("center"),e.color(...y.DANGER),e.fixed(),e.z(b.UI_TEXT)]);g.push(X);const H=e.add([e.rect(120,35),e.pos(e.width()/2,z+130),e.anchor("center"),e.color(...y.SECONDARY),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);g.push(H);const R=e.add([e.text("Try Again",{size:Z.SMALL}),e.pos(e.width()/2,z+130),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(R),H.onClick(()=>{et(),m()}),H.onHoverUpdate(()=>{H.color=e.rgb(...y.SECONDARY_HOVER)}),H.onHoverEnd(()=>{H.color=e.rgb(...y.SECONDARY)});return}const _=N.entries;if(v(z),_.length===0){const X=e.add([e.text("No global entries yet. Be the first!",{size:Z.BODY}),e.pos(e.width()/2,z+60),e.anchor("center"),e.color(...y.TEXT_DISABLED),e.fixed(),e.z(b.UI_TEXT)]);g.push(X)}else _.forEach((X,H)=>{const R=z+40+H*35,F=X.name.toLowerCase()===S.toLowerCase();T(H+1,X,R,F)});if(N.totalCount>0){const X=z+40+Math.min(_.length,10)*35+20,H=e.add([e.text(`${N.totalCount} player${N.totalCount!==1?"s":""} worldwide`,{size:Z.SMALL}),e.pos(e.width()/2,X),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(H)}})}function O(S,z){const L=e.width()/2,N=20,_=L-(z-1)*N/2,X=L+(z-1)*N/2,H=25,R=_-H,F=X+H;for(let ne=0;ne<z;ne++){const ie=ne===r,fe=_+ne*N,Me=e.add([e.rect(16,16),e.pos(fe,S),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:16,height:16}),e.fixed(),e.z(b.UI_ELEMENTS)]),Ue=e.add([e.text(ie?"":"",{size:14}),e.pos(fe,S),e.anchor("center"),e.color(ie?255:120,ie?255:120,ie?255:120),e.fixed(),e.z(b.UI_TEXT)]),Ne=ne;Me.onClick(()=>{Ne!==r&&(et(),r=Ne,m())}),Me.cursor="pointer",g.push(Me,Ue)}const G=e.add([e.rect(30,30),e.pos(R,S),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),Q=e.add([e.text("<",{size:24}),e.pos(R,S),e.anchor("center"),e.color(r>0?255:80,r>0?255:80,r>0?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);r>0&&(G.onClick(()=>{et(),r--,m()}),G.cursor="pointer"),g.push(G,Q);const le=e.add([e.rect(30,30),e.pos(F,S),e.anchor("center"),e.color(0,0,0),e.opacity(0),e.area({width:30,height:30}),e.fixed(),e.z(b.UI_ELEMENTS+1)]),se=e.add([e.text(">",{size:24}),e.pos(F,S),e.anchor("center"),e.color(r<z-1?255:80,r<z-1?255:80,r<z-1?255:80),e.fixed(),e.z(b.UI_TEXT+1)]);r<z-1&&(le.onClick(()=>{et(),r++,m()}),le.cursor="pointer"),g.push(le,se)}function v(S){const z=["#","Name","Score","Floor","Time"],L=[80,150,350,470,560];z.forEach((_,X)=>{const H=e.add([e.text(_,{size:Z.SMALL}),e.pos(L[X],S),e.anchor(X===0?"center":"left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);g.push(H)});const N=e.add([e.rect(550,2),e.pos(e.width()/2,S+20),e.anchor("center"),e.color(...y.BORDER),e.fixed(),e.z(b.UI_ELEMENTS)]);g.push(N)}function T(S,z,L,N=!1){const _=[80,150,350,470,560],X=N?y.GOLD:y.TEXT_PRIMARY,H=Wt[z.character]||Wt.survivor,R=e.add([e.text(S<=3?["","1st","2nd","3rd"][S]:`${S}`,{size:Z.BODY}),e.pos(_[0],L),e.anchor("center"),e.color(...S===1?[255,215,0]:S===2?[192,192,192]:S===3?[205,127,50]:X),e.fixed(),e.z(b.UI_TEXT)]);g.push(R);const F=e.add([e.text(`${H.char} ${z.name}`,{size:Z.BODY}),e.pos(_[1],L),e.anchor("left"),e.color(...X),e.fixed(),e.z(b.UI_TEXT)]);g.push(F);const G=e.add([e.text(Tr(z.score),{size:Z.BODY}),e.pos(_[2],L),e.anchor("left"),e.color(...X),e.fixed(),e.z(b.UI_TEXT)]);g.push(G);const Q=e.add([e.text(`${z.floor}`,{size:Z.BODY}),e.pos(_[3],L),e.anchor("left"),e.color(...X),e.fixed(),e.z(b.UI_TEXT)]);g.push(Q);const le=e.add([e.text(Xl(z.time),{size:Z.BODY}),e.pos(_[4],L),e.anchor("left"),e.color(...X),e.fixed(),e.z(b.UI_TEXT)]);if(g.push(le),N){const se=e.add([e.rect(550,30),e.pos(e.width()/2,L),e.anchor("center"),e.color(...y.GOLD),e.opacity(.1),e.fixed(),e.z(b.UI_BACKGROUND+1)]);g.push(se)}}const{SM:x}=Hn.BUTTON,C=e.add([e.rect(x.width,x.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),C.onClick(()=>{Ot(),e.go("menu")}),C.onHoverUpdate(()=>{C.color=e.rgb(...y.SECONDARY_HOVER)}),C.onHoverEnd(()=>{C.color=e.rgb(...y.SECONDARY)}),e.onKeyPress("escape",()=>{Ot(),e.go("menu")}),D(),m()})}function c2(e,t,o){const n=e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.color(0,0,0),e.opacity(.7),e.fixed(),e.z(b.OVERLAY)]),r=e.add([e.rect(400,180),e.pos(e.width()/2,e.height()/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(3,e.rgb(...y.BORDER)),e.fixed(),e.z(b.OVERLAY+1)]),l=e.add([e.text("Edit Player Name",{size:Z.LABEL}),e.pos(e.width()/2,e.height()/2-60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+2)]),c=e.add([e.rect(300,40),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(2,e.rgb(...y.GOLD)),e.fixed(),e.z(b.OVERLAY+2)]);let d=t;const i=e.add([e.text(d,{size:Z.LABEL}),e.pos(e.width()/2,e.height()/2-10),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.OVERLAY+3)]),h=e.add([e.text("(Max 20 characters)",{size:Z.SMALL-2}),e.pos(e.width()/2,e.height()/2+25),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.OVERLAY+2)]),u=[n,r,l,c,i,h];function g(){u.forEach(v=>{v&&v.exists&&v.exists()&&e.destroy(v)})}const p=e.add([e.rect(100,30),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.TEXT_PRIMARY)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),D=e.add([e.text("Cancel",{size:Z.SMALL-2}),e.pos(e.width()/2-60,e.height()/2+60),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.OVERLAY+3)]);p.onClick(()=>{et(),g()}),u.push(p,D);const m=e.add([e.rect(100,30),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(b.OVERLAY+2)]),M=e.add([e.text("Save",{size:Z.SMALL-2}),e.pos(e.width()/2+60,e.height()/2+60),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.OVERLAY+3)]);m.onClick(()=>{d.trim().length>0?(Ot(),o(d.trim()),g()):(h.text="Name cannot be empty!",h.color=e.rgb(255,100,100))}),u.push(m,M);const B=e.onCharInput(v=>{d.length<20&&/[a-zA-Z0-9 ]/.test(v)&&(d+=v,i.text=d,h.text="(Max 20 characters)",h.color=e.rgb(...y.TEXT_SECONDARY))}),P=e.onKeyPress("backspace",()=>{d.length>0&&(d=d.slice(0,-1),i.text=d||" ")}),f=e.onKeyPress("escape",()=>{g(),B.cancel(),P.cancel(),f.cancel(),O.cancel()}),O=e.onKeyPress("enter",()=>{d.trim().length>0&&(Ot(),o(d.trim()),g(),B.cancel(),P.cancel(),f.cancel(),O.cancel())})}function l2(e){e.scene("profile",(t={})=>{const o=t.externalProfile||null,n=o!==null,s=n?o:mt();let a=n?o.selectedPortrait:ui();const r=n?o.stats:Ms(),l=n?o.playerLevel:hi(),c=n?o.totalXP:ma(),d=n?o.playerName:Co();n&&o.achievements;const i=n?o.unlockedPortraits:ph();e.add([e.rect(e.width(),e.height()),e.pos(0,0),e.anchor("topleft"),e.color(...y.BG_DARK),e.fixed(),e.z(b.BACKGROUND)]),fi(e,{patternCount:8,particleCount:12}),n?e.add([e.text(`${d}'s Profile`,{size:Z.H1}),e.pos(e.width()/2,35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]):pi(e,"PROFILE",e.width()/2,35,8);const h=80,u=140,g=720,p=e.width()/2;e.add([e.rect(g,u),e.pos(p,h+u/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const D=80,m=p-g/2+60,M=h+u/2,B=Ar(a)||kn.default;e.add([e.rect(D,D),e.pos(m,M),e.anchor("center"),e.color(...y.BG_LIGHT),e.outline(3,e.rgb(...B.color||[200,200,200])),e.fixed(),e.z(b.UI_BACKGROUND+1)]),e.add([e.text(B.icon,{size:40}),e.pos(m,M-5),e.anchor("center"),e.color(...B.color||[200,200,200]),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(`LV${l}`,{size:12}),e.pos(m,M+28),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);const P=m+80;let f=h+20,O=d;const v=e.add([e.text(O,{size:Z.H1}),e.pos(P,f),e.anchor("left"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]);if(!n){const Be=p+g/2-20,Ke=Be-24-8,qe=e.add([e.rect(24,24),e.pos(Ke,f),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Ke-24/2,f),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),qe.onClick(()=>{Ot(),c2(e,O,at=>{Vc(at),v.text=at,O=at})}),qe.onHoverUpdate(()=>{qe.color=e.rgb(...y.BG_LIGHT)}),qe.onHoverEnd(()=>{qe.color=e.rgb(...y.BG_MEDIUM)});const ke=e.add([e.rect(24,24),e.pos(Be,f),e.anchor("right"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.GOLD)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("",{size:14}),e.pos(Be-24/2,f),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]),ke.onClick(()=>{Ot();const at=dr();Vc(at),v.text=at,O=at}),ke.onHoverUpdate(()=>{ke.color=e.rgb(...y.BG_LIGHT)}),ke.onHoverEnd(()=>{ke.color=e.rgb(...y.BG_MEDIUM)})}f+=35;const T=Math.min(5,Math.floor(l/10)),x="".repeat(T)+"".repeat(5-T);e.add([e.text(`Level ${l}  ${x}`,{size:Z.LABEL}),e.pos(P,f),e.anchor("left"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),f+=30;const C=250,S=16,z=n?0:Kr(),L=c,N=n?c:fh();e.add([e.rect(C,S),e.pos(P,f),e.anchor("left"),e.color(40,40,60),e.outline(1,e.rgb(80,80,100)),e.fixed(),e.z(b.UI_BACKGROUND+1)]);const _=Math.max(2,C*z);e.add([e.rect(_,S-4),e.pos(P+2,f),e.anchor("left"),e.color(100,180,255),e.fixed(),e.z(b.UI_ELEMENTS)]),e.add([e.text(`${Math.round(z*100)}%`,{size:10}),e.pos(P+C/2,f),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)]),f+=22,e.add([e.text(`${L.toLocaleString()} / ${N.toLocaleString()} XP`,{size:Z.SMALL}),e.pos(P,f),e.anchor("left"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const X=h+u+10,H=165;e.add([e.rect(g,H),e.pos(p,X+H/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const R=E1(),F=40,G=50,Q=13,le=(Q-1)*G,se=p-le/2,ne=X+28;let ie=null,fe=null;function Me(Ie){ie&&ie.exists()&&(ie.text=`Selected: "${Ie.name}"`),fe&&fe.exists()&&(fe.text=Ie.description)}R.forEach((Ie,Be)=>{const Ke=Math.floor(Be/Q),qe=Be%Q,ke=se+qe*G,at=ne+Ke*(G+5),tt=n?i.includes(Ie.id):A1(Ie.id,s),ot=Ie.id===a,ft=tt?ot?[80,100,140]:y.BG_LIGHT:[40,40,50],ct=ot?y.GOLD:tt?Ie.color:[80,80,80],yt=e.add([e.rect(F,F),e.pos(ke,at),e.anchor("center"),e.color(...ft),e.outline(ot?3:2,e.rgb(...ct)),n?null:e.area(),e.fixed(),e.z(b.UI_ELEMENTS)].filter(Boolean)),Ht=tt?Ie.color:[80,80,80];e.add([e.text(Ie.icon,{size:24}),e.pos(ke,at-3),e.anchor("center"),e.color(...Ht),e.fixed(),e.z(b.UI_TEXT)]);const Dt=tt?Ie.name.substring(0,8):"???";e.add([e.text(Dt,{size:8}),e.pos(ke,at+F/2+8),e.anchor("center"),e.color(...tt?y.TEXT_SECONDARY:[80,80,80]),e.fixed(),e.z(b.UI_TEXT)]),n||(yt.onClick(()=>{if(tt)Ot(),kg(Ie.id),a=Ie.id,Me(Ie),e.go("profile");else{et();const Nt=S1(Ie.id);fe&&fe.exists()&&(fe.text=`Locked: ${Nt}`,fe.color=e.rgb(...y.DANGER))}}),yt.onHoverUpdate(()=>{ot||(yt.color=e.rgb(...tt?[100,120,160]:[50,50,60]))}),yt.onHoverEnd(()=>{ot||(yt.color=e.rgb(...ft))}))}),ie=e.add([e.text(`Selected: "${B.name}"`,{size:Z.SMALL}),e.pos(p,X+H-35),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)]),fe=e.add([e.text(B.description,{size:Z.SMALL-2}),e.pos(p,X+H-18),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]);const Ue=X+H+10,Ne=120;e.add([e.rect(g,Ne),e.pos(p,Ue+Ne/2),e.anchor("center"),e.color(...y.BG_MEDIUM),e.outline(2,e.rgb(...y.BORDER)),e.fixed(),e.z(b.UI_BACKGROUND)]);const Pe=r,Ge=Pe.totalRuns||0,Te=Ge>0?Math.round((Pe.totalCurrencyEarned||0)/Ge):0,ut=Ge>0?((Pe.totalFloorsReached||0)/Ge).toFixed(1):"0",pe=Ge>0?((Pe.totalRoomsCleared||0)/Ge).toFixed(1):"0",Ae=Pe.fastestRunTime||0,re=Math.floor(Ae/60),Ce=Math.floor(Ae%60),Fe=Ae>0?`${re}:${Ce.toString().padStart(2,"0")}`:"--:--",De=[{label:"Total Runs",value:Ge},{label:"Best Floor",value:Pe.bestFloor||1},{label:"Best Level",value:Pe.bestLevel||1},{label:"Best Room",value:Pe.bestRoom||1},{label:"Fastest Run",value:Fe}],We=g/De.length;De.forEach((Ie,Be)=>{const Ke=p-g/2+We*Be+We/2,qe=Ue+15;e.add([e.text(Ie.label,{size:Z.SMALL-2}),e.pos(Ke,qe),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(String(Ie.value),{size:Z.LABEL}),e.pos(Ke,qe+16),e.anchor("center"),e.color(...y.GOLD),e.fixed(),e.z(b.UI_TEXT)])}),[{label:"Enemies",value:(Pe.totalEnemiesKilled||0).toLocaleString()},{label:"Bosses",value:Pe.totalBossesKilled||0},{label:"Rooms",value:(Pe.totalRoomsCleared||0).toLocaleString()},{label:"Avg Floor",value:ut},{label:"Avg Rooms",value:pe}].forEach((Ie,Be)=>{const Ke=p-g/2+We*Be+We/2,qe=Ue+50;e.add([e.text(Ie.label,{size:Z.SMALL-2}),e.pos(Ke,qe),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(String(Ie.value),{size:Z.SMALL}),e.pos(Ke,qe+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)])}),[{label:"Total Money",value:(Pe.totalCurrencyEarned||0).toLocaleString()},{label:"Spent",value:(Pe.totalCurrencySpent||0).toLocaleString()},{label:"Avg Money",value:Te.toLocaleString()},{label:"Floors",value:(Pe.totalFloorsReached||0).toLocaleString()},{label:"Play Time",value:(()=>{const Ie=Pe.totalPlayTime||0,Be=Math.floor(Ie/3600),Ke=Math.floor(Ie%3600/60);return`${Be}h ${Ke}m`})()}].forEach((Ie,Be)=>{const Ke=p-g/2+We*Be+We/2,qe=Ue+85;e.add([e.text(Ie.label,{size:Z.SMALL-2}),e.pos(Ke,qe),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),e.add([e.text(String(Ie.value),{size:Z.SMALL}),e.pos(Ke,qe+14),e.anchor("center"),e.color(...y.TEXT_PRIMARY),e.fixed(),e.z(b.UI_TEXT)])});const{SM:Lt}=Hn.BUTTON,dt=e.add([e.rect(Lt.width,Lt.height),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.NEUTRAL),e.outline(2,e.rgb(...y.BORDER)),e.area(),e.fixed(),e.z(b.UI_ELEMENTS)]);e.add([e.text("BACK",{size:Z.SMALL}),e.pos(e.width()/2,e.height()-40),e.anchor("center"),e.color(...y.TEXT_SECONDARY),e.fixed(),e.z(b.UI_TEXT)]),dt.onClick(()=>{et(),e.go("menu")}),dt.onHoverUpdate(()=>{dt.color=e.rgb(...y.NEUTRAL_HOVER)}),dt.onHoverEnd(()=>{dt.color=e.rgb(...y.NEUTRAL)}),e.onKeyPress("escape",()=>{et(),e.go("menu")})})}const $o=Rg({width:Ls.CANVAS_WIDTH,height:Ls.CANVAS_HEIGHT,background:Ls.BACKGROUND_COLOR,scale:Ls.CANVAS_SCALE,debug:Ls.DEBUG_MODE,root:document.querySelector("#game-container"),stretch:!0,letterbox:!0,crisp:!0});O1($o);v1($o);k1($o);e2($o);t2($o);n2($o);i2($o);a2($o);r2($o);l2($o);$o.go("menu");
//# sourceMappingURL=main-B3h3BrOH.js.map
